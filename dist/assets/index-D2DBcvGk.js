var r7=Object.defineProperty;var n7=(t,e,r)=>e in t?r7(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var xw=(t,e,r)=>n7(t,typeof e!="symbol"?e+"":e,r);function s7(t,e){for(var r=0;r<e.length;r++){const c=e[r];if(typeof c!="string"&&!Array.isArray(c)){for(const h in c)if(h!=="default"&&!(h in t)){const x=Object.getOwnPropertyDescriptor(c,h);x&&Object.defineProperty(t,h,x.get?x:{enumerable:!0,get:()=>c[h]})}}}return Object.freeze(Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}))}(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const h of document.querySelectorAll('link[rel="modulepreload"]'))c(h);new MutationObserver(h=>{for(const x of h)if(x.type==="childList")for(const w of x.addedNodes)w.tagName==="LINK"&&w.rel==="modulepreload"&&c(w)}).observe(document,{childList:!0,subtree:!0});function r(h){const x={};return h.integrity&&(x.integrity=h.integrity),h.referrerPolicy&&(x.referrerPolicy=h.referrerPolicy),h.crossOrigin==="use-credentials"?x.credentials="include":h.crossOrigin==="anonymous"?x.credentials="omit":x.credentials="same-origin",x}function c(h){if(h.ep)return;h.ep=!0;const x=r(h);fetch(h.href,x)}})();var a7=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function d5(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var h5={exports:{}},PS={},p5={exports:{}},cn={};/**
 * @license React
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Ov=Symbol.for("react.element"),o7=Symbol.for("react.portal"),l7=Symbol.for("react.fragment"),c7=Symbol.for("react.strict_mode"),u7=Symbol.for("react.profiler"),d7=Symbol.for("react.provider"),h7=Symbol.for("react.context"),p7=Symbol.for("react.forward_ref"),m7=Symbol.for("react.suspense"),f7=Symbol.for("react.memo"),g7=Symbol.for("react.lazy"),gO=Symbol.iterator;function y7(t){return t===null||typeof t!="object"?null:(t=gO&&t[gO]||t["@@iterator"],typeof t=="function"?t:null)}var m5={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},f5=Object.assign,g5={};function qy(t,e,r){this.props=t,this.context=e,this.refs=g5,this.updater=r||m5}qy.prototype.isReactComponent={};qy.prototype.setState=function(t,e){if(typeof t!="object"&&typeof t!="function"&&t!=null)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,t,e,"setState")};qy.prototype.forceUpdate=function(t){this.updater.enqueueForceUpdate(this,t,"forceUpdate")};function y5(){}y5.prototype=qy.prototype;function CI(t,e,r){this.props=t,this.context=e,this.refs=g5,this.updater=r||m5}var EI=CI.prototype=new y5;EI.constructor=CI;f5(EI,qy.prototype);EI.isPureReactComponent=!0;var yO=Array.isArray,x5=Object.prototype.hasOwnProperty,II={current:null},_5={key:!0,ref:!0,__self:!0,__source:!0};function v5(t,e,r){var c,h={},x=null,w=null;if(e!=null)for(c in e.ref!==void 0&&(w=e.ref),e.key!==void 0&&(x=""+e.key),e)x5.call(e,c)&&!_5.hasOwnProperty(c)&&(h[c]=e[c]);var o=arguments.length-2;if(o===1)h.children=r;else if(1<o){for(var C=Array(o),R=0;R<o;R++)C[R]=arguments[R+2];h.children=C}if(t&&t.defaultProps)for(c in o=t.defaultProps,o)h[c]===void 0&&(h[c]=o[c]);return{$$typeof:Ov,type:t,key:x,ref:w,props:h,_owner:II.current}}function x7(t,e){return{$$typeof:Ov,type:t.type,key:e,ref:t.ref,props:t.props,_owner:t._owner}}function PI(t){return typeof t=="object"&&t!==null&&t.$$typeof===Ov}function _7(t){var e={"=":"=0",":":"=2"};return"$"+t.replace(/[=:]/g,function(r){return e[r]})}var xO=/\/+/g;function ZA(t,e){return typeof t=="object"&&t!==null&&t.key!=null?_7(""+t.key):e.toString(36)}function Qw(t,e,r,c,h){var x=typeof t;(x==="undefined"||x==="boolean")&&(t=null);var w=!1;if(t===null)w=!0;else switch(x){case"string":case"number":w=!0;break;case"object":switch(t.$$typeof){case Ov:case o7:w=!0}}if(w)return w=t,h=h(w),t=c===""?"."+ZA(w,0):c,yO(h)?(r="",t!=null&&(r=t.replace(xO,"$&/")+"/"),Qw(h,e,r,"",function(R){return R})):h!=null&&(PI(h)&&(h=x7(h,r+(!h.key||w&&w.key===h.key?"":(""+h.key).replace(xO,"$&/")+"/")+t)),e.push(h)),1;if(w=0,c=c===""?".":c+":",yO(t))for(var o=0;o<t.length;o++){x=t[o];var C=c+ZA(x,o);w+=Qw(x,e,r,C,h)}else if(C=y7(t),typeof C=="function")for(t=C.call(t),o=0;!(x=t.next()).done;)x=x.value,C=c+ZA(x,o++),w+=Qw(x,e,r,C,h);else if(x==="object")throw e=String(t),Error("Objects are not valid as a React child (found: "+(e==="[object Object]"?"object with keys {"+Object.keys(t).join(", ")+"}":e)+"). If you meant to render a collection of children, use an array instead.");return w}function _w(t,e,r){if(t==null)return t;var c=[],h=0;return Qw(t,c,"","",function(x){return e.call(r,x,h++)}),c}function v7(t){if(t._status===-1){var e=t._result;e=e(),e.then(function(r){(t._status===0||t._status===-1)&&(t._status=1,t._result=r)},function(r){(t._status===0||t._status===-1)&&(t._status=2,t._result=r)}),t._status===-1&&(t._status=0,t._result=e)}if(t._status===1)return t._result.default;throw t._result}var rl={current:null},Jw={transition:null},b7={ReactCurrentDispatcher:rl,ReactCurrentBatchConfig:Jw,ReactCurrentOwner:II};function b5(){throw Error("act(...) is not supported in production builds of React.")}cn.Children={map:_w,forEach:function(t,e,r){_w(t,function(){e.apply(this,arguments)},r)},count:function(t){var e=0;return _w(t,function(){e++}),e},toArray:function(t){return _w(t,function(e){return e})||[]},only:function(t){if(!PI(t))throw Error("React.Children.only expected to receive a single React element child.");return t}};cn.Component=qy;cn.Fragment=l7;cn.Profiler=u7;cn.PureComponent=CI;cn.StrictMode=c7;cn.Suspense=m7;cn.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=b7;cn.act=b5;cn.cloneElement=function(t,e,r){if(t==null)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+t+".");var c=f5({},t.props),h=t.key,x=t.ref,w=t._owner;if(e!=null){if(e.ref!==void 0&&(x=e.ref,w=II.current),e.key!==void 0&&(h=""+e.key),t.type&&t.type.defaultProps)var o=t.type.defaultProps;for(C in e)x5.call(e,C)&&!_5.hasOwnProperty(C)&&(c[C]=e[C]===void 0&&o!==void 0?o[C]:e[C])}var C=arguments.length-2;if(C===1)c.children=r;else if(1<C){o=Array(C);for(var R=0;R<C;R++)o[R]=arguments[R+2];c.children=o}return{$$typeof:Ov,type:t.type,key:h,ref:x,props:c,_owner:w}};cn.createContext=function(t){return t={$$typeof:h7,_currentValue:t,_currentValue2:t,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null},t.Provider={$$typeof:d7,_context:t},t.Consumer=t};cn.createElement=v5;cn.createFactory=function(t){var e=v5.bind(null,t);return e.type=t,e};cn.createRef=function(){return{current:null}};cn.forwardRef=function(t){return{$$typeof:p7,render:t}};cn.isValidElement=PI;cn.lazy=function(t){return{$$typeof:g7,_payload:{_status:-1,_result:t},_init:v7}};cn.memo=function(t,e){return{$$typeof:f7,type:t,compare:e===void 0?null:e}};cn.startTransition=function(t){var e=Jw.transition;Jw.transition={};try{t()}finally{Jw.transition=e}};cn.unstable_act=b5;cn.useCallback=function(t,e){return rl.current.useCallback(t,e)};cn.useContext=function(t){return rl.current.useContext(t)};cn.useDebugValue=function(){};cn.useDeferredValue=function(t){return rl.current.useDeferredValue(t)};cn.useEffect=function(t,e){return rl.current.useEffect(t,e)};cn.useId=function(){return rl.current.useId()};cn.useImperativeHandle=function(t,e,r){return rl.current.useImperativeHandle(t,e,r)};cn.useInsertionEffect=function(t,e){return rl.current.useInsertionEffect(t,e)};cn.useLayoutEffect=function(t,e){return rl.current.useLayoutEffect(t,e)};cn.useMemo=function(t,e){return rl.current.useMemo(t,e)};cn.useReducer=function(t,e,r){return rl.current.useReducer(t,e,r)};cn.useRef=function(t){return rl.current.useRef(t)};cn.useState=function(t){return rl.current.useState(t)};cn.useSyncExternalStore=function(t,e,r){return rl.current.useSyncExternalStore(t,e,r)};cn.useTransition=function(){return rl.current.useTransition()};cn.version="18.3.1";p5.exports=cn;var ue=p5.exports;const jI=d5(ue),w7=s7({__proto__:null,default:jI},[ue]);/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var S7=ue,T7=Symbol.for("react.element"),N7=Symbol.for("react.fragment"),A7=Object.prototype.hasOwnProperty,C7=S7.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,E7={key:!0,ref:!0,__self:!0,__source:!0};function w5(t,e,r){var c,h={},x=null,w=null;r!==void 0&&(x=""+r),e.key!==void 0&&(x=""+e.key),e.ref!==void 0&&(w=e.ref);for(c in e)A7.call(e,c)&&!E7.hasOwnProperty(c)&&(h[c]=e[c]);if(t&&t.defaultProps)for(c in e=t.defaultProps,e)h[c]===void 0&&(h[c]=e[c]);return{$$typeof:T7,type:t,key:x,ref:w,props:h,_owner:C7.current}}PS.Fragment=N7;PS.jsx=w5;PS.jsxs=w5;h5.exports=PS;var n=h5.exports,VC={},S5={exports:{}},ql={},T5={exports:{}},N5={};/**
 * @license React
 * scheduler.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */(function(t){function e(Pe,It){var tt=Pe.length;Pe.push(It);e:for(;0<tt;){var zt=tt-1>>>1,vt=Pe[zt];if(0<h(vt,It))Pe[zt]=It,Pe[tt]=vt,tt=zt;else break e}}function r(Pe){return Pe.length===0?null:Pe[0]}function c(Pe){if(Pe.length===0)return null;var It=Pe[0],tt=Pe.pop();if(tt!==It){Pe[0]=tt;e:for(var zt=0,vt=Pe.length,Ot=vt>>>1;zt<Ot;){var Et=2*(zt+1)-1,yi=Pe[Et],mi=Et+1,ht=Pe[mi];if(0>h(yi,tt))mi<vt&&0>h(ht,yi)?(Pe[zt]=ht,Pe[mi]=tt,zt=mi):(Pe[zt]=yi,Pe[Et]=tt,zt=Et);else if(mi<vt&&0>h(ht,tt))Pe[zt]=ht,Pe[mi]=tt,zt=mi;else break e}}return It}function h(Pe,It){var tt=Pe.sortIndex-It.sortIndex;return tt!==0?tt:Pe.id-It.id}if(typeof performance=="object"&&typeof performance.now=="function"){var x=performance;t.unstable_now=function(){return x.now()}}else{var w=Date,o=w.now();t.unstable_now=function(){return w.now()-o}}var C=[],R=[],F=1,$=null,Y=3,H=!1,X=!1,he=!1,se=typeof setTimeout=="function"?setTimeout:null,de=typeof clearTimeout=="function"?clearTimeout:null,K=typeof setImmediate<"u"?setImmediate:null;typeof navigator<"u"&&navigator.scheduling!==void 0&&navigator.scheduling.isInputPending!==void 0&&navigator.scheduling.isInputPending.bind(navigator.scheduling);function ge(Pe){for(var It=r(R);It!==null;){if(It.callback===null)c(R);else if(It.startTime<=Pe)c(R),It.sortIndex=It.expirationTime,e(C,It);else break;It=r(R)}}function Ae(Pe){if(he=!1,ge(Pe),!X)if(r(C)!==null)X=!0,Le(Te);else{var It=r(R);It!==null&&Ke(Ae,It.startTime-Pe)}}function Te(Pe,It){X=!1,he&&(he=!1,de(ae),ae=-1),H=!0;var tt=Y;try{for(ge(It),$=r(C);$!==null&&(!($.expirationTime>It)||Pe&&!ke());){var zt=$.callback;if(typeof zt=="function"){$.callback=null,Y=$.priorityLevel;var vt=zt($.expirationTime<=It);It=t.unstable_now(),typeof vt=="function"?$.callback=vt:$===r(C)&&c(C),ge(It)}else c(C);$=r(C)}if($!==null)var Ot=!0;else{var Et=r(R);Et!==null&&Ke(Ae,Et.startTime-It),Ot=!1}return Ot}finally{$=null,Y=tt,H=!1}}var Ce=!1,ne=null,ae=-1,q=5,oe=-1;function ke(){return!(t.unstable_now()-oe<q)}function Ve(){if(ne!==null){var Pe=t.unstable_now();oe=Pe;var It=!0;try{It=ne(!0,Pe)}finally{It?ie():(Ce=!1,ne=null)}}else Ce=!1}var ie;if(typeof K=="function")ie=function(){K(Ve)};else if(typeof MessageChannel<"u"){var ze=new MessageChannel,ve=ze.port2;ze.port1.onmessage=Ve,ie=function(){ve.postMessage(null)}}else ie=function(){se(Ve,0)};function Le(Pe){ne=Pe,Ce||(Ce=!0,ie())}function Ke(Pe,It){ae=se(function(){Pe(t.unstable_now())},It)}t.unstable_IdlePriority=5,t.unstable_ImmediatePriority=1,t.unstable_LowPriority=4,t.unstable_NormalPriority=3,t.unstable_Profiling=null,t.unstable_UserBlockingPriority=2,t.unstable_cancelCallback=function(Pe){Pe.callback=null},t.unstable_continueExecution=function(){X||H||(X=!0,Le(Te))},t.unstable_forceFrameRate=function(Pe){0>Pe||125<Pe?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):q=0<Pe?Math.floor(1e3/Pe):5},t.unstable_getCurrentPriorityLevel=function(){return Y},t.unstable_getFirstCallbackNode=function(){return r(C)},t.unstable_next=function(Pe){switch(Y){case 1:case 2:case 3:var It=3;break;default:It=Y}var tt=Y;Y=It;try{return Pe()}finally{Y=tt}},t.unstable_pauseExecution=function(){},t.unstable_requestPaint=function(){},t.unstable_runWithPriority=function(Pe,It){switch(Pe){case 1:case 2:case 3:case 4:case 5:break;default:Pe=3}var tt=Y;Y=Pe;try{return It()}finally{Y=tt}},t.unstable_scheduleCallback=function(Pe,It,tt){var zt=t.unstable_now();switch(typeof tt=="object"&&tt!==null?(tt=tt.delay,tt=typeof tt=="number"&&0<tt?zt+tt:zt):tt=zt,Pe){case 1:var vt=-1;break;case 2:vt=250;break;case 5:vt=1073741823;break;case 4:vt=1e4;break;default:vt=5e3}return vt=tt+vt,Pe={id:F++,callback:It,priorityLevel:Pe,startTime:tt,expirationTime:vt,sortIndex:-1},tt>zt?(Pe.sortIndex=tt,e(R,Pe),r(C)===null&&Pe===r(R)&&(he?(de(ae),ae=-1):he=!0,Ke(Ae,tt-zt))):(Pe.sortIndex=vt,e(C,Pe),X||H||(X=!0,Le(Te))),Pe},t.unstable_shouldYield=ke,t.unstable_wrapCallback=function(Pe){var It=Y;return function(){var tt=Y;Y=It;try{return Pe.apply(this,arguments)}finally{Y=tt}}}})(N5);T5.exports=N5;var I7=T5.exports;/**
 * @license React
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var P7=ue,Bl=I7;function _i(t){for(var e="https://reactjs.org/docs/error-decoder.html?invariant="+t,r=1;r<arguments.length;r++)e+="&args[]="+encodeURIComponent(arguments[r]);return"Minified React error #"+t+"; visit "+e+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var A5=new Set,iv={};function pf(t,e){wy(t,e),wy(t+"Capture",e)}function wy(t,e){for(iv[t]=e,t=0;t<e.length;t++)A5.add(e[t])}var Fd=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),UC=Object.prototype.hasOwnProperty,j7=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,_O={},vO={};function R7(t){return UC.call(vO,t)?!0:UC.call(_O,t)?!1:j7.test(t)?vO[t]=!0:(_O[t]=!0,!1)}function k7(t,e,r,c){if(r!==null&&r.type===0)return!1;switch(typeof e){case"function":case"symbol":return!0;case"boolean":return c?!1:r!==null?!r.acceptsBooleans:(t=t.toLowerCase().slice(0,5),t!=="data-"&&t!=="aria-");default:return!1}}function D7(t,e,r,c){if(e===null||typeof e>"u"||k7(t,e,r,c))return!0;if(c)return!1;if(r!==null)switch(r.type){case 3:return!e;case 4:return e===!1;case 5:return isNaN(e);case 6:return isNaN(e)||1>e}return!1}function nl(t,e,r,c,h,x,w){this.acceptsBooleans=e===2||e===3||e===4,this.attributeName=c,this.attributeNamespace=h,this.mustUseProperty=r,this.propertyName=t,this.type=e,this.sanitizeURL=x,this.removeEmptyString=w}var mo={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(t){mo[t]=new nl(t,0,!1,t,null,!1,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(t){var e=t[0];mo[e]=new nl(e,1,!1,t[1],null,!1,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(t){mo[t]=new nl(t,2,!1,t.toLowerCase(),null,!1,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(t){mo[t]=new nl(t,2,!1,t,null,!1,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(t){mo[t]=new nl(t,3,!1,t.toLowerCase(),null,!1,!1)});["checked","multiple","muted","selected"].forEach(function(t){mo[t]=new nl(t,3,!0,t,null,!1,!1)});["capture","download"].forEach(function(t){mo[t]=new nl(t,4,!1,t,null,!1,!1)});["cols","rows","size","span"].forEach(function(t){mo[t]=new nl(t,6,!1,t,null,!1,!1)});["rowSpan","start"].forEach(function(t){mo[t]=new nl(t,5,!1,t.toLowerCase(),null,!1,!1)});var RI=/[\-:]([a-z])/g;function kI(t){return t[1].toUpperCase()}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(t){var e=t.replace(RI,kI);mo[e]=new nl(e,1,!1,t,null,!1,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(t){var e=t.replace(RI,kI);mo[e]=new nl(e,1,!1,t,"http://www.w3.org/1999/xlink",!1,!1)});["xml:base","xml:lang","xml:space"].forEach(function(t){var e=t.replace(RI,kI);mo[e]=new nl(e,1,!1,t,"http://www.w3.org/XML/1998/namespace",!1,!1)});["tabIndex","crossOrigin"].forEach(function(t){mo[t]=new nl(t,1,!1,t.toLowerCase(),null,!1,!1)});mo.xlinkHref=new nl("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1);["src","href","action","formAction"].forEach(function(t){mo[t]=new nl(t,1,!1,t.toLowerCase(),null,!0,!0)});function DI(t,e,r,c){var h=mo.hasOwnProperty(e)?mo[e]:null;(h!==null?h.type!==0:c||!(2<e.length)||e[0]!=="o"&&e[0]!=="O"||e[1]!=="n"&&e[1]!=="N")&&(D7(e,r,h,c)&&(r=null),c||h===null?R7(e)&&(r===null?t.removeAttribute(e):t.setAttribute(e,""+r)):h.mustUseProperty?t[h.propertyName]=r===null?h.type===3?!1:"":r:(e=h.attributeName,c=h.attributeNamespace,r===null?t.removeAttribute(e):(h=h.type,r=h===3||h===4&&r===!0?"":""+r,c?t.setAttributeNS(c,e,r):t.setAttribute(e,r))))}var Xd=P7.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,vw=Symbol.for("react.element"),Kg=Symbol.for("react.portal"),Qg=Symbol.for("react.fragment"),MI=Symbol.for("react.strict_mode"),qC=Symbol.for("react.profiler"),C5=Symbol.for("react.provider"),E5=Symbol.for("react.context"),OI=Symbol.for("react.forward_ref"),$C=Symbol.for("react.suspense"),GC=Symbol.for("react.suspense_list"),LI=Symbol.for("react.memo"),Vh=Symbol.for("react.lazy"),I5=Symbol.for("react.offscreen"),bO=Symbol.iterator;function c0(t){return t===null||typeof t!="object"?null:(t=bO&&t[bO]||t["@@iterator"],typeof t=="function"?t:null)}var Hs=Object.assign,XA;function T0(t){if(XA===void 0)try{throw Error()}catch(r){var e=r.stack.trim().match(/\n( *(at )?)/);XA=e&&e[1]||""}return`
`+XA+t}var YA=!1;function KA(t,e){if(!t||YA)return"";YA=!0;var r=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(e)if(e=function(){throw Error()},Object.defineProperty(e.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(e,[])}catch(R){var c=R}Reflect.construct(t,[],e)}else{try{e.call()}catch(R){c=R}t.call(e.prototype)}else{try{throw Error()}catch(R){c=R}t()}}catch(R){if(R&&c&&typeof R.stack=="string"){for(var h=R.stack.split(`
`),x=c.stack.split(`
`),w=h.length-1,o=x.length-1;1<=w&&0<=o&&h[w]!==x[o];)o--;for(;1<=w&&0<=o;w--,o--)if(h[w]!==x[o]){if(w!==1||o!==1)do if(w--,o--,0>o||h[w]!==x[o]){var C=`
`+h[w].replace(" at new "," at ");return t.displayName&&C.includes("<anonymous>")&&(C=C.replace("<anonymous>",t.displayName)),C}while(1<=w&&0<=o);break}}}finally{YA=!1,Error.prepareStackTrace=r}return(t=t?t.displayName||t.name:"")?T0(t):""}function M7(t){switch(t.tag){case 5:return T0(t.type);case 16:return T0("Lazy");case 13:return T0("Suspense");case 19:return T0("SuspenseList");case 0:case 2:case 15:return t=KA(t.type,!1),t;case 11:return t=KA(t.type.render,!1),t;case 1:return t=KA(t.type,!0),t;default:return""}}function HC(t){if(t==null)return null;if(typeof t=="function")return t.displayName||t.name||null;if(typeof t=="string")return t;switch(t){case Qg:return"Fragment";case Kg:return"Portal";case qC:return"Profiler";case MI:return"StrictMode";case $C:return"Suspense";case GC:return"SuspenseList"}if(typeof t=="object")switch(t.$$typeof){case E5:return(t.displayName||"Context")+".Consumer";case C5:return(t._context.displayName||"Context")+".Provider";case OI:var e=t.render;return t=t.displayName,t||(t=e.displayName||e.name||"",t=t!==""?"ForwardRef("+t+")":"ForwardRef"),t;case LI:return e=t.displayName||null,e!==null?e:HC(t.type)||"Memo";case Vh:e=t._payload,t=t._init;try{return HC(t(e))}catch{}}return null}function O7(t){var e=t.type;switch(t.tag){case 24:return"Cache";case 9:return(e.displayName||"Context")+".Consumer";case 10:return(e._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return t=e.render,t=t.displayName||t.name||"",e.displayName||(t!==""?"ForwardRef("+t+")":"ForwardRef");case 7:return"Fragment";case 5:return e;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return HC(e);case 8:return e===MI?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if(typeof e=="function")return e.displayName||e.name||null;if(typeof e=="string")return e}return null}function vp(t){switch(typeof t){case"boolean":case"number":case"string":case"undefined":return t;case"object":return t;default:return""}}function P5(t){var e=t.type;return(t=t.nodeName)&&t.toLowerCase()==="input"&&(e==="checkbox"||e==="radio")}function L7(t){var e=P5(t)?"checked":"value",r=Object.getOwnPropertyDescriptor(t.constructor.prototype,e),c=""+t[e];if(!t.hasOwnProperty(e)&&typeof r<"u"&&typeof r.get=="function"&&typeof r.set=="function"){var h=r.get,x=r.set;return Object.defineProperty(t,e,{configurable:!0,get:function(){return h.call(this)},set:function(w){c=""+w,x.call(this,w)}}),Object.defineProperty(t,e,{enumerable:r.enumerable}),{getValue:function(){return c},setValue:function(w){c=""+w},stopTracking:function(){t._valueTracker=null,delete t[e]}}}}function bw(t){t._valueTracker||(t._valueTracker=L7(t))}function j5(t){if(!t)return!1;var e=t._valueTracker;if(!e)return!0;var r=e.getValue(),c="";return t&&(c=P5(t)?t.checked?"true":"false":t.value),t=c,t!==r?(e.setValue(t),!0):!1}function C2(t){if(t=t||(typeof document<"u"?document:void 0),typeof t>"u")return null;try{return t.activeElement||t.body}catch{return t.body}}function WC(t,e){var r=e.checked;return Hs({},e,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:r??t._wrapperState.initialChecked})}function wO(t,e){var r=e.defaultValue==null?"":e.defaultValue,c=e.checked!=null?e.checked:e.defaultChecked;r=vp(e.value!=null?e.value:r),t._wrapperState={initialChecked:c,initialValue:r,controlled:e.type==="checkbox"||e.type==="radio"?e.checked!=null:e.value!=null}}function R5(t,e){e=e.checked,e!=null&&DI(t,"checked",e,!1)}function ZC(t,e){R5(t,e);var r=vp(e.value),c=e.type;if(r!=null)c==="number"?(r===0&&t.value===""||t.value!=r)&&(t.value=""+r):t.value!==""+r&&(t.value=""+r);else if(c==="submit"||c==="reset"){t.removeAttribute("value");return}e.hasOwnProperty("value")?XC(t,e.type,r):e.hasOwnProperty("defaultValue")&&XC(t,e.type,vp(e.defaultValue)),e.checked==null&&e.defaultChecked!=null&&(t.defaultChecked=!!e.defaultChecked)}function SO(t,e,r){if(e.hasOwnProperty("value")||e.hasOwnProperty("defaultValue")){var c=e.type;if(!(c!=="submit"&&c!=="reset"||e.value!==void 0&&e.value!==null))return;e=""+t._wrapperState.initialValue,r||e===t.value||(t.value=e),t.defaultValue=e}r=t.name,r!==""&&(t.name=""),t.defaultChecked=!!t._wrapperState.initialChecked,r!==""&&(t.name=r)}function XC(t,e,r){(e!=="number"||C2(t.ownerDocument)!==t)&&(r==null?t.defaultValue=""+t._wrapperState.initialValue:t.defaultValue!==""+r&&(t.defaultValue=""+r))}var N0=Array.isArray;function dy(t,e,r,c){if(t=t.options,e){e={};for(var h=0;h<r.length;h++)e["$"+r[h]]=!0;for(r=0;r<t.length;r++)h=e.hasOwnProperty("$"+t[r].value),t[r].selected!==h&&(t[r].selected=h),h&&c&&(t[r].defaultSelected=!0)}else{for(r=""+vp(r),e=null,h=0;h<t.length;h++){if(t[h].value===r){t[h].selected=!0,c&&(t[h].defaultSelected=!0);return}e!==null||t[h].disabled||(e=t[h])}e!==null&&(e.selected=!0)}}function YC(t,e){if(e.dangerouslySetInnerHTML!=null)throw Error(_i(91));return Hs({},e,{value:void 0,defaultValue:void 0,children:""+t._wrapperState.initialValue})}function TO(t,e){var r=e.value;if(r==null){if(r=e.children,e=e.defaultValue,r!=null){if(e!=null)throw Error(_i(92));if(N0(r)){if(1<r.length)throw Error(_i(93));r=r[0]}e=r}e==null&&(e=""),r=e}t._wrapperState={initialValue:vp(r)}}function k5(t,e){var r=vp(e.value),c=vp(e.defaultValue);r!=null&&(r=""+r,r!==t.value&&(t.value=r),e.defaultValue==null&&t.defaultValue!==r&&(t.defaultValue=r)),c!=null&&(t.defaultValue=""+c)}function NO(t){var e=t.textContent;e===t._wrapperState.initialValue&&e!==""&&e!==null&&(t.value=e)}function D5(t){switch(t){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function KC(t,e){return t==null||t==="http://www.w3.org/1999/xhtml"?D5(e):t==="http://www.w3.org/2000/svg"&&e==="foreignObject"?"http://www.w3.org/1999/xhtml":t}var ww,M5=function(t){return typeof MSApp<"u"&&MSApp.execUnsafeLocalFunction?function(e,r,c,h){MSApp.execUnsafeLocalFunction(function(){return t(e,r,c,h)})}:t}(function(t,e){if(t.namespaceURI!=="http://www.w3.org/2000/svg"||"innerHTML"in t)t.innerHTML=e;else{for(ww=ww||document.createElement("div"),ww.innerHTML="<svg>"+e.valueOf().toString()+"</svg>",e=ww.firstChild;t.firstChild;)t.removeChild(t.firstChild);for(;e.firstChild;)t.appendChild(e.firstChild)}});function rv(t,e){if(e){var r=t.firstChild;if(r&&r===t.lastChild&&r.nodeType===3){r.nodeValue=e;return}}t.textContent=e}var L0={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},F7=["Webkit","ms","Moz","O"];Object.keys(L0).forEach(function(t){F7.forEach(function(e){e=e+t.charAt(0).toUpperCase()+t.substring(1),L0[e]=L0[t]})});function O5(t,e,r){return e==null||typeof e=="boolean"||e===""?"":r||typeof e!="number"||e===0||L0.hasOwnProperty(t)&&L0[t]?(""+e).trim():e+"px"}function L5(t,e){t=t.style;for(var r in e)if(e.hasOwnProperty(r)){var c=r.indexOf("--")===0,h=O5(r,e[r],c);r==="float"&&(r="cssFloat"),c?t.setProperty(r,h):t[r]=h}}var z7=Hs({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function QC(t,e){if(e){if(z7[t]&&(e.children!=null||e.dangerouslySetInnerHTML!=null))throw Error(_i(137,t));if(e.dangerouslySetInnerHTML!=null){if(e.children!=null)throw Error(_i(60));if(typeof e.dangerouslySetInnerHTML!="object"||!("__html"in e.dangerouslySetInnerHTML))throw Error(_i(61))}if(e.style!=null&&typeof e.style!="object")throw Error(_i(62))}}function JC(t,e){if(t.indexOf("-")===-1)return typeof e.is=="string";switch(t){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var eE=null;function FI(t){return t=t.target||t.srcElement||window,t.correspondingUseElement&&(t=t.correspondingUseElement),t.nodeType===3?t.parentNode:t}var tE=null,hy=null,py=null;function AO(t){if(t=zv(t)){if(typeof tE!="function")throw Error(_i(280));var e=t.stateNode;e&&(e=MS(e),tE(t.stateNode,t.type,e))}}function F5(t){hy?py?py.push(t):py=[t]:hy=t}function z5(){if(hy){var t=hy,e=py;if(py=hy=null,AO(t),e)for(t=0;t<e.length;t++)AO(e[t])}}function B5(t,e){return t(e)}function V5(){}var QA=!1;function U5(t,e,r){if(QA)return t(e,r);QA=!0;try{return B5(t,e,r)}finally{QA=!1,(hy!==null||py!==null)&&(V5(),z5())}}function nv(t,e){var r=t.stateNode;if(r===null)return null;var c=MS(r);if(c===null)return null;r=c[e];e:switch(e){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(c=!c.disabled)||(t=t.type,c=!(t==="button"||t==="input"||t==="select"||t==="textarea")),t=!c;break e;default:t=!1}if(t)return null;if(r&&typeof r!="function")throw Error(_i(231,e,typeof r));return r}var iE=!1;if(Fd)try{var u0={};Object.defineProperty(u0,"passive",{get:function(){iE=!0}}),window.addEventListener("test",u0,u0),window.removeEventListener("test",u0,u0)}catch{iE=!1}function B7(t,e,r,c,h,x,w,o,C){var R=Array.prototype.slice.call(arguments,3);try{e.apply(r,R)}catch(F){this.onError(F)}}var F0=!1,E2=null,I2=!1,rE=null,V7={onError:function(t){F0=!0,E2=t}};function U7(t,e,r,c,h,x,w,o,C){F0=!1,E2=null,B7.apply(V7,arguments)}function q7(t,e,r,c,h,x,w,o,C){if(U7.apply(this,arguments),F0){if(F0){var R=E2;F0=!1,E2=null}else throw Error(_i(198));I2||(I2=!0,rE=R)}}function mf(t){var e=t,r=t;if(t.alternate)for(;e.return;)e=e.return;else{t=e;do e=t,e.flags&4098&&(r=e.return),t=e.return;while(t)}return e.tag===3?r:null}function q5(t){if(t.tag===13){var e=t.memoizedState;if(e===null&&(t=t.alternate,t!==null&&(e=t.memoizedState)),e!==null)return e.dehydrated}return null}function CO(t){if(mf(t)!==t)throw Error(_i(188))}function $7(t){var e=t.alternate;if(!e){if(e=mf(t),e===null)throw Error(_i(188));return e!==t?null:t}for(var r=t,c=e;;){var h=r.return;if(h===null)break;var x=h.alternate;if(x===null){if(c=h.return,c!==null){r=c;continue}break}if(h.child===x.child){for(x=h.child;x;){if(x===r)return CO(h),t;if(x===c)return CO(h),e;x=x.sibling}throw Error(_i(188))}if(r.return!==c.return)r=h,c=x;else{for(var w=!1,o=h.child;o;){if(o===r){w=!0,r=h,c=x;break}if(o===c){w=!0,c=h,r=x;break}o=o.sibling}if(!w){for(o=x.child;o;){if(o===r){w=!0,r=x,c=h;break}if(o===c){w=!0,c=x,r=h;break}o=o.sibling}if(!w)throw Error(_i(189))}}if(r.alternate!==c)throw Error(_i(190))}if(r.tag!==3)throw Error(_i(188));return r.stateNode.current===r?t:e}function $5(t){return t=$7(t),t!==null?G5(t):null}function G5(t){if(t.tag===5||t.tag===6)return t;for(t=t.child;t!==null;){var e=G5(t);if(e!==null)return e;t=t.sibling}return null}var H5=Bl.unstable_scheduleCallback,EO=Bl.unstable_cancelCallback,G7=Bl.unstable_shouldYield,H7=Bl.unstable_requestPaint,ma=Bl.unstable_now,W7=Bl.unstable_getCurrentPriorityLevel,zI=Bl.unstable_ImmediatePriority,W5=Bl.unstable_UserBlockingPriority,P2=Bl.unstable_NormalPriority,Z7=Bl.unstable_LowPriority,Z5=Bl.unstable_IdlePriority,jS=null,zu=null;function X7(t){if(zu&&typeof zu.onCommitFiberRoot=="function")try{zu.onCommitFiberRoot(jS,t,void 0,(t.current.flags&128)===128)}catch{}}var Gc=Math.clz32?Math.clz32:Q7,Y7=Math.log,K7=Math.LN2;function Q7(t){return t>>>=0,t===0?32:31-(Y7(t)/K7|0)|0}var Sw=64,Tw=4194304;function A0(t){switch(t&-t){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return t&4194240;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return t&130023424;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return t}}function j2(t,e){var r=t.pendingLanes;if(r===0)return 0;var c=0,h=t.suspendedLanes,x=t.pingedLanes,w=r&268435455;if(w!==0){var o=w&~h;o!==0?c=A0(o):(x&=w,x!==0&&(c=A0(x)))}else w=r&~h,w!==0?c=A0(w):x!==0&&(c=A0(x));if(c===0)return 0;if(e!==0&&e!==c&&!(e&h)&&(h=c&-c,x=e&-e,h>=x||h===16&&(x&4194240)!==0))return e;if(c&4&&(c|=r&16),e=t.entangledLanes,e!==0)for(t=t.entanglements,e&=c;0<e;)r=31-Gc(e),h=1<<r,c|=t[r],e&=~h;return c}function J7(t,e){switch(t){case 1:case 2:case 4:return e+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return e+5e3;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return-1;case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function eG(t,e){for(var r=t.suspendedLanes,c=t.pingedLanes,h=t.expirationTimes,x=t.pendingLanes;0<x;){var w=31-Gc(x),o=1<<w,C=h[w];C===-1?(!(o&r)||o&c)&&(h[w]=J7(o,e)):C<=e&&(t.expiredLanes|=o),x&=~o}}function nE(t){return t=t.pendingLanes&-1073741825,t!==0?t:t&1073741824?1073741824:0}function X5(){var t=Sw;return Sw<<=1,!(Sw&4194240)&&(Sw=64),t}function JA(t){for(var e=[],r=0;31>r;r++)e.push(t);return e}function Lv(t,e,r){t.pendingLanes|=e,e!==536870912&&(t.suspendedLanes=0,t.pingedLanes=0),t=t.eventTimes,e=31-Gc(e),t[e]=r}function tG(t,e){var r=t.pendingLanes&~e;t.pendingLanes=e,t.suspendedLanes=0,t.pingedLanes=0,t.expiredLanes&=e,t.mutableReadLanes&=e,t.entangledLanes&=e,e=t.entanglements;var c=t.eventTimes;for(t=t.expirationTimes;0<r;){var h=31-Gc(r),x=1<<h;e[h]=0,c[h]=-1,t[h]=-1,r&=~x}}function BI(t,e){var r=t.entangledLanes|=e;for(t=t.entanglements;r;){var c=31-Gc(r),h=1<<c;h&e|t[c]&e&&(t[c]|=e),r&=~h}}var Qn=0;function Y5(t){return t&=-t,1<t?4<t?t&268435455?16:536870912:4:1}var K5,VI,Q5,J5,eF,sE=!1,Nw=[],sp=null,ap=null,op=null,sv=new Map,av=new Map,Gh=[],iG="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function IO(t,e){switch(t){case"focusin":case"focusout":sp=null;break;case"dragenter":case"dragleave":ap=null;break;case"mouseover":case"mouseout":op=null;break;case"pointerover":case"pointerout":sv.delete(e.pointerId);break;case"gotpointercapture":case"lostpointercapture":av.delete(e.pointerId)}}function d0(t,e,r,c,h,x){return t===null||t.nativeEvent!==x?(t={blockedOn:e,domEventName:r,eventSystemFlags:c,nativeEvent:x,targetContainers:[h]},e!==null&&(e=zv(e),e!==null&&VI(e)),t):(t.eventSystemFlags|=c,e=t.targetContainers,h!==null&&e.indexOf(h)===-1&&e.push(h),t)}function rG(t,e,r,c,h){switch(e){case"focusin":return sp=d0(sp,t,e,r,c,h),!0;case"dragenter":return ap=d0(ap,t,e,r,c,h),!0;case"mouseover":return op=d0(op,t,e,r,c,h),!0;case"pointerover":var x=h.pointerId;return sv.set(x,d0(sv.get(x)||null,t,e,r,c,h)),!0;case"gotpointercapture":return x=h.pointerId,av.set(x,d0(av.get(x)||null,t,e,r,c,h)),!0}return!1}function tF(t){var e=zm(t.target);if(e!==null){var r=mf(e);if(r!==null){if(e=r.tag,e===13){if(e=q5(r),e!==null){t.blockedOn=e,eF(t.priority,function(){Q5(r)});return}}else if(e===3&&r.stateNode.current.memoizedState.isDehydrated){t.blockedOn=r.tag===3?r.stateNode.containerInfo:null;return}}}t.blockedOn=null}function e2(t){if(t.blockedOn!==null)return!1;for(var e=t.targetContainers;0<e.length;){var r=aE(t.domEventName,t.eventSystemFlags,e[0],t.nativeEvent);if(r===null){r=t.nativeEvent;var c=new r.constructor(r.type,r);eE=c,r.target.dispatchEvent(c),eE=null}else return e=zv(r),e!==null&&VI(e),t.blockedOn=r,!1;e.shift()}return!0}function PO(t,e,r){e2(t)&&r.delete(e)}function nG(){sE=!1,sp!==null&&e2(sp)&&(sp=null),ap!==null&&e2(ap)&&(ap=null),op!==null&&e2(op)&&(op=null),sv.forEach(PO),av.forEach(PO)}function h0(t,e){t.blockedOn===e&&(t.blockedOn=null,sE||(sE=!0,Bl.unstable_scheduleCallback(Bl.unstable_NormalPriority,nG)))}function ov(t){function e(h){return h0(h,t)}if(0<Nw.length){h0(Nw[0],t);for(var r=1;r<Nw.length;r++){var c=Nw[r];c.blockedOn===t&&(c.blockedOn=null)}}for(sp!==null&&h0(sp,t),ap!==null&&h0(ap,t),op!==null&&h0(op,t),sv.forEach(e),av.forEach(e),r=0;r<Gh.length;r++)c=Gh[r],c.blockedOn===t&&(c.blockedOn=null);for(;0<Gh.length&&(r=Gh[0],r.blockedOn===null);)tF(r),r.blockedOn===null&&Gh.shift()}var my=Xd.ReactCurrentBatchConfig,R2=!0;function sG(t,e,r,c){var h=Qn,x=my.transition;my.transition=null;try{Qn=1,UI(t,e,r,c)}finally{Qn=h,my.transition=x}}function aG(t,e,r,c){var h=Qn,x=my.transition;my.transition=null;try{Qn=4,UI(t,e,r,c)}finally{Qn=h,my.transition=x}}function UI(t,e,r,c){if(R2){var h=aE(t,e,r,c);if(h===null)cC(t,e,c,k2,r),IO(t,c);else if(rG(h,t,e,r,c))c.stopPropagation();else if(IO(t,c),e&4&&-1<iG.indexOf(t)){for(;h!==null;){var x=zv(h);if(x!==null&&K5(x),x=aE(t,e,r,c),x===null&&cC(t,e,c,k2,r),x===h)break;h=x}h!==null&&c.stopPropagation()}else cC(t,e,c,null,r)}}var k2=null;function aE(t,e,r,c){if(k2=null,t=FI(c),t=zm(t),t!==null)if(e=mf(t),e===null)t=null;else if(r=e.tag,r===13){if(t=q5(e),t!==null)return t;t=null}else if(r===3){if(e.stateNode.current.memoizedState.isDehydrated)return e.tag===3?e.stateNode.containerInfo:null;t=null}else e!==t&&(t=null);return k2=t,null}function iF(t){switch(t){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(W7()){case zI:return 1;case W5:return 4;case P2:case Z7:return 16;case Z5:return 536870912;default:return 16}default:return 16}}var Jh=null,qI=null,t2=null;function rF(){if(t2)return t2;var t,e=qI,r=e.length,c,h="value"in Jh?Jh.value:Jh.textContent,x=h.length;for(t=0;t<r&&e[t]===h[t];t++);var w=r-t;for(c=1;c<=w&&e[r-c]===h[x-c];c++);return t2=h.slice(t,1<c?1-c:void 0)}function i2(t){var e=t.keyCode;return"charCode"in t?(t=t.charCode,t===0&&e===13&&(t=13)):t=e,t===10&&(t=13),32<=t||t===13?t:0}function Aw(){return!0}function jO(){return!1}function $l(t){function e(r,c,h,x,w){this._reactName=r,this._targetInst=h,this.type=c,this.nativeEvent=x,this.target=w,this.currentTarget=null;for(var o in t)t.hasOwnProperty(o)&&(r=t[o],this[o]=r?r(x):x[o]);return this.isDefaultPrevented=(x.defaultPrevented!=null?x.defaultPrevented:x.returnValue===!1)?Aw:jO,this.isPropagationStopped=jO,this}return Hs(e.prototype,{preventDefault:function(){this.defaultPrevented=!0;var r=this.nativeEvent;r&&(r.preventDefault?r.preventDefault():typeof r.returnValue!="unknown"&&(r.returnValue=!1),this.isDefaultPrevented=Aw)},stopPropagation:function(){var r=this.nativeEvent;r&&(r.stopPropagation?r.stopPropagation():typeof r.cancelBubble!="unknown"&&(r.cancelBubble=!0),this.isPropagationStopped=Aw)},persist:function(){},isPersistent:Aw}),e}var $y={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(t){return t.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},$I=$l($y),Fv=Hs({},$y,{view:0,detail:0}),oG=$l(Fv),eC,tC,p0,RS=Hs({},Fv,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:GI,button:0,buttons:0,relatedTarget:function(t){return t.relatedTarget===void 0?t.fromElement===t.srcElement?t.toElement:t.fromElement:t.relatedTarget},movementX:function(t){return"movementX"in t?t.movementX:(t!==p0&&(p0&&t.type==="mousemove"?(eC=t.screenX-p0.screenX,tC=t.screenY-p0.screenY):tC=eC=0,p0=t),eC)},movementY:function(t){return"movementY"in t?t.movementY:tC}}),RO=$l(RS),lG=Hs({},RS,{dataTransfer:0}),cG=$l(lG),uG=Hs({},Fv,{relatedTarget:0}),iC=$l(uG),dG=Hs({},$y,{animationName:0,elapsedTime:0,pseudoElement:0}),hG=$l(dG),pG=Hs({},$y,{clipboardData:function(t){return"clipboardData"in t?t.clipboardData:window.clipboardData}}),mG=$l(pG),fG=Hs({},$y,{data:0}),kO=$l(fG),gG={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},yG={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},xG={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function _G(t){var e=this.nativeEvent;return e.getModifierState?e.getModifierState(t):(t=xG[t])?!!e[t]:!1}function GI(){return _G}var vG=Hs({},Fv,{key:function(t){if(t.key){var e=gG[t.key]||t.key;if(e!=="Unidentified")return e}return t.type==="keypress"?(t=i2(t),t===13?"Enter":String.fromCharCode(t)):t.type==="keydown"||t.type==="keyup"?yG[t.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:GI,charCode:function(t){return t.type==="keypress"?i2(t):0},keyCode:function(t){return t.type==="keydown"||t.type==="keyup"?t.keyCode:0},which:function(t){return t.type==="keypress"?i2(t):t.type==="keydown"||t.type==="keyup"?t.keyCode:0}}),bG=$l(vG),wG=Hs({},RS,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),DO=$l(wG),SG=Hs({},Fv,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:GI}),TG=$l(SG),NG=Hs({},$y,{propertyName:0,elapsedTime:0,pseudoElement:0}),AG=$l(NG),CG=Hs({},RS,{deltaX:function(t){return"deltaX"in t?t.deltaX:"wheelDeltaX"in t?-t.wheelDeltaX:0},deltaY:function(t){return"deltaY"in t?t.deltaY:"wheelDeltaY"in t?-t.wheelDeltaY:"wheelDelta"in t?-t.wheelDelta:0},deltaZ:0,deltaMode:0}),EG=$l(CG),IG=[9,13,27,32],HI=Fd&&"CompositionEvent"in window,z0=null;Fd&&"documentMode"in document&&(z0=document.documentMode);var PG=Fd&&"TextEvent"in window&&!z0,nF=Fd&&(!HI||z0&&8<z0&&11>=z0),MO=" ",OO=!1;function sF(t,e){switch(t){case"keyup":return IG.indexOf(e.keyCode)!==-1;case"keydown":return e.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function aF(t){return t=t.detail,typeof t=="object"&&"data"in t?t.data:null}var Jg=!1;function jG(t,e){switch(t){case"compositionend":return aF(e);case"keypress":return e.which!==32?null:(OO=!0,MO);case"textInput":return t=e.data,t===MO&&OO?null:t;default:return null}}function RG(t,e){if(Jg)return t==="compositionend"||!HI&&sF(t,e)?(t=rF(),t2=qI=Jh=null,Jg=!1,t):null;switch(t){case"paste":return null;case"keypress":if(!(e.ctrlKey||e.altKey||e.metaKey)||e.ctrlKey&&e.altKey){if(e.char&&1<e.char.length)return e.char;if(e.which)return String.fromCharCode(e.which)}return null;case"compositionend":return nF&&e.locale!=="ko"?null:e.data;default:return null}}var kG={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function LO(t){var e=t&&t.nodeName&&t.nodeName.toLowerCase();return e==="input"?!!kG[t.type]:e==="textarea"}function oF(t,e,r,c){F5(c),e=D2(e,"onChange"),0<e.length&&(r=new $I("onChange","change",null,r,c),t.push({event:r,listeners:e}))}var B0=null,lv=null;function DG(t){xF(t,0)}function kS(t){var e=iy(t);if(j5(e))return t}function MG(t,e){if(t==="change")return e}var lF=!1;if(Fd){var rC;if(Fd){var nC="oninput"in document;if(!nC){var FO=document.createElement("div");FO.setAttribute("oninput","return;"),nC=typeof FO.oninput=="function"}rC=nC}else rC=!1;lF=rC&&(!document.documentMode||9<document.documentMode)}function zO(){B0&&(B0.detachEvent("onpropertychange",cF),lv=B0=null)}function cF(t){if(t.propertyName==="value"&&kS(lv)){var e=[];oF(e,lv,t,FI(t)),U5(DG,e)}}function OG(t,e,r){t==="focusin"?(zO(),B0=e,lv=r,B0.attachEvent("onpropertychange",cF)):t==="focusout"&&zO()}function LG(t){if(t==="selectionchange"||t==="keyup"||t==="keydown")return kS(lv)}function FG(t,e){if(t==="click")return kS(e)}function zG(t,e){if(t==="input"||t==="change")return kS(e)}function BG(t,e){return t===e&&(t!==0||1/t===1/e)||t!==t&&e!==e}var Zc=typeof Object.is=="function"?Object.is:BG;function cv(t,e){if(Zc(t,e))return!0;if(typeof t!="object"||t===null||typeof e!="object"||e===null)return!1;var r=Object.keys(t),c=Object.keys(e);if(r.length!==c.length)return!1;for(c=0;c<r.length;c++){var h=r[c];if(!UC.call(e,h)||!Zc(t[h],e[h]))return!1}return!0}function BO(t){for(;t&&t.firstChild;)t=t.firstChild;return t}function VO(t,e){var r=BO(t);t=0;for(var c;r;){if(r.nodeType===3){if(c=t+r.textContent.length,t<=e&&c>=e)return{node:r,offset:e-t};t=c}e:{for(;r;){if(r.nextSibling){r=r.nextSibling;break e}r=r.parentNode}r=void 0}r=BO(r)}}function uF(t,e){return t&&e?t===e?!0:t&&t.nodeType===3?!1:e&&e.nodeType===3?uF(t,e.parentNode):"contains"in t?t.contains(e):t.compareDocumentPosition?!!(t.compareDocumentPosition(e)&16):!1:!1}function dF(){for(var t=window,e=C2();e instanceof t.HTMLIFrameElement;){try{var r=typeof e.contentWindow.location.href=="string"}catch{r=!1}if(r)t=e.contentWindow;else break;e=C2(t.document)}return e}function WI(t){var e=t&&t.nodeName&&t.nodeName.toLowerCase();return e&&(e==="input"&&(t.type==="text"||t.type==="search"||t.type==="tel"||t.type==="url"||t.type==="password")||e==="textarea"||t.contentEditable==="true")}function VG(t){var e=dF(),r=t.focusedElem,c=t.selectionRange;if(e!==r&&r&&r.ownerDocument&&uF(r.ownerDocument.documentElement,r)){if(c!==null&&WI(r)){if(e=c.start,t=c.end,t===void 0&&(t=e),"selectionStart"in r)r.selectionStart=e,r.selectionEnd=Math.min(t,r.value.length);else if(t=(e=r.ownerDocument||document)&&e.defaultView||window,t.getSelection){t=t.getSelection();var h=r.textContent.length,x=Math.min(c.start,h);c=c.end===void 0?x:Math.min(c.end,h),!t.extend&&x>c&&(h=c,c=x,x=h),h=VO(r,x);var w=VO(r,c);h&&w&&(t.rangeCount!==1||t.anchorNode!==h.node||t.anchorOffset!==h.offset||t.focusNode!==w.node||t.focusOffset!==w.offset)&&(e=e.createRange(),e.setStart(h.node,h.offset),t.removeAllRanges(),x>c?(t.addRange(e),t.extend(w.node,w.offset)):(e.setEnd(w.node,w.offset),t.addRange(e)))}}for(e=[],t=r;t=t.parentNode;)t.nodeType===1&&e.push({element:t,left:t.scrollLeft,top:t.scrollTop});for(typeof r.focus=="function"&&r.focus(),r=0;r<e.length;r++)t=e[r],t.element.scrollLeft=t.left,t.element.scrollTop=t.top}}var UG=Fd&&"documentMode"in document&&11>=document.documentMode,ey=null,oE=null,V0=null,lE=!1;function UO(t,e,r){var c=r.window===r?r.document:r.nodeType===9?r:r.ownerDocument;lE||ey==null||ey!==C2(c)||(c=ey,"selectionStart"in c&&WI(c)?c={start:c.selectionStart,end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset}),V0&&cv(V0,c)||(V0=c,c=D2(oE,"onSelect"),0<c.length&&(e=new $I("onSelect","select",null,e,r),t.push({event:e,listeners:c}),e.target=ey)))}function Cw(t,e){var r={};return r[t.toLowerCase()]=e.toLowerCase(),r["Webkit"+t]="webkit"+e,r["Moz"+t]="moz"+e,r}var ty={animationend:Cw("Animation","AnimationEnd"),animationiteration:Cw("Animation","AnimationIteration"),animationstart:Cw("Animation","AnimationStart"),transitionend:Cw("Transition","TransitionEnd")},sC={},hF={};Fd&&(hF=document.createElement("div").style,"AnimationEvent"in window||(delete ty.animationend.animation,delete ty.animationiteration.animation,delete ty.animationstart.animation),"TransitionEvent"in window||delete ty.transitionend.transition);function DS(t){if(sC[t])return sC[t];if(!ty[t])return t;var e=ty[t],r;for(r in e)if(e.hasOwnProperty(r)&&r in hF)return sC[t]=e[r];return t}var pF=DS("animationend"),mF=DS("animationiteration"),fF=DS("animationstart"),gF=DS("transitionend"),yF=new Map,qO="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function Ep(t,e){yF.set(t,e),pf(e,[t])}for(var aC=0;aC<qO.length;aC++){var oC=qO[aC],qG=oC.toLowerCase(),$G=oC[0].toUpperCase()+oC.slice(1);Ep(qG,"on"+$G)}Ep(pF,"onAnimationEnd");Ep(mF,"onAnimationIteration");Ep(fF,"onAnimationStart");Ep("dblclick","onDoubleClick");Ep("focusin","onFocus");Ep("focusout","onBlur");Ep(gF,"onTransitionEnd");wy("onMouseEnter",["mouseout","mouseover"]);wy("onMouseLeave",["mouseout","mouseover"]);wy("onPointerEnter",["pointerout","pointerover"]);wy("onPointerLeave",["pointerout","pointerover"]);pf("onChange","change click focusin focusout input keydown keyup selectionchange".split(" "));pf("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" "));pf("onBeforeInput",["compositionend","keypress","textInput","paste"]);pf("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" "));pf("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" "));pf("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var C0="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),GG=new Set("cancel close invalid load scroll toggle".split(" ").concat(C0));function $O(t,e,r){var c=t.type||"unknown-event";t.currentTarget=r,q7(c,e,void 0,t),t.currentTarget=null}function xF(t,e){e=(e&4)!==0;for(var r=0;r<t.length;r++){var c=t[r],h=c.event;c=c.listeners;e:{var x=void 0;if(e)for(var w=c.length-1;0<=w;w--){var o=c[w],C=o.instance,R=o.currentTarget;if(o=o.listener,C!==x&&h.isPropagationStopped())break e;$O(h,o,R),x=C}else for(w=0;w<c.length;w++){if(o=c[w],C=o.instance,R=o.currentTarget,o=o.listener,C!==x&&h.isPropagationStopped())break e;$O(h,o,R),x=C}}}if(I2)throw t=rE,I2=!1,rE=null,t}function ws(t,e){var r=e[pE];r===void 0&&(r=e[pE]=new Set);var c=t+"__bubble";r.has(c)||(_F(e,t,2,!1),r.add(c))}function lC(t,e,r){var c=0;e&&(c|=4),_F(r,t,c,e)}var Ew="_reactListening"+Math.random().toString(36).slice(2);function uv(t){if(!t[Ew]){t[Ew]=!0,A5.forEach(function(r){r!=="selectionchange"&&(GG.has(r)||lC(r,!1,t),lC(r,!0,t))});var e=t.nodeType===9?t:t.ownerDocument;e===null||e[Ew]||(e[Ew]=!0,lC("selectionchange",!1,e))}}function _F(t,e,r,c){switch(iF(e)){case 1:var h=sG;break;case 4:h=aG;break;default:h=UI}r=h.bind(null,e,r,t),h=void 0,!iE||e!=="touchstart"&&e!=="touchmove"&&e!=="wheel"||(h=!0),c?h!==void 0?t.addEventListener(e,r,{capture:!0,passive:h}):t.addEventListener(e,r,!0):h!==void 0?t.addEventListener(e,r,{passive:h}):t.addEventListener(e,r,!1)}function cC(t,e,r,c,h){var x=c;if(!(e&1)&&!(e&2)&&c!==null)e:for(;;){if(c===null)return;var w=c.tag;if(w===3||w===4){var o=c.stateNode.containerInfo;if(o===h||o.nodeType===8&&o.parentNode===h)break;if(w===4)for(w=c.return;w!==null;){var C=w.tag;if((C===3||C===4)&&(C=w.stateNode.containerInfo,C===h||C.nodeType===8&&C.parentNode===h))return;w=w.return}for(;o!==null;){if(w=zm(o),w===null)return;if(C=w.tag,C===5||C===6){c=x=w;continue e}o=o.parentNode}}c=c.return}U5(function(){var R=x,F=FI(r),$=[];e:{var Y=yF.get(t);if(Y!==void 0){var H=$I,X=t;switch(t){case"keypress":if(i2(r)===0)break e;case"keydown":case"keyup":H=bG;break;case"focusin":X="focus",H=iC;break;case"focusout":X="blur",H=iC;break;case"beforeblur":case"afterblur":H=iC;break;case"click":if(r.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":H=RO;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":H=cG;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":H=TG;break;case pF:case mF:case fF:H=hG;break;case gF:H=AG;break;case"scroll":H=oG;break;case"wheel":H=EG;break;case"copy":case"cut":case"paste":H=mG;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":H=DO}var he=(e&4)!==0,se=!he&&t==="scroll",de=he?Y!==null?Y+"Capture":null:Y;he=[];for(var K=R,ge;K!==null;){ge=K;var Ae=ge.stateNode;if(ge.tag===5&&Ae!==null&&(ge=Ae,de!==null&&(Ae=nv(K,de),Ae!=null&&he.push(dv(K,Ae,ge)))),se)break;K=K.return}0<he.length&&(Y=new H(Y,X,null,r,F),$.push({event:Y,listeners:he}))}}if(!(e&7)){e:{if(Y=t==="mouseover"||t==="pointerover",H=t==="mouseout"||t==="pointerout",Y&&r!==eE&&(X=r.relatedTarget||r.fromElement)&&(zm(X)||X[zd]))break e;if((H||Y)&&(Y=F.window===F?F:(Y=F.ownerDocument)?Y.defaultView||Y.parentWindow:window,H?(X=r.relatedTarget||r.toElement,H=R,X=X?zm(X):null,X!==null&&(se=mf(X),X!==se||X.tag!==5&&X.tag!==6)&&(X=null)):(H=null,X=R),H!==X)){if(he=RO,Ae="onMouseLeave",de="onMouseEnter",K="mouse",(t==="pointerout"||t==="pointerover")&&(he=DO,Ae="onPointerLeave",de="onPointerEnter",K="pointer"),se=H==null?Y:iy(H),ge=X==null?Y:iy(X),Y=new he(Ae,K+"leave",H,r,F),Y.target=se,Y.relatedTarget=ge,Ae=null,zm(F)===R&&(he=new he(de,K+"enter",X,r,F),he.target=ge,he.relatedTarget=se,Ae=he),se=Ae,H&&X)t:{for(he=H,de=X,K=0,ge=he;ge;ge=Ug(ge))K++;for(ge=0,Ae=de;Ae;Ae=Ug(Ae))ge++;for(;0<K-ge;)he=Ug(he),K--;for(;0<ge-K;)de=Ug(de),ge--;for(;K--;){if(he===de||de!==null&&he===de.alternate)break t;he=Ug(he),de=Ug(de)}he=null}else he=null;H!==null&&GO($,Y,H,he,!1),X!==null&&se!==null&&GO($,se,X,he,!0)}}e:{if(Y=R?iy(R):window,H=Y.nodeName&&Y.nodeName.toLowerCase(),H==="select"||H==="input"&&Y.type==="file")var Te=MG;else if(LO(Y))if(lF)Te=zG;else{Te=LG;var Ce=OG}else(H=Y.nodeName)&&H.toLowerCase()==="input"&&(Y.type==="checkbox"||Y.type==="radio")&&(Te=FG);if(Te&&(Te=Te(t,R))){oF($,Te,r,F);break e}Ce&&Ce(t,Y,R),t==="focusout"&&(Ce=Y._wrapperState)&&Ce.controlled&&Y.type==="number"&&XC(Y,"number",Y.value)}switch(Ce=R?iy(R):window,t){case"focusin":(LO(Ce)||Ce.contentEditable==="true")&&(ey=Ce,oE=R,V0=null);break;case"focusout":V0=oE=ey=null;break;case"mousedown":lE=!0;break;case"contextmenu":case"mouseup":case"dragend":lE=!1,UO($,r,F);break;case"selectionchange":if(UG)break;case"keydown":case"keyup":UO($,r,F)}var ne;if(HI)e:{switch(t){case"compositionstart":var ae="onCompositionStart";break e;case"compositionend":ae="onCompositionEnd";break e;case"compositionupdate":ae="onCompositionUpdate";break e}ae=void 0}else Jg?sF(t,r)&&(ae="onCompositionEnd"):t==="keydown"&&r.keyCode===229&&(ae="onCompositionStart");ae&&(nF&&r.locale!=="ko"&&(Jg||ae!=="onCompositionStart"?ae==="onCompositionEnd"&&Jg&&(ne=rF()):(Jh=F,qI="value"in Jh?Jh.value:Jh.textContent,Jg=!0)),Ce=D2(R,ae),0<Ce.length&&(ae=new kO(ae,t,null,r,F),$.push({event:ae,listeners:Ce}),ne?ae.data=ne:(ne=aF(r),ne!==null&&(ae.data=ne)))),(ne=PG?jG(t,r):RG(t,r))&&(R=D2(R,"onBeforeInput"),0<R.length&&(F=new kO("onBeforeInput","beforeinput",null,r,F),$.push({event:F,listeners:R}),F.data=ne))}xF($,e)})}function dv(t,e,r){return{instance:t,listener:e,currentTarget:r}}function D2(t,e){for(var r=e+"Capture",c=[];t!==null;){var h=t,x=h.stateNode;h.tag===5&&x!==null&&(h=x,x=nv(t,r),x!=null&&c.unshift(dv(t,x,h)),x=nv(t,e),x!=null&&c.push(dv(t,x,h))),t=t.return}return c}function Ug(t){if(t===null)return null;do t=t.return;while(t&&t.tag!==5);return t||null}function GO(t,e,r,c,h){for(var x=e._reactName,w=[];r!==null&&r!==c;){var o=r,C=o.alternate,R=o.stateNode;if(C!==null&&C===c)break;o.tag===5&&R!==null&&(o=R,h?(C=nv(r,x),C!=null&&w.unshift(dv(r,C,o))):h||(C=nv(r,x),C!=null&&w.push(dv(r,C,o)))),r=r.return}w.length!==0&&t.push({event:e,listeners:w})}var HG=/\r\n?/g,WG=/\u0000|\uFFFD/g;function HO(t){return(typeof t=="string"?t:""+t).replace(HG,`
`).replace(WG,"")}function Iw(t,e,r){if(e=HO(e),HO(t)!==e&&r)throw Error(_i(425))}function M2(){}var cE=null,uE=null;function dE(t,e){return t==="textarea"||t==="noscript"||typeof e.children=="string"||typeof e.children=="number"||typeof e.dangerouslySetInnerHTML=="object"&&e.dangerouslySetInnerHTML!==null&&e.dangerouslySetInnerHTML.__html!=null}var hE=typeof setTimeout=="function"?setTimeout:void 0,ZG=typeof clearTimeout=="function"?clearTimeout:void 0,WO=typeof Promise=="function"?Promise:void 0,XG=typeof queueMicrotask=="function"?queueMicrotask:typeof WO<"u"?function(t){return WO.resolve(null).then(t).catch(YG)}:hE;function YG(t){setTimeout(function(){throw t})}function uC(t,e){var r=e,c=0;do{var h=r.nextSibling;if(t.removeChild(r),h&&h.nodeType===8)if(r=h.data,r==="/$"){if(c===0){t.removeChild(h),ov(e);return}c--}else r!=="$"&&r!=="$?"&&r!=="$!"||c++;r=h}while(r);ov(e)}function lp(t){for(;t!=null;t=t.nextSibling){var e=t.nodeType;if(e===1||e===3)break;if(e===8){if(e=t.data,e==="$"||e==="$!"||e==="$?")break;if(e==="/$")return null}}return t}function ZO(t){t=t.previousSibling;for(var e=0;t;){if(t.nodeType===8){var r=t.data;if(r==="$"||r==="$!"||r==="$?"){if(e===0)return t;e--}else r==="/$"&&e++}t=t.previousSibling}return null}var Gy=Math.random().toString(36).slice(2),Lu="__reactFiber$"+Gy,hv="__reactProps$"+Gy,zd="__reactContainer$"+Gy,pE="__reactEvents$"+Gy,KG="__reactListeners$"+Gy,QG="__reactHandles$"+Gy;function zm(t){var e=t[Lu];if(e)return e;for(var r=t.parentNode;r;){if(e=r[zd]||r[Lu]){if(r=e.alternate,e.child!==null||r!==null&&r.child!==null)for(t=ZO(t);t!==null;){if(r=t[Lu])return r;t=ZO(t)}return e}t=r,r=t.parentNode}return null}function zv(t){return t=t[Lu]||t[zd],!t||t.tag!==5&&t.tag!==6&&t.tag!==13&&t.tag!==3?null:t}function iy(t){if(t.tag===5||t.tag===6)return t.stateNode;throw Error(_i(33))}function MS(t){return t[hv]||null}var mE=[],ry=-1;function Ip(t){return{current:t}}function Ts(t){0>ry||(t.current=mE[ry],mE[ry]=null,ry--)}function us(t,e){ry++,mE[ry]=t.current,t.current=e}var bp={},Mo=Ip(bp),xl=Ip(!1),Ym=bp;function Sy(t,e){var r=t.type.contextTypes;if(!r)return bp;var c=t.stateNode;if(c&&c.__reactInternalMemoizedUnmaskedChildContext===e)return c.__reactInternalMemoizedMaskedChildContext;var h={},x;for(x in r)h[x]=e[x];return c&&(t=t.stateNode,t.__reactInternalMemoizedUnmaskedChildContext=e,t.__reactInternalMemoizedMaskedChildContext=h),h}function _l(t){return t=t.childContextTypes,t!=null}function O2(){Ts(xl),Ts(Mo)}function XO(t,e,r){if(Mo.current!==bp)throw Error(_i(168));us(Mo,e),us(xl,r)}function vF(t,e,r){var c=t.stateNode;if(e=e.childContextTypes,typeof c.getChildContext!="function")return r;c=c.getChildContext();for(var h in c)if(!(h in e))throw Error(_i(108,O7(t)||"Unknown",h));return Hs({},r,c)}function L2(t){return t=(t=t.stateNode)&&t.__reactInternalMemoizedMergedChildContext||bp,Ym=Mo.current,us(Mo,t),us(xl,xl.current),!0}function YO(t,e,r){var c=t.stateNode;if(!c)throw Error(_i(169));r?(t=vF(t,e,Ym),c.__reactInternalMemoizedMergedChildContext=t,Ts(xl),Ts(Mo),us(Mo,t)):Ts(xl),us(xl,r)}var Cd=null,OS=!1,dC=!1;function bF(t){Cd===null?Cd=[t]:Cd.push(t)}function JG(t){OS=!0,bF(t)}function Pp(){if(!dC&&Cd!==null){dC=!0;var t=0,e=Qn;try{var r=Cd;for(Qn=1;t<r.length;t++){var c=r[t];do c=c(!0);while(c!==null)}Cd=null,OS=!1}catch(h){throw Cd!==null&&(Cd=Cd.slice(t+1)),H5(zI,Pp),h}finally{Qn=e,dC=!1}}return null}var ny=[],sy=0,F2=null,z2=0,dc=[],hc=0,Km=null,Ed=1,Id="";function Mm(t,e){ny[sy++]=z2,ny[sy++]=F2,F2=t,z2=e}function wF(t,e,r){dc[hc++]=Ed,dc[hc++]=Id,dc[hc++]=Km,Km=t;var c=Ed;t=Id;var h=32-Gc(c)-1;c&=~(1<<h),r+=1;var x=32-Gc(e)+h;if(30<x){var w=h-h%5;x=(c&(1<<w)-1).toString(32),c>>=w,h-=w,Ed=1<<32-Gc(e)+h|r<<h|c,Id=x+t}else Ed=1<<x|r<<h|c,Id=t}function ZI(t){t.return!==null&&(Mm(t,1),wF(t,1,0))}function XI(t){for(;t===F2;)F2=ny[--sy],ny[sy]=null,z2=ny[--sy],ny[sy]=null;for(;t===Km;)Km=dc[--hc],dc[hc]=null,Id=dc[--hc],dc[hc]=null,Ed=dc[--hc],dc[hc]=null}var Fl=null,Dl=null,ks=!1,$c=null;function SF(t,e){var r=pc(5,null,null,0);r.elementType="DELETED",r.stateNode=e,r.return=t,e=t.deletions,e===null?(t.deletions=[r],t.flags|=16):e.push(r)}function KO(t,e){switch(t.tag){case 5:var r=t.type;return e=e.nodeType!==1||r.toLowerCase()!==e.nodeName.toLowerCase()?null:e,e!==null?(t.stateNode=e,Fl=t,Dl=lp(e.firstChild),!0):!1;case 6:return e=t.pendingProps===""||e.nodeType!==3?null:e,e!==null?(t.stateNode=e,Fl=t,Dl=null,!0):!1;case 13:return e=e.nodeType!==8?null:e,e!==null?(r=Km!==null?{id:Ed,overflow:Id}:null,t.memoizedState={dehydrated:e,treeContext:r,retryLane:1073741824},r=pc(18,null,null,0),r.stateNode=e,r.return=t,t.child=r,Fl=t,Dl=null,!0):!1;default:return!1}}function fE(t){return(t.mode&1)!==0&&(t.flags&128)===0}function gE(t){if(ks){var e=Dl;if(e){var r=e;if(!KO(t,e)){if(fE(t))throw Error(_i(418));e=lp(r.nextSibling);var c=Fl;e&&KO(t,e)?SF(c,r):(t.flags=t.flags&-4097|2,ks=!1,Fl=t)}}else{if(fE(t))throw Error(_i(418));t.flags=t.flags&-4097|2,ks=!1,Fl=t}}}function QO(t){for(t=t.return;t!==null&&t.tag!==5&&t.tag!==3&&t.tag!==13;)t=t.return;Fl=t}function Pw(t){if(t!==Fl)return!1;if(!ks)return QO(t),ks=!0,!1;var e;if((e=t.tag!==3)&&!(e=t.tag!==5)&&(e=t.type,e=e!=="head"&&e!=="body"&&!dE(t.type,t.memoizedProps)),e&&(e=Dl)){if(fE(t))throw TF(),Error(_i(418));for(;e;)SF(t,e),e=lp(e.nextSibling)}if(QO(t),t.tag===13){if(t=t.memoizedState,t=t!==null?t.dehydrated:null,!t)throw Error(_i(317));e:{for(t=t.nextSibling,e=0;t;){if(t.nodeType===8){var r=t.data;if(r==="/$"){if(e===0){Dl=lp(t.nextSibling);break e}e--}else r!=="$"&&r!=="$!"&&r!=="$?"||e++}t=t.nextSibling}Dl=null}}else Dl=Fl?lp(t.stateNode.nextSibling):null;return!0}function TF(){for(var t=Dl;t;)t=lp(t.nextSibling)}function Ty(){Dl=Fl=null,ks=!1}function YI(t){$c===null?$c=[t]:$c.push(t)}var eH=Xd.ReactCurrentBatchConfig;function m0(t,e,r){if(t=r.ref,t!==null&&typeof t!="function"&&typeof t!="object"){if(r._owner){if(r=r._owner,r){if(r.tag!==1)throw Error(_i(309));var c=r.stateNode}if(!c)throw Error(_i(147,t));var h=c,x=""+t;return e!==null&&e.ref!==null&&typeof e.ref=="function"&&e.ref._stringRef===x?e.ref:(e=function(w){var o=h.refs;w===null?delete o[x]:o[x]=w},e._stringRef=x,e)}if(typeof t!="string")throw Error(_i(284));if(!r._owner)throw Error(_i(290,t))}return t}function jw(t,e){throw t=Object.prototype.toString.call(e),Error(_i(31,t==="[object Object]"?"object with keys {"+Object.keys(e).join(", ")+"}":t))}function JO(t){var e=t._init;return e(t._payload)}function NF(t){function e(de,K){if(t){var ge=de.deletions;ge===null?(de.deletions=[K],de.flags|=16):ge.push(K)}}function r(de,K){if(!t)return null;for(;K!==null;)e(de,K),K=K.sibling;return null}function c(de,K){for(de=new Map;K!==null;)K.key!==null?de.set(K.key,K):de.set(K.index,K),K=K.sibling;return de}function h(de,K){return de=hp(de,K),de.index=0,de.sibling=null,de}function x(de,K,ge){return de.index=ge,t?(ge=de.alternate,ge!==null?(ge=ge.index,ge<K?(de.flags|=2,K):ge):(de.flags|=2,K)):(de.flags|=1048576,K)}function w(de){return t&&de.alternate===null&&(de.flags|=2),de}function o(de,K,ge,Ae){return K===null||K.tag!==6?(K=xC(ge,de.mode,Ae),K.return=de,K):(K=h(K,ge),K.return=de,K)}function C(de,K,ge,Ae){var Te=ge.type;return Te===Qg?F(de,K,ge.props.children,Ae,ge.key):K!==null&&(K.elementType===Te||typeof Te=="object"&&Te!==null&&Te.$$typeof===Vh&&JO(Te)===K.type)?(Ae=h(K,ge.props),Ae.ref=m0(de,K,ge),Ae.return=de,Ae):(Ae=c2(ge.type,ge.key,ge.props,null,de.mode,Ae),Ae.ref=m0(de,K,ge),Ae.return=de,Ae)}function R(de,K,ge,Ae){return K===null||K.tag!==4||K.stateNode.containerInfo!==ge.containerInfo||K.stateNode.implementation!==ge.implementation?(K=_C(ge,de.mode,Ae),K.return=de,K):(K=h(K,ge.children||[]),K.return=de,K)}function F(de,K,ge,Ae,Te){return K===null||K.tag!==7?(K=Gm(ge,de.mode,Ae,Te),K.return=de,K):(K=h(K,ge),K.return=de,K)}function $(de,K,ge){if(typeof K=="string"&&K!==""||typeof K=="number")return K=xC(""+K,de.mode,ge),K.return=de,K;if(typeof K=="object"&&K!==null){switch(K.$$typeof){case vw:return ge=c2(K.type,K.key,K.props,null,de.mode,ge),ge.ref=m0(de,null,K),ge.return=de,ge;case Kg:return K=_C(K,de.mode,ge),K.return=de,K;case Vh:var Ae=K._init;return $(de,Ae(K._payload),ge)}if(N0(K)||c0(K))return K=Gm(K,de.mode,ge,null),K.return=de,K;jw(de,K)}return null}function Y(de,K,ge,Ae){var Te=K!==null?K.key:null;if(typeof ge=="string"&&ge!==""||typeof ge=="number")return Te!==null?null:o(de,K,""+ge,Ae);if(typeof ge=="object"&&ge!==null){switch(ge.$$typeof){case vw:return ge.key===Te?C(de,K,ge,Ae):null;case Kg:return ge.key===Te?R(de,K,ge,Ae):null;case Vh:return Te=ge._init,Y(de,K,Te(ge._payload),Ae)}if(N0(ge)||c0(ge))return Te!==null?null:F(de,K,ge,Ae,null);jw(de,ge)}return null}function H(de,K,ge,Ae,Te){if(typeof Ae=="string"&&Ae!==""||typeof Ae=="number")return de=de.get(ge)||null,o(K,de,""+Ae,Te);if(typeof Ae=="object"&&Ae!==null){switch(Ae.$$typeof){case vw:return de=de.get(Ae.key===null?ge:Ae.key)||null,C(K,de,Ae,Te);case Kg:return de=de.get(Ae.key===null?ge:Ae.key)||null,R(K,de,Ae,Te);case Vh:var Ce=Ae._init;return H(de,K,ge,Ce(Ae._payload),Te)}if(N0(Ae)||c0(Ae))return de=de.get(ge)||null,F(K,de,Ae,Te,null);jw(K,Ae)}return null}function X(de,K,ge,Ae){for(var Te=null,Ce=null,ne=K,ae=K=0,q=null;ne!==null&&ae<ge.length;ae++){ne.index>ae?(q=ne,ne=null):q=ne.sibling;var oe=Y(de,ne,ge[ae],Ae);if(oe===null){ne===null&&(ne=q);break}t&&ne&&oe.alternate===null&&e(de,ne),K=x(oe,K,ae),Ce===null?Te=oe:Ce.sibling=oe,Ce=oe,ne=q}if(ae===ge.length)return r(de,ne),ks&&Mm(de,ae),Te;if(ne===null){for(;ae<ge.length;ae++)ne=$(de,ge[ae],Ae),ne!==null&&(K=x(ne,K,ae),Ce===null?Te=ne:Ce.sibling=ne,Ce=ne);return ks&&Mm(de,ae),Te}for(ne=c(de,ne);ae<ge.length;ae++)q=H(ne,de,ae,ge[ae],Ae),q!==null&&(t&&q.alternate!==null&&ne.delete(q.key===null?ae:q.key),K=x(q,K,ae),Ce===null?Te=q:Ce.sibling=q,Ce=q);return t&&ne.forEach(function(ke){return e(de,ke)}),ks&&Mm(de,ae),Te}function he(de,K,ge,Ae){var Te=c0(ge);if(typeof Te!="function")throw Error(_i(150));if(ge=Te.call(ge),ge==null)throw Error(_i(151));for(var Ce=Te=null,ne=K,ae=K=0,q=null,oe=ge.next();ne!==null&&!oe.done;ae++,oe=ge.next()){ne.index>ae?(q=ne,ne=null):q=ne.sibling;var ke=Y(de,ne,oe.value,Ae);if(ke===null){ne===null&&(ne=q);break}t&&ne&&ke.alternate===null&&e(de,ne),K=x(ke,K,ae),Ce===null?Te=ke:Ce.sibling=ke,Ce=ke,ne=q}if(oe.done)return r(de,ne),ks&&Mm(de,ae),Te;if(ne===null){for(;!oe.done;ae++,oe=ge.next())oe=$(de,oe.value,Ae),oe!==null&&(K=x(oe,K,ae),Ce===null?Te=oe:Ce.sibling=oe,Ce=oe);return ks&&Mm(de,ae),Te}for(ne=c(de,ne);!oe.done;ae++,oe=ge.next())oe=H(ne,de,ae,oe.value,Ae),oe!==null&&(t&&oe.alternate!==null&&ne.delete(oe.key===null?ae:oe.key),K=x(oe,K,ae),Ce===null?Te=oe:Ce.sibling=oe,Ce=oe);return t&&ne.forEach(function(Ve){return e(de,Ve)}),ks&&Mm(de,ae),Te}function se(de,K,ge,Ae){if(typeof ge=="object"&&ge!==null&&ge.type===Qg&&ge.key===null&&(ge=ge.props.children),typeof ge=="object"&&ge!==null){switch(ge.$$typeof){case vw:e:{for(var Te=ge.key,Ce=K;Ce!==null;){if(Ce.key===Te){if(Te=ge.type,Te===Qg){if(Ce.tag===7){r(de,Ce.sibling),K=h(Ce,ge.props.children),K.return=de,de=K;break e}}else if(Ce.elementType===Te||typeof Te=="object"&&Te!==null&&Te.$$typeof===Vh&&JO(Te)===Ce.type){r(de,Ce.sibling),K=h(Ce,ge.props),K.ref=m0(de,Ce,ge),K.return=de,de=K;break e}r(de,Ce);break}else e(de,Ce);Ce=Ce.sibling}ge.type===Qg?(K=Gm(ge.props.children,de.mode,Ae,ge.key),K.return=de,de=K):(Ae=c2(ge.type,ge.key,ge.props,null,de.mode,Ae),Ae.ref=m0(de,K,ge),Ae.return=de,de=Ae)}return w(de);case Kg:e:{for(Ce=ge.key;K!==null;){if(K.key===Ce)if(K.tag===4&&K.stateNode.containerInfo===ge.containerInfo&&K.stateNode.implementation===ge.implementation){r(de,K.sibling),K=h(K,ge.children||[]),K.return=de,de=K;break e}else{r(de,K);break}else e(de,K);K=K.sibling}K=_C(ge,de.mode,Ae),K.return=de,de=K}return w(de);case Vh:return Ce=ge._init,se(de,K,Ce(ge._payload),Ae)}if(N0(ge))return X(de,K,ge,Ae);if(c0(ge))return he(de,K,ge,Ae);jw(de,ge)}return typeof ge=="string"&&ge!==""||typeof ge=="number"?(ge=""+ge,K!==null&&K.tag===6?(r(de,K.sibling),K=h(K,ge),K.return=de,de=K):(r(de,K),K=xC(ge,de.mode,Ae),K.return=de,de=K),w(de)):r(de,K)}return se}var Ny=NF(!0),AF=NF(!1),B2=Ip(null),V2=null,ay=null,KI=null;function QI(){KI=ay=V2=null}function JI(t){var e=B2.current;Ts(B2),t._currentValue=e}function yE(t,e,r){for(;t!==null;){var c=t.alternate;if((t.childLanes&e)!==e?(t.childLanes|=e,c!==null&&(c.childLanes|=e)):c!==null&&(c.childLanes&e)!==e&&(c.childLanes|=e),t===r)break;t=t.return}}function fy(t,e){V2=t,KI=ay=null,t=t.dependencies,t!==null&&t.firstContext!==null&&(t.lanes&e&&(yl=!0),t.firstContext=null)}function xc(t){var e=t._currentValue;if(KI!==t)if(t={context:t,memoizedValue:e,next:null},ay===null){if(V2===null)throw Error(_i(308));ay=t,V2.dependencies={lanes:0,firstContext:t}}else ay=ay.next=t;return e}var Bm=null;function eP(t){Bm===null?Bm=[t]:Bm.push(t)}function CF(t,e,r,c){var h=e.interleaved;return h===null?(r.next=r,eP(e)):(r.next=h.next,h.next=r),e.interleaved=r,Bd(t,c)}function Bd(t,e){t.lanes|=e;var r=t.alternate;for(r!==null&&(r.lanes|=e),r=t,t=t.return;t!==null;)t.childLanes|=e,r=t.alternate,r!==null&&(r.childLanes|=e),r=t,t=t.return;return r.tag===3?r.stateNode:null}var Uh=!1;function tP(t){t.updateQueue={baseState:t.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function EF(t,e){t=t.updateQueue,e.updateQueue===t&&(e.updateQueue={baseState:t.baseState,firstBaseUpdate:t.firstBaseUpdate,lastBaseUpdate:t.lastBaseUpdate,shared:t.shared,effects:t.effects})}function Md(t,e){return{eventTime:t,lane:e,tag:0,payload:null,callback:null,next:null}}function cp(t,e,r){var c=t.updateQueue;if(c===null)return null;if(c=c.shared,On&2){var h=c.pending;return h===null?e.next=e:(e.next=h.next,h.next=e),c.pending=e,Bd(t,r)}return h=c.interleaved,h===null?(e.next=e,eP(c)):(e.next=h.next,h.next=e),c.interleaved=e,Bd(t,r)}function r2(t,e,r){if(e=e.updateQueue,e!==null&&(e=e.shared,(r&4194240)!==0)){var c=e.lanes;c&=t.pendingLanes,r|=c,e.lanes=r,BI(t,r)}}function eL(t,e){var r=t.updateQueue,c=t.alternate;if(c!==null&&(c=c.updateQueue,r===c)){var h=null,x=null;if(r=r.firstBaseUpdate,r!==null){do{var w={eventTime:r.eventTime,lane:r.lane,tag:r.tag,payload:r.payload,callback:r.callback,next:null};x===null?h=x=w:x=x.next=w,r=r.next}while(r!==null);x===null?h=x=e:x=x.next=e}else h=x=e;r={baseState:c.baseState,firstBaseUpdate:h,lastBaseUpdate:x,shared:c.shared,effects:c.effects},t.updateQueue=r;return}t=r.lastBaseUpdate,t===null?r.firstBaseUpdate=e:t.next=e,r.lastBaseUpdate=e}function U2(t,e,r,c){var h=t.updateQueue;Uh=!1;var x=h.firstBaseUpdate,w=h.lastBaseUpdate,o=h.shared.pending;if(o!==null){h.shared.pending=null;var C=o,R=C.next;C.next=null,w===null?x=R:w.next=R,w=C;var F=t.alternate;F!==null&&(F=F.updateQueue,o=F.lastBaseUpdate,o!==w&&(o===null?F.firstBaseUpdate=R:o.next=R,F.lastBaseUpdate=C))}if(x!==null){var $=h.baseState;w=0,F=R=C=null,o=x;do{var Y=o.lane,H=o.eventTime;if((c&Y)===Y){F!==null&&(F=F.next={eventTime:H,lane:0,tag:o.tag,payload:o.payload,callback:o.callback,next:null});e:{var X=t,he=o;switch(Y=e,H=r,he.tag){case 1:if(X=he.payload,typeof X=="function"){$=X.call(H,$,Y);break e}$=X;break e;case 3:X.flags=X.flags&-65537|128;case 0:if(X=he.payload,Y=typeof X=="function"?X.call(H,$,Y):X,Y==null)break e;$=Hs({},$,Y);break e;case 2:Uh=!0}}o.callback!==null&&o.lane!==0&&(t.flags|=64,Y=h.effects,Y===null?h.effects=[o]:Y.push(o))}else H={eventTime:H,lane:Y,tag:o.tag,payload:o.payload,callback:o.callback,next:null},F===null?(R=F=H,C=$):F=F.next=H,w|=Y;if(o=o.next,o===null){if(o=h.shared.pending,o===null)break;Y=o,o=Y.next,Y.next=null,h.lastBaseUpdate=Y,h.shared.pending=null}}while(!0);if(F===null&&(C=$),h.baseState=C,h.firstBaseUpdate=R,h.lastBaseUpdate=F,e=h.shared.interleaved,e!==null){h=e;do w|=h.lane,h=h.next;while(h!==e)}else x===null&&(h.shared.lanes=0);Jm|=w,t.lanes=w,t.memoizedState=$}}function tL(t,e,r){if(t=e.effects,e.effects=null,t!==null)for(e=0;e<t.length;e++){var c=t[e],h=c.callback;if(h!==null){if(c.callback=null,c=r,typeof h!="function")throw Error(_i(191,h));h.call(c)}}}var Bv={},Bu=Ip(Bv),pv=Ip(Bv),mv=Ip(Bv);function Vm(t){if(t===Bv)throw Error(_i(174));return t}function iP(t,e){switch(us(mv,e),us(pv,t),us(Bu,Bv),t=e.nodeType,t){case 9:case 11:e=(e=e.documentElement)?e.namespaceURI:KC(null,"");break;default:t=t===8?e.parentNode:e,e=t.namespaceURI||null,t=t.tagName,e=KC(e,t)}Ts(Bu),us(Bu,e)}function Ay(){Ts(Bu),Ts(pv),Ts(mv)}function IF(t){Vm(mv.current);var e=Vm(Bu.current),r=KC(e,t.type);e!==r&&(us(pv,t),us(Bu,r))}function rP(t){pv.current===t&&(Ts(Bu),Ts(pv))}var qs=Ip(0);function q2(t){for(var e=t;e!==null;){if(e.tag===13){var r=e.memoizedState;if(r!==null&&(r=r.dehydrated,r===null||r.data==="$?"||r.data==="$!"))return e}else if(e.tag===19&&e.memoizedProps.revealOrder!==void 0){if(e.flags&128)return e}else if(e.child!==null){e.child.return=e,e=e.child;continue}if(e===t)break;for(;e.sibling===null;){if(e.return===null||e.return===t)return null;e=e.return}e.sibling.return=e.return,e=e.sibling}return null}var hC=[];function nP(){for(var t=0;t<hC.length;t++)hC[t]._workInProgressVersionPrimary=null;hC.length=0}var n2=Xd.ReactCurrentDispatcher,pC=Xd.ReactCurrentBatchConfig,Qm=0,$s=null,ja=null,Wa=null,$2=!1,U0=!1,fv=0,tH=0;function Ao(){throw Error(_i(321))}function sP(t,e){if(e===null)return!1;for(var r=0;r<e.length&&r<t.length;r++)if(!Zc(t[r],e[r]))return!1;return!0}function aP(t,e,r,c,h,x){if(Qm=x,$s=e,e.memoizedState=null,e.updateQueue=null,e.lanes=0,n2.current=t===null||t.memoizedState===null?sH:aH,t=r(c,h),U0){x=0;do{if(U0=!1,fv=0,25<=x)throw Error(_i(301));x+=1,Wa=ja=null,e.updateQueue=null,n2.current=oH,t=r(c,h)}while(U0)}if(n2.current=G2,e=ja!==null&&ja.next!==null,Qm=0,Wa=ja=$s=null,$2=!1,e)throw Error(_i(300));return t}function oP(){var t=fv!==0;return fv=0,t}function Du(){var t={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return Wa===null?$s.memoizedState=Wa=t:Wa=Wa.next=t,Wa}function _c(){if(ja===null){var t=$s.alternate;t=t!==null?t.memoizedState:null}else t=ja.next;var e=Wa===null?$s.memoizedState:Wa.next;if(e!==null)Wa=e,ja=t;else{if(t===null)throw Error(_i(310));ja=t,t={memoizedState:ja.memoizedState,baseState:ja.baseState,baseQueue:ja.baseQueue,queue:ja.queue,next:null},Wa===null?$s.memoizedState=Wa=t:Wa=Wa.next=t}return Wa}function gv(t,e){return typeof e=="function"?e(t):e}function mC(t){var e=_c(),r=e.queue;if(r===null)throw Error(_i(311));r.lastRenderedReducer=t;var c=ja,h=c.baseQueue,x=r.pending;if(x!==null){if(h!==null){var w=h.next;h.next=x.next,x.next=w}c.baseQueue=h=x,r.pending=null}if(h!==null){x=h.next,c=c.baseState;var o=w=null,C=null,R=x;do{var F=R.lane;if((Qm&F)===F)C!==null&&(C=C.next={lane:0,action:R.action,hasEagerState:R.hasEagerState,eagerState:R.eagerState,next:null}),c=R.hasEagerState?R.eagerState:t(c,R.action);else{var $={lane:F,action:R.action,hasEagerState:R.hasEagerState,eagerState:R.eagerState,next:null};C===null?(o=C=$,w=c):C=C.next=$,$s.lanes|=F,Jm|=F}R=R.next}while(R!==null&&R!==x);C===null?w=c:C.next=o,Zc(c,e.memoizedState)||(yl=!0),e.memoizedState=c,e.baseState=w,e.baseQueue=C,r.lastRenderedState=c}if(t=r.interleaved,t!==null){h=t;do x=h.lane,$s.lanes|=x,Jm|=x,h=h.next;while(h!==t)}else h===null&&(r.lanes=0);return[e.memoizedState,r.dispatch]}function fC(t){var e=_c(),r=e.queue;if(r===null)throw Error(_i(311));r.lastRenderedReducer=t;var c=r.dispatch,h=r.pending,x=e.memoizedState;if(h!==null){r.pending=null;var w=h=h.next;do x=t(x,w.action),w=w.next;while(w!==h);Zc(x,e.memoizedState)||(yl=!0),e.memoizedState=x,e.baseQueue===null&&(e.baseState=x),r.lastRenderedState=x}return[x,c]}function PF(){}function jF(t,e){var r=$s,c=_c(),h=e(),x=!Zc(c.memoizedState,h);if(x&&(c.memoizedState=h,yl=!0),c=c.queue,lP(DF.bind(null,r,c,t),[t]),c.getSnapshot!==e||x||Wa!==null&&Wa.memoizedState.tag&1){if(r.flags|=2048,yv(9,kF.bind(null,r,c,h,e),void 0,null),Za===null)throw Error(_i(349));Qm&30||RF(r,e,h)}return h}function RF(t,e,r){t.flags|=16384,t={getSnapshot:e,value:r},e=$s.updateQueue,e===null?(e={lastEffect:null,stores:null},$s.updateQueue=e,e.stores=[t]):(r=e.stores,r===null?e.stores=[t]:r.push(t))}function kF(t,e,r,c){e.value=r,e.getSnapshot=c,MF(e)&&OF(t)}function DF(t,e,r){return r(function(){MF(e)&&OF(t)})}function MF(t){var e=t.getSnapshot;t=t.value;try{var r=e();return!Zc(t,r)}catch{return!0}}function OF(t){var e=Bd(t,1);e!==null&&Hc(e,t,1,-1)}function iL(t){var e=Du();return typeof t=="function"&&(t=t()),e.memoizedState=e.baseState=t,t={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:gv,lastRenderedState:t},e.queue=t,t=t.dispatch=nH.bind(null,$s,t),[e.memoizedState,t]}function yv(t,e,r,c){return t={tag:t,create:e,destroy:r,deps:c,next:null},e=$s.updateQueue,e===null?(e={lastEffect:null,stores:null},$s.updateQueue=e,e.lastEffect=t.next=t):(r=e.lastEffect,r===null?e.lastEffect=t.next=t:(c=r.next,r.next=t,t.next=c,e.lastEffect=t)),t}function LF(){return _c().memoizedState}function s2(t,e,r,c){var h=Du();$s.flags|=t,h.memoizedState=yv(1|e,r,void 0,c===void 0?null:c)}function LS(t,e,r,c){var h=_c();c=c===void 0?null:c;var x=void 0;if(ja!==null){var w=ja.memoizedState;if(x=w.destroy,c!==null&&sP(c,w.deps)){h.memoizedState=yv(e,r,x,c);return}}$s.flags|=t,h.memoizedState=yv(1|e,r,x,c)}function rL(t,e){return s2(8390656,8,t,e)}function lP(t,e){return LS(2048,8,t,e)}function FF(t,e){return LS(4,2,t,e)}function zF(t,e){return LS(4,4,t,e)}function BF(t,e){if(typeof e=="function")return t=t(),e(t),function(){e(null)};if(e!=null)return t=t(),e.current=t,function(){e.current=null}}function VF(t,e,r){return r=r!=null?r.concat([t]):null,LS(4,4,BF.bind(null,e,t),r)}function cP(){}function UF(t,e){var r=_c();e=e===void 0?null:e;var c=r.memoizedState;return c!==null&&e!==null&&sP(e,c[1])?c[0]:(r.memoizedState=[t,e],t)}function qF(t,e){var r=_c();e=e===void 0?null:e;var c=r.memoizedState;return c!==null&&e!==null&&sP(e,c[1])?c[0]:(t=t(),r.memoizedState=[t,e],t)}function $F(t,e,r){return Qm&21?(Zc(r,e)||(r=X5(),$s.lanes|=r,Jm|=r,t.baseState=!0),e):(t.baseState&&(t.baseState=!1,yl=!0),t.memoizedState=r)}function iH(t,e){var r=Qn;Qn=r!==0&&4>r?r:4,t(!0);var c=pC.transition;pC.transition={};try{t(!1),e()}finally{Qn=r,pC.transition=c}}function GF(){return _c().memoizedState}function rH(t,e,r){var c=dp(t);if(r={lane:c,action:r,hasEagerState:!1,eagerState:null,next:null},HF(t))WF(e,r);else if(r=CF(t,e,r,c),r!==null){var h=el();Hc(r,t,c,h),ZF(r,e,c)}}function nH(t,e,r){var c=dp(t),h={lane:c,action:r,hasEagerState:!1,eagerState:null,next:null};if(HF(t))WF(e,h);else{var x=t.alternate;if(t.lanes===0&&(x===null||x.lanes===0)&&(x=e.lastRenderedReducer,x!==null))try{var w=e.lastRenderedState,o=x(w,r);if(h.hasEagerState=!0,h.eagerState=o,Zc(o,w)){var C=e.interleaved;C===null?(h.next=h,eP(e)):(h.next=C.next,C.next=h),e.interleaved=h;return}}catch{}finally{}r=CF(t,e,h,c),r!==null&&(h=el(),Hc(r,t,c,h),ZF(r,e,c))}}function HF(t){var e=t.alternate;return t===$s||e!==null&&e===$s}function WF(t,e){U0=$2=!0;var r=t.pending;r===null?e.next=e:(e.next=r.next,r.next=e),t.pending=e}function ZF(t,e,r){if(r&4194240){var c=e.lanes;c&=t.pendingLanes,r|=c,e.lanes=r,BI(t,r)}}var G2={readContext:xc,useCallback:Ao,useContext:Ao,useEffect:Ao,useImperativeHandle:Ao,useInsertionEffect:Ao,useLayoutEffect:Ao,useMemo:Ao,useReducer:Ao,useRef:Ao,useState:Ao,useDebugValue:Ao,useDeferredValue:Ao,useTransition:Ao,useMutableSource:Ao,useSyncExternalStore:Ao,useId:Ao,unstable_isNewReconciler:!1},sH={readContext:xc,useCallback:function(t,e){return Du().memoizedState=[t,e===void 0?null:e],t},useContext:xc,useEffect:rL,useImperativeHandle:function(t,e,r){return r=r!=null?r.concat([t]):null,s2(4194308,4,BF.bind(null,e,t),r)},useLayoutEffect:function(t,e){return s2(4194308,4,t,e)},useInsertionEffect:function(t,e){return s2(4,2,t,e)},useMemo:function(t,e){var r=Du();return e=e===void 0?null:e,t=t(),r.memoizedState=[t,e],t},useReducer:function(t,e,r){var c=Du();return e=r!==void 0?r(e):e,c.memoizedState=c.baseState=e,t={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:t,lastRenderedState:e},c.queue=t,t=t.dispatch=rH.bind(null,$s,t),[c.memoizedState,t]},useRef:function(t){var e=Du();return t={current:t},e.memoizedState=t},useState:iL,useDebugValue:cP,useDeferredValue:function(t){return Du().memoizedState=t},useTransition:function(){var t=iL(!1),e=t[0];return t=iH.bind(null,t[1]),Du().memoizedState=t,[e,t]},useMutableSource:function(){},useSyncExternalStore:function(t,e,r){var c=$s,h=Du();if(ks){if(r===void 0)throw Error(_i(407));r=r()}else{if(r=e(),Za===null)throw Error(_i(349));Qm&30||RF(c,e,r)}h.memoizedState=r;var x={value:r,getSnapshot:e};return h.queue=x,rL(DF.bind(null,c,x,t),[t]),c.flags|=2048,yv(9,kF.bind(null,c,x,r,e),void 0,null),r},useId:function(){var t=Du(),e=Za.identifierPrefix;if(ks){var r=Id,c=Ed;r=(c&~(1<<32-Gc(c)-1)).toString(32)+r,e=":"+e+"R"+r,r=fv++,0<r&&(e+="H"+r.toString(32)),e+=":"}else r=tH++,e=":"+e+"r"+r.toString(32)+":";return t.memoizedState=e},unstable_isNewReconciler:!1},aH={readContext:xc,useCallback:UF,useContext:xc,useEffect:lP,useImperativeHandle:VF,useInsertionEffect:FF,useLayoutEffect:zF,useMemo:qF,useReducer:mC,useRef:LF,useState:function(){return mC(gv)},useDebugValue:cP,useDeferredValue:function(t){var e=_c();return $F(e,ja.memoizedState,t)},useTransition:function(){var t=mC(gv)[0],e=_c().memoizedState;return[t,e]},useMutableSource:PF,useSyncExternalStore:jF,useId:GF,unstable_isNewReconciler:!1},oH={readContext:xc,useCallback:UF,useContext:xc,useEffect:lP,useImperativeHandle:VF,useInsertionEffect:FF,useLayoutEffect:zF,useMemo:qF,useReducer:fC,useRef:LF,useState:function(){return fC(gv)},useDebugValue:cP,useDeferredValue:function(t){var e=_c();return ja===null?e.memoizedState=t:$F(e,ja.memoizedState,t)},useTransition:function(){var t=fC(gv)[0],e=_c().memoizedState;return[t,e]},useMutableSource:PF,useSyncExternalStore:jF,useId:GF,unstable_isNewReconciler:!1};function Uc(t,e){if(t&&t.defaultProps){e=Hs({},e),t=t.defaultProps;for(var r in t)e[r]===void 0&&(e[r]=t[r]);return e}return e}function xE(t,e,r,c){e=t.memoizedState,r=r(c,e),r=r==null?e:Hs({},e,r),t.memoizedState=r,t.lanes===0&&(t.updateQueue.baseState=r)}var FS={isMounted:function(t){return(t=t._reactInternals)?mf(t)===t:!1},enqueueSetState:function(t,e,r){t=t._reactInternals;var c=el(),h=dp(t),x=Md(c,h);x.payload=e,r!=null&&(x.callback=r),e=cp(t,x,h),e!==null&&(Hc(e,t,h,c),r2(e,t,h))},enqueueReplaceState:function(t,e,r){t=t._reactInternals;var c=el(),h=dp(t),x=Md(c,h);x.tag=1,x.payload=e,r!=null&&(x.callback=r),e=cp(t,x,h),e!==null&&(Hc(e,t,h,c),r2(e,t,h))},enqueueForceUpdate:function(t,e){t=t._reactInternals;var r=el(),c=dp(t),h=Md(r,c);h.tag=2,e!=null&&(h.callback=e),e=cp(t,h,c),e!==null&&(Hc(e,t,c,r),r2(e,t,c))}};function nL(t,e,r,c,h,x,w){return t=t.stateNode,typeof t.shouldComponentUpdate=="function"?t.shouldComponentUpdate(c,x,w):e.prototype&&e.prototype.isPureReactComponent?!cv(r,c)||!cv(h,x):!0}function XF(t,e,r){var c=!1,h=bp,x=e.contextType;return typeof x=="object"&&x!==null?x=xc(x):(h=_l(e)?Ym:Mo.current,c=e.contextTypes,x=(c=c!=null)?Sy(t,h):bp),e=new e(r,x),t.memoizedState=e.state!==null&&e.state!==void 0?e.state:null,e.updater=FS,t.stateNode=e,e._reactInternals=t,c&&(t=t.stateNode,t.__reactInternalMemoizedUnmaskedChildContext=h,t.__reactInternalMemoizedMaskedChildContext=x),e}function sL(t,e,r,c){t=e.state,typeof e.componentWillReceiveProps=="function"&&e.componentWillReceiveProps(r,c),typeof e.UNSAFE_componentWillReceiveProps=="function"&&e.UNSAFE_componentWillReceiveProps(r,c),e.state!==t&&FS.enqueueReplaceState(e,e.state,null)}function _E(t,e,r,c){var h=t.stateNode;h.props=r,h.state=t.memoizedState,h.refs={},tP(t);var x=e.contextType;typeof x=="object"&&x!==null?h.context=xc(x):(x=_l(e)?Ym:Mo.current,h.context=Sy(t,x)),h.state=t.memoizedState,x=e.getDerivedStateFromProps,typeof x=="function"&&(xE(t,e,x,r),h.state=t.memoizedState),typeof e.getDerivedStateFromProps=="function"||typeof h.getSnapshotBeforeUpdate=="function"||typeof h.UNSAFE_componentWillMount!="function"&&typeof h.componentWillMount!="function"||(e=h.state,typeof h.componentWillMount=="function"&&h.componentWillMount(),typeof h.UNSAFE_componentWillMount=="function"&&h.UNSAFE_componentWillMount(),e!==h.state&&FS.enqueueReplaceState(h,h.state,null),U2(t,r,h,c),h.state=t.memoizedState),typeof h.componentDidMount=="function"&&(t.flags|=4194308)}function Cy(t,e){try{var r="",c=e;do r+=M7(c),c=c.return;while(c);var h=r}catch(x){h=`
Error generating stack: `+x.message+`
`+x.stack}return{value:t,source:e,stack:h,digest:null}}function gC(t,e,r){return{value:t,source:null,stack:r??null,digest:e??null}}function vE(t,e){try{console.error(e.value)}catch(r){setTimeout(function(){throw r})}}var lH=typeof WeakMap=="function"?WeakMap:Map;function YF(t,e,r){r=Md(-1,r),r.tag=3,r.payload={element:null};var c=e.value;return r.callback=function(){W2||(W2=!0,PE=c),vE(t,e)},r}function KF(t,e,r){r=Md(-1,r),r.tag=3;var c=t.type.getDerivedStateFromError;if(typeof c=="function"){var h=e.value;r.payload=function(){return c(h)},r.callback=function(){vE(t,e)}}var x=t.stateNode;return x!==null&&typeof x.componentDidCatch=="function"&&(r.callback=function(){vE(t,e),typeof c!="function"&&(up===null?up=new Set([this]):up.add(this));var w=e.stack;this.componentDidCatch(e.value,{componentStack:w!==null?w:""})}),r}function aL(t,e,r){var c=t.pingCache;if(c===null){c=t.pingCache=new lH;var h=new Set;c.set(e,h)}else h=c.get(e),h===void 0&&(h=new Set,c.set(e,h));h.has(r)||(h.add(r),t=wH.bind(null,t,e,r),e.then(t,t))}function oL(t){do{var e;if((e=t.tag===13)&&(e=t.memoizedState,e=e!==null?e.dehydrated!==null:!0),e)return t;t=t.return}while(t!==null);return null}function lL(t,e,r,c,h){return t.mode&1?(t.flags|=65536,t.lanes=h,t):(t===e?t.flags|=65536:(t.flags|=128,r.flags|=131072,r.flags&=-52805,r.tag===1&&(r.alternate===null?r.tag=17:(e=Md(-1,1),e.tag=2,cp(r,e,1))),r.lanes|=1),t)}var cH=Xd.ReactCurrentOwner,yl=!1;function Jo(t,e,r,c){e.child=t===null?AF(e,null,r,c):Ny(e,t.child,r,c)}function cL(t,e,r,c,h){r=r.render;var x=e.ref;return fy(e,h),c=aP(t,e,r,c,x,h),r=oP(),t!==null&&!yl?(e.updateQueue=t.updateQueue,e.flags&=-2053,t.lanes&=~h,Vd(t,e,h)):(ks&&r&&ZI(e),e.flags|=1,Jo(t,e,c,h),e.child)}function uL(t,e,r,c,h){if(t===null){var x=r.type;return typeof x=="function"&&!yP(x)&&x.defaultProps===void 0&&r.compare===null&&r.defaultProps===void 0?(e.tag=15,e.type=x,QF(t,e,x,c,h)):(t=c2(r.type,null,c,e,e.mode,h),t.ref=e.ref,t.return=e,e.child=t)}if(x=t.child,!(t.lanes&h)){var w=x.memoizedProps;if(r=r.compare,r=r!==null?r:cv,r(w,c)&&t.ref===e.ref)return Vd(t,e,h)}return e.flags|=1,t=hp(x,c),t.ref=e.ref,t.return=e,e.child=t}function QF(t,e,r,c,h){if(t!==null){var x=t.memoizedProps;if(cv(x,c)&&t.ref===e.ref)if(yl=!1,e.pendingProps=c=x,(t.lanes&h)!==0)t.flags&131072&&(yl=!0);else return e.lanes=t.lanes,Vd(t,e,h)}return bE(t,e,r,c,h)}function JF(t,e,r){var c=e.pendingProps,h=c.children,x=t!==null?t.memoizedState:null;if(c.mode==="hidden")if(!(e.mode&1))e.memoizedState={baseLanes:0,cachePool:null,transitions:null},us(ly,kl),kl|=r;else{if(!(r&1073741824))return t=x!==null?x.baseLanes|r:r,e.lanes=e.childLanes=1073741824,e.memoizedState={baseLanes:t,cachePool:null,transitions:null},e.updateQueue=null,us(ly,kl),kl|=t,null;e.memoizedState={baseLanes:0,cachePool:null,transitions:null},c=x!==null?x.baseLanes:r,us(ly,kl),kl|=c}else x!==null?(c=x.baseLanes|r,e.memoizedState=null):c=r,us(ly,kl),kl|=c;return Jo(t,e,h,r),e.child}function ez(t,e){var r=e.ref;(t===null&&r!==null||t!==null&&t.ref!==r)&&(e.flags|=512,e.flags|=2097152)}function bE(t,e,r,c,h){var x=_l(r)?Ym:Mo.current;return x=Sy(e,x),fy(e,h),r=aP(t,e,r,c,x,h),c=oP(),t!==null&&!yl?(e.updateQueue=t.updateQueue,e.flags&=-2053,t.lanes&=~h,Vd(t,e,h)):(ks&&c&&ZI(e),e.flags|=1,Jo(t,e,r,h),e.child)}function dL(t,e,r,c,h){if(_l(r)){var x=!0;L2(e)}else x=!1;if(fy(e,h),e.stateNode===null)a2(t,e),XF(e,r,c),_E(e,r,c,h),c=!0;else if(t===null){var w=e.stateNode,o=e.memoizedProps;w.props=o;var C=w.context,R=r.contextType;typeof R=="object"&&R!==null?R=xc(R):(R=_l(r)?Ym:Mo.current,R=Sy(e,R));var F=r.getDerivedStateFromProps,$=typeof F=="function"||typeof w.getSnapshotBeforeUpdate=="function";$||typeof w.UNSAFE_componentWillReceiveProps!="function"&&typeof w.componentWillReceiveProps!="function"||(o!==c||C!==R)&&sL(e,w,c,R),Uh=!1;var Y=e.memoizedState;w.state=Y,U2(e,c,w,h),C=e.memoizedState,o!==c||Y!==C||xl.current||Uh?(typeof F=="function"&&(xE(e,r,F,c),C=e.memoizedState),(o=Uh||nL(e,r,o,c,Y,C,R))?($||typeof w.UNSAFE_componentWillMount!="function"&&typeof w.componentWillMount!="function"||(typeof w.componentWillMount=="function"&&w.componentWillMount(),typeof w.UNSAFE_componentWillMount=="function"&&w.UNSAFE_componentWillMount()),typeof w.componentDidMount=="function"&&(e.flags|=4194308)):(typeof w.componentDidMount=="function"&&(e.flags|=4194308),e.memoizedProps=c,e.memoizedState=C),w.props=c,w.state=C,w.context=R,c=o):(typeof w.componentDidMount=="function"&&(e.flags|=4194308),c=!1)}else{w=e.stateNode,EF(t,e),o=e.memoizedProps,R=e.type===e.elementType?o:Uc(e.type,o),w.props=R,$=e.pendingProps,Y=w.context,C=r.contextType,typeof C=="object"&&C!==null?C=xc(C):(C=_l(r)?Ym:Mo.current,C=Sy(e,C));var H=r.getDerivedStateFromProps;(F=typeof H=="function"||typeof w.getSnapshotBeforeUpdate=="function")||typeof w.UNSAFE_componentWillReceiveProps!="function"&&typeof w.componentWillReceiveProps!="function"||(o!==$||Y!==C)&&sL(e,w,c,C),Uh=!1,Y=e.memoizedState,w.state=Y,U2(e,c,w,h);var X=e.memoizedState;o!==$||Y!==X||xl.current||Uh?(typeof H=="function"&&(xE(e,r,H,c),X=e.memoizedState),(R=Uh||nL(e,r,R,c,Y,X,C)||!1)?(F||typeof w.UNSAFE_componentWillUpdate!="function"&&typeof w.componentWillUpdate!="function"||(typeof w.componentWillUpdate=="function"&&w.componentWillUpdate(c,X,C),typeof w.UNSAFE_componentWillUpdate=="function"&&w.UNSAFE_componentWillUpdate(c,X,C)),typeof w.componentDidUpdate=="function"&&(e.flags|=4),typeof w.getSnapshotBeforeUpdate=="function"&&(e.flags|=1024)):(typeof w.componentDidUpdate!="function"||o===t.memoizedProps&&Y===t.memoizedState||(e.flags|=4),typeof w.getSnapshotBeforeUpdate!="function"||o===t.memoizedProps&&Y===t.memoizedState||(e.flags|=1024),e.memoizedProps=c,e.memoizedState=X),w.props=c,w.state=X,w.context=C,c=R):(typeof w.componentDidUpdate!="function"||o===t.memoizedProps&&Y===t.memoizedState||(e.flags|=4),typeof w.getSnapshotBeforeUpdate!="function"||o===t.memoizedProps&&Y===t.memoizedState||(e.flags|=1024),c=!1)}return wE(t,e,r,c,x,h)}function wE(t,e,r,c,h,x){ez(t,e);var w=(e.flags&128)!==0;if(!c&&!w)return h&&YO(e,r,!1),Vd(t,e,x);c=e.stateNode,cH.current=e;var o=w&&typeof r.getDerivedStateFromError!="function"?null:c.render();return e.flags|=1,t!==null&&w?(e.child=Ny(e,t.child,null,x),e.child=Ny(e,null,o,x)):Jo(t,e,o,x),e.memoizedState=c.state,h&&YO(e,r,!0),e.child}function tz(t){var e=t.stateNode;e.pendingContext?XO(t,e.pendingContext,e.pendingContext!==e.context):e.context&&XO(t,e.context,!1),iP(t,e.containerInfo)}function hL(t,e,r,c,h){return Ty(),YI(h),e.flags|=256,Jo(t,e,r,c),e.child}var SE={dehydrated:null,treeContext:null,retryLane:0};function TE(t){return{baseLanes:t,cachePool:null,transitions:null}}function iz(t,e,r){var c=e.pendingProps,h=qs.current,x=!1,w=(e.flags&128)!==0,o;if((o=w)||(o=t!==null&&t.memoizedState===null?!1:(h&2)!==0),o?(x=!0,e.flags&=-129):(t===null||t.memoizedState!==null)&&(h|=1),us(qs,h&1),t===null)return gE(e),t=e.memoizedState,t!==null&&(t=t.dehydrated,t!==null)?(e.mode&1?t.data==="$!"?e.lanes=8:e.lanes=1073741824:e.lanes=1,null):(w=c.children,t=c.fallback,x?(c=e.mode,x=e.child,w={mode:"hidden",children:w},!(c&1)&&x!==null?(x.childLanes=0,x.pendingProps=w):x=VS(w,c,0,null),t=Gm(t,c,r,null),x.return=e,t.return=e,x.sibling=t,e.child=x,e.child.memoizedState=TE(r),e.memoizedState=SE,t):uP(e,w));if(h=t.memoizedState,h!==null&&(o=h.dehydrated,o!==null))return uH(t,e,w,c,o,h,r);if(x){x=c.fallback,w=e.mode,h=t.child,o=h.sibling;var C={mode:"hidden",children:c.children};return!(w&1)&&e.child!==h?(c=e.child,c.childLanes=0,c.pendingProps=C,e.deletions=null):(c=hp(h,C),c.subtreeFlags=h.subtreeFlags&14680064),o!==null?x=hp(o,x):(x=Gm(x,w,r,null),x.flags|=2),x.return=e,c.return=e,c.sibling=x,e.child=c,c=x,x=e.child,w=t.child.memoizedState,w=w===null?TE(r):{baseLanes:w.baseLanes|r,cachePool:null,transitions:w.transitions},x.memoizedState=w,x.childLanes=t.childLanes&~r,e.memoizedState=SE,c}return x=t.child,t=x.sibling,c=hp(x,{mode:"visible",children:c.children}),!(e.mode&1)&&(c.lanes=r),c.return=e,c.sibling=null,t!==null&&(r=e.deletions,r===null?(e.deletions=[t],e.flags|=16):r.push(t)),e.child=c,e.memoizedState=null,c}function uP(t,e){return e=VS({mode:"visible",children:e},t.mode,0,null),e.return=t,t.child=e}function Rw(t,e,r,c){return c!==null&&YI(c),Ny(e,t.child,null,r),t=uP(e,e.pendingProps.children),t.flags|=2,e.memoizedState=null,t}function uH(t,e,r,c,h,x,w){if(r)return e.flags&256?(e.flags&=-257,c=gC(Error(_i(422))),Rw(t,e,w,c)):e.memoizedState!==null?(e.child=t.child,e.flags|=128,null):(x=c.fallback,h=e.mode,c=VS({mode:"visible",children:c.children},h,0,null),x=Gm(x,h,w,null),x.flags|=2,c.return=e,x.return=e,c.sibling=x,e.child=c,e.mode&1&&Ny(e,t.child,null,w),e.child.memoizedState=TE(w),e.memoizedState=SE,x);if(!(e.mode&1))return Rw(t,e,w,null);if(h.data==="$!"){if(c=h.nextSibling&&h.nextSibling.dataset,c)var o=c.dgst;return c=o,x=Error(_i(419)),c=gC(x,c,void 0),Rw(t,e,w,c)}if(o=(w&t.childLanes)!==0,yl||o){if(c=Za,c!==null){switch(w&-w){case 4:h=2;break;case 16:h=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:h=32;break;case 536870912:h=268435456;break;default:h=0}h=h&(c.suspendedLanes|w)?0:h,h!==0&&h!==x.retryLane&&(x.retryLane=h,Bd(t,h),Hc(c,t,h,-1))}return gP(),c=gC(Error(_i(421))),Rw(t,e,w,c)}return h.data==="$?"?(e.flags|=128,e.child=t.child,e=SH.bind(null,t),h._reactRetry=e,null):(t=x.treeContext,Dl=lp(h.nextSibling),Fl=e,ks=!0,$c=null,t!==null&&(dc[hc++]=Ed,dc[hc++]=Id,dc[hc++]=Km,Ed=t.id,Id=t.overflow,Km=e),e=uP(e,c.children),e.flags|=4096,e)}function pL(t,e,r){t.lanes|=e;var c=t.alternate;c!==null&&(c.lanes|=e),yE(t.return,e,r)}function yC(t,e,r,c,h){var x=t.memoizedState;x===null?t.memoizedState={isBackwards:e,rendering:null,renderingStartTime:0,last:c,tail:r,tailMode:h}:(x.isBackwards=e,x.rendering=null,x.renderingStartTime=0,x.last=c,x.tail=r,x.tailMode=h)}function rz(t,e,r){var c=e.pendingProps,h=c.revealOrder,x=c.tail;if(Jo(t,e,c.children,r),c=qs.current,c&2)c=c&1|2,e.flags|=128;else{if(t!==null&&t.flags&128)e:for(t=e.child;t!==null;){if(t.tag===13)t.memoizedState!==null&&pL(t,r,e);else if(t.tag===19)pL(t,r,e);else if(t.child!==null){t.child.return=t,t=t.child;continue}if(t===e)break e;for(;t.sibling===null;){if(t.return===null||t.return===e)break e;t=t.return}t.sibling.return=t.return,t=t.sibling}c&=1}if(us(qs,c),!(e.mode&1))e.memoizedState=null;else switch(h){case"forwards":for(r=e.child,h=null;r!==null;)t=r.alternate,t!==null&&q2(t)===null&&(h=r),r=r.sibling;r=h,r===null?(h=e.child,e.child=null):(h=r.sibling,r.sibling=null),yC(e,!1,h,r,x);break;case"backwards":for(r=null,h=e.child,e.child=null;h!==null;){if(t=h.alternate,t!==null&&q2(t)===null){e.child=h;break}t=h.sibling,h.sibling=r,r=h,h=t}yC(e,!0,r,null,x);break;case"together":yC(e,!1,null,null,void 0);break;default:e.memoizedState=null}return e.child}function a2(t,e){!(e.mode&1)&&t!==null&&(t.alternate=null,e.alternate=null,e.flags|=2)}function Vd(t,e,r){if(t!==null&&(e.dependencies=t.dependencies),Jm|=e.lanes,!(r&e.childLanes))return null;if(t!==null&&e.child!==t.child)throw Error(_i(153));if(e.child!==null){for(t=e.child,r=hp(t,t.pendingProps),e.child=r,r.return=e;t.sibling!==null;)t=t.sibling,r=r.sibling=hp(t,t.pendingProps),r.return=e;r.sibling=null}return e.child}function dH(t,e,r){switch(e.tag){case 3:tz(e),Ty();break;case 5:IF(e);break;case 1:_l(e.type)&&L2(e);break;case 4:iP(e,e.stateNode.containerInfo);break;case 10:var c=e.type._context,h=e.memoizedProps.value;us(B2,c._currentValue),c._currentValue=h;break;case 13:if(c=e.memoizedState,c!==null)return c.dehydrated!==null?(us(qs,qs.current&1),e.flags|=128,null):r&e.child.childLanes?iz(t,e,r):(us(qs,qs.current&1),t=Vd(t,e,r),t!==null?t.sibling:null);us(qs,qs.current&1);break;case 19:if(c=(r&e.childLanes)!==0,t.flags&128){if(c)return rz(t,e,r);e.flags|=128}if(h=e.memoizedState,h!==null&&(h.rendering=null,h.tail=null,h.lastEffect=null),us(qs,qs.current),c)break;return null;case 22:case 23:return e.lanes=0,JF(t,e,r)}return Vd(t,e,r)}var nz,NE,sz,az;nz=function(t,e){for(var r=e.child;r!==null;){if(r.tag===5||r.tag===6)t.appendChild(r.stateNode);else if(r.tag!==4&&r.child!==null){r.child.return=r,r=r.child;continue}if(r===e)break;for(;r.sibling===null;){if(r.return===null||r.return===e)return;r=r.return}r.sibling.return=r.return,r=r.sibling}};NE=function(){};sz=function(t,e,r,c){var h=t.memoizedProps;if(h!==c){t=e.stateNode,Vm(Bu.current);var x=null;switch(r){case"input":h=WC(t,h),c=WC(t,c),x=[];break;case"select":h=Hs({},h,{value:void 0}),c=Hs({},c,{value:void 0}),x=[];break;case"textarea":h=YC(t,h),c=YC(t,c),x=[];break;default:typeof h.onClick!="function"&&typeof c.onClick=="function"&&(t.onclick=M2)}QC(r,c);var w;r=null;for(R in h)if(!c.hasOwnProperty(R)&&h.hasOwnProperty(R)&&h[R]!=null)if(R==="style"){var o=h[R];for(w in o)o.hasOwnProperty(w)&&(r||(r={}),r[w]="")}else R!=="dangerouslySetInnerHTML"&&R!=="children"&&R!=="suppressContentEditableWarning"&&R!=="suppressHydrationWarning"&&R!=="autoFocus"&&(iv.hasOwnProperty(R)?x||(x=[]):(x=x||[]).push(R,null));for(R in c){var C=c[R];if(o=h!=null?h[R]:void 0,c.hasOwnProperty(R)&&C!==o&&(C!=null||o!=null))if(R==="style")if(o){for(w in o)!o.hasOwnProperty(w)||C&&C.hasOwnProperty(w)||(r||(r={}),r[w]="");for(w in C)C.hasOwnProperty(w)&&o[w]!==C[w]&&(r||(r={}),r[w]=C[w])}else r||(x||(x=[]),x.push(R,r)),r=C;else R==="dangerouslySetInnerHTML"?(C=C?C.__html:void 0,o=o?o.__html:void 0,C!=null&&o!==C&&(x=x||[]).push(R,C)):R==="children"?typeof C!="string"&&typeof C!="number"||(x=x||[]).push(R,""+C):R!=="suppressContentEditableWarning"&&R!=="suppressHydrationWarning"&&(iv.hasOwnProperty(R)?(C!=null&&R==="onScroll"&&ws("scroll",t),x||o===C||(x=[])):(x=x||[]).push(R,C))}r&&(x=x||[]).push("style",r);var R=x;(e.updateQueue=R)&&(e.flags|=4)}};az=function(t,e,r,c){r!==c&&(e.flags|=4)};function f0(t,e){if(!ks)switch(t.tailMode){case"hidden":e=t.tail;for(var r=null;e!==null;)e.alternate!==null&&(r=e),e=e.sibling;r===null?t.tail=null:r.sibling=null;break;case"collapsed":r=t.tail;for(var c=null;r!==null;)r.alternate!==null&&(c=r),r=r.sibling;c===null?e||t.tail===null?t.tail=null:t.tail.sibling=null:c.sibling=null}}function Co(t){var e=t.alternate!==null&&t.alternate.child===t.child,r=0,c=0;if(e)for(var h=t.child;h!==null;)r|=h.lanes|h.childLanes,c|=h.subtreeFlags&14680064,c|=h.flags&14680064,h.return=t,h=h.sibling;else for(h=t.child;h!==null;)r|=h.lanes|h.childLanes,c|=h.subtreeFlags,c|=h.flags,h.return=t,h=h.sibling;return t.subtreeFlags|=c,t.childLanes=r,e}function hH(t,e,r){var c=e.pendingProps;switch(XI(e),e.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return Co(e),null;case 1:return _l(e.type)&&O2(),Co(e),null;case 3:return c=e.stateNode,Ay(),Ts(xl),Ts(Mo),nP(),c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),(t===null||t.child===null)&&(Pw(e)?e.flags|=4:t===null||t.memoizedState.isDehydrated&&!(e.flags&256)||(e.flags|=1024,$c!==null&&(kE($c),$c=null))),NE(t,e),Co(e),null;case 5:rP(e);var h=Vm(mv.current);if(r=e.type,t!==null&&e.stateNode!=null)sz(t,e,r,c,h),t.ref!==e.ref&&(e.flags|=512,e.flags|=2097152);else{if(!c){if(e.stateNode===null)throw Error(_i(166));return Co(e),null}if(t=Vm(Bu.current),Pw(e)){c=e.stateNode,r=e.type;var x=e.memoizedProps;switch(c[Lu]=e,c[hv]=x,t=(e.mode&1)!==0,r){case"dialog":ws("cancel",c),ws("close",c);break;case"iframe":case"object":case"embed":ws("load",c);break;case"video":case"audio":for(h=0;h<C0.length;h++)ws(C0[h],c);break;case"source":ws("error",c);break;case"img":case"image":case"link":ws("error",c),ws("load",c);break;case"details":ws("toggle",c);break;case"input":wO(c,x),ws("invalid",c);break;case"select":c._wrapperState={wasMultiple:!!x.multiple},ws("invalid",c);break;case"textarea":TO(c,x),ws("invalid",c)}QC(r,x),h=null;for(var w in x)if(x.hasOwnProperty(w)){var o=x[w];w==="children"?typeof o=="string"?c.textContent!==o&&(x.suppressHydrationWarning!==!0&&Iw(c.textContent,o,t),h=["children",o]):typeof o=="number"&&c.textContent!==""+o&&(x.suppressHydrationWarning!==!0&&Iw(c.textContent,o,t),h=["children",""+o]):iv.hasOwnProperty(w)&&o!=null&&w==="onScroll"&&ws("scroll",c)}switch(r){case"input":bw(c),SO(c,x,!0);break;case"textarea":bw(c),NO(c);break;case"select":case"option":break;default:typeof x.onClick=="function"&&(c.onclick=M2)}c=h,e.updateQueue=c,c!==null&&(e.flags|=4)}else{w=h.nodeType===9?h:h.ownerDocument,t==="http://www.w3.org/1999/xhtml"&&(t=D5(r)),t==="http://www.w3.org/1999/xhtml"?r==="script"?(t=w.createElement("div"),t.innerHTML="<script><\/script>",t=t.removeChild(t.firstChild)):typeof c.is=="string"?t=w.createElement(r,{is:c.is}):(t=w.createElement(r),r==="select"&&(w=t,c.multiple?w.multiple=!0:c.size&&(w.size=c.size))):t=w.createElementNS(t,r),t[Lu]=e,t[hv]=c,nz(t,e,!1,!1),e.stateNode=t;e:{switch(w=JC(r,c),r){case"dialog":ws("cancel",t),ws("close",t),h=c;break;case"iframe":case"object":case"embed":ws("load",t),h=c;break;case"video":case"audio":for(h=0;h<C0.length;h++)ws(C0[h],t);h=c;break;case"source":ws("error",t),h=c;break;case"img":case"image":case"link":ws("error",t),ws("load",t),h=c;break;case"details":ws("toggle",t),h=c;break;case"input":wO(t,c),h=WC(t,c),ws("invalid",t);break;case"option":h=c;break;case"select":t._wrapperState={wasMultiple:!!c.multiple},h=Hs({},c,{value:void 0}),ws("invalid",t);break;case"textarea":TO(t,c),h=YC(t,c),ws("invalid",t);break;default:h=c}QC(r,h),o=h;for(x in o)if(o.hasOwnProperty(x)){var C=o[x];x==="style"?L5(t,C):x==="dangerouslySetInnerHTML"?(C=C?C.__html:void 0,C!=null&&M5(t,C)):x==="children"?typeof C=="string"?(r!=="textarea"||C!=="")&&rv(t,C):typeof C=="number"&&rv(t,""+C):x!=="suppressContentEditableWarning"&&x!=="suppressHydrationWarning"&&x!=="autoFocus"&&(iv.hasOwnProperty(x)?C!=null&&x==="onScroll"&&ws("scroll",t):C!=null&&DI(t,x,C,w))}switch(r){case"input":bw(t),SO(t,c,!1);break;case"textarea":bw(t),NO(t);break;case"option":c.value!=null&&t.setAttribute("value",""+vp(c.value));break;case"select":t.multiple=!!c.multiple,x=c.value,x!=null?dy(t,!!c.multiple,x,!1):c.defaultValue!=null&&dy(t,!!c.multiple,c.defaultValue,!0);break;default:typeof h.onClick=="function"&&(t.onclick=M2)}switch(r){case"button":case"input":case"select":case"textarea":c=!!c.autoFocus;break e;case"img":c=!0;break e;default:c=!1}}c&&(e.flags|=4)}e.ref!==null&&(e.flags|=512,e.flags|=2097152)}return Co(e),null;case 6:if(t&&e.stateNode!=null)az(t,e,t.memoizedProps,c);else{if(typeof c!="string"&&e.stateNode===null)throw Error(_i(166));if(r=Vm(mv.current),Vm(Bu.current),Pw(e)){if(c=e.stateNode,r=e.memoizedProps,c[Lu]=e,(x=c.nodeValue!==r)&&(t=Fl,t!==null))switch(t.tag){case 3:Iw(c.nodeValue,r,(t.mode&1)!==0);break;case 5:t.memoizedProps.suppressHydrationWarning!==!0&&Iw(c.nodeValue,r,(t.mode&1)!==0)}x&&(e.flags|=4)}else c=(r.nodeType===9?r:r.ownerDocument).createTextNode(c),c[Lu]=e,e.stateNode=c}return Co(e),null;case 13:if(Ts(qs),c=e.memoizedState,t===null||t.memoizedState!==null&&t.memoizedState.dehydrated!==null){if(ks&&Dl!==null&&e.mode&1&&!(e.flags&128))TF(),Ty(),e.flags|=98560,x=!1;else if(x=Pw(e),c!==null&&c.dehydrated!==null){if(t===null){if(!x)throw Error(_i(318));if(x=e.memoizedState,x=x!==null?x.dehydrated:null,!x)throw Error(_i(317));x[Lu]=e}else Ty(),!(e.flags&128)&&(e.memoizedState=null),e.flags|=4;Co(e),x=!1}else $c!==null&&(kE($c),$c=null),x=!0;if(!x)return e.flags&65536?e:null}return e.flags&128?(e.lanes=r,e):(c=c!==null,c!==(t!==null&&t.memoizedState!==null)&&c&&(e.child.flags|=8192,e.mode&1&&(t===null||qs.current&1?Ra===0&&(Ra=3):gP())),e.updateQueue!==null&&(e.flags|=4),Co(e),null);case 4:return Ay(),NE(t,e),t===null&&uv(e.stateNode.containerInfo),Co(e),null;case 10:return JI(e.type._context),Co(e),null;case 17:return _l(e.type)&&O2(),Co(e),null;case 19:if(Ts(qs),x=e.memoizedState,x===null)return Co(e),null;if(c=(e.flags&128)!==0,w=x.rendering,w===null)if(c)f0(x,!1);else{if(Ra!==0||t!==null&&t.flags&128)for(t=e.child;t!==null;){if(w=q2(t),w!==null){for(e.flags|=128,f0(x,!1),c=w.updateQueue,c!==null&&(e.updateQueue=c,e.flags|=4),e.subtreeFlags=0,c=r,r=e.child;r!==null;)x=r,t=c,x.flags&=14680066,w=x.alternate,w===null?(x.childLanes=0,x.lanes=t,x.child=null,x.subtreeFlags=0,x.memoizedProps=null,x.memoizedState=null,x.updateQueue=null,x.dependencies=null,x.stateNode=null):(x.childLanes=w.childLanes,x.lanes=w.lanes,x.child=w.child,x.subtreeFlags=0,x.deletions=null,x.memoizedProps=w.memoizedProps,x.memoizedState=w.memoizedState,x.updateQueue=w.updateQueue,x.type=w.type,t=w.dependencies,x.dependencies=t===null?null:{lanes:t.lanes,firstContext:t.firstContext}),r=r.sibling;return us(qs,qs.current&1|2),e.child}t=t.sibling}x.tail!==null&&ma()>Ey&&(e.flags|=128,c=!0,f0(x,!1),e.lanes=4194304)}else{if(!c)if(t=q2(w),t!==null){if(e.flags|=128,c=!0,r=t.updateQueue,r!==null&&(e.updateQueue=r,e.flags|=4),f0(x,!0),x.tail===null&&x.tailMode==="hidden"&&!w.alternate&&!ks)return Co(e),null}else 2*ma()-x.renderingStartTime>Ey&&r!==1073741824&&(e.flags|=128,c=!0,f0(x,!1),e.lanes=4194304);x.isBackwards?(w.sibling=e.child,e.child=w):(r=x.last,r!==null?r.sibling=w:e.child=w,x.last=w)}return x.tail!==null?(e=x.tail,x.rendering=e,x.tail=e.sibling,x.renderingStartTime=ma(),e.sibling=null,r=qs.current,us(qs,c?r&1|2:r&1),e):(Co(e),null);case 22:case 23:return fP(),c=e.memoizedState!==null,t!==null&&t.memoizedState!==null!==c&&(e.flags|=8192),c&&e.mode&1?kl&1073741824&&(Co(e),e.subtreeFlags&6&&(e.flags|=8192)):Co(e),null;case 24:return null;case 25:return null}throw Error(_i(156,e.tag))}function pH(t,e){switch(XI(e),e.tag){case 1:return _l(e.type)&&O2(),t=e.flags,t&65536?(e.flags=t&-65537|128,e):null;case 3:return Ay(),Ts(xl),Ts(Mo),nP(),t=e.flags,t&65536&&!(t&128)?(e.flags=t&-65537|128,e):null;case 5:return rP(e),null;case 13:if(Ts(qs),t=e.memoizedState,t!==null&&t.dehydrated!==null){if(e.alternate===null)throw Error(_i(340));Ty()}return t=e.flags,t&65536?(e.flags=t&-65537|128,e):null;case 19:return Ts(qs),null;case 4:return Ay(),null;case 10:return JI(e.type._context),null;case 22:case 23:return fP(),null;case 24:return null;default:return null}}var kw=!1,Po=!1,mH=typeof WeakSet=="function"?WeakSet:Set,Yi=null;function oy(t,e){var r=t.ref;if(r!==null)if(typeof r=="function")try{r(null)}catch(c){na(t,e,c)}else r.current=null}function AE(t,e,r){try{r()}catch(c){na(t,e,c)}}var mL=!1;function fH(t,e){if(cE=R2,t=dF(),WI(t)){if("selectionStart"in t)var r={start:t.selectionStart,end:t.selectionEnd};else e:{r=(r=t.ownerDocument)&&r.defaultView||window;var c=r.getSelection&&r.getSelection();if(c&&c.rangeCount!==0){r=c.anchorNode;var h=c.anchorOffset,x=c.focusNode;c=c.focusOffset;try{r.nodeType,x.nodeType}catch{r=null;break e}var w=0,o=-1,C=-1,R=0,F=0,$=t,Y=null;t:for(;;){for(var H;$!==r||h!==0&&$.nodeType!==3||(o=w+h),$!==x||c!==0&&$.nodeType!==3||(C=w+c),$.nodeType===3&&(w+=$.nodeValue.length),(H=$.firstChild)!==null;)Y=$,$=H;for(;;){if($===t)break t;if(Y===r&&++R===h&&(o=w),Y===x&&++F===c&&(C=w),(H=$.nextSibling)!==null)break;$=Y,Y=$.parentNode}$=H}r=o===-1||C===-1?null:{start:o,end:C}}else r=null}r=r||{start:0,end:0}}else r=null;for(uE={focusedElem:t,selectionRange:r},R2=!1,Yi=e;Yi!==null;)if(e=Yi,t=e.child,(e.subtreeFlags&1028)!==0&&t!==null)t.return=e,Yi=t;else for(;Yi!==null;){e=Yi;try{var X=e.alternate;if(e.flags&1024)switch(e.tag){case 0:case 11:case 15:break;case 1:if(X!==null){var he=X.memoizedProps,se=X.memoizedState,de=e.stateNode,K=de.getSnapshotBeforeUpdate(e.elementType===e.type?he:Uc(e.type,he),se);de.__reactInternalSnapshotBeforeUpdate=K}break;case 3:var ge=e.stateNode.containerInfo;ge.nodeType===1?ge.textContent="":ge.nodeType===9&&ge.documentElement&&ge.removeChild(ge.documentElement);break;case 5:case 6:case 4:case 17:break;default:throw Error(_i(163))}}catch(Ae){na(e,e.return,Ae)}if(t=e.sibling,t!==null){t.return=e.return,Yi=t;break}Yi=e.return}return X=mL,mL=!1,X}function q0(t,e,r){var c=e.updateQueue;if(c=c!==null?c.lastEffect:null,c!==null){var h=c=c.next;do{if((h.tag&t)===t){var x=h.destroy;h.destroy=void 0,x!==void 0&&AE(e,r,x)}h=h.next}while(h!==c)}}function zS(t,e){if(e=e.updateQueue,e=e!==null?e.lastEffect:null,e!==null){var r=e=e.next;do{if((r.tag&t)===t){var c=r.create;r.destroy=c()}r=r.next}while(r!==e)}}function CE(t){var e=t.ref;if(e!==null){var r=t.stateNode;switch(t.tag){case 5:t=r;break;default:t=r}typeof e=="function"?e(t):e.current=t}}function oz(t){var e=t.alternate;e!==null&&(t.alternate=null,oz(e)),t.child=null,t.deletions=null,t.sibling=null,t.tag===5&&(e=t.stateNode,e!==null&&(delete e[Lu],delete e[hv],delete e[pE],delete e[KG],delete e[QG])),t.stateNode=null,t.return=null,t.dependencies=null,t.memoizedProps=null,t.memoizedState=null,t.pendingProps=null,t.stateNode=null,t.updateQueue=null}function lz(t){return t.tag===5||t.tag===3||t.tag===4}function fL(t){e:for(;;){for(;t.sibling===null;){if(t.return===null||lz(t.return))return null;t=t.return}for(t.sibling.return=t.return,t=t.sibling;t.tag!==5&&t.tag!==6&&t.tag!==18;){if(t.flags&2||t.child===null||t.tag===4)continue e;t.child.return=t,t=t.child}if(!(t.flags&2))return t.stateNode}}function EE(t,e,r){var c=t.tag;if(c===5||c===6)t=t.stateNode,e?r.nodeType===8?r.parentNode.insertBefore(t,e):r.insertBefore(t,e):(r.nodeType===8?(e=r.parentNode,e.insertBefore(t,r)):(e=r,e.appendChild(t)),r=r._reactRootContainer,r!=null||e.onclick!==null||(e.onclick=M2));else if(c!==4&&(t=t.child,t!==null))for(EE(t,e,r),t=t.sibling;t!==null;)EE(t,e,r),t=t.sibling}function IE(t,e,r){var c=t.tag;if(c===5||c===6)t=t.stateNode,e?r.insertBefore(t,e):r.appendChild(t);else if(c!==4&&(t=t.child,t!==null))for(IE(t,e,r),t=t.sibling;t!==null;)IE(t,e,r),t=t.sibling}var oo=null,qc=!1;function Oh(t,e,r){for(r=r.child;r!==null;)cz(t,e,r),r=r.sibling}function cz(t,e,r){if(zu&&typeof zu.onCommitFiberUnmount=="function")try{zu.onCommitFiberUnmount(jS,r)}catch{}switch(r.tag){case 5:Po||oy(r,e);case 6:var c=oo,h=qc;oo=null,Oh(t,e,r),oo=c,qc=h,oo!==null&&(qc?(t=oo,r=r.stateNode,t.nodeType===8?t.parentNode.removeChild(r):t.removeChild(r)):oo.removeChild(r.stateNode));break;case 18:oo!==null&&(qc?(t=oo,r=r.stateNode,t.nodeType===8?uC(t.parentNode,r):t.nodeType===1&&uC(t,r),ov(t)):uC(oo,r.stateNode));break;case 4:c=oo,h=qc,oo=r.stateNode.containerInfo,qc=!0,Oh(t,e,r),oo=c,qc=h;break;case 0:case 11:case 14:case 15:if(!Po&&(c=r.updateQueue,c!==null&&(c=c.lastEffect,c!==null))){h=c=c.next;do{var x=h,w=x.destroy;x=x.tag,w!==void 0&&(x&2||x&4)&&AE(r,e,w),h=h.next}while(h!==c)}Oh(t,e,r);break;case 1:if(!Po&&(oy(r,e),c=r.stateNode,typeof c.componentWillUnmount=="function"))try{c.props=r.memoizedProps,c.state=r.memoizedState,c.componentWillUnmount()}catch(o){na(r,e,o)}Oh(t,e,r);break;case 21:Oh(t,e,r);break;case 22:r.mode&1?(Po=(c=Po)||r.memoizedState!==null,Oh(t,e,r),Po=c):Oh(t,e,r);break;default:Oh(t,e,r)}}function gL(t){var e=t.updateQueue;if(e!==null){t.updateQueue=null;var r=t.stateNode;r===null&&(r=t.stateNode=new mH),e.forEach(function(c){var h=TH.bind(null,t,c);r.has(c)||(r.add(c),c.then(h,h))})}}function Bc(t,e){var r=e.deletions;if(r!==null)for(var c=0;c<r.length;c++){var h=r[c];try{var x=t,w=e,o=w;e:for(;o!==null;){switch(o.tag){case 5:oo=o.stateNode,qc=!1;break e;case 3:oo=o.stateNode.containerInfo,qc=!0;break e;case 4:oo=o.stateNode.containerInfo,qc=!0;break e}o=o.return}if(oo===null)throw Error(_i(160));cz(x,w,h),oo=null,qc=!1;var C=h.alternate;C!==null&&(C.return=null),h.return=null}catch(R){na(h,e,R)}}if(e.subtreeFlags&12854)for(e=e.child;e!==null;)uz(e,t),e=e.sibling}function uz(t,e){var r=t.alternate,c=t.flags;switch(t.tag){case 0:case 11:case 14:case 15:if(Bc(e,t),Ru(t),c&4){try{q0(3,t,t.return),zS(3,t)}catch(he){na(t,t.return,he)}try{q0(5,t,t.return)}catch(he){na(t,t.return,he)}}break;case 1:Bc(e,t),Ru(t),c&512&&r!==null&&oy(r,r.return);break;case 5:if(Bc(e,t),Ru(t),c&512&&r!==null&&oy(r,r.return),t.flags&32){var h=t.stateNode;try{rv(h,"")}catch(he){na(t,t.return,he)}}if(c&4&&(h=t.stateNode,h!=null)){var x=t.memoizedProps,w=r!==null?r.memoizedProps:x,o=t.type,C=t.updateQueue;if(t.updateQueue=null,C!==null)try{o==="input"&&x.type==="radio"&&x.name!=null&&R5(h,x),JC(o,w);var R=JC(o,x);for(w=0;w<C.length;w+=2){var F=C[w],$=C[w+1];F==="style"?L5(h,$):F==="dangerouslySetInnerHTML"?M5(h,$):F==="children"?rv(h,$):DI(h,F,$,R)}switch(o){case"input":ZC(h,x);break;case"textarea":k5(h,x);break;case"select":var Y=h._wrapperState.wasMultiple;h._wrapperState.wasMultiple=!!x.multiple;var H=x.value;H!=null?dy(h,!!x.multiple,H,!1):Y!==!!x.multiple&&(x.defaultValue!=null?dy(h,!!x.multiple,x.defaultValue,!0):dy(h,!!x.multiple,x.multiple?[]:"",!1))}h[hv]=x}catch(he){na(t,t.return,he)}}break;case 6:if(Bc(e,t),Ru(t),c&4){if(t.stateNode===null)throw Error(_i(162));h=t.stateNode,x=t.memoizedProps;try{h.nodeValue=x}catch(he){na(t,t.return,he)}}break;case 3:if(Bc(e,t),Ru(t),c&4&&r!==null&&r.memoizedState.isDehydrated)try{ov(e.containerInfo)}catch(he){na(t,t.return,he)}break;case 4:Bc(e,t),Ru(t);break;case 13:Bc(e,t),Ru(t),h=t.child,h.flags&8192&&(x=h.memoizedState!==null,h.stateNode.isHidden=x,!x||h.alternate!==null&&h.alternate.memoizedState!==null||(pP=ma())),c&4&&gL(t);break;case 22:if(F=r!==null&&r.memoizedState!==null,t.mode&1?(Po=(R=Po)||F,Bc(e,t),Po=R):Bc(e,t),Ru(t),c&8192){if(R=t.memoizedState!==null,(t.stateNode.isHidden=R)&&!F&&t.mode&1)for(Yi=t,F=t.child;F!==null;){for($=Yi=F;Yi!==null;){switch(Y=Yi,H=Y.child,Y.tag){case 0:case 11:case 14:case 15:q0(4,Y,Y.return);break;case 1:oy(Y,Y.return);var X=Y.stateNode;if(typeof X.componentWillUnmount=="function"){c=Y,r=Y.return;try{e=c,X.props=e.memoizedProps,X.state=e.memoizedState,X.componentWillUnmount()}catch(he){na(c,r,he)}}break;case 5:oy(Y,Y.return);break;case 22:if(Y.memoizedState!==null){xL($);continue}}H!==null?(H.return=Y,Yi=H):xL($)}F=F.sibling}e:for(F=null,$=t;;){if($.tag===5){if(F===null){F=$;try{h=$.stateNode,R?(x=h.style,typeof x.setProperty=="function"?x.setProperty("display","none","important"):x.display="none"):(o=$.stateNode,C=$.memoizedProps.style,w=C!=null&&C.hasOwnProperty("display")?C.display:null,o.style.display=O5("display",w))}catch(he){na(t,t.return,he)}}}else if($.tag===6){if(F===null)try{$.stateNode.nodeValue=R?"":$.memoizedProps}catch(he){na(t,t.return,he)}}else if(($.tag!==22&&$.tag!==23||$.memoizedState===null||$===t)&&$.child!==null){$.child.return=$,$=$.child;continue}if($===t)break e;for(;$.sibling===null;){if($.return===null||$.return===t)break e;F===$&&(F=null),$=$.return}F===$&&(F=null),$.sibling.return=$.return,$=$.sibling}}break;case 19:Bc(e,t),Ru(t),c&4&&gL(t);break;case 21:break;default:Bc(e,t),Ru(t)}}function Ru(t){var e=t.flags;if(e&2){try{e:{for(var r=t.return;r!==null;){if(lz(r)){var c=r;break e}r=r.return}throw Error(_i(160))}switch(c.tag){case 5:var h=c.stateNode;c.flags&32&&(rv(h,""),c.flags&=-33);var x=fL(t);IE(t,x,h);break;case 3:case 4:var w=c.stateNode.containerInfo,o=fL(t);EE(t,o,w);break;default:throw Error(_i(161))}}catch(C){na(t,t.return,C)}t.flags&=-3}e&4096&&(t.flags&=-4097)}function gH(t,e,r){Yi=t,dz(t)}function dz(t,e,r){for(var c=(t.mode&1)!==0;Yi!==null;){var h=Yi,x=h.child;if(h.tag===22&&c){var w=h.memoizedState!==null||kw;if(!w){var o=h.alternate,C=o!==null&&o.memoizedState!==null||Po;o=kw;var R=Po;if(kw=w,(Po=C)&&!R)for(Yi=h;Yi!==null;)w=Yi,C=w.child,w.tag===22&&w.memoizedState!==null?_L(h):C!==null?(C.return=w,Yi=C):_L(h);for(;x!==null;)Yi=x,dz(x),x=x.sibling;Yi=h,kw=o,Po=R}yL(t)}else h.subtreeFlags&8772&&x!==null?(x.return=h,Yi=x):yL(t)}}function yL(t){for(;Yi!==null;){var e=Yi;if(e.flags&8772){var r=e.alternate;try{if(e.flags&8772)switch(e.tag){case 0:case 11:case 15:Po||zS(5,e);break;case 1:var c=e.stateNode;if(e.flags&4&&!Po)if(r===null)c.componentDidMount();else{var h=e.elementType===e.type?r.memoizedProps:Uc(e.type,r.memoizedProps);c.componentDidUpdate(h,r.memoizedState,c.__reactInternalSnapshotBeforeUpdate)}var x=e.updateQueue;x!==null&&tL(e,x,c);break;case 3:var w=e.updateQueue;if(w!==null){if(r=null,e.child!==null)switch(e.child.tag){case 5:r=e.child.stateNode;break;case 1:r=e.child.stateNode}tL(e,w,r)}break;case 5:var o=e.stateNode;if(r===null&&e.flags&4){r=o;var C=e.memoizedProps;switch(e.type){case"button":case"input":case"select":case"textarea":C.autoFocus&&r.focus();break;case"img":C.src&&(r.src=C.src)}}break;case 6:break;case 4:break;case 12:break;case 13:if(e.memoizedState===null){var R=e.alternate;if(R!==null){var F=R.memoizedState;if(F!==null){var $=F.dehydrated;$!==null&&ov($)}}}break;case 19:case 17:case 21:case 22:case 23:case 25:break;default:throw Error(_i(163))}Po||e.flags&512&&CE(e)}catch(Y){na(e,e.return,Y)}}if(e===t){Yi=null;break}if(r=e.sibling,r!==null){r.return=e.return,Yi=r;break}Yi=e.return}}function xL(t){for(;Yi!==null;){var e=Yi;if(e===t){Yi=null;break}var r=e.sibling;if(r!==null){r.return=e.return,Yi=r;break}Yi=e.return}}function _L(t){for(;Yi!==null;){var e=Yi;try{switch(e.tag){case 0:case 11:case 15:var r=e.return;try{zS(4,e)}catch(C){na(e,r,C)}break;case 1:var c=e.stateNode;if(typeof c.componentDidMount=="function"){var h=e.return;try{c.componentDidMount()}catch(C){na(e,h,C)}}var x=e.return;try{CE(e)}catch(C){na(e,x,C)}break;case 5:var w=e.return;try{CE(e)}catch(C){na(e,w,C)}}}catch(C){na(e,e.return,C)}if(e===t){Yi=null;break}var o=e.sibling;if(o!==null){o.return=e.return,Yi=o;break}Yi=e.return}}var yH=Math.ceil,H2=Xd.ReactCurrentDispatcher,dP=Xd.ReactCurrentOwner,gc=Xd.ReactCurrentBatchConfig,On=0,Za=null,Na=null,uo=0,kl=0,ly=Ip(0),Ra=0,xv=null,Jm=0,BS=0,hP=0,$0=null,fl=null,pP=0,Ey=1/0,Nd=null,W2=!1,PE=null,up=null,Dw=!1,ep=null,Z2=0,G0=0,jE=null,o2=-1,l2=0;function el(){return On&6?ma():o2!==-1?o2:o2=ma()}function dp(t){return t.mode&1?On&2&&uo!==0?uo&-uo:eH.transition!==null?(l2===0&&(l2=X5()),l2):(t=Qn,t!==0||(t=window.event,t=t===void 0?16:iF(t.type)),t):1}function Hc(t,e,r,c){if(50<G0)throw G0=0,jE=null,Error(_i(185));Lv(t,r,c),(!(On&2)||t!==Za)&&(t===Za&&(!(On&2)&&(BS|=r),Ra===4&&Hh(t,uo)),vl(t,c),r===1&&On===0&&!(e.mode&1)&&(Ey=ma()+500,OS&&Pp()))}function vl(t,e){var r=t.callbackNode;eG(t,e);var c=j2(t,t===Za?uo:0);if(c===0)r!==null&&EO(r),t.callbackNode=null,t.callbackPriority=0;else if(e=c&-c,t.callbackPriority!==e){if(r!=null&&EO(r),e===1)t.tag===0?JG(vL.bind(null,t)):bF(vL.bind(null,t)),XG(function(){!(On&6)&&Pp()}),r=null;else{switch(Y5(c)){case 1:r=zI;break;case 4:r=W5;break;case 16:r=P2;break;case 536870912:r=Z5;break;default:r=P2}r=_z(r,hz.bind(null,t))}t.callbackPriority=e,t.callbackNode=r}}function hz(t,e){if(o2=-1,l2=0,On&6)throw Error(_i(327));var r=t.callbackNode;if(gy()&&t.callbackNode!==r)return null;var c=j2(t,t===Za?uo:0);if(c===0)return null;if(c&30||c&t.expiredLanes||e)e=X2(t,c);else{e=c;var h=On;On|=2;var x=mz();(Za!==t||uo!==e)&&(Nd=null,Ey=ma()+500,$m(t,e));do try{vH();break}catch(o){pz(t,o)}while(!0);QI(),H2.current=x,On=h,Na!==null?e=0:(Za=null,uo=0,e=Ra)}if(e!==0){if(e===2&&(h=nE(t),h!==0&&(c=h,e=RE(t,h))),e===1)throw r=xv,$m(t,0),Hh(t,c),vl(t,ma()),r;if(e===6)Hh(t,c);else{if(h=t.current.alternate,!(c&30)&&!xH(h)&&(e=X2(t,c),e===2&&(x=nE(t),x!==0&&(c=x,e=RE(t,x))),e===1))throw r=xv,$m(t,0),Hh(t,c),vl(t,ma()),r;switch(t.finishedWork=h,t.finishedLanes=c,e){case 0:case 1:throw Error(_i(345));case 2:Om(t,fl,Nd);break;case 3:if(Hh(t,c),(c&130023424)===c&&(e=pP+500-ma(),10<e)){if(j2(t,0)!==0)break;if(h=t.suspendedLanes,(h&c)!==c){el(),t.pingedLanes|=t.suspendedLanes&h;break}t.timeoutHandle=hE(Om.bind(null,t,fl,Nd),e);break}Om(t,fl,Nd);break;case 4:if(Hh(t,c),(c&4194240)===c)break;for(e=t.eventTimes,h=-1;0<c;){var w=31-Gc(c);x=1<<w,w=e[w],w>h&&(h=w),c&=~x}if(c=h,c=ma()-c,c=(120>c?120:480>c?480:1080>c?1080:1920>c?1920:3e3>c?3e3:4320>c?4320:1960*yH(c/1960))-c,10<c){t.timeoutHandle=hE(Om.bind(null,t,fl,Nd),c);break}Om(t,fl,Nd);break;case 5:Om(t,fl,Nd);break;default:throw Error(_i(329))}}}return vl(t,ma()),t.callbackNode===r?hz.bind(null,t):null}function RE(t,e){var r=$0;return t.current.memoizedState.isDehydrated&&($m(t,e).flags|=256),t=X2(t,e),t!==2&&(e=fl,fl=r,e!==null&&kE(e)),t}function kE(t){fl===null?fl=t:fl.push.apply(fl,t)}function xH(t){for(var e=t;;){if(e.flags&16384){var r=e.updateQueue;if(r!==null&&(r=r.stores,r!==null))for(var c=0;c<r.length;c++){var h=r[c],x=h.getSnapshot;h=h.value;try{if(!Zc(x(),h))return!1}catch{return!1}}}if(r=e.child,e.subtreeFlags&16384&&r!==null)r.return=e,e=r;else{if(e===t)break;for(;e.sibling===null;){if(e.return===null||e.return===t)return!0;e=e.return}e.sibling.return=e.return,e=e.sibling}}return!0}function Hh(t,e){for(e&=~hP,e&=~BS,t.suspendedLanes|=e,t.pingedLanes&=~e,t=t.expirationTimes;0<e;){var r=31-Gc(e),c=1<<r;t[r]=-1,e&=~c}}function vL(t){if(On&6)throw Error(_i(327));gy();var e=j2(t,0);if(!(e&1))return vl(t,ma()),null;var r=X2(t,e);if(t.tag!==0&&r===2){var c=nE(t);c!==0&&(e=c,r=RE(t,c))}if(r===1)throw r=xv,$m(t,0),Hh(t,e),vl(t,ma()),r;if(r===6)throw Error(_i(345));return t.finishedWork=t.current.alternate,t.finishedLanes=e,Om(t,fl,Nd),vl(t,ma()),null}function mP(t,e){var r=On;On|=1;try{return t(e)}finally{On=r,On===0&&(Ey=ma()+500,OS&&Pp())}}function ef(t){ep!==null&&ep.tag===0&&!(On&6)&&gy();var e=On;On|=1;var r=gc.transition,c=Qn;try{if(gc.transition=null,Qn=1,t)return t()}finally{Qn=c,gc.transition=r,On=e,!(On&6)&&Pp()}}function fP(){kl=ly.current,Ts(ly)}function $m(t,e){t.finishedWork=null,t.finishedLanes=0;var r=t.timeoutHandle;if(r!==-1&&(t.timeoutHandle=-1,ZG(r)),Na!==null)for(r=Na.return;r!==null;){var c=r;switch(XI(c),c.tag){case 1:c=c.type.childContextTypes,c!=null&&O2();break;case 3:Ay(),Ts(xl),Ts(Mo),nP();break;case 5:rP(c);break;case 4:Ay();break;case 13:Ts(qs);break;case 19:Ts(qs);break;case 10:JI(c.type._context);break;case 22:case 23:fP()}r=r.return}if(Za=t,Na=t=hp(t.current,null),uo=kl=e,Ra=0,xv=null,hP=BS=Jm=0,fl=$0=null,Bm!==null){for(e=0;e<Bm.length;e++)if(r=Bm[e],c=r.interleaved,c!==null){r.interleaved=null;var h=c.next,x=r.pending;if(x!==null){var w=x.next;x.next=h,c.next=w}r.pending=c}Bm=null}return t}function pz(t,e){do{var r=Na;try{if(QI(),n2.current=G2,$2){for(var c=$s.memoizedState;c!==null;){var h=c.queue;h!==null&&(h.pending=null),c=c.next}$2=!1}if(Qm=0,Wa=ja=$s=null,U0=!1,fv=0,dP.current=null,r===null||r.return===null){Ra=1,xv=e,Na=null;break}e:{var x=t,w=r.return,o=r,C=e;if(e=uo,o.flags|=32768,C!==null&&typeof C=="object"&&typeof C.then=="function"){var R=C,F=o,$=F.tag;if(!(F.mode&1)&&($===0||$===11||$===15)){var Y=F.alternate;Y?(F.updateQueue=Y.updateQueue,F.memoizedState=Y.memoizedState,F.lanes=Y.lanes):(F.updateQueue=null,F.memoizedState=null)}var H=oL(w);if(H!==null){H.flags&=-257,lL(H,w,o,x,e),H.mode&1&&aL(x,R,e),e=H,C=R;var X=e.updateQueue;if(X===null){var he=new Set;he.add(C),e.updateQueue=he}else X.add(C);break e}else{if(!(e&1)){aL(x,R,e),gP();break e}C=Error(_i(426))}}else if(ks&&o.mode&1){var se=oL(w);if(se!==null){!(se.flags&65536)&&(se.flags|=256),lL(se,w,o,x,e),YI(Cy(C,o));break e}}x=C=Cy(C,o),Ra!==4&&(Ra=2),$0===null?$0=[x]:$0.push(x),x=w;do{switch(x.tag){case 3:x.flags|=65536,e&=-e,x.lanes|=e;var de=YF(x,C,e);eL(x,de);break e;case 1:o=C;var K=x.type,ge=x.stateNode;if(!(x.flags&128)&&(typeof K.getDerivedStateFromError=="function"||ge!==null&&typeof ge.componentDidCatch=="function"&&(up===null||!up.has(ge)))){x.flags|=65536,e&=-e,x.lanes|=e;var Ae=KF(x,o,e);eL(x,Ae);break e}}x=x.return}while(x!==null)}gz(r)}catch(Te){e=Te,Na===r&&r!==null&&(Na=r=r.return);continue}break}while(!0)}function mz(){var t=H2.current;return H2.current=G2,t===null?G2:t}function gP(){(Ra===0||Ra===3||Ra===2)&&(Ra=4),Za===null||!(Jm&268435455)&&!(BS&268435455)||Hh(Za,uo)}function X2(t,e){var r=On;On|=2;var c=mz();(Za!==t||uo!==e)&&(Nd=null,$m(t,e));do try{_H();break}catch(h){pz(t,h)}while(!0);if(QI(),On=r,H2.current=c,Na!==null)throw Error(_i(261));return Za=null,uo=0,Ra}function _H(){for(;Na!==null;)fz(Na)}function vH(){for(;Na!==null&&!G7();)fz(Na)}function fz(t){var e=xz(t.alternate,t,kl);t.memoizedProps=t.pendingProps,e===null?gz(t):Na=e,dP.current=null}function gz(t){var e=t;do{var r=e.alternate;if(t=e.return,e.flags&32768){if(r=pH(r,e),r!==null){r.flags&=32767,Na=r;return}if(t!==null)t.flags|=32768,t.subtreeFlags=0,t.deletions=null;else{Ra=6,Na=null;return}}else if(r=hH(r,e,kl),r!==null){Na=r;return}if(e=e.sibling,e!==null){Na=e;return}Na=e=t}while(e!==null);Ra===0&&(Ra=5)}function Om(t,e,r){var c=Qn,h=gc.transition;try{gc.transition=null,Qn=1,bH(t,e,r,c)}finally{gc.transition=h,Qn=c}return null}function bH(t,e,r,c){do gy();while(ep!==null);if(On&6)throw Error(_i(327));r=t.finishedWork;var h=t.finishedLanes;if(r===null)return null;if(t.finishedWork=null,t.finishedLanes=0,r===t.current)throw Error(_i(177));t.callbackNode=null,t.callbackPriority=0;var x=r.lanes|r.childLanes;if(tG(t,x),t===Za&&(Na=Za=null,uo=0),!(r.subtreeFlags&2064)&&!(r.flags&2064)||Dw||(Dw=!0,_z(P2,function(){return gy(),null})),x=(r.flags&15990)!==0,r.subtreeFlags&15990||x){x=gc.transition,gc.transition=null;var w=Qn;Qn=1;var o=On;On|=4,dP.current=null,fH(t,r),uz(r,t),VG(uE),R2=!!cE,uE=cE=null,t.current=r,gH(r),H7(),On=o,Qn=w,gc.transition=x}else t.current=r;if(Dw&&(Dw=!1,ep=t,Z2=h),x=t.pendingLanes,x===0&&(up=null),X7(r.stateNode),vl(t,ma()),e!==null)for(c=t.onRecoverableError,r=0;r<e.length;r++)h=e[r],c(h.value,{componentStack:h.stack,digest:h.digest});if(W2)throw W2=!1,t=PE,PE=null,t;return Z2&1&&t.tag!==0&&gy(),x=t.pendingLanes,x&1?t===jE?G0++:(G0=0,jE=t):G0=0,Pp(),null}function gy(){if(ep!==null){var t=Y5(Z2),e=gc.transition,r=Qn;try{if(gc.transition=null,Qn=16>t?16:t,ep===null)var c=!1;else{if(t=ep,ep=null,Z2=0,On&6)throw Error(_i(331));var h=On;for(On|=4,Yi=t.current;Yi!==null;){var x=Yi,w=x.child;if(Yi.flags&16){var o=x.deletions;if(o!==null){for(var C=0;C<o.length;C++){var R=o[C];for(Yi=R;Yi!==null;){var F=Yi;switch(F.tag){case 0:case 11:case 15:q0(8,F,x)}var $=F.child;if($!==null)$.return=F,Yi=$;else for(;Yi!==null;){F=Yi;var Y=F.sibling,H=F.return;if(oz(F),F===R){Yi=null;break}if(Y!==null){Y.return=H,Yi=Y;break}Yi=H}}}var X=x.alternate;if(X!==null){var he=X.child;if(he!==null){X.child=null;do{var se=he.sibling;he.sibling=null,he=se}while(he!==null)}}Yi=x}}if(x.subtreeFlags&2064&&w!==null)w.return=x,Yi=w;else e:for(;Yi!==null;){if(x=Yi,x.flags&2048)switch(x.tag){case 0:case 11:case 15:q0(9,x,x.return)}var de=x.sibling;if(de!==null){de.return=x.return,Yi=de;break e}Yi=x.return}}var K=t.current;for(Yi=K;Yi!==null;){w=Yi;var ge=w.child;if(w.subtreeFlags&2064&&ge!==null)ge.return=w,Yi=ge;else e:for(w=K;Yi!==null;){if(o=Yi,o.flags&2048)try{switch(o.tag){case 0:case 11:case 15:zS(9,o)}}catch(Te){na(o,o.return,Te)}if(o===w){Yi=null;break e}var Ae=o.sibling;if(Ae!==null){Ae.return=o.return,Yi=Ae;break e}Yi=o.return}}if(On=h,Pp(),zu&&typeof zu.onPostCommitFiberRoot=="function")try{zu.onPostCommitFiberRoot(jS,t)}catch{}c=!0}return c}finally{Qn=r,gc.transition=e}}return!1}function bL(t,e,r){e=Cy(r,e),e=YF(t,e,1),t=cp(t,e,1),e=el(),t!==null&&(Lv(t,1,e),vl(t,e))}function na(t,e,r){if(t.tag===3)bL(t,t,r);else for(;e!==null;){if(e.tag===3){bL(e,t,r);break}else if(e.tag===1){var c=e.stateNode;if(typeof e.type.getDerivedStateFromError=="function"||typeof c.componentDidCatch=="function"&&(up===null||!up.has(c))){t=Cy(r,t),t=KF(e,t,1),e=cp(e,t,1),t=el(),e!==null&&(Lv(e,1,t),vl(e,t));break}}e=e.return}}function wH(t,e,r){var c=t.pingCache;c!==null&&c.delete(e),e=el(),t.pingedLanes|=t.suspendedLanes&r,Za===t&&(uo&r)===r&&(Ra===4||Ra===3&&(uo&130023424)===uo&&500>ma()-pP?$m(t,0):hP|=r),vl(t,e)}function yz(t,e){e===0&&(t.mode&1?(e=Tw,Tw<<=1,!(Tw&130023424)&&(Tw=4194304)):e=1);var r=el();t=Bd(t,e),t!==null&&(Lv(t,e,r),vl(t,r))}function SH(t){var e=t.memoizedState,r=0;e!==null&&(r=e.retryLane),yz(t,r)}function TH(t,e){var r=0;switch(t.tag){case 13:var c=t.stateNode,h=t.memoizedState;h!==null&&(r=h.retryLane);break;case 19:c=t.stateNode;break;default:throw Error(_i(314))}c!==null&&c.delete(e),yz(t,r)}var xz;xz=function(t,e,r){if(t!==null)if(t.memoizedProps!==e.pendingProps||xl.current)yl=!0;else{if(!(t.lanes&r)&&!(e.flags&128))return yl=!1,dH(t,e,r);yl=!!(t.flags&131072)}else yl=!1,ks&&e.flags&1048576&&wF(e,z2,e.index);switch(e.lanes=0,e.tag){case 2:var c=e.type;a2(t,e),t=e.pendingProps;var h=Sy(e,Mo.current);fy(e,r),h=aP(null,e,c,t,h,r);var x=oP();return e.flags|=1,typeof h=="object"&&h!==null&&typeof h.render=="function"&&h.$$typeof===void 0?(e.tag=1,e.memoizedState=null,e.updateQueue=null,_l(c)?(x=!0,L2(e)):x=!1,e.memoizedState=h.state!==null&&h.state!==void 0?h.state:null,tP(e),h.updater=FS,e.stateNode=h,h._reactInternals=e,_E(e,c,t,r),e=wE(null,e,c,!0,x,r)):(e.tag=0,ks&&x&&ZI(e),Jo(null,e,h,r),e=e.child),e;case 16:c=e.elementType;e:{switch(a2(t,e),t=e.pendingProps,h=c._init,c=h(c._payload),e.type=c,h=e.tag=AH(c),t=Uc(c,t),h){case 0:e=bE(null,e,c,t,r);break e;case 1:e=dL(null,e,c,t,r);break e;case 11:e=cL(null,e,c,t,r);break e;case 14:e=uL(null,e,c,Uc(c.type,t),r);break e}throw Error(_i(306,c,""))}return e;case 0:return c=e.type,h=e.pendingProps,h=e.elementType===c?h:Uc(c,h),bE(t,e,c,h,r);case 1:return c=e.type,h=e.pendingProps,h=e.elementType===c?h:Uc(c,h),dL(t,e,c,h,r);case 3:e:{if(tz(e),t===null)throw Error(_i(387));c=e.pendingProps,x=e.memoizedState,h=x.element,EF(t,e),U2(e,c,null,r);var w=e.memoizedState;if(c=w.element,x.isDehydrated)if(x={element:c,isDehydrated:!1,cache:w.cache,pendingSuspenseBoundaries:w.pendingSuspenseBoundaries,transitions:w.transitions},e.updateQueue.baseState=x,e.memoizedState=x,e.flags&256){h=Cy(Error(_i(423)),e),e=hL(t,e,c,r,h);break e}else if(c!==h){h=Cy(Error(_i(424)),e),e=hL(t,e,c,r,h);break e}else for(Dl=lp(e.stateNode.containerInfo.firstChild),Fl=e,ks=!0,$c=null,r=AF(e,null,c,r),e.child=r;r;)r.flags=r.flags&-3|4096,r=r.sibling;else{if(Ty(),c===h){e=Vd(t,e,r);break e}Jo(t,e,c,r)}e=e.child}return e;case 5:return IF(e),t===null&&gE(e),c=e.type,h=e.pendingProps,x=t!==null?t.memoizedProps:null,w=h.children,dE(c,h)?w=null:x!==null&&dE(c,x)&&(e.flags|=32),ez(t,e),Jo(t,e,w,r),e.child;case 6:return t===null&&gE(e),null;case 13:return iz(t,e,r);case 4:return iP(e,e.stateNode.containerInfo),c=e.pendingProps,t===null?e.child=Ny(e,null,c,r):Jo(t,e,c,r),e.child;case 11:return c=e.type,h=e.pendingProps,h=e.elementType===c?h:Uc(c,h),cL(t,e,c,h,r);case 7:return Jo(t,e,e.pendingProps,r),e.child;case 8:return Jo(t,e,e.pendingProps.children,r),e.child;case 12:return Jo(t,e,e.pendingProps.children,r),e.child;case 10:e:{if(c=e.type._context,h=e.pendingProps,x=e.memoizedProps,w=h.value,us(B2,c._currentValue),c._currentValue=w,x!==null)if(Zc(x.value,w)){if(x.children===h.children&&!xl.current){e=Vd(t,e,r);break e}}else for(x=e.child,x!==null&&(x.return=e);x!==null;){var o=x.dependencies;if(o!==null){w=x.child;for(var C=o.firstContext;C!==null;){if(C.context===c){if(x.tag===1){C=Md(-1,r&-r),C.tag=2;var R=x.updateQueue;if(R!==null){R=R.shared;var F=R.pending;F===null?C.next=C:(C.next=F.next,F.next=C),R.pending=C}}x.lanes|=r,C=x.alternate,C!==null&&(C.lanes|=r),yE(x.return,r,e),o.lanes|=r;break}C=C.next}}else if(x.tag===10)w=x.type===e.type?null:x.child;else if(x.tag===18){if(w=x.return,w===null)throw Error(_i(341));w.lanes|=r,o=w.alternate,o!==null&&(o.lanes|=r),yE(w,r,e),w=x.sibling}else w=x.child;if(w!==null)w.return=x;else for(w=x;w!==null;){if(w===e){w=null;break}if(x=w.sibling,x!==null){x.return=w.return,w=x;break}w=w.return}x=w}Jo(t,e,h.children,r),e=e.child}return e;case 9:return h=e.type,c=e.pendingProps.children,fy(e,r),h=xc(h),c=c(h),e.flags|=1,Jo(t,e,c,r),e.child;case 14:return c=e.type,h=Uc(c,e.pendingProps),h=Uc(c.type,h),uL(t,e,c,h,r);case 15:return QF(t,e,e.type,e.pendingProps,r);case 17:return c=e.type,h=e.pendingProps,h=e.elementType===c?h:Uc(c,h),a2(t,e),e.tag=1,_l(c)?(t=!0,L2(e)):t=!1,fy(e,r),XF(e,c,h),_E(e,c,h,r),wE(null,e,c,!0,t,r);case 19:return rz(t,e,r);case 22:return JF(t,e,r)}throw Error(_i(156,e.tag))};function _z(t,e){return H5(t,e)}function NH(t,e,r,c){this.tag=t,this.key=r,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=e,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=c,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function pc(t,e,r,c){return new NH(t,e,r,c)}function yP(t){return t=t.prototype,!(!t||!t.isReactComponent)}function AH(t){if(typeof t=="function")return yP(t)?1:0;if(t!=null){if(t=t.$$typeof,t===OI)return 11;if(t===LI)return 14}return 2}function hp(t,e){var r=t.alternate;return r===null?(r=pc(t.tag,e,t.key,t.mode),r.elementType=t.elementType,r.type=t.type,r.stateNode=t.stateNode,r.alternate=t,t.alternate=r):(r.pendingProps=e,r.type=t.type,r.flags=0,r.subtreeFlags=0,r.deletions=null),r.flags=t.flags&14680064,r.childLanes=t.childLanes,r.lanes=t.lanes,r.child=t.child,r.memoizedProps=t.memoizedProps,r.memoizedState=t.memoizedState,r.updateQueue=t.updateQueue,e=t.dependencies,r.dependencies=e===null?null:{lanes:e.lanes,firstContext:e.firstContext},r.sibling=t.sibling,r.index=t.index,r.ref=t.ref,r}function c2(t,e,r,c,h,x){var w=2;if(c=t,typeof t=="function")yP(t)&&(w=1);else if(typeof t=="string")w=5;else e:switch(t){case Qg:return Gm(r.children,h,x,e);case MI:w=8,h|=8;break;case qC:return t=pc(12,r,e,h|2),t.elementType=qC,t.lanes=x,t;case $C:return t=pc(13,r,e,h),t.elementType=$C,t.lanes=x,t;case GC:return t=pc(19,r,e,h),t.elementType=GC,t.lanes=x,t;case I5:return VS(r,h,x,e);default:if(typeof t=="object"&&t!==null)switch(t.$$typeof){case C5:w=10;break e;case E5:w=9;break e;case OI:w=11;break e;case LI:w=14;break e;case Vh:w=16,c=null;break e}throw Error(_i(130,t==null?t:typeof t,""))}return e=pc(w,r,e,h),e.elementType=t,e.type=c,e.lanes=x,e}function Gm(t,e,r,c){return t=pc(7,t,c,e),t.lanes=r,t}function VS(t,e,r,c){return t=pc(22,t,c,e),t.elementType=I5,t.lanes=r,t.stateNode={isHidden:!1},t}function xC(t,e,r){return t=pc(6,t,null,e),t.lanes=r,t}function _C(t,e,r){return e=pc(4,t.children!==null?t.children:[],t.key,e),e.lanes=r,e.stateNode={containerInfo:t.containerInfo,pendingChildren:null,implementation:t.implementation},e}function CH(t,e,r,c,h){this.tag=e,this.containerInfo=t,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=JA(0),this.expirationTimes=JA(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=JA(0),this.identifierPrefix=c,this.onRecoverableError=h,this.mutableSourceEagerHydrationData=null}function xP(t,e,r,c,h,x,w,o,C){return t=new CH(t,e,r,o,C),e===1?(e=1,x===!0&&(e|=8)):e=0,x=pc(3,null,null,e),t.current=x,x.stateNode=t,x.memoizedState={element:c,isDehydrated:r,cache:null,transitions:null,pendingSuspenseBoundaries:null},tP(x),t}function EH(t,e,r){var c=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:Kg,key:c==null?null:""+c,children:t,containerInfo:e,implementation:r}}function vz(t){if(!t)return bp;t=t._reactInternals;e:{if(mf(t)!==t||t.tag!==1)throw Error(_i(170));var e=t;do{switch(e.tag){case 3:e=e.stateNode.context;break e;case 1:if(_l(e.type)){e=e.stateNode.__reactInternalMemoizedMergedChildContext;break e}}e=e.return}while(e!==null);throw Error(_i(171))}if(t.tag===1){var r=t.type;if(_l(r))return vF(t,r,e)}return e}function bz(t,e,r,c,h,x,w,o,C){return t=xP(r,c,!0,t,h,x,w,o,C),t.context=vz(null),r=t.current,c=el(),h=dp(r),x=Md(c,h),x.callback=e??null,cp(r,x,h),t.current.lanes=h,Lv(t,h,c),vl(t,c),t}function US(t,e,r,c){var h=e.current,x=el(),w=dp(h);return r=vz(r),e.context===null?e.context=r:e.pendingContext=r,e=Md(x,w),e.payload={element:t},c=c===void 0?null:c,c!==null&&(e.callback=c),t=cp(h,e,w),t!==null&&(Hc(t,h,w,x),r2(t,h,w)),w}function Y2(t){if(t=t.current,!t.child)return null;switch(t.child.tag){case 5:return t.child.stateNode;default:return t.child.stateNode}}function wL(t,e){if(t=t.memoizedState,t!==null&&t.dehydrated!==null){var r=t.retryLane;t.retryLane=r!==0&&r<e?r:e}}function _P(t,e){wL(t,e),(t=t.alternate)&&wL(t,e)}function IH(){return null}var wz=typeof reportError=="function"?reportError:function(t){console.error(t)};function vP(t){this._internalRoot=t}qS.prototype.render=vP.prototype.render=function(t){var e=this._internalRoot;if(e===null)throw Error(_i(409));US(t,e,null,null)};qS.prototype.unmount=vP.prototype.unmount=function(){var t=this._internalRoot;if(t!==null){this._internalRoot=null;var e=t.containerInfo;ef(function(){US(null,t,null,null)}),e[zd]=null}};function qS(t){this._internalRoot=t}qS.prototype.unstable_scheduleHydration=function(t){if(t){var e=J5();t={blockedOn:null,target:t,priority:e};for(var r=0;r<Gh.length&&e!==0&&e<Gh[r].priority;r++);Gh.splice(r,0,t),r===0&&tF(t)}};function bP(t){return!(!t||t.nodeType!==1&&t.nodeType!==9&&t.nodeType!==11)}function $S(t){return!(!t||t.nodeType!==1&&t.nodeType!==9&&t.nodeType!==11&&(t.nodeType!==8||t.nodeValue!==" react-mount-point-unstable "))}function SL(){}function PH(t,e,r,c,h){if(h){if(typeof c=="function"){var x=c;c=function(){var R=Y2(w);x.call(R)}}var w=bz(e,c,t,0,null,!1,!1,"",SL);return t._reactRootContainer=w,t[zd]=w.current,uv(t.nodeType===8?t.parentNode:t),ef(),w}for(;h=t.lastChild;)t.removeChild(h);if(typeof c=="function"){var o=c;c=function(){var R=Y2(C);o.call(R)}}var C=xP(t,0,!1,null,null,!1,!1,"",SL);return t._reactRootContainer=C,t[zd]=C.current,uv(t.nodeType===8?t.parentNode:t),ef(function(){US(e,C,r,c)}),C}function GS(t,e,r,c,h){var x=r._reactRootContainer;if(x){var w=x;if(typeof h=="function"){var o=h;h=function(){var C=Y2(w);o.call(C)}}US(e,w,t,h)}else w=PH(r,e,t,h,c);return Y2(w)}K5=function(t){switch(t.tag){case 3:var e=t.stateNode;if(e.current.memoizedState.isDehydrated){var r=A0(e.pendingLanes);r!==0&&(BI(e,r|1),vl(e,ma()),!(On&6)&&(Ey=ma()+500,Pp()))}break;case 13:ef(function(){var c=Bd(t,1);if(c!==null){var h=el();Hc(c,t,1,h)}}),_P(t,1)}};VI=function(t){if(t.tag===13){var e=Bd(t,134217728);if(e!==null){var r=el();Hc(e,t,134217728,r)}_P(t,134217728)}};Q5=function(t){if(t.tag===13){var e=dp(t),r=Bd(t,e);if(r!==null){var c=el();Hc(r,t,e,c)}_P(t,e)}};J5=function(){return Qn};eF=function(t,e){var r=Qn;try{return Qn=t,e()}finally{Qn=r}};tE=function(t,e,r){switch(e){case"input":if(ZC(t,r),e=r.name,r.type==="radio"&&e!=null){for(r=t;r.parentNode;)r=r.parentNode;for(r=r.querySelectorAll("input[name="+JSON.stringify(""+e)+'][type="radio"]'),e=0;e<r.length;e++){var c=r[e];if(c!==t&&c.form===t.form){var h=MS(c);if(!h)throw Error(_i(90));j5(c),ZC(c,h)}}}break;case"textarea":k5(t,r);break;case"select":e=r.value,e!=null&&dy(t,!!r.multiple,e,!1)}};B5=mP;V5=ef;var jH={usingClientEntryPoint:!1,Events:[zv,iy,MS,F5,z5,mP]},g0={findFiberByHostInstance:zm,bundleType:0,version:"18.3.1",rendererPackageName:"react-dom"},RH={bundleType:g0.bundleType,version:g0.version,rendererPackageName:g0.rendererPackageName,rendererConfig:g0.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:Xd.ReactCurrentDispatcher,findHostInstanceByFiber:function(t){return t=$5(t),t===null?null:t.stateNode},findFiberByHostInstance:g0.findFiberByHostInstance||IH,findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.3.1-next-f1338f8080-20240426"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var Mw=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!Mw.isDisabled&&Mw.supportsFiber)try{jS=Mw.inject(RH),zu=Mw}catch{}}ql.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=jH;ql.createPortal=function(t,e){var r=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!bP(e))throw Error(_i(200));return EH(t,e,null,r)};ql.createRoot=function(t,e){if(!bP(t))throw Error(_i(299));var r=!1,c="",h=wz;return e!=null&&(e.unstable_strictMode===!0&&(r=!0),e.identifierPrefix!==void 0&&(c=e.identifierPrefix),e.onRecoverableError!==void 0&&(h=e.onRecoverableError)),e=xP(t,1,!1,null,null,r,!1,c,h),t[zd]=e.current,uv(t.nodeType===8?t.parentNode:t),new vP(e)};ql.findDOMNode=function(t){if(t==null)return null;if(t.nodeType===1)return t;var e=t._reactInternals;if(e===void 0)throw typeof t.render=="function"?Error(_i(188)):(t=Object.keys(t).join(","),Error(_i(268,t)));return t=$5(e),t=t===null?null:t.stateNode,t};ql.flushSync=function(t){return ef(t)};ql.hydrate=function(t,e,r){if(!$S(e))throw Error(_i(200));return GS(null,t,e,!0,r)};ql.hydrateRoot=function(t,e,r){if(!bP(t))throw Error(_i(405));var c=r!=null&&r.hydratedSources||null,h=!1,x="",w=wz;if(r!=null&&(r.unstable_strictMode===!0&&(h=!0),r.identifierPrefix!==void 0&&(x=r.identifierPrefix),r.onRecoverableError!==void 0&&(w=r.onRecoverableError)),e=bz(e,null,t,1,r??null,h,!1,x,w),t[zd]=e.current,uv(t),c)for(t=0;t<c.length;t++)r=c[t],h=r._getVersion,h=h(r._source),e.mutableSourceEagerHydrationData==null?e.mutableSourceEagerHydrationData=[r,h]:e.mutableSourceEagerHydrationData.push(r,h);return new qS(e)};ql.render=function(t,e,r){if(!$S(e))throw Error(_i(200));return GS(null,t,e,!1,r)};ql.unmountComponentAtNode=function(t){if(!$S(t))throw Error(_i(40));return t._reactRootContainer?(ef(function(){GS(null,null,t,!1,function(){t._reactRootContainer=null,t[zd]=null})}),!0):!1};ql.unstable_batchedUpdates=mP;ql.unstable_renderSubtreeIntoContainer=function(t,e,r,c){if(!$S(r))throw Error(_i(200));if(t==null||t._reactInternals===void 0)throw Error(_i(38));return GS(t,e,r,!1,c)};ql.version="18.3.1-next-f1338f8080-20240426";function Sz(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(Sz)}catch(t){console.error(t)}}Sz(),S5.exports=ql;var kH=S5.exports,TL=kH;VC.createRoot=TL.createRoot,VC.hydrateRoot=TL.hydrateRoot;/**
 * @remix-run/router v1.23.2
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function _v(){return _v=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var c in r)Object.prototype.hasOwnProperty.call(r,c)&&(t[c]=r[c])}return t},_v.apply(this,arguments)}var tp;(function(t){t.Pop="POP",t.Push="PUSH",t.Replace="REPLACE"})(tp||(tp={}));const NL="popstate";function DH(t){t===void 0&&(t={});function e(c,h){let{pathname:x,search:w,hash:o}=c.location;return DE("",{pathname:x,search:w,hash:o},h.state&&h.state.usr||null,h.state&&h.state.key||"default")}function r(c,h){return typeof h=="string"?h:K2(h)}return OH(e,r,null,t)}function Gs(t,e){if(t===!1||t===null||typeof t>"u")throw new Error(e)}function wP(t,e){if(!t){typeof console<"u"&&console.warn(e);try{throw new Error(e)}catch{}}}function MH(){return Math.random().toString(36).substr(2,8)}function AL(t,e){return{usr:t.state,key:t.key,idx:e}}function DE(t,e,r,c){return r===void 0&&(r=null),_v({pathname:typeof t=="string"?t:t.pathname,search:"",hash:""},typeof e=="string"?Hy(e):e,{state:r,key:e&&e.key||c||MH()})}function K2(t){let{pathname:e="/",search:r="",hash:c=""}=t;return r&&r!=="?"&&(e+=r.charAt(0)==="?"?r:"?"+r),c&&c!=="#"&&(e+=c.charAt(0)==="#"?c:"#"+c),e}function Hy(t){let e={};if(t){let r=t.indexOf("#");r>=0&&(e.hash=t.substr(r),t=t.substr(0,r));let c=t.indexOf("?");c>=0&&(e.search=t.substr(c),t=t.substr(0,c)),t&&(e.pathname=t)}return e}function OH(t,e,r,c){c===void 0&&(c={});let{window:h=document.defaultView,v5Compat:x=!1}=c,w=h.history,o=tp.Pop,C=null,R=F();R==null&&(R=0,w.replaceState(_v({},w.state,{idx:R}),""));function F(){return(w.state||{idx:null}).idx}function $(){o=tp.Pop;let se=F(),de=se==null?null:se-R;R=se,C&&C({action:o,location:he.location,delta:de})}function Y(se,de){o=tp.Push;let K=DE(he.location,se,de);R=F()+1;let ge=AL(K,R),Ae=he.createHref(K);try{w.pushState(ge,"",Ae)}catch(Te){if(Te instanceof DOMException&&Te.name==="DataCloneError")throw Te;h.location.assign(Ae)}x&&C&&C({action:o,location:he.location,delta:1})}function H(se,de){o=tp.Replace;let K=DE(he.location,se,de);R=F();let ge=AL(K,R),Ae=he.createHref(K);w.replaceState(ge,"",Ae),x&&C&&C({action:o,location:he.location,delta:0})}function X(se){let de=h.location.origin!=="null"?h.location.origin:h.location.href,K=typeof se=="string"?se:K2(se);return K=K.replace(/ $/,"%20"),Gs(de,"No window.location.(origin|href) available to create URL for href: "+K),new URL(K,de)}let he={get action(){return o},get location(){return t(h,w)},listen(se){if(C)throw new Error("A history only accepts one active listener");return h.addEventListener(NL,$),C=se,()=>{h.removeEventListener(NL,$),C=null}},createHref(se){return e(h,se)},createURL:X,encodeLocation(se){let de=X(se);return{pathname:de.pathname,search:de.search,hash:de.hash}},push:Y,replace:H,go(se){return w.go(se)}};return he}var CL;(function(t){t.data="data",t.deferred="deferred",t.redirect="redirect",t.error="error"})(CL||(CL={}));function LH(t,e,r){return r===void 0&&(r="/"),FH(t,e,r)}function FH(t,e,r,c){let h=typeof e=="string"?Hy(e):e,x=Iy(h.pathname||"/",r);if(x==null)return null;let w=Tz(t);zH(w);let o=null;for(let C=0;o==null&&C<w.length;++C){let R=YH(x);o=ZH(w[C],R)}return o}function Tz(t,e,r,c){e===void 0&&(e=[]),r===void 0&&(r=[]),c===void 0&&(c="");let h=(x,w,o)=>{let C={relativePath:o===void 0?x.path||"":o,caseSensitive:x.caseSensitive===!0,childrenIndex:w,route:x};C.relativePath.startsWith("/")&&(Gs(C.relativePath.startsWith(c),'Absolute route path "'+C.relativePath+'" nested under path '+('"'+c+'" is not valid. An absolute child route path ')+"must start with the combined path of all its parent routes."),C.relativePath=C.relativePath.slice(c.length));let R=pp([c,C.relativePath]),F=r.concat(C);x.children&&x.children.length>0&&(Gs(x.index!==!0,"Index routes must not have child routes. Please remove "+('all child routes from route path "'+R+'".')),Tz(x.children,e,F,R)),!(x.path==null&&!x.index)&&e.push({path:R,score:HH(R,x.index),routesMeta:F})};return t.forEach((x,w)=>{var o;if(x.path===""||!((o=x.path)!=null&&o.includes("?")))h(x,w);else for(let C of Nz(x.path))h(x,w,C)}),e}function Nz(t){let e=t.split("/");if(e.length===0)return[];let[r,...c]=e,h=r.endsWith("?"),x=r.replace(/\?$/,"");if(c.length===0)return h?[x,""]:[x];let w=Nz(c.join("/")),o=[];return o.push(...w.map(C=>C===""?x:[x,C].join("/"))),h&&o.push(...w),o.map(C=>t.startsWith("/")&&C===""?"/":C)}function zH(t){t.sort((e,r)=>e.score!==r.score?r.score-e.score:WH(e.routesMeta.map(c=>c.childrenIndex),r.routesMeta.map(c=>c.childrenIndex)))}const BH=/^:[\w-]+$/,VH=3,UH=2,qH=1,$H=10,GH=-2,EL=t=>t==="*";function HH(t,e){let r=t.split("/"),c=r.length;return r.some(EL)&&(c+=GH),e&&(c+=UH),r.filter(h=>!EL(h)).reduce((h,x)=>h+(BH.test(x)?VH:x===""?qH:$H),c)}function WH(t,e){return t.length===e.length&&t.slice(0,-1).every((c,h)=>c===e[h])?t[t.length-1]-e[e.length-1]:0}function ZH(t,e,r){let{routesMeta:c}=t,h={},x="/",w=[];for(let o=0;o<c.length;++o){let C=c[o],R=o===c.length-1,F=x==="/"?e:e.slice(x.length)||"/",$=ME({path:C.relativePath,caseSensitive:C.caseSensitive,end:R},F),Y=C.route;if(!$)return null;Object.assign(h,$.params),w.push({params:h,pathname:pp([x,$.pathname]),pathnameBase:tW(pp([x,$.pathnameBase])),route:Y}),$.pathnameBase!=="/"&&(x=pp([x,$.pathnameBase]))}return w}function ME(t,e){typeof t=="string"&&(t={path:t,caseSensitive:!1,end:!0});let[r,c]=XH(t.path,t.caseSensitive,t.end),h=e.match(r);if(!h)return null;let x=h[0],w=x.replace(/(.)\/+$/,"$1"),o=h.slice(1);return{params:c.reduce((R,F,$)=>{let{paramName:Y,isOptional:H}=F;if(Y==="*"){let he=o[$]||"";w=x.slice(0,x.length-he.length).replace(/(.)\/+$/,"$1")}const X=o[$];return H&&!X?R[Y]=void 0:R[Y]=(X||"").replace(/%2F/g,"/"),R},{}),pathname:x,pathnameBase:w,pattern:t}}function XH(t,e,r){e===void 0&&(e=!1),r===void 0&&(r=!0),wP(t==="*"||!t.endsWith("*")||t.endsWith("/*"),'Route path "'+t+'" will be treated as if it were '+('"'+t.replace(/\*$/,"/*")+'" because the `*` character must ')+"always follow a `/` in the pattern. To get rid of this warning, "+('please change the route path to "'+t.replace(/\*$/,"/*")+'".'));let c=[],h="^"+t.replace(/\/*\*?$/,"").replace(/^\/*/,"/").replace(/[\\.*+^${}|()[\]]/g,"\\$&").replace(/\/:([\w-]+)(\?)?/g,(w,o,C)=>(c.push({paramName:o,isOptional:C!=null}),C?"/?([^\\/]+)?":"/([^\\/]+)"));return t.endsWith("*")?(c.push({paramName:"*"}),h+=t==="*"||t==="/*"?"(.*)$":"(?:\\/(.+)|\\/*)$"):r?h+="\\/*$":t!==""&&t!=="/"&&(h+="(?:(?=\\/|$))"),[new RegExp(h,e?void 0:"i"),c]}function YH(t){try{return t.split("/").map(e=>decodeURIComponent(e).replace(/\//g,"%2F")).join("/")}catch(e){return wP(!1,'The URL path "'+t+'" could not be decoded because it is is a malformed URL segment. This is probably due to a bad percent '+("encoding ("+e+").")),t}}function Iy(t,e){if(e==="/")return t;if(!t.toLowerCase().startsWith(e.toLowerCase()))return null;let r=e.endsWith("/")?e.length-1:e.length,c=t.charAt(r);return c&&c!=="/"?null:t.slice(r)||"/"}const KH=/^(?:[a-z][a-z0-9+.-]*:|\/\/)/i,QH=t=>KH.test(t);function JH(t,e){e===void 0&&(e="/");let{pathname:r,search:c="",hash:h=""}=typeof t=="string"?Hy(t):t,x;if(r)if(QH(r))x=r;else{if(r.includes("//")){let w=r;r=r.replace(/\/\/+/g,"/"),wP(!1,"Pathnames cannot have embedded double slashes - normalizing "+(w+" -> "+r))}r.startsWith("/")?x=IL(r.substring(1),"/"):x=IL(r,e)}else x=e;return{pathname:x,search:iW(c),hash:rW(h)}}function IL(t,e){let r=e.replace(/\/+$/,"").split("/");return t.split("/").forEach(h=>{h===".."?r.length>1&&r.pop():h!=="."&&r.push(h)}),r.length>1?r.join("/"):"/"}function vC(t,e,r,c){return"Cannot include a '"+t+"' character in a manually specified "+("`to."+e+"` field ["+JSON.stringify(c)+"].  Please separate it out to the ")+("`to."+r+"` field. Alternatively you may provide the full path as ")+'a string in <Link to="..."> and the router will parse it for you.'}function eW(t){return t.filter((e,r)=>r===0||e.route.path&&e.route.path.length>0)}function SP(t,e){let r=eW(t);return e?r.map((c,h)=>h===r.length-1?c.pathname:c.pathnameBase):r.map(c=>c.pathnameBase)}function TP(t,e,r,c){c===void 0&&(c=!1);let h;typeof t=="string"?h=Hy(t):(h=_v({},t),Gs(!h.pathname||!h.pathname.includes("?"),vC("?","pathname","search",h)),Gs(!h.pathname||!h.pathname.includes("#"),vC("#","pathname","hash",h)),Gs(!h.search||!h.search.includes("#"),vC("#","search","hash",h)));let x=t===""||h.pathname==="",w=x?"/":h.pathname,o;if(w==null)o=r;else{let $=e.length-1;if(!c&&w.startsWith("..")){let Y=w.split("/");for(;Y[0]==="..";)Y.shift(),$-=1;h.pathname=Y.join("/")}o=$>=0?e[$]:"/"}let C=JH(h,o),R=w&&w!=="/"&&w.endsWith("/"),F=(x||w===".")&&r.endsWith("/");return!C.pathname.endsWith("/")&&(R||F)&&(C.pathname+="/"),C}const pp=t=>t.join("/").replace(/\/\/+/g,"/"),tW=t=>t.replace(/\/+$/,"").replace(/^\/*/,"/"),iW=t=>!t||t==="?"?"":t.startsWith("?")?t:"?"+t,rW=t=>!t||t==="#"?"":t.startsWith("#")?t:"#"+t;function nW(t){return t!=null&&typeof t.status=="number"&&typeof t.statusText=="string"&&typeof t.internal=="boolean"&&"data"in t}const Az=["post","put","patch","delete"];new Set(Az);const sW=["get",...Az];new Set(sW);/**
 * React Router v6.30.3
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function vv(){return vv=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var c in r)Object.prototype.hasOwnProperty.call(r,c)&&(t[c]=r[c])}return t},vv.apply(this,arguments)}const HS=ue.createContext(null),Cz=ue.createContext(null),Yd=ue.createContext(null),WS=ue.createContext(null),Ku=ue.createContext({outlet:null,matches:[],isDataRoute:!1}),Ez=ue.createContext(null);function aW(t,e){let{relative:r}=e===void 0?{}:e;Wy()||Gs(!1);let{basename:c,navigator:h}=ue.useContext(Yd),{hash:x,pathname:w,search:o}=ZS(t,{relative:r}),C=w;return c!=="/"&&(C=w==="/"?c:pp([c,w])),h.createHref({pathname:C,search:o,hash:x})}function Wy(){return ue.useContext(WS)!=null}function jp(){return Wy()||Gs(!1),ue.useContext(WS).location}function Iz(t){ue.useContext(Yd).static||ue.useLayoutEffect(t)}function tu(){let{isDataRoute:t}=ue.useContext(Ku);return t?bW():oW()}function oW(){Wy()||Gs(!1);let t=ue.useContext(HS),{basename:e,future:r,navigator:c}=ue.useContext(Yd),{matches:h}=ue.useContext(Ku),{pathname:x}=jp(),w=JSON.stringify(SP(h,r.v7_relativeSplatPath)),o=ue.useRef(!1);return Iz(()=>{o.current=!0}),ue.useCallback(function(R,F){if(F===void 0&&(F={}),!o.current)return;if(typeof R=="number"){c.go(R);return}let $=TP(R,JSON.parse(w),x,F.relative==="path");t==null&&e!=="/"&&($.pathname=$.pathname==="/"?e:pp([e,$.pathname])),(F.replace?c.replace:c.push)($,F.state,F)},[e,c,w,x,t])}const lW=ue.createContext(null);function cW(t){let e=ue.useContext(Ku).outlet;return e&&ue.createElement(lW.Provider,{value:t},e)}function NP(){let{matches:t}=ue.useContext(Ku),e=t[t.length-1];return e?e.params:{}}function ZS(t,e){let{relative:r}=e===void 0?{}:e,{future:c}=ue.useContext(Yd),{matches:h}=ue.useContext(Ku),{pathname:x}=jp(),w=JSON.stringify(SP(h,c.v7_relativeSplatPath));return ue.useMemo(()=>TP(t,JSON.parse(w),x,r==="path"),[t,w,x,r])}function uW(t,e){return dW(t,e)}function dW(t,e,r,c){Wy()||Gs(!1);let{navigator:h}=ue.useContext(Yd),{matches:x}=ue.useContext(Ku),w=x[x.length-1],o=w?w.params:{};w&&w.pathname;let C=w?w.pathnameBase:"/";w&&w.route;let R=jp(),F;if(e){var $;let se=typeof e=="string"?Hy(e):e;C==="/"||($=se.pathname)!=null&&$.startsWith(C)||Gs(!1),F=se}else F=R;let Y=F.pathname||"/",H=Y;if(C!=="/"){let se=C.replace(/^\//,"").split("/");H="/"+Y.replace(/^\//,"").split("/").slice(se.length).join("/")}let X=LH(t,{pathname:H}),he=gW(X&&X.map(se=>Object.assign({},se,{params:Object.assign({},o,se.params),pathname:pp([C,h.encodeLocation?h.encodeLocation(se.pathname).pathname:se.pathname]),pathnameBase:se.pathnameBase==="/"?C:pp([C,h.encodeLocation?h.encodeLocation(se.pathnameBase).pathname:se.pathnameBase])})),x,r,c);return e&&he?ue.createElement(WS.Provider,{value:{location:vv({pathname:"/",search:"",hash:"",state:null,key:"default"},F),navigationType:tp.Pop}},he):he}function hW(){let t=vW(),e=nW(t)?t.status+" "+t.statusText:t instanceof Error?t.message:JSON.stringify(t),r=t instanceof Error?t.stack:null,h={padding:"0.5rem",backgroundColor:"rgba(200,200,200, 0.5)"};return ue.createElement(ue.Fragment,null,ue.createElement("h2",null,"Unexpected Application Error!"),ue.createElement("h3",{style:{fontStyle:"italic"}},e),r?ue.createElement("pre",{style:h},r):null,null)}const pW=ue.createElement(hW,null);class mW extends ue.Component{constructor(e){super(e),this.state={location:e.location,revalidation:e.revalidation,error:e.error}}static getDerivedStateFromError(e){return{error:e}}static getDerivedStateFromProps(e,r){return r.location!==e.location||r.revalidation!=="idle"&&e.revalidation==="idle"?{error:e.error,location:e.location,revalidation:e.revalidation}:{error:e.error!==void 0?e.error:r.error,location:r.location,revalidation:e.revalidation||r.revalidation}}componentDidCatch(e,r){console.error("React Router caught the following error during render",e,r)}render(){return this.state.error!==void 0?ue.createElement(Ku.Provider,{value:this.props.routeContext},ue.createElement(Ez.Provider,{value:this.state.error,children:this.props.component})):this.props.children}}function fW(t){let{routeContext:e,match:r,children:c}=t,h=ue.useContext(HS);return h&&h.static&&h.staticContext&&(r.route.errorElement||r.route.ErrorBoundary)&&(h.staticContext._deepestRenderedBoundaryId=r.route.id),ue.createElement(Ku.Provider,{value:e},c)}function gW(t,e,r,c){var h;if(e===void 0&&(e=[]),r===void 0&&(r=null),c===void 0&&(c=null),t==null){var x;if(!r)return null;if(r.errors)t=r.matches;else if((x=c)!=null&&x.v7_partialHydration&&e.length===0&&!r.initialized&&r.matches.length>0)t=r.matches;else return null}let w=t,o=(h=r)==null?void 0:h.errors;if(o!=null){let F=w.findIndex($=>$.route.id&&(o==null?void 0:o[$.route.id])!==void 0);F>=0||Gs(!1),w=w.slice(0,Math.min(w.length,F+1))}let C=!1,R=-1;if(r&&c&&c.v7_partialHydration)for(let F=0;F<w.length;F++){let $=w[F];if(($.route.HydrateFallback||$.route.hydrateFallbackElement)&&(R=F),$.route.id){let{loaderData:Y,errors:H}=r,X=$.route.loader&&Y[$.route.id]===void 0&&(!H||H[$.route.id]===void 0);if($.route.lazy||X){C=!0,R>=0?w=w.slice(0,R+1):w=[w[0]];break}}}return w.reduceRight((F,$,Y)=>{let H,X=!1,he=null,se=null;r&&(H=o&&$.route.id?o[$.route.id]:void 0,he=$.route.errorElement||pW,C&&(R<0&&Y===0?(wW("route-fallback"),X=!0,se=null):R===Y&&(X=!0,se=$.route.hydrateFallbackElement||null)));let de=e.concat(w.slice(0,Y+1)),K=()=>{let ge;return H?ge=he:X?ge=se:$.route.Component?ge=ue.createElement($.route.Component,null):$.route.element?ge=$.route.element:ge=F,ue.createElement(fW,{match:$,routeContext:{outlet:F,matches:de,isDataRoute:r!=null},children:ge})};return r&&($.route.ErrorBoundary||$.route.errorElement||Y===0)?ue.createElement(mW,{location:r.location,revalidation:r.revalidation,component:he,error:H,children:K(),routeContext:{outlet:null,matches:de,isDataRoute:!0}}):K()},null)}var Pz=function(t){return t.UseBlocker="useBlocker",t.UseRevalidator="useRevalidator",t.UseNavigateStable="useNavigate",t}(Pz||{}),jz=function(t){return t.UseBlocker="useBlocker",t.UseLoaderData="useLoaderData",t.UseActionData="useActionData",t.UseRouteError="useRouteError",t.UseNavigation="useNavigation",t.UseRouteLoaderData="useRouteLoaderData",t.UseMatches="useMatches",t.UseRevalidator="useRevalidator",t.UseNavigateStable="useNavigate",t.UseRouteId="useRouteId",t}(jz||{});function yW(t){let e=ue.useContext(HS);return e||Gs(!1),e}function xW(t){let e=ue.useContext(Cz);return e||Gs(!1),e}function _W(t){let e=ue.useContext(Ku);return e||Gs(!1),e}function Rz(t){let e=_W(),r=e.matches[e.matches.length-1];return r.route.id||Gs(!1),r.route.id}function vW(){var t;let e=ue.useContext(Ez),r=xW(),c=Rz();return e!==void 0?e:(t=r.errors)==null?void 0:t[c]}function bW(){let{router:t}=yW(Pz.UseNavigateStable),e=Rz(jz.UseNavigateStable),r=ue.useRef(!1);return Iz(()=>{r.current=!0}),ue.useCallback(function(h,x){x===void 0&&(x={}),r.current&&(typeof h=="number"?t.navigate(h):t.navigate(h,vv({fromRouteId:e},x)))},[t,e])}const PL={};function wW(t,e,r){PL[t]||(PL[t]=!0)}function SW(t,e){t==null||t.v7_startTransition,t==null||t.v7_relativeSplatPath}function AP(t){let{to:e,replace:r,state:c,relative:h}=t;Wy()||Gs(!1);let{future:x,static:w}=ue.useContext(Yd),{matches:o}=ue.useContext(Ku),{pathname:C}=jp(),R=tu(),F=TP(e,SP(o,x.v7_relativeSplatPath),C,h==="path"),$=JSON.stringify(F);return ue.useEffect(()=>R(JSON.parse($),{replace:r,state:c,relative:h}),[R,$,h,r,c]),null}function TW(t){return cW(t.context)}function ra(t){Gs(!1)}function NW(t){let{basename:e="/",children:r=null,location:c,navigationType:h=tp.Pop,navigator:x,static:w=!1,future:o}=t;Wy()&&Gs(!1);let C=e.replace(/^\/*/,"/"),R=ue.useMemo(()=>({basename:C,navigator:x,static:w,future:vv({v7_relativeSplatPath:!1},o)}),[C,o,x,w]);typeof c=="string"&&(c=Hy(c));let{pathname:F="/",search:$="",hash:Y="",state:H=null,key:X="default"}=c,he=ue.useMemo(()=>{let se=Iy(F,C);return se==null?null:{location:{pathname:se,search:$,hash:Y,state:H,key:X},navigationType:h}},[C,F,$,Y,H,X,h]);return he==null?null:ue.createElement(Yd.Provider,{value:R},ue.createElement(WS.Provider,{children:r,value:he}))}function AW(t){let{children:e,location:r}=t;return uW(OE(e),r)}new Promise(()=>{});function OE(t,e){e===void 0&&(e=[]);let r=[];return ue.Children.forEach(t,(c,h)=>{if(!ue.isValidElement(c))return;let x=[...e,h];if(c.type===ue.Fragment){r.push.apply(r,OE(c.props.children,x));return}c.type!==ra&&Gs(!1),!c.props.index||!c.props.children||Gs(!1);let w={id:c.props.id||x.join("-"),caseSensitive:c.props.caseSensitive,element:c.props.element,Component:c.props.Component,index:c.props.index,path:c.props.path,loader:c.props.loader,action:c.props.action,errorElement:c.props.errorElement,ErrorBoundary:c.props.ErrorBoundary,hasErrorBoundary:c.props.ErrorBoundary!=null||c.props.errorElement!=null,shouldRevalidate:c.props.shouldRevalidate,handle:c.props.handle,lazy:c.props.lazy};c.props.children&&(w.children=OE(c.props.children,x)),r.push(w)}),r}/**
 * React Router DOM v6.30.3
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function Q2(){return Q2=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var c in r)Object.prototype.hasOwnProperty.call(r,c)&&(t[c]=r[c])}return t},Q2.apply(this,arguments)}function kz(t,e){if(t==null)return{};var r={},c=Object.keys(t),h,x;for(x=0;x<c.length;x++)h=c[x],!(e.indexOf(h)>=0)&&(r[h]=t[h]);return r}function CW(t){return!!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey)}function EW(t,e){return t.button===0&&(!e||e==="_self")&&!CW(t)}function LE(t){return t===void 0&&(t=""),new URLSearchParams(typeof t=="string"||Array.isArray(t)||t instanceof URLSearchParams?t:Object.keys(t).reduce((e,r)=>{let c=t[r];return e.concat(Array.isArray(c)?c.map(h=>[r,h]):[[r,c]])},[]))}function IW(t,e){let r=LE(t);return e&&e.forEach((c,h)=>{r.has(h)||e.getAll(h).forEach(x=>{r.append(h,x)})}),r}const PW=["onClick","relative","reloadDocument","replace","state","target","to","preventScrollReset","viewTransition"],jW=["aria-current","caseSensitive","className","end","style","to","viewTransition","children"],RW="6";try{window.__reactRouterVersion=RW}catch{}const kW=ue.createContext({isTransitioning:!1}),DW="startTransition",jL=w7[DW];function MW(t){let{basename:e,children:r,future:c,window:h}=t,x=ue.useRef();x.current==null&&(x.current=DH({window:h,v5Compat:!0}));let w=x.current,[o,C]=ue.useState({action:w.action,location:w.location}),{v7_startTransition:R}=c||{},F=ue.useCallback($=>{R&&jL?jL(()=>C($)):C($)},[C,R]);return ue.useLayoutEffect(()=>w.listen(F),[w,F]),ue.useEffect(()=>SW(c),[c]),ue.createElement(NW,{basename:e,children:r,location:o.location,navigationType:o.action,navigator:w,future:c})}const OW=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u",LW=/^(?:[a-z][a-z0-9+.-]*:|\/\/)/i,dr=ue.forwardRef(function(e,r){let{onClick:c,relative:h,reloadDocument:x,replace:w,state:o,target:C,to:R,preventScrollReset:F,viewTransition:$}=e,Y=kz(e,PW),{basename:H}=ue.useContext(Yd),X,he=!1;if(typeof R=="string"&&LW.test(R)&&(X=R,OW))try{let ge=new URL(window.location.href),Ae=R.startsWith("//")?new URL(ge.protocol+R):new URL(R),Te=Iy(Ae.pathname,H);Ae.origin===ge.origin&&Te!=null?R=Te+Ae.search+Ae.hash:he=!0}catch{}let se=aW(R,{relative:h}),de=zW(R,{replace:w,state:o,target:C,preventScrollReset:F,relative:h,viewTransition:$});function K(ge){c&&c(ge),ge.defaultPrevented||de(ge)}return ue.createElement("a",Q2({},Y,{href:X||se,onClick:he||x?c:K,ref:r,target:C}))}),RL=ue.forwardRef(function(e,r){let{"aria-current":c="page",caseSensitive:h=!1,className:x="",end:w=!1,style:o,to:C,viewTransition:R,children:F}=e,$=kz(e,jW),Y=ZS(C,{relative:$.relative}),H=jp(),X=ue.useContext(Cz),{navigator:he,basename:se}=ue.useContext(Yd),de=X!=null&&BW(Y)&&R===!0,K=he.encodeLocation?he.encodeLocation(Y).pathname:Y.pathname,ge=H.pathname,Ae=X&&X.navigation&&X.navigation.location?X.navigation.location.pathname:null;h||(ge=ge.toLowerCase(),Ae=Ae?Ae.toLowerCase():null,K=K.toLowerCase()),Ae&&se&&(Ae=Iy(Ae,se)||Ae);const Te=K!=="/"&&K.endsWith("/")?K.length-1:K.length;let Ce=ge===K||!w&&ge.startsWith(K)&&ge.charAt(Te)==="/",ne=Ae!=null&&(Ae===K||!w&&Ae.startsWith(K)&&Ae.charAt(K.length)==="/"),ae={isActive:Ce,isPending:ne,isTransitioning:de},q=Ce?c:void 0,oe;typeof x=="function"?oe=x(ae):oe=[x,Ce?"active":null,ne?"pending":null,de?"transitioning":null].filter(Boolean).join(" ");let ke=typeof o=="function"?o(ae):o;return ue.createElement(dr,Q2({},$,{"aria-current":q,className:oe,ref:r,style:ke,to:C,viewTransition:R}),typeof F=="function"?F(ae):F)});var FE;(function(t){t.UseScrollRestoration="useScrollRestoration",t.UseSubmit="useSubmit",t.UseSubmitFetcher="useSubmitFetcher",t.UseFetcher="useFetcher",t.useViewTransitionState="useViewTransitionState"})(FE||(FE={}));var kL;(function(t){t.UseFetcher="useFetcher",t.UseFetchers="useFetchers",t.UseScrollRestoration="useScrollRestoration"})(kL||(kL={}));function FW(t){let e=ue.useContext(HS);return e||Gs(!1),e}function zW(t,e){let{target:r,replace:c,state:h,preventScrollReset:x,relative:w,viewTransition:o}=e===void 0?{}:e,C=tu(),R=jp(),F=ZS(t,{relative:w});return ue.useCallback($=>{if(EW($,r)){$.preventDefault();let Y=c!==void 0?c:K2(R)===K2(F);C(t,{replace:Y,state:h,preventScrollReset:x,relative:w,viewTransition:o})}},[R,C,F,c,h,r,t,x,w,o])}function Vv(t){let e=ue.useRef(LE(t)),r=ue.useRef(!1),c=jp(),h=ue.useMemo(()=>IW(c.search,r.current?null:e.current),[c.search]),x=tu(),w=ue.useCallback((o,C)=>{const R=LE(typeof o=="function"?o(h):o);r.current=!0,x("?"+R,C)},[x,h]);return[h,w]}function BW(t,e){e===void 0&&(e={});let r=ue.useContext(kW);r==null&&Gs(!1);let{basename:c}=FW(FE.useViewTransitionState),h=ZS(t,{relative:e.relative});if(!r.isTransitioning)return!1;let x=Iy(r.currentLocation.pathname,c)||r.currentLocation.pathname,w=Iy(r.nextLocation.pathname,c)||r.nextLocation.pathname;return ME(h.pathname,w)!=null||ME(h.pathname,x)!=null}var DL={};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Dz=function(t){const e=[];let r=0;for(let c=0;c<t.length;c++){let h=t.charCodeAt(c);h<128?e[r++]=h:h<2048?(e[r++]=h>>6|192,e[r++]=h&63|128):(h&64512)===55296&&c+1<t.length&&(t.charCodeAt(c+1)&64512)===56320?(h=65536+((h&1023)<<10)+(t.charCodeAt(++c)&1023),e[r++]=h>>18|240,e[r++]=h>>12&63|128,e[r++]=h>>6&63|128,e[r++]=h&63|128):(e[r++]=h>>12|224,e[r++]=h>>6&63|128,e[r++]=h&63|128)}return e},VW=function(t){const e=[];let r=0,c=0;for(;r<t.length;){const h=t[r++];if(h<128)e[c++]=String.fromCharCode(h);else if(h>191&&h<224){const x=t[r++];e[c++]=String.fromCharCode((h&31)<<6|x&63)}else if(h>239&&h<365){const x=t[r++],w=t[r++],o=t[r++],C=((h&7)<<18|(x&63)<<12|(w&63)<<6|o&63)-65536;e[c++]=String.fromCharCode(55296+(C>>10)),e[c++]=String.fromCharCode(56320+(C&1023))}else{const x=t[r++],w=t[r++];e[c++]=String.fromCharCode((h&15)<<12|(x&63)<<6|w&63)}}return e.join("")},Mz={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:typeof atob=="function",encodeByteArray(t,e){if(!Array.isArray(t))throw Error("encodeByteArray takes an array as a parameter");this.init_();const r=e?this.byteToCharMapWebSafe_:this.byteToCharMap_,c=[];for(let h=0;h<t.length;h+=3){const x=t[h],w=h+1<t.length,o=w?t[h+1]:0,C=h+2<t.length,R=C?t[h+2]:0,F=x>>2,$=(x&3)<<4|o>>4;let Y=(o&15)<<2|R>>6,H=R&63;C||(H=64,w||(Y=64)),c.push(r[F],r[$],r[Y],r[H])}return c.join("")},encodeString(t,e){return this.HAS_NATIVE_SUPPORT&&!e?btoa(t):this.encodeByteArray(Dz(t),e)},decodeString(t,e){return this.HAS_NATIVE_SUPPORT&&!e?atob(t):VW(this.decodeStringToByteArray(t,e))},decodeStringToByteArray(t,e){this.init_();const r=e?this.charToByteMapWebSafe_:this.charToByteMap_,c=[];for(let h=0;h<t.length;){const x=r[t.charAt(h++)],o=h<t.length?r[t.charAt(h)]:0;++h;const R=h<t.length?r[t.charAt(h)]:64;++h;const $=h<t.length?r[t.charAt(h)]:64;if(++h,x==null||o==null||R==null||$==null)throw new UW;const Y=x<<2|o>>4;if(c.push(Y),R!==64){const H=o<<4&240|R>>2;if(c.push(H),$!==64){const X=R<<6&192|$;c.push(X)}}}return c},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let t=0;t<this.ENCODED_VALS.length;t++)this.byteToCharMap_[t]=this.ENCODED_VALS.charAt(t),this.charToByteMap_[this.byteToCharMap_[t]]=t,this.byteToCharMapWebSafe_[t]=this.ENCODED_VALS_WEBSAFE.charAt(t),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[t]]=t,t>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(t)]=t,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(t)]=t)}}};class UW extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const qW=function(t){const e=Dz(t);return Mz.encodeByteArray(e,!0)},J2=function(t){return qW(t).replace(/\./g,"")},Oz=function(t){try{return Mz.decodeString(t,!0)}catch(e){console.error("base64Decode failed: ",e)}return null};/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function $W(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("Unable to locate global object.")}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const GW=()=>$W().__FIREBASE_DEFAULTS__,HW=()=>{if(typeof process>"u"||typeof DL>"u")return;const t=DL.__FIREBASE_DEFAULTS__;if(t)return JSON.parse(t)},WW=()=>{if(typeof document>"u")return;let t;try{t=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch{return}const e=t&&Oz(t[1]);return e&&JSON.parse(e)},XS=()=>{try{return GW()||HW()||WW()}catch(t){console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${t}`);return}},Lz=t=>{var e,r;return(r=(e=XS())===null||e===void 0?void 0:e.emulatorHosts)===null||r===void 0?void 0:r[t]},Fz=t=>{const e=Lz(t);if(!e)return;const r=e.lastIndexOf(":");if(r<=0||r+1===e.length)throw new Error(`Invalid host ${e} with no separate hostname and port!`);const c=parseInt(e.substring(r+1),10);return e[0]==="["?[e.substring(1,r-1),c]:[e.substring(0,r),c]},zz=()=>{var t;return(t=XS())===null||t===void 0?void 0:t.config},Bz=t=>{var e;return(e=XS())===null||e===void 0?void 0:e[`_${t}`]};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ZW{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((e,r)=>{this.resolve=e,this.reject=r})}wrapCallback(e){return(r,c)=>{r?this.reject(r):this.resolve(c),typeof e=="function"&&(this.promise.catch(()=>{}),e.length===1?e(r):e(r,c))}}}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Vz(t,e){if(t.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const r={alg:"none",type:"JWT"},c=e||"demo-project",h=t.iat||0,x=t.sub||t.user_id;if(!x)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const w=Object.assign({iss:`https://securetoken.google.com/${c}`,aud:c,iat:h,exp:h+3600,auth_time:h,sub:x,user_id:x,firebase:{sign_in_provider:"custom",identities:{}}},t);return[J2(JSON.stringify(r)),J2(JSON.stringify(w)),""].join(".")}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Oo(){return typeof navigator<"u"&&typeof navigator.userAgent=="string"?navigator.userAgent:""}function XW(){return typeof window<"u"&&!!(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(Oo())}function YW(){var t;const e=(t=XS())===null||t===void 0?void 0:t.forceEnvironment;if(e==="node")return!0;if(e==="browser")return!1;try{return Object.prototype.toString.call(global.process)==="[object process]"}catch{return!1}}function KW(){return typeof navigator<"u"&&navigator.userAgent==="Cloudflare-Workers"}function QW(){const t=typeof chrome=="object"?chrome.runtime:typeof browser=="object"?browser.runtime:void 0;return typeof t=="object"&&t.id!==void 0}function JW(){return typeof navigator=="object"&&navigator.product==="ReactNative"}function eZ(){const t=Oo();return t.indexOf("MSIE ")>=0||t.indexOf("Trident/")>=0}function tZ(){return!YW()&&!!navigator.userAgent&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}function iZ(){try{return typeof indexedDB=="object"}catch{return!1}}function rZ(){return new Promise((t,e)=>{try{let r=!0;const c="validate-browser-context-for-indexeddb-analytics-module",h=self.indexedDB.open(c);h.onsuccess=()=>{h.result.close(),r||self.indexedDB.deleteDatabase(c),t(!0)},h.onupgradeneeded=()=>{r=!1},h.onerror=()=>{var x;e(((x=h.error)===null||x===void 0?void 0:x.message)||"")}}catch(r){e(r)}})}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const nZ="FirebaseError";class Qu extends Error{constructor(e,r,c){super(r),this.code=e,this.customData=c,this.name=nZ,Object.setPrototypeOf(this,Qu.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,Uv.prototype.create)}}class Uv{constructor(e,r,c){this.service=e,this.serviceName=r,this.errors=c}create(e,...r){const c=r[0]||{},h=`${this.service}/${e}`,x=this.errors[e],w=x?sZ(x,c):"Error",o=`${this.serviceName}: ${w} (${h}).`;return new Qu(h,o,c)}}function sZ(t,e){return t.replace(aZ,(r,c)=>{const h=e[c];return h!=null?String(h):`<${c}?>`})}const aZ=/\{\$([^}]+)}/g;function oZ(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}function eS(t,e){if(t===e)return!0;const r=Object.keys(t),c=Object.keys(e);for(const h of r){if(!c.includes(h))return!1;const x=t[h],w=e[h];if(ML(x)&&ML(w)){if(!eS(x,w))return!1}else if(x!==w)return!1}for(const h of c)if(!r.includes(h))return!1;return!0}function ML(t){return t!==null&&typeof t=="object"}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function qv(t){const e=[];for(const[r,c]of Object.entries(t))Array.isArray(c)?c.forEach(h=>{e.push(encodeURIComponent(r)+"="+encodeURIComponent(h))}):e.push(encodeURIComponent(r)+"="+encodeURIComponent(c));return e.length?"&"+e.join("&"):""}function E0(t){const e={};return t.replace(/^\?/,"").split("&").forEach(c=>{if(c){const[h,x]=c.split("=");e[decodeURIComponent(h)]=decodeURIComponent(x)}}),e}function I0(t){const e=t.indexOf("?");if(!e)return"";const r=t.indexOf("#",e);return t.substring(e,r>0?r:void 0)}function lZ(t,e){const r=new cZ(t,e);return r.subscribe.bind(r)}class cZ{constructor(e,r){this.observers=[],this.unsubscribes=[],this.observerCount=0,this.task=Promise.resolve(),this.finalized=!1,this.onNoObservers=r,this.task.then(()=>{e(this)}).catch(c=>{this.error(c)})}next(e){this.forEachObserver(r=>{r.next(e)})}error(e){this.forEachObserver(r=>{r.error(e)}),this.close(e)}complete(){this.forEachObserver(e=>{e.complete()}),this.close()}subscribe(e,r,c){let h;if(e===void 0&&r===void 0&&c===void 0)throw new Error("Missing Observer.");uZ(e,["next","error","complete"])?h=e:h={next:e,error:r,complete:c},h.next===void 0&&(h.next=bC),h.error===void 0&&(h.error=bC),h.complete===void 0&&(h.complete=bC);const x=this.unsubscribeOne.bind(this,this.observers.length);return this.finalized&&this.task.then(()=>{try{this.finalError?h.error(this.finalError):h.complete()}catch{}}),this.observers.push(h),x}unsubscribeOne(e){this.observers===void 0||this.observers[e]===void 0||(delete this.observers[e],this.observerCount-=1,this.observerCount===0&&this.onNoObservers!==void 0&&this.onNoObservers(this))}forEachObserver(e){if(!this.finalized)for(let r=0;r<this.observers.length;r++)this.sendOne(r,e)}sendOne(e,r){this.task.then(()=>{if(this.observers!==void 0&&this.observers[e]!==void 0)try{r(this.observers[e])}catch(c){typeof console<"u"&&console.error&&console.error(c)}})}close(e){this.finalized||(this.finalized=!0,e!==void 0&&(this.finalError=e),this.task.then(()=>{this.observers=void 0,this.onNoObservers=void 0}))}}function uZ(t,e){if(typeof t!="object"||t===null)return!1;for(const r of e)if(r in t&&typeof t[r]=="function")return!0;return!1}function bC(){}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function As(t){return t&&t._delegate?t._delegate:t}class wp{constructor(e,r,c){this.name=e,this.instanceFactory=r,this.type=c,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Lm="[DEFAULT]";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class dZ{constructor(e,r){this.name=e,this.container=r,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(e){const r=this.normalizeInstanceIdentifier(e);if(!this.instancesDeferred.has(r)){const c=new ZW;if(this.instancesDeferred.set(r,c),this.isInitialized(r)||this.shouldAutoInitialize())try{const h=this.getOrInitializeService({instanceIdentifier:r});h&&c.resolve(h)}catch{}}return this.instancesDeferred.get(r).promise}getImmediate(e){var r;const c=this.normalizeInstanceIdentifier(e==null?void 0:e.identifier),h=(r=e==null?void 0:e.optional)!==null&&r!==void 0?r:!1;if(this.isInitialized(c)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:c})}catch(x){if(h)return null;throw x}else{if(h)return null;throw Error(`Service ${this.name} is not available`)}}getComponent(){return this.component}setComponent(e){if(e.name!==this.name)throw Error(`Mismatching Component ${e.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=e,!!this.shouldAutoInitialize()){if(pZ(e))try{this.getOrInitializeService({instanceIdentifier:Lm})}catch{}for(const[r,c]of this.instancesDeferred.entries()){const h=this.normalizeInstanceIdentifier(r);try{const x=this.getOrInitializeService({instanceIdentifier:h});c.resolve(x)}catch{}}}}clearInstance(e=Lm){this.instancesDeferred.delete(e),this.instancesOptions.delete(e),this.instances.delete(e)}async delete(){const e=Array.from(this.instances.values());await Promise.all([...e.filter(r=>"INTERNAL"in r).map(r=>r.INTERNAL.delete()),...e.filter(r=>"_delete"in r).map(r=>r._delete())])}isComponentSet(){return this.component!=null}isInitialized(e=Lm){return this.instances.has(e)}getOptions(e=Lm){return this.instancesOptions.get(e)||{}}initialize(e={}){const{options:r={}}=e,c=this.normalizeInstanceIdentifier(e.instanceIdentifier);if(this.isInitialized(c))throw Error(`${this.name}(${c}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const h=this.getOrInitializeService({instanceIdentifier:c,options:r});for(const[x,w]of this.instancesDeferred.entries()){const o=this.normalizeInstanceIdentifier(x);c===o&&w.resolve(h)}return h}onInit(e,r){var c;const h=this.normalizeInstanceIdentifier(r),x=(c=this.onInitCallbacks.get(h))!==null&&c!==void 0?c:new Set;x.add(e),this.onInitCallbacks.set(h,x);const w=this.instances.get(h);return w&&e(w,h),()=>{x.delete(e)}}invokeOnInitCallbacks(e,r){const c=this.onInitCallbacks.get(r);if(c)for(const h of c)try{h(e,r)}catch{}}getOrInitializeService({instanceIdentifier:e,options:r={}}){let c=this.instances.get(e);if(!c&&this.component&&(c=this.component.instanceFactory(this.container,{instanceIdentifier:hZ(e),options:r}),this.instances.set(e,c),this.instancesOptions.set(e,r),this.invokeOnInitCallbacks(c,e),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,e,c)}catch{}return c||null}normalizeInstanceIdentifier(e=Lm){return this.component?this.component.multipleInstances?e:Lm:e}shouldAutoInitialize(){return!!this.component&&this.component.instantiationMode!=="EXPLICIT"}}function hZ(t){return t===Lm?void 0:t}function pZ(t){return t.instantiationMode==="EAGER"}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class mZ{constructor(e){this.name=e,this.providers=new Map}addComponent(e){const r=this.getProvider(e.name);if(r.isComponentSet())throw new Error(`Component ${e.name} has already been registered with ${this.name}`);r.setComponent(e)}addOrOverwriteComponent(e){this.getProvider(e.name).isComponentSet()&&this.providers.delete(e.name),this.addComponent(e)}getProvider(e){if(this.providers.has(e))return this.providers.get(e);const r=new dZ(e,this);return this.providers.set(e,r),r}getProviders(){return Array.from(this.providers.values())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Sn;(function(t){t[t.DEBUG=0]="DEBUG",t[t.VERBOSE=1]="VERBOSE",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.SILENT=5]="SILENT"})(Sn||(Sn={}));const fZ={debug:Sn.DEBUG,verbose:Sn.VERBOSE,info:Sn.INFO,warn:Sn.WARN,error:Sn.ERROR,silent:Sn.SILENT},gZ=Sn.INFO,yZ={[Sn.DEBUG]:"log",[Sn.VERBOSE]:"log",[Sn.INFO]:"info",[Sn.WARN]:"warn",[Sn.ERROR]:"error"},xZ=(t,e,...r)=>{if(e<t.logLevel)return;const c=new Date().toISOString(),h=yZ[e];if(h)console[h](`[${c}]  ${t.name}:`,...r);else throw new Error(`Attempted to log a message with an invalid logType (value: ${e})`)};class CP{constructor(e){this.name=e,this._logLevel=gZ,this._logHandler=xZ,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in Sn))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel=typeof e=="string"?fZ[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if(typeof e!="function")throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,Sn.DEBUG,...e),this._logHandler(this,Sn.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,Sn.VERBOSE,...e),this._logHandler(this,Sn.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,Sn.INFO,...e),this._logHandler(this,Sn.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,Sn.WARN,...e),this._logHandler(this,Sn.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,Sn.ERROR,...e),this._logHandler(this,Sn.ERROR,...e)}}const _Z=(t,e)=>e.some(r=>t instanceof r);let OL,LL;function vZ(){return OL||(OL=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function bZ(){return LL||(LL=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const Uz=new WeakMap,zE=new WeakMap,qz=new WeakMap,wC=new WeakMap,EP=new WeakMap;function wZ(t){const e=new Promise((r,c)=>{const h=()=>{t.removeEventListener("success",x),t.removeEventListener("error",w)},x=()=>{r(mp(t.result)),h()},w=()=>{c(t.error),h()};t.addEventListener("success",x),t.addEventListener("error",w)});return e.then(r=>{r instanceof IDBCursor&&Uz.set(r,t)}).catch(()=>{}),EP.set(e,t),e}function SZ(t){if(zE.has(t))return;const e=new Promise((r,c)=>{const h=()=>{t.removeEventListener("complete",x),t.removeEventListener("error",w),t.removeEventListener("abort",w)},x=()=>{r(),h()},w=()=>{c(t.error||new DOMException("AbortError","AbortError")),h()};t.addEventListener("complete",x),t.addEventListener("error",w),t.addEventListener("abort",w)});zE.set(t,e)}let BE={get(t,e,r){if(t instanceof IDBTransaction){if(e==="done")return zE.get(t);if(e==="objectStoreNames")return t.objectStoreNames||qz.get(t);if(e==="store")return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return mp(t[e])},set(t,e,r){return t[e]=r,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function TZ(t){BE=t(BE)}function NZ(t){return t===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(e,...r){const c=t.call(SC(this),e,...r);return qz.set(c,e.sort?e.sort():[e]),mp(c)}:bZ().includes(t)?function(...e){return t.apply(SC(this),e),mp(Uz.get(this))}:function(...e){return mp(t.apply(SC(this),e))}}function AZ(t){return typeof t=="function"?NZ(t):(t instanceof IDBTransaction&&SZ(t),_Z(t,vZ())?new Proxy(t,BE):t)}function mp(t){if(t instanceof IDBRequest)return wZ(t);if(wC.has(t))return wC.get(t);const e=AZ(t);return e!==t&&(wC.set(t,e),EP.set(e,t)),e}const SC=t=>EP.get(t);function CZ(t,e,{blocked:r,upgrade:c,blocking:h,terminated:x}={}){const w=indexedDB.open(t,e),o=mp(w);return c&&w.addEventListener("upgradeneeded",C=>{c(mp(w.result),C.oldVersion,C.newVersion,mp(w.transaction),C)}),r&&w.addEventListener("blocked",C=>r(C.oldVersion,C.newVersion,C)),o.then(C=>{x&&C.addEventListener("close",()=>x()),h&&C.addEventListener("versionchange",R=>h(R.oldVersion,R.newVersion,R))}).catch(()=>{}),o}const EZ=["get","getKey","getAll","getAllKeys","count"],IZ=["put","add","delete","clear"],TC=new Map;function FL(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(TC.get(e))return TC.get(e);const r=e.replace(/FromIndex$/,""),c=e!==r,h=IZ.includes(r);if(!(r in(c?IDBIndex:IDBObjectStore).prototype)||!(h||EZ.includes(r)))return;const x=async function(w,...o){const C=this.transaction(w,h?"readwrite":"readonly");let R=C.store;return c&&(R=R.index(o.shift())),(await Promise.all([R[r](...o),h&&C.done]))[0]};return TC.set(e,x),x}TZ(t=>({...t,get:(e,r,c)=>FL(e,r)||t.get(e,r,c),has:(e,r)=>!!FL(e,r)||t.has(e,r)}));/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class PZ{constructor(e){this.container=e}getPlatformInfoString(){return this.container.getProviders().map(r=>{if(jZ(r)){const c=r.getImmediate();return`${c.library}/${c.version}`}else return null}).filter(r=>r).join(" ")}}function jZ(t){const e=t.getComponent();return(e==null?void 0:e.type)==="VERSION"}const VE="@firebase/app",zL="0.10.13";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ud=new CP("@firebase/app"),RZ="@firebase/app-compat",kZ="@firebase/analytics-compat",DZ="@firebase/analytics",MZ="@firebase/app-check-compat",OZ="@firebase/app-check",LZ="@firebase/auth",FZ="@firebase/auth-compat",zZ="@firebase/database",BZ="@firebase/data-connect",VZ="@firebase/database-compat",UZ="@firebase/functions",qZ="@firebase/functions-compat",$Z="@firebase/installations",GZ="@firebase/installations-compat",HZ="@firebase/messaging",WZ="@firebase/messaging-compat",ZZ="@firebase/performance",XZ="@firebase/performance-compat",YZ="@firebase/remote-config",KZ="@firebase/remote-config-compat",QZ="@firebase/storage",JZ="@firebase/storage-compat",eX="@firebase/firestore",tX="@firebase/vertexai-preview",iX="@firebase/firestore-compat",rX="firebase",nX="10.14.1";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const UE="[DEFAULT]",sX={[VE]:"fire-core",[RZ]:"fire-core-compat",[DZ]:"fire-analytics",[kZ]:"fire-analytics-compat",[OZ]:"fire-app-check",[MZ]:"fire-app-check-compat",[LZ]:"fire-auth",[FZ]:"fire-auth-compat",[zZ]:"fire-rtdb",[BZ]:"fire-data-connect",[VZ]:"fire-rtdb-compat",[UZ]:"fire-fn",[qZ]:"fire-fn-compat",[$Z]:"fire-iid",[GZ]:"fire-iid-compat",[HZ]:"fire-fcm",[WZ]:"fire-fcm-compat",[ZZ]:"fire-perf",[XZ]:"fire-perf-compat",[YZ]:"fire-rc",[KZ]:"fire-rc-compat",[QZ]:"fire-gcs",[JZ]:"fire-gcs-compat",[eX]:"fire-fst",[iX]:"fire-fst-compat",[tX]:"fire-vertex","fire-js":"fire-js",[rX]:"fire-js-all"};/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const tS=new Map,aX=new Map,qE=new Map;function BL(t,e){try{t.container.addComponent(e)}catch(r){Ud.debug(`Component ${e.name} failed to register with FirebaseApp ${t.name}`,r)}}function tf(t){const e=t.name;if(qE.has(e))return Ud.debug(`There were multiple attempts to register component ${e}.`),!1;qE.set(e,t);for(const r of tS.values())BL(r,t);for(const r of aX.values())BL(r,t);return!0}function YS(t,e){const r=t.container.getProvider("heartbeat").getImmediate({optional:!0});return r&&r.triggerHeartbeat(),t.container.getProvider(e)}function Pd(t){return t.settings!==void 0}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const oX={"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."},fp=new Uv("app","Firebase",oX);/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class lX{constructor(e,r,c){this._isDeleted=!1,this._options=Object.assign({},e),this._config=Object.assign({},r),this._name=r.name,this._automaticDataCollectionEnabled=r.automaticDataCollectionEnabled,this._container=c,this.container.addComponent(new wp("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(e){this.checkDestroyed(),this._automaticDataCollectionEnabled=e}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(e){this._isDeleted=e}checkDestroyed(){if(this.isDeleted)throw fp.create("app-deleted",{appName:this._name})}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ff=nX;function $z(t,e={}){let r=t;typeof e!="object"&&(e={name:e});const c=Object.assign({name:UE,automaticDataCollectionEnabled:!1},e),h=c.name;if(typeof h!="string"||!h)throw fp.create("bad-app-name",{appName:String(h)});if(r||(r=zz()),!r)throw fp.create("no-options");const x=tS.get(h);if(x){if(eS(r,x.options)&&eS(c,x.config))return x;throw fp.create("duplicate-app",{appName:h})}const w=new mZ(h);for(const C of qE.values())w.addComponent(C);const o=new lX(r,c,w);return tS.set(h,o),o}function IP(t=UE){const e=tS.get(t);if(!e&&t===UE&&zz())return $z();if(!e)throw fp.create("no-app",{appName:t});return e}function Vu(t,e,r){var c;let h=(c=sX[t])!==null&&c!==void 0?c:t;r&&(h+=`-${r}`);const x=h.match(/\s|\//),w=e.match(/\s|\//);if(x||w){const o=[`Unable to register library "${h}" with version "${e}":`];x&&o.push(`library name "${h}" contains illegal characters (whitespace or "/")`),x&&w&&o.push("and"),w&&o.push(`version name "${e}" contains illegal characters (whitespace or "/")`),Ud.warn(o.join(" "));return}tf(new wp(`${h}-version`,()=>({library:h,version:e}),"VERSION"))}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const cX="firebase-heartbeat-database",uX=1,bv="firebase-heartbeat-store";let NC=null;function Gz(){return NC||(NC=CZ(cX,uX,{upgrade:(t,e)=>{switch(e){case 0:try{t.createObjectStore(bv)}catch(r){console.warn(r)}}}}).catch(t=>{throw fp.create("idb-open",{originalErrorMessage:t.message})})),NC}async function dX(t){try{const r=(await Gz()).transaction(bv),c=await r.objectStore(bv).get(Hz(t));return await r.done,c}catch(e){if(e instanceof Qu)Ud.warn(e.message);else{const r=fp.create("idb-get",{originalErrorMessage:e==null?void 0:e.message});Ud.warn(r.message)}}}async function VL(t,e){try{const c=(await Gz()).transaction(bv,"readwrite");await c.objectStore(bv).put(e,Hz(t)),await c.done}catch(r){if(r instanceof Qu)Ud.warn(r.message);else{const c=fp.create("idb-set",{originalErrorMessage:r==null?void 0:r.message});Ud.warn(c.message)}}}function Hz(t){return`${t.name}!${t.options.appId}`}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const hX=1024,pX=30*24*60*60*1e3;class mX{constructor(e){this.container=e,this._heartbeatsCache=null;const r=this.container.getProvider("app").getImmediate();this._storage=new gX(r),this._heartbeatsCachePromise=this._storage.read().then(c=>(this._heartbeatsCache=c,c))}async triggerHeartbeat(){var e,r;try{const h=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),x=UL();return((e=this._heartbeatsCache)===null||e===void 0?void 0:e.heartbeats)==null&&(this._heartbeatsCache=await this._heartbeatsCachePromise,((r=this._heartbeatsCache)===null||r===void 0?void 0:r.heartbeats)==null)||this._heartbeatsCache.lastSentHeartbeatDate===x||this._heartbeatsCache.heartbeats.some(w=>w.date===x)?void 0:(this._heartbeatsCache.heartbeats.push({date:x,agent:h}),this._heartbeatsCache.heartbeats=this._heartbeatsCache.heartbeats.filter(w=>{const o=new Date(w.date).valueOf();return Date.now()-o<=pX}),this._storage.overwrite(this._heartbeatsCache))}catch(c){Ud.warn(c)}}async getHeartbeatsHeader(){var e;try{if(this._heartbeatsCache===null&&await this._heartbeatsCachePromise,((e=this._heartbeatsCache)===null||e===void 0?void 0:e.heartbeats)==null||this._heartbeatsCache.heartbeats.length===0)return"";const r=UL(),{heartbeatsToSend:c,unsentEntries:h}=fX(this._heartbeatsCache.heartbeats),x=J2(JSON.stringify({version:2,heartbeats:c}));return this._heartbeatsCache.lastSentHeartbeatDate=r,h.length>0?(this._heartbeatsCache.heartbeats=h,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),x}catch(r){return Ud.warn(r),""}}}function UL(){return new Date().toISOString().substring(0,10)}function fX(t,e=hX){const r=[];let c=t.slice();for(const h of t){const x=r.find(w=>w.agent===h.agent);if(x){if(x.dates.push(h.date),qL(r)>e){x.dates.pop();break}}else if(r.push({agent:h.agent,dates:[h.date]}),qL(r)>e){r.pop();break}c=c.slice(1)}return{heartbeatsToSend:r,unsentEntries:c}}class gX{constructor(e){this.app=e,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return iZ()?rZ().then(()=>!0).catch(()=>!1):!1}async read(){if(await this._canUseIndexedDBPromise){const r=await dX(this.app);return r!=null&&r.heartbeats?r:{heartbeats:[]}}else return{heartbeats:[]}}async overwrite(e){var r;if(await this._canUseIndexedDBPromise){const h=await this.read();return VL(this.app,{lastSentHeartbeatDate:(r=e.lastSentHeartbeatDate)!==null&&r!==void 0?r:h.lastSentHeartbeatDate,heartbeats:e.heartbeats})}else return}async add(e){var r;if(await this._canUseIndexedDBPromise){const h=await this.read();return VL(this.app,{lastSentHeartbeatDate:(r=e.lastSentHeartbeatDate)!==null&&r!==void 0?r:h.lastSentHeartbeatDate,heartbeats:[...h.heartbeats,...e.heartbeats]})}else return}}function qL(t){return J2(JSON.stringify({version:2,heartbeats:t})).length}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function yX(t){tf(new wp("platform-logger",e=>new PZ(e),"PRIVATE")),tf(new wp("heartbeat",e=>new mX(e),"PRIVATE")),Vu(VE,zL,t),Vu(VE,zL,"esm2017"),Vu("fire-js","")}yX("");function PP(t,e){var r={};for(var c in t)Object.prototype.hasOwnProperty.call(t,c)&&e.indexOf(c)<0&&(r[c]=t[c]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var h=0,c=Object.getOwnPropertySymbols(t);h<c.length;h++)e.indexOf(c[h])<0&&Object.prototype.propertyIsEnumerable.call(t,c[h])&&(r[c[h]]=t[c[h]]);return r}function Wz(){return{"dependent-sdk-initialized-before-auth":"Another Firebase SDK was initialized and is trying to use Auth before Auth is initialized. Please be sure to call `initializeAuth` or `getAuth` before starting any other Firebase SDK."}}const xX=Wz,Zz=new Uv("auth","Firebase",Wz());/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const iS=new CP("@firebase/auth");function _X(t,...e){iS.logLevel<=Sn.WARN&&iS.warn(`Auth (${ff}): ${t}`,...e)}function u2(t,...e){iS.logLevel<=Sn.ERROR&&iS.error(`Auth (${ff}): ${t}`,...e)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Xc(t,...e){throw jP(t,...e)}function Uu(t,...e){return jP(t,...e)}function Xz(t,e,r){const c=Object.assign(Object.assign({},xX()),{[e]:r});return new Uv("auth","Firebase",c).create(e,{appName:t.name})}function gp(t){return Xz(t,"operation-not-supported-in-this-environment","Operations that alter the current user are not supported in conjunction with FirebaseServerApp")}function jP(t,...e){if(typeof t!="string"){const r=e[0],c=[...e.slice(1)];return c[0]&&(c[0].appName=t.name),t._errorFactory.create(r,...c)}return Zz.create(t,...e)}function Sr(t,e,...r){if(!t)throw jP(e,...r)}function jd(t){const e="INTERNAL ASSERTION FAILED: "+t;throw u2(e),new Error(e)}function qd(t,e){t||jd(e)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function $E(){var t;return typeof self<"u"&&((t=self.location)===null||t===void 0?void 0:t.href)||""}function vX(){return $L()==="http:"||$L()==="https:"}function $L(){var t;return typeof self<"u"&&((t=self.location)===null||t===void 0?void 0:t.protocol)||null}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function bX(){return typeof navigator<"u"&&navigator&&"onLine"in navigator&&typeof navigator.onLine=="boolean"&&(vX()||QW()||"connection"in navigator)?navigator.onLine:!0}function wX(){if(typeof navigator>"u")return null;const t=navigator;return t.languages&&t.languages[0]||t.language||null}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class $v{constructor(e,r){this.shortDelay=e,this.longDelay=r,qd(r>e,"Short delay should be less than long delay!"),this.isMobile=XW()||JW()}get(){return bX()?this.isMobile?this.longDelay:this.shortDelay:Math.min(5e3,this.shortDelay)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function RP(t,e){qd(t.emulator,"Emulator should always be set here");const{url:r}=t.emulator;return e?`${r}${e.startsWith("/")?e.slice(1):e}`:r}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Yz{static initialize(e,r,c){this.fetchImpl=e,r&&(this.headersImpl=r),c&&(this.responseImpl=c)}static fetch(){if(this.fetchImpl)return this.fetchImpl;if(typeof self<"u"&&"fetch"in self)return self.fetch;if(typeof globalThis<"u"&&globalThis.fetch)return globalThis.fetch;if(typeof fetch<"u")return fetch;jd("Could not find fetch implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill")}static headers(){if(this.headersImpl)return this.headersImpl;if(typeof self<"u"&&"Headers"in self)return self.Headers;if(typeof globalThis<"u"&&globalThis.Headers)return globalThis.Headers;if(typeof Headers<"u")return Headers;jd("Could not find Headers implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill")}static response(){if(this.responseImpl)return this.responseImpl;if(typeof self<"u"&&"Response"in self)return self.Response;if(typeof globalThis<"u"&&globalThis.Response)return globalThis.Response;if(typeof Response<"u")return Response;jd("Could not find Response implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill")}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const SX={CREDENTIAL_MISMATCH:"custom-token-mismatch",MISSING_CUSTOM_TOKEN:"internal-error",INVALID_IDENTIFIER:"invalid-email",MISSING_CONTINUE_URI:"internal-error",INVALID_PASSWORD:"wrong-password",MISSING_PASSWORD:"missing-password",INVALID_LOGIN_CREDENTIALS:"invalid-credential",EMAIL_EXISTS:"email-already-in-use",PASSWORD_LOGIN_DISABLED:"operation-not-allowed",INVALID_IDP_RESPONSE:"invalid-credential",INVALID_PENDING_TOKEN:"invalid-credential",FEDERATED_USER_ID_ALREADY_LINKED:"credential-already-in-use",MISSING_REQ_TYPE:"internal-error",EMAIL_NOT_FOUND:"user-not-found",RESET_PASSWORD_EXCEED_LIMIT:"too-many-requests",EXPIRED_OOB_CODE:"expired-action-code",INVALID_OOB_CODE:"invalid-action-code",MISSING_OOB_CODE:"internal-error",CREDENTIAL_TOO_OLD_LOGIN_AGAIN:"requires-recent-login",INVALID_ID_TOKEN:"invalid-user-token",TOKEN_EXPIRED:"user-token-expired",USER_NOT_FOUND:"user-token-expired",TOO_MANY_ATTEMPTS_TRY_LATER:"too-many-requests",PASSWORD_DOES_NOT_MEET_REQUIREMENTS:"password-does-not-meet-requirements",INVALID_CODE:"invalid-verification-code",INVALID_SESSION_INFO:"invalid-verification-id",INVALID_TEMPORARY_PROOF:"invalid-credential",MISSING_SESSION_INFO:"missing-verification-id",SESSION_EXPIRED:"code-expired",MISSING_ANDROID_PACKAGE_NAME:"missing-android-pkg-name",UNAUTHORIZED_DOMAIN:"unauthorized-continue-uri",INVALID_OAUTH_CLIENT_ID:"invalid-oauth-client-id",ADMIN_ONLY_OPERATION:"admin-restricted-operation",INVALID_MFA_PENDING_CREDENTIAL:"invalid-multi-factor-session",MFA_ENROLLMENT_NOT_FOUND:"multi-factor-info-not-found",MISSING_MFA_ENROLLMENT_ID:"missing-multi-factor-info",MISSING_MFA_PENDING_CREDENTIAL:"missing-multi-factor-session",SECOND_FACTOR_EXISTS:"second-factor-already-in-use",SECOND_FACTOR_LIMIT_EXCEEDED:"maximum-second-factor-count-exceeded",BLOCKING_FUNCTION_ERROR_RESPONSE:"internal-error",RECAPTCHA_NOT_ENABLED:"recaptcha-not-enabled",MISSING_RECAPTCHA_TOKEN:"missing-recaptcha-token",INVALID_RECAPTCHA_TOKEN:"invalid-recaptcha-token",INVALID_RECAPTCHA_ACTION:"invalid-recaptcha-action",MISSING_CLIENT_TYPE:"missing-client-type",MISSING_RECAPTCHA_VERSION:"missing-recaptcha-version",INVALID_RECAPTCHA_VERSION:"invalid-recaptcha-version",INVALID_REQ_TYPE:"invalid-req-type"};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const TX=new $v(3e4,6e4);function Rp(t,e){return t.tenantId&&!e.tenantId?Object.assign(Object.assign({},e),{tenantId:t.tenantId}):e}async function Ju(t,e,r,c,h={}){return Kz(t,h,async()=>{let x={},w={};c&&(e==="GET"?w=c:x={body:JSON.stringify(c)});const o=qv(Object.assign({key:t.config.apiKey},w)).slice(1),C=await t._getAdditionalHeaders();C["Content-Type"]="application/json",t.languageCode&&(C["X-Firebase-Locale"]=t.languageCode);const R=Object.assign({method:e,headers:C},x);return KW()||(R.referrerPolicy="no-referrer"),Yz.fetch()(Qz(t,t.config.apiHost,r,o),R)})}async function Kz(t,e,r){t._canInitEmulator=!1;const c=Object.assign(Object.assign({},SX),e);try{const h=new AX(t),x=await Promise.race([r(),h.promise]);h.clearNetworkTimeout();const w=await x.json();if("needConfirmation"in w)throw Ow(t,"account-exists-with-different-credential",w);if(x.ok&&!("errorMessage"in w))return w;{const o=x.ok?w.errorMessage:w.error.message,[C,R]=o.split(" : ");if(C==="FEDERATED_USER_ID_ALREADY_LINKED")throw Ow(t,"credential-already-in-use",w);if(C==="EMAIL_EXISTS")throw Ow(t,"email-already-in-use",w);if(C==="USER_DISABLED")throw Ow(t,"user-disabled",w);const F=c[C]||C.toLowerCase().replace(/[_\s]+/g,"-");if(R)throw Xz(t,F,R);Xc(t,F)}}catch(h){if(h instanceof Qu)throw h;Xc(t,"network-request-failed",{message:String(h)})}}async function KS(t,e,r,c,h={}){const x=await Ju(t,e,r,c,h);return"mfaPendingCredential"in x&&Xc(t,"multi-factor-auth-required",{_serverResponse:x}),x}function Qz(t,e,r,c){const h=`${e}${r}?${c}`;return t.config.emulator?RP(t.config,h):`${t.config.apiScheme}://${h}`}function NX(t){switch(t){case"ENFORCE":return"ENFORCE";case"AUDIT":return"AUDIT";case"OFF":return"OFF";default:return"ENFORCEMENT_STATE_UNSPECIFIED"}}class AX{constructor(e){this.auth=e,this.timer=null,this.promise=new Promise((r,c)=>{this.timer=setTimeout(()=>c(Uu(this.auth,"network-request-failed")),TX.get())})}clearNetworkTimeout(){clearTimeout(this.timer)}}function Ow(t,e,r){const c={appName:t.name};r.email&&(c.email=r.email),r.phoneNumber&&(c.phoneNumber=r.phoneNumber);const h=Uu(t,e,c);return h.customData._tokenResponse=r,h}function GL(t){return t!==void 0&&t.enterprise!==void 0}class CX{constructor(e){if(this.siteKey="",this.recaptchaEnforcementState=[],e.recaptchaKey===void 0)throw new Error("recaptchaKey undefined");this.siteKey=e.recaptchaKey.split("/")[3],this.recaptchaEnforcementState=e.recaptchaEnforcementState}getProviderEnforcementState(e){if(!this.recaptchaEnforcementState||this.recaptchaEnforcementState.length===0)return null;for(const r of this.recaptchaEnforcementState)if(r.provider&&r.provider===e)return NX(r.enforcementState);return null}isProviderEnabled(e){return this.getProviderEnforcementState(e)==="ENFORCE"||this.getProviderEnforcementState(e)==="AUDIT"}}async function EX(t,e){return Ju(t,"GET","/v2/recaptchaConfig",Rp(t,e))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function IX(t,e){return Ju(t,"POST","/v1/accounts:delete",e)}async function Jz(t,e){return Ju(t,"POST","/v1/accounts:lookup",e)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function H0(t){if(t)try{const e=new Date(Number(t));if(!isNaN(e.getTime()))return e.toUTCString()}catch{}}async function PX(t,e=!1){const r=As(t),c=await r.getIdToken(e),h=kP(c);Sr(h&&h.exp&&h.auth_time&&h.iat,r.auth,"internal-error");const x=typeof h.firebase=="object"?h.firebase:void 0,w=x==null?void 0:x.sign_in_provider;return{claims:h,token:c,authTime:H0(AC(h.auth_time)),issuedAtTime:H0(AC(h.iat)),expirationTime:H0(AC(h.exp)),signInProvider:w||null,signInSecondFactor:(x==null?void 0:x.sign_in_second_factor)||null}}function AC(t){return Number(t)*1e3}function kP(t){const[e,r,c]=t.split(".");if(e===void 0||r===void 0||c===void 0)return u2("JWT malformed, contained fewer than 3 sections"),null;try{const h=Oz(r);return h?JSON.parse(h):(u2("Failed to decode base64 JWT payload"),null)}catch(h){return u2("Caught error parsing JWT payload as JSON",h==null?void 0:h.toString()),null}}function HL(t){const e=kP(t);return Sr(e,"internal-error"),Sr(typeof e.exp<"u","internal-error"),Sr(typeof e.iat<"u","internal-error"),Number(e.exp)-Number(e.iat)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function Py(t,e,r=!1){if(r)return e;try{return await e}catch(c){throw c instanceof Qu&&jX(c)&&t.auth.currentUser===t&&await t.auth.signOut(),c}}function jX({code:t}){return t==="auth/user-disabled"||t==="auth/user-token-expired"}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class RX{constructor(e){this.user=e,this.isRunning=!1,this.timerId=null,this.errorBackoff=3e4}_start(){this.isRunning||(this.isRunning=!0,this.schedule())}_stop(){this.isRunning&&(this.isRunning=!1,this.timerId!==null&&clearTimeout(this.timerId))}getInterval(e){var r;if(e){const c=this.errorBackoff;return this.errorBackoff=Math.min(this.errorBackoff*2,96e4),c}else{this.errorBackoff=3e4;const h=((r=this.user.stsTokenManager.expirationTime)!==null&&r!==void 0?r:0)-Date.now()-3e5;return Math.max(0,h)}}schedule(e=!1){if(!this.isRunning)return;const r=this.getInterval(e);this.timerId=setTimeout(async()=>{await this.iteration()},r)}async iteration(){try{await this.user.getIdToken(!0)}catch(e){(e==null?void 0:e.code)==="auth/network-request-failed"&&this.schedule(!0);return}this.schedule()}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class GE{constructor(e,r){this.createdAt=e,this.lastLoginAt=r,this._initializeTime()}_initializeTime(){this.lastSignInTime=H0(this.lastLoginAt),this.creationTime=H0(this.createdAt)}_copy(e){this.createdAt=e.createdAt,this.lastLoginAt=e.lastLoginAt,this._initializeTime()}toJSON(){return{createdAt:this.createdAt,lastLoginAt:this.lastLoginAt}}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function rS(t){var e;const r=t.auth,c=await t.getIdToken(),h=await Py(t,Jz(r,{idToken:c}));Sr(h==null?void 0:h.users.length,r,"internal-error");const x=h.users[0];t._notifyReloadListener(x);const w=!((e=x.providerUserInfo)===null||e===void 0)&&e.length?eB(x.providerUserInfo):[],o=DX(t.providerData,w),C=t.isAnonymous,R=!(t.email&&x.passwordHash)&&!(o!=null&&o.length),F=C?R:!1,$={uid:x.localId,displayName:x.displayName||null,photoURL:x.photoUrl||null,email:x.email||null,emailVerified:x.emailVerified||!1,phoneNumber:x.phoneNumber||null,tenantId:x.tenantId||null,providerData:o,metadata:new GE(x.createdAt,x.lastLoginAt),isAnonymous:F};Object.assign(t,$)}async function kX(t){const e=As(t);await rS(e),await e.auth._persistUserIfCurrent(e),e.auth._notifyListenersIfCurrent(e)}function DX(t,e){return[...t.filter(c=>!e.some(h=>h.providerId===c.providerId)),...e]}function eB(t){return t.map(e=>{var{providerId:r}=e,c=PP(e,["providerId"]);return{providerId:r,uid:c.rawId||"",displayName:c.displayName||null,email:c.email||null,phoneNumber:c.phoneNumber||null,photoURL:c.photoUrl||null}})}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function MX(t,e){const r=await Kz(t,{},async()=>{const c=qv({grant_type:"refresh_token",refresh_token:e}).slice(1),{tokenApiHost:h,apiKey:x}=t.config,w=Qz(t,h,"/v1/token",`key=${x}`),o=await t._getAdditionalHeaders();return o["Content-Type"]="application/x-www-form-urlencoded",Yz.fetch()(w,{method:"POST",headers:o,body:c})});return{accessToken:r.access_token,expiresIn:r.expires_in,refreshToken:r.refresh_token}}async function OX(t,e){return Ju(t,"POST","/v2/accounts:revokeToken",Rp(t,e))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class yy{constructor(){this.refreshToken=null,this.accessToken=null,this.expirationTime=null}get isExpired(){return!this.expirationTime||Date.now()>this.expirationTime-3e4}updateFromServerResponse(e){Sr(e.idToken,"internal-error"),Sr(typeof e.idToken<"u","internal-error"),Sr(typeof e.refreshToken<"u","internal-error");const r="expiresIn"in e&&typeof e.expiresIn<"u"?Number(e.expiresIn):HL(e.idToken);this.updateTokensAndExpiration(e.idToken,e.refreshToken,r)}updateFromIdToken(e){Sr(e.length!==0,"internal-error");const r=HL(e);this.updateTokensAndExpiration(e,null,r)}async getToken(e,r=!1){return!r&&this.accessToken&&!this.isExpired?this.accessToken:(Sr(this.refreshToken,e,"user-token-expired"),this.refreshToken?(await this.refresh(e,this.refreshToken),this.accessToken):null)}clearRefreshToken(){this.refreshToken=null}async refresh(e,r){const{accessToken:c,refreshToken:h,expiresIn:x}=await MX(e,r);this.updateTokensAndExpiration(c,h,Number(x))}updateTokensAndExpiration(e,r,c){this.refreshToken=r||null,this.accessToken=e||null,this.expirationTime=Date.now()+c*1e3}static fromJSON(e,r){const{refreshToken:c,accessToken:h,expirationTime:x}=r,w=new yy;return c&&(Sr(typeof c=="string","internal-error",{appName:e}),w.refreshToken=c),h&&(Sr(typeof h=="string","internal-error",{appName:e}),w.accessToken=h),x&&(Sr(typeof x=="number","internal-error",{appName:e}),w.expirationTime=x),w}toJSON(){return{refreshToken:this.refreshToken,accessToken:this.accessToken,expirationTime:this.expirationTime}}_assign(e){this.accessToken=e.accessToken,this.refreshToken=e.refreshToken,this.expirationTime=e.expirationTime}_clone(){return Object.assign(new yy,this.toJSON())}_performRefresh(){return jd("not implemented")}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Lh(t,e){Sr(typeof t=="string"||typeof t>"u","internal-error",{appName:e})}class Rd{constructor(e){var{uid:r,auth:c,stsTokenManager:h}=e,x=PP(e,["uid","auth","stsTokenManager"]);this.providerId="firebase",this.proactiveRefresh=new RX(this),this.reloadUserInfo=null,this.reloadListener=null,this.uid=r,this.auth=c,this.stsTokenManager=h,this.accessToken=h.accessToken,this.displayName=x.displayName||null,this.email=x.email||null,this.emailVerified=x.emailVerified||!1,this.phoneNumber=x.phoneNumber||null,this.photoURL=x.photoURL||null,this.isAnonymous=x.isAnonymous||!1,this.tenantId=x.tenantId||null,this.providerData=x.providerData?[...x.providerData]:[],this.metadata=new GE(x.createdAt||void 0,x.lastLoginAt||void 0)}async getIdToken(e){const r=await Py(this,this.stsTokenManager.getToken(this.auth,e));return Sr(r,this.auth,"internal-error"),this.accessToken!==r&&(this.accessToken=r,await this.auth._persistUserIfCurrent(this),this.auth._notifyListenersIfCurrent(this)),r}getIdTokenResult(e){return PX(this,e)}reload(){return kX(this)}_assign(e){this!==e&&(Sr(this.uid===e.uid,this.auth,"internal-error"),this.displayName=e.displayName,this.photoURL=e.photoURL,this.email=e.email,this.emailVerified=e.emailVerified,this.phoneNumber=e.phoneNumber,this.isAnonymous=e.isAnonymous,this.tenantId=e.tenantId,this.providerData=e.providerData.map(r=>Object.assign({},r)),this.metadata._copy(e.metadata),this.stsTokenManager._assign(e.stsTokenManager))}_clone(e){const r=new Rd(Object.assign(Object.assign({},this),{auth:e,stsTokenManager:this.stsTokenManager._clone()}));return r.metadata._copy(this.metadata),r}_onReload(e){Sr(!this.reloadListener,this.auth,"internal-error"),this.reloadListener=e,this.reloadUserInfo&&(this._notifyReloadListener(this.reloadUserInfo),this.reloadUserInfo=null)}_notifyReloadListener(e){this.reloadListener?this.reloadListener(e):this.reloadUserInfo=e}_startProactiveRefresh(){this.proactiveRefresh._start()}_stopProactiveRefresh(){this.proactiveRefresh._stop()}async _updateTokensIfNecessary(e,r=!1){let c=!1;e.idToken&&e.idToken!==this.stsTokenManager.accessToken&&(this.stsTokenManager.updateFromServerResponse(e),c=!0),r&&await rS(this),await this.auth._persistUserIfCurrent(this),c&&this.auth._notifyListenersIfCurrent(this)}async delete(){if(Pd(this.auth.app))return Promise.reject(gp(this.auth));const e=await this.getIdToken();return await Py(this,IX(this.auth,{idToken:e})),this.stsTokenManager.clearRefreshToken(),this.auth.signOut()}toJSON(){return Object.assign(Object.assign({uid:this.uid,email:this.email||void 0,emailVerified:this.emailVerified,displayName:this.displayName||void 0,isAnonymous:this.isAnonymous,photoURL:this.photoURL||void 0,phoneNumber:this.phoneNumber||void 0,tenantId:this.tenantId||void 0,providerData:this.providerData.map(e=>Object.assign({},e)),stsTokenManager:this.stsTokenManager.toJSON(),_redirectEventId:this._redirectEventId},this.metadata.toJSON()),{apiKey:this.auth.config.apiKey,appName:this.auth.name})}get refreshToken(){return this.stsTokenManager.refreshToken||""}static _fromJSON(e,r){var c,h,x,w,o,C,R,F;const $=(c=r.displayName)!==null&&c!==void 0?c:void 0,Y=(h=r.email)!==null&&h!==void 0?h:void 0,H=(x=r.phoneNumber)!==null&&x!==void 0?x:void 0,X=(w=r.photoURL)!==null&&w!==void 0?w:void 0,he=(o=r.tenantId)!==null&&o!==void 0?o:void 0,se=(C=r._redirectEventId)!==null&&C!==void 0?C:void 0,de=(R=r.createdAt)!==null&&R!==void 0?R:void 0,K=(F=r.lastLoginAt)!==null&&F!==void 0?F:void 0,{uid:ge,emailVerified:Ae,isAnonymous:Te,providerData:Ce,stsTokenManager:ne}=r;Sr(ge&&ne,e,"internal-error");const ae=yy.fromJSON(this.name,ne);Sr(typeof ge=="string",e,"internal-error"),Lh($,e.name),Lh(Y,e.name),Sr(typeof Ae=="boolean",e,"internal-error"),Sr(typeof Te=="boolean",e,"internal-error"),Lh(H,e.name),Lh(X,e.name),Lh(he,e.name),Lh(se,e.name),Lh(de,e.name),Lh(K,e.name);const q=new Rd({uid:ge,auth:e,email:Y,emailVerified:Ae,displayName:$,isAnonymous:Te,photoURL:X,phoneNumber:H,tenantId:he,stsTokenManager:ae,createdAt:de,lastLoginAt:K});return Ce&&Array.isArray(Ce)&&(q.providerData=Ce.map(oe=>Object.assign({},oe))),se&&(q._redirectEventId=se),q}static async _fromIdTokenResponse(e,r,c=!1){const h=new yy;h.updateFromServerResponse(r);const x=new Rd({uid:r.localId,auth:e,stsTokenManager:h,isAnonymous:c});return await rS(x),x}static async _fromGetAccountInfoResponse(e,r,c){const h=r.users[0];Sr(h.localId!==void 0,"internal-error");const x=h.providerUserInfo!==void 0?eB(h.providerUserInfo):[],w=!(h.email&&h.passwordHash)&&!(x!=null&&x.length),o=new yy;o.updateFromIdToken(c);const C=new Rd({uid:h.localId,auth:e,stsTokenManager:o,isAnonymous:w}),R={uid:h.localId,displayName:h.displayName||null,photoURL:h.photoUrl||null,email:h.email||null,emailVerified:h.emailVerified||!1,phoneNumber:h.phoneNumber||null,tenantId:h.tenantId||null,providerData:x,metadata:new GE(h.createdAt,h.lastLoginAt),isAnonymous:!(h.email&&h.passwordHash)&&!(x!=null&&x.length)};return Object.assign(C,R),C}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const WL=new Map;function kd(t){qd(t instanceof Function,"Expected a class definition");let e=WL.get(t);return e?(qd(e instanceof t,"Instance stored in cache mismatched with class"),e):(e=new t,WL.set(t,e),e)}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class tB{constructor(){this.type="NONE",this.storage={}}async _isAvailable(){return!0}async _set(e,r){this.storage[e]=r}async _get(e){const r=this.storage[e];return r===void 0?null:r}async _remove(e){delete this.storage[e]}_addListener(e,r){}_removeListener(e,r){}}tB.type="NONE";const ZL=tB;/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function d2(t,e,r){return`firebase:${t}:${e}:${r}`}class xy{constructor(e,r,c){this.persistence=e,this.auth=r,this.userKey=c;const{config:h,name:x}=this.auth;this.fullUserKey=d2(this.userKey,h.apiKey,x),this.fullPersistenceKey=d2("persistence",h.apiKey,x),this.boundEventHandler=r._onStorageEvent.bind(r),this.persistence._addListener(this.fullUserKey,this.boundEventHandler)}setCurrentUser(e){return this.persistence._set(this.fullUserKey,e.toJSON())}async getCurrentUser(){const e=await this.persistence._get(this.fullUserKey);return e?Rd._fromJSON(this.auth,e):null}removeCurrentUser(){return this.persistence._remove(this.fullUserKey)}savePersistenceForRedirect(){return this.persistence._set(this.fullPersistenceKey,this.persistence.type)}async setPersistence(e){if(this.persistence===e)return;const r=await this.getCurrentUser();if(await this.removeCurrentUser(),this.persistence=e,r)return this.setCurrentUser(r)}delete(){this.persistence._removeListener(this.fullUserKey,this.boundEventHandler)}static async create(e,r,c="authUser"){if(!r.length)return new xy(kd(ZL),e,c);const h=(await Promise.all(r.map(async R=>{if(await R._isAvailable())return R}))).filter(R=>R);let x=h[0]||kd(ZL);const w=d2(c,e.config.apiKey,e.name);let o=null;for(const R of r)try{const F=await R._get(w);if(F){const $=Rd._fromJSON(e,F);R!==x&&(o=$),x=R;break}}catch{}const C=h.filter(R=>R._shouldAllowMigration);return!x._shouldAllowMigration||!C.length?new xy(x,e,c):(x=C[0],o&&await x._set(w,o.toJSON()),await Promise.all(r.map(async R=>{if(R!==x)try{await R._remove(w)}catch{}})),new xy(x,e,c))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function XL(t){const e=t.toLowerCase();if(e.includes("opera/")||e.includes("opr/")||e.includes("opios/"))return"Opera";if(sB(e))return"IEMobile";if(e.includes("msie")||e.includes("trident/"))return"IE";if(e.includes("edge/"))return"Edge";if(iB(e))return"Firefox";if(e.includes("silk/"))return"Silk";if(oB(e))return"Blackberry";if(lB(e))return"Webos";if(rB(e))return"Safari";if((e.includes("chrome/")||nB(e))&&!e.includes("edge/"))return"Chrome";if(aB(e))return"Android";{const r=/([a-zA-Z\d\.]+)\/[a-zA-Z\d\.]*$/,c=t.match(r);if((c==null?void 0:c.length)===2)return c[1]}return"Other"}function iB(t=Oo()){return/firefox\//i.test(t)}function rB(t=Oo()){const e=t.toLowerCase();return e.includes("safari/")&&!e.includes("chrome/")&&!e.includes("crios/")&&!e.includes("android")}function nB(t=Oo()){return/crios\//i.test(t)}function sB(t=Oo()){return/iemobile/i.test(t)}function aB(t=Oo()){return/android/i.test(t)}function oB(t=Oo()){return/blackberry/i.test(t)}function lB(t=Oo()){return/webos/i.test(t)}function DP(t=Oo()){return/iphone|ipad|ipod/i.test(t)||/macintosh/i.test(t)&&/mobile/i.test(t)}function LX(t=Oo()){var e;return DP(t)&&!!(!((e=window.navigator)===null||e===void 0)&&e.standalone)}function FX(){return eZ()&&document.documentMode===10}function cB(t=Oo()){return DP(t)||aB(t)||lB(t)||oB(t)||/windows phone/i.test(t)||sB(t)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function uB(t,e=[]){let r;switch(t){case"Browser":r=XL(Oo());break;case"Worker":r=`${XL(Oo())}-${t}`;break;default:r=t}const c=e.length?e.join(","):"FirebaseCore-web";return`${r}/JsCore/${ff}/${c}`}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class zX{constructor(e){this.auth=e,this.queue=[]}pushCallback(e,r){const c=x=>new Promise((w,o)=>{try{const C=e(x);w(C)}catch(C){o(C)}});c.onAbort=r,this.queue.push(c);const h=this.queue.length-1;return()=>{this.queue[h]=()=>Promise.resolve()}}async runMiddleware(e){if(this.auth.currentUser===e)return;const r=[];try{for(const c of this.queue)await c(e),c.onAbort&&r.push(c.onAbort)}catch(c){r.reverse();for(const h of r)try{h()}catch{}throw this.auth._errorFactory.create("login-blocked",{originalMessage:c==null?void 0:c.message})}}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function BX(t,e={}){return Ju(t,"GET","/v2/passwordPolicy",Rp(t,e))}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const VX=6;class UX{constructor(e){var r,c,h,x;const w=e.customStrengthOptions;this.customStrengthOptions={},this.customStrengthOptions.minPasswordLength=(r=w.minPasswordLength)!==null&&r!==void 0?r:VX,w.maxPasswordLength&&(this.customStrengthOptions.maxPasswordLength=w.maxPasswordLength),w.containsLowercaseCharacter!==void 0&&(this.customStrengthOptions.containsLowercaseLetter=w.containsLowercaseCharacter),w.containsUppercaseCharacter!==void 0&&(this.customStrengthOptions.containsUppercaseLetter=w.containsUppercaseCharacter),w.containsNumericCharacter!==void 0&&(this.customStrengthOptions.containsNumericCharacter=w.containsNumericCharacter),w.containsNonAlphanumericCharacter!==void 0&&(this.customStrengthOptions.containsNonAlphanumericCharacter=w.containsNonAlphanumericCharacter),this.enforcementState=e.enforcementState,this.enforcementState==="ENFORCEMENT_STATE_UNSPECIFIED"&&(this.enforcementState="OFF"),this.allowedNonAlphanumericCharacters=(h=(c=e.allowedNonAlphanumericCharacters)===null||c===void 0?void 0:c.join(""))!==null&&h!==void 0?h:"",this.forceUpgradeOnSignin=(x=e.forceUpgradeOnSignin)!==null&&x!==void 0?x:!1,this.schemaVersion=e.schemaVersion}validatePassword(e){var r,c,h,x,w,o;const C={isValid:!0,passwordPolicy:this};return this.validatePasswordLengthOptions(e,C),this.validatePasswordCharacterOptions(e,C),C.isValid&&(C.isValid=(r=C.meetsMinPasswordLength)!==null&&r!==void 0?r:!0),C.isValid&&(C.isValid=(c=C.meetsMaxPasswordLength)!==null&&c!==void 0?c:!0),C.isValid&&(C.isValid=(h=C.containsLowercaseLetter)!==null&&h!==void 0?h:!0),C.isValid&&(C.isValid=(x=C.containsUppercaseLetter)!==null&&x!==void 0?x:!0),C.isValid&&(C.isValid=(w=C.containsNumericCharacter)!==null&&w!==void 0?w:!0),C.isValid&&(C.isValid=(o=C.containsNonAlphanumericCharacter)!==null&&o!==void 0?o:!0),C}validatePasswordLengthOptions(e,r){const c=this.customStrengthOptions.minPasswordLength,h=this.customStrengthOptions.maxPasswordLength;c&&(r.meetsMinPasswordLength=e.length>=c),h&&(r.meetsMaxPasswordLength=e.length<=h)}validatePasswordCharacterOptions(e,r){this.updatePasswordCharacterOptionsStatuses(r,!1,!1,!1,!1);let c;for(let h=0;h<e.length;h++)c=e.charAt(h),this.updatePasswordCharacterOptionsStatuses(r,c>="a"&&c<="z",c>="A"&&c<="Z",c>="0"&&c<="9",this.allowedNonAlphanumericCharacters.includes(c))}updatePasswordCharacterOptionsStatuses(e,r,c,h,x){this.customStrengthOptions.containsLowercaseLetter&&(e.containsLowercaseLetter||(e.containsLowercaseLetter=r)),this.customStrengthOptions.containsUppercaseLetter&&(e.containsUppercaseLetter||(e.containsUppercaseLetter=c)),this.customStrengthOptions.containsNumericCharacter&&(e.containsNumericCharacter||(e.containsNumericCharacter=h)),this.customStrengthOptions.containsNonAlphanumericCharacter&&(e.containsNonAlphanumericCharacter||(e.containsNonAlphanumericCharacter=x))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class qX{constructor(e,r,c,h){this.app=e,this.heartbeatServiceProvider=r,this.appCheckServiceProvider=c,this.config=h,this.currentUser=null,this.emulatorConfig=null,this.operations=Promise.resolve(),this.authStateSubscription=new YL(this),this.idTokenSubscription=new YL(this),this.beforeStateQueue=new zX(this),this.redirectUser=null,this.isProactiveRefreshEnabled=!1,this.EXPECTED_PASSWORD_POLICY_SCHEMA_VERSION=1,this._canInitEmulator=!0,this._isInitialized=!1,this._deleted=!1,this._initializationPromise=null,this._popupRedirectResolver=null,this._errorFactory=Zz,this._agentRecaptchaConfig=null,this._tenantRecaptchaConfigs={},this._projectPasswordPolicy=null,this._tenantPasswordPolicies={},this.lastNotifiedUid=void 0,this.languageCode=null,this.tenantId=null,this.settings={appVerificationDisabledForTesting:!1},this.frameworks=[],this.name=e.name,this.clientVersion=h.sdkClientVersion}_initializeWithPersistence(e,r){return r&&(this._popupRedirectResolver=kd(r)),this._initializationPromise=this.queue(async()=>{var c,h;if(!this._deleted&&(this.persistenceManager=await xy.create(this,e),!this._deleted)){if(!((c=this._popupRedirectResolver)===null||c===void 0)&&c._shouldInitProactively)try{await this._popupRedirectResolver._initialize(this)}catch{}await this.initializeCurrentUser(r),this.lastNotifiedUid=((h=this.currentUser)===null||h===void 0?void 0:h.uid)||null,!this._deleted&&(this._isInitialized=!0)}}),this._initializationPromise}async _onStorageEvent(){if(this._deleted)return;const e=await this.assertedPersistence.getCurrentUser();if(!(!this.currentUser&&!e)){if(this.currentUser&&e&&this.currentUser.uid===e.uid){this._currentUser._assign(e),await this.currentUser.getIdToken();return}await this._updateCurrentUser(e,!0)}}async initializeCurrentUserFromIdToken(e){try{const r=await Jz(this,{idToken:e}),c=await Rd._fromGetAccountInfoResponse(this,r,e);await this.directlySetCurrentUser(c)}catch(r){console.warn("FirebaseServerApp could not login user with provided authIdToken: ",r),await this.directlySetCurrentUser(null)}}async initializeCurrentUser(e){var r;if(Pd(this.app)){const w=this.app.settings.authIdToken;return w?new Promise(o=>{setTimeout(()=>this.initializeCurrentUserFromIdToken(w).then(o,o))}):this.directlySetCurrentUser(null)}const c=await this.assertedPersistence.getCurrentUser();let h=c,x=!1;if(e&&this.config.authDomain){await this.getOrInitRedirectPersistenceManager();const w=(r=this.redirectUser)===null||r===void 0?void 0:r._redirectEventId,o=h==null?void 0:h._redirectEventId,C=await this.tryRedirectSignIn(e);(!w||w===o)&&(C!=null&&C.user)&&(h=C.user,x=!0)}if(!h)return this.directlySetCurrentUser(null);if(!h._redirectEventId){if(x)try{await this.beforeStateQueue.runMiddleware(h)}catch(w){h=c,this._popupRedirectResolver._overrideRedirectResult(this,()=>Promise.reject(w))}return h?this.reloadAndSetCurrentUserOrClear(h):this.directlySetCurrentUser(null)}return Sr(this._popupRedirectResolver,this,"argument-error"),await this.getOrInitRedirectPersistenceManager(),this.redirectUser&&this.redirectUser._redirectEventId===h._redirectEventId?this.directlySetCurrentUser(h):this.reloadAndSetCurrentUserOrClear(h)}async tryRedirectSignIn(e){let r=null;try{r=await this._popupRedirectResolver._completeRedirectFn(this,e,!0)}catch{await this._setRedirectUser(null)}return r}async reloadAndSetCurrentUserOrClear(e){try{await rS(e)}catch(r){if((r==null?void 0:r.code)!=="auth/network-request-failed")return this.directlySetCurrentUser(null)}return this.directlySetCurrentUser(e)}useDeviceLanguage(){this.languageCode=wX()}async _delete(){this._deleted=!0}async updateCurrentUser(e){if(Pd(this.app))return Promise.reject(gp(this));const r=e?As(e):null;return r&&Sr(r.auth.config.apiKey===this.config.apiKey,this,"invalid-user-token"),this._updateCurrentUser(r&&r._clone(this))}async _updateCurrentUser(e,r=!1){if(!this._deleted)return e&&Sr(this.tenantId===e.tenantId,this,"tenant-id-mismatch"),r||await this.beforeStateQueue.runMiddleware(e),this.queue(async()=>{await this.directlySetCurrentUser(e),this.notifyAuthListeners()})}async signOut(){return Pd(this.app)?Promise.reject(gp(this)):(await this.beforeStateQueue.runMiddleware(null),(this.redirectPersistenceManager||this._popupRedirectResolver)&&await this._setRedirectUser(null),this._updateCurrentUser(null,!0))}setPersistence(e){return Pd(this.app)?Promise.reject(gp(this)):this.queue(async()=>{await this.assertedPersistence.setPersistence(kd(e))})}_getRecaptchaConfig(){return this.tenantId==null?this._agentRecaptchaConfig:this._tenantRecaptchaConfigs[this.tenantId]}async validatePassword(e){this._getPasswordPolicyInternal()||await this._updatePasswordPolicy();const r=this._getPasswordPolicyInternal();return r.schemaVersion!==this.EXPECTED_PASSWORD_POLICY_SCHEMA_VERSION?Promise.reject(this._errorFactory.create("unsupported-password-policy-schema-version",{})):r.validatePassword(e)}_getPasswordPolicyInternal(){return this.tenantId===null?this._projectPasswordPolicy:this._tenantPasswordPolicies[this.tenantId]}async _updatePasswordPolicy(){const e=await BX(this),r=new UX(e);this.tenantId===null?this._projectPasswordPolicy=r:this._tenantPasswordPolicies[this.tenantId]=r}_getPersistence(){return this.assertedPersistence.persistence.type}_updateErrorMap(e){this._errorFactory=new Uv("auth","Firebase",e())}onAuthStateChanged(e,r,c){return this.registerStateListener(this.authStateSubscription,e,r,c)}beforeAuthStateChanged(e,r){return this.beforeStateQueue.pushCallback(e,r)}onIdTokenChanged(e,r,c){return this.registerStateListener(this.idTokenSubscription,e,r,c)}authStateReady(){return new Promise((e,r)=>{if(this.currentUser)e();else{const c=this.onAuthStateChanged(()=>{c(),e()},r)}})}async revokeAccessToken(e){if(this.currentUser){const r=await this.currentUser.getIdToken(),c={providerId:"apple.com",tokenType:"ACCESS_TOKEN",token:e,idToken:r};this.tenantId!=null&&(c.tenantId=this.tenantId),await OX(this,c)}}toJSON(){var e;return{apiKey:this.config.apiKey,authDomain:this.config.authDomain,appName:this.name,currentUser:(e=this._currentUser)===null||e===void 0?void 0:e.toJSON()}}async _setRedirectUser(e,r){const c=await this.getOrInitRedirectPersistenceManager(r);return e===null?c.removeCurrentUser():c.setCurrentUser(e)}async getOrInitRedirectPersistenceManager(e){if(!this.redirectPersistenceManager){const r=e&&kd(e)||this._popupRedirectResolver;Sr(r,this,"argument-error"),this.redirectPersistenceManager=await xy.create(this,[kd(r._redirectPersistence)],"redirectUser"),this.redirectUser=await this.redirectPersistenceManager.getCurrentUser()}return this.redirectPersistenceManager}async _redirectUserForId(e){var r,c;return this._isInitialized&&await this.queue(async()=>{}),((r=this._currentUser)===null||r===void 0?void 0:r._redirectEventId)===e?this._currentUser:((c=this.redirectUser)===null||c===void 0?void 0:c._redirectEventId)===e?this.redirectUser:null}async _persistUserIfCurrent(e){if(e===this.currentUser)return this.queue(async()=>this.directlySetCurrentUser(e))}_notifyListenersIfCurrent(e){e===this.currentUser&&this.notifyAuthListeners()}_key(){return`${this.config.authDomain}:${this.config.apiKey}:${this.name}`}_startProactiveRefresh(){this.isProactiveRefreshEnabled=!0,this.currentUser&&this._currentUser._startProactiveRefresh()}_stopProactiveRefresh(){this.isProactiveRefreshEnabled=!1,this.currentUser&&this._currentUser._stopProactiveRefresh()}get _currentUser(){return this.currentUser}notifyAuthListeners(){var e,r;if(!this._isInitialized)return;this.idTokenSubscription.next(this.currentUser);const c=(r=(e=this.currentUser)===null||e===void 0?void 0:e.uid)!==null&&r!==void 0?r:null;this.lastNotifiedUid!==c&&(this.lastNotifiedUid=c,this.authStateSubscription.next(this.currentUser))}registerStateListener(e,r,c,h){if(this._deleted)return()=>{};const x=typeof r=="function"?r:r.next.bind(r);let w=!1;const o=this._isInitialized?Promise.resolve():this._initializationPromise;if(Sr(o,this,"internal-error"),o.then(()=>{w||x(this.currentUser)}),typeof r=="function"){const C=e.addObserver(r,c,h);return()=>{w=!0,C()}}else{const C=e.addObserver(r);return()=>{w=!0,C()}}}async directlySetCurrentUser(e){this.currentUser&&this.currentUser!==e&&this._currentUser._stopProactiveRefresh(),e&&this.isProactiveRefreshEnabled&&e._startProactiveRefresh(),this.currentUser=e,e?await this.assertedPersistence.setCurrentUser(e):await this.assertedPersistence.removeCurrentUser()}queue(e){return this.operations=this.operations.then(e,e),this.operations}get assertedPersistence(){return Sr(this.persistenceManager,this,"internal-error"),this.persistenceManager}_logFramework(e){!e||this.frameworks.includes(e)||(this.frameworks.push(e),this.frameworks.sort(),this.clientVersion=uB(this.config.clientPlatform,this._getFrameworks()))}_getFrameworks(){return this.frameworks}async _getAdditionalHeaders(){var e;const r={"X-Client-Version":this.clientVersion};this.app.options.appId&&(r["X-Firebase-gmpid"]=this.app.options.appId);const c=await((e=this.heartbeatServiceProvider.getImmediate({optional:!0}))===null||e===void 0?void 0:e.getHeartbeatsHeader());c&&(r["X-Firebase-Client"]=c);const h=await this._getAppCheckToken();return h&&(r["X-Firebase-AppCheck"]=h),r}async _getAppCheckToken(){var e;const r=await((e=this.appCheckServiceProvider.getImmediate({optional:!0}))===null||e===void 0?void 0:e.getToken());return r!=null&&r.error&&_X(`Error while retrieving App Check token: ${r.error}`),r==null?void 0:r.token}}function gf(t){return As(t)}class YL{constructor(e){this.auth=e,this.observer=null,this.addObserver=lZ(r=>this.observer=r)}get next(){return Sr(this.observer,this.auth,"internal-error"),this.observer.next.bind(this.observer)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let QS={async loadJS(){throw new Error("Unable to load external scripts")},recaptchaV2Script:"",recaptchaEnterpriseScript:"",gapiScript:""};function $X(t){QS=t}function dB(t){return QS.loadJS(t)}function GX(){return QS.recaptchaEnterpriseScript}function HX(){return QS.gapiScript}function WX(t){return`__${t}${Math.floor(Math.random()*1e6)}`}const ZX="recaptcha-enterprise",XX="NO_RECAPTCHA";class YX{constructor(e){this.type=ZX,this.auth=gf(e)}async verify(e="verify",r=!1){async function c(x){if(!r){if(x.tenantId==null&&x._agentRecaptchaConfig!=null)return x._agentRecaptchaConfig.siteKey;if(x.tenantId!=null&&x._tenantRecaptchaConfigs[x.tenantId]!==void 0)return x._tenantRecaptchaConfigs[x.tenantId].siteKey}return new Promise(async(w,o)=>{EX(x,{clientType:"CLIENT_TYPE_WEB",version:"RECAPTCHA_ENTERPRISE"}).then(C=>{if(C.recaptchaKey===void 0)o(new Error("recaptcha Enterprise site key undefined"));else{const R=new CX(C);return x.tenantId==null?x._agentRecaptchaConfig=R:x._tenantRecaptchaConfigs[x.tenantId]=R,w(R.siteKey)}}).catch(C=>{o(C)})})}function h(x,w,o){const C=window.grecaptcha;GL(C)?C.enterprise.ready(()=>{C.enterprise.execute(x,{action:e}).then(R=>{w(R)}).catch(()=>{w(XX)})}):o(Error("No reCAPTCHA enterprise script loaded."))}return new Promise((x,w)=>{c(this.auth).then(o=>{if(!r&&GL(window.grecaptcha))h(o,x,w);else{if(typeof window>"u"){w(new Error("RecaptchaVerifier is only supported in browser"));return}let C=GX();C.length!==0&&(C+=o),dB(C).then(()=>{h(o,x,w)}).catch(R=>{w(R)})}}).catch(o=>{w(o)})})}}async function KL(t,e,r,c=!1){const h=new YX(t);let x;try{x=await h.verify(r)}catch{x=await h.verify(r,!0)}const w=Object.assign({},e);return c?Object.assign(w,{captchaResp:x}):Object.assign(w,{captchaResponse:x}),Object.assign(w,{clientType:"CLIENT_TYPE_WEB"}),Object.assign(w,{recaptchaVersion:"RECAPTCHA_ENTERPRISE"}),w}async function HE(t,e,r,c){var h;if(!((h=t._getRecaptchaConfig())===null||h===void 0)&&h.isProviderEnabled("EMAIL_PASSWORD_PROVIDER")){const x=await KL(t,e,r,r==="getOobCode");return c(t,x)}else return c(t,e).catch(async x=>{if(x.code==="auth/missing-recaptcha-token"){console.log(`${r} is protected by reCAPTCHA Enterprise for this project. Automatically triggering the reCAPTCHA flow and restarting the flow.`);const w=await KL(t,e,r,r==="getOobCode");return c(t,w)}else return Promise.reject(x)})}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function KX(t,e){const r=YS(t,"auth");if(r.isInitialized()){const h=r.getImmediate(),x=r.getOptions();if(eS(x,e??{}))return h;Xc(h,"already-initialized")}return r.initialize({options:e})}function QX(t,e){const r=(e==null?void 0:e.persistence)||[],c=(Array.isArray(r)?r:[r]).map(kd);e!=null&&e.errorMap&&t._updateErrorMap(e.errorMap),t._initializeWithPersistence(c,e==null?void 0:e.popupRedirectResolver)}function JX(t,e,r){const c=gf(t);Sr(c._canInitEmulator,c,"emulator-config-failed"),Sr(/^https?:\/\//.test(e),c,"invalid-emulator-scheme");const h=!1,x=hB(e),{host:w,port:o}=eY(e),C=o===null?"":`:${o}`;c.config.emulator={url:`${x}//${w}${C}/`},c.settings.appVerificationDisabledForTesting=!0,c.emulatorConfig=Object.freeze({host:w,port:o,protocol:x.replace(":",""),options:Object.freeze({disableWarnings:h})}),tY()}function hB(t){const e=t.indexOf(":");return e<0?"":t.substr(0,e+1)}function eY(t){const e=hB(t),r=/(\/\/)?([^?#/]+)/.exec(t.substr(e.length));if(!r)return{host:"",port:null};const c=r[2].split("@").pop()||"",h=/^(\[[^\]]+\])(:|$)/.exec(c);if(h){const x=h[1];return{host:x,port:QL(c.substr(x.length+1))}}else{const[x,w]=c.split(":");return{host:x,port:QL(w)}}}function QL(t){if(!t)return null;const e=Number(t);return isNaN(e)?null:e}function tY(){function t(){const e=document.createElement("p"),r=e.style;e.innerText="Running in emulator mode. Do not use with production credentials.",r.position="fixed",r.width="100%",r.backgroundColor="#ffffff",r.border=".1em solid #000000",r.color="#b50000",r.bottom="0px",r.left="0px",r.margin="0px",r.zIndex="10000",r.textAlign="center",e.classList.add("firebase-emulator-warning"),document.body.appendChild(e)}typeof console<"u"&&typeof console.info=="function"&&console.info("WARNING: You are using the Auth Emulator, which is intended for local testing only.  Do not use with production credentials."),typeof window<"u"&&typeof document<"u"&&(document.readyState==="loading"?window.addEventListener("DOMContentLoaded",t):t())}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class MP{constructor(e,r){this.providerId=e,this.signInMethod=r}toJSON(){return jd("not implemented")}_getIdTokenResponse(e){return jd("not implemented")}_linkToIdToken(e,r){return jd("not implemented")}_getReauthenticationResolver(e){return jd("not implemented")}}async function iY(t,e){return Ju(t,"POST","/v1/accounts:update",e)}async function rY(t,e){return Ju(t,"POST","/v1/accounts:signUp",e)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function nY(t,e){return KS(t,"POST","/v1/accounts:signInWithPassword",Rp(t,e))}async function sY(t,e){return Ju(t,"POST","/v1/accounts:sendOobCode",Rp(t,e))}async function aY(t,e){return sY(t,e)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function oY(t,e){return KS(t,"POST","/v1/accounts:signInWithEmailLink",Rp(t,e))}async function lY(t,e){return KS(t,"POST","/v1/accounts:signInWithEmailLink",Rp(t,e))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class wv extends MP{constructor(e,r,c,h=null){super("password",c),this._email=e,this._password=r,this._tenantId=h}static _fromEmailAndPassword(e,r){return new wv(e,r,"password")}static _fromEmailAndCode(e,r,c=null){return new wv(e,r,"emailLink",c)}toJSON(){return{email:this._email,password:this._password,signInMethod:this.signInMethod,tenantId:this._tenantId}}static fromJSON(e){const r=typeof e=="string"?JSON.parse(e):e;if(r!=null&&r.email&&(r!=null&&r.password)){if(r.signInMethod==="password")return this._fromEmailAndPassword(r.email,r.password);if(r.signInMethod==="emailLink")return this._fromEmailAndCode(r.email,r.password,r.tenantId)}return null}async _getIdTokenResponse(e){switch(this.signInMethod){case"password":const r={returnSecureToken:!0,email:this._email,password:this._password,clientType:"CLIENT_TYPE_WEB"};return HE(e,r,"signInWithPassword",nY);case"emailLink":return oY(e,{email:this._email,oobCode:this._password});default:Xc(e,"internal-error")}}async _linkToIdToken(e,r){switch(this.signInMethod){case"password":const c={idToken:r,returnSecureToken:!0,email:this._email,password:this._password,clientType:"CLIENT_TYPE_WEB"};return HE(e,c,"signUpPassword",rY);case"emailLink":return lY(e,{idToken:r,email:this._email,oobCode:this._password});default:Xc(e,"internal-error")}}_getReauthenticationResolver(e){return this._getIdTokenResponse(e)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function _y(t,e){return KS(t,"POST","/v1/accounts:signInWithIdp",Rp(t,e))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const cY="http://localhost";class rf extends MP{constructor(){super(...arguments),this.pendingToken=null}static _fromParams(e){const r=new rf(e.providerId,e.signInMethod);return e.idToken||e.accessToken?(e.idToken&&(r.idToken=e.idToken),e.accessToken&&(r.accessToken=e.accessToken),e.nonce&&!e.pendingToken&&(r.nonce=e.nonce),e.pendingToken&&(r.pendingToken=e.pendingToken)):e.oauthToken&&e.oauthTokenSecret?(r.accessToken=e.oauthToken,r.secret=e.oauthTokenSecret):Xc("argument-error"),r}toJSON(){return{idToken:this.idToken,accessToken:this.accessToken,secret:this.secret,nonce:this.nonce,pendingToken:this.pendingToken,providerId:this.providerId,signInMethod:this.signInMethod}}static fromJSON(e){const r=typeof e=="string"?JSON.parse(e):e,{providerId:c,signInMethod:h}=r,x=PP(r,["providerId","signInMethod"]);if(!c||!h)return null;const w=new rf(c,h);return w.idToken=x.idToken||void 0,w.accessToken=x.accessToken||void 0,w.secret=x.secret,w.nonce=x.nonce,w.pendingToken=x.pendingToken||null,w}_getIdTokenResponse(e){const r=this.buildRequest();return _y(e,r)}_linkToIdToken(e,r){const c=this.buildRequest();return c.idToken=r,_y(e,c)}_getReauthenticationResolver(e){const r=this.buildRequest();return r.autoCreate=!1,_y(e,r)}buildRequest(){const e={requestUri:cY,returnSecureToken:!0};if(this.pendingToken)e.pendingToken=this.pendingToken;else{const r={};this.idToken&&(r.id_token=this.idToken),this.accessToken&&(r.access_token=this.accessToken),this.secret&&(r.oauth_token_secret=this.secret),r.providerId=this.providerId,this.nonce&&!this.pendingToken&&(r.nonce=this.nonce),e.postBody=qv(r)}return e}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function uY(t){switch(t){case"recoverEmail":return"RECOVER_EMAIL";case"resetPassword":return"PASSWORD_RESET";case"signIn":return"EMAIL_SIGNIN";case"verifyEmail":return"VERIFY_EMAIL";case"verifyAndChangeEmail":return"VERIFY_AND_CHANGE_EMAIL";case"revertSecondFactorAddition":return"REVERT_SECOND_FACTOR_ADDITION";default:return null}}function dY(t){const e=E0(I0(t)).link,r=e?E0(I0(e)).deep_link_id:null,c=E0(I0(t)).deep_link_id;return(c?E0(I0(c)).link:null)||c||r||e||t}class OP{constructor(e){var r,c,h,x,w,o;const C=E0(I0(e)),R=(r=C.apiKey)!==null&&r!==void 0?r:null,F=(c=C.oobCode)!==null&&c!==void 0?c:null,$=uY((h=C.mode)!==null&&h!==void 0?h:null);Sr(R&&F&&$,"argument-error"),this.apiKey=R,this.operation=$,this.code=F,this.continueUrl=(x=C.continueUrl)!==null&&x!==void 0?x:null,this.languageCode=(w=C.languageCode)!==null&&w!==void 0?w:null,this.tenantId=(o=C.tenantId)!==null&&o!==void 0?o:null}static parseLink(e){const r=dY(e);try{return new OP(r)}catch{return null}}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class yf{constructor(){this.providerId=yf.PROVIDER_ID}static credential(e,r){return wv._fromEmailAndPassword(e,r)}static credentialWithLink(e,r){const c=OP.parseLink(r);return Sr(c,"argument-error"),wv._fromEmailAndCode(e,c.code,c.tenantId)}}yf.PROVIDER_ID="password";yf.EMAIL_PASSWORD_SIGN_IN_METHOD="password";yf.EMAIL_LINK_SIGN_IN_METHOD="emailLink";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class pB{constructor(e){this.providerId=e,this.defaultLanguageCode=null,this.customParameters={}}setDefaultLanguage(e){this.defaultLanguageCode=e}setCustomParameters(e){return this.customParameters=e,this}getCustomParameters(){return this.customParameters}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Gv extends pB{constructor(){super(...arguments),this.scopes=[]}addScope(e){return this.scopes.includes(e)||this.scopes.push(e),this}getScopes(){return[...this.scopes]}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Wh extends Gv{constructor(){super("facebook.com")}static credential(e){return rf._fromParams({providerId:Wh.PROVIDER_ID,signInMethod:Wh.FACEBOOK_SIGN_IN_METHOD,accessToken:e})}static credentialFromResult(e){return Wh.credentialFromTaggedObject(e)}static credentialFromError(e){return Wh.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject({_tokenResponse:e}){if(!e||!("oauthAccessToken"in e)||!e.oauthAccessToken)return null;try{return Wh.credential(e.oauthAccessToken)}catch{return null}}}Wh.FACEBOOK_SIGN_IN_METHOD="facebook.com";Wh.PROVIDER_ID="facebook.com";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Zh extends Gv{constructor(){super("google.com"),this.addScope("profile")}static credential(e,r){return rf._fromParams({providerId:Zh.PROVIDER_ID,signInMethod:Zh.GOOGLE_SIGN_IN_METHOD,idToken:e,accessToken:r})}static credentialFromResult(e){return Zh.credentialFromTaggedObject(e)}static credentialFromError(e){return Zh.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject({_tokenResponse:e}){if(!e)return null;const{oauthIdToken:r,oauthAccessToken:c}=e;if(!r&&!c)return null;try{return Zh.credential(r,c)}catch{return null}}}Zh.GOOGLE_SIGN_IN_METHOD="google.com";Zh.PROVIDER_ID="google.com";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Xh extends Gv{constructor(){super("github.com")}static credential(e){return rf._fromParams({providerId:Xh.PROVIDER_ID,signInMethod:Xh.GITHUB_SIGN_IN_METHOD,accessToken:e})}static credentialFromResult(e){return Xh.credentialFromTaggedObject(e)}static credentialFromError(e){return Xh.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject({_tokenResponse:e}){if(!e||!("oauthAccessToken"in e)||!e.oauthAccessToken)return null;try{return Xh.credential(e.oauthAccessToken)}catch{return null}}}Xh.GITHUB_SIGN_IN_METHOD="github.com";Xh.PROVIDER_ID="github.com";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Yh extends Gv{constructor(){super("twitter.com")}static credential(e,r){return rf._fromParams({providerId:Yh.PROVIDER_ID,signInMethod:Yh.TWITTER_SIGN_IN_METHOD,oauthToken:e,oauthTokenSecret:r})}static credentialFromResult(e){return Yh.credentialFromTaggedObject(e)}static credentialFromError(e){return Yh.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject({_tokenResponse:e}){if(!e)return null;const{oauthAccessToken:r,oauthTokenSecret:c}=e;if(!r||!c)return null;try{return Yh.credential(r,c)}catch{return null}}}Yh.TWITTER_SIGN_IN_METHOD="twitter.com";Yh.PROVIDER_ID="twitter.com";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class jy{constructor(e){this.user=e.user,this.providerId=e.providerId,this._tokenResponse=e._tokenResponse,this.operationType=e.operationType}static async _fromIdTokenResponse(e,r,c,h=!1){const x=await Rd._fromIdTokenResponse(e,c,h),w=JL(c);return new jy({user:x,providerId:w,_tokenResponse:c,operationType:r})}static async _forOperation(e,r,c){await e._updateTokensIfNecessary(c,!0);const h=JL(c);return new jy({user:e,providerId:h,_tokenResponse:c,operationType:r})}}function JL(t){return t.providerId?t.providerId:"phoneNumber"in t?"phone":null}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class nS extends Qu{constructor(e,r,c,h){var x;super(r.code,r.message),this.operationType=c,this.user=h,Object.setPrototypeOf(this,nS.prototype),this.customData={appName:e.name,tenantId:(x=e.tenantId)!==null&&x!==void 0?x:void 0,_serverResponse:r.customData._serverResponse,operationType:c}}static _fromErrorAndOperation(e,r,c,h){return new nS(e,r,c,h)}}function mB(t,e,r,c){return(e==="reauthenticate"?r._getReauthenticationResolver(t):r._getIdTokenResponse(t)).catch(x=>{throw x.code==="auth/multi-factor-auth-required"?nS._fromErrorAndOperation(t,x,e,c):x})}async function hY(t,e,r=!1){const c=await Py(t,e._linkToIdToken(t.auth,await t.getIdToken()),r);return jy._forOperation(t,"link",c)}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function fB(t,e,r=!1){const{auth:c}=t;if(Pd(c.app))return Promise.reject(gp(c));const h="reauthenticate";try{const x=await Py(t,mB(c,h,e,t),r);Sr(x.idToken,c,"internal-error");const w=kP(x.idToken);Sr(w,c,"internal-error");const{sub:o}=w;return Sr(t.uid===o,c,"user-mismatch"),jy._forOperation(t,h,x)}catch(x){throw(x==null?void 0:x.code)==="auth/user-not-found"&&Xc(c,"user-mismatch"),x}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function gB(t,e,r=!1){if(Pd(t.app))return Promise.reject(gp(t));const c="signIn",h=await mB(t,c,e),x=await jy._fromIdTokenResponse(t,c,h);return r||await t._updateCurrentUser(x.user),x}async function pY(t,e){return gB(gf(t),e)}async function mY(t,e){return fB(As(t),e)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function fY(t,e,r){var c;Sr(((c=r.url)===null||c===void 0?void 0:c.length)>0,t,"invalid-continue-uri"),Sr(typeof r.dynamicLinkDomain>"u"||r.dynamicLinkDomain.length>0,t,"invalid-dynamic-link-domain"),e.continueUrl=r.url,e.dynamicLinkDomain=r.dynamicLinkDomain,e.canHandleCodeInApp=r.handleCodeInApp,r.iOS&&(Sr(r.iOS.bundleId.length>0,t,"missing-ios-bundle-id"),e.iOSBundleId=r.iOS.bundleId),r.android&&(Sr(r.android.packageName.length>0,t,"missing-android-pkg-name"),e.androidInstallApp=r.android.installApp,e.androidMinimumVersionCode=r.android.minimumVersion,e.androidPackageName=r.android.packageName)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function gY(t){const e=gf(t);e._getPasswordPolicyInternal()&&await e._updatePasswordPolicy()}async function yY(t,e,r){const c=gf(t),h={requestType:"PASSWORD_RESET",email:e,clientType:"CLIENT_TYPE_WEB"};r&&fY(c,h,r),await HE(c,h,"getOobCode",aY)}function xY(t,e,r){return Pd(t.app)?Promise.reject(gp(t)):pY(As(t),yf.credential(e,r)).catch(async c=>{throw c.code==="auth/password-does-not-meet-requirements"&&gY(t),c})}function _Y(t,e){return vY(As(t),null,e)}async function vY(t,e,r){const{auth:c}=t,x={idToken:await t.getIdToken(),returnSecureToken:!0};r&&(x.password=r);const w=await Py(t,iY(c,x));await t._updateTokensIfNecessary(w,!0)}function bY(t,e,r,c){return As(t).onIdTokenChanged(e,r,c)}function wY(t,e,r){return As(t).beforeAuthStateChanged(e,r)}function SY(t,e,r,c){return As(t).onAuthStateChanged(e,r,c)}function TY(t){return As(t).signOut()}const sS="__sak";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class yB{constructor(e,r){this.storageRetriever=e,this.type=r}_isAvailable(){try{return this.storage?(this.storage.setItem(sS,"1"),this.storage.removeItem(sS),Promise.resolve(!0)):Promise.resolve(!1)}catch{return Promise.resolve(!1)}}_set(e,r){return this.storage.setItem(e,JSON.stringify(r)),Promise.resolve()}_get(e){const r=this.storage.getItem(e);return Promise.resolve(r?JSON.parse(r):null)}_remove(e){return this.storage.removeItem(e),Promise.resolve()}get storage(){return this.storageRetriever()}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const NY=1e3,AY=10;class xB extends yB{constructor(){super(()=>window.localStorage,"LOCAL"),this.boundEventHandler=(e,r)=>this.onStorageEvent(e,r),this.listeners={},this.localCache={},this.pollTimer=null,this.fallbackToPolling=cB(),this._shouldAllowMigration=!0}forAllChangedKeys(e){for(const r of Object.keys(this.listeners)){const c=this.storage.getItem(r),h=this.localCache[r];c!==h&&e(r,h,c)}}onStorageEvent(e,r=!1){if(!e.key){this.forAllChangedKeys((w,o,C)=>{this.notifyListeners(w,C)});return}const c=e.key;r?this.detachListener():this.stopPolling();const h=()=>{const w=this.storage.getItem(c);!r&&this.localCache[c]===w||this.notifyListeners(c,w)},x=this.storage.getItem(c);FX()&&x!==e.newValue&&e.newValue!==e.oldValue?setTimeout(h,AY):h()}notifyListeners(e,r){this.localCache[e]=r;const c=this.listeners[e];if(c)for(const h of Array.from(c))h(r&&JSON.parse(r))}startPolling(){this.stopPolling(),this.pollTimer=setInterval(()=>{this.forAllChangedKeys((e,r,c)=>{this.onStorageEvent(new StorageEvent("storage",{key:e,oldValue:r,newValue:c}),!0)})},NY)}stopPolling(){this.pollTimer&&(clearInterval(this.pollTimer),this.pollTimer=null)}attachListener(){window.addEventListener("storage",this.boundEventHandler)}detachListener(){window.removeEventListener("storage",this.boundEventHandler)}_addListener(e,r){Object.keys(this.listeners).length===0&&(this.fallbackToPolling?this.startPolling():this.attachListener()),this.listeners[e]||(this.listeners[e]=new Set,this.localCache[e]=this.storage.getItem(e)),this.listeners[e].add(r)}_removeListener(e,r){this.listeners[e]&&(this.listeners[e].delete(r),this.listeners[e].size===0&&delete this.listeners[e]),Object.keys(this.listeners).length===0&&(this.detachListener(),this.stopPolling())}async _set(e,r){await super._set(e,r),this.localCache[e]=JSON.stringify(r)}async _get(e){const r=await super._get(e);return this.localCache[e]=JSON.stringify(r),r}async _remove(e){await super._remove(e),delete this.localCache[e]}}xB.type="LOCAL";const CY=xB;/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class _B extends yB{constructor(){super(()=>window.sessionStorage,"SESSION")}_addListener(e,r){}_removeListener(e,r){}}_B.type="SESSION";const vB=_B;/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function EY(t){return Promise.all(t.map(async e=>{try{return{fulfilled:!0,value:await e}}catch(r){return{fulfilled:!1,reason:r}}}))}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class JS{constructor(e){this.eventTarget=e,this.handlersMap={},this.boundEventHandler=this.handleEvent.bind(this)}static _getInstance(e){const r=this.receivers.find(h=>h.isListeningto(e));if(r)return r;const c=new JS(e);return this.receivers.push(c),c}isListeningto(e){return this.eventTarget===e}async handleEvent(e){const r=e,{eventId:c,eventType:h,data:x}=r.data,w=this.handlersMap[h];if(!(w!=null&&w.size))return;r.ports[0].postMessage({status:"ack",eventId:c,eventType:h});const o=Array.from(w).map(async R=>R(r.origin,x)),C=await EY(o);r.ports[0].postMessage({status:"done",eventId:c,eventType:h,response:C})}_subscribe(e,r){Object.keys(this.handlersMap).length===0&&this.eventTarget.addEventListener("message",this.boundEventHandler),this.handlersMap[e]||(this.handlersMap[e]=new Set),this.handlersMap[e].add(r)}_unsubscribe(e,r){this.handlersMap[e]&&r&&this.handlersMap[e].delete(r),(!r||this.handlersMap[e].size===0)&&delete this.handlersMap[e],Object.keys(this.handlersMap).length===0&&this.eventTarget.removeEventListener("message",this.boundEventHandler)}}JS.receivers=[];/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function LP(t="",e=10){let r="";for(let c=0;c<e;c++)r+=Math.floor(Math.random()*10);return t+r}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class IY{constructor(e){this.target=e,this.handlers=new Set}removeMessageHandler(e){e.messageChannel&&(e.messageChannel.port1.removeEventListener("message",e.onMessage),e.messageChannel.port1.close()),this.handlers.delete(e)}async _send(e,r,c=50){const h=typeof MessageChannel<"u"?new MessageChannel:null;if(!h)throw new Error("connection_unavailable");let x,w;return new Promise((o,C)=>{const R=LP("",20);h.port1.start();const F=setTimeout(()=>{C(new Error("unsupported_event"))},c);w={messageChannel:h,onMessage($){const Y=$;if(Y.data.eventId===R)switch(Y.data.status){case"ack":clearTimeout(F),x=setTimeout(()=>{C(new Error("timeout"))},3e3);break;case"done":clearTimeout(x),o(Y.data.response);break;default:clearTimeout(F),clearTimeout(x),C(new Error("invalid_response"));break}}},this.handlers.add(w),h.port1.addEventListener("message",w.onMessage),this.target.postMessage({eventType:e,eventId:R,data:r},[h.port2])}).finally(()=>{w&&this.removeMessageHandler(w)})}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function qu(){return window}function PY(t){qu().location.href=t}/**
 * @license
 * Copyright 2020 Google LLC.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function bB(){return typeof qu().WorkerGlobalScope<"u"&&typeof qu().importScripts=="function"}async function jY(){if(!(navigator!=null&&navigator.serviceWorker))return null;try{return(await navigator.serviceWorker.ready).active}catch{return null}}function RY(){var t;return((t=navigator==null?void 0:navigator.serviceWorker)===null||t===void 0?void 0:t.controller)||null}function kY(){return bB()?self:null}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const wB="firebaseLocalStorageDb",DY=1,aS="firebaseLocalStorage",SB="fbase_key";class Hv{constructor(e){this.request=e}toPromise(){return new Promise((e,r)=>{this.request.addEventListener("success",()=>{e(this.request.result)}),this.request.addEventListener("error",()=>{r(this.request.error)})})}}function eT(t,e){return t.transaction([aS],e?"readwrite":"readonly").objectStore(aS)}function MY(){const t=indexedDB.deleteDatabase(wB);return new Hv(t).toPromise()}function WE(){const t=indexedDB.open(wB,DY);return new Promise((e,r)=>{t.addEventListener("error",()=>{r(t.error)}),t.addEventListener("upgradeneeded",()=>{const c=t.result;try{c.createObjectStore(aS,{keyPath:SB})}catch(h){r(h)}}),t.addEventListener("success",async()=>{const c=t.result;c.objectStoreNames.contains(aS)?e(c):(c.close(),await MY(),e(await WE()))})})}async function e4(t,e,r){const c=eT(t,!0).put({[SB]:e,value:r});return new Hv(c).toPromise()}async function OY(t,e){const r=eT(t,!1).get(e),c=await new Hv(r).toPromise();return c===void 0?null:c.value}function t4(t,e){const r=eT(t,!0).delete(e);return new Hv(r).toPromise()}const LY=800,FY=3;class TB{constructor(){this.type="LOCAL",this._shouldAllowMigration=!0,this.listeners={},this.localCache={},this.pollTimer=null,this.pendingWrites=0,this.receiver=null,this.sender=null,this.serviceWorkerReceiverAvailable=!1,this.activeServiceWorker=null,this._workerInitializationPromise=this.initializeServiceWorkerMessaging().then(()=>{},()=>{})}async _openDb(){return this.db?this.db:(this.db=await WE(),this.db)}async _withRetries(e){let r=0;for(;;)try{const c=await this._openDb();return await e(c)}catch(c){if(r++>FY)throw c;this.db&&(this.db.close(),this.db=void 0)}}async initializeServiceWorkerMessaging(){return bB()?this.initializeReceiver():this.initializeSender()}async initializeReceiver(){this.receiver=JS._getInstance(kY()),this.receiver._subscribe("keyChanged",async(e,r)=>({keyProcessed:(await this._poll()).includes(r.key)})),this.receiver._subscribe("ping",async(e,r)=>["keyChanged"])}async initializeSender(){var e,r;if(this.activeServiceWorker=await jY(),!this.activeServiceWorker)return;this.sender=new IY(this.activeServiceWorker);const c=await this.sender._send("ping",{},800);c&&!((e=c[0])===null||e===void 0)&&e.fulfilled&&!((r=c[0])===null||r===void 0)&&r.value.includes("keyChanged")&&(this.serviceWorkerReceiverAvailable=!0)}async notifyServiceWorker(e){if(!(!this.sender||!this.activeServiceWorker||RY()!==this.activeServiceWorker))try{await this.sender._send("keyChanged",{key:e},this.serviceWorkerReceiverAvailable?800:50)}catch{}}async _isAvailable(){try{if(!indexedDB)return!1;const e=await WE();return await e4(e,sS,"1"),await t4(e,sS),!0}catch{}return!1}async _withPendingWrite(e){this.pendingWrites++;try{await e()}finally{this.pendingWrites--}}async _set(e,r){return this._withPendingWrite(async()=>(await this._withRetries(c=>e4(c,e,r)),this.localCache[e]=r,this.notifyServiceWorker(e)))}async _get(e){const r=await this._withRetries(c=>OY(c,e));return this.localCache[e]=r,r}async _remove(e){return this._withPendingWrite(async()=>(await this._withRetries(r=>t4(r,e)),delete this.localCache[e],this.notifyServiceWorker(e)))}async _poll(){const e=await this._withRetries(h=>{const x=eT(h,!1).getAll();return new Hv(x).toPromise()});if(!e)return[];if(this.pendingWrites!==0)return[];const r=[],c=new Set;if(e.length!==0)for(const{fbase_key:h,value:x}of e)c.add(h),JSON.stringify(this.localCache[h])!==JSON.stringify(x)&&(this.notifyListeners(h,x),r.push(h));for(const h of Object.keys(this.localCache))this.localCache[h]&&!c.has(h)&&(this.notifyListeners(h,null),r.push(h));return r}notifyListeners(e,r){this.localCache[e]=r;const c=this.listeners[e];if(c)for(const h of Array.from(c))h(r)}startPolling(){this.stopPolling(),this.pollTimer=setInterval(async()=>this._poll(),LY)}stopPolling(){this.pollTimer&&(clearInterval(this.pollTimer),this.pollTimer=null)}_addListener(e,r){Object.keys(this.listeners).length===0&&this.startPolling(),this.listeners[e]||(this.listeners[e]=new Set,this._get(e)),this.listeners[e].add(r)}_removeListener(e,r){this.listeners[e]&&(this.listeners[e].delete(r),this.listeners[e].size===0&&delete this.listeners[e]),Object.keys(this.listeners).length===0&&this.stopPolling()}}TB.type="LOCAL";const zY=TB;new $v(3e4,6e4);/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function BY(t,e){return e?kd(e):(Sr(t._popupRedirectResolver,t,"argument-error"),t._popupRedirectResolver)}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class FP extends MP{constructor(e){super("custom","custom"),this.params=e}_getIdTokenResponse(e){return _y(e,this._buildIdpRequest())}_linkToIdToken(e,r){return _y(e,this._buildIdpRequest(r))}_getReauthenticationResolver(e){return _y(e,this._buildIdpRequest())}_buildIdpRequest(e){const r={requestUri:this.params.requestUri,sessionId:this.params.sessionId,postBody:this.params.postBody,tenantId:this.params.tenantId,pendingToken:this.params.pendingToken,returnSecureToken:!0,returnIdpCredential:!0};return e&&(r.idToken=e),r}}function VY(t){return gB(t.auth,new FP(t),t.bypassAuthState)}function UY(t){const{auth:e,user:r}=t;return Sr(r,e,"internal-error"),fB(r,new FP(t),t.bypassAuthState)}async function qY(t){const{auth:e,user:r}=t;return Sr(r,e,"internal-error"),hY(r,new FP(t),t.bypassAuthState)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class NB{constructor(e,r,c,h,x=!1){this.auth=e,this.resolver=c,this.user=h,this.bypassAuthState=x,this.pendingPromise=null,this.eventManager=null,this.filter=Array.isArray(r)?r:[r]}execute(){return new Promise(async(e,r)=>{this.pendingPromise={resolve:e,reject:r};try{this.eventManager=await this.resolver._initialize(this.auth),await this.onExecution(),this.eventManager.registerConsumer(this)}catch(c){this.reject(c)}})}async onAuthEvent(e){const{urlResponse:r,sessionId:c,postBody:h,tenantId:x,error:w,type:o}=e;if(w){this.reject(w);return}const C={auth:this.auth,requestUri:r,sessionId:c,tenantId:x||void 0,postBody:h||void 0,user:this.user,bypassAuthState:this.bypassAuthState};try{this.resolve(await this.getIdpTask(o)(C))}catch(R){this.reject(R)}}onError(e){this.reject(e)}getIdpTask(e){switch(e){case"signInViaPopup":case"signInViaRedirect":return VY;case"linkViaPopup":case"linkViaRedirect":return qY;case"reauthViaPopup":case"reauthViaRedirect":return UY;default:Xc(this.auth,"internal-error")}}resolve(e){qd(this.pendingPromise,"Pending promise was never set"),this.pendingPromise.resolve(e),this.unregisterAndCleanUp()}reject(e){qd(this.pendingPromise,"Pending promise was never set"),this.pendingPromise.reject(e),this.unregisterAndCleanUp()}unregisterAndCleanUp(){this.eventManager&&this.eventManager.unregisterConsumer(this),this.pendingPromise=null,this.cleanUp()}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const $Y=new $v(2e3,1e4);class cy extends NB{constructor(e,r,c,h,x){super(e,r,h,x),this.provider=c,this.authWindow=null,this.pollId=null,cy.currentPopupAction&&cy.currentPopupAction.cancel(),cy.currentPopupAction=this}async executeNotNull(){const e=await this.execute();return Sr(e,this.auth,"internal-error"),e}async onExecution(){qd(this.filter.length===1,"Popup operations only handle one event");const e=LP();this.authWindow=await this.resolver._openPopup(this.auth,this.provider,this.filter[0],e),this.authWindow.associatedEvent=e,this.resolver._originValidation(this.auth).catch(r=>{this.reject(r)}),this.resolver._isIframeWebStorageSupported(this.auth,r=>{r||this.reject(Uu(this.auth,"web-storage-unsupported"))}),this.pollUserCancellation()}get eventId(){var e;return((e=this.authWindow)===null||e===void 0?void 0:e.associatedEvent)||null}cancel(){this.reject(Uu(this.auth,"cancelled-popup-request"))}cleanUp(){this.authWindow&&this.authWindow.close(),this.pollId&&window.clearTimeout(this.pollId),this.authWindow=null,this.pollId=null,cy.currentPopupAction=null}pollUserCancellation(){const e=()=>{var r,c;if(!((c=(r=this.authWindow)===null||r===void 0?void 0:r.window)===null||c===void 0)&&c.closed){this.pollId=window.setTimeout(()=>{this.pollId=null,this.reject(Uu(this.auth,"popup-closed-by-user"))},8e3);return}this.pollId=window.setTimeout(e,$Y.get())};e()}}cy.currentPopupAction=null;/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const GY="pendingRedirect",h2=new Map;class HY extends NB{constructor(e,r,c=!1){super(e,["signInViaRedirect","linkViaRedirect","reauthViaRedirect","unknown"],r,void 0,c),this.eventId=null}async execute(){let e=h2.get(this.auth._key());if(!e){try{const c=await WY(this.resolver,this.auth)?await super.execute():null;e=()=>Promise.resolve(c)}catch(r){e=()=>Promise.reject(r)}h2.set(this.auth._key(),e)}return this.bypassAuthState||h2.set(this.auth._key(),()=>Promise.resolve(null)),e()}async onAuthEvent(e){if(e.type==="signInViaRedirect")return super.onAuthEvent(e);if(e.type==="unknown"){this.resolve(null);return}if(e.eventId){const r=await this.auth._redirectUserForId(e.eventId);if(r)return this.user=r,super.onAuthEvent(e);this.resolve(null)}}async onExecution(){}cleanUp(){}}async function WY(t,e){const r=YY(e),c=XY(t);if(!await c._isAvailable())return!1;const h=await c._get(r)==="true";return await c._remove(r),h}function ZY(t,e){h2.set(t._key(),e)}function XY(t){return kd(t._redirectPersistence)}function YY(t){return d2(GY,t.config.apiKey,t.name)}async function KY(t,e,r=!1){if(Pd(t.app))return Promise.reject(gp(t));const c=gf(t),h=BY(c,e),w=await new HY(c,h,r).execute();return w&&!r&&(delete w.user._redirectEventId,await c._persistUserIfCurrent(w.user),await c._setRedirectUser(null,e)),w}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const QY=10*60*1e3;class JY{constructor(e){this.auth=e,this.cachedEventUids=new Set,this.consumers=new Set,this.queuedRedirectEvent=null,this.hasHandledPotentialRedirect=!1,this.lastProcessedEventTime=Date.now()}registerConsumer(e){this.consumers.add(e),this.queuedRedirectEvent&&this.isEventForConsumer(this.queuedRedirectEvent,e)&&(this.sendToConsumer(this.queuedRedirectEvent,e),this.saveEventToCache(this.queuedRedirectEvent),this.queuedRedirectEvent=null)}unregisterConsumer(e){this.consumers.delete(e)}onEvent(e){if(this.hasEventBeenHandled(e))return!1;let r=!1;return this.consumers.forEach(c=>{this.isEventForConsumer(e,c)&&(r=!0,this.sendToConsumer(e,c),this.saveEventToCache(e))}),this.hasHandledPotentialRedirect||!eK(e)||(this.hasHandledPotentialRedirect=!0,r||(this.queuedRedirectEvent=e,r=!0)),r}sendToConsumer(e,r){var c;if(e.error&&!AB(e)){const h=((c=e.error.code)===null||c===void 0?void 0:c.split("auth/")[1])||"internal-error";r.onError(Uu(this.auth,h))}else r.onAuthEvent(e)}isEventForConsumer(e,r){const c=r.eventId===null||!!e.eventId&&e.eventId===r.eventId;return r.filter.includes(e.type)&&c}hasEventBeenHandled(e){return Date.now()-this.lastProcessedEventTime>=QY&&this.cachedEventUids.clear(),this.cachedEventUids.has(i4(e))}saveEventToCache(e){this.cachedEventUids.add(i4(e)),this.lastProcessedEventTime=Date.now()}}function i4(t){return[t.type,t.eventId,t.sessionId,t.tenantId].filter(e=>e).join("-")}function AB({type:t,error:e}){return t==="unknown"&&(e==null?void 0:e.code)==="auth/no-auth-event"}function eK(t){switch(t.type){case"signInViaRedirect":case"linkViaRedirect":case"reauthViaRedirect":return!0;case"unknown":return AB(t);default:return!1}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function tK(t,e={}){return Ju(t,"GET","/v1/projects",e)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const iK=/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/,rK=/^https?/;async function nK(t){if(t.config.emulator)return;const{authorizedDomains:e}=await tK(t);for(const r of e)try{if(sK(r))return}catch{}Xc(t,"unauthorized-domain")}function sK(t){const e=$E(),{protocol:r,hostname:c}=new URL(e);if(t.startsWith("chrome-extension://")){const w=new URL(t);return w.hostname===""&&c===""?r==="chrome-extension:"&&t.replace("chrome-extension://","")===e.replace("chrome-extension://",""):r==="chrome-extension:"&&w.hostname===c}if(!rK.test(r))return!1;if(iK.test(t))return c===t;const h=t.replace(/\./g,"\\.");return new RegExp("^(.+\\."+h+"|"+h+")$","i").test(c)}/**
 * @license
 * Copyright 2020 Google LLC.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const aK=new $v(3e4,6e4);function r4(){const t=qu().___jsl;if(t!=null&&t.H){for(const e of Object.keys(t.H))if(t.H[e].r=t.H[e].r||[],t.H[e].L=t.H[e].L||[],t.H[e].r=[...t.H[e].L],t.CP)for(let r=0;r<t.CP.length;r++)t.CP[r]=null}}function oK(t){return new Promise((e,r)=>{var c,h,x;function w(){r4(),gapi.load("gapi.iframes",{callback:()=>{e(gapi.iframes.getContext())},ontimeout:()=>{r4(),r(Uu(t,"network-request-failed"))},timeout:aK.get()})}if(!((h=(c=qu().gapi)===null||c===void 0?void 0:c.iframes)===null||h===void 0)&&h.Iframe)e(gapi.iframes.getContext());else if(!((x=qu().gapi)===null||x===void 0)&&x.load)w();else{const o=WX("iframefcb");return qu()[o]=()=>{gapi.load?w():r(Uu(t,"network-request-failed"))},dB(`${HX()}?onload=${o}`).catch(C=>r(C))}}).catch(e=>{throw p2=null,e})}let p2=null;function lK(t){return p2=p2||oK(t),p2}/**
 * @license
 * Copyright 2020 Google LLC.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const cK=new $v(5e3,15e3),uK="__/auth/iframe",dK="emulator/auth/iframe",hK={style:{position:"absolute",top:"-100px",width:"1px",height:"1px"},"aria-hidden":"true",tabindex:"-1"},pK=new Map([["identitytoolkit.googleapis.com","p"],["staging-identitytoolkit.sandbox.googleapis.com","s"],["test-identitytoolkit.sandbox.googleapis.com","t"]]);function mK(t){const e=t.config;Sr(e.authDomain,t,"auth-domain-config-required");const r=e.emulator?RP(e,dK):`https://${t.config.authDomain}/${uK}`,c={apiKey:e.apiKey,appName:t.name,v:ff},h=pK.get(t.config.apiHost);h&&(c.eid=h);const x=t._getFrameworks();return x.length&&(c.fw=x.join(",")),`${r}?${qv(c).slice(1)}`}async function fK(t){const e=await lK(t),r=qu().gapi;return Sr(r,t,"internal-error"),e.open({where:document.body,url:mK(t),messageHandlersFilter:r.iframes.CROSS_ORIGIN_IFRAMES_FILTER,attributes:hK,dontclear:!0},c=>new Promise(async(h,x)=>{await c.restyle({setHideOnLeave:!1});const w=Uu(t,"network-request-failed"),o=qu().setTimeout(()=>{x(w)},cK.get());function C(){qu().clearTimeout(o),h(c)}c.ping(C).then(C,()=>{x(w)})}))}/**
 * @license
 * Copyright 2020 Google LLC.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const gK={location:"yes",resizable:"yes",statusbar:"yes",toolbar:"no"},yK=500,xK=600,_K="_blank",vK="http://localhost";class n4{constructor(e){this.window=e,this.associatedEvent=null}close(){if(this.window)try{this.window.close()}catch{}}}function bK(t,e,r,c=yK,h=xK){const x=Math.max((window.screen.availHeight-h)/2,0).toString(),w=Math.max((window.screen.availWidth-c)/2,0).toString();let o="";const C=Object.assign(Object.assign({},gK),{width:c.toString(),height:h.toString(),top:x,left:w}),R=Oo().toLowerCase();r&&(o=nB(R)?_K:r),iB(R)&&(e=e||vK,C.scrollbars="yes");const F=Object.entries(C).reduce((Y,[H,X])=>`${Y}${H}=${X},`,"");if(LX(R)&&o!=="_self")return wK(e||"",o),new n4(null);const $=window.open(e||"",o,F);Sr($,t,"popup-blocked");try{$.focus()}catch{}return new n4($)}function wK(t,e){const r=document.createElement("a");r.href=t,r.target=e;const c=document.createEvent("MouseEvent");c.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,1,null),r.dispatchEvent(c)}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const SK="__/auth/handler",TK="emulator/auth/handler",NK=encodeURIComponent("fac");async function s4(t,e,r,c,h,x){Sr(t.config.authDomain,t,"auth-domain-config-required"),Sr(t.config.apiKey,t,"invalid-api-key");const w={apiKey:t.config.apiKey,appName:t.name,authType:r,redirectUrl:c,v:ff,eventId:h};if(e instanceof pB){e.setDefaultLanguage(t.languageCode),w.providerId=e.providerId||"",oZ(e.getCustomParameters())||(w.customParameters=JSON.stringify(e.getCustomParameters()));for(const[F,$]of Object.entries({}))w[F]=$}if(e instanceof Gv){const F=e.getScopes().filter($=>$!=="");F.length>0&&(w.scopes=F.join(","))}t.tenantId&&(w.tid=t.tenantId);const o=w;for(const F of Object.keys(o))o[F]===void 0&&delete o[F];const C=await t._getAppCheckToken(),R=C?`#${NK}=${encodeURIComponent(C)}`:"";return`${AK(t)}?${qv(o).slice(1)}${R}`}function AK({config:t}){return t.emulator?RP(t,TK):`https://${t.authDomain}/${SK}`}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const CC="webStorageSupport";class CK{constructor(){this.eventManagers={},this.iframes={},this.originValidationPromises={},this._redirectPersistence=vB,this._completeRedirectFn=KY,this._overrideRedirectResult=ZY}async _openPopup(e,r,c,h){var x;qd((x=this.eventManagers[e._key()])===null||x===void 0?void 0:x.manager,"_initialize() not called before _openPopup()");const w=await s4(e,r,c,$E(),h);return bK(e,w,LP())}async _openRedirect(e,r,c,h){await this._originValidation(e);const x=await s4(e,r,c,$E(),h);return PY(x),new Promise(()=>{})}_initialize(e){const r=e._key();if(this.eventManagers[r]){const{manager:h,promise:x}=this.eventManagers[r];return h?Promise.resolve(h):(qd(x,"If manager is not set, promise should be"),x)}const c=this.initAndGetManager(e);return this.eventManagers[r]={promise:c},c.catch(()=>{delete this.eventManagers[r]}),c}async initAndGetManager(e){const r=await fK(e),c=new JY(e);return r.register("authEvent",h=>(Sr(h==null?void 0:h.authEvent,e,"invalid-auth-event"),{status:c.onEvent(h.authEvent)?"ACK":"ERROR"}),gapi.iframes.CROSS_ORIGIN_IFRAMES_FILTER),this.eventManagers[e._key()]={manager:c},this.iframes[e._key()]=r,c}_isIframeWebStorageSupported(e,r){this.iframes[e._key()].send(CC,{type:CC},h=>{var x;const w=(x=h==null?void 0:h[0])===null||x===void 0?void 0:x[CC];w!==void 0&&r(!!w),Xc(e,"internal-error")},gapi.iframes.CROSS_ORIGIN_IFRAMES_FILTER)}_originValidation(e){const r=e._key();return this.originValidationPromises[r]||(this.originValidationPromises[r]=nK(e)),this.originValidationPromises[r]}get _shouldInitProactively(){return cB()||rB()||DP()}}const EK=CK;var a4="@firebase/auth",o4="1.7.9";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class IK{constructor(e){this.auth=e,this.internalListeners=new Map}getUid(){var e;return this.assertAuthConfigured(),((e=this.auth.currentUser)===null||e===void 0?void 0:e.uid)||null}async getToken(e){return this.assertAuthConfigured(),await this.auth._initializationPromise,this.auth.currentUser?{accessToken:await this.auth.currentUser.getIdToken(e)}:null}addAuthTokenListener(e){if(this.assertAuthConfigured(),this.internalListeners.has(e))return;const r=this.auth.onIdTokenChanged(c=>{e((c==null?void 0:c.stsTokenManager.accessToken)||null)});this.internalListeners.set(e,r),this.updateProactiveRefresh()}removeAuthTokenListener(e){this.assertAuthConfigured();const r=this.internalListeners.get(e);r&&(this.internalListeners.delete(e),r(),this.updateProactiveRefresh())}assertAuthConfigured(){Sr(this.auth._initializationPromise,"dependent-sdk-initialized-before-auth")}updateProactiveRefresh(){this.internalListeners.size>0?this.auth._startProactiveRefresh():this.auth._stopProactiveRefresh()}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function PK(t){switch(t){case"Node":return"node";case"ReactNative":return"rn";case"Worker":return"webworker";case"Cordova":return"cordova";case"WebExtension":return"web-extension";default:return}}function jK(t){tf(new wp("auth",(e,{options:r})=>{const c=e.getProvider("app").getImmediate(),h=e.getProvider("heartbeat"),x=e.getProvider("app-check-internal"),{apiKey:w,authDomain:o}=c.options;Sr(w&&!w.includes(":"),"invalid-api-key",{appName:c.name});const C={apiKey:w,authDomain:o,clientPlatform:t,apiHost:"identitytoolkit.googleapis.com",tokenApiHost:"securetoken.googleapis.com",apiScheme:"https",sdkClientVersion:uB(t)},R=new qX(c,h,x,C);return QX(R,r),R},"PUBLIC").setInstantiationMode("EXPLICIT").setInstanceCreatedCallback((e,r,c)=>{e.getProvider("auth-internal").initialize()})),tf(new wp("auth-internal",e=>{const r=gf(e.getProvider("auth").getImmediate());return(c=>new IK(c))(r)},"PRIVATE").setInstantiationMode("EXPLICIT")),Vu(a4,o4,PK(t)),Vu(a4,o4,"esm2017")}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const RK=5*60,kK=Bz("authIdTokenMaxAge")||RK;let l4=null;const DK=t=>async e=>{const r=e&&await e.getIdTokenResult(),c=r&&(new Date().getTime()-Date.parse(r.issuedAtTime))/1e3;if(c&&c>kK)return;const h=r==null?void 0:r.token;l4!==h&&(l4=h,await fetch(t,{method:h?"POST":"DELETE",headers:h?{Authorization:`Bearer ${h}`}:{}}))};function MK(t=IP()){const e=YS(t,"auth");if(e.isInitialized())return e.getImmediate();const r=KX(t,{popupRedirectResolver:EK,persistence:[zY,CY,vB]}),c=Bz("authTokenSyncURL");if(c&&typeof isSecureContext=="boolean"&&isSecureContext){const x=new URL(c,location.origin);if(location.origin===x.origin){const w=DK(x.toString());wY(r,w,()=>w(r.currentUser)),bY(r,o=>w(o))}}const h=Lz("auth");return h&&JX(r,`http://${h}`),r}function OK(){var t,e;return(e=(t=document.getElementsByTagName("head"))===null||t===void 0?void 0:t[0])!==null&&e!==void 0?e:document}$X({loadJS(t){return new Promise((e,r)=>{const c=document.createElement("script");c.setAttribute("src",t),c.onload=e,c.onerror=h=>{const x=Uu("internal-error");x.customData=h,r(x)},c.type="text/javascript",c.charset="UTF-8",OK().appendChild(c)})},gapiScript:"https://apis.google.com/js/api.js",recaptchaV2Script:"https://www.google.com/recaptcha/api.js",recaptchaEnterpriseScript:"https://www.google.com/recaptcha/enterprise.js?render="});jK("Browser");var c4=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};/** @license
Copyright The Closure Library Authors.
SPDX-License-Identifier: Apache-2.0
*/var Hm,CB;(function(){var t;/** @license

 Copyright The Closure Library Authors.
 SPDX-License-Identifier: Apache-2.0
*/function e(ne,ae){function q(){}q.prototype=ae.prototype,ne.D=ae.prototype,ne.prototype=new q,ne.prototype.constructor=ne,ne.C=function(oe,ke,Ve){for(var ie=Array(arguments.length-2),ze=2;ze<arguments.length;ze++)ie[ze-2]=arguments[ze];return ae.prototype[ke].apply(oe,ie)}}function r(){this.blockSize=-1}function c(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}e(c,r),c.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0};function h(ne,ae,q){q||(q=0);var oe=Array(16);if(typeof ae=="string")for(var ke=0;16>ke;++ke)oe[ke]=ae.charCodeAt(q++)|ae.charCodeAt(q++)<<8|ae.charCodeAt(q++)<<16|ae.charCodeAt(q++)<<24;else for(ke=0;16>ke;++ke)oe[ke]=ae[q++]|ae[q++]<<8|ae[q++]<<16|ae[q++]<<24;ae=ne.g[0],q=ne.g[1],ke=ne.g[2];var Ve=ne.g[3],ie=ae+(Ve^q&(ke^Ve))+oe[0]+3614090360&4294967295;ae=q+(ie<<7&4294967295|ie>>>25),ie=Ve+(ke^ae&(q^ke))+oe[1]+3905402710&4294967295,Ve=ae+(ie<<12&4294967295|ie>>>20),ie=ke+(q^Ve&(ae^q))+oe[2]+606105819&4294967295,ke=Ve+(ie<<17&4294967295|ie>>>15),ie=q+(ae^ke&(Ve^ae))+oe[3]+3250441966&4294967295,q=ke+(ie<<22&4294967295|ie>>>10),ie=ae+(Ve^q&(ke^Ve))+oe[4]+4118548399&4294967295,ae=q+(ie<<7&4294967295|ie>>>25),ie=Ve+(ke^ae&(q^ke))+oe[5]+1200080426&4294967295,Ve=ae+(ie<<12&4294967295|ie>>>20),ie=ke+(q^Ve&(ae^q))+oe[6]+2821735955&4294967295,ke=Ve+(ie<<17&4294967295|ie>>>15),ie=q+(ae^ke&(Ve^ae))+oe[7]+4249261313&4294967295,q=ke+(ie<<22&4294967295|ie>>>10),ie=ae+(Ve^q&(ke^Ve))+oe[8]+1770035416&4294967295,ae=q+(ie<<7&4294967295|ie>>>25),ie=Ve+(ke^ae&(q^ke))+oe[9]+2336552879&4294967295,Ve=ae+(ie<<12&4294967295|ie>>>20),ie=ke+(q^Ve&(ae^q))+oe[10]+4294925233&4294967295,ke=Ve+(ie<<17&4294967295|ie>>>15),ie=q+(ae^ke&(Ve^ae))+oe[11]+2304563134&4294967295,q=ke+(ie<<22&4294967295|ie>>>10),ie=ae+(Ve^q&(ke^Ve))+oe[12]+1804603682&4294967295,ae=q+(ie<<7&4294967295|ie>>>25),ie=Ve+(ke^ae&(q^ke))+oe[13]+4254626195&4294967295,Ve=ae+(ie<<12&4294967295|ie>>>20),ie=ke+(q^Ve&(ae^q))+oe[14]+2792965006&4294967295,ke=Ve+(ie<<17&4294967295|ie>>>15),ie=q+(ae^ke&(Ve^ae))+oe[15]+1236535329&4294967295,q=ke+(ie<<22&4294967295|ie>>>10),ie=ae+(ke^Ve&(q^ke))+oe[1]+4129170786&4294967295,ae=q+(ie<<5&4294967295|ie>>>27),ie=Ve+(q^ke&(ae^q))+oe[6]+3225465664&4294967295,Ve=ae+(ie<<9&4294967295|ie>>>23),ie=ke+(ae^q&(Ve^ae))+oe[11]+643717713&4294967295,ke=Ve+(ie<<14&4294967295|ie>>>18),ie=q+(Ve^ae&(ke^Ve))+oe[0]+3921069994&4294967295,q=ke+(ie<<20&4294967295|ie>>>12),ie=ae+(ke^Ve&(q^ke))+oe[5]+3593408605&4294967295,ae=q+(ie<<5&4294967295|ie>>>27),ie=Ve+(q^ke&(ae^q))+oe[10]+38016083&4294967295,Ve=ae+(ie<<9&4294967295|ie>>>23),ie=ke+(ae^q&(Ve^ae))+oe[15]+3634488961&4294967295,ke=Ve+(ie<<14&4294967295|ie>>>18),ie=q+(Ve^ae&(ke^Ve))+oe[4]+3889429448&4294967295,q=ke+(ie<<20&4294967295|ie>>>12),ie=ae+(ke^Ve&(q^ke))+oe[9]+568446438&4294967295,ae=q+(ie<<5&4294967295|ie>>>27),ie=Ve+(q^ke&(ae^q))+oe[14]+3275163606&4294967295,Ve=ae+(ie<<9&4294967295|ie>>>23),ie=ke+(ae^q&(Ve^ae))+oe[3]+4107603335&4294967295,ke=Ve+(ie<<14&4294967295|ie>>>18),ie=q+(Ve^ae&(ke^Ve))+oe[8]+1163531501&4294967295,q=ke+(ie<<20&4294967295|ie>>>12),ie=ae+(ke^Ve&(q^ke))+oe[13]+2850285829&4294967295,ae=q+(ie<<5&4294967295|ie>>>27),ie=Ve+(q^ke&(ae^q))+oe[2]+4243563512&4294967295,Ve=ae+(ie<<9&4294967295|ie>>>23),ie=ke+(ae^q&(Ve^ae))+oe[7]+1735328473&4294967295,ke=Ve+(ie<<14&4294967295|ie>>>18),ie=q+(Ve^ae&(ke^Ve))+oe[12]+2368359562&4294967295,q=ke+(ie<<20&4294967295|ie>>>12),ie=ae+(q^ke^Ve)+oe[5]+4294588738&4294967295,ae=q+(ie<<4&4294967295|ie>>>28),ie=Ve+(ae^q^ke)+oe[8]+2272392833&4294967295,Ve=ae+(ie<<11&4294967295|ie>>>21),ie=ke+(Ve^ae^q)+oe[11]+1839030562&4294967295,ke=Ve+(ie<<16&4294967295|ie>>>16),ie=q+(ke^Ve^ae)+oe[14]+4259657740&4294967295,q=ke+(ie<<23&4294967295|ie>>>9),ie=ae+(q^ke^Ve)+oe[1]+2763975236&4294967295,ae=q+(ie<<4&4294967295|ie>>>28),ie=Ve+(ae^q^ke)+oe[4]+1272893353&4294967295,Ve=ae+(ie<<11&4294967295|ie>>>21),ie=ke+(Ve^ae^q)+oe[7]+4139469664&4294967295,ke=Ve+(ie<<16&4294967295|ie>>>16),ie=q+(ke^Ve^ae)+oe[10]+3200236656&4294967295,q=ke+(ie<<23&4294967295|ie>>>9),ie=ae+(q^ke^Ve)+oe[13]+681279174&4294967295,ae=q+(ie<<4&4294967295|ie>>>28),ie=Ve+(ae^q^ke)+oe[0]+3936430074&4294967295,Ve=ae+(ie<<11&4294967295|ie>>>21),ie=ke+(Ve^ae^q)+oe[3]+3572445317&4294967295,ke=Ve+(ie<<16&4294967295|ie>>>16),ie=q+(ke^Ve^ae)+oe[6]+76029189&4294967295,q=ke+(ie<<23&4294967295|ie>>>9),ie=ae+(q^ke^Ve)+oe[9]+3654602809&4294967295,ae=q+(ie<<4&4294967295|ie>>>28),ie=Ve+(ae^q^ke)+oe[12]+3873151461&4294967295,Ve=ae+(ie<<11&4294967295|ie>>>21),ie=ke+(Ve^ae^q)+oe[15]+530742520&4294967295,ke=Ve+(ie<<16&4294967295|ie>>>16),ie=q+(ke^Ve^ae)+oe[2]+3299628645&4294967295,q=ke+(ie<<23&4294967295|ie>>>9),ie=ae+(ke^(q|~Ve))+oe[0]+4096336452&4294967295,ae=q+(ie<<6&4294967295|ie>>>26),ie=Ve+(q^(ae|~ke))+oe[7]+1126891415&4294967295,Ve=ae+(ie<<10&4294967295|ie>>>22),ie=ke+(ae^(Ve|~q))+oe[14]+2878612391&4294967295,ke=Ve+(ie<<15&4294967295|ie>>>17),ie=q+(Ve^(ke|~ae))+oe[5]+4237533241&4294967295,q=ke+(ie<<21&4294967295|ie>>>11),ie=ae+(ke^(q|~Ve))+oe[12]+1700485571&4294967295,ae=q+(ie<<6&4294967295|ie>>>26),ie=Ve+(q^(ae|~ke))+oe[3]+2399980690&4294967295,Ve=ae+(ie<<10&4294967295|ie>>>22),ie=ke+(ae^(Ve|~q))+oe[10]+4293915773&4294967295,ke=Ve+(ie<<15&4294967295|ie>>>17),ie=q+(Ve^(ke|~ae))+oe[1]+2240044497&4294967295,q=ke+(ie<<21&4294967295|ie>>>11),ie=ae+(ke^(q|~Ve))+oe[8]+1873313359&4294967295,ae=q+(ie<<6&4294967295|ie>>>26),ie=Ve+(q^(ae|~ke))+oe[15]+4264355552&4294967295,Ve=ae+(ie<<10&4294967295|ie>>>22),ie=ke+(ae^(Ve|~q))+oe[6]+2734768916&4294967295,ke=Ve+(ie<<15&4294967295|ie>>>17),ie=q+(Ve^(ke|~ae))+oe[13]+1309151649&4294967295,q=ke+(ie<<21&4294967295|ie>>>11),ie=ae+(ke^(q|~Ve))+oe[4]+4149444226&4294967295,ae=q+(ie<<6&4294967295|ie>>>26),ie=Ve+(q^(ae|~ke))+oe[11]+3174756917&4294967295,Ve=ae+(ie<<10&4294967295|ie>>>22),ie=ke+(ae^(Ve|~q))+oe[2]+718787259&4294967295,ke=Ve+(ie<<15&4294967295|ie>>>17),ie=q+(Ve^(ke|~ae))+oe[9]+3951481745&4294967295,ne.g[0]=ne.g[0]+ae&4294967295,ne.g[1]=ne.g[1]+(ke+(ie<<21&4294967295|ie>>>11))&4294967295,ne.g[2]=ne.g[2]+ke&4294967295,ne.g[3]=ne.g[3]+Ve&4294967295}c.prototype.u=function(ne,ae){ae===void 0&&(ae=ne.length);for(var q=ae-this.blockSize,oe=this.B,ke=this.h,Ve=0;Ve<ae;){if(ke==0)for(;Ve<=q;)h(this,ne,Ve),Ve+=this.blockSize;if(typeof ne=="string"){for(;Ve<ae;)if(oe[ke++]=ne.charCodeAt(Ve++),ke==this.blockSize){h(this,oe),ke=0;break}}else for(;Ve<ae;)if(oe[ke++]=ne[Ve++],ke==this.blockSize){h(this,oe),ke=0;break}}this.h=ke,this.o+=ae},c.prototype.v=function(){var ne=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);ne[0]=128;for(var ae=1;ae<ne.length-8;++ae)ne[ae]=0;var q=8*this.o;for(ae=ne.length-8;ae<ne.length;++ae)ne[ae]=q&255,q/=256;for(this.u(ne),ne=Array(16),ae=q=0;4>ae;++ae)for(var oe=0;32>oe;oe+=8)ne[q++]=this.g[ae]>>>oe&255;return ne};function x(ne,ae){var q=o;return Object.prototype.hasOwnProperty.call(q,ne)?q[ne]:q[ne]=ae(ne)}function w(ne,ae){this.h=ae;for(var q=[],oe=!0,ke=ne.length-1;0<=ke;ke--){var Ve=ne[ke]|0;oe&&Ve==ae||(q[ke]=Ve,oe=!1)}this.g=q}var o={};function C(ne){return-128<=ne&&128>ne?x(ne,function(ae){return new w([ae|0],0>ae?-1:0)}):new w([ne|0],0>ne?-1:0)}function R(ne){if(isNaN(ne)||!isFinite(ne))return $;if(0>ne)return se(R(-ne));for(var ae=[],q=1,oe=0;ne>=q;oe++)ae[oe]=ne/q|0,q*=4294967296;return new w(ae,0)}function F(ne,ae){if(ne.length==0)throw Error("number format error: empty string");if(ae=ae||10,2>ae||36<ae)throw Error("radix out of range: "+ae);if(ne.charAt(0)=="-")return se(F(ne.substring(1),ae));if(0<=ne.indexOf("-"))throw Error('number format error: interior "-" character');for(var q=R(Math.pow(ae,8)),oe=$,ke=0;ke<ne.length;ke+=8){var Ve=Math.min(8,ne.length-ke),ie=parseInt(ne.substring(ke,ke+Ve),ae);8>Ve?(Ve=R(Math.pow(ae,Ve)),oe=oe.j(Ve).add(R(ie))):(oe=oe.j(q),oe=oe.add(R(ie)))}return oe}var $=C(0),Y=C(1),H=C(16777216);t=w.prototype,t.m=function(){if(he(this))return-se(this).m();for(var ne=0,ae=1,q=0;q<this.g.length;q++){var oe=this.i(q);ne+=(0<=oe?oe:4294967296+oe)*ae,ae*=4294967296}return ne},t.toString=function(ne){if(ne=ne||10,2>ne||36<ne)throw Error("radix out of range: "+ne);if(X(this))return"0";if(he(this))return"-"+se(this).toString(ne);for(var ae=R(Math.pow(ne,6)),q=this,oe="";;){var ke=Ae(q,ae).g;q=de(q,ke.j(ae));var Ve=((0<q.g.length?q.g[0]:q.h)>>>0).toString(ne);if(q=ke,X(q))return Ve+oe;for(;6>Ve.length;)Ve="0"+Ve;oe=Ve+oe}},t.i=function(ne){return 0>ne?0:ne<this.g.length?this.g[ne]:this.h};function X(ne){if(ne.h!=0)return!1;for(var ae=0;ae<ne.g.length;ae++)if(ne.g[ae]!=0)return!1;return!0}function he(ne){return ne.h==-1}t.l=function(ne){return ne=de(this,ne),he(ne)?-1:X(ne)?0:1};function se(ne){for(var ae=ne.g.length,q=[],oe=0;oe<ae;oe++)q[oe]=~ne.g[oe];return new w(q,~ne.h).add(Y)}t.abs=function(){return he(this)?se(this):this},t.add=function(ne){for(var ae=Math.max(this.g.length,ne.g.length),q=[],oe=0,ke=0;ke<=ae;ke++){var Ve=oe+(this.i(ke)&65535)+(ne.i(ke)&65535),ie=(Ve>>>16)+(this.i(ke)>>>16)+(ne.i(ke)>>>16);oe=ie>>>16,Ve&=65535,ie&=65535,q[ke]=ie<<16|Ve}return new w(q,q[q.length-1]&-2147483648?-1:0)};function de(ne,ae){return ne.add(se(ae))}t.j=function(ne){if(X(this)||X(ne))return $;if(he(this))return he(ne)?se(this).j(se(ne)):se(se(this).j(ne));if(he(ne))return se(this.j(se(ne)));if(0>this.l(H)&&0>ne.l(H))return R(this.m()*ne.m());for(var ae=this.g.length+ne.g.length,q=[],oe=0;oe<2*ae;oe++)q[oe]=0;for(oe=0;oe<this.g.length;oe++)for(var ke=0;ke<ne.g.length;ke++){var Ve=this.i(oe)>>>16,ie=this.i(oe)&65535,ze=ne.i(ke)>>>16,ve=ne.i(ke)&65535;q[2*oe+2*ke]+=ie*ve,K(q,2*oe+2*ke),q[2*oe+2*ke+1]+=Ve*ve,K(q,2*oe+2*ke+1),q[2*oe+2*ke+1]+=ie*ze,K(q,2*oe+2*ke+1),q[2*oe+2*ke+2]+=Ve*ze,K(q,2*oe+2*ke+2)}for(oe=0;oe<ae;oe++)q[oe]=q[2*oe+1]<<16|q[2*oe];for(oe=ae;oe<2*ae;oe++)q[oe]=0;return new w(q,0)};function K(ne,ae){for(;(ne[ae]&65535)!=ne[ae];)ne[ae+1]+=ne[ae]>>>16,ne[ae]&=65535,ae++}function ge(ne,ae){this.g=ne,this.h=ae}function Ae(ne,ae){if(X(ae))throw Error("division by zero");if(X(ne))return new ge($,$);if(he(ne))return ae=Ae(se(ne),ae),new ge(se(ae.g),se(ae.h));if(he(ae))return ae=Ae(ne,se(ae)),new ge(se(ae.g),ae.h);if(30<ne.g.length){if(he(ne)||he(ae))throw Error("slowDivide_ only works with positive integers.");for(var q=Y,oe=ae;0>=oe.l(ne);)q=Te(q),oe=Te(oe);var ke=Ce(q,1),Ve=Ce(oe,1);for(oe=Ce(oe,2),q=Ce(q,2);!X(oe);){var ie=Ve.add(oe);0>=ie.l(ne)&&(ke=ke.add(q),Ve=ie),oe=Ce(oe,1),q=Ce(q,1)}return ae=de(ne,ke.j(ae)),new ge(ke,ae)}for(ke=$;0<=ne.l(ae);){for(q=Math.max(1,Math.floor(ne.m()/ae.m())),oe=Math.ceil(Math.log(q)/Math.LN2),oe=48>=oe?1:Math.pow(2,oe-48),Ve=R(q),ie=Ve.j(ae);he(ie)||0<ie.l(ne);)q-=oe,Ve=R(q),ie=Ve.j(ae);X(Ve)&&(Ve=Y),ke=ke.add(Ve),ne=de(ne,ie)}return new ge(ke,ne)}t.A=function(ne){return Ae(this,ne).h},t.and=function(ne){for(var ae=Math.max(this.g.length,ne.g.length),q=[],oe=0;oe<ae;oe++)q[oe]=this.i(oe)&ne.i(oe);return new w(q,this.h&ne.h)},t.or=function(ne){for(var ae=Math.max(this.g.length,ne.g.length),q=[],oe=0;oe<ae;oe++)q[oe]=this.i(oe)|ne.i(oe);return new w(q,this.h|ne.h)},t.xor=function(ne){for(var ae=Math.max(this.g.length,ne.g.length),q=[],oe=0;oe<ae;oe++)q[oe]=this.i(oe)^ne.i(oe);return new w(q,this.h^ne.h)};function Te(ne){for(var ae=ne.g.length+1,q=[],oe=0;oe<ae;oe++)q[oe]=ne.i(oe)<<1|ne.i(oe-1)>>>31;return new w(q,ne.h)}function Ce(ne,ae){var q=ae>>5;ae%=32;for(var oe=ne.g.length-q,ke=[],Ve=0;Ve<oe;Ve++)ke[Ve]=0<ae?ne.i(Ve+q)>>>ae|ne.i(Ve+q+1)<<32-ae:ne.i(Ve+q);return new w(ke,ne.h)}c.prototype.digest=c.prototype.v,c.prototype.reset=c.prototype.s,c.prototype.update=c.prototype.u,CB=c,w.prototype.add=w.prototype.add,w.prototype.multiply=w.prototype.j,w.prototype.modulo=w.prototype.A,w.prototype.compare=w.prototype.l,w.prototype.toNumber=w.prototype.m,w.prototype.toString=w.prototype.toString,w.prototype.getBits=w.prototype.i,w.fromNumber=R,w.fromString=F,Hm=w}).apply(typeof c4<"u"?c4:typeof self<"u"?self:typeof window<"u"?window:{});var Lw=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};/** @license
Copyright The Closure Library Authors.
SPDX-License-Identifier: Apache-2.0
*/var EB,P0,IB,m2,ZE,PB,jB,RB;(function(){var t,e=typeof Object.defineProperties=="function"?Object.defineProperty:function(k,re,ye){return k==Array.prototype||k==Object.prototype||(k[re]=ye.value),k};function r(k){k=[typeof globalThis=="object"&&globalThis,k,typeof window=="object"&&window,typeof self=="object"&&self,typeof Lw=="object"&&Lw];for(var re=0;re<k.length;++re){var ye=k[re];if(ye&&ye.Math==Math)return ye}throw Error("Cannot find global object")}var c=r(this);function h(k,re){if(re)e:{var ye=c;k=k.split(".");for(var We=0;We<k.length-1;We++){var Pt=k[We];if(!(Pt in ye))break e;ye=ye[Pt]}k=k[k.length-1],We=ye[k],re=re(We),re!=We&&re!=null&&e(ye,k,{configurable:!0,writable:!0,value:re})}}function x(k,re){k instanceof String&&(k+="");var ye=0,We=!1,Pt={next:function(){if(!We&&ye<k.length){var qt=ye++;return{value:re(qt,k[qt]),done:!1}}return We=!0,{done:!0,value:void 0}}};return Pt[Symbol.iterator]=function(){return Pt},Pt}h("Array.prototype.values",function(k){return k||function(){return x(this,function(re,ye){return ye})}});/** @license

 Copyright The Closure Library Authors.
 SPDX-License-Identifier: Apache-2.0
*/var w=w||{},o=this||self;function C(k){var re=typeof k;return re=re!="object"?re:k?Array.isArray(k)?"array":re:"null",re=="array"||re=="object"&&typeof k.length=="number"}function R(k){var re=typeof k;return re=="object"&&k!=null||re=="function"}function F(k,re,ye){return k.call.apply(k.bind,arguments)}function $(k,re,ye){if(!k)throw Error();if(2<arguments.length){var We=Array.prototype.slice.call(arguments,2);return function(){var Pt=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(Pt,We),k.apply(re,Pt)}}return function(){return k.apply(re,arguments)}}function Y(k,re,ye){return Y=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?F:$,Y.apply(null,arguments)}function H(k,re){var ye=Array.prototype.slice.call(arguments,1);return function(){var We=ye.slice();return We.push.apply(We,arguments),k.apply(this,We)}}function X(k,re){function ye(){}ye.prototype=re.prototype,k.aa=re.prototype,k.prototype=new ye,k.prototype.constructor=k,k.Qb=function(We,Pt,qt){for(var Ti=Array(arguments.length-2),An=2;An<arguments.length;An++)Ti[An-2]=arguments[An];return re.prototype[Pt].apply(We,Ti)}}function he(k){const re=k.length;if(0<re){const ye=Array(re);for(let We=0;We<re;We++)ye[We]=k[We];return ye}return[]}function se(k,re){for(let ye=1;ye<arguments.length;ye++){const We=arguments[ye];if(C(We)){const Pt=k.length||0,qt=We.length||0;k.length=Pt+qt;for(let Ti=0;Ti<qt;Ti++)k[Pt+Ti]=We[Ti]}else k.push(We)}}class de{constructor(re,ye){this.i=re,this.j=ye,this.h=0,this.g=null}get(){let re;return 0<this.h?(this.h--,re=this.g,this.g=re.next,re.next=null):re=this.i(),re}}function K(k){return/^[\s\xa0]*$/.test(k)}function ge(){var k=o.navigator;return k&&(k=k.userAgent)?k:""}function Ae(k){return Ae[" "](k),k}Ae[" "]=function(){};var Te=ge().indexOf("Gecko")!=-1&&!(ge().toLowerCase().indexOf("webkit")!=-1&&ge().indexOf("Edge")==-1)&&!(ge().indexOf("Trident")!=-1||ge().indexOf("MSIE")!=-1)&&ge().indexOf("Edge")==-1;function Ce(k,re,ye){for(const We in k)re.call(ye,k[We],We,k)}function ne(k,re){for(const ye in k)re.call(void 0,k[ye],ye,k)}function ae(k){const re={};for(const ye in k)re[ye]=k[ye];return re}const q="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function oe(k,re){let ye,We;for(let Pt=1;Pt<arguments.length;Pt++){We=arguments[Pt];for(ye in We)k[ye]=We[ye];for(let qt=0;qt<q.length;qt++)ye=q[qt],Object.prototype.hasOwnProperty.call(We,ye)&&(k[ye]=We[ye])}}function ke(k){var re=1;k=k.split(":");const ye=[];for(;0<re&&k.length;)ye.push(k.shift()),re--;return k.length&&ye.push(k.join(":")),ye}function Ve(k){o.setTimeout(()=>{throw k},0)}function ie(){var k=It;let re=null;return k.g&&(re=k.g,k.g=k.g.next,k.g||(k.h=null),re.next=null),re}class ze{constructor(){this.h=this.g=null}add(re,ye){const We=ve.get();We.set(re,ye),this.h?this.h.next=We:this.g=We,this.h=We}}var ve=new de(()=>new Le,k=>k.reset());class Le{constructor(){this.next=this.g=this.h=null}set(re,ye){this.h=re,this.g=ye,this.next=null}reset(){this.next=this.g=this.h=null}}let Ke,Pe=!1,It=new ze,tt=()=>{const k=o.Promise.resolve(void 0);Ke=()=>{k.then(zt)}};var zt=()=>{for(var k;k=ie();){try{k.h.call(k.g)}catch(ye){Ve(ye)}var re=ve;re.j(k),100>re.h&&(re.h++,k.next=re.g,re.g=k)}Pe=!1};function vt(){this.s=this.s,this.C=this.C}vt.prototype.s=!1,vt.prototype.ma=function(){this.s||(this.s=!0,this.N())},vt.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()};function Ot(k,re){this.type=k,this.g=this.target=re,this.defaultPrevented=!1}Ot.prototype.h=function(){this.defaultPrevented=!0};var Et=function(){if(!o.addEventListener||!Object.defineProperty)return!1;var k=!1,re=Object.defineProperty({},"passive",{get:function(){k=!0}});try{const ye=()=>{};o.addEventListener("test",ye,re),o.removeEventListener("test",ye,re)}catch{}return k}();function yi(k,re){if(Ot.call(this,k?k.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,k){var ye=this.type=k.type,We=k.changedTouches&&k.changedTouches.length?k.changedTouches[0]:null;if(this.target=k.target||k.srcElement,this.g=re,re=k.relatedTarget){if(Te){e:{try{Ae(re.nodeName);var Pt=!0;break e}catch{}Pt=!1}Pt||(re=null)}}else ye=="mouseover"?re=k.fromElement:ye=="mouseout"&&(re=k.toElement);this.relatedTarget=re,We?(this.clientX=We.clientX!==void 0?We.clientX:We.pageX,this.clientY=We.clientY!==void 0?We.clientY:We.pageY,this.screenX=We.screenX||0,this.screenY=We.screenY||0):(this.clientX=k.clientX!==void 0?k.clientX:k.pageX,this.clientY=k.clientY!==void 0?k.clientY:k.pageY,this.screenX=k.screenX||0,this.screenY=k.screenY||0),this.button=k.button,this.key=k.key||"",this.ctrlKey=k.ctrlKey,this.altKey=k.altKey,this.shiftKey=k.shiftKey,this.metaKey=k.metaKey,this.pointerId=k.pointerId||0,this.pointerType=typeof k.pointerType=="string"?k.pointerType:mi[k.pointerType]||"",this.state=k.state,this.i=k,k.defaultPrevented&&yi.aa.h.call(this)}}X(yi,Ot);var mi={2:"touch",3:"pen",4:"mouse"};yi.prototype.h=function(){yi.aa.h.call(this);var k=this.i;k.preventDefault?k.preventDefault():k.returnValue=!1};var ht="closure_listenable_"+(1e6*Math.random()|0),hi=0;function ni(k,re,ye,We,Pt){this.listener=k,this.proxy=null,this.src=re,this.type=ye,this.capture=!!We,this.ha=Pt,this.key=++hi,this.da=this.fa=!1}function ui(k){k.da=!0,k.listener=null,k.proxy=null,k.src=null,k.ha=null}function Fi(k){this.src=k,this.g={},this.h=0}Fi.prototype.add=function(k,re,ye,We,Pt){var qt=k.toString();k=this.g[qt],k||(k=this.g[qt]=[],this.h++);var Ti=Bi(k,re,We,Pt);return-1<Ti?(re=k[Ti],ye||(re.fa=!1)):(re=new ni(re,this.src,qt,!!We,Pt),re.fa=ye,k.push(re)),re};function Ii(k,re){var ye=re.type;if(ye in k.g){var We=k.g[ye],Pt=Array.prototype.indexOf.call(We,re,void 0),qt;(qt=0<=Pt)&&Array.prototype.splice.call(We,Pt,1),qt&&(ui(re),k.g[ye].length==0&&(delete k.g[ye],k.h--))}}function Bi(k,re,ye,We){for(var Pt=0;Pt<k.length;++Pt){var qt=k[Pt];if(!qt.da&&qt.listener==re&&qt.capture==!!ye&&qt.ha==We)return Pt}return-1}var Ki="closure_lm_"+(1e6*Math.random()|0),$r={};function nn(k,re,ye,We,Pt){if(Array.isArray(re)){for(var qt=0;qt<re.length;qt++)nn(k,re[qt],ye,We,Pt);return null}return ye=Vi(ye),k&&k[ht]?k.K(re,ye,R(We)?!!We.capture:!1,Pt):Gn(k,re,ye,!1,We,Pt)}function Gn(k,re,ye,We,Pt,qt){if(!re)throw Error("Invalid event type");var Ti=R(Pt)?!!Pt.capture:!!Pt,An=ai(k);if(An||(k[Ki]=An=new Fi(k)),ye=An.add(re,ye,We,Ti,qt),ye.proxy)return ye;if(We=Tr(),ye.proxy=We,We.src=k,We.listener=ye,k.addEventListener)Et||(Pt=Ti),Pt===void 0&&(Pt=!1),k.addEventListener(re.toString(),We,Pt);else if(k.attachEvent)k.attachEvent(ar(re.toString()),We);else if(k.addListener&&k.removeListener)k.addListener(We);else throw Error("addEventListener and attachEvent are unavailable.");return ye}function Tr(){function k(ye){return re.call(k.src,k.listener,ye)}const re=li;return k}function jt(k,re,ye,We,Pt){if(Array.isArray(re))for(var qt=0;qt<re.length;qt++)jt(k,re[qt],ye,We,Pt);else We=R(We)?!!We.capture:!!We,ye=Vi(ye),k&&k[ht]?(k=k.i,re=String(re).toString(),re in k.g&&(qt=k.g[re],ye=Bi(qt,ye,We,Pt),-1<ye&&(ui(qt[ye]),Array.prototype.splice.call(qt,ye,1),qt.length==0&&(delete k.g[re],k.h--)))):k&&(k=ai(k))&&(re=k.g[re.toString()],k=-1,re&&(k=Bi(re,ye,We,Pt)),(ye=-1<k?re[k]:null)&&bi(ye))}function bi(k){if(typeof k!="number"&&k&&!k.da){var re=k.src;if(re&&re[ht])Ii(re.i,k);else{var ye=k.type,We=k.proxy;re.removeEventListener?re.removeEventListener(ye,We,k.capture):re.detachEvent?re.detachEvent(ar(ye),We):re.addListener&&re.removeListener&&re.removeListener(We),(ye=ai(re))?(Ii(ye,k),ye.h==0&&(ye.src=null,re[Ki]=null)):ui(k)}}}function ar(k){return k in $r?$r[k]:$r[k]="on"+k}function li(k,re){if(k.da)k=!0;else{re=new yi(re,this);var ye=k.listener,We=k.ha||k.src;k.fa&&bi(k),k=ye.call(We,re)}return k}function ai(k){return k=k[Ki],k instanceof Fi?k:null}var Jt="__closure_events_fn_"+(1e9*Math.random()>>>0);function Vi(k){return typeof k=="function"?k:(k[Jt]||(k[Jt]=function(re){return k.handleEvent(re)}),k[Jt])}function fi(){vt.call(this),this.i=new Fi(this),this.M=this,this.F=null}X(fi,vt),fi.prototype[ht]=!0,fi.prototype.removeEventListener=function(k,re,ye,We){jt(this,k,re,ye,We)};function vi(k,re){var ye,We=k.F;if(We)for(ye=[];We;We=We.F)ye.push(We);if(k=k.M,We=re.type||re,typeof re=="string")re=new Ot(re,k);else if(re instanceof Ot)re.target=re.target||k;else{var Pt=re;re=new Ot(We,k),oe(re,Pt)}if(Pt=!0,ye)for(var qt=ye.length-1;0<=qt;qt--){var Ti=re.g=ye[qt];Pt=Pi(Ti,We,!0,re)&&Pt}if(Ti=re.g=k,Pt=Pi(Ti,We,!0,re)&&Pt,Pt=Pi(Ti,We,!1,re)&&Pt,ye)for(qt=0;qt<ye.length;qt++)Ti=re.g=ye[qt],Pt=Pi(Ti,We,!1,re)&&Pt}fi.prototype.N=function(){if(fi.aa.N.call(this),this.i){var k=this.i,re;for(re in k.g){for(var ye=k.g[re],We=0;We<ye.length;We++)ui(ye[We]);delete k.g[re],k.h--}}this.F=null},fi.prototype.K=function(k,re,ye,We){return this.i.add(String(k),re,!1,ye,We)},fi.prototype.L=function(k,re,ye,We){return this.i.add(String(k),re,!0,ye,We)};function Pi(k,re,ye,We){if(re=k.i.g[String(re)],!re)return!0;re=re.concat();for(var Pt=!0,qt=0;qt<re.length;++qt){var Ti=re[qt];if(Ti&&!Ti.da&&Ti.capture==ye){var An=Ti.listener,an=Ti.ha||Ti.src;Ti.fa&&Ii(k.i,Ti),Pt=An.call(an,We)!==!1&&Pt}}return Pt&&!We.defaultPrevented}function Nr(k,re,ye){if(typeof k=="function")ye&&(k=Y(k,ye));else if(k&&typeof k.handleEvent=="function")k=Y(k.handleEvent,k);else throw Error("Invalid listener argument");return 2147483647<Number(re)?-1:o.setTimeout(k,re||0)}function er(k){k.g=Nr(()=>{k.g=null,k.i&&(k.i=!1,er(k))},k.l);const re=k.h;k.h=null,k.m.apply(null,re)}class Wr extends vt{constructor(re,ye){super(),this.m=re,this.l=ye,this.h=null,this.i=!1,this.g=null}j(re){this.h=arguments,this.g?this.i=!0:er(this)}N(){super.N(),this.g&&(o.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function kr(k){vt.call(this),this.h=k,this.g={}}X(kr,vt);var di=[];function or(k){Ce(k.g,function(re,ye){this.g.hasOwnProperty(ye)&&bi(re)},k),k.g={}}kr.prototype.N=function(){kr.aa.N.call(this),or(this)},kr.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var jn=o.JSON.stringify,Da=o.JSON.parse,ms=class{stringify(k){return o.JSON.stringify(k,void 0)}parse(k){return o.JSON.parse(k,void 0)}};function pt(){}pt.prototype.h=null;function oi(k){return k.h||(k.h=k.i())}function Mi(){}var qi={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function Xn(){Ot.call(this,"d")}X(Xn,Ot);function mr(){Ot.call(this,"c")}X(mr,Ot);var sn={},al=null;function Ma(){return al=al||new fi}sn.La="serverreachability";function fs(k){Ot.call(this,sn.La,k)}X(fs,Ot);function ol(k){const re=Ma();vi(re,new fs(re))}sn.STAT_EVENT="statevent";function ll(k,re){Ot.call(this,sn.STAT_EVENT,k),this.stat=re}X(ll,Ot);function wt(k){const re=Ma();vi(re,new ll(re,k))}sn.Ma="timingevent";function Xa(k,re){Ot.call(this,sn.Ma,k),this.size=re}X(Xa,Ot);function Oi(k,re){if(typeof k!="function")throw Error("Fn must not be null and must be a function");return o.setTimeout(function(){k()},re)}function Xr(){this.g=!0}Xr.prototype.xa=function(){this.g=!1};function Zi(k,re,ye,We,Pt,qt){k.info(function(){if(k.g)if(qt)for(var Ti="",An=qt.split("&"),an=0;an<An.length;an++){var Er=An[an].split("=");if(1<Er.length){var Cn=Er[0];Er=Er[1];var Ks=Cn.split("_");Ti=2<=Ks.length&&Ks[1]=="type"?Ti+(Cn+"="+Er+"&"):Ti+(Cn+"=redacted&")}}else Ti=null;else Ti=qt;return"XMLHTTP REQ ("+We+") [attempt "+Pt+"]: "+re+`
`+ye+`
`+Ti})}function Ze(k,re,ye,We,Pt,qt,Ti){k.info(function(){return"XMLHTTP RESP ("+We+") [ attempt "+Pt+"]: "+re+`
`+ye+`
`+qt+" "+Ti})}function te(k,re,ye,We){k.info(function(){return"XMLHTTP TEXT ("+re+"): "+Ne(k,ye)+(We?" "+We:"")})}function pe(k,re){k.info(function(){return"TIMEOUT: "+re})}Xr.prototype.info=function(){};function Ne(k,re){if(!k.g)return re;if(!re)return null;try{var ye=JSON.parse(re);if(ye){for(k=0;k<ye.length;k++)if(Array.isArray(ye[k])){var We=ye[k];if(!(2>We.length)){var Pt=We[1];if(Array.isArray(Pt)&&!(1>Pt.length)){var qt=Pt[0];if(qt!="noop"&&qt!="stop"&&qt!="close")for(var Ti=1;Ti<Pt.length;Ti++)Pt[Ti]=""}}}}return jn(ye)}catch{return re}}var Ue={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},Ie={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"},Xe;function Je(){}X(Je,pt),Je.prototype.g=function(){return new XMLHttpRequest},Je.prototype.i=function(){return{}},Xe=new Je;function He(k,re,ye,We){this.j=k,this.i=re,this.l=ye,this.R=We||1,this.U=new kr(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new it}function it(){this.i=null,this.g="",this.h=!1}var At={},St={};function Ht(k,re,ye){k.L=1,k.v=xa(Ms(re)),k.m=ye,k.P=!0,ci(k,null)}function ci(k,re){k.F=Date.now(),$i(k),k.A=Ms(k.v);var ye=k.A,We=k.R;Array.isArray(We)||(We=[String(We)]),Sc(ye.i,"t",We),k.C=0,ye=k.j.J,k.h=new it,k.g=ca(k.j,ye?re:null,!k.m),0<k.O&&(k.M=new Wr(Y(k.Y,k,k.g),k.O)),re=k.U,ye=k.g,We=k.ca;var Pt="readystatechange";Array.isArray(Pt)||(Pt&&(di[0]=Pt.toString()),Pt=di);for(var qt=0;qt<Pt.length;qt++){var Ti=nn(ye,Pt[qt],We||re.handleEvent,!1,re.h||re);if(!Ti)break;re.g[Ti.key]=Ti}re=k.H?ae(k.H):{},k.m?(k.u||(k.u="POST"),re["Content-Type"]="application/x-www-form-urlencoded",k.g.ea(k.A,k.u,k.m,re)):(k.u="GET",k.g.ea(k.A,k.u,null,re)),ol(),Zi(k.i,k.u,k.A,k.l,k.R,k.m)}He.prototype.ca=function(k){k=k.target;const re=this.M;re&&La(k)==3?re.j():this.Y(k)},He.prototype.Y=function(k){try{if(k==this.g)e:{const Ks=La(this.g);var re=this.g.Ba();const Ja=this.g.Z();if(!(3>Ks)&&(Ks!=3||this.g&&(this.h.h||this.g.oa()||ul(this.g)))){this.J||Ks!=4||re==7||(re==8||0>=Ja?ol(3):ol(2)),Ni(this);var ye=this.g.Z();this.X=ye;t:if(wi(this)){var We=ul(this.g);k="";var Pt=We.length,qt=La(this.g)==4;if(!this.h.i){if(typeof TextDecoder>"u"){Nn(this),Br(this);var Ti="";break t}this.h.i=new o.TextDecoder}for(re=0;re<Pt;re++)this.h.h=!0,k+=this.h.i.decode(We[re],{stream:!(qt&&re==Pt-1)});We.length=0,this.h.g+=k,this.C=0,Ti=this.h.g}else Ti=this.g.oa();if(this.o=ye==200,Ze(this.i,this.u,this.A,this.l,this.R,Ks,ye),this.o){if(this.T&&!this.K){t:{if(this.g){var An,an=this.g;if((An=an.g?an.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!K(An)){var Er=An;break t}}Er=null}if(ye=Er)te(this.i,this.l,ye,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,gn(this,ye);else{this.o=!1,this.s=3,wt(12),Nn(this),Br(this);break e}}if(this.P){ye=!0;let un;for(;!this.J&&this.C<Ti.length;)if(un=zi(this,Ti),un==St){Ks==4&&(this.s=4,wt(14),ye=!1),te(this.i,this.l,null,"[Incomplete Response]");break}else if(un==At){this.s=4,wt(15),te(this.i,this.l,Ti,"[Invalid Chunk]"),ye=!1;break}else te(this.i,this.l,un,null),gn(this,un);if(wi(this)&&this.C!=0&&(this.h.g=this.h.g.slice(this.C),this.C=0),Ks!=4||Ti.length!=0||this.h.h||(this.s=1,wt(16),ye=!1),this.o=this.o&&ye,!ye)te(this.i,this.l,Ti,"[Invalid Chunked Response]"),Nn(this),Br(this);else if(0<Ti.length&&!this.W){this.W=!0;var Cn=this.j;Cn.g==this&&Cn.ba&&!Cn.M&&(Cn.j.info("Great, no buffering proxy detected. Bytes received: "+Ti.length),sd(Cn),Cn.M=!0,wt(11))}}else te(this.i,this.l,Ti,null),gn(this,Ti);Ks==4&&Nn(this),this.o&&!this.J&&(Ks==4?ad(this.j,this):(this.o=!1,$i(this)))}else nd(this.g),ye==400&&0<Ti.indexOf("Unknown SID")?(this.s=3,wt(12)):(this.s=0,wt(13)),Nn(this),Br(this)}}}catch{}finally{}};function wi(k){return k.g?k.u=="GET"&&k.L!=2&&k.j.Ca:!1}function zi(k,re){var ye=k.C,We=re.indexOf(`
`,ye);return We==-1?St:(ye=Number(re.substring(ye,We)),isNaN(ye)?At:(We+=1,We+ye>re.length?St:(re=re.slice(We,We+ye),k.C=We+ye,re)))}He.prototype.cancel=function(){this.J=!0,Nn(this)};function $i(k){k.S=Date.now()+k.I,Ei(k,k.I)}function Ei(k,re){if(k.B!=null)throw Error("WatchDog timer not null");k.B=Oi(Y(k.ba,k),re)}function Ni(k){k.B&&(o.clearTimeout(k.B),k.B=null)}He.prototype.ba=function(){this.B=null;const k=Date.now();0<=k-this.S?(pe(this.i,this.A),this.L!=2&&(ol(),wt(17)),Nn(this),this.s=2,Br(this)):Ei(this,this.S-k)};function Br(k){k.j.G==0||k.J||ad(k.j,k)}function Nn(k){Ni(k);var re=k.M;re&&typeof re.ma=="function"&&re.ma(),k.M=null,or(k.U),k.g&&(re=k.g,k.g=null,re.abort(),re.ma())}function gn(k,re){try{var ye=k.j;if(ye.G!=0&&(ye.g==k||Or(ye.h,k))){if(!k.K&&Or(ye.h,k)&&ye.G==3){try{var We=ye.Da.g.parse(re)}catch{We=null}if(Array.isArray(We)&&We.length==3){var Pt=We;if(Pt[0]==0){e:if(!ye.u){if(ye.g)if(ye.g.F+3e3<k.F)Ls(ye),Ys(ye);else break e;Si(ye),wt(18)}}else ye.za=Pt[1],0<ye.za-ye.T&&37500>Pt[2]&&ye.F&&ye.v==0&&!ye.C&&(ye.C=Oi(Y(ye.Za,ye),6e3));if(1>=Jr(ye.h)&&ye.ca){try{ye.ca()}catch{}ye.ca=void 0}}else ii(ye,11)}else if((k.K||ye.g==k)&&Ls(ye),!K(re))for(Pt=ye.Da.g.parse(re),re=0;re<Pt.length;re++){let Er=Pt[re];if(ye.T=Er[0],Er=Er[1],ye.G==2)if(Er[0]=="c"){ye.K=Er[1],ye.ia=Er[2];const Cn=Er[3];Cn!=null&&(ye.la=Cn,ye.j.info("VER="+ye.la));const Ks=Er[4];Ks!=null&&(ye.Aa=Ks,ye.j.info("SVER="+ye.Aa));const Ja=Er[5];Ja!=null&&typeof Ja=="number"&&0<Ja&&(We=1.5*Ja,ye.L=We,ye.j.info("backChannelRequestTimeoutMs_="+We)),We=ye;const un=k.g;if(un){const eo=un.g?un.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(eo){var qt=We.h;qt.g||eo.indexOf("spdy")==-1&&eo.indexOf("quic")==-1&&eo.indexOf("h2")==-1||(qt.j=qt.l,qt.g=new Set,qt.h&&(Lr(qt,qt.h),qt.h=null))}if(We.D){const Bo=un.g?un.g.getResponseHeader("X-HTTP-Session-Id"):null;Bo&&(We.ya=Bo,xn(We.I,We.D,Bo))}}ye.G=3,ye.l&&ye.l.ua(),ye.ba&&(ye.R=Date.now()-k.F,ye.j.info("Handshake RTT: "+ye.R+"ms")),We=ye;var Ti=k;if(We.qa=gr(We,We.J?We.ia:null,We.W),Ti.K){yn(We.h,Ti);var An=Ti,an=We.L;an&&(An.I=an),An.B&&(Ni(An),$i(An)),We.g=Ti}else qp(We);0<ye.i.length&&Ac(ye)}else Er[0]!="stop"&&Er[0]!="close"||ii(ye,7);else ye.G==3&&(Er[0]=="stop"||Er[0]=="close"?Er[0]=="stop"?ii(ye,7):zo(ye):Er[0]!="noop"&&ye.l&&ye.l.ta(Er),ye.v=0)}}ol(4)}catch{}}var Rn=class{constructor(k,re){this.g=k,this.map=re}};function Yr(k){this.l=k||10,o.PerformanceNavigationTiming?(k=o.performance.getEntriesByType("navigation"),k=0<k.length&&(k[0].nextHopProtocol=="hq"||k[0].nextHopProtocol=="h2")):k=!!(o.chrome&&o.chrome.loadTimes&&o.chrome.loadTimes()&&o.chrome.loadTimes().wasFetchedViaSpdy),this.j=k?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function cr(k){return k.h?!0:k.g?k.g.size>=k.j:!1}function Jr(k){return k.h?1:k.g?k.g.size:0}function Or(k,re){return k.h?k.h==re:k.g?k.g.has(re):!1}function Lr(k,re){k.g?k.g.add(re):k.h=re}function yn(k,re){k.h&&k.h==re?k.h=null:k.g&&k.g.has(re)&&k.g.delete(re)}Yr.prototype.cancel=function(){if(this.i=Es(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&this.g.size!==0){for(const k of this.g.values())k.cancel();this.g.clear()}};function Es(k){if(k.h!=null)return k.i.concat(k.h.D);if(k.g!=null&&k.g.size!==0){let re=k.i;for(const ye of k.g.values())re=re.concat(ye.D);return re}return he(k.i)}function Is(k){if(k.V&&typeof k.V=="function")return k.V();if(typeof Map<"u"&&k instanceof Map||typeof Set<"u"&&k instanceof Set)return Array.from(k.values());if(typeof k=="string")return k.split("");if(C(k)){for(var re=[],ye=k.length,We=0;We<ye;We++)re.push(k[We]);return re}re=[],ye=0;for(We in k)re[ye++]=k[We];return re}function ns(k){if(k.na&&typeof k.na=="function")return k.na();if(!k.V||typeof k.V!="function"){if(typeof Map<"u"&&k instanceof Map)return Array.from(k.keys());if(!(typeof Set<"u"&&k instanceof Set)){if(C(k)||typeof k=="string"){var re=[];k=k.length;for(var ye=0;ye<k;ye++)re.push(ye);return re}re=[],ye=0;for(const We in k)re[ye++]=We;return re}}}function wl(k,re){if(k.forEach&&typeof k.forEach=="function")k.forEach(re,void 0);else if(C(k)||typeof k=="string")Array.prototype.forEach.call(k,re,void 0);else for(var ye=ns(k),We=Is(k),Pt=We.length,qt=0;qt<Pt;qt++)re.call(void 0,We[qt],ye&&ye[qt],k)}var Zs=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function Oa(k,re){if(k){k=k.split("&");for(var ye=0;ye<k.length;ye++){var We=k[ye].indexOf("="),Pt=null;if(0<=We){var qt=k[ye].substring(0,We);Pt=k[ye].substring(We+1)}else qt=k[ye];re(qt,Pt?decodeURIComponent(Pt.replace(/\+/g," ")):"")}}}function Xs(k){if(this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,k instanceof Xs){this.h=k.h,la(this,k.j),this.o=k.o,this.g=k.g,Os(this,k.s),this.l=k.l;var re=k.i,ye=new Ka;ye.i=re.i,re.g&&(ye.g=new Map(re.g),ye.h=re.h),cl(this,ye),this.m=k.m}else k&&(re=String(k).match(Zs))?(this.h=!1,la(this,re[1]||"",!0),this.o=Sl(re[2]||""),this.g=Sl(re[3]||"",!0),Os(this,re[4]),this.l=Sl(re[5]||"",!0),cl(this,re[6]||"",!0),this.m=Sl(re[7]||"")):(this.h=!1,this.i=new Ka(null,this.h))}Xs.prototype.toString=function(){var k=[],re=this.j;re&&k.push(Tl(re,zp,!0),":");var ye=this.g;return(ye||re=="file")&&(k.push("//"),(re=this.o)&&k.push(Tl(re,zp,!0),"@"),k.push(encodeURIComponent(String(ye)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),ye=this.s,ye!=null&&k.push(":",String(ye))),(ye=this.l)&&(this.g&&ye.charAt(0)!="/"&&k.push("/"),k.push(Tl(ye,ye.charAt(0)=="/"?Vp:Bp,!0))),(ye=this.i.toString())&&k.push("?",ye),(ye=this.m)&&k.push("#",Tl(ye,Ya)),k.join("")};function Ms(k){return new Xs(k)}function la(k,re,ye){k.j=ye?Sl(re,!0):re,k.j&&(k.j=k.j.replace(/:$/,""))}function Os(k,re){if(re){if(re=Number(re),isNaN(re)||0>re)throw Error("Bad port number "+re);k.s=re}else k.s=null}function cl(k,re,ye){re instanceof Ka?(k.i=re,Hl(k.i,k.h)):(ye||(re=Tl(re,Ps)),k.i=new Ka(re,k.h))}function xn(k,re,ye){k.i.set(re,ye)}function xa(k){return xn(k,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),k}function Sl(k,re){return k?re?decodeURI(k.replace(/%25/g,"%2525")):decodeURIComponent(k):""}function Tl(k,re,ye){return typeof k=="string"?(k=encodeURI(k).replace(re,Sf),ye&&(k=k.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),k):null}function Sf(k){return k=k.charCodeAt(0),"%"+(k>>4&15).toString(16)+(k&15).toString(16)}var zp=/[#\/\?@]/g,Bp=/[#\?:]/g,Vp=/[#\?]/g,Ps=/[#\?@]/g,Ya=/#/g;function Ka(k,re){this.h=this.g=null,this.i=k||null,this.j=!!re}function js(k){k.g||(k.g=new Map,k.h=0,k.i&&Oa(k.i,function(re,ye){k.add(decodeURIComponent(re.replace(/\+/g," ")),ye)}))}t=Ka.prototype,t.add=function(k,re){js(this),this.i=null,k=yo(this,k);var ye=this.g.get(k);return ye||this.g.set(k,ye=[]),ye.push(re),this.h+=1,this};function Fo(k,re){js(k),re=yo(k,re),k.g.has(re)&&(k.i=null,k.h-=k.g.get(re).length,k.g.delete(re))}function wc(k,re){return js(k),re=yo(k,re),k.g.has(re)}t.forEach=function(k,re){js(this),this.g.forEach(function(ye,We){ye.forEach(function(Pt){k.call(re,Pt,We,this)},this)},this)},t.na=function(){js(this);const k=Array.from(this.g.values()),re=Array.from(this.g.keys()),ye=[];for(let We=0;We<re.length;We++){const Pt=k[We];for(let qt=0;qt<Pt.length;qt++)ye.push(re[We])}return ye},t.V=function(k){js(this);let re=[];if(typeof k=="string")wc(this,k)&&(re=re.concat(this.g.get(yo(this,k))));else{k=Array.from(this.g.values());for(let ye=0;ye<k.length;ye++)re=re.concat(k[ye])}return re},t.set=function(k,re){return js(this),this.i=null,k=yo(this,k),wc(this,k)&&(this.h-=this.g.get(k).length),this.g.set(k,[re]),this.h+=1,this},t.get=function(k,re){return k?(k=this.V(k),0<k.length?String(k[0]):re):re};function Sc(k,re,ye){Fo(k,re),0<ye.length&&(k.i=null,k.g.set(yo(k,re),he(ye)),k.h+=ye.length)}t.toString=function(){if(this.i)return this.i;if(!this.g)return"";const k=[],re=Array.from(this.g.keys());for(var ye=0;ye<re.length;ye++){var We=re[ye];const qt=encodeURIComponent(String(We)),Ti=this.V(We);for(We=0;We<Ti.length;We++){var Pt=qt;Ti[We]!==""&&(Pt+="="+encodeURIComponent(String(Ti[We]))),k.push(Pt)}}return this.i=k.join("&")};function yo(k,re){return re=String(re),k.j&&(re=re.toLowerCase()),re}function Hl(k,re){re&&!k.j&&(js(k),k.i=null,k.g.forEach(function(ye,We){var Pt=We.toLowerCase();We!=Pt&&(Fo(this,We),Sc(this,Pt,ye))},k)),k.j=re}function eh(k,re){const ye=new Xr;if(o.Image){const We=new Image;We.onload=H(Nl,ye,"TestLoadImage: loaded",!0,re,We),We.onerror=H(Nl,ye,"TestLoadImage: error",!1,re,We),We.onabort=H(Nl,ye,"TestLoadImage: abort",!1,re,We),We.ontimeout=H(Nl,ye,"TestLoadImage: timeout",!1,re,We),o.setTimeout(function(){We.ontimeout&&We.ontimeout()},1e4),We.src=k}else re(!1)}function Tf(k,re){const ye=new Xr,We=new AbortController,Pt=setTimeout(()=>{We.abort(),Nl(ye,"TestPingServer: timeout",!1,re)},1e4);fetch(k,{signal:We.signal}).then(qt=>{clearTimeout(Pt),qt.ok?Nl(ye,"TestPingServer: ok",!0,re):Nl(ye,"TestPingServer: server error",!1,re)}).catch(()=>{clearTimeout(Pt),Nl(ye,"TestPingServer: error",!1,re)})}function Nl(k,re,ye,We,Pt){try{Pt&&(Pt.onload=null,Pt.onerror=null,Pt.onabort=null,Pt.ontimeout=null),We(ye)}catch{}}function Ca(){this.g=new ms}function id(k,re,ye){const We=ye||"";try{wl(k,function(Pt,qt){let Ti=Pt;R(Pt)&&(Ti=jn(Pt)),re.push(We+qt+"="+encodeURIComponent(Ti))})}catch(Pt){throw re.push(We+"type="+encodeURIComponent("_badmap")),Pt}}function Wl(k){this.l=k.Ub||null,this.j=k.eb||!1}X(Wl,pt),Wl.prototype.g=function(){return new xo(this.l,this.j)},Wl.prototype.i=function(k){return function(){return k}}({});function xo(k,re){fi.call(this),this.D=k,this.o=re,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}X(xo,fi),t=xo.prototype,t.open=function(k,re){if(this.readyState!=0)throw this.abort(),Error("Error reopening a connection");this.B=k,this.A=re,this.readyState=1,Tc(this)},t.send=function(k){if(this.readyState!=1)throw this.abort(),Error("need to call open() first. ");this.g=!0;const re={headers:this.u,method:this.B,credentials:this.m,cache:void 0};k&&(re.body=k),(this.D||o).fetch(new Request(this.A,re)).then(this.Sa.bind(this),this.ga.bind(this))},t.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&this.readyState!=4&&(this.g=!1,rd(this)),this.readyState=0},t.Sa=function(k){if(this.g&&(this.l=k,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=k.headers,this.readyState=2,Tc(this)),this.g&&(this.readyState=3,Tc(this),this.g)))if(this.responseType==="arraybuffer")k.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if(typeof o.ReadableStream<"u"&&"body"in k){if(this.j=k.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;su(this)}else k.text().then(this.Ra.bind(this),this.ga.bind(this))};function su(k){k.j.read().then(k.Pa.bind(k)).catch(k.ga.bind(k))}t.Pa=function(k){if(this.g){if(this.o&&k.value)this.response.push(k.value);else if(!this.o){var re=k.value?k.value:new Uint8Array(0);(re=this.v.decode(re,{stream:!k.done}))&&(this.response=this.responseText+=re)}k.done?rd(this):Tc(this),this.readyState==3&&su(this)}},t.Ra=function(k){this.g&&(this.response=this.responseText=k,rd(this))},t.Qa=function(k){this.g&&(this.response=k,rd(this))},t.ga=function(){this.g&&rd(this)};function rd(k){k.readyState=4,k.l=null,k.j=null,k.v=null,Tc(k)}t.setRequestHeader=function(k,re){this.u.append(k,re)},t.getResponseHeader=function(k){return this.h&&this.h.get(k.toLowerCase())||""},t.getAllResponseHeaders=function(){if(!this.h)return"";const k=[],re=this.h.entries();for(var ye=re.next();!ye.done;)ye=ye.value,k.push(ye[0]+": "+ye[1]),ye=re.next();return k.join(`\r
`)};function Tc(k){k.onreadystatechange&&k.onreadystatechange.call(k)}Object.defineProperty(xo.prototype,"withCredentials",{get:function(){return this.m==="include"},set:function(k){this.m=k?"include":"same-origin"}});function hr(k){let re="";return Ce(k,function(ye,We){re+=We,re+=":",re+=ye,re+=`\r
`}),re}function Zl(k,re,ye){e:{for(We in ye){var We=!1;break e}We=!0}We||(ye=hr(ye),typeof k=="string"?ye!=null&&encodeURIComponent(String(ye)):xn(k,re,ye))}function Yn(k){fi.call(this),this.headers=new Map,this.o=k||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}X(Yn,fi);var Nf=/^https?$/i,Af=["POST","PUT"];t=Yn.prototype,t.Ha=function(k){this.J=k},t.ea=function(k,re,ye,We){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+k);re=re?re.toUpperCase():"GET",this.D=k,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=this.o?this.o.g():Xe.g(),this.v=this.o?oi(this.o):oi(Xe),this.g.onreadystatechange=Y(this.Ea,this);try{this.B=!0,this.g.open(re,String(k),!0),this.B=!1}catch(qt){au(this,qt);return}if(k=ye||"",ye=new Map(this.headers),We)if(Object.getPrototypeOf(We)===Object.prototype)for(var Pt in We)ye.set(Pt,We[Pt]);else if(typeof We.keys=="function"&&typeof We.get=="function")for(const qt of We.keys())ye.set(qt,We.get(qt));else throw Error("Unknown input type for opt_headers: "+String(We));We=Array.from(ye.keys()).find(qt=>qt.toLowerCase()=="content-type"),Pt=o.FormData&&k instanceof o.FormData,!(0<=Array.prototype.indexOf.call(Af,re,void 0))||We||Pt||ye.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[qt,Ti]of ye)this.g.setRequestHeader(qt,Ti);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{Cf(this),this.u=!0,this.g.send(k),this.u=!1}catch(qt){au(this,qt)}};function au(k,re){k.h=!1,k.g&&(k.j=!0,k.g.abort(),k.j=!1),k.l=re,k.m=5,Al(k),Nc(k)}function Al(k){k.A||(k.A=!0,vi(k,"complete"),vi(k,"error"))}t.abort=function(k){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=k||7,vi(this,"complete"),vi(this,"abort"),Nc(this))},t.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),Nc(this,!0)),Yn.aa.N.call(this)},t.Ea=function(){this.s||(this.B||this.u||this.j?ou(this):this.bb())},t.bb=function(){ou(this)};function ou(k){if(k.h&&typeof w<"u"&&(!k.v[1]||La(k)!=4||k.Z()!=2)){if(k.u&&La(k)==4)Nr(k.Ea,0,k);else if(vi(k,"readystatechange"),La(k)==4){k.h=!1;try{const Ti=k.Z();e:switch(Ti){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var re=!0;break e;default:re=!1}var ye;if(!(ye=re)){var We;if(We=Ti===0){var Pt=String(k.D).match(Zs)[1]||null;!Pt&&o.self&&o.self.location&&(Pt=o.self.location.protocol.slice(0,-1)),We=!Nf.test(Pt?Pt.toLowerCase():"")}ye=We}if(ye)vi(k,"complete"),vi(k,"success");else{k.m=6;try{var qt=2<La(k)?k.g.statusText:""}catch{qt=""}k.l=qt+" ["+k.Z()+"]",Al(k)}}finally{Nc(k)}}}}function Nc(k,re){if(k.g){Cf(k);const ye=k.g,We=k.v[0]?()=>{}:null;k.g=null,k.v=null,re||vi(k,"ready");try{ye.onreadystatechange=We}catch{}}}function Cf(k){k.I&&(o.clearTimeout(k.I),k.I=null)}t.isActive=function(){return!!this.g};function La(k){return k.g?k.g.readyState:0}t.Z=function(){try{return 2<La(this)?this.g.status:-1}catch{return-1}},t.oa=function(){try{return this.g?this.g.responseText:""}catch{return""}},t.Oa=function(k){if(this.g){var re=this.g.responseText;return k&&re.indexOf(k)==0&&(re=re.substring(k.length)),Da(re)}};function ul(k){try{if(!k.g)return null;if("response"in k.g)return k.g.response;switch(k.H){case"":case"text":return k.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in k.g)return k.g.mozResponseArrayBuffer}return null}catch{return null}}function nd(k){const re={};k=(k.g&&2<=La(k)&&k.g.getAllResponseHeaders()||"").split(`\r
`);for(let We=0;We<k.length;We++){if(K(k[We]))continue;var ye=ke(k[We]);const Pt=ye[0];if(ye=ye[1],typeof ye!="string")continue;ye=ye.trim();const qt=re[Pt]||[];re[Pt]=qt,qt.push(ye)}ne(re,function(We){return We.join(", ")})}t.Ba=function(){return this.m},t.Ka=function(){return typeof this.l=="string"?this.l:String(this.l)};function lu(k,re,ye){return ye&&ye.internalChannelParams&&ye.internalChannelParams[k]||re}function Xl(k){this.Aa=0,this.i=[],this.j=new Xr,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=lu("failFast",!1,k),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=lu("baseRetryDelayMs",5e3,k),this.cb=lu("retryDelaySeedMs",1e4,k),this.Wa=lu("forwardChannelMaxRetries",2,k),this.wa=lu("forwardChannelRequestTimeoutMs",2e4,k),this.pa=k&&k.xmlHttpFactory||void 0,this.Xa=k&&k.Tb||void 0,this.Ca=k&&k.useFetchStreams||!1,this.L=void 0,this.J=k&&k.supportsCrossDomainXhr||!1,this.K="",this.h=new Yr(k&&k.concurrentRequestLimit),this.Da=new Ca,this.P=k&&k.fastHandshake||!1,this.O=k&&k.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=k&&k.Rb||!1,k&&k.xa&&this.j.xa(),k&&k.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&k&&k.detectBufferingProxy||!1,this.ja=void 0,k&&k.longPollingTimeout&&0<k.longPollingTimeout&&(this.ja=k.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}t=Xl.prototype,t.la=8,t.G=1,t.connect=function(k,re,ye,We){wt(0),this.W=k,this.H=re||{},ye&&We!==void 0&&(this.H.OSID=ye,this.H.OAID=We),this.F=this.X,this.I=gr(this,null,this.W),Ac(this)};function zo(k){if(Qa(k),k.G==3){var re=k.U++,ye=Ms(k.I);if(xn(ye,"SID",k.K),xn(ye,"RID",re),xn(ye,"TYPE","terminate"),Cc(k,ye),re=new He(k,k.j,re),re.L=2,re.v=xa(Ms(ye)),ye=!1,o.navigator&&o.navigator.sendBeacon)try{ye=o.navigator.sendBeacon(re.v.toString(),"")}catch{}!ye&&o.Image&&(new Image().src=re.v,ye=!0),ye||(re.g=ca(re.j,null),re.g.ea(re.v)),re.F=Date.now(),$i(re)}br(k)}function Ys(k){k.g&&(sd(k),k.g.cancel(),k.g=null)}function Qa(k){Ys(k),k.u&&(o.clearTimeout(k.u),k.u=null),Ls(k),k.h.cancel(),k.s&&(typeof k.s=="number"&&o.clearTimeout(k.s),k.s=null)}function Ac(k){if(!cr(k.h)&&!k.s){k.s=!0;var re=k.Ga;Ke||tt(),Pe||(Ke(),Pe=!0),It.add(re,k),k.B=0}}function Ef(k,re){return Jr(k.h)>=k.h.j-(k.s?1:0)?!1:k.s?(k.i=re.D.concat(k.i),!0):k.G==1||k.G==2||k.B>=(k.Va?0:k.Wa)?!1:(k.s=Oi(Y(k.Ga,k,re),_a(k,k.B)),k.B++,!0)}t.Ga=function(k){if(this.s)if(this.s=null,this.G==1){if(!k){this.U=Math.floor(1e5*Math.random()),k=this.U++;const Pt=new He(this,this.j,k);let qt=this.o;if(this.S&&(qt?(qt=ae(qt),oe(qt,this.S)):qt=this.S),this.m!==null||this.O||(Pt.H=qt,qt=null),this.P)e:{for(var re=0,ye=0;ye<this.i.length;ye++){t:{var We=this.i[ye];if("__data__"in We.map&&(We=We.map.__data__,typeof We=="string")){We=We.length;break t}We=void 0}if(We===void 0)break;if(re+=We,4096<re){re=ye;break e}if(re===4096||ye===this.i.length-1){re=ye+1;break e}}re=1e3}else re=1e3;re=Up(this,Pt,re),ye=Ms(this.I),xn(ye,"RID",k),xn(ye,"CVER",22),this.D&&xn(ye,"X-HTTP-Session-Id",this.D),Cc(this,ye),qt&&(this.O?re="headers="+encodeURIComponent(String(hr(qt)))+"&"+re:this.m&&Zl(ye,this.m,qt)),Lr(this.h,Pt),this.Ua&&xn(ye,"TYPE","init"),this.P?(xn(ye,"$req",re),xn(ye,"SID","null"),Pt.T=!0,Ht(Pt,ye,null)):Ht(Pt,ye,re),this.G=2}}else this.G==3&&(k?Ar(this,k):this.i.length==0||cr(this.h)||Ar(this))};function Ar(k,re){var ye;re?ye=re.l:ye=k.U++;const We=Ms(k.I);xn(We,"SID",k.K),xn(We,"RID",ye),xn(We,"AID",k.T),Cc(k,We),k.m&&k.o&&Zl(We,k.m,k.o),ye=new He(k,k.j,ye,k.B+1),k.m===null&&(ye.H=k.o),re&&(k.i=re.D.concat(k.i)),re=Up(k,ye,1e3),ye.I=Math.round(.5*k.wa)+Math.round(.5*k.wa*Math.random()),Lr(k.h,ye),Ht(ye,We,re)}function Cc(k,re){k.H&&Ce(k.H,function(ye,We){xn(re,We,ye)}),k.l&&wl({},function(ye,We){xn(re,We,ye)})}function Up(k,re,ye){ye=Math.min(k.i.length,ye);var We=k.l?Y(k.l.Na,k.l,k):null;e:{var Pt=k.i;let qt=-1;for(;;){const Ti=["count="+ye];qt==-1?0<ye?(qt=Pt[0].g,Ti.push("ofs="+qt)):qt=0:Ti.push("ofs="+qt);let An=!0;for(let an=0;an<ye;an++){let Er=Pt[an].g;const Cn=Pt[an].map;if(Er-=qt,0>Er)qt=Math.max(0,Pt[an].g-100),An=!1;else try{id(Cn,Ti,"req"+Er+"_")}catch{We&&We(Cn)}}if(An){We=Ti.join("&");break e}}}return k=k.i.splice(0,ye),re.D=k,We}function qp(k){if(!k.g&&!k.u){k.Y=1;var re=k.Fa;Ke||tt(),Pe||(Ke(),Pe=!0),It.add(re,k),k.v=0}}function Si(k){return k.g||k.u||3<=k.v?!1:(k.Y++,k.u=Oi(Y(k.Fa,k),_a(k,k.v)),k.v++,!0)}t.Fa=function(){if(this.u=null,Yl(this),this.ba&&!(this.M||this.g==null||0>=this.R)){var k=2*this.R;this.j.info("BP detection timer enabled: "+k),this.A=Oi(Y(this.ab,this),k)}},t.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,wt(10),Ys(this),Yl(this))};function sd(k){k.A!=null&&(o.clearTimeout(k.A),k.A=null)}function Yl(k){k.g=new He(k,k.j,"rpc",k.Y),k.m===null&&(k.g.H=k.o),k.g.O=0;var re=Ms(k.qa);xn(re,"RID","rpc"),xn(re,"SID",k.K),xn(re,"AID",k.T),xn(re,"CI",k.F?"0":"1"),!k.F&&k.ja&&xn(re,"TO",k.ja),xn(re,"TYPE","xmlhttp"),Cc(k,re),k.m&&k.o&&Zl(re,k.m,k.o),k.L&&(k.g.I=k.L);var ye=k.g;k=k.ia,ye.L=1,ye.v=xa(Ms(re)),ye.m=null,ye.P=!0,ci(ye,k)}t.Za=function(){this.C!=null&&(this.C=null,Ys(this),Si(this),wt(19))};function Ls(k){k.C!=null&&(o.clearTimeout(k.C),k.C=null)}function ad(k,re){var ye=null;if(k.g==re){Ls(k),sd(k),k.g=null;var We=2}else if(Or(k.h,re))ye=re.D,yn(k.h,re),We=1;else return;if(k.G!=0){if(re.o)if(We==1){ye=re.m?re.m.length:0,re=Date.now()-re.F;var Pt=k.B;We=Ma(),vi(We,new Xa(We,ye)),Ac(k)}else qp(k);else if(Pt=re.s,Pt==3||Pt==0&&0<re.X||!(We==1&&Ef(k,re)||We==2&&Si(k)))switch(ye&&0<ye.length&&(re=k.h,re.i=re.i.concat(ye)),Pt){case 1:ii(k,5);break;case 4:ii(k,10);break;case 3:ii(k,6);break;default:ii(k,2)}}}function _a(k,re){let ye=k.Ta+Math.floor(Math.random()*k.cb);return k.isActive()||(ye*=2),ye*re}function ii(k,re){if(k.j.info("Error code "+re),re==2){var ye=Y(k.fb,k),We=k.Xa;const Pt=!We;We=new Xs(We||"//www.google.com/images/cleardot.gif"),o.location&&o.location.protocol=="http"||la(We,"https"),xa(We),Pt?eh(We.toString(),ye):Tf(We.toString(),ye)}else wt(2);k.G=0,k.l&&k.l.sa(re),br(k),Qa(k)}t.fb=function(k){k?(this.j.info("Successfully pinged google.com"),wt(2)):(this.j.info("Failed to ping google.com"),wt(1))};function br(k){if(k.G=0,k.ka=[],k.l){const re=Es(k.h);(re.length!=0||k.i.length!=0)&&(se(k.ka,re),se(k.ka,k.i),k.h.i.length=0,he(k.i),k.i.length=0),k.l.ra()}}function gr(k,re,ye){var We=ye instanceof Xs?Ms(ye):new Xs(ye);if(We.g!="")re&&(We.g=re+"."+We.g),Os(We,We.s);else{var Pt=o.location;We=Pt.protocol,re=re?re+"."+Pt.hostname:Pt.hostname,Pt=+Pt.port;var qt=new Xs(null);We&&la(qt,We),re&&(qt.g=re),Pt&&Os(qt,Pt),ye&&(qt.l=ye),We=qt}return ye=k.D,re=k.ya,ye&&re&&xn(We,ye,re),xn(We,"VER",k.la),Cc(k,We),We}function ca(k,re,ye){if(re&&!k.J)throw Error("Can't create secondary domain capable XhrIo object.");return re=k.Ca&&!k.pa?new Yn(new Wl({eb:ye})):new Yn(k.pa),re.Ha(k.J),re}t.isActive=function(){return!!this.l&&this.l.isActive(this)};function Ec(){}t=Ec.prototype,t.ua=function(){},t.ta=function(){},t.sa=function(){},t.ra=function(){},t.isActive=function(){return!0},t.Na=function(){};function wr(){}wr.prototype.g=function(k,re){return new va(k,re)};function va(k,re){fi.call(this),this.g=new Xl(re),this.l=k,this.h=re&&re.messageUrlParams||null,k=re&&re.messageHeaders||null,re&&re.clientProtocolHeaderRequired&&(k?k["X-Client-Protocol"]="webchannel":k={"X-Client-Protocol":"webchannel"}),this.g.o=k,k=re&&re.initMessageHeaders||null,re&&re.messageContentType&&(k?k["X-WebChannel-Content-Type"]=re.messageContentType:k={"X-WebChannel-Content-Type":re.messageContentType}),re&&re.va&&(k?k["X-WebChannel-Client-Profile"]=re.va:k={"X-WebChannel-Client-Profile":re.va}),this.g.S=k,(k=re&&re.Sb)&&!K(k)&&(this.g.m=k),this.v=re&&re.supportsCrossDomainXhr||!1,this.u=re&&re.sendRawJson||!1,(re=re&&re.httpSessionIdParam)&&!K(re)&&(this.g.D=re,k=this.h,k!==null&&re in k&&(k=this.h,re in k&&delete k[re])),this.j=new as(this)}X(va,fi),va.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},va.prototype.close=function(){zo(this.g)},va.prototype.o=function(k){var re=this.g;if(typeof k=="string"){var ye={};ye.__data__=k,k=ye}else this.u&&(ye={},ye.__data__=jn(k),k=ye);re.i.push(new Rn(re.Ya++,k)),re.G==3&&Ac(re)},va.prototype.N=function(){this.g.l=null,delete this.j,zo(this.g),delete this.g,va.aa.N.call(this)};function Ic(k){Xn.call(this),k.__headers__&&(this.headers=k.__headers__,this.statusCode=k.__status__,delete k.__headers__,delete k.__status__);var re=k.__sm__;if(re){e:{for(const ye in re){k=ye;break e}k=void 0}(this.i=k)&&(k=this.i,re=re!==null&&k in re?re[k]:void 0),this.data=re}else this.data=k}X(Ic,Xn);function Kl(){mr.call(this),this.status=1}X(Kl,mr);function as(k){this.g=k}X(as,Ec),as.prototype.ua=function(){vi(this.g,"a")},as.prototype.ta=function(k){vi(this.g,new Ic(k))},as.prototype.sa=function(k){vi(this.g,new Kl)},as.prototype.ra=function(){vi(this.g,"b")},wr.prototype.createWebChannel=wr.prototype.g,va.prototype.send=va.prototype.o,va.prototype.open=va.prototype.m,va.prototype.close=va.prototype.close,RB=function(){return new wr},jB=function(){return Ma()},PB=sn,ZE={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},Ue.NO_ERROR=0,Ue.TIMEOUT=8,Ue.HTTP_ERROR=6,m2=Ue,Ie.COMPLETE="complete",IB=Ie,Mi.EventType=qi,qi.OPEN="a",qi.CLOSE="b",qi.ERROR="c",qi.MESSAGE="d",fi.prototype.listen=fi.prototype.K,P0=Mi,Yn.prototype.listenOnce=Yn.prototype.L,Yn.prototype.getLastError=Yn.prototype.Ka,Yn.prototype.getLastErrorCode=Yn.prototype.Ba,Yn.prototype.getStatus=Yn.prototype.Z,Yn.prototype.getResponseJson=Yn.prototype.Oa,Yn.prototype.getResponseText=Yn.prototype.oa,Yn.prototype.send=Yn.prototype.ea,Yn.prototype.setWithCredentials=Yn.prototype.Ha,EB=Yn}).apply(typeof Lw<"u"?Lw:typeof self<"u"?self:typeof window<"u"?window:{});const u4="@firebase/firestore";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Io=class{constructor(e){this.uid=e}isAuthenticated(){return this.uid!=null}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}};Io.UNAUTHENTICATED=new Io(null),Io.GOOGLE_CREDENTIALS=new Io("google-credentials-uid"),Io.FIRST_PARTY=new Io("first-party-uid"),Io.MOCK_USER=new Io("mock-user");/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Zy="10.14.0";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const nf=new CP("@firebase/firestore");function y0(){return nf.logLevel}function nr(t,...e){if(nf.logLevel<=Sn.DEBUG){const r=e.map(zP);nf.debug(`Firestore (${Zy}): ${t}`,...r)}}function $d(t,...e){if(nf.logLevel<=Sn.ERROR){const r=e.map(zP);nf.error(`Firestore (${Zy}): ${t}`,...r)}}function Ry(t,...e){if(nf.logLevel<=Sn.WARN){const r=e.map(zP);nf.warn(`Firestore (${Zy}): ${t}`,...r)}}function zP(t){if(typeof t=="string")return t;try{/**
* @license
* Copyright 2020 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/return function(r){return JSON.stringify(r)}(t)}catch{return t}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function zr(t="Unexpected state"){const e=`FIRESTORE (${Zy}) INTERNAL ASSERTION FAILED: `+t;throw $d(e),new Error(e)}function Jn(t,e){t||zr()}function Hr(t,e){return t}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ti={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Wi extends Qu{constructor(e,r){super(e,r),this.code=e,this.message=r,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Od{constructor(){this.promise=new Promise((e,r)=>{this.resolve=e,this.reject=r})}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class kB{constructor(e,r){this.user=r,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class LK{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,r){e.enqueueRetryable(()=>r(Io.UNAUTHENTICATED))}shutdown(){}}class FK{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,r){this.changeListener=r,e.enqueueRetryable(()=>r(this.token.user))}shutdown(){this.changeListener=null}}class zK{constructor(e){this.t=e,this.currentUser=Io.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,r){Jn(this.o===void 0);let c=this.i;const h=C=>this.i!==c?(c=this.i,r(C)):Promise.resolve();let x=new Od;this.o=()=>{this.i++,this.currentUser=this.u(),x.resolve(),x=new Od,e.enqueueRetryable(()=>h(this.currentUser))};const w=()=>{const C=x;e.enqueueRetryable(async()=>{await C.promise,await h(this.currentUser)})},o=C=>{nr("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=C,this.o&&(this.auth.addAuthTokenListener(this.o),w())};this.t.onInit(C=>o(C)),setTimeout(()=>{if(!this.auth){const C=this.t.getImmediate({optional:!0});C?o(C):(nr("FirebaseAuthCredentialsProvider","Auth not yet detected"),x.resolve(),x=new Od)}},0),w()}getToken(){const e=this.i,r=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(r).then(c=>this.i!==e?(nr("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):c?(Jn(typeof c.accessToken=="string"),new kB(c.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){const e=this.auth&&this.auth.getUid();return Jn(e===null||typeof e=="string"),new Io(e)}}class BK{constructor(e,r,c){this.l=e,this.h=r,this.P=c,this.type="FirstParty",this.user=Io.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);const e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class VK{constructor(e,r,c){this.l=e,this.h=r,this.P=c}getToken(){return Promise.resolve(new BK(this.l,this.h,this.P))}start(e,r){e.enqueueRetryable(()=>r(Io.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class UK{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class qK{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(e,r){Jn(this.o===void 0);const c=x=>{x.error!=null&&nr("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${x.error.message}`);const w=x.token!==this.R;return this.R=x.token,nr("FirebaseAppCheckTokenProvider",`Received ${w?"new":"existing"} token.`),w?r(x.token):Promise.resolve()};this.o=x=>{e.enqueueRetryable(()=>c(x))};const h=x=>{nr("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=x,this.o&&this.appCheck.addTokenListener(this.o)};this.A.onInit(x=>h(x)),setTimeout(()=>{if(!this.appCheck){const x=this.A.getImmediate({optional:!0});x?h(x):nr("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(r=>r?(Jn(typeof r.token=="string"),this.R=r.token,new UK(r.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function $K(t){const e=typeof self<"u"&&(self.crypto||self.msCrypto),r=new Uint8Array(t);if(e&&typeof e.getRandomValues=="function")e.getRandomValues(r);else for(let c=0;c<t;c++)r[c]=Math.floor(256*Math.random());return r}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class DB{static newId(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r=Math.floor(256/e.length)*e.length;let c="";for(;c.length<20;){const h=$K(40);for(let x=0;x<h.length;++x)c.length<20&&h[x]<r&&(c+=e.charAt(h[x]%e.length))}return c}}function Fn(t,e){return t<e?-1:t>e?1:0}function ky(t,e,r){return t.length===e.length&&t.every((c,h)=>r(c,e[h]))}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class sa{constructor(e,r){if(this.seconds=e,this.nanoseconds=r,r<0)throw new Wi(ti.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+r);if(r>=1e9)throw new Wi(ti.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+r);if(e<-62135596800)throw new Wi(ti.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new Wi(ti.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return sa.fromMillis(Date.now())}static fromDate(e){return sa.fromMillis(e.getTime())}static fromMillis(e){const r=Math.floor(e/1e3),c=Math.floor(1e6*(e-1e3*r));return new sa(r,c)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?Fn(this.nanoseconds,e.nanoseconds):Fn(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Gr{constructor(e){this.timestamp=e}static fromTimestamp(e){return new Gr(e)}static min(){return new Gr(new sa(0,0))}static max(){return new Gr(new sa(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Sv{constructor(e,r,c){r===void 0?r=0:r>e.length&&zr(),c===void 0?c=e.length-r:c>e.length-r&&zr(),this.segments=e,this.offset=r,this.len=c}get length(){return this.len}isEqual(e){return Sv.comparator(this,e)===0}child(e){const r=this.segments.slice(this.offset,this.limit());return e instanceof Sv?e.forEach(c=>{r.push(c)}):r.push(e),this.construct(r)}limit(){return this.offset+this.length}popFirst(e){return e=e===void 0?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return this.length===0}isPrefixOf(e){if(e.length<this.length)return!1;for(let r=0;r<this.length;r++)if(this.get(r)!==e.get(r))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let r=0;r<this.length;r++)if(this.get(r)!==e.get(r))return!1;return!0}forEach(e){for(let r=this.offset,c=this.limit();r<c;r++)e(this.segments[r])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,r){const c=Math.min(e.length,r.length);for(let h=0;h<c;h++){const x=e.get(h),w=r.get(h);if(x<w)return-1;if(x>w)return 1}return e.length<r.length?-1:e.length>r.length?1:0}}class Ss extends Sv{construct(e,r,c){return new Ss(e,r,c)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){const r=[];for(const c of e){if(c.indexOf("//")>=0)throw new Wi(ti.INVALID_ARGUMENT,`Invalid segment (${c}). Paths must not contain // in them.`);r.push(...c.split("/").filter(h=>h.length>0))}return new Ss(r)}static emptyPath(){return new Ss([])}}const GK=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class co extends Sv{construct(e,r,c){return new co(e,r,c)}static isValidIdentifier(e){return GK.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),co.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return this.length===1&&this.get(0)==="__name__"}static keyField(){return new co(["__name__"])}static fromServerFormat(e){const r=[];let c="",h=0;const x=()=>{if(c.length===0)throw new Wi(ti.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);r.push(c),c=""};let w=!1;for(;h<e.length;){const o=e[h];if(o==="\\"){if(h+1===e.length)throw new Wi(ti.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const C=e[h+1];if(C!=="\\"&&C!=="."&&C!=="`")throw new Wi(ti.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);c+=C,h+=2}else o==="`"?(w=!w,h++):o!=="."||w?(c+=o,h++):(x(),h++)}if(x(),w)throw new Wi(ti.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new co(r)}static emptyPath(){return new co([])}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class xr{constructor(e){this.path=e}static fromPath(e){return new xr(Ss.fromString(e))}static fromName(e){return new xr(Ss.fromString(e).popFirst(5))}static empty(){return new xr(Ss.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return e!==null&&Ss.comparator(this.path,e.path)===0}toString(){return this.path.toString()}static comparator(e,r){return Ss.comparator(e.path,r.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new xr(new Ss(e.slice()))}}function HK(t,e){const r=t.toTimestamp().seconds,c=t.toTimestamp().nanoseconds+1,h=Gr.fromTimestamp(c===1e9?new sa(r+1,0):new sa(r,c));return new Sp(h,xr.empty(),e)}function WK(t){return new Sp(t.readTime,t.key,-1)}class Sp{constructor(e,r,c){this.readTime=e,this.documentKey=r,this.largestBatchId=c}static min(){return new Sp(Gr.min(),xr.empty(),-1)}static max(){return new Sp(Gr.max(),xr.empty(),-1)}}function ZK(t,e){let r=t.readTime.compareTo(e.readTime);return r!==0?r:(r=xr.comparator(t.documentKey,e.documentKey),r!==0?r:Fn(t.largestBatchId,e.largestBatchId))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const XK="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class YK{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function Wv(t){if(t.code!==ti.FAILED_PRECONDITION||t.message!==XK)throw t;nr("LocalStore","Unexpectedly lost primary lease")}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class pi{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(r=>{this.isDone=!0,this.result=r,this.nextCallback&&this.nextCallback(r)},r=>{this.isDone=!0,this.error=r,this.catchCallback&&this.catchCallback(r)})}catch(e){return this.next(void 0,e)}next(e,r){return this.callbackAttached&&zr(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(r,this.error):this.wrapSuccess(e,this.result):new pi((c,h)=>{this.nextCallback=x=>{this.wrapSuccess(e,x).next(c,h)},this.catchCallback=x=>{this.wrapFailure(r,x).next(c,h)}})}toPromise(){return new Promise((e,r)=>{this.next(e,r)})}wrapUserFunction(e){try{const r=e();return r instanceof pi?r:pi.resolve(r)}catch(r){return pi.reject(r)}}wrapSuccess(e,r){return e?this.wrapUserFunction(()=>e(r)):pi.resolve(r)}wrapFailure(e,r){return e?this.wrapUserFunction(()=>e(r)):pi.reject(r)}static resolve(e){return new pi((r,c)=>{r(e)})}static reject(e){return new pi((r,c)=>{c(e)})}static waitFor(e){return new pi((r,c)=>{let h=0,x=0,w=!1;e.forEach(o=>{++h,o.next(()=>{++x,w&&x===h&&r()},C=>c(C))}),w=!0,x===h&&r()})}static or(e){let r=pi.resolve(!1);for(const c of e)r=r.next(h=>h?pi.resolve(h):c());return r}static forEach(e,r){const c=[];return e.forEach((h,x)=>{c.push(r.call(this,h,x))}),this.waitFor(c)}static mapArray(e,r){return new pi((c,h)=>{const x=e.length,w=new Array(x);let o=0;for(let C=0;C<x;C++){const R=C;r(e[R]).next(F=>{w[R]=F,++o,o===x&&c(w)},F=>h(F))}})}static doWhile(e,r){return new pi((c,h)=>{const x=()=>{e()===!0?r().next(()=>{x()},h):c()};x()})}}function KK(t){const e=t.match(/Android ([\d.]+)/i),r=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(r)}function Zv(t){return t.name==="IndexedDbTransactionError"}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class BP{constructor(e,r){this.previousValue=e,r&&(r.sequenceNumberHandler=c=>this.ie(c),this.se=c=>r.writeSequenceNumber(c))}ie(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this.se&&this.se(e),e}}BP.oe=-1;function tT(t){return t==null}function oS(t){return t===0&&1/t==-1/0}function QK(t){return typeof t=="number"&&Number.isInteger(t)&&!oS(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function d4(t){let e=0;for(const r in t)Object.prototype.hasOwnProperty.call(t,r)&&e++;return e}function xf(t,e){for(const r in t)Object.prototype.hasOwnProperty.call(t,r)&&e(r,t[r])}function MB(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ws{constructor(e,r){this.comparator=e,this.root=r||lo.EMPTY}insert(e,r){return new Ws(this.comparator,this.root.insert(e,r,this.comparator).copy(null,null,lo.BLACK,null,null))}remove(e){return new Ws(this.comparator,this.root.remove(e,this.comparator).copy(null,null,lo.BLACK,null,null))}get(e){let r=this.root;for(;!r.isEmpty();){const c=this.comparator(e,r.key);if(c===0)return r.value;c<0?r=r.left:c>0&&(r=r.right)}return null}indexOf(e){let r=0,c=this.root;for(;!c.isEmpty();){const h=this.comparator(e,c.key);if(h===0)return r+c.left.size;h<0?c=c.left:(r+=c.left.size+1,c=c.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((r,c)=>(e(r,c),!1))}toString(){const e=[];return this.inorderTraversal((r,c)=>(e.push(`${r}:${c}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new Fw(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new Fw(this.root,e,this.comparator,!1)}getReverseIterator(){return new Fw(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new Fw(this.root,e,this.comparator,!0)}}class Fw{constructor(e,r,c,h){this.isReverse=h,this.nodeStack=[];let x=1;for(;!e.isEmpty();)if(x=r?c(e.key,r):1,r&&h&&(x*=-1),x<0)e=this.isReverse?e.left:e.right;else{if(x===0){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const r={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return r}hasNext(){return this.nodeStack.length>0}peek(){if(this.nodeStack.length===0)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class lo{constructor(e,r,c,h,x){this.key=e,this.value=r,this.color=c??lo.RED,this.left=h??lo.EMPTY,this.right=x??lo.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,r,c,h,x){return new lo(e??this.key,r??this.value,c??this.color,h??this.left,x??this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,r,c){let h=this;const x=c(e,h.key);return h=x<0?h.copy(null,null,null,h.left.insert(e,r,c),null):x===0?h.copy(null,r,null,null,null):h.copy(null,null,null,null,h.right.insert(e,r,c)),h.fixUp()}removeMin(){if(this.left.isEmpty())return lo.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,r){let c,h=this;if(r(e,h.key)<0)h.left.isEmpty()||h.left.isRed()||h.left.left.isRed()||(h=h.moveRedLeft()),h=h.copy(null,null,null,h.left.remove(e,r),null);else{if(h.left.isRed()&&(h=h.rotateRight()),h.right.isEmpty()||h.right.isRed()||h.right.left.isRed()||(h=h.moveRedRight()),r(e,h.key)===0){if(h.right.isEmpty())return lo.EMPTY;c=h.right.min(),h=h.copy(c.key,c.value,null,null,h.right.removeMin())}h=h.copy(null,null,null,null,h.right.remove(e,r))}return h.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,lo.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,lo.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),r=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,r)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw zr();const e=this.left.check();if(e!==this.right.check())throw zr();return e+(this.isRed()?0:1)}}lo.EMPTY=null,lo.RED=!0,lo.BLACK=!1;lo.EMPTY=new class{constructor(){this.size=0}get key(){throw zr()}get value(){throw zr()}get color(){throw zr()}get left(){throw zr()}get right(){throw zr()}copy(e,r,c,h,x){return this}insert(e,r,c){return new lo(e,r)}remove(e,r){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ho{constructor(e){this.comparator=e,this.data=new Ws(this.comparator)}has(e){return this.data.get(e)!==null}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((r,c)=>(e(r),!1))}forEachInRange(e,r){const c=this.data.getIteratorFrom(e[0]);for(;c.hasNext();){const h=c.getNext();if(this.comparator(h.key,e[1])>=0)return;r(h.key)}}forEachWhile(e,r){let c;for(c=r!==void 0?this.data.getIteratorFrom(r):this.data.getIterator();c.hasNext();)if(!e(c.getNext().key))return}firstAfterOrEqual(e){const r=this.data.getIteratorFrom(e);return r.hasNext()?r.getNext().key:null}getIterator(){return new h4(this.data.getIterator())}getIteratorFrom(e){return new h4(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let r=this;return r.size<e.size&&(r=e,e=this),e.forEach(c=>{r=r.add(c)}),r}isEqual(e){if(!(e instanceof ho)||this.size!==e.size)return!1;const r=this.data.getIterator(),c=e.data.getIterator();for(;r.hasNext();){const h=r.getNext().key,x=c.getNext().key;if(this.comparator(h,x)!==0)return!1}return!0}toArray(){const e=[];return this.forEach(r=>{e.push(r)}),e}toString(){const e=[];return this.forEach(r=>e.push(r)),"SortedSet("+e.toString()+")"}copy(e){const r=new ho(this.comparator);return r.data=e,r}}class h4{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ml{constructor(e){this.fields=e,e.sort(co.comparator)}static empty(){return new Ml([])}unionWith(e){let r=new ho(co.comparator);for(const c of this.fields)r=r.add(c);for(const c of e)r=r.add(c);return new Ml(r.toArray())}covers(e){for(const r of this.fields)if(r.isPrefixOf(e))return!0;return!1}isEqual(e){return ky(this.fields,e.fields,(r,c)=>r.isEqual(c))}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class OB extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class fo{constructor(e){this.binaryString=e}static fromBase64String(e){const r=function(h){try{return atob(h)}catch(x){throw typeof DOMException<"u"&&x instanceof DOMException?new OB("Invalid base64 string: "+x):x}}(e);return new fo(r)}static fromUint8Array(e){const r=function(h){let x="";for(let w=0;w<h.length;++w)x+=String.fromCharCode(h[w]);return x}(e);return new fo(r)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return function(r){return btoa(r)}(this.binaryString)}toUint8Array(){return function(r){const c=new Uint8Array(r.length);for(let h=0;h<r.length;h++)c[h]=r.charCodeAt(h);return c}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return Fn(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}fo.EMPTY_BYTE_STRING=new fo("");const JK=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Tp(t){if(Jn(!!t),typeof t=="string"){let e=0;const r=JK.exec(t);if(Jn(!!r),r[1]){let h=r[1];h=(h+"000000000").substr(0,9),e=Number(h)}const c=new Date(t);return{seconds:Math.floor(c.getTime()/1e3),nanos:e}}return{seconds:da(t.seconds),nanos:da(t.nanos)}}function da(t){return typeof t=="number"?t:typeof t=="string"?Number(t):0}function sf(t){return typeof t=="string"?fo.fromBase64String(t):fo.fromUint8Array(t)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function VP(t){var e,r;return((r=(((e=t==null?void 0:t.mapValue)===null||e===void 0?void 0:e.fields)||{}).__type__)===null||r===void 0?void 0:r.stringValue)==="server_timestamp"}function UP(t){const e=t.mapValue.fields.__previous_value__;return VP(e)?UP(e):e}function Tv(t){const e=Tp(t.mapValue.fields.__local_write_time__.timestampValue);return new sa(e.seconds,e.nanos)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class eQ{constructor(e,r,c,h,x,w,o,C,R){this.databaseId=e,this.appId=r,this.persistenceKey=c,this.host=h,this.ssl=x,this.forceLongPolling=w,this.autoDetectLongPolling=o,this.longPollingOptions=C,this.useFetchStreams=R}}class Nv{constructor(e,r){this.projectId=e,this.database=r||"(default)"}static empty(){return new Nv("","")}get isDefaultDatabase(){return this.database==="(default)"}isEqual(e){return e instanceof Nv&&e.projectId===this.projectId&&e.database===this.database}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const zw={mapValue:{}};function af(t){return"nullValue"in t?0:"booleanValue"in t?1:"integerValue"in t||"doubleValue"in t?2:"timestampValue"in t?3:"stringValue"in t?5:"bytesValue"in t?6:"referenceValue"in t?7:"geoPointValue"in t?8:"arrayValue"in t?9:"mapValue"in t?VP(t)?4:iQ(t)?9007199254740991:tQ(t)?10:11:zr()}function Hu(t,e){if(t===e)return!0;const r=af(t);if(r!==af(e))return!1;switch(r){case 0:case 9007199254740991:return!0;case 1:return t.booleanValue===e.booleanValue;case 4:return Tv(t).isEqual(Tv(e));case 3:return function(h,x){if(typeof h.timestampValue=="string"&&typeof x.timestampValue=="string"&&h.timestampValue.length===x.timestampValue.length)return h.timestampValue===x.timestampValue;const w=Tp(h.timestampValue),o=Tp(x.timestampValue);return w.seconds===o.seconds&&w.nanos===o.nanos}(t,e);case 5:return t.stringValue===e.stringValue;case 6:return function(h,x){return sf(h.bytesValue).isEqual(sf(x.bytesValue))}(t,e);case 7:return t.referenceValue===e.referenceValue;case 8:return function(h,x){return da(h.geoPointValue.latitude)===da(x.geoPointValue.latitude)&&da(h.geoPointValue.longitude)===da(x.geoPointValue.longitude)}(t,e);case 2:return function(h,x){if("integerValue"in h&&"integerValue"in x)return da(h.integerValue)===da(x.integerValue);if("doubleValue"in h&&"doubleValue"in x){const w=da(h.doubleValue),o=da(x.doubleValue);return w===o?oS(w)===oS(o):isNaN(w)&&isNaN(o)}return!1}(t,e);case 9:return ky(t.arrayValue.values||[],e.arrayValue.values||[],Hu);case 10:case 11:return function(h,x){const w=h.mapValue.fields||{},o=x.mapValue.fields||{};if(d4(w)!==d4(o))return!1;for(const C in w)if(w.hasOwnProperty(C)&&(o[C]===void 0||!Hu(w[C],o[C])))return!1;return!0}(t,e);default:return zr()}}function Av(t,e){return(t.values||[]).find(r=>Hu(r,e))!==void 0}function Dy(t,e){if(t===e)return 0;const r=af(t),c=af(e);if(r!==c)return Fn(r,c);switch(r){case 0:case 9007199254740991:return 0;case 1:return Fn(t.booleanValue,e.booleanValue);case 2:return function(x,w){const o=da(x.integerValue||x.doubleValue),C=da(w.integerValue||w.doubleValue);return o<C?-1:o>C?1:o===C?0:isNaN(o)?isNaN(C)?0:-1:1}(t,e);case 3:return p4(t.timestampValue,e.timestampValue);case 4:return p4(Tv(t),Tv(e));case 5:return Fn(t.stringValue,e.stringValue);case 6:return function(x,w){const o=sf(x),C=sf(w);return o.compareTo(C)}(t.bytesValue,e.bytesValue);case 7:return function(x,w){const o=x.split("/"),C=w.split("/");for(let R=0;R<o.length&&R<C.length;R++){const F=Fn(o[R],C[R]);if(F!==0)return F}return Fn(o.length,C.length)}(t.referenceValue,e.referenceValue);case 8:return function(x,w){const o=Fn(da(x.latitude),da(w.latitude));return o!==0?o:Fn(da(x.longitude),da(w.longitude))}(t.geoPointValue,e.geoPointValue);case 9:return m4(t.arrayValue,e.arrayValue);case 10:return function(x,w){var o,C,R,F;const $=x.fields||{},Y=w.fields||{},H=(o=$.value)===null||o===void 0?void 0:o.arrayValue,X=(C=Y.value)===null||C===void 0?void 0:C.arrayValue,he=Fn(((R=H==null?void 0:H.values)===null||R===void 0?void 0:R.length)||0,((F=X==null?void 0:X.values)===null||F===void 0?void 0:F.length)||0);return he!==0?he:m4(H,X)}(t.mapValue,e.mapValue);case 11:return function(x,w){if(x===zw.mapValue&&w===zw.mapValue)return 0;if(x===zw.mapValue)return 1;if(w===zw.mapValue)return-1;const o=x.fields||{},C=Object.keys(o),R=w.fields||{},F=Object.keys(R);C.sort(),F.sort();for(let $=0;$<C.length&&$<F.length;++$){const Y=Fn(C[$],F[$]);if(Y!==0)return Y;const H=Dy(o[C[$]],R[F[$]]);if(H!==0)return H}return Fn(C.length,F.length)}(t.mapValue,e.mapValue);default:throw zr()}}function p4(t,e){if(typeof t=="string"&&typeof e=="string"&&t.length===e.length)return Fn(t,e);const r=Tp(t),c=Tp(e),h=Fn(r.seconds,c.seconds);return h!==0?h:Fn(r.nanos,c.nanos)}function m4(t,e){const r=t.values||[],c=e.values||[];for(let h=0;h<r.length&&h<c.length;++h){const x=Dy(r[h],c[h]);if(x)return x}return Fn(r.length,c.length)}function My(t){return XE(t)}function XE(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(r){const c=Tp(r);return`time(${c.seconds},${c.nanos})`}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?function(r){return sf(r).toBase64()}(t.bytesValue):"referenceValue"in t?function(r){return xr.fromName(r).toString()}(t.referenceValue):"geoPointValue"in t?function(r){return`geo(${r.latitude},${r.longitude})`}(t.geoPointValue):"arrayValue"in t?function(r){let c="[",h=!0;for(const x of r.values||[])h?h=!1:c+=",",c+=XE(x);return c+"]"}(t.arrayValue):"mapValue"in t?function(r){const c=Object.keys(r.fields||{}).sort();let h="{",x=!0;for(const w of c)x?x=!1:h+=",",h+=`${w}:${XE(r.fields[w])}`;return h+"}"}(t.mapValue):zr()}function f4(t,e){return{referenceValue:`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`}}function YE(t){return!!t&&"integerValue"in t}function qP(t){return!!t&&"arrayValue"in t}function g4(t){return!!t&&"nullValue"in t}function y4(t){return!!t&&"doubleValue"in t&&isNaN(Number(t.doubleValue))}function f2(t){return!!t&&"mapValue"in t}function tQ(t){var e,r;return((r=(((e=t==null?void 0:t.mapValue)===null||e===void 0?void 0:e.fields)||{}).__type__)===null||r===void 0?void 0:r.stringValue)==="__vector__"}function W0(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&typeof t.timestampValue=="object")return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const e={mapValue:{fields:{}}};return xf(t.mapValue.fields,(r,c)=>e.mapValue.fields[r]=W0(c)),e}if(t.arrayValue){const e={arrayValue:{values:[]}};for(let r=0;r<(t.arrayValue.values||[]).length;++r)e.arrayValue.values[r]=W0(t.arrayValue.values[r]);return e}return Object.assign({},t)}function iQ(t){return(((t.mapValue||{}).fields||{}).__type__||{}).stringValue==="__max__"}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class gl{constructor(e){this.value=e}static empty(){return new gl({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let r=this.value;for(let c=0;c<e.length-1;++c)if(r=(r.mapValue.fields||{})[e.get(c)],!f2(r))return null;return r=(r.mapValue.fields||{})[e.lastSegment()],r||null}}set(e,r){this.getFieldsMap(e.popLast())[e.lastSegment()]=W0(r)}setAll(e){let r=co.emptyPath(),c={},h=[];e.forEach((w,o)=>{if(!r.isImmediateParentOf(o)){const C=this.getFieldsMap(r);this.applyChanges(C,c,h),c={},h=[],r=o.popLast()}w?c[o.lastSegment()]=W0(w):h.push(o.lastSegment())});const x=this.getFieldsMap(r);this.applyChanges(x,c,h)}delete(e){const r=this.field(e.popLast());f2(r)&&r.mapValue.fields&&delete r.mapValue.fields[e.lastSegment()]}isEqual(e){return Hu(this.value,e.value)}getFieldsMap(e){let r=this.value;r.mapValue.fields||(r.mapValue={fields:{}});for(let c=0;c<e.length;++c){let h=r.mapValue.fields[e.get(c)];f2(h)&&h.mapValue.fields||(h={mapValue:{fields:{}}},r.mapValue.fields[e.get(c)]=h),r=h}return r.mapValue.fields}applyChanges(e,r,c){xf(r,(h,x)=>e[h]=x);for(const h of c)delete e[h]}clone(){return new gl(W0(this.value))}}function LB(t){const e=[];return xf(t.fields,(r,c)=>{const h=new co([r]);if(f2(c)){const x=LB(c.mapValue).fields;if(x.length===0)e.push(h);else for(const w of x)e.push(h.child(w))}else e.push(h)}),new Ml(e)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class jo{constructor(e,r,c,h,x,w,o){this.key=e,this.documentType=r,this.version=c,this.readTime=h,this.createTime=x,this.data=w,this.documentState=o}static newInvalidDocument(e){return new jo(e,0,Gr.min(),Gr.min(),Gr.min(),gl.empty(),0)}static newFoundDocument(e,r,c,h){return new jo(e,1,r,Gr.min(),c,h,0)}static newNoDocument(e,r){return new jo(e,2,r,Gr.min(),Gr.min(),gl.empty(),0)}static newUnknownDocument(e,r){return new jo(e,3,r,Gr.min(),Gr.min(),gl.empty(),2)}convertToFoundDocument(e,r){return!this.createTime.isEqual(Gr.min())||this.documentType!==2&&this.documentType!==0||(this.createTime=e),this.version=e,this.documentType=1,this.data=r,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=gl.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=gl.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=Gr.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return this.documentState===1}get hasCommittedMutations(){return this.documentState===2}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return this.documentType!==0}isFoundDocument(){return this.documentType===1}isNoDocument(){return this.documentType===2}isUnknownDocument(){return this.documentType===3}isEqual(e){return e instanceof jo&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new jo(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class lS{constructor(e,r){this.position=e,this.inclusive=r}}function x4(t,e,r){let c=0;for(let h=0;h<t.position.length;h++){const x=e[h],w=t.position[h];if(x.field.isKeyField()?c=xr.comparator(xr.fromName(w.referenceValue),r.key):c=Dy(w,r.data.field(x.field)),x.dir==="desc"&&(c*=-1),c!==0)break}return c}function _4(t,e){if(t===null)return e===null;if(e===null||t.inclusive!==e.inclusive||t.position.length!==e.position.length)return!1;for(let r=0;r<t.position.length;r++)if(!Hu(t.position[r],e.position[r]))return!1;return!0}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Cv{constructor(e,r="asc"){this.field=e,this.dir=r}}function rQ(t,e){return t.dir===e.dir&&t.field.isEqual(e.field)}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class FB{}class Aa extends FB{constructor(e,r,c){super(),this.field=e,this.op=r,this.value=c}static create(e,r,c){return e.isKeyField()?r==="in"||r==="not-in"?this.createKeyFieldInFilter(e,r,c):new sQ(e,r,c):r==="array-contains"?new lQ(e,c):r==="in"?new cQ(e,c):r==="not-in"?new uQ(e,c):r==="array-contains-any"?new dQ(e,c):new Aa(e,r,c)}static createKeyFieldInFilter(e,r,c){return r==="in"?new aQ(e,c):new oQ(e,c)}matches(e){const r=e.data.field(this.field);return this.op==="!="?r!==null&&this.matchesComparison(Dy(r,this.value)):r!==null&&af(this.value)===af(r)&&this.matchesComparison(Dy(r,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return e===0;case"!=":return e!==0;case">":return e>0;case">=":return e>=0;default:return zr()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class Yc extends FB{constructor(e,r){super(),this.filters=e,this.op=r,this.ae=null}static create(e,r){return new Yc(e,r)}matches(e){return zB(this)?this.filters.find(r=>!r.matches(e))===void 0:this.filters.find(r=>r.matches(e))!==void 0}getFlattenedFilters(){return this.ae!==null||(this.ae=this.filters.reduce((e,r)=>e.concat(r.getFlattenedFilters()),[])),this.ae}getFilters(){return Object.assign([],this.filters)}}function zB(t){return t.op==="and"}function BB(t){return nQ(t)&&zB(t)}function nQ(t){for(const e of t.filters)if(e instanceof Yc)return!1;return!0}function KE(t){if(t instanceof Aa)return t.field.canonicalString()+t.op.toString()+My(t.value);if(BB(t))return t.filters.map(e=>KE(e)).join(",");{const e=t.filters.map(r=>KE(r)).join(",");return`${t.op}(${e})`}}function VB(t,e){return t instanceof Aa?function(c,h){return h instanceof Aa&&c.op===h.op&&c.field.isEqual(h.field)&&Hu(c.value,h.value)}(t,e):t instanceof Yc?function(c,h){return h instanceof Yc&&c.op===h.op&&c.filters.length===h.filters.length?c.filters.reduce((x,w,o)=>x&&VB(w,h.filters[o]),!0):!1}(t,e):void zr()}function UB(t){return t instanceof Aa?function(r){return`${r.field.canonicalString()} ${r.op} ${My(r.value)}`}(t):t instanceof Yc?function(r){return r.op.toString()+" {"+r.getFilters().map(UB).join(" ,")+"}"}(t):"Filter"}class sQ extends Aa{constructor(e,r,c){super(e,r,c),this.key=xr.fromName(c.referenceValue)}matches(e){const r=xr.comparator(e.key,this.key);return this.matchesComparison(r)}}class aQ extends Aa{constructor(e,r){super(e,"in",r),this.keys=qB("in",r)}matches(e){return this.keys.some(r=>r.isEqual(e.key))}}class oQ extends Aa{constructor(e,r){super(e,"not-in",r),this.keys=qB("not-in",r)}matches(e){return!this.keys.some(r=>r.isEqual(e.key))}}function qB(t,e){var r;return(((r=e.arrayValue)===null||r===void 0?void 0:r.values)||[]).map(c=>xr.fromName(c.referenceValue))}class lQ extends Aa{constructor(e,r){super(e,"array-contains",r)}matches(e){const r=e.data.field(this.field);return qP(r)&&Av(r.arrayValue,this.value)}}class cQ extends Aa{constructor(e,r){super(e,"in",r)}matches(e){const r=e.data.field(this.field);return r!==null&&Av(this.value.arrayValue,r)}}class uQ extends Aa{constructor(e,r){super(e,"not-in",r)}matches(e){if(Av(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const r=e.data.field(this.field);return r!==null&&!Av(this.value.arrayValue,r)}}class dQ extends Aa{constructor(e,r){super(e,"array-contains-any",r)}matches(e){const r=e.data.field(this.field);return!(!qP(r)||!r.arrayValue.values)&&r.arrayValue.values.some(c=>Av(this.value.arrayValue,c))}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class hQ{constructor(e,r=null,c=[],h=[],x=null,w=null,o=null){this.path=e,this.collectionGroup=r,this.orderBy=c,this.filters=h,this.limit=x,this.startAt=w,this.endAt=o,this.ue=null}}function v4(t,e=null,r=[],c=[],h=null,x=null,w=null){return new hQ(t,e,r,c,h,x,w)}function $P(t){const e=Hr(t);if(e.ue===null){let r=e.path.canonicalString();e.collectionGroup!==null&&(r+="|cg:"+e.collectionGroup),r+="|f:",r+=e.filters.map(c=>KE(c)).join(","),r+="|ob:",r+=e.orderBy.map(c=>function(x){return x.field.canonicalString()+x.dir}(c)).join(","),tT(e.limit)||(r+="|l:",r+=e.limit),e.startAt&&(r+="|lb:",r+=e.startAt.inclusive?"b:":"a:",r+=e.startAt.position.map(c=>My(c)).join(",")),e.endAt&&(r+="|ub:",r+=e.endAt.inclusive?"a:":"b:",r+=e.endAt.position.map(c=>My(c)).join(",")),e.ue=r}return e.ue}function GP(t,e){if(t.limit!==e.limit||t.orderBy.length!==e.orderBy.length)return!1;for(let r=0;r<t.orderBy.length;r++)if(!rQ(t.orderBy[r],e.orderBy[r]))return!1;if(t.filters.length!==e.filters.length)return!1;for(let r=0;r<t.filters.length;r++)if(!VB(t.filters[r],e.filters[r]))return!1;return t.collectionGroup===e.collectionGroup&&!!t.path.isEqual(e.path)&&!!_4(t.startAt,e.startAt)&&_4(t.endAt,e.endAt)}function QE(t){return xr.isDocumentKey(t.path)&&t.collectionGroup===null&&t.filters.length===0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Xy{constructor(e,r=null,c=[],h=[],x=null,w="F",o=null,C=null){this.path=e,this.collectionGroup=r,this.explicitOrderBy=c,this.filters=h,this.limit=x,this.limitType=w,this.startAt=o,this.endAt=C,this.ce=null,this.le=null,this.he=null,this.startAt,this.endAt}}function pQ(t,e,r,c,h,x,w,o){return new Xy(t,e,r,c,h,x,w,o)}function HP(t){return new Xy(t)}function b4(t){return t.filters.length===0&&t.limit===null&&t.startAt==null&&t.endAt==null&&(t.explicitOrderBy.length===0||t.explicitOrderBy.length===1&&t.explicitOrderBy[0].field.isKeyField())}function $B(t){return t.collectionGroup!==null}function Z0(t){const e=Hr(t);if(e.ce===null){e.ce=[];const r=new Set;for(const x of e.explicitOrderBy)e.ce.push(x),r.add(x.field.canonicalString());const c=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";(function(w){let o=new ho(co.comparator);return w.filters.forEach(C=>{C.getFlattenedFilters().forEach(R=>{R.isInequality()&&(o=o.add(R.field))})}),o})(e).forEach(x=>{r.has(x.canonicalString())||x.isKeyField()||e.ce.push(new Cv(x,c))}),r.has(co.keyField().canonicalString())||e.ce.push(new Cv(co.keyField(),c))}return e.ce}function $u(t){const e=Hr(t);return e.le||(e.le=mQ(e,Z0(t))),e.le}function mQ(t,e){if(t.limitType==="F")return v4(t.path,t.collectionGroup,e,t.filters,t.limit,t.startAt,t.endAt);{e=e.map(h=>{const x=h.dir==="desc"?"asc":"desc";return new Cv(h.field,x)});const r=t.endAt?new lS(t.endAt.position,t.endAt.inclusive):null,c=t.startAt?new lS(t.startAt.position,t.startAt.inclusive):null;return v4(t.path,t.collectionGroup,e,t.filters,t.limit,r,c)}}function JE(t,e){const r=t.filters.concat([e]);return new Xy(t.path,t.collectionGroup,t.explicitOrderBy.slice(),r,t.limit,t.limitType,t.startAt,t.endAt)}function cS(t,e,r){return new Xy(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),e,r,t.startAt,t.endAt)}function iT(t,e){return GP($u(t),$u(e))&&t.limitType===e.limitType}function GB(t){return`${$P($u(t))}|lt:${t.limitType}`}function Zg(t){return`Query(target=${function(r){let c=r.path.canonicalString();return r.collectionGroup!==null&&(c+=" collectionGroup="+r.collectionGroup),r.filters.length>0&&(c+=`, filters: [${r.filters.map(h=>UB(h)).join(", ")}]`),tT(r.limit)||(c+=", limit: "+r.limit),r.orderBy.length>0&&(c+=`, orderBy: [${r.orderBy.map(h=>function(w){return`${w.field.canonicalString()} (${w.dir})`}(h)).join(", ")}]`),r.startAt&&(c+=", startAt: ",c+=r.startAt.inclusive?"b:":"a:",c+=r.startAt.position.map(h=>My(h)).join(",")),r.endAt&&(c+=", endAt: ",c+=r.endAt.inclusive?"a:":"b:",c+=r.endAt.position.map(h=>My(h)).join(",")),`Target(${c})`}($u(t))}; limitType=${t.limitType})`}function rT(t,e){return e.isFoundDocument()&&function(c,h){const x=h.key.path;return c.collectionGroup!==null?h.key.hasCollectionId(c.collectionGroup)&&c.path.isPrefixOf(x):xr.isDocumentKey(c.path)?c.path.isEqual(x):c.path.isImmediateParentOf(x)}(t,e)&&function(c,h){for(const x of Z0(c))if(!x.field.isKeyField()&&h.data.field(x.field)===null)return!1;return!0}(t,e)&&function(c,h){for(const x of c.filters)if(!x.matches(h))return!1;return!0}(t,e)&&function(c,h){return!(c.startAt&&!function(w,o,C){const R=x4(w,o,C);return w.inclusive?R<=0:R<0}(c.startAt,Z0(c),h)||c.endAt&&!function(w,o,C){const R=x4(w,o,C);return w.inclusive?R>=0:R>0}(c.endAt,Z0(c),h))}(t,e)}function fQ(t){return t.collectionGroup||(t.path.length%2==1?t.path.lastSegment():t.path.get(t.path.length-2))}function HB(t){return(e,r)=>{let c=!1;for(const h of Z0(t)){const x=gQ(h,e,r);if(x!==0)return x;c=c||h.field.isKeyField()}return 0}}function gQ(t,e,r){const c=t.field.isKeyField()?xr.comparator(e.key,r.key):function(x,w,o){const C=w.data.field(x),R=o.data.field(x);return C!==null&&R!==null?Dy(C,R):zr()}(t.field,e,r);switch(t.dir){case"asc":return c;case"desc":return-1*c;default:return zr()}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Yy{constructor(e,r){this.mapKeyFn=e,this.equalsFn=r,this.inner={},this.innerSize=0}get(e){const r=this.mapKeyFn(e),c=this.inner[r];if(c!==void 0){for(const[h,x]of c)if(this.equalsFn(h,e))return x}}has(e){return this.get(e)!==void 0}set(e,r){const c=this.mapKeyFn(e),h=this.inner[c];if(h===void 0)return this.inner[c]=[[e,r]],void this.innerSize++;for(let x=0;x<h.length;x++)if(this.equalsFn(h[x][0],e))return void(h[x]=[e,r]);h.push([e,r]),this.innerSize++}delete(e){const r=this.mapKeyFn(e),c=this.inner[r];if(c===void 0)return!1;for(let h=0;h<c.length;h++)if(this.equalsFn(c[h][0],e))return c.length===1?delete this.inner[r]:c.splice(h,1),this.innerSize--,!0;return!1}forEach(e){xf(this.inner,(r,c)=>{for(const[h,x]of c)e(h,x)})}isEmpty(){return MB(this.inner)}size(){return this.innerSize}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const yQ=new Ws(xr.comparator);function Gd(){return yQ}const WB=new Ws(xr.comparator);function j0(...t){let e=WB;for(const r of t)e=e.insert(r.key,r);return e}function ZB(t){let e=WB;return t.forEach((r,c)=>e=e.insert(r,c.overlayedDocument)),e}function Um(){return X0()}function XB(){return X0()}function X0(){return new Yy(t=>t.toString(),(t,e)=>t.isEqual(e))}const xQ=new Ws(xr.comparator),_Q=new ho(xr.comparator);function mn(...t){let e=_Q;for(const r of t)e=e.add(r);return e}const vQ=new ho(Fn);function bQ(){return vQ}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function WP(t,e){if(t.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:oS(e)?"-0":e}}function YB(t){return{integerValue:""+t}}function wQ(t,e){return QK(e)?YB(e):WP(t,e)}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class nT{constructor(){this._=void 0}}function SQ(t,e,r){return t instanceof Ev?function(h,x){const w={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:h.seconds,nanos:h.nanoseconds}}}};return x&&VP(x)&&(x=UP(x)),x&&(w.fields.__previous_value__=x),{mapValue:w}}(r,e):t instanceof Iv?QB(t,e):t instanceof Pv?JB(t,e):function(h,x){const w=KB(h,x),o=w4(w)+w4(h.Pe);return YE(w)&&YE(h.Pe)?YB(o):WP(h.serializer,o)}(t,e)}function TQ(t,e,r){return t instanceof Iv?QB(t,e):t instanceof Pv?JB(t,e):r}function KB(t,e){return t instanceof uS?function(c){return YE(c)||function(x){return!!x&&"doubleValue"in x}(c)}(e)?e:{integerValue:0}:null}class Ev extends nT{}class Iv extends nT{constructor(e){super(),this.elements=e}}function QB(t,e){const r=eV(e);for(const c of t.elements)r.some(h=>Hu(h,c))||r.push(c);return{arrayValue:{values:r}}}class Pv extends nT{constructor(e){super(),this.elements=e}}function JB(t,e){let r=eV(e);for(const c of t.elements)r=r.filter(h=>!Hu(h,c));return{arrayValue:{values:r}}}class uS extends nT{constructor(e,r){super(),this.serializer=e,this.Pe=r}}function w4(t){return da(t.integerValue||t.doubleValue)}function eV(t){return qP(t)&&t.arrayValue.values?t.arrayValue.values.slice():[]}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class NQ{constructor(e,r){this.field=e,this.transform=r}}function AQ(t,e){return t.field.isEqual(e.field)&&function(c,h){return c instanceof Iv&&h instanceof Iv||c instanceof Pv&&h instanceof Pv?ky(c.elements,h.elements,Hu):c instanceof uS&&h instanceof uS?Hu(c.Pe,h.Pe):c instanceof Ev&&h instanceof Ev}(t.transform,e.transform)}class CQ{constructor(e,r){this.version=e,this.transformResults=r}}class yc{constructor(e,r){this.updateTime=e,this.exists=r}static none(){return new yc}static exists(e){return new yc(void 0,e)}static updateTime(e){return new yc(e)}get isNone(){return this.updateTime===void 0&&this.exists===void 0}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function g2(t,e){return t.updateTime!==void 0?e.isFoundDocument()&&e.version.isEqual(t.updateTime):t.exists===void 0||t.exists===e.isFoundDocument()}class sT{}function tV(t,e){if(!t.hasLocalMutations||e&&e.fields.length===0)return null;if(e===null)return t.isNoDocument()?new ZP(t.key,yc.none()):new Xv(t.key,t.data,yc.none());{const r=t.data,c=gl.empty();let h=new ho(co.comparator);for(let x of e.fields)if(!h.has(x)){let w=r.field(x);w===null&&x.length>1&&(x=x.popLast(),w=r.field(x)),w===null?c.delete(x):c.set(x,w),h=h.add(x)}return new kp(t.key,c,new Ml(h.toArray()),yc.none())}}function EQ(t,e,r){t instanceof Xv?function(h,x,w){const o=h.value.clone(),C=T4(h.fieldTransforms,x,w.transformResults);o.setAll(C),x.convertToFoundDocument(w.version,o).setHasCommittedMutations()}(t,e,r):t instanceof kp?function(h,x,w){if(!g2(h.precondition,x))return void x.convertToUnknownDocument(w.version);const o=T4(h.fieldTransforms,x,w.transformResults),C=x.data;C.setAll(iV(h)),C.setAll(o),x.convertToFoundDocument(w.version,C).setHasCommittedMutations()}(t,e,r):function(h,x,w){x.convertToNoDocument(w.version).setHasCommittedMutations()}(0,e,r)}function Y0(t,e,r,c){return t instanceof Xv?function(x,w,o,C){if(!g2(x.precondition,w))return o;const R=x.value.clone(),F=N4(x.fieldTransforms,C,w);return R.setAll(F),w.convertToFoundDocument(w.version,R).setHasLocalMutations(),null}(t,e,r,c):t instanceof kp?function(x,w,o,C){if(!g2(x.precondition,w))return o;const R=N4(x.fieldTransforms,C,w),F=w.data;return F.setAll(iV(x)),F.setAll(R),w.convertToFoundDocument(w.version,F).setHasLocalMutations(),o===null?null:o.unionWith(x.fieldMask.fields).unionWith(x.fieldTransforms.map($=>$.field))}(t,e,r,c):function(x,w,o){return g2(x.precondition,w)?(w.convertToNoDocument(w.version).setHasLocalMutations(),null):o}(t,e,r)}function IQ(t,e){let r=null;for(const c of t.fieldTransforms){const h=e.data.field(c.field),x=KB(c.transform,h||null);x!=null&&(r===null&&(r=gl.empty()),r.set(c.field,x))}return r||null}function S4(t,e){return t.type===e.type&&!!t.key.isEqual(e.key)&&!!t.precondition.isEqual(e.precondition)&&!!function(c,h){return c===void 0&&h===void 0||!(!c||!h)&&ky(c,h,(x,w)=>AQ(x,w))}(t.fieldTransforms,e.fieldTransforms)&&(t.type===0?t.value.isEqual(e.value):t.type!==1||t.data.isEqual(e.data)&&t.fieldMask.isEqual(e.fieldMask))}class Xv extends sT{constructor(e,r,c,h=[]){super(),this.key=e,this.value=r,this.precondition=c,this.fieldTransforms=h,this.type=0}getFieldMask(){return null}}class kp extends sT{constructor(e,r,c,h,x=[]){super(),this.key=e,this.data=r,this.fieldMask=c,this.precondition=h,this.fieldTransforms=x,this.type=1}getFieldMask(){return this.fieldMask}}function iV(t){const e=new Map;return t.fieldMask.fields.forEach(r=>{if(!r.isEmpty()){const c=t.data.field(r);e.set(r,c)}}),e}function T4(t,e,r){const c=new Map;Jn(t.length===r.length);for(let h=0;h<r.length;h++){const x=t[h],w=x.transform,o=e.data.field(x.field);c.set(x.field,TQ(w,o,r[h]))}return c}function N4(t,e,r){const c=new Map;for(const h of t){const x=h.transform,w=r.data.field(h.field);c.set(h.field,SQ(x,w,e))}return c}class ZP extends sT{constructor(e,r){super(),this.key=e,this.precondition=r,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class PQ extends sT{constructor(e,r){super(),this.key=e,this.precondition=r,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class jQ{constructor(e,r,c,h){this.batchId=e,this.localWriteTime=r,this.baseMutations=c,this.mutations=h}applyToRemoteDocument(e,r){const c=r.mutationResults;for(let h=0;h<this.mutations.length;h++){const x=this.mutations[h];x.key.isEqual(e.key)&&EQ(x,e,c[h])}}applyToLocalView(e,r){for(const c of this.baseMutations)c.key.isEqual(e.key)&&(r=Y0(c,e,r,this.localWriteTime));for(const c of this.mutations)c.key.isEqual(e.key)&&(r=Y0(c,e,r,this.localWriteTime));return r}applyToLocalDocumentSet(e,r){const c=XB();return this.mutations.forEach(h=>{const x=e.get(h.key),w=x.overlayedDocument;let o=this.applyToLocalView(w,x.mutatedFields);o=r.has(h.key)?null:o;const C=tV(w,o);C!==null&&c.set(h.key,C),w.isValidDocument()||w.convertToNoDocument(Gr.min())}),c}keys(){return this.mutations.reduce((e,r)=>e.add(r.key),mn())}isEqual(e){return this.batchId===e.batchId&&ky(this.mutations,e.mutations,(r,c)=>S4(r,c))&&ky(this.baseMutations,e.baseMutations,(r,c)=>S4(r,c))}}class XP{constructor(e,r,c,h){this.batch=e,this.commitVersion=r,this.mutationResults=c,this.docVersions=h}static from(e,r,c){Jn(e.mutations.length===c.length);let h=function(){return xQ}();const x=e.mutations;for(let w=0;w<x.length;w++)h=h.insert(x[w].key,c[w].version);return new XP(e,r,c,h)}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class RQ{constructor(e,r){this.largestBatchId=e,this.mutation=r}getKey(){return this.mutation.key}isEqual(e){return e!==null&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class kQ{constructor(e,r){this.count=e,this.unchangedNames=r}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Ta,En;function DQ(t){switch(t){default:return zr();case ti.CANCELLED:case ti.UNKNOWN:case ti.DEADLINE_EXCEEDED:case ti.RESOURCE_EXHAUSTED:case ti.INTERNAL:case ti.UNAVAILABLE:case ti.UNAUTHENTICATED:return!1;case ti.INVALID_ARGUMENT:case ti.NOT_FOUND:case ti.ALREADY_EXISTS:case ti.PERMISSION_DENIED:case ti.FAILED_PRECONDITION:case ti.ABORTED:case ti.OUT_OF_RANGE:case ti.UNIMPLEMENTED:case ti.DATA_LOSS:return!0}}function rV(t){if(t===void 0)return $d("GRPC error has no .code"),ti.UNKNOWN;switch(t){case Ta.OK:return ti.OK;case Ta.CANCELLED:return ti.CANCELLED;case Ta.UNKNOWN:return ti.UNKNOWN;case Ta.DEADLINE_EXCEEDED:return ti.DEADLINE_EXCEEDED;case Ta.RESOURCE_EXHAUSTED:return ti.RESOURCE_EXHAUSTED;case Ta.INTERNAL:return ti.INTERNAL;case Ta.UNAVAILABLE:return ti.UNAVAILABLE;case Ta.UNAUTHENTICATED:return ti.UNAUTHENTICATED;case Ta.INVALID_ARGUMENT:return ti.INVALID_ARGUMENT;case Ta.NOT_FOUND:return ti.NOT_FOUND;case Ta.ALREADY_EXISTS:return ti.ALREADY_EXISTS;case Ta.PERMISSION_DENIED:return ti.PERMISSION_DENIED;case Ta.FAILED_PRECONDITION:return ti.FAILED_PRECONDITION;case Ta.ABORTED:return ti.ABORTED;case Ta.OUT_OF_RANGE:return ti.OUT_OF_RANGE;case Ta.UNIMPLEMENTED:return ti.UNIMPLEMENTED;case Ta.DATA_LOSS:return ti.DATA_LOSS;default:return zr()}}(En=Ta||(Ta={}))[En.OK=0]="OK",En[En.CANCELLED=1]="CANCELLED",En[En.UNKNOWN=2]="UNKNOWN",En[En.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",En[En.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",En[En.NOT_FOUND=5]="NOT_FOUND",En[En.ALREADY_EXISTS=6]="ALREADY_EXISTS",En[En.PERMISSION_DENIED=7]="PERMISSION_DENIED",En[En.UNAUTHENTICATED=16]="UNAUTHENTICATED",En[En.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",En[En.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",En[En.ABORTED=10]="ABORTED",En[En.OUT_OF_RANGE=11]="OUT_OF_RANGE",En[En.UNIMPLEMENTED=12]="UNIMPLEMENTED",En[En.INTERNAL=13]="INTERNAL",En[En.UNAVAILABLE=14]="UNAVAILABLE",En[En.DATA_LOSS=15]="DATA_LOSS";/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function MQ(){return new TextEncoder}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const OQ=new Hm([4294967295,4294967295],0);function A4(t){const e=MQ().encode(t),r=new CB;return r.update(e),new Uint8Array(r.digest())}function C4(t){const e=new DataView(t.buffer),r=e.getUint32(0,!0),c=e.getUint32(4,!0),h=e.getUint32(8,!0),x=e.getUint32(12,!0);return[new Hm([r,c],0),new Hm([h,x],0)]}class YP{constructor(e,r,c){if(this.bitmap=e,this.padding=r,this.hashCount=c,r<0||r>=8)throw new R0(`Invalid padding: ${r}`);if(c<0)throw new R0(`Invalid hash count: ${c}`);if(e.length>0&&this.hashCount===0)throw new R0(`Invalid hash count: ${c}`);if(e.length===0&&r!==0)throw new R0(`Invalid padding when bitmap length is 0: ${r}`);this.Ie=8*e.length-r,this.Te=Hm.fromNumber(this.Ie)}Ee(e,r,c){let h=e.add(r.multiply(Hm.fromNumber(c)));return h.compare(OQ)===1&&(h=new Hm([h.getBits(0),h.getBits(1)],0)),h.modulo(this.Te).toNumber()}de(e){return(this.bitmap[Math.floor(e/8)]&1<<e%8)!=0}mightContain(e){if(this.Ie===0)return!1;const r=A4(e),[c,h]=C4(r);for(let x=0;x<this.hashCount;x++){const w=this.Ee(c,h,x);if(!this.de(w))return!1}return!0}static create(e,r,c){const h=e%8==0?0:8-e%8,x=new Uint8Array(Math.ceil(e/8)),w=new YP(x,h,r);return c.forEach(o=>w.insert(o)),w}insert(e){if(this.Ie===0)return;const r=A4(e),[c,h]=C4(r);for(let x=0;x<this.hashCount;x++){const w=this.Ee(c,h,x);this.Ae(w)}}Ae(e){const r=Math.floor(e/8),c=e%8;this.bitmap[r]|=1<<c}}class R0 extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class aT{constructor(e,r,c,h,x){this.snapshotVersion=e,this.targetChanges=r,this.targetMismatches=c,this.documentUpdates=h,this.resolvedLimboDocuments=x}static createSynthesizedRemoteEventForCurrentChange(e,r,c){const h=new Map;return h.set(e,Yv.createSynthesizedTargetChangeForCurrentChange(e,r,c)),new aT(Gr.min(),h,new Ws(Fn),Gd(),mn())}}class Yv{constructor(e,r,c,h,x){this.resumeToken=e,this.current=r,this.addedDocuments=c,this.modifiedDocuments=h,this.removedDocuments=x}static createSynthesizedTargetChangeForCurrentChange(e,r,c){return new Yv(c,r,mn(),mn(),mn())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class y2{constructor(e,r,c,h){this.Re=e,this.removedTargetIds=r,this.key=c,this.Ve=h}}class nV{constructor(e,r){this.targetId=e,this.me=r}}class sV{constructor(e,r,c=fo.EMPTY_BYTE_STRING,h=null){this.state=e,this.targetIds=r,this.resumeToken=c,this.cause=h}}class E4{constructor(){this.fe=0,this.ge=P4(),this.pe=fo.EMPTY_BYTE_STRING,this.ye=!1,this.we=!0}get current(){return this.ye}get resumeToken(){return this.pe}get Se(){return this.fe!==0}get be(){return this.we}De(e){e.approximateByteSize()>0&&(this.we=!0,this.pe=e)}ve(){let e=mn(),r=mn(),c=mn();return this.ge.forEach((h,x)=>{switch(x){case 0:e=e.add(h);break;case 2:r=r.add(h);break;case 1:c=c.add(h);break;default:zr()}}),new Yv(this.pe,this.ye,e,r,c)}Ce(){this.we=!1,this.ge=P4()}Fe(e,r){this.we=!0,this.ge=this.ge.insert(e,r)}Me(e){this.we=!0,this.ge=this.ge.remove(e)}xe(){this.fe+=1}Oe(){this.fe-=1,Jn(this.fe>=0)}Ne(){this.we=!0,this.ye=!0}}class LQ{constructor(e){this.Le=e,this.Be=new Map,this.ke=Gd(),this.qe=I4(),this.Qe=new Ws(Fn)}Ke(e){for(const r of e.Re)e.Ve&&e.Ve.isFoundDocument()?this.$e(r,e.Ve):this.Ue(r,e.key,e.Ve);for(const r of e.removedTargetIds)this.Ue(r,e.key,e.Ve)}We(e){this.forEachTarget(e,r=>{const c=this.Ge(r);switch(e.state){case 0:this.ze(r)&&c.De(e.resumeToken);break;case 1:c.Oe(),c.Se||c.Ce(),c.De(e.resumeToken);break;case 2:c.Oe(),c.Se||this.removeTarget(r);break;case 3:this.ze(r)&&(c.Ne(),c.De(e.resumeToken));break;case 4:this.ze(r)&&(this.je(r),c.De(e.resumeToken));break;default:zr()}})}forEachTarget(e,r){e.targetIds.length>0?e.targetIds.forEach(r):this.Be.forEach((c,h)=>{this.ze(h)&&r(h)})}He(e){const r=e.targetId,c=e.me.count,h=this.Je(r);if(h){const x=h.target;if(QE(x))if(c===0){const w=new xr(x.path);this.Ue(r,w,jo.newNoDocument(w,Gr.min()))}else Jn(c===1);else{const w=this.Ye(r);if(w!==c){const o=this.Ze(e),C=o?this.Xe(o,e,w):1;if(C!==0){this.je(r);const R=C===2?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Qe=this.Qe.insert(r,R)}}}}}Ze(e){const r=e.me.unchangedNames;if(!r||!r.bits)return null;const{bits:{bitmap:c="",padding:h=0},hashCount:x=0}=r;let w,o;try{w=sf(c).toUint8Array()}catch(C){if(C instanceof OB)return Ry("Decoding the base64 bloom filter in existence filter failed ("+C.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw C}try{o=new YP(w,h,x)}catch(C){return Ry(C instanceof R0?"BloomFilter error: ":"Applying bloom filter failed: ",C),null}return o.Ie===0?null:o}Xe(e,r,c){return r.me.count===c-this.nt(e,r.targetId)?0:2}nt(e,r){const c=this.Le.getRemoteKeysForTarget(r);let h=0;return c.forEach(x=>{const w=this.Le.tt(),o=`projects/${w.projectId}/databases/${w.database}/documents/${x.path.canonicalString()}`;e.mightContain(o)||(this.Ue(r,x,null),h++)}),h}rt(e){const r=new Map;this.Be.forEach((x,w)=>{const o=this.Je(w);if(o){if(x.current&&QE(o.target)){const C=new xr(o.target.path);this.ke.get(C)!==null||this.it(w,C)||this.Ue(w,C,jo.newNoDocument(C,e))}x.be&&(r.set(w,x.ve()),x.Ce())}});let c=mn();this.qe.forEach((x,w)=>{let o=!0;w.forEachWhile(C=>{const R=this.Je(C);return!R||R.purpose==="TargetPurposeLimboResolution"||(o=!1,!1)}),o&&(c=c.add(x))}),this.ke.forEach((x,w)=>w.setReadTime(e));const h=new aT(e,r,this.Qe,this.ke,c);return this.ke=Gd(),this.qe=I4(),this.Qe=new Ws(Fn),h}$e(e,r){if(!this.ze(e))return;const c=this.it(e,r.key)?2:0;this.Ge(e).Fe(r.key,c),this.ke=this.ke.insert(r.key,r),this.qe=this.qe.insert(r.key,this.st(r.key).add(e))}Ue(e,r,c){if(!this.ze(e))return;const h=this.Ge(e);this.it(e,r)?h.Fe(r,1):h.Me(r),this.qe=this.qe.insert(r,this.st(r).delete(e)),c&&(this.ke=this.ke.insert(r,c))}removeTarget(e){this.Be.delete(e)}Ye(e){const r=this.Ge(e).ve();return this.Le.getRemoteKeysForTarget(e).size+r.addedDocuments.size-r.removedDocuments.size}xe(e){this.Ge(e).xe()}Ge(e){let r=this.Be.get(e);return r||(r=new E4,this.Be.set(e,r)),r}st(e){let r=this.qe.get(e);return r||(r=new ho(Fn),this.qe=this.qe.insert(e,r)),r}ze(e){const r=this.Je(e)!==null;return r||nr("WatchChangeAggregator","Detected inactive target",e),r}Je(e){const r=this.Be.get(e);return r&&r.Se?null:this.Le.ot(e)}je(e){this.Be.set(e,new E4),this.Le.getRemoteKeysForTarget(e).forEach(r=>{this.Ue(e,r,null)})}it(e,r){return this.Le.getRemoteKeysForTarget(e).has(r)}}function I4(){return new Ws(xr.comparator)}function P4(){return new Ws(xr.comparator)}const FQ={asc:"ASCENDING",desc:"DESCENDING"},zQ={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},BQ={and:"AND",or:"OR"};class VQ{constructor(e,r){this.databaseId=e,this.useProto3Json=r}}function eI(t,e){return t.useProto3Json||tT(e)?e:{value:e}}function dS(t,e){return t.useProto3Json?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function aV(t,e){return t.useProto3Json?e.toBase64():e.toUint8Array()}function UQ(t,e){return dS(t,e.toTimestamp())}function Gu(t){return Jn(!!t),Gr.fromTimestamp(function(r){const c=Tp(r);return new sa(c.seconds,c.nanos)}(t))}function KP(t,e){return tI(t,e).canonicalString()}function tI(t,e){const r=function(h){return new Ss(["projects",h.projectId,"databases",h.database])}(t).child("documents");return e===void 0?r:r.child(e)}function oV(t){const e=Ss.fromString(t);return Jn(hV(e)),e}function iI(t,e){return KP(t.databaseId,e.path)}function EC(t,e){const r=oV(e);if(r.get(1)!==t.databaseId.projectId)throw new Wi(ti.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+r.get(1)+" vs "+t.databaseId.projectId);if(r.get(3)!==t.databaseId.database)throw new Wi(ti.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+r.get(3)+" vs "+t.databaseId.database);return new xr(cV(r))}function lV(t,e){return KP(t.databaseId,e)}function qQ(t){const e=oV(t);return e.length===4?Ss.emptyPath():cV(e)}function rI(t){return new Ss(["projects",t.databaseId.projectId,"databases",t.databaseId.database]).canonicalString()}function cV(t){return Jn(t.length>4&&t.get(4)==="documents"),t.popFirst(5)}function j4(t,e,r){return{name:iI(t,e),fields:r.value.mapValue.fields}}function $Q(t,e){let r;if("targetChange"in e){e.targetChange;const c=function(R){return R==="NO_CHANGE"?0:R==="ADD"?1:R==="REMOVE"?2:R==="CURRENT"?3:R==="RESET"?4:zr()}(e.targetChange.targetChangeType||"NO_CHANGE"),h=e.targetChange.targetIds||[],x=function(R,F){return R.useProto3Json?(Jn(F===void 0||typeof F=="string"),fo.fromBase64String(F||"")):(Jn(F===void 0||F instanceof Buffer||F instanceof Uint8Array),fo.fromUint8Array(F||new Uint8Array))}(t,e.targetChange.resumeToken),w=e.targetChange.cause,o=w&&function(R){const F=R.code===void 0?ti.UNKNOWN:rV(R.code);return new Wi(F,R.message||"")}(w);r=new sV(c,h,x,o||null)}else if("documentChange"in e){e.documentChange;const c=e.documentChange;c.document,c.document.name,c.document.updateTime;const h=EC(t,c.document.name),x=Gu(c.document.updateTime),w=c.document.createTime?Gu(c.document.createTime):Gr.min(),o=new gl({mapValue:{fields:c.document.fields}}),C=jo.newFoundDocument(h,x,w,o),R=c.targetIds||[],F=c.removedTargetIds||[];r=new y2(R,F,C.key,C)}else if("documentDelete"in e){e.documentDelete;const c=e.documentDelete;c.document;const h=EC(t,c.document),x=c.readTime?Gu(c.readTime):Gr.min(),w=jo.newNoDocument(h,x),o=c.removedTargetIds||[];r=new y2([],o,w.key,w)}else if("documentRemove"in e){e.documentRemove;const c=e.documentRemove;c.document;const h=EC(t,c.document),x=c.removedTargetIds||[];r=new y2([],x,h,null)}else{if(!("filter"in e))return zr();{e.filter;const c=e.filter;c.targetId;const{count:h=0,unchangedNames:x}=c,w=new kQ(h,x),o=c.targetId;r=new nV(o,w)}}return r}function GQ(t,e){let r;if(e instanceof Xv)r={update:j4(t,e.key,e.value)};else if(e instanceof ZP)r={delete:iI(t,e.key)};else if(e instanceof kp)r={update:j4(t,e.key,e.data),updateMask:eJ(e.fieldMask)};else{if(!(e instanceof PQ))return zr();r={verify:iI(t,e.key)}}return e.fieldTransforms.length>0&&(r.updateTransforms=e.fieldTransforms.map(c=>function(x,w){const o=w.transform;if(o instanceof Ev)return{fieldPath:w.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(o instanceof Iv)return{fieldPath:w.field.canonicalString(),appendMissingElements:{values:o.elements}};if(o instanceof Pv)return{fieldPath:w.field.canonicalString(),removeAllFromArray:{values:o.elements}};if(o instanceof uS)return{fieldPath:w.field.canonicalString(),increment:o.Pe};throw zr()}(0,c))),e.precondition.isNone||(r.currentDocument=function(h,x){return x.updateTime!==void 0?{updateTime:UQ(h,x.updateTime)}:x.exists!==void 0?{exists:x.exists}:zr()}(t,e.precondition)),r}function HQ(t,e){return t&&t.length>0?(Jn(e!==void 0),t.map(r=>function(h,x){let w=h.updateTime?Gu(h.updateTime):Gu(x);return w.isEqual(Gr.min())&&(w=Gu(x)),new CQ(w,h.transformResults||[])}(r,e))):[]}function WQ(t,e){return{documents:[lV(t,e.path)]}}function ZQ(t,e){const r={structuredQuery:{}},c=e.path;let h;e.collectionGroup!==null?(h=c,r.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(h=c.popLast(),r.structuredQuery.from=[{collectionId:c.lastSegment()}]),r.parent=lV(t,h);const x=function(R){if(R.length!==0)return dV(Yc.create(R,"and"))}(e.filters);x&&(r.structuredQuery.where=x);const w=function(R){if(R.length!==0)return R.map(F=>function(Y){return{field:Xg(Y.field),direction:KQ(Y.dir)}}(F))}(e.orderBy);w&&(r.structuredQuery.orderBy=w);const o=eI(t,e.limit);return o!==null&&(r.structuredQuery.limit=o),e.startAt&&(r.structuredQuery.startAt=function(R){return{before:R.inclusive,values:R.position}}(e.startAt)),e.endAt&&(r.structuredQuery.endAt=function(R){return{before:!R.inclusive,values:R.position}}(e.endAt)),{_t:r,parent:h}}function XQ(t){let e=qQ(t.parent);const r=t.structuredQuery,c=r.from?r.from.length:0;let h=null;if(c>0){Jn(c===1);const F=r.from[0];F.allDescendants?h=F.collectionId:e=e.child(F.collectionId)}let x=[];r.where&&(x=function($){const Y=uV($);return Y instanceof Yc&&BB(Y)?Y.getFilters():[Y]}(r.where));let w=[];r.orderBy&&(w=function($){return $.map(Y=>function(X){return new Cv(Yg(X.field),function(se){switch(se){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(X.direction))}(Y))}(r.orderBy));let o=null;r.limit&&(o=function($){let Y;return Y=typeof $=="object"?$.value:$,tT(Y)?null:Y}(r.limit));let C=null;r.startAt&&(C=function($){const Y=!!$.before,H=$.values||[];return new lS(H,Y)}(r.startAt));let R=null;return r.endAt&&(R=function($){const Y=!$.before,H=$.values||[];return new lS(H,Y)}(r.endAt)),pQ(e,h,w,x,o,"F",C,R)}function YQ(t,e){const r=function(h){switch(h){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return zr()}}(e.purpose);return r==null?null:{"goog-listen-tags":r}}function uV(t){return t.unaryFilter!==void 0?function(r){switch(r.unaryFilter.op){case"IS_NAN":const c=Yg(r.unaryFilter.field);return Aa.create(c,"==",{doubleValue:NaN});case"IS_NULL":const h=Yg(r.unaryFilter.field);return Aa.create(h,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const x=Yg(r.unaryFilter.field);return Aa.create(x,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const w=Yg(r.unaryFilter.field);return Aa.create(w,"!=",{nullValue:"NULL_VALUE"});default:return zr()}}(t):t.fieldFilter!==void 0?function(r){return Aa.create(Yg(r.fieldFilter.field),function(h){switch(h){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return zr()}}(r.fieldFilter.op),r.fieldFilter.value)}(t):t.compositeFilter!==void 0?function(r){return Yc.create(r.compositeFilter.filters.map(c=>uV(c)),function(h){switch(h){case"AND":return"and";case"OR":return"or";default:return zr()}}(r.compositeFilter.op))}(t):zr()}function KQ(t){return FQ[t]}function QQ(t){return zQ[t]}function JQ(t){return BQ[t]}function Xg(t){return{fieldPath:t.canonicalString()}}function Yg(t){return co.fromServerFormat(t.fieldPath)}function dV(t){return t instanceof Aa?function(r){if(r.op==="=="){if(y4(r.value))return{unaryFilter:{field:Xg(r.field),op:"IS_NAN"}};if(g4(r.value))return{unaryFilter:{field:Xg(r.field),op:"IS_NULL"}}}else if(r.op==="!="){if(y4(r.value))return{unaryFilter:{field:Xg(r.field),op:"IS_NOT_NAN"}};if(g4(r.value))return{unaryFilter:{field:Xg(r.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Xg(r.field),op:QQ(r.op),value:r.value}}}(t):t instanceof Yc?function(r){const c=r.getFilters().map(h=>dV(h));return c.length===1?c[0]:{compositeFilter:{op:JQ(r.op),filters:c}}}(t):zr()}function eJ(t){const e=[];return t.fields.forEach(r=>e.push(r.canonicalString())),{fieldPaths:e}}function hV(t){return t.length>=4&&t.get(0)==="projects"&&t.get(2)==="databases"}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ip{constructor(e,r,c,h,x=Gr.min(),w=Gr.min(),o=fo.EMPTY_BYTE_STRING,C=null){this.target=e,this.targetId=r,this.purpose=c,this.sequenceNumber=h,this.snapshotVersion=x,this.lastLimboFreeSnapshotVersion=w,this.resumeToken=o,this.expectedCount=C}withSequenceNumber(e){return new ip(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,r){return new ip(this.target,this.targetId,this.purpose,this.sequenceNumber,r,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new ip(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new ip(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class tJ{constructor(e){this.ct=e}}function iJ(t){const e=XQ({parent:t.parent,structuredQuery:t.structuredQuery});return t.limitType==="LAST"?cS(e,e.limit,"L"):e}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class rJ{constructor(){this.un=new nJ}addToCollectionParentIndex(e,r){return this.un.add(r),pi.resolve()}getCollectionParents(e,r){return pi.resolve(this.un.getEntries(r))}addFieldIndex(e,r){return pi.resolve()}deleteFieldIndex(e,r){return pi.resolve()}deleteAllFieldIndexes(e){return pi.resolve()}createTargetIndexes(e,r){return pi.resolve()}getDocumentsMatchingTarget(e,r){return pi.resolve(null)}getIndexType(e,r){return pi.resolve(0)}getFieldIndexes(e,r){return pi.resolve([])}getNextCollectionGroupToUpdate(e){return pi.resolve(null)}getMinOffset(e,r){return pi.resolve(Sp.min())}getMinOffsetFromCollectionGroup(e,r){return pi.resolve(Sp.min())}updateCollectionGroup(e,r,c){return pi.resolve()}updateIndexEntries(e,r){return pi.resolve()}}class nJ{constructor(){this.index={}}add(e){const r=e.lastSegment(),c=e.popLast(),h=this.index[r]||new ho(Ss.comparator),x=!h.has(c);return this.index[r]=h.add(c),x}has(e){const r=e.lastSegment(),c=e.popLast(),h=this.index[r];return h&&h.has(c)}getEntries(e){return(this.index[e]||new ho(Ss.comparator)).toArray()}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Oy{constructor(e){this.Ln=e}next(){return this.Ln+=2,this.Ln}static Bn(){return new Oy(0)}static kn(){return new Oy(-1)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class sJ{constructor(){this.changes=new Yy(e=>e.toString(),(e,r)=>e.isEqual(r)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,r){this.assertNotApplied(),this.changes.set(e,jo.newInvalidDocument(e).setReadTime(r))}getEntry(e,r){this.assertNotApplied();const c=this.changes.get(r);return c!==void 0?pi.resolve(c):this.getFromCache(e,r)}getEntries(e,r){return this.getAllFromCache(e,r)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class aJ{constructor(e,r){this.overlayedDocument=e,this.mutatedFields=r}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class oJ{constructor(e,r,c,h){this.remoteDocumentCache=e,this.mutationQueue=r,this.documentOverlayCache=c,this.indexManager=h}getDocument(e,r){let c=null;return this.documentOverlayCache.getOverlay(e,r).next(h=>(c=h,this.remoteDocumentCache.getEntry(e,r))).next(h=>(c!==null&&Y0(c.mutation,h,Ml.empty(),sa.now()),h))}getDocuments(e,r){return this.remoteDocumentCache.getEntries(e,r).next(c=>this.getLocalViewOfDocuments(e,c,mn()).next(()=>c))}getLocalViewOfDocuments(e,r,c=mn()){const h=Um();return this.populateOverlays(e,h,r).next(()=>this.computeViews(e,r,h,c).next(x=>{let w=j0();return x.forEach((o,C)=>{w=w.insert(o,C.overlayedDocument)}),w}))}getOverlayedDocuments(e,r){const c=Um();return this.populateOverlays(e,c,r).next(()=>this.computeViews(e,r,c,mn()))}populateOverlays(e,r,c){const h=[];return c.forEach(x=>{r.has(x)||h.push(x)}),this.documentOverlayCache.getOverlays(e,h).next(x=>{x.forEach((w,o)=>{r.set(w,o)})})}computeViews(e,r,c,h){let x=Gd();const w=X0(),o=function(){return X0()}();return r.forEach((C,R)=>{const F=c.get(R.key);h.has(R.key)&&(F===void 0||F.mutation instanceof kp)?x=x.insert(R.key,R):F!==void 0?(w.set(R.key,F.mutation.getFieldMask()),Y0(F.mutation,R,F.mutation.getFieldMask(),sa.now())):w.set(R.key,Ml.empty())}),this.recalculateAndSaveOverlays(e,x).next(C=>(C.forEach((R,F)=>w.set(R,F)),r.forEach((R,F)=>{var $;return o.set(R,new aJ(F,($=w.get(R))!==null&&$!==void 0?$:null))}),o))}recalculateAndSaveOverlays(e,r){const c=X0();let h=new Ws((w,o)=>w-o),x=mn();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,r).next(w=>{for(const o of w)o.keys().forEach(C=>{const R=r.get(C);if(R===null)return;let F=c.get(C)||Ml.empty();F=o.applyToLocalView(R,F),c.set(C,F);const $=(h.get(o.batchId)||mn()).add(C);h=h.insert(o.batchId,$)})}).next(()=>{const w=[],o=h.getReverseIterator();for(;o.hasNext();){const C=o.getNext(),R=C.key,F=C.value,$=XB();F.forEach(Y=>{if(!x.has(Y)){const H=tV(r.get(Y),c.get(Y));H!==null&&$.set(Y,H),x=x.add(Y)}}),w.push(this.documentOverlayCache.saveOverlays(e,R,$))}return pi.waitFor(w)}).next(()=>c)}recalculateAndSaveOverlaysForDocumentKeys(e,r){return this.remoteDocumentCache.getEntries(e,r).next(c=>this.recalculateAndSaveOverlays(e,c))}getDocumentsMatchingQuery(e,r,c,h){return function(w){return xr.isDocumentKey(w.path)&&w.collectionGroup===null&&w.filters.length===0}(r)?this.getDocumentsMatchingDocumentQuery(e,r.path):$B(r)?this.getDocumentsMatchingCollectionGroupQuery(e,r,c,h):this.getDocumentsMatchingCollectionQuery(e,r,c,h)}getNextDocuments(e,r,c,h){return this.remoteDocumentCache.getAllFromCollectionGroup(e,r,c,h).next(x=>{const w=h-x.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,r,c.largestBatchId,h-x.size):pi.resolve(Um());let o=-1,C=x;return w.next(R=>pi.forEach(R,(F,$)=>(o<$.largestBatchId&&(o=$.largestBatchId),x.get(F)?pi.resolve():this.remoteDocumentCache.getEntry(e,F).next(Y=>{C=C.insert(F,Y)}))).next(()=>this.populateOverlays(e,R,x)).next(()=>this.computeViews(e,C,R,mn())).next(F=>({batchId:o,changes:ZB(F)})))})}getDocumentsMatchingDocumentQuery(e,r){return this.getDocument(e,new xr(r)).next(c=>{let h=j0();return c.isFoundDocument()&&(h=h.insert(c.key,c)),h})}getDocumentsMatchingCollectionGroupQuery(e,r,c,h){const x=r.collectionGroup;let w=j0();return this.indexManager.getCollectionParents(e,x).next(o=>pi.forEach(o,C=>{const R=function($,Y){return new Xy(Y,null,$.explicitOrderBy.slice(),$.filters.slice(),$.limit,$.limitType,$.startAt,$.endAt)}(r,C.child(x));return this.getDocumentsMatchingCollectionQuery(e,R,c,h).next(F=>{F.forEach(($,Y)=>{w=w.insert($,Y)})})}).next(()=>w))}getDocumentsMatchingCollectionQuery(e,r,c,h){let x;return this.documentOverlayCache.getOverlaysForCollection(e,r.path,c.largestBatchId).next(w=>(x=w,this.remoteDocumentCache.getDocumentsMatchingQuery(e,r,c,x,h))).next(w=>{x.forEach((C,R)=>{const F=R.getKey();w.get(F)===null&&(w=w.insert(F,jo.newInvalidDocument(F)))});let o=j0();return w.forEach((C,R)=>{const F=x.get(C);F!==void 0&&Y0(F.mutation,R,Ml.empty(),sa.now()),rT(r,R)&&(o=o.insert(C,R))}),o})}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class lJ{constructor(e){this.serializer=e,this.hr=new Map,this.Pr=new Map}getBundleMetadata(e,r){return pi.resolve(this.hr.get(r))}saveBundleMetadata(e,r){return this.hr.set(r.id,function(h){return{id:h.id,version:h.version,createTime:Gu(h.createTime)}}(r)),pi.resolve()}getNamedQuery(e,r){return pi.resolve(this.Pr.get(r))}saveNamedQuery(e,r){return this.Pr.set(r.name,function(h){return{name:h.name,query:iJ(h.bundledQuery),readTime:Gu(h.readTime)}}(r)),pi.resolve()}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class cJ{constructor(){this.overlays=new Ws(xr.comparator),this.Ir=new Map}getOverlay(e,r){return pi.resolve(this.overlays.get(r))}getOverlays(e,r){const c=Um();return pi.forEach(r,h=>this.getOverlay(e,h).next(x=>{x!==null&&c.set(h,x)})).next(()=>c)}saveOverlays(e,r,c){return c.forEach((h,x)=>{this.ht(e,r,x)}),pi.resolve()}removeOverlaysForBatchId(e,r,c){const h=this.Ir.get(c);return h!==void 0&&(h.forEach(x=>this.overlays=this.overlays.remove(x)),this.Ir.delete(c)),pi.resolve()}getOverlaysForCollection(e,r,c){const h=Um(),x=r.length+1,w=new xr(r.child("")),o=this.overlays.getIteratorFrom(w);for(;o.hasNext();){const C=o.getNext().value,R=C.getKey();if(!r.isPrefixOf(R.path))break;R.path.length===x&&C.largestBatchId>c&&h.set(C.getKey(),C)}return pi.resolve(h)}getOverlaysForCollectionGroup(e,r,c,h){let x=new Ws((R,F)=>R-F);const w=this.overlays.getIterator();for(;w.hasNext();){const R=w.getNext().value;if(R.getKey().getCollectionGroup()===r&&R.largestBatchId>c){let F=x.get(R.largestBatchId);F===null&&(F=Um(),x=x.insert(R.largestBatchId,F)),F.set(R.getKey(),R)}}const o=Um(),C=x.getIterator();for(;C.hasNext()&&(C.getNext().value.forEach((R,F)=>o.set(R,F)),!(o.size()>=h)););return pi.resolve(o)}ht(e,r,c){const h=this.overlays.get(c.key);if(h!==null){const w=this.Ir.get(h.largestBatchId).delete(c.key);this.Ir.set(h.largestBatchId,w)}this.overlays=this.overlays.insert(c.key,new RQ(r,c));let x=this.Ir.get(r);x===void 0&&(x=mn(),this.Ir.set(r,x)),this.Ir.set(r,x.add(c.key))}}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class uJ{constructor(){this.sessionToken=fo.EMPTY_BYTE_STRING}getSessionToken(e){return pi.resolve(this.sessionToken)}setSessionToken(e,r){return this.sessionToken=r,pi.resolve()}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class QP{constructor(){this.Tr=new ho(Ha.Er),this.dr=new ho(Ha.Ar)}isEmpty(){return this.Tr.isEmpty()}addReference(e,r){const c=new Ha(e,r);this.Tr=this.Tr.add(c),this.dr=this.dr.add(c)}Rr(e,r){e.forEach(c=>this.addReference(c,r))}removeReference(e,r){this.Vr(new Ha(e,r))}mr(e,r){e.forEach(c=>this.removeReference(c,r))}gr(e){const r=new xr(new Ss([])),c=new Ha(r,e),h=new Ha(r,e+1),x=[];return this.dr.forEachInRange([c,h],w=>{this.Vr(w),x.push(w.key)}),x}pr(){this.Tr.forEach(e=>this.Vr(e))}Vr(e){this.Tr=this.Tr.delete(e),this.dr=this.dr.delete(e)}yr(e){const r=new xr(new Ss([])),c=new Ha(r,e),h=new Ha(r,e+1);let x=mn();return this.dr.forEachInRange([c,h],w=>{x=x.add(w.key)}),x}containsKey(e){const r=new Ha(e,0),c=this.Tr.firstAfterOrEqual(r);return c!==null&&e.isEqual(c.key)}}class Ha{constructor(e,r){this.key=e,this.wr=r}static Er(e,r){return xr.comparator(e.key,r.key)||Fn(e.wr,r.wr)}static Ar(e,r){return Fn(e.wr,r.wr)||xr.comparator(e.key,r.key)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class dJ{constructor(e,r){this.indexManager=e,this.referenceDelegate=r,this.mutationQueue=[],this.Sr=1,this.br=new ho(Ha.Er)}checkEmpty(e){return pi.resolve(this.mutationQueue.length===0)}addMutationBatch(e,r,c,h){const x=this.Sr;this.Sr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const w=new jQ(x,r,c,h);this.mutationQueue.push(w);for(const o of h)this.br=this.br.add(new Ha(o.key,x)),this.indexManager.addToCollectionParentIndex(e,o.key.path.popLast());return pi.resolve(w)}lookupMutationBatch(e,r){return pi.resolve(this.Dr(r))}getNextMutationBatchAfterBatchId(e,r){const c=r+1,h=this.vr(c),x=h<0?0:h;return pi.resolve(this.mutationQueue.length>x?this.mutationQueue[x]:null)}getHighestUnacknowledgedBatchId(){return pi.resolve(this.mutationQueue.length===0?-1:this.Sr-1)}getAllMutationBatches(e){return pi.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,r){const c=new Ha(r,0),h=new Ha(r,Number.POSITIVE_INFINITY),x=[];return this.br.forEachInRange([c,h],w=>{const o=this.Dr(w.wr);x.push(o)}),pi.resolve(x)}getAllMutationBatchesAffectingDocumentKeys(e,r){let c=new ho(Fn);return r.forEach(h=>{const x=new Ha(h,0),w=new Ha(h,Number.POSITIVE_INFINITY);this.br.forEachInRange([x,w],o=>{c=c.add(o.wr)})}),pi.resolve(this.Cr(c))}getAllMutationBatchesAffectingQuery(e,r){const c=r.path,h=c.length+1;let x=c;xr.isDocumentKey(x)||(x=x.child(""));const w=new Ha(new xr(x),0);let o=new ho(Fn);return this.br.forEachWhile(C=>{const R=C.key.path;return!!c.isPrefixOf(R)&&(R.length===h&&(o=o.add(C.wr)),!0)},w),pi.resolve(this.Cr(o))}Cr(e){const r=[];return e.forEach(c=>{const h=this.Dr(c);h!==null&&r.push(h)}),r}removeMutationBatch(e,r){Jn(this.Fr(r.batchId,"removed")===0),this.mutationQueue.shift();let c=this.br;return pi.forEach(r.mutations,h=>{const x=new Ha(h.key,r.batchId);return c=c.delete(x),this.referenceDelegate.markPotentiallyOrphaned(e,h.key)}).next(()=>{this.br=c})}On(e){}containsKey(e,r){const c=new Ha(r,0),h=this.br.firstAfterOrEqual(c);return pi.resolve(r.isEqual(h&&h.key))}performConsistencyCheck(e){return this.mutationQueue.length,pi.resolve()}Fr(e,r){return this.vr(e)}vr(e){return this.mutationQueue.length===0?0:e-this.mutationQueue[0].batchId}Dr(e){const r=this.vr(e);return r<0||r>=this.mutationQueue.length?null:this.mutationQueue[r]}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class hJ{constructor(e){this.Mr=e,this.docs=function(){return new Ws(xr.comparator)}(),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,r){const c=r.key,h=this.docs.get(c),x=h?h.size:0,w=this.Mr(r);return this.docs=this.docs.insert(c,{document:r.mutableCopy(),size:w}),this.size+=w-x,this.indexManager.addToCollectionParentIndex(e,c.path.popLast())}removeEntry(e){const r=this.docs.get(e);r&&(this.docs=this.docs.remove(e),this.size-=r.size)}getEntry(e,r){const c=this.docs.get(r);return pi.resolve(c?c.document.mutableCopy():jo.newInvalidDocument(r))}getEntries(e,r){let c=Gd();return r.forEach(h=>{const x=this.docs.get(h);c=c.insert(h,x?x.document.mutableCopy():jo.newInvalidDocument(h))}),pi.resolve(c)}getDocumentsMatchingQuery(e,r,c,h){let x=Gd();const w=r.path,o=new xr(w.child("")),C=this.docs.getIteratorFrom(o);for(;C.hasNext();){const{key:R,value:{document:F}}=C.getNext();if(!w.isPrefixOf(R.path))break;R.path.length>w.length+1||ZK(WK(F),c)<=0||(h.has(F.key)||rT(r,F))&&(x=x.insert(F.key,F.mutableCopy()))}return pi.resolve(x)}getAllFromCollectionGroup(e,r,c,h){zr()}Or(e,r){return pi.forEach(this.docs,c=>r(c))}newChangeBuffer(e){return new pJ(this)}getSize(e){return pi.resolve(this.size)}}class pJ extends sJ{constructor(e){super(),this.cr=e}applyChanges(e){const r=[];return this.changes.forEach((c,h)=>{h.isValidDocument()?r.push(this.cr.addEntry(e,h)):this.cr.removeEntry(c)}),pi.waitFor(r)}getFromCache(e,r){return this.cr.getEntry(e,r)}getAllFromCache(e,r){return this.cr.getEntries(e,r)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class mJ{constructor(e){this.persistence=e,this.Nr=new Yy(r=>$P(r),GP),this.lastRemoteSnapshotVersion=Gr.min(),this.highestTargetId=0,this.Lr=0,this.Br=new QP,this.targetCount=0,this.kr=Oy.Bn()}forEachTarget(e,r){return this.Nr.forEach((c,h)=>r(h)),pi.resolve()}getLastRemoteSnapshotVersion(e){return pi.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return pi.resolve(this.Lr)}allocateTargetId(e){return this.highestTargetId=this.kr.next(),pi.resolve(this.highestTargetId)}setTargetsMetadata(e,r,c){return c&&(this.lastRemoteSnapshotVersion=c),r>this.Lr&&(this.Lr=r),pi.resolve()}Kn(e){this.Nr.set(e.target,e);const r=e.targetId;r>this.highestTargetId&&(this.kr=new Oy(r),this.highestTargetId=r),e.sequenceNumber>this.Lr&&(this.Lr=e.sequenceNumber)}addTargetData(e,r){return this.Kn(r),this.targetCount+=1,pi.resolve()}updateTargetData(e,r){return this.Kn(r),pi.resolve()}removeTargetData(e,r){return this.Nr.delete(r.target),this.Br.gr(r.targetId),this.targetCount-=1,pi.resolve()}removeTargets(e,r,c){let h=0;const x=[];return this.Nr.forEach((w,o)=>{o.sequenceNumber<=r&&c.get(o.targetId)===null&&(this.Nr.delete(w),x.push(this.removeMatchingKeysForTargetId(e,o.targetId)),h++)}),pi.waitFor(x).next(()=>h)}getTargetCount(e){return pi.resolve(this.targetCount)}getTargetData(e,r){const c=this.Nr.get(r)||null;return pi.resolve(c)}addMatchingKeys(e,r,c){return this.Br.Rr(r,c),pi.resolve()}removeMatchingKeys(e,r,c){this.Br.mr(r,c);const h=this.persistence.referenceDelegate,x=[];return h&&r.forEach(w=>{x.push(h.markPotentiallyOrphaned(e,w))}),pi.waitFor(x)}removeMatchingKeysForTargetId(e,r){return this.Br.gr(r),pi.resolve()}getMatchingKeysForTargetId(e,r){const c=this.Br.yr(r);return pi.resolve(c)}containsKey(e,r){return pi.resolve(this.Br.containsKey(r))}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class fJ{constructor(e,r){this.qr={},this.overlays={},this.Qr=new BP(0),this.Kr=!1,this.Kr=!0,this.$r=new uJ,this.referenceDelegate=e(this),this.Ur=new mJ(this),this.indexManager=new rJ,this.remoteDocumentCache=function(h){return new hJ(h)}(c=>this.referenceDelegate.Wr(c)),this.serializer=new tJ(r),this.Gr=new lJ(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Kr=!1,Promise.resolve()}get started(){return this.Kr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let r=this.overlays[e.toKey()];return r||(r=new cJ,this.overlays[e.toKey()]=r),r}getMutationQueue(e,r){let c=this.qr[e.toKey()];return c||(c=new dJ(r,this.referenceDelegate),this.qr[e.toKey()]=c),c}getGlobalsCache(){return this.$r}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Gr}runTransaction(e,r,c){nr("MemoryPersistence","Starting transaction:",e);const h=new gJ(this.Qr.next());return this.referenceDelegate.zr(),c(h).next(x=>this.referenceDelegate.jr(h).next(()=>x)).toPromise().then(x=>(h.raiseOnCommittedEvent(),x))}Hr(e,r){return pi.or(Object.values(this.qr).map(c=>()=>c.containsKey(e,r)))}}class gJ extends YK{constructor(e){super(),this.currentSequenceNumber=e}}class JP{constructor(e){this.persistence=e,this.Jr=new QP,this.Yr=null}static Zr(e){return new JP(e)}get Xr(){if(this.Yr)return this.Yr;throw zr()}addReference(e,r,c){return this.Jr.addReference(c,r),this.Xr.delete(c.toString()),pi.resolve()}removeReference(e,r,c){return this.Jr.removeReference(c,r),this.Xr.add(c.toString()),pi.resolve()}markPotentiallyOrphaned(e,r){return this.Xr.add(r.toString()),pi.resolve()}removeTarget(e,r){this.Jr.gr(r.targetId).forEach(h=>this.Xr.add(h.toString()));const c=this.persistence.getTargetCache();return c.getMatchingKeysForTargetId(e,r.targetId).next(h=>{h.forEach(x=>this.Xr.add(x.toString()))}).next(()=>c.removeTargetData(e,r))}zr(){this.Yr=new Set}jr(e){const r=this.persistence.getRemoteDocumentCache().newChangeBuffer();return pi.forEach(this.Xr,c=>{const h=xr.fromPath(c);return this.ei(e,h).next(x=>{x||r.removeEntry(h,Gr.min())})}).next(()=>(this.Yr=null,r.apply(e)))}updateLimboDocument(e,r){return this.ei(e,r).next(c=>{c?this.Xr.delete(r.toString()):this.Xr.add(r.toString())})}Wr(e){return 0}ei(e,r){return pi.or([()=>pi.resolve(this.Jr.containsKey(r)),()=>this.persistence.getTargetCache().containsKey(e,r),()=>this.persistence.Hr(e,r)])}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ej{constructor(e,r,c,h){this.targetId=e,this.fromCache=r,this.$i=c,this.Ui=h}static Wi(e,r){let c=mn(),h=mn();for(const x of r.docChanges)switch(x.type){case 0:c=c.add(x.doc.key);break;case 1:h=h.add(x.doc.key)}return new ej(e,r.fromCache,c,h)}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class yJ{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class xJ{constructor(){this.Gi=!1,this.zi=!1,this.ji=100,this.Hi=function(){return tZ()?8:KK(Oo())>0?6:4}()}initialize(e,r){this.Ji=e,this.indexManager=r,this.Gi=!0}getDocumentsMatchingQuery(e,r,c,h){const x={result:null};return this.Yi(e,r).next(w=>{x.result=w}).next(()=>{if(!x.result)return this.Zi(e,r,h,c).next(w=>{x.result=w})}).next(()=>{if(x.result)return;const w=new yJ;return this.Xi(e,r,w).next(o=>{if(x.result=o,this.zi)return this.es(e,r,w,o.size)})}).next(()=>x.result)}es(e,r,c,h){return c.documentReadCount<this.ji?(y0()<=Sn.DEBUG&&nr("QueryEngine","SDK will not create cache indexes for query:",Zg(r),"since it only creates cache indexes for collection contains","more than or equal to",this.ji,"documents"),pi.resolve()):(y0()<=Sn.DEBUG&&nr("QueryEngine","Query:",Zg(r),"scans",c.documentReadCount,"local documents and returns",h,"documents as results."),c.documentReadCount>this.Hi*h?(y0()<=Sn.DEBUG&&nr("QueryEngine","The SDK decides to create cache indexes for query:",Zg(r),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,$u(r))):pi.resolve())}Yi(e,r){if(b4(r))return pi.resolve(null);let c=$u(r);return this.indexManager.getIndexType(e,c).next(h=>h===0?null:(r.limit!==null&&h===1&&(r=cS(r,null,"F"),c=$u(r)),this.indexManager.getDocumentsMatchingTarget(e,c).next(x=>{const w=mn(...x);return this.Ji.getDocuments(e,w).next(o=>this.indexManager.getMinOffset(e,c).next(C=>{const R=this.ts(r,o);return this.ns(r,R,w,C.readTime)?this.Yi(e,cS(r,null,"F")):this.rs(e,R,r,C)}))})))}Zi(e,r,c,h){return b4(r)||h.isEqual(Gr.min())?pi.resolve(null):this.Ji.getDocuments(e,c).next(x=>{const w=this.ts(r,x);return this.ns(r,w,c,h)?pi.resolve(null):(y0()<=Sn.DEBUG&&nr("QueryEngine","Re-using previous result from %s to execute query: %s",h.toString(),Zg(r)),this.rs(e,w,r,HK(h,-1)).next(o=>o))})}ts(e,r){let c=new ho(HB(e));return r.forEach((h,x)=>{rT(e,x)&&(c=c.add(x))}),c}ns(e,r,c,h){if(e.limit===null)return!1;if(c.size!==r.size)return!0;const x=e.limitType==="F"?r.last():r.first();return!!x&&(x.hasPendingWrites||x.version.compareTo(h)>0)}Xi(e,r,c){return y0()<=Sn.DEBUG&&nr("QueryEngine","Using full collection scan to execute query:",Zg(r)),this.Ji.getDocumentsMatchingQuery(e,r,Sp.min(),c)}rs(e,r,c,h){return this.Ji.getDocumentsMatchingQuery(e,c,h).next(x=>(r.forEach(w=>{x=x.insert(w.key,w)}),x))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class _J{constructor(e,r,c,h){this.persistence=e,this.ss=r,this.serializer=h,this.os=new Ws(Fn),this._s=new Yy(x=>$P(x),GP),this.us=new Map,this.cs=e.getRemoteDocumentCache(),this.Ur=e.getTargetCache(),this.Gr=e.getBundleCache(),this.ls(c)}ls(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new oJ(this.cs,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.cs.setIndexManager(this.indexManager),this.ss.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",r=>e.collect(r,this.os))}}function vJ(t,e,r,c){return new _J(t,e,r,c)}async function pV(t,e){const r=Hr(t);return await r.persistence.runTransaction("Handle user change","readonly",c=>{let h;return r.mutationQueue.getAllMutationBatches(c).next(x=>(h=x,r.ls(e),r.mutationQueue.getAllMutationBatches(c))).next(x=>{const w=[],o=[];let C=mn();for(const R of h){w.push(R.batchId);for(const F of R.mutations)C=C.add(F.key)}for(const R of x){o.push(R.batchId);for(const F of R.mutations)C=C.add(F.key)}return r.localDocuments.getDocuments(c,C).next(R=>({hs:R,removedBatchIds:w,addedBatchIds:o}))})})}function bJ(t,e){const r=Hr(t);return r.persistence.runTransaction("Acknowledge batch","readwrite-primary",c=>{const h=e.batch.keys(),x=r.cs.newChangeBuffer({trackRemovals:!0});return function(o,C,R,F){const $=R.batch,Y=$.keys();let H=pi.resolve();return Y.forEach(X=>{H=H.next(()=>F.getEntry(C,X)).next(he=>{const se=R.docVersions.get(X);Jn(se!==null),he.version.compareTo(se)<0&&($.applyToRemoteDocument(he,R),he.isValidDocument()&&(he.setReadTime(R.commitVersion),F.addEntry(he)))})}),H.next(()=>o.mutationQueue.removeMutationBatch(C,$))}(r,c,e,x).next(()=>x.apply(c)).next(()=>r.mutationQueue.performConsistencyCheck(c)).next(()=>r.documentOverlayCache.removeOverlaysForBatchId(c,h,e.batch.batchId)).next(()=>r.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(c,function(o){let C=mn();for(let R=0;R<o.mutationResults.length;++R)o.mutationResults[R].transformResults.length>0&&(C=C.add(o.batch.mutations[R].key));return C}(e))).next(()=>r.localDocuments.getDocuments(c,h))})}function mV(t){const e=Hr(t);return e.persistence.runTransaction("Get last remote snapshot version","readonly",r=>e.Ur.getLastRemoteSnapshotVersion(r))}function wJ(t,e){const r=Hr(t),c=e.snapshotVersion;let h=r.os;return r.persistence.runTransaction("Apply remote event","readwrite-primary",x=>{const w=r.cs.newChangeBuffer({trackRemovals:!0});h=r.os;const o=[];e.targetChanges.forEach((F,$)=>{const Y=h.get($);if(!Y)return;o.push(r.Ur.removeMatchingKeys(x,F.removedDocuments,$).next(()=>r.Ur.addMatchingKeys(x,F.addedDocuments,$)));let H=Y.withSequenceNumber(x.currentSequenceNumber);e.targetMismatches.get($)!==null?H=H.withResumeToken(fo.EMPTY_BYTE_STRING,Gr.min()).withLastLimboFreeSnapshotVersion(Gr.min()):F.resumeToken.approximateByteSize()>0&&(H=H.withResumeToken(F.resumeToken,c)),h=h.insert($,H),function(he,se,de){return he.resumeToken.approximateByteSize()===0||se.snapshotVersion.toMicroseconds()-he.snapshotVersion.toMicroseconds()>=3e8?!0:de.addedDocuments.size+de.modifiedDocuments.size+de.removedDocuments.size>0}(Y,H,F)&&o.push(r.Ur.updateTargetData(x,H))});let C=Gd(),R=mn();if(e.documentUpdates.forEach(F=>{e.resolvedLimboDocuments.has(F)&&o.push(r.persistence.referenceDelegate.updateLimboDocument(x,F))}),o.push(SJ(x,w,e.documentUpdates).next(F=>{C=F.Ps,R=F.Is})),!c.isEqual(Gr.min())){const F=r.Ur.getLastRemoteSnapshotVersion(x).next($=>r.Ur.setTargetsMetadata(x,x.currentSequenceNumber,c));o.push(F)}return pi.waitFor(o).next(()=>w.apply(x)).next(()=>r.localDocuments.getLocalViewOfDocuments(x,C,R)).next(()=>C)}).then(x=>(r.os=h,x))}function SJ(t,e,r){let c=mn(),h=mn();return r.forEach(x=>c=c.add(x)),e.getEntries(t,c).next(x=>{let w=Gd();return r.forEach((o,C)=>{const R=x.get(o);C.isFoundDocument()!==R.isFoundDocument()&&(h=h.add(o)),C.isNoDocument()&&C.version.isEqual(Gr.min())?(e.removeEntry(o,C.readTime),w=w.insert(o,C)):!R.isValidDocument()||C.version.compareTo(R.version)>0||C.version.compareTo(R.version)===0&&R.hasPendingWrites?(e.addEntry(C),w=w.insert(o,C)):nr("LocalStore","Ignoring outdated watch update for ",o,". Current version:",R.version," Watch version:",C.version)}),{Ps:w,Is:h}})}function TJ(t,e){const r=Hr(t);return r.persistence.runTransaction("Get next mutation batch","readonly",c=>(e===void 0&&(e=-1),r.mutationQueue.getNextMutationBatchAfterBatchId(c,e)))}function NJ(t,e){const r=Hr(t);return r.persistence.runTransaction("Allocate target","readwrite",c=>{let h;return r.Ur.getTargetData(c,e).next(x=>x?(h=x,pi.resolve(h)):r.Ur.allocateTargetId(c).next(w=>(h=new ip(e,w,"TargetPurposeListen",c.currentSequenceNumber),r.Ur.addTargetData(c,h).next(()=>h))))}).then(c=>{const h=r.os.get(c.targetId);return(h===null||c.snapshotVersion.compareTo(h.snapshotVersion)>0)&&(r.os=r.os.insert(c.targetId,c),r._s.set(e,c.targetId)),c})}async function nI(t,e,r){const c=Hr(t),h=c.os.get(e),x=r?"readwrite":"readwrite-primary";try{r||await c.persistence.runTransaction("Release target",x,w=>c.persistence.referenceDelegate.removeTarget(w,h))}catch(w){if(!Zv(w))throw w;nr("LocalStore",`Failed to update sequence numbers for target ${e}: ${w}`)}c.os=c.os.remove(e),c._s.delete(h.target)}function R4(t,e,r){const c=Hr(t);let h=Gr.min(),x=mn();return c.persistence.runTransaction("Execute query","readwrite",w=>function(C,R,F){const $=Hr(C),Y=$._s.get(F);return Y!==void 0?pi.resolve($.os.get(Y)):$.Ur.getTargetData(R,F)}(c,w,$u(e)).next(o=>{if(o)return h=o.lastLimboFreeSnapshotVersion,c.Ur.getMatchingKeysForTargetId(w,o.targetId).next(C=>{x=C})}).next(()=>c.ss.getDocumentsMatchingQuery(w,e,r?h:Gr.min(),r?x:mn())).next(o=>(AJ(c,fQ(e),o),{documents:o,Ts:x})))}function AJ(t,e,r){let c=t.us.get(e)||Gr.min();r.forEach((h,x)=>{x.readTime.compareTo(c)>0&&(c=x.readTime)}),t.us.set(e,c)}class k4{constructor(){this.activeTargetIds=bQ()}fs(e){this.activeTargetIds=this.activeTargetIds.add(e)}gs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Vs(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class CJ{constructor(){this.so=new k4,this.oo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,r,c){}addLocalQueryTarget(e,r=!0){return r&&this.so.fs(e),this.oo[e]||"not-current"}updateQueryState(e,r,c){this.oo[e]=r}removeLocalQueryTarget(e){this.so.gs(e)}isLocalQueryTarget(e){return this.so.activeTargetIds.has(e)}clearQueryState(e){delete this.oo[e]}getAllActiveQueryTargets(){return this.so.activeTargetIds}isActiveQueryTarget(e){return this.so.activeTargetIds.has(e)}start(){return this.so=new k4,Promise.resolve()}handleUserChange(e,r,c){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class EJ{_o(e){}shutdown(){}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class D4{constructor(){this.ao=()=>this.uo(),this.co=()=>this.lo(),this.ho=[],this.Po()}_o(e){this.ho.push(e)}shutdown(){window.removeEventListener("online",this.ao),window.removeEventListener("offline",this.co)}Po(){window.addEventListener("online",this.ao),window.addEventListener("offline",this.co)}uo(){nr("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.ho)e(0)}lo(){nr("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.ho)e(1)}static D(){return typeof window<"u"&&window.addEventListener!==void 0&&window.removeEventListener!==void 0}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Bw=null;function IC(){return Bw===null?Bw=function(){return 268435456+Math.round(2147483648*Math.random())}():Bw++,"0x"+Bw.toString(16)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const IJ={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class PJ{constructor(e){this.Io=e.Io,this.To=e.To}Eo(e){this.Ao=e}Ro(e){this.Vo=e}mo(e){this.fo=e}onMessage(e){this.po=e}close(){this.To()}send(e){this.Io(e)}yo(){this.Ao()}wo(){this.Vo()}So(e){this.fo(e)}bo(e){this.po(e)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Eo="WebChannelConnection";class jJ extends class{constructor(r){this.databaseInfo=r,this.databaseId=r.databaseId;const c=r.ssl?"https":"http",h=encodeURIComponent(this.databaseId.projectId),x=encodeURIComponent(this.databaseId.database);this.Do=c+"://"+r.host,this.vo=`projects/${h}/databases/${x}`,this.Co=this.databaseId.database==="(default)"?`project_id=${h}`:`project_id=${h}&database_id=${x}`}get Fo(){return!1}Mo(r,c,h,x,w){const o=IC(),C=this.xo(r,c.toUriEncodedString());nr("RestConnection",`Sending RPC '${r}' ${o}:`,C,h);const R={"google-cloud-resource-prefix":this.vo,"x-goog-request-params":this.Co};return this.Oo(R,x,w),this.No(r,C,R,h).then(F=>(nr("RestConnection",`Received RPC '${r}' ${o}: `,F),F),F=>{throw Ry("RestConnection",`RPC '${r}' ${o} failed with error: `,F,"url: ",C,"request:",h),F})}Lo(r,c,h,x,w,o){return this.Mo(r,c,h,x,w)}Oo(r,c,h){r["X-Goog-Api-Client"]=function(){return"gl-js/ fire/"+Zy}(),r["Content-Type"]="text/plain",this.databaseInfo.appId&&(r["X-Firebase-GMPID"]=this.databaseInfo.appId),c&&c.headers.forEach((x,w)=>r[w]=x),h&&h.headers.forEach((x,w)=>r[w]=x)}xo(r,c){const h=IJ[r];return`${this.Do}/v1/${c}:${h}`}terminate(){}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}No(e,r,c,h){const x=IC();return new Promise((w,o)=>{const C=new EB;C.setWithCredentials(!0),C.listenOnce(IB.COMPLETE,()=>{try{switch(C.getLastErrorCode()){case m2.NO_ERROR:const F=C.getResponseJson();nr(Eo,`XHR for RPC '${e}' ${x} received:`,JSON.stringify(F)),w(F);break;case m2.TIMEOUT:nr(Eo,`RPC '${e}' ${x} timed out`),o(new Wi(ti.DEADLINE_EXCEEDED,"Request time out"));break;case m2.HTTP_ERROR:const $=C.getStatus();if(nr(Eo,`RPC '${e}' ${x} failed with status:`,$,"response text:",C.getResponseText()),$>0){let Y=C.getResponseJson();Array.isArray(Y)&&(Y=Y[0]);const H=Y==null?void 0:Y.error;if(H&&H.status&&H.message){const X=function(se){const de=se.toLowerCase().replace(/_/g,"-");return Object.values(ti).indexOf(de)>=0?de:ti.UNKNOWN}(H.status);o(new Wi(X,H.message))}else o(new Wi(ti.UNKNOWN,"Server responded with status "+C.getStatus()))}else o(new Wi(ti.UNAVAILABLE,"Connection failed."));break;default:zr()}}finally{nr(Eo,`RPC '${e}' ${x} completed.`)}});const R=JSON.stringify(h);nr(Eo,`RPC '${e}' ${x} sending request:`,h),C.send(r,"POST",R,c,15)})}Bo(e,r,c){const h=IC(),x=[this.Do,"/","google.firestore.v1.Firestore","/",e,"/channel"],w=RB(),o=jB(),C={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},R=this.longPollingOptions.timeoutSeconds;R!==void 0&&(C.longPollingTimeout=Math.round(1e3*R)),this.useFetchStreams&&(C.useFetchStreams=!0),this.Oo(C.initMessageHeaders,r,c),C.encodeInitMessageHeaders=!0;const F=x.join("");nr(Eo,`Creating RPC '${e}' stream ${h}: ${F}`,C);const $=w.createWebChannel(F,C);let Y=!1,H=!1;const X=new PJ({Io:se=>{H?nr(Eo,`Not sending because RPC '${e}' stream ${h} is closed:`,se):(Y||(nr(Eo,`Opening RPC '${e}' stream ${h} transport.`),$.open(),Y=!0),nr(Eo,`RPC '${e}' stream ${h} sending:`,se),$.send(se))},To:()=>$.close()}),he=(se,de,K)=>{se.listen(de,ge=>{try{K(ge)}catch(Ae){setTimeout(()=>{throw Ae},0)}})};return he($,P0.EventType.OPEN,()=>{H||(nr(Eo,`RPC '${e}' stream ${h} transport opened.`),X.yo())}),he($,P0.EventType.CLOSE,()=>{H||(H=!0,nr(Eo,`RPC '${e}' stream ${h} transport closed`),X.So())}),he($,P0.EventType.ERROR,se=>{H||(H=!0,Ry(Eo,`RPC '${e}' stream ${h} transport errored:`,se),X.So(new Wi(ti.UNAVAILABLE,"The operation could not be completed")))}),he($,P0.EventType.MESSAGE,se=>{var de;if(!H){const K=se.data[0];Jn(!!K);const ge=K,Ae=ge.error||((de=ge[0])===null||de===void 0?void 0:de.error);if(Ae){nr(Eo,`RPC '${e}' stream ${h} received error:`,Ae);const Te=Ae.status;let Ce=function(q){const oe=Ta[q];if(oe!==void 0)return rV(oe)}(Te),ne=Ae.message;Ce===void 0&&(Ce=ti.INTERNAL,ne="Unknown error status: "+Te+" with message "+Ae.message),H=!0,X.So(new Wi(Ce,ne)),$.close()}else nr(Eo,`RPC '${e}' stream ${h} received:`,K),X.bo(K)}}),he(o,PB.STAT_EVENT,se=>{se.stat===ZE.PROXY?nr(Eo,`RPC '${e}' stream ${h} detected buffering proxy`):se.stat===ZE.NOPROXY&&nr(Eo,`RPC '${e}' stream ${h} detected no buffering proxy`)}),setTimeout(()=>{X.wo()},0),X}}function PC(){return typeof document<"u"?document:null}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function oT(t){return new VQ(t,!0)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class fV{constructor(e,r,c=1e3,h=1.5,x=6e4){this.ui=e,this.timerId=r,this.ko=c,this.qo=h,this.Qo=x,this.Ko=0,this.$o=null,this.Uo=Date.now(),this.reset()}reset(){this.Ko=0}Wo(){this.Ko=this.Qo}Go(e){this.cancel();const r=Math.floor(this.Ko+this.zo()),c=Math.max(0,Date.now()-this.Uo),h=Math.max(0,r-c);h>0&&nr("ExponentialBackoff",`Backing off for ${h} ms (base delay: ${this.Ko} ms, delay with jitter: ${r} ms, last attempt: ${c} ms ago)`),this.$o=this.ui.enqueueAfterDelay(this.timerId,h,()=>(this.Uo=Date.now(),e())),this.Ko*=this.qo,this.Ko<this.ko&&(this.Ko=this.ko),this.Ko>this.Qo&&(this.Ko=this.Qo)}jo(){this.$o!==null&&(this.$o.skipDelay(),this.$o=null)}cancel(){this.$o!==null&&(this.$o.cancel(),this.$o=null)}zo(){return(Math.random()-.5)*this.Ko}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class gV{constructor(e,r,c,h,x,w,o,C){this.ui=e,this.Ho=c,this.Jo=h,this.connection=x,this.authCredentialsProvider=w,this.appCheckCredentialsProvider=o,this.listener=C,this.state=0,this.Yo=0,this.Zo=null,this.Xo=null,this.stream=null,this.e_=0,this.t_=new fV(e,r)}n_(){return this.state===1||this.state===5||this.r_()}r_(){return this.state===2||this.state===3}start(){this.e_=0,this.state!==4?this.auth():this.i_()}async stop(){this.n_()&&await this.close(0)}s_(){this.state=0,this.t_.reset()}o_(){this.r_()&&this.Zo===null&&(this.Zo=this.ui.enqueueAfterDelay(this.Ho,6e4,()=>this.__()))}a_(e){this.u_(),this.stream.send(e)}async __(){if(this.r_())return this.close(0)}u_(){this.Zo&&(this.Zo.cancel(),this.Zo=null)}c_(){this.Xo&&(this.Xo.cancel(),this.Xo=null)}async close(e,r){this.u_(),this.c_(),this.t_.cancel(),this.Yo++,e!==4?this.t_.reset():r&&r.code===ti.RESOURCE_EXHAUSTED?($d(r.toString()),$d("Using maximum backoff delay to prevent overloading the backend."),this.t_.Wo()):r&&r.code===ti.UNAUTHENTICATED&&this.state!==3&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),this.stream!==null&&(this.l_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.mo(r)}l_(){}auth(){this.state=1;const e=this.h_(this.Yo),r=this.Yo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([c,h])=>{this.Yo===r&&this.P_(c,h)},c=>{e(()=>{const h=new Wi(ti.UNKNOWN,"Fetching auth token failed: "+c.message);return this.I_(h)})})}P_(e,r){const c=this.h_(this.Yo);this.stream=this.T_(e,r),this.stream.Eo(()=>{c(()=>this.listener.Eo())}),this.stream.Ro(()=>{c(()=>(this.state=2,this.Xo=this.ui.enqueueAfterDelay(this.Jo,1e4,()=>(this.r_()&&(this.state=3),Promise.resolve())),this.listener.Ro()))}),this.stream.mo(h=>{c(()=>this.I_(h))}),this.stream.onMessage(h=>{c(()=>++this.e_==1?this.E_(h):this.onNext(h))})}i_(){this.state=5,this.t_.Go(async()=>{this.state=0,this.start()})}I_(e){return nr("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}h_(e){return r=>{this.ui.enqueueAndForget(()=>this.Yo===e?r():(nr("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class RJ extends gV{constructor(e,r,c,h,x,w){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",r,c,h,w),this.serializer=x}T_(e,r){return this.connection.Bo("Listen",e,r)}E_(e){return this.onNext(e)}onNext(e){this.t_.reset();const r=$Q(this.serializer,e),c=function(x){if(!("targetChange"in x))return Gr.min();const w=x.targetChange;return w.targetIds&&w.targetIds.length?Gr.min():w.readTime?Gu(w.readTime):Gr.min()}(e);return this.listener.d_(r,c)}A_(e){const r={};r.database=rI(this.serializer),r.addTarget=function(x,w){let o;const C=w.target;if(o=QE(C)?{documents:WQ(x,C)}:{query:ZQ(x,C)._t},o.targetId=w.targetId,w.resumeToken.approximateByteSize()>0){o.resumeToken=aV(x,w.resumeToken);const R=eI(x,w.expectedCount);R!==null&&(o.expectedCount=R)}else if(w.snapshotVersion.compareTo(Gr.min())>0){o.readTime=dS(x,w.snapshotVersion.toTimestamp());const R=eI(x,w.expectedCount);R!==null&&(o.expectedCount=R)}return o}(this.serializer,e);const c=YQ(this.serializer,e);c&&(r.labels=c),this.a_(r)}R_(e){const r={};r.database=rI(this.serializer),r.removeTarget=e,this.a_(r)}}class kJ extends gV{constructor(e,r,c,h,x,w){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",r,c,h,w),this.serializer=x}get V_(){return this.e_>0}start(){this.lastStreamToken=void 0,super.start()}l_(){this.V_&&this.m_([])}T_(e,r){return this.connection.Bo("Write",e,r)}E_(e){return Jn(!!e.streamToken),this.lastStreamToken=e.streamToken,Jn(!e.writeResults||e.writeResults.length===0),this.listener.f_()}onNext(e){Jn(!!e.streamToken),this.lastStreamToken=e.streamToken,this.t_.reset();const r=HQ(e.writeResults,e.commitTime),c=Gu(e.commitTime);return this.listener.g_(c,r)}p_(){const e={};e.database=rI(this.serializer),this.a_(e)}m_(e){const r={streamToken:this.lastStreamToken,writes:e.map(c=>GQ(this.serializer,c))};this.a_(r)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class DJ extends class{}{constructor(e,r,c,h){super(),this.authCredentials=e,this.appCheckCredentials=r,this.connection=c,this.serializer=h,this.y_=!1}w_(){if(this.y_)throw new Wi(ti.FAILED_PRECONDITION,"The client has already been terminated.")}Mo(e,r,c,h){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([x,w])=>this.connection.Mo(e,tI(r,c),h,x,w)).catch(x=>{throw x.name==="FirebaseError"?(x.code===ti.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),x):new Wi(ti.UNKNOWN,x.toString())})}Lo(e,r,c,h,x){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([w,o])=>this.connection.Lo(e,tI(r,c),h,w,o,x)).catch(w=>{throw w.name==="FirebaseError"?(w.code===ti.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),w):new Wi(ti.UNKNOWN,w.toString())})}terminate(){this.y_=!0,this.connection.terminate()}}class MJ{constructor(e,r){this.asyncQueue=e,this.onlineStateHandler=r,this.state="Unknown",this.S_=0,this.b_=null,this.D_=!0}v_(){this.S_===0&&(this.C_("Unknown"),this.b_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.b_=null,this.F_("Backend didn't respond within 10 seconds."),this.C_("Offline"),Promise.resolve())))}M_(e){this.state==="Online"?this.C_("Unknown"):(this.S_++,this.S_>=1&&(this.x_(),this.F_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.C_("Offline")))}set(e){this.x_(),this.S_=0,e==="Online"&&(this.D_=!1),this.C_(e)}C_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}F_(e){const r=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.D_?($d(r),this.D_=!1):nr("OnlineStateTracker",r)}x_(){this.b_!==null&&(this.b_.cancel(),this.b_=null)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class OJ{constructor(e,r,c,h,x){this.localStore=e,this.datastore=r,this.asyncQueue=c,this.remoteSyncer={},this.O_=[],this.N_=new Map,this.L_=new Set,this.B_=[],this.k_=x,this.k_._o(w=>{c.enqueueAndForget(async()=>{_f(this)&&(nr("RemoteStore","Restarting streams for network reachability change."),await async function(C){const R=Hr(C);R.L_.add(4),await Kv(R),R.q_.set("Unknown"),R.L_.delete(4),await lT(R)}(this))})}),this.q_=new MJ(c,h)}}async function lT(t){if(_f(t))for(const e of t.B_)await e(!0)}async function Kv(t){for(const e of t.B_)await e(!1)}function yV(t,e){const r=Hr(t);r.N_.has(e.targetId)||(r.N_.set(e.targetId,e),nj(r)?rj(r):Ky(r).r_()&&ij(r,e))}function tj(t,e){const r=Hr(t),c=Ky(r);r.N_.delete(e),c.r_()&&xV(r,e),r.N_.size===0&&(c.r_()?c.o_():_f(r)&&r.q_.set("Unknown"))}function ij(t,e){if(t.Q_.xe(e.targetId),e.resumeToken.approximateByteSize()>0||e.snapshotVersion.compareTo(Gr.min())>0){const r=t.remoteSyncer.getRemoteKeysForTarget(e.targetId).size;e=e.withExpectedCount(r)}Ky(t).A_(e)}function xV(t,e){t.Q_.xe(e),Ky(t).R_(e)}function rj(t){t.Q_=new LQ({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),ot:e=>t.N_.get(e)||null,tt:()=>t.datastore.serializer.databaseId}),Ky(t).start(),t.q_.v_()}function nj(t){return _f(t)&&!Ky(t).n_()&&t.N_.size>0}function _f(t){return Hr(t).L_.size===0}function _V(t){t.Q_=void 0}async function LJ(t){t.q_.set("Online")}async function FJ(t){t.N_.forEach((e,r)=>{ij(t,e)})}async function zJ(t,e){_V(t),nj(t)?(t.q_.M_(e),rj(t)):t.q_.set("Unknown")}async function BJ(t,e,r){if(t.q_.set("Online"),e instanceof sV&&e.state===2&&e.cause)try{await async function(h,x){const w=x.cause;for(const o of x.targetIds)h.N_.has(o)&&(await h.remoteSyncer.rejectListen(o,w),h.N_.delete(o),h.Q_.removeTarget(o))}(t,e)}catch(c){nr("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),c),await hS(t,c)}else if(e instanceof y2?t.Q_.Ke(e):e instanceof nV?t.Q_.He(e):t.Q_.We(e),!r.isEqual(Gr.min()))try{const c=await mV(t.localStore);r.compareTo(c)>=0&&await function(x,w){const o=x.Q_.rt(w);return o.targetChanges.forEach((C,R)=>{if(C.resumeToken.approximateByteSize()>0){const F=x.N_.get(R);F&&x.N_.set(R,F.withResumeToken(C.resumeToken,w))}}),o.targetMismatches.forEach((C,R)=>{const F=x.N_.get(C);if(!F)return;x.N_.set(C,F.withResumeToken(fo.EMPTY_BYTE_STRING,F.snapshotVersion)),xV(x,C);const $=new ip(F.target,C,R,F.sequenceNumber);ij(x,$)}),x.remoteSyncer.applyRemoteEvent(o)}(t,r)}catch(c){nr("RemoteStore","Failed to raise snapshot:",c),await hS(t,c)}}async function hS(t,e,r){if(!Zv(e))throw e;t.L_.add(1),await Kv(t),t.q_.set("Offline"),r||(r=()=>mV(t.localStore)),t.asyncQueue.enqueueRetryable(async()=>{nr("RemoteStore","Retrying IndexedDB access"),await r(),t.L_.delete(1),await lT(t)})}function vV(t,e){return e().catch(r=>hS(t,r,e))}async function cT(t){const e=Hr(t),r=Np(e);let c=e.O_.length>0?e.O_[e.O_.length-1].batchId:-1;for(;VJ(e);)try{const h=await TJ(e.localStore,c);if(h===null){e.O_.length===0&&r.o_();break}c=h.batchId,UJ(e,h)}catch(h){await hS(e,h)}bV(e)&&wV(e)}function VJ(t){return _f(t)&&t.O_.length<10}function UJ(t,e){t.O_.push(e);const r=Np(t);r.r_()&&r.V_&&r.m_(e.mutations)}function bV(t){return _f(t)&&!Np(t).n_()&&t.O_.length>0}function wV(t){Np(t).start()}async function qJ(t){Np(t).p_()}async function $J(t){const e=Np(t);for(const r of t.O_)e.m_(r.mutations)}async function GJ(t,e,r){const c=t.O_.shift(),h=XP.from(c,e,r);await vV(t,()=>t.remoteSyncer.applySuccessfulWrite(h)),await cT(t)}async function HJ(t,e){e&&Np(t).V_&&await async function(c,h){if(function(w){return DQ(w)&&w!==ti.ABORTED}(h.code)){const x=c.O_.shift();Np(c).s_(),await vV(c,()=>c.remoteSyncer.rejectFailedWrite(x.batchId,h)),await cT(c)}}(t,e),bV(t)&&wV(t)}async function M4(t,e){const r=Hr(t);r.asyncQueue.verifyOperationInProgress(),nr("RemoteStore","RemoteStore received new credentials");const c=_f(r);r.L_.add(3),await Kv(r),c&&r.q_.set("Unknown"),await r.remoteSyncer.handleCredentialChange(e),r.L_.delete(3),await lT(r)}async function WJ(t,e){const r=Hr(t);e?(r.L_.delete(2),await lT(r)):e||(r.L_.add(2),await Kv(r),r.q_.set("Unknown"))}function Ky(t){return t.K_||(t.K_=function(r,c,h){const x=Hr(r);return x.w_(),new RJ(c,x.connection,x.authCredentials,x.appCheckCredentials,x.serializer,h)}(t.datastore,t.asyncQueue,{Eo:LJ.bind(null,t),Ro:FJ.bind(null,t),mo:zJ.bind(null,t),d_:BJ.bind(null,t)}),t.B_.push(async e=>{e?(t.K_.s_(),nj(t)?rj(t):t.q_.set("Unknown")):(await t.K_.stop(),_V(t))})),t.K_}function Np(t){return t.U_||(t.U_=function(r,c,h){const x=Hr(r);return x.w_(),new kJ(c,x.connection,x.authCredentials,x.appCheckCredentials,x.serializer,h)}(t.datastore,t.asyncQueue,{Eo:()=>Promise.resolve(),Ro:qJ.bind(null,t),mo:HJ.bind(null,t),f_:$J.bind(null,t),g_:GJ.bind(null,t)}),t.B_.push(async e=>{e?(t.U_.s_(),await cT(t)):(await t.U_.stop(),t.O_.length>0&&(nr("RemoteStore",`Stopping write stream with ${t.O_.length} pending writes`),t.O_=[]))})),t.U_}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class sj{constructor(e,r,c,h,x){this.asyncQueue=e,this.timerId=r,this.targetTimeMs=c,this.op=h,this.removalCallback=x,this.deferred=new Od,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(w=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,r,c,h,x){const w=Date.now()+c,o=new sj(e,r,w,h,x);return o.start(c),o}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){this.timerHandle!==null&&(this.clearTimeout(),this.deferred.reject(new Wi(ti.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>this.timerHandle!==null?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){this.timerHandle!==null&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function aj(t,e){if($d("AsyncQueue",`${e}: ${t}`),Zv(t))return new Wi(ti.UNAVAILABLE,`${e}: ${t}`);throw t}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class vy{constructor(e){this.comparator=e?(r,c)=>e(r,c)||xr.comparator(r.key,c.key):(r,c)=>xr.comparator(r.key,c.key),this.keyedMap=j0(),this.sortedSet=new Ws(this.comparator)}static emptySet(e){return new vy(e.comparator)}has(e){return this.keyedMap.get(e)!=null}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const r=this.keyedMap.get(e);return r?this.sortedSet.indexOf(r):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((r,c)=>(e(r),!1))}add(e){const r=this.delete(e.key);return r.copy(r.keyedMap.insert(e.key,e),r.sortedSet.insert(e,null))}delete(e){const r=this.get(e);return r?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(r)):this}isEqual(e){if(!(e instanceof vy)||this.size!==e.size)return!1;const r=this.sortedSet.getIterator(),c=e.sortedSet.getIterator();for(;r.hasNext();){const h=r.getNext().key,x=c.getNext().key;if(!h.isEqual(x))return!1}return!0}toString(){const e=[];return this.forEach(r=>{e.push(r.toString())}),e.length===0?"DocumentSet ()":`DocumentSet (
  `+e.join(`  
`)+`
)`}copy(e,r){const c=new vy;return c.comparator=this.comparator,c.keyedMap=e,c.sortedSet=r,c}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class O4{constructor(){this.W_=new Ws(xr.comparator)}track(e){const r=e.doc.key,c=this.W_.get(r);c?e.type!==0&&c.type===3?this.W_=this.W_.insert(r,e):e.type===3&&c.type!==1?this.W_=this.W_.insert(r,{type:c.type,doc:e.doc}):e.type===2&&c.type===2?this.W_=this.W_.insert(r,{type:2,doc:e.doc}):e.type===2&&c.type===0?this.W_=this.W_.insert(r,{type:0,doc:e.doc}):e.type===1&&c.type===0?this.W_=this.W_.remove(r):e.type===1&&c.type===2?this.W_=this.W_.insert(r,{type:1,doc:c.doc}):e.type===0&&c.type===1?this.W_=this.W_.insert(r,{type:2,doc:e.doc}):zr():this.W_=this.W_.insert(r,e)}G_(){const e=[];return this.W_.inorderTraversal((r,c)=>{e.push(c)}),e}}class Ly{constructor(e,r,c,h,x,w,o,C,R){this.query=e,this.docs=r,this.oldDocs=c,this.docChanges=h,this.mutatedKeys=x,this.fromCache=w,this.syncStateChanged=o,this.excludesMetadataChanges=C,this.hasCachedResults=R}static fromInitialDocuments(e,r,c,h,x){const w=[];return r.forEach(o=>{w.push({type:0,doc:o})}),new Ly(e,r,vy.emptySet(r),w,c,h,!0,!1,x)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&iT(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const r=this.docChanges,c=e.docChanges;if(r.length!==c.length)return!1;for(let h=0;h<r.length;h++)if(r[h].type!==c[h].type||!r[h].doc.isEqual(c[h].doc))return!1;return!0}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ZJ{constructor(){this.z_=void 0,this.j_=[]}H_(){return this.j_.some(e=>e.J_())}}class XJ{constructor(){this.queries=L4(),this.onlineState="Unknown",this.Y_=new Set}terminate(){(function(r,c){const h=Hr(r),x=h.queries;h.queries=L4(),x.forEach((w,o)=>{for(const C of o.j_)C.onError(c)})})(this,new Wi(ti.ABORTED,"Firestore shutting down"))}}function L4(){return new Yy(t=>GB(t),iT)}async function SV(t,e){const r=Hr(t);let c=3;const h=e.query;let x=r.queries.get(h);x?!x.H_()&&e.J_()&&(c=2):(x=new ZJ,c=e.J_()?0:1);try{switch(c){case 0:x.z_=await r.onListen(h,!0);break;case 1:x.z_=await r.onListen(h,!1);break;case 2:await r.onFirstRemoteStoreListen(h)}}catch(w){const o=aj(w,`Initialization of query '${Zg(e.query)}' failed`);return void e.onError(o)}r.queries.set(h,x),x.j_.push(e),e.Z_(r.onlineState),x.z_&&e.X_(x.z_)&&oj(r)}async function TV(t,e){const r=Hr(t),c=e.query;let h=3;const x=r.queries.get(c);if(x){const w=x.j_.indexOf(e);w>=0&&(x.j_.splice(w,1),x.j_.length===0?h=e.J_()?0:1:!x.H_()&&e.J_()&&(h=2))}switch(h){case 0:return r.queries.delete(c),r.onUnlisten(c,!0);case 1:return r.queries.delete(c),r.onUnlisten(c,!1);case 2:return r.onLastRemoteStoreUnlisten(c);default:return}}function YJ(t,e){const r=Hr(t);let c=!1;for(const h of e){const x=h.query,w=r.queries.get(x);if(w){for(const o of w.j_)o.X_(h)&&(c=!0);w.z_=h}}c&&oj(r)}function KJ(t,e,r){const c=Hr(t),h=c.queries.get(e);if(h)for(const x of h.j_)x.onError(r);c.queries.delete(e)}function oj(t){t.Y_.forEach(e=>{e.next()})}var sI,F4;(F4=sI||(sI={})).ea="default",F4.Cache="cache";class NV{constructor(e,r,c){this.query=e,this.ta=r,this.na=!1,this.ra=null,this.onlineState="Unknown",this.options=c||{}}X_(e){if(!this.options.includeMetadataChanges){const c=[];for(const h of e.docChanges)h.type!==3&&c.push(h);e=new Ly(e.query,e.docs,e.oldDocs,c,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let r=!1;return this.na?this.ia(e)&&(this.ta.next(e),r=!0):this.sa(e,this.onlineState)&&(this.oa(e),r=!0),this.ra=e,r}onError(e){this.ta.error(e)}Z_(e){this.onlineState=e;let r=!1;return this.ra&&!this.na&&this.sa(this.ra,e)&&(this.oa(this.ra),r=!0),r}sa(e,r){if(!e.fromCache||!this.J_())return!0;const c=r!=="Offline";return(!this.options._a||!c)&&(!e.docs.isEmpty()||e.hasCachedResults||r==="Offline")}ia(e){if(e.docChanges.length>0)return!0;const r=this.ra&&this.ra.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!r)&&this.options.includeMetadataChanges===!0}oa(e){e=Ly.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.na=!0,this.ta.next(e)}J_(){return this.options.source!==sI.Cache}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class AV{constructor(e){this.key=e}}class CV{constructor(e){this.key=e}}class QJ{constructor(e,r){this.query=e,this.Ta=r,this.Ea=null,this.hasCachedResults=!1,this.current=!1,this.da=mn(),this.mutatedKeys=mn(),this.Aa=HB(e),this.Ra=new vy(this.Aa)}get Va(){return this.Ta}ma(e,r){const c=r?r.fa:new O4,h=r?r.Ra:this.Ra;let x=r?r.mutatedKeys:this.mutatedKeys,w=h,o=!1;const C=this.query.limitType==="F"&&h.size===this.query.limit?h.last():null,R=this.query.limitType==="L"&&h.size===this.query.limit?h.first():null;if(e.inorderTraversal((F,$)=>{const Y=h.get(F),H=rT(this.query,$)?$:null,X=!!Y&&this.mutatedKeys.has(Y.key),he=!!H&&(H.hasLocalMutations||this.mutatedKeys.has(H.key)&&H.hasCommittedMutations);let se=!1;Y&&H?Y.data.isEqual(H.data)?X!==he&&(c.track({type:3,doc:H}),se=!0):this.ga(Y,H)||(c.track({type:2,doc:H}),se=!0,(C&&this.Aa(H,C)>0||R&&this.Aa(H,R)<0)&&(o=!0)):!Y&&H?(c.track({type:0,doc:H}),se=!0):Y&&!H&&(c.track({type:1,doc:Y}),se=!0,(C||R)&&(o=!0)),se&&(H?(w=w.add(H),x=he?x.add(F):x.delete(F)):(w=w.delete(F),x=x.delete(F)))}),this.query.limit!==null)for(;w.size>this.query.limit;){const F=this.query.limitType==="F"?w.last():w.first();w=w.delete(F.key),x=x.delete(F.key),c.track({type:1,doc:F})}return{Ra:w,fa:c,ns:o,mutatedKeys:x}}ga(e,r){return e.hasLocalMutations&&r.hasCommittedMutations&&!r.hasLocalMutations}applyChanges(e,r,c,h){const x=this.Ra;this.Ra=e.Ra,this.mutatedKeys=e.mutatedKeys;const w=e.fa.G_();w.sort((F,$)=>function(H,X){const he=se=>{switch(se){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return zr()}};return he(H)-he(X)}(F.type,$.type)||this.Aa(F.doc,$.doc)),this.pa(c),h=h!=null&&h;const o=r&&!h?this.ya():[],C=this.da.size===0&&this.current&&!h?1:0,R=C!==this.Ea;return this.Ea=C,w.length!==0||R?{snapshot:new Ly(this.query,e.Ra,x,w,e.mutatedKeys,C===0,R,!1,!!c&&c.resumeToken.approximateByteSize()>0),wa:o}:{wa:o}}Z_(e){return this.current&&e==="Offline"?(this.current=!1,this.applyChanges({Ra:this.Ra,fa:new O4,mutatedKeys:this.mutatedKeys,ns:!1},!1)):{wa:[]}}Sa(e){return!this.Ta.has(e)&&!!this.Ra.has(e)&&!this.Ra.get(e).hasLocalMutations}pa(e){e&&(e.addedDocuments.forEach(r=>this.Ta=this.Ta.add(r)),e.modifiedDocuments.forEach(r=>{}),e.removedDocuments.forEach(r=>this.Ta=this.Ta.delete(r)),this.current=e.current)}ya(){if(!this.current)return[];const e=this.da;this.da=mn(),this.Ra.forEach(c=>{this.Sa(c.key)&&(this.da=this.da.add(c.key))});const r=[];return e.forEach(c=>{this.da.has(c)||r.push(new CV(c))}),this.da.forEach(c=>{e.has(c)||r.push(new AV(c))}),r}ba(e){this.Ta=e.Ts,this.da=mn();const r=this.ma(e.documents);return this.applyChanges(r,!0)}Da(){return Ly.fromInitialDocuments(this.query,this.Ra,this.mutatedKeys,this.Ea===0,this.hasCachedResults)}}class JJ{constructor(e,r,c){this.query=e,this.targetId=r,this.view=c}}class eee{constructor(e){this.key=e,this.va=!1}}class tee{constructor(e,r,c,h,x,w){this.localStore=e,this.remoteStore=r,this.eventManager=c,this.sharedClientState=h,this.currentUser=x,this.maxConcurrentLimboResolutions=w,this.Ca={},this.Fa=new Yy(o=>GB(o),iT),this.Ma=new Map,this.xa=new Set,this.Oa=new Ws(xr.comparator),this.Na=new Map,this.La=new QP,this.Ba={},this.ka=new Map,this.qa=Oy.kn(),this.onlineState="Unknown",this.Qa=void 0}get isPrimaryClient(){return this.Qa===!0}}async function iee(t,e,r=!0){const c=kV(t);let h;const x=c.Fa.get(e);return x?(c.sharedClientState.addLocalQueryTarget(x.targetId),h=x.view.Da()):h=await EV(c,e,r,!0),h}async function ree(t,e){const r=kV(t);await EV(r,e,!0,!1)}async function EV(t,e,r,c){const h=await NJ(t.localStore,$u(e)),x=h.targetId,w=t.sharedClientState.addLocalQueryTarget(x,r);let o;return c&&(o=await nee(t,e,x,w==="current",h.resumeToken)),t.isPrimaryClient&&r&&yV(t.remoteStore,h),o}async function nee(t,e,r,c,h){t.Ka=($,Y,H)=>async function(he,se,de,K){let ge=se.view.ma(de);ge.ns&&(ge=await R4(he.localStore,se.query,!1).then(({documents:ne})=>se.view.ma(ne,ge)));const Ae=K&&K.targetChanges.get(se.targetId),Te=K&&K.targetMismatches.get(se.targetId)!=null,Ce=se.view.applyChanges(ge,he.isPrimaryClient,Ae,Te);return B4(he,se.targetId,Ce.wa),Ce.snapshot}(t,$,Y,H);const x=await R4(t.localStore,e,!0),w=new QJ(e,x.Ts),o=w.ma(x.documents),C=Yv.createSynthesizedTargetChangeForCurrentChange(r,c&&t.onlineState!=="Offline",h),R=w.applyChanges(o,t.isPrimaryClient,C);B4(t,r,R.wa);const F=new JJ(e,r,w);return t.Fa.set(e,F),t.Ma.has(r)?t.Ma.get(r).push(e):t.Ma.set(r,[e]),R.snapshot}async function see(t,e,r){const c=Hr(t),h=c.Fa.get(e),x=c.Ma.get(h.targetId);if(x.length>1)return c.Ma.set(h.targetId,x.filter(w=>!iT(w,e))),void c.Fa.delete(e);c.isPrimaryClient?(c.sharedClientState.removeLocalQueryTarget(h.targetId),c.sharedClientState.isActiveQueryTarget(h.targetId)||await nI(c.localStore,h.targetId,!1).then(()=>{c.sharedClientState.clearQueryState(h.targetId),r&&tj(c.remoteStore,h.targetId),aI(c,h.targetId)}).catch(Wv)):(aI(c,h.targetId),await nI(c.localStore,h.targetId,!0))}async function aee(t,e){const r=Hr(t),c=r.Fa.get(e),h=r.Ma.get(c.targetId);r.isPrimaryClient&&h.length===1&&(r.sharedClientState.removeLocalQueryTarget(c.targetId),tj(r.remoteStore,c.targetId))}async function oee(t,e,r){const c=mee(t);try{const h=await function(w,o){const C=Hr(w),R=sa.now(),F=o.reduce((H,X)=>H.add(X.key),mn());let $,Y;return C.persistence.runTransaction("Locally write mutations","readwrite",H=>{let X=Gd(),he=mn();return C.cs.getEntries(H,F).next(se=>{X=se,X.forEach((de,K)=>{K.isValidDocument()||(he=he.add(de))})}).next(()=>C.localDocuments.getOverlayedDocuments(H,X)).next(se=>{$=se;const de=[];for(const K of o){const ge=IQ(K,$.get(K.key).overlayedDocument);ge!=null&&de.push(new kp(K.key,ge,LB(ge.value.mapValue),yc.exists(!0)))}return C.mutationQueue.addMutationBatch(H,R,de,o)}).next(se=>{Y=se;const de=se.applyToLocalDocumentSet($,he);return C.documentOverlayCache.saveOverlays(H,se.batchId,de)})}).then(()=>({batchId:Y.batchId,changes:ZB($)}))}(c.localStore,e);c.sharedClientState.addPendingMutation(h.batchId),function(w,o,C){let R=w.Ba[w.currentUser.toKey()];R||(R=new Ws(Fn)),R=R.insert(o,C),w.Ba[w.currentUser.toKey()]=R}(c,h.batchId,r),await Qv(c,h.changes),await cT(c.remoteStore)}catch(h){const x=aj(h,"Failed to persist write");r.reject(x)}}async function IV(t,e){const r=Hr(t);try{const c=await wJ(r.localStore,e);e.targetChanges.forEach((h,x)=>{const w=r.Na.get(x);w&&(Jn(h.addedDocuments.size+h.modifiedDocuments.size+h.removedDocuments.size<=1),h.addedDocuments.size>0?w.va=!0:h.modifiedDocuments.size>0?Jn(w.va):h.removedDocuments.size>0&&(Jn(w.va),w.va=!1))}),await Qv(r,c,e)}catch(c){await Wv(c)}}function z4(t,e,r){const c=Hr(t);if(c.isPrimaryClient&&r===0||!c.isPrimaryClient&&r===1){const h=[];c.Fa.forEach((x,w)=>{const o=w.view.Z_(e);o.snapshot&&h.push(o.snapshot)}),function(w,o){const C=Hr(w);C.onlineState=o;let R=!1;C.queries.forEach((F,$)=>{for(const Y of $.j_)Y.Z_(o)&&(R=!0)}),R&&oj(C)}(c.eventManager,e),h.length&&c.Ca.d_(h),c.onlineState=e,c.isPrimaryClient&&c.sharedClientState.setOnlineState(e)}}async function lee(t,e,r){const c=Hr(t);c.sharedClientState.updateQueryState(e,"rejected",r);const h=c.Na.get(e),x=h&&h.key;if(x){let w=new Ws(xr.comparator);w=w.insert(x,jo.newNoDocument(x,Gr.min()));const o=mn().add(x),C=new aT(Gr.min(),new Map,new Ws(Fn),w,o);await IV(c,C),c.Oa=c.Oa.remove(x),c.Na.delete(e),lj(c)}else await nI(c.localStore,e,!1).then(()=>aI(c,e,r)).catch(Wv)}async function cee(t,e){const r=Hr(t),c=e.batch.batchId;try{const h=await bJ(r.localStore,e);jV(r,c,null),PV(r,c),r.sharedClientState.updateMutationState(c,"acknowledged"),await Qv(r,h)}catch(h){await Wv(h)}}async function uee(t,e,r){const c=Hr(t);try{const h=await function(w,o){const C=Hr(w);return C.persistence.runTransaction("Reject batch","readwrite-primary",R=>{let F;return C.mutationQueue.lookupMutationBatch(R,o).next($=>(Jn($!==null),F=$.keys(),C.mutationQueue.removeMutationBatch(R,$))).next(()=>C.mutationQueue.performConsistencyCheck(R)).next(()=>C.documentOverlayCache.removeOverlaysForBatchId(R,F,o)).next(()=>C.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(R,F)).next(()=>C.localDocuments.getDocuments(R,F))})}(c.localStore,e);jV(c,e,r),PV(c,e),c.sharedClientState.updateMutationState(e,"rejected",r),await Qv(c,h)}catch(h){await Wv(h)}}function PV(t,e){(t.ka.get(e)||[]).forEach(r=>{r.resolve()}),t.ka.delete(e)}function jV(t,e,r){const c=Hr(t);let h=c.Ba[c.currentUser.toKey()];if(h){const x=h.get(e);x&&(r?x.reject(r):x.resolve(),h=h.remove(e)),c.Ba[c.currentUser.toKey()]=h}}function aI(t,e,r=null){t.sharedClientState.removeLocalQueryTarget(e);for(const c of t.Ma.get(e))t.Fa.delete(c),r&&t.Ca.$a(c,r);t.Ma.delete(e),t.isPrimaryClient&&t.La.gr(e).forEach(c=>{t.La.containsKey(c)||RV(t,c)})}function RV(t,e){t.xa.delete(e.path.canonicalString());const r=t.Oa.get(e);r!==null&&(tj(t.remoteStore,r),t.Oa=t.Oa.remove(e),t.Na.delete(r),lj(t))}function B4(t,e,r){for(const c of r)c instanceof AV?(t.La.addReference(c.key,e),dee(t,c)):c instanceof CV?(nr("SyncEngine","Document no longer in limbo: "+c.key),t.La.removeReference(c.key,e),t.La.containsKey(c.key)||RV(t,c.key)):zr()}function dee(t,e){const r=e.key,c=r.path.canonicalString();t.Oa.get(r)||t.xa.has(c)||(nr("SyncEngine","New document in limbo: "+r),t.xa.add(c),lj(t))}function lj(t){for(;t.xa.size>0&&t.Oa.size<t.maxConcurrentLimboResolutions;){const e=t.xa.values().next().value;t.xa.delete(e);const r=new xr(Ss.fromString(e)),c=t.qa.next();t.Na.set(c,new eee(r)),t.Oa=t.Oa.insert(r,c),yV(t.remoteStore,new ip($u(HP(r.path)),c,"TargetPurposeLimboResolution",BP.oe))}}async function Qv(t,e,r){const c=Hr(t),h=[],x=[],w=[];c.Fa.isEmpty()||(c.Fa.forEach((o,C)=>{w.push(c.Ka(C,e,r).then(R=>{var F;if((R||r)&&c.isPrimaryClient){const $=R?!R.fromCache:(F=r==null?void 0:r.targetChanges.get(C.targetId))===null||F===void 0?void 0:F.current;c.sharedClientState.updateQueryState(C.targetId,$?"current":"not-current")}if(R){h.push(R);const $=ej.Wi(C.targetId,R);x.push($)}}))}),await Promise.all(w),c.Ca.d_(h),await async function(C,R){const F=Hr(C);try{await F.persistence.runTransaction("notifyLocalViewChanges","readwrite",$=>pi.forEach(R,Y=>pi.forEach(Y.$i,H=>F.persistence.referenceDelegate.addReference($,Y.targetId,H)).next(()=>pi.forEach(Y.Ui,H=>F.persistence.referenceDelegate.removeReference($,Y.targetId,H)))))}catch($){if(!Zv($))throw $;nr("LocalStore","Failed to update sequence numbers: "+$)}for(const $ of R){const Y=$.targetId;if(!$.fromCache){const H=F.os.get(Y),X=H.snapshotVersion,he=H.withLastLimboFreeSnapshotVersion(X);F.os=F.os.insert(Y,he)}}}(c.localStore,x))}async function hee(t,e){const r=Hr(t);if(!r.currentUser.isEqual(e)){nr("SyncEngine","User change. New user:",e.toKey());const c=await pV(r.localStore,e);r.currentUser=e,function(x,w){x.ka.forEach(o=>{o.forEach(C=>{C.reject(new Wi(ti.CANCELLED,w))})}),x.ka.clear()}(r,"'waitForPendingWrites' promise is rejected due to a user change."),r.sharedClientState.handleUserChange(e,c.removedBatchIds,c.addedBatchIds),await Qv(r,c.hs)}}function pee(t,e){const r=Hr(t),c=r.Na.get(e);if(c&&c.va)return mn().add(c.key);{let h=mn();const x=r.Ma.get(e);if(!x)return h;for(const w of x){const o=r.Fa.get(w);h=h.unionWith(o.view.Va)}return h}}function kV(t){const e=Hr(t);return e.remoteStore.remoteSyncer.applyRemoteEvent=IV.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=pee.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=lee.bind(null,e),e.Ca.d_=YJ.bind(null,e.eventManager),e.Ca.$a=KJ.bind(null,e.eventManager),e}function mee(t){const e=Hr(t);return e.remoteStore.remoteSyncer.applySuccessfulWrite=cee.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=uee.bind(null,e),e}class pS{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(e){this.serializer=oT(e.databaseInfo.databaseId),this.sharedClientState=this.Wa(e),this.persistence=this.Ga(e),await this.persistence.start(),this.localStore=this.za(e),this.gcScheduler=this.ja(e,this.localStore),this.indexBackfillerScheduler=this.Ha(e,this.localStore)}ja(e,r){return null}Ha(e,r){return null}za(e){return vJ(this.persistence,new xJ,e.initialUser,this.serializer)}Ga(e){return new fJ(JP.Zr,this.serializer)}Wa(e){return new CJ}async terminate(){var e,r;(e=this.gcScheduler)===null||e===void 0||e.stop(),(r=this.indexBackfillerScheduler)===null||r===void 0||r.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}pS.provider={build:()=>new pS};class oI{async initialize(e,r){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(r),this.remoteStore=this.createRemoteStore(r),this.eventManager=this.createEventManager(r),this.syncEngine=this.createSyncEngine(r,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=c=>z4(this.syncEngine,c,1),this.remoteStore.remoteSyncer.handleCredentialChange=hee.bind(null,this.syncEngine),await WJ(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return function(){return new XJ}()}createDatastore(e){const r=oT(e.databaseInfo.databaseId),c=function(x){return new jJ(x)}(e.databaseInfo);return function(x,w,o,C){return new DJ(x,w,o,C)}(e.authCredentials,e.appCheckCredentials,c,r)}createRemoteStore(e){return function(c,h,x,w,o){return new OJ(c,h,x,w,o)}(this.localStore,this.datastore,e.asyncQueue,r=>z4(this.syncEngine,r,0),function(){return D4.D()?new D4:new EJ}())}createSyncEngine(e,r){return function(h,x,w,o,C,R,F){const $=new tee(h,x,w,o,C,R);return F&&($.Qa=!0),$}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,r)}async terminate(){var e,r;await async function(h){const x=Hr(h);nr("RemoteStore","RemoteStore shutting down."),x.L_.add(5),await Kv(x),x.k_.shutdown(),x.q_.set("Unknown")}(this.remoteStore),(e=this.datastore)===null||e===void 0||e.terminate(),(r=this.eventManager)===null||r===void 0||r.terminate()}}oI.provider={build:()=>new oI};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class DV{constructor(e){this.observer=e,this.muted=!1}next(e){this.muted||this.observer.next&&this.Ya(this.observer.next,e)}error(e){this.muted||(this.observer.error?this.Ya(this.observer.error,e):$d("Uncaught Error in snapshot listener:",e.toString()))}Za(){this.muted=!0}Ya(e,r){setTimeout(()=>{this.muted||e(r)},0)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class fee{constructor(e,r,c,h,x){this.authCredentials=e,this.appCheckCredentials=r,this.asyncQueue=c,this.databaseInfo=h,this.user=Io.UNAUTHENTICATED,this.clientId=DB.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=x,this.authCredentials.start(c,async w=>{nr("FirestoreClient","Received user=",w.uid),await this.authCredentialListener(w),this.user=w}),this.appCheckCredentials.start(c,w=>(nr("FirestoreClient","Received new app check token=",w),this.appCheckCredentialListener(w,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}terminate(){this.asyncQueue.enterRestrictedMode();const e=new Od;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(r){const c=aj(r,"Failed to shutdown persistence");e.reject(c)}}),e.promise}}async function jC(t,e){t.asyncQueue.verifyOperationInProgress(),nr("FirestoreClient","Initializing OfflineComponentProvider");const r=t.configuration;await e.initialize(r);let c=r.initialUser;t.setCredentialChangeListener(async h=>{c.isEqual(h)||(await pV(e.localStore,h),c=h)}),e.persistence.setDatabaseDeletedListener(()=>t.terminate()),t._offlineComponents=e}async function V4(t,e){t.asyncQueue.verifyOperationInProgress();const r=await gee(t);nr("FirestoreClient","Initializing OnlineComponentProvider"),await e.initialize(r,t.configuration),t.setCredentialChangeListener(c=>M4(e.remoteStore,c)),t.setAppCheckTokenChangeListener((c,h)=>M4(e.remoteStore,h)),t._onlineComponents=e}async function gee(t){if(!t._offlineComponents)if(t._uninitializedComponentsProvider){nr("FirestoreClient","Using user provided OfflineComponentProvider");try{await jC(t,t._uninitializedComponentsProvider._offline)}catch(e){const r=e;if(!function(h){return h.name==="FirebaseError"?h.code===ti.FAILED_PRECONDITION||h.code===ti.UNIMPLEMENTED:!(typeof DOMException<"u"&&h instanceof DOMException)||h.code===22||h.code===20||h.code===11}(r))throw r;Ry("Error using user provided cache. Falling back to memory cache: "+r),await jC(t,new pS)}}else nr("FirestoreClient","Using default OfflineComponentProvider"),await jC(t,new pS);return t._offlineComponents}async function MV(t){return t._onlineComponents||(t._uninitializedComponentsProvider?(nr("FirestoreClient","Using user provided OnlineComponentProvider"),await V4(t,t._uninitializedComponentsProvider._online)):(nr("FirestoreClient","Using default OnlineComponentProvider"),await V4(t,new oI))),t._onlineComponents}function yee(t){return MV(t).then(e=>e.syncEngine)}async function OV(t){const e=await MV(t),r=e.eventManager;return r.onListen=iee.bind(null,e.syncEngine),r.onUnlisten=see.bind(null,e.syncEngine),r.onFirstRemoteStoreListen=ree.bind(null,e.syncEngine),r.onLastRemoteStoreUnlisten=aee.bind(null,e.syncEngine),r}function xee(t,e,r={}){const c=new Od;return t.asyncQueue.enqueueAndForget(async()=>function(x,w,o,C,R){const F=new DV({next:Y=>{F.Za(),w.enqueueAndForget(()=>TV(x,$));const H=Y.docs.has(o);!H&&Y.fromCache?R.reject(new Wi(ti.UNAVAILABLE,"Failed to get document because the client is offline.")):H&&Y.fromCache&&C&&C.source==="server"?R.reject(new Wi(ti.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):R.resolve(Y)},error:Y=>R.reject(Y)}),$=new NV(HP(o.path),F,{includeMetadataChanges:!0,_a:!0});return SV(x,$)}(await OV(t),t.asyncQueue,e,r,c)),c.promise}function _ee(t,e,r={}){const c=new Od;return t.asyncQueue.enqueueAndForget(async()=>function(x,w,o,C,R){const F=new DV({next:Y=>{F.Za(),w.enqueueAndForget(()=>TV(x,$)),Y.fromCache&&C.source==="server"?R.reject(new Wi(ti.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):R.resolve(Y)},error:Y=>R.reject(Y)}),$=new NV(o,F,{includeMetadataChanges:!0,_a:!0});return SV(x,$)}(await OV(t),t.asyncQueue,e,r,c)),c.promise}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function LV(t){const e={};return t.timeoutSeconds!==void 0&&(e.timeoutSeconds=t.timeoutSeconds),e}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const U4=new Map;/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function FV(t,e,r){if(!r)throw new Wi(ti.INVALID_ARGUMENT,`Function ${t}() cannot be called with an empty ${e}.`)}function vee(t,e,r,c){if(e===!0&&c===!0)throw new Wi(ti.INVALID_ARGUMENT,`${t} and ${r} cannot be used together.`)}function q4(t){if(!xr.isDocumentKey(t))throw new Wi(ti.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${t} has ${t.length}.`)}function $4(t){if(xr.isDocumentKey(t))throw new Wi(ti.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${t} has ${t.length}.`)}function uT(t){if(t===void 0)return"undefined";if(t===null)return"null";if(typeof t=="string")return t.length>20&&(t=`${t.substring(0,20)}...`),JSON.stringify(t);if(typeof t=="number"||typeof t=="boolean")return""+t;if(typeof t=="object"){if(t instanceof Array)return"an array";{const e=function(c){return c.constructor?c.constructor.name:null}(t);return e?`a custom ${e} object`:"an object"}}return typeof t=="function"?"a function":zr()}function Kc(t,e){if("_delegate"in t&&(t=t._delegate),!(t instanceof e)){if(e.name===t.constructor.name)throw new Wi(ti.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const r=uT(t);throw new Wi(ti.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${r}`)}}return t}function bee(t,e){if(e<=0)throw new Wi(ti.INVALID_ARGUMENT,`Function ${t}() requires a positive number, but it was: ${e}.`)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class G4{constructor(e){var r,c;if(e.host===void 0){if(e.ssl!==void 0)throw new Wi(ti.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=(r=e.ssl)===null||r===void 0||r;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,e.cacheSizeBytes===void 0)this.cacheSizeBytes=41943040;else{if(e.cacheSizeBytes!==-1&&e.cacheSizeBytes<1048576)throw new Wi(ti.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}vee("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:e.experimentalAutoDetectLongPolling===void 0?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=LV((c=e.experimentalLongPollingOptions)!==null&&c!==void 0?c:{}),function(x){if(x.timeoutSeconds!==void 0){if(isNaN(x.timeoutSeconds))throw new Wi(ti.INVALID_ARGUMENT,`invalid long polling timeout: ${x.timeoutSeconds} (must not be NaN)`);if(x.timeoutSeconds<5)throw new Wi(ti.INVALID_ARGUMENT,`invalid long polling timeout: ${x.timeoutSeconds} (minimum allowed value is 5)`);if(x.timeoutSeconds>30)throw new Wi(ti.INVALID_ARGUMENT,`invalid long polling timeout: ${x.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&function(c,h){return c.timeoutSeconds===h.timeoutSeconds}(this.experimentalLongPollingOptions,e.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class dT{constructor(e,r,c,h){this._authCredentials=e,this._appCheckCredentials=r,this._databaseId=c,this._app=h,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new G4({}),this._settingsFrozen=!1,this._terminateTask="notTerminated"}get app(){if(!this._app)throw new Wi(ti.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return this._terminateTask!=="notTerminated"}_setSettings(e){if(this._settingsFrozen)throw new Wi(ti.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new G4(e),e.credentials!==void 0&&(this._authCredentials=function(c){if(!c)return new LK;switch(c.type){case"firstParty":return new VK(c.sessionIndex||"0",c.iamToken||null,c.authTokenFactory||null);case"provider":return c.client;default:throw new Wi(ti.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask==="notTerminated"&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){this._terminateTask==="notTerminated"?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(r){const c=U4.get(r);c&&(nr("ComponentProvider","Removing Datastore"),U4.delete(r),c.terminate())}(this),Promise.resolve()}}function wee(t,e,r,c={}){var h;const x=(t=Kc(t,dT))._getSettings(),w=`${e}:${r}`;if(x.host!=="firestore.googleapis.com"&&x.host!==w&&Ry("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),t._setSettings(Object.assign(Object.assign({},x),{host:w,ssl:!1})),c.mockUserToken){let o,C;if(typeof c.mockUserToken=="string")o=c.mockUserToken,C=Io.MOCK_USER;else{o=Vz(c.mockUserToken,(h=t._app)===null||h===void 0?void 0:h.options.projectId);const R=c.mockUserToken.sub||c.mockUserToken.user_id;if(!R)throw new Wi(ti.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");C=new Io(R)}t._authCredentials=new FK(new kB(o,C))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Dp{constructor(e,r,c){this.converter=r,this._query=c,this.type="query",this.firestore=e}withConverter(e){return new Dp(this.firestore,e,this._query)}}class tl{constructor(e,r,c){this.converter=r,this._key=c,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new yp(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new tl(this.firestore,e,this._key)}}class yp extends Dp{constructor(e,r,c){super(e,r,HP(c)),this._path=c,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new tl(this.firestore,null,new xr(e))}withConverter(e){return new yp(this.firestore,e,this._path)}}function Mp(t,e,...r){if(t=As(t),FV("collection","path",e),t instanceof dT){const c=Ss.fromString(e,...r);return $4(c),new yp(t,null,c)}{if(!(t instanceof tl||t instanceof yp))throw new Wi(ti.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const c=t._path.child(Ss.fromString(e,...r));return $4(c),new yp(t.firestore,null,c)}}function qn(t,e,...r){if(t=As(t),arguments.length===1&&(e=DB.newId()),FV("doc","path",e),t instanceof dT){const c=Ss.fromString(e,...r);return q4(c),new tl(t,null,new xr(c))}{if(!(t instanceof tl||t instanceof yp))throw new Wi(ti.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const c=t._path.child(Ss.fromString(e,...r));return q4(c),new tl(t.firestore,t instanceof yp?t.converter:null,new xr(c))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class H4{constructor(e=Promise.resolve()){this.Pu=[],this.Iu=!1,this.Tu=[],this.Eu=null,this.du=!1,this.Au=!1,this.Ru=[],this.t_=new fV(this,"async_queue_retry"),this.Vu=()=>{const c=PC();c&&nr("AsyncQueue","Visibility state changed to "+c.visibilityState),this.t_.jo()},this.mu=e;const r=PC();r&&typeof r.addEventListener=="function"&&r.addEventListener("visibilitychange",this.Vu)}get isShuttingDown(){return this.Iu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.fu(),this.gu(e)}enterRestrictedMode(e){if(!this.Iu){this.Iu=!0,this.Au=e||!1;const r=PC();r&&typeof r.removeEventListener=="function"&&r.removeEventListener("visibilitychange",this.Vu)}}enqueue(e){if(this.fu(),this.Iu)return new Promise(()=>{});const r=new Od;return this.gu(()=>this.Iu&&this.Au?Promise.resolve():(e().then(r.resolve,r.reject),r.promise)).then(()=>r.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Pu.push(e),this.pu()))}async pu(){if(this.Pu.length!==0){try{await this.Pu[0](),this.Pu.shift(),this.t_.reset()}catch(e){if(!Zv(e))throw e;nr("AsyncQueue","Operation failed with retryable error: "+e)}this.Pu.length>0&&this.t_.Go(()=>this.pu())}}gu(e){const r=this.mu.then(()=>(this.du=!0,e().catch(c=>{this.Eu=c,this.du=!1;const h=function(w){let o=w.message||"";return w.stack&&(o=w.stack.includes(w.message)?w.stack:w.message+`
`+w.stack),o}(c);throw $d("INTERNAL UNHANDLED ERROR: ",h),c}).then(c=>(this.du=!1,c))));return this.mu=r,r}enqueueAfterDelay(e,r,c){this.fu(),this.Ru.indexOf(e)>-1&&(r=0);const h=sj.createAndSchedule(this,e,r,c,x=>this.yu(x));return this.Tu.push(h),h}fu(){this.Eu&&zr()}verifyOperationInProgress(){}async wu(){let e;do e=this.mu,await e;while(e!==this.mu)}Su(e){for(const r of this.Tu)if(r.timerId===e)return!0;return!1}bu(e){return this.wu().then(()=>{this.Tu.sort((r,c)=>r.targetTimeMs-c.targetTimeMs);for(const r of this.Tu)if(r.skipDelay(),e!=="all"&&r.timerId===e)break;return this.wu()})}Du(e){this.Ru.push(e)}yu(e){const r=this.Tu.indexOf(e);this.Tu.splice(r,1)}}class vf extends dT{constructor(e,r,c,h){super(e,r,c,h),this.type="firestore",this._queue=new H4,this._persistenceKey=(h==null?void 0:h.name)||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){const e=this._firestoreClient.terminate();this._queue=new H4(e),this._firestoreClient=void 0,await e}}}function See(t,e){const r=typeof t=="object"?t:IP(),c=typeof t=="string"?t:"(default)",h=YS(r,"firestore").getImmediate({identifier:c});if(!h._initialized){const x=Fz("firestore");x&&wee(h,...x)}return h}function cj(t){if(t._terminated)throw new Wi(ti.FAILED_PRECONDITION,"The client has already been terminated.");return t._firestoreClient||Tee(t),t._firestoreClient}function Tee(t){var e,r,c;const h=t._freezeSettings(),x=function(o,C,R,F){return new eQ(o,C,R,F.host,F.ssl,F.experimentalForceLongPolling,F.experimentalAutoDetectLongPolling,LV(F.experimentalLongPollingOptions),F.useFetchStreams)}(t._databaseId,((e=t._app)===null||e===void 0?void 0:e.options.appId)||"",t._persistenceKey,h);t._componentsProvider||!((r=h.localCache)===null||r===void 0)&&r._offlineComponentProvider&&(!((c=h.localCache)===null||c===void 0)&&c._onlineComponentProvider)&&(t._componentsProvider={_offline:h.localCache._offlineComponentProvider,_online:h.localCache._onlineComponentProvider}),t._firestoreClient=new fee(t._authCredentials,t._appCheckCredentials,t._queue,x,t._componentsProvider&&function(o){const C=o==null?void 0:o._online.build();return{_offline:o==null?void 0:o._offline.build(C),_online:C}}(t._componentsProvider))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Fy{constructor(e){this._byteString=e}static fromBase64String(e){try{return new Fy(fo.fromBase64String(e))}catch(r){throw new Wi(ti.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+r)}}static fromUint8Array(e){return new Fy(fo.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class hT{constructor(...e){for(let r=0;r<e.length;++r)if(e[r].length===0)throw new Wi(ti.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new co(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class pT{constructor(e){this._methodName=e}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class uj{constructor(e,r){if(!isFinite(e)||e<-90||e>90)throw new Wi(ti.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(r)||r<-180||r>180)throw new Wi(ti.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+r);this._lat=e,this._long=r}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return Fn(this._lat,e._lat)||Fn(this._long,e._long)}}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class dj{constructor(e){this._values=(e||[]).map(r=>r)}toArray(){return this._values.map(e=>e)}isEqual(e){return function(c,h){if(c.length!==h.length)return!1;for(let x=0;x<c.length;++x)if(c[x]!==h[x])return!1;return!0}(this._values,e._values)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Nee=/^__.*__$/;class Aee{constructor(e,r,c){this.data=e,this.fieldMask=r,this.fieldTransforms=c}toMutation(e,r){return this.fieldMask!==null?new kp(e,this.data,this.fieldMask,r,this.fieldTransforms):new Xv(e,this.data,r,this.fieldTransforms)}}class zV{constructor(e,r,c){this.data=e,this.fieldMask=r,this.fieldTransforms=c}toMutation(e,r){return new kp(e,this.data,this.fieldMask,r,this.fieldTransforms)}}function BV(t){switch(t){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw zr()}}class hj{constructor(e,r,c,h,x,w){this.settings=e,this.databaseId=r,this.serializer=c,this.ignoreUndefinedProperties=h,x===void 0&&this.vu(),this.fieldTransforms=x||[],this.fieldMask=w||[]}get path(){return this.settings.path}get Cu(){return this.settings.Cu}Fu(e){return new hj(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Mu(e){var r;const c=(r=this.path)===null||r===void 0?void 0:r.child(e),h=this.Fu({path:c,xu:!1});return h.Ou(e),h}Nu(e){var r;const c=(r=this.path)===null||r===void 0?void 0:r.child(e),h=this.Fu({path:c,xu:!1});return h.vu(),h}Lu(e){return this.Fu({path:void 0,xu:!0})}Bu(e){return mS(e,this.settings.methodName,this.settings.ku||!1,this.path,this.settings.qu)}contains(e){return this.fieldMask.find(r=>e.isPrefixOf(r))!==void 0||this.fieldTransforms.find(r=>e.isPrefixOf(r.field))!==void 0}vu(){if(this.path)for(let e=0;e<this.path.length;e++)this.Ou(this.path.get(e))}Ou(e){if(e.length===0)throw this.Bu("Document fields must not be empty");if(BV(this.Cu)&&Nee.test(e))throw this.Bu('Document fields cannot begin and end with "__"')}}class Cee{constructor(e,r,c){this.databaseId=e,this.ignoreUndefinedProperties=r,this.serializer=c||oT(e)}Qu(e,r,c,h=!1){return new hj({Cu:e,methodName:r,qu:c,path:co.emptyPath(),xu:!1,ku:h},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function mT(t){const e=t._freezeSettings(),r=oT(t._databaseId);return new Cee(t._databaseId,!!e.ignoreUndefinedProperties,r)}function VV(t,e,r,c,h,x={}){const w=t.Qu(x.merge||x.mergeFields?2:0,e,r,h);mj("Data must be an object, but it was:",w,c);const o=UV(c,w);let C,R;if(x.merge)C=new Ml(w.fieldMask),R=w.fieldTransforms;else if(x.mergeFields){const F=[];for(const $ of x.mergeFields){const Y=lI(e,$,r);if(!w.contains(Y))throw new Wi(ti.INVALID_ARGUMENT,`Field '${Y}' is specified in your field mask but missing from your input data.`);$V(F,Y)||F.push(Y)}C=new Ml(F),R=w.fieldTransforms.filter($=>C.covers($.field))}else C=null,R=w.fieldTransforms;return new Aee(new gl(o),C,R)}class fT extends pT{_toFieldTransform(e){if(e.Cu!==2)throw e.Cu===1?e.Bu(`${this._methodName}() can only appear at the top level of your update data`):e.Bu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof fT}}class pj extends pT{_toFieldTransform(e){return new NQ(e.path,new Ev)}isEqual(e){return e instanceof pj}}function Eee(t,e,r,c){const h=t.Qu(1,e,r);mj("Data must be an object, but it was:",h,c);const x=[],w=gl.empty();xf(c,(C,R)=>{const F=fj(e,C,r);R=As(R);const $=h.Nu(F);if(R instanceof fT)x.push(F);else{const Y=Jv(R,$);Y!=null&&(x.push(F),w.set(F,Y))}});const o=new Ml(x);return new zV(w,o,h.fieldTransforms)}function Iee(t,e,r,c,h,x){const w=t.Qu(1,e,r),o=[lI(e,c,r)],C=[h];if(x.length%2!=0)throw new Wi(ti.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let Y=0;Y<x.length;Y+=2)o.push(lI(e,x[Y])),C.push(x[Y+1]);const R=[],F=gl.empty();for(let Y=o.length-1;Y>=0;--Y)if(!$V(R,o[Y])){const H=o[Y];let X=C[Y];X=As(X);const he=w.Nu(H);if(X instanceof fT)R.push(H);else{const se=Jv(X,he);se!=null&&(R.push(H),F.set(H,se))}}const $=new Ml(R);return new zV(F,$,w.fieldTransforms)}function Pee(t,e,r,c=!1){return Jv(r,t.Qu(c?4:3,e))}function Jv(t,e){if(qV(t=As(t)))return mj("Unsupported field value:",e,t),UV(t,e);if(t instanceof pT)return function(c,h){if(!BV(h.Cu))throw h.Bu(`${c._methodName}() can only be used with update() and set()`);if(!h.path)throw h.Bu(`${c._methodName}() is not currently supported inside arrays`);const x=c._toFieldTransform(h);x&&h.fieldTransforms.push(x)}(t,e),null;if(t===void 0&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.settings.xu&&e.Cu!==4)throw e.Bu("Nested arrays are not supported");return function(c,h){const x=[];let w=0;for(const o of c){let C=Jv(o,h.Lu(w));C==null&&(C={nullValue:"NULL_VALUE"}),x.push(C),w++}return{arrayValue:{values:x}}}(t,e)}return function(c,h){if((c=As(c))===null)return{nullValue:"NULL_VALUE"};if(typeof c=="number")return wQ(h.serializer,c);if(typeof c=="boolean")return{booleanValue:c};if(typeof c=="string")return{stringValue:c};if(c instanceof Date){const x=sa.fromDate(c);return{timestampValue:dS(h.serializer,x)}}if(c instanceof sa){const x=new sa(c.seconds,1e3*Math.floor(c.nanoseconds/1e3));return{timestampValue:dS(h.serializer,x)}}if(c instanceof uj)return{geoPointValue:{latitude:c.latitude,longitude:c.longitude}};if(c instanceof Fy)return{bytesValue:aV(h.serializer,c._byteString)};if(c instanceof tl){const x=h.databaseId,w=c.firestore._databaseId;if(!w.isEqual(x))throw h.Bu(`Document reference is for database ${w.projectId}/${w.database} but should be for database ${x.projectId}/${x.database}`);return{referenceValue:KP(c.firestore._databaseId||h.databaseId,c._key.path)}}if(c instanceof dj)return function(w,o){return{mapValue:{fields:{__type__:{stringValue:"__vector__"},value:{arrayValue:{values:w.toArray().map(C=>{if(typeof C!="number")throw o.Bu("VectorValues must only contain numeric values.");return WP(o.serializer,C)})}}}}}}(c,h);throw h.Bu(`Unsupported field value: ${uT(c)}`)}(t,e)}function UV(t,e){const r={};return MB(t)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):xf(t,(c,h)=>{const x=Jv(h,e.Mu(c));x!=null&&(r[c]=x)}),{mapValue:{fields:r}}}function qV(t){return!(typeof t!="object"||t===null||t instanceof Array||t instanceof Date||t instanceof sa||t instanceof uj||t instanceof Fy||t instanceof tl||t instanceof pT||t instanceof dj)}function mj(t,e,r){if(!qV(r)||!function(h){return typeof h=="object"&&h!==null&&(Object.getPrototypeOf(h)===Object.prototype||Object.getPrototypeOf(h)===null)}(r)){const c=uT(r);throw c==="an object"?e.Bu(t+" a custom object"):e.Bu(t+" "+c)}}function lI(t,e,r){if((e=As(e))instanceof hT)return e._internalPath;if(typeof e=="string")return fj(t,e);throw mS("Field path arguments must be of type string or ",t,!1,void 0,r)}const jee=new RegExp("[~\\*/\\[\\]]");function fj(t,e,r){if(e.search(jee)>=0)throw mS(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,r);try{return new hT(...e.split("."))._internalPath}catch{throw mS(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,r)}}function mS(t,e,r,c,h){const x=c&&!c.isEmpty(),w=h!==void 0;let o=`Function ${e}() called with invalid data`;r&&(o+=" (via `toFirestore()`)"),o+=". ";let C="";return(x||w)&&(C+=" (found",x&&(C+=` in field ${c}`),w&&(C+=` in document ${h}`),C+=")"),new Wi(ti.INVALID_ARGUMENT,o+t+C)}function $V(t,e){return t.some(r=>r.isEqual(e))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class GV{constructor(e,r,c,h,x){this._firestore=e,this._userDataWriter=r,this._key=c,this._document=h,this._converter=x}get id(){return this._key.path.lastSegment()}get ref(){return new tl(this._firestore,this._converter,this._key)}exists(){return this._document!==null}data(){if(this._document){if(this._converter){const e=new Ree(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const r=this._document.data.field(gT("DocumentSnapshot.get",e));if(r!==null)return this._userDataWriter.convertValue(r)}}}class Ree extends GV{data(){return super.data()}}function gT(t,e){return typeof e=="string"?fj(t,e):e instanceof hT?e._internalPath:e._delegate._internalPath}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function kee(t){if(t.limitType==="L"&&t.explicitOrderBy.length===0)throw new Wi(ti.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class gj{}class yj extends gj{}function is(t,e,...r){let c=[];e instanceof gj&&c.push(e),c=c.concat(r),function(x){const w=x.filter(C=>C instanceof xj).length,o=x.filter(C=>C instanceof yT).length;if(w>1||w>0&&o>0)throw new Wi(ti.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(c);for(const h of c)t=h._apply(t);return t}class yT extends yj{constructor(e,r,c){super(),this._field=e,this._op=r,this._value=c,this.type="where"}static _create(e,r,c){return new yT(e,r,c)}_apply(e){const r=this._parse(e);return HV(e._query,r),new Dp(e.firestore,e.converter,JE(e._query,r))}_parse(e){const r=mT(e.firestore);return function(x,w,o,C,R,F,$){let Y;if(R.isKeyField()){if(F==="array-contains"||F==="array-contains-any")throw new Wi(ti.INVALID_ARGUMENT,`Invalid Query. You can't perform '${F}' queries on documentId().`);if(F==="in"||F==="not-in"){Z4($,F);const H=[];for(const X of $)H.push(W4(C,x,X));Y={arrayValue:{values:H}}}else Y=W4(C,x,$)}else F!=="in"&&F!=="not-in"&&F!=="array-contains-any"||Z4($,F),Y=Pee(o,w,$,F==="in"||F==="not-in");return Aa.create(R,F,Y)}(e._query,"where",r,e.firestore._databaseId,this._field,this._op,this._value)}}function ha(t,e,r){const c=e,h=gT("where",t);return yT._create(h,c,r)}class xj extends gj{constructor(e,r){super(),this.type=e,this._queryConstraints=r}static _create(e,r){return new xj(e,r)}_parse(e){const r=this._queryConstraints.map(c=>c._parse(e)).filter(c=>c.getFilters().length>0);return r.length===1?r[0]:Yc.create(r,this._getOperator())}_apply(e){const r=this._parse(e);return r.getFilters().length===0?e:(function(h,x){let w=h;const o=x.getFlattenedFilters();for(const C of o)HV(w,C),w=JE(w,C)}(e._query,r),new Dp(e.firestore,e.converter,JE(e._query,r)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return this.type==="and"?"and":"or"}}class _j extends yj{constructor(e,r){super(),this._field=e,this._direction=r,this.type="orderBy"}static _create(e,r){return new _j(e,r)}_apply(e){const r=function(h,x,w){if(h.startAt!==null)throw new Wi(ti.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(h.endAt!==null)throw new Wi(ti.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new Cv(x,w)}(e._query,this._field,this._direction);return new Dp(e.firestore,e.converter,function(h,x){const w=h.explicitOrderBy.concat([x]);return new Xy(h.path,h.collectionGroup,w,h.filters.slice(),h.limit,h.limitType,h.startAt,h.endAt)}(e._query,r))}}function pa(t,e="asc"){const r=e,c=gT("orderBy",t);return _j._create(c,r)}class vj extends yj{constructor(e,r,c){super(),this.type=e,this._limit=r,this._limitType=c}static _create(e,r,c){return new vj(e,r,c)}_apply(e){return new Dp(e.firestore,e.converter,cS(e._query,this._limit,this._limitType))}}function Qy(t){return bee("limit",t),vj._create("limit",t,"F")}function W4(t,e,r){if(typeof(r=As(r))=="string"){if(r==="")throw new Wi(ti.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!$B(e)&&r.indexOf("/")!==-1)throw new Wi(ti.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${r}' contains a '/' character.`);const c=e.path.child(Ss.fromString(r));if(!xr.isDocumentKey(c))throw new Wi(ti.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${c}' is not because it has an odd number of segments (${c.length}).`);return f4(t,new xr(c))}if(r instanceof tl)return f4(t,r._key);throw new Wi(ti.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${uT(r)}.`)}function Z4(t,e){if(!Array.isArray(t)||t.length===0)throw new Wi(ti.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`)}function HV(t,e){const r=function(h,x){for(const w of h)for(const o of w.getFlattenedFilters())if(x.indexOf(o.op)>=0)return o.op;return null}(t.filters,function(h){switch(h){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(r!==null)throw r===e.op?new Wi(ti.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new Wi(ti.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${r.toString()}' filters.`)}class Dee{convertValue(e,r="none"){switch(af(e)){case 0:return null;case 1:return e.booleanValue;case 2:return da(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,r);case 5:return e.stringValue;case 6:return this.convertBytes(sf(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,r);case 11:return this.convertObject(e.mapValue,r);case 10:return this.convertVectorValue(e.mapValue);default:throw zr()}}convertObject(e,r){return this.convertObjectMap(e.fields,r)}convertObjectMap(e,r="none"){const c={};return xf(e,(h,x)=>{c[h]=this.convertValue(x,r)}),c}convertVectorValue(e){var r,c,h;const x=(h=(c=(r=e.fields)===null||r===void 0?void 0:r.value.arrayValue)===null||c===void 0?void 0:c.values)===null||h===void 0?void 0:h.map(w=>da(w.doubleValue));return new dj(x)}convertGeoPoint(e){return new uj(da(e.latitude),da(e.longitude))}convertArray(e,r){return(e.values||[]).map(c=>this.convertValue(c,r))}convertServerTimestamp(e,r){switch(r){case"previous":const c=UP(e);return c==null?null:this.convertValue(c,r);case"estimate":return this.convertTimestamp(Tv(e));default:return null}}convertTimestamp(e){const r=Tp(e);return new sa(r.seconds,r.nanos)}convertDocumentKey(e,r){const c=Ss.fromString(e);Jn(hV(c));const h=new Nv(c.get(1),c.get(3)),x=new xr(c.popFirst(5));return h.isEqual(r)||$d(`Document ${x} contains a document reference within a different database (${h.projectId}/${h.database}) which is not supported. It will be treated as a reference in the current database (${r.projectId}/${r.database}) instead.`),x}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function WV(t,e,r){let c;return c=t?r&&(r.merge||r.mergeFields)?t.toFirestore(e,r):t.toFirestore(e):e,c}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class k0{constructor(e,r){this.hasPendingWrites=e,this.fromCache=r}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class ZV extends GV{constructor(e,r,c,h,x,w){super(e,r,c,h,w),this._firestore=e,this._firestoreImpl=e,this.metadata=x}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const r=new x2(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(r,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,r={}){if(this._document){const c=this._document.data.field(gT("DocumentSnapshot.get",e));if(c!==null)return this._userDataWriter.convertValue(c,r.serverTimestamps)}}}class x2 extends ZV{data(e={}){return super.data(e)}}class Mee{constructor(e,r,c,h){this._firestore=e,this._userDataWriter=r,this._snapshot=h,this.metadata=new k0(h.hasPendingWrites,h.fromCache),this.query=c}get docs(){const e=[];return this.forEach(r=>e.push(r)),e}get size(){return this._snapshot.docs.size}get empty(){return this.size===0}forEach(e,r){this._snapshot.docs.forEach(c=>{e.call(r,new x2(this._firestore,this._userDataWriter,c.key,c,new k0(this._snapshot.mutatedKeys.has(c.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){const r=!!e.includeMetadataChanges;if(r&&this._snapshot.excludesMetadataChanges)throw new Wi(ti.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===r||(this._cachedChanges=function(h,x){if(h._snapshot.oldDocs.isEmpty()){let w=0;return h._snapshot.docChanges.map(o=>{const C=new x2(h._firestore,h._userDataWriter,o.doc.key,o.doc,new k0(h._snapshot.mutatedKeys.has(o.doc.key),h._snapshot.fromCache),h.query.converter);return o.doc,{type:"added",doc:C,oldIndex:-1,newIndex:w++}})}{let w=h._snapshot.oldDocs;return h._snapshot.docChanges.filter(o=>x||o.type!==3).map(o=>{const C=new x2(h._firestore,h._userDataWriter,o.doc.key,o.doc,new k0(h._snapshot.mutatedKeys.has(o.doc.key),h._snapshot.fromCache),h.query.converter);let R=-1,F=-1;return o.type!==0&&(R=w.indexOf(o.doc.key),w=w.delete(o.doc.key)),o.type!==1&&(w=w.add(o.doc),F=w.indexOf(o.doc.key)),{type:Oee(o.type),doc:C,oldIndex:R,newIndex:F}})}}(this,r),this._cachedChangesIncludeMetadataChanges=r),this._cachedChanges}}function Oee(t){switch(t){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return zr()}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ap(t){t=Kc(t,tl);const e=Kc(t.firestore,vf);return xee(cj(e),t._key).then(r=>Lee(e,t,r))}class XV extends Dee{constructor(e){super(),this.firestore=e}convertBytes(e){return new Fy(e)}convertReference(e){const r=this.convertDocumentKey(e,this.firestore._databaseId);return new tl(this.firestore,null,r)}}function Kd(t){t=Kc(t,Dp);const e=Kc(t.firestore,vf),r=cj(e),c=new XV(e);return kee(t._query),_ee(r,t._query).then(h=>new Mee(e,c,t,h))}function cI(t,e,r){t=Kc(t,tl);const c=Kc(t.firestore,vf),h=WV(t.converter,e,r);return xT(c,[VV(mT(c),"setDoc",t._key,h,t.converter!==null,r).toMutation(t._key,yc.none())])}function Gl(t,e,r,...c){t=Kc(t,tl);const h=Kc(t.firestore,vf),x=mT(h);let w;return w=typeof(e=As(e))=="string"||e instanceof hT?Iee(x,"updateDoc",t._key,e,r,c):Eee(x,"updateDoc",t._key,e),xT(h,[w.toMutation(t._key,yc.exists(!0))])}function Jy(t){return xT(Kc(t.firestore,vf),[new ZP(t._key,yc.none())])}function ex(t,e){const r=Kc(t.firestore,vf),c=qn(t),h=WV(t.converter,e);return xT(r,[VV(mT(t.firestore),"addDoc",c._key,h,t.converter!==null,{}).toMutation(c._key,yc.exists(!1))]).then(()=>c)}function xT(t,e){return function(c,h){const x=new Od;return c.asyncQueue.enqueueAndForget(async()=>oee(await yee(c),h,x)),x.promise}(cj(t),e)}function Lee(t,e,r){const c=r.docs.get(e._key),h=new XV(t);return new ZV(t,h,e._key,c,new k0(r.hasPendingWrites,r.fromCache),e.converter)}function Pn(){return new pj("serverTimestamp")}(function(e,r=!0){(function(h){Zy=h})(ff),tf(new wp("firestore",(c,{instanceIdentifier:h,options:x})=>{const w=c.getProvider("app").getImmediate(),o=new vf(new zK(c.getProvider("auth-internal")),new qK(c.getProvider("app-check-internal")),function(R,F){if(!Object.prototype.hasOwnProperty.apply(R.options,["projectId"]))throw new Wi(ti.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Nv(R.options.projectId,F)}(w,h),w);return x=Object.assign({useFetchStreams:r},x),o._setSettings(x),o},"PUBLIC").setMultipleInstances(!0)),Vu(u4,"4.7.3",e),Vu(u4,"4.7.3","esm2017")})();var Fee="firebase",zee="10.14.1";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Vu(Fee,zee,"app");/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const YV="firebasestorage.googleapis.com",KV="storageBucket",Bee=2*60*1e3,Vee=10*60*1e3;/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class oa extends Qu{constructor(e,r,c=0){super(RC(e),`Firebase Storage: ${r} (${RC(e)})`),this.status_=c,this.customData={serverResponse:null},this._baseMessage=this.message,Object.setPrototypeOf(this,oa.prototype)}get status(){return this.status_}set status(e){this.status_=e}_codeEquals(e){return RC(e)===this.code}get serverResponse(){return this.customData.serverResponse}set serverResponse(e){this.customData.serverResponse=e,this.customData.serverResponse?this.message=`${this._baseMessage}
${this.customData.serverResponse}`:this.message=this._baseMessage}}var aa;(function(t){t.UNKNOWN="unknown",t.OBJECT_NOT_FOUND="object-not-found",t.BUCKET_NOT_FOUND="bucket-not-found",t.PROJECT_NOT_FOUND="project-not-found",t.QUOTA_EXCEEDED="quota-exceeded",t.UNAUTHENTICATED="unauthenticated",t.UNAUTHORIZED="unauthorized",t.UNAUTHORIZED_APP="unauthorized-app",t.RETRY_LIMIT_EXCEEDED="retry-limit-exceeded",t.INVALID_CHECKSUM="invalid-checksum",t.CANCELED="canceled",t.INVALID_EVENT_NAME="invalid-event-name",t.INVALID_URL="invalid-url",t.INVALID_DEFAULT_BUCKET="invalid-default-bucket",t.NO_DEFAULT_BUCKET="no-default-bucket",t.CANNOT_SLICE_BLOB="cannot-slice-blob",t.SERVER_FILE_WRONG_SIZE="server-file-wrong-size",t.NO_DOWNLOAD_URL="no-download-url",t.INVALID_ARGUMENT="invalid-argument",t.INVALID_ARGUMENT_COUNT="invalid-argument-count",t.APP_DELETED="app-deleted",t.INVALID_ROOT_OPERATION="invalid-root-operation",t.INVALID_FORMAT="invalid-format",t.INTERNAL_ERROR="internal-error",t.UNSUPPORTED_ENVIRONMENT="unsupported-environment"})(aa||(aa={}));function RC(t){return"storage/"+t}function bj(){const t="An unknown error occurred, please check the error payload for server response.";return new oa(aa.UNKNOWN,t)}function Uee(t){return new oa(aa.OBJECT_NOT_FOUND,"Object '"+t+"' does not exist.")}function qee(t){return new oa(aa.QUOTA_EXCEEDED,"Quota for bucket '"+t+"' exceeded, please view quota on https://firebase.google.com/pricing/.")}function $ee(){const t="User is not authenticated, please authenticate using Firebase Authentication and try again.";return new oa(aa.UNAUTHENTICATED,t)}function Gee(){return new oa(aa.UNAUTHORIZED_APP,"This app does not have permission to access Firebase Storage on this project.")}function Hee(t){return new oa(aa.UNAUTHORIZED,"User does not have permission to access '"+t+"'.")}function Wee(){return new oa(aa.RETRY_LIMIT_EXCEEDED,"Max retry time for operation exceeded, please try again.")}function Zee(){return new oa(aa.CANCELED,"User canceled the upload/download.")}function Xee(t){return new oa(aa.INVALID_URL,"Invalid URL '"+t+"'.")}function Yee(t){return new oa(aa.INVALID_DEFAULT_BUCKET,"Invalid default bucket '"+t+"'.")}function Kee(){return new oa(aa.NO_DEFAULT_BUCKET,"No default bucket found. Did you set the '"+KV+"' property when initializing the app?")}function Qee(){return new oa(aa.CANNOT_SLICE_BLOB,"Cannot slice blob for upload. Please retry the upload.")}function Jee(){return new oa(aa.NO_DOWNLOAD_URL,"The given file does not have any download URLs.")}function ete(t){return new oa(aa.UNSUPPORTED_ENVIRONMENT,`${t} is missing. Make sure to install the required polyfills. See https://firebase.google.com/docs/web/environments-js-sdk#polyfills for more information.`)}function uI(t){return new oa(aa.INVALID_ARGUMENT,t)}function QV(){return new oa(aa.APP_DELETED,"The Firebase app was deleted.")}function tte(t){return new oa(aa.INVALID_ROOT_OPERATION,"The operation '"+t+"' cannot be performed on a root reference, create a non-root reference using child, such as .child('file.png').")}function K0(t,e){return new oa(aa.INVALID_FORMAT,"String does not match format '"+t+"': "+e)}function x0(t){throw new oa(aa.INTERNAL_ERROR,"Internal error: "+t)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ol{constructor(e,r){this.bucket=e,this.path_=r}get path(){return this.path_}get isRoot(){return this.path.length===0}fullServerUrl(){const e=encodeURIComponent;return"/b/"+e(this.bucket)+"/o/"+e(this.path)}bucketOnlyServerUrl(){return"/b/"+encodeURIComponent(this.bucket)+"/o"}static makeFromBucketSpec(e,r){let c;try{c=Ol.makeFromUrl(e,r)}catch{return new Ol(e,"")}if(c.path==="")return c;throw Yee(e)}static makeFromUrl(e,r){let c=null;const h="([A-Za-z0-9.\\-_]+)";function x(Ae){Ae.path.charAt(Ae.path.length-1)==="/"&&(Ae.path_=Ae.path_.slice(0,-1))}const w="(/(.*))?$",o=new RegExp("^gs://"+h+w,"i"),C={bucket:1,path:3};function R(Ae){Ae.path_=decodeURIComponent(Ae.path)}const F="v[A-Za-z0-9_]+",$=r.replace(/[.]/g,"\\."),Y="(/([^?#]*).*)?$",H=new RegExp(`^https?://${$}/${F}/b/${h}/o${Y}`,"i"),X={bucket:1,path:3},he=r===YV?"(?:storage.googleapis.com|storage.cloud.google.com)":r,se="([^?#]*)",de=new RegExp(`^https?://${he}/${h}/${se}`,"i"),ge=[{regex:o,indices:C,postModify:x},{regex:H,indices:X,postModify:R},{regex:de,indices:{bucket:1,path:2},postModify:R}];for(let Ae=0;Ae<ge.length;Ae++){const Te=ge[Ae],Ce=Te.regex.exec(e);if(Ce){const ne=Ce[Te.indices.bucket];let ae=Ce[Te.indices.path];ae||(ae=""),c=new Ol(ne,ae),Te.postModify(c);break}}if(c==null)throw Xee(e);return c}}class ite{constructor(e){this.promise_=Promise.reject(e)}getPromise(){return this.promise_}cancel(e=!1){}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function rte(t,e,r){let c=1,h=null,x=null,w=!1,o=0;function C(){return o===2}let R=!1;function F(...se){R||(R=!0,e.apply(null,se))}function $(se){h=setTimeout(()=>{h=null,t(H,C())},se)}function Y(){x&&clearTimeout(x)}function H(se,...de){if(R){Y();return}if(se){Y(),F.call(null,se,...de);return}if(C()||w){Y(),F.call(null,se,...de);return}c<64&&(c*=2);let ge;o===1?(o=2,ge=0):ge=(c+Math.random())*1e3,$(ge)}let X=!1;function he(se){X||(X=!0,Y(),!R&&(h!==null?(se||(o=2),clearTimeout(h),$(0)):se||(o=1)))}return $(0),x=setTimeout(()=>{w=!0,he(!0)},r),he}function nte(t){t(!1)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ste(t){return t!==void 0}function ate(t){return typeof t=="object"&&!Array.isArray(t)}function wj(t){return typeof t=="string"||t instanceof String}function X4(t){return Sj()&&t instanceof Blob}function Sj(){return typeof Blob<"u"}function Y4(t,e,r,c){if(c<e)throw uI(`Invalid value for '${t}'. Expected ${e} or greater.`);if(c>r)throw uI(`Invalid value for '${t}'. Expected ${r} or less.`)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function _T(t,e,r){let c=e;return r==null&&(c=`https://${e}`),`${r}://${c}/v0${t}`}function JV(t){const e=encodeURIComponent;let r="?";for(const c in t)if(t.hasOwnProperty(c)){const h=e(c)+"="+e(t[c]);r=r+h+"&"}return r=r.slice(0,-1),r}var Wm;(function(t){t[t.NO_ERROR=0]="NO_ERROR",t[t.NETWORK_ERROR=1]="NETWORK_ERROR",t[t.ABORT=2]="ABORT"})(Wm||(Wm={}));/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ote(t,e){const r=t>=500&&t<600,h=[408,429].indexOf(t)!==-1,x=e.indexOf(t)!==-1;return r||h||x}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class lte{constructor(e,r,c,h,x,w,o,C,R,F,$,Y=!0){this.url_=e,this.method_=r,this.headers_=c,this.body_=h,this.successCodes_=x,this.additionalRetryCodes_=w,this.callback_=o,this.errorCallback_=C,this.timeout_=R,this.progressCallback_=F,this.connectionFactory_=$,this.retry=Y,this.pendingConnection_=null,this.backoffId_=null,this.canceled_=!1,this.appDelete_=!1,this.promise_=new Promise((H,X)=>{this.resolve_=H,this.reject_=X,this.start_()})}start_(){const e=(c,h)=>{if(h){c(!1,new Vw(!1,null,!0));return}const x=this.connectionFactory_();this.pendingConnection_=x;const w=o=>{const C=o.loaded,R=o.lengthComputable?o.total:-1;this.progressCallback_!==null&&this.progressCallback_(C,R)};this.progressCallback_!==null&&x.addUploadProgressListener(w),x.send(this.url_,this.method_,this.body_,this.headers_).then(()=>{this.progressCallback_!==null&&x.removeUploadProgressListener(w),this.pendingConnection_=null;const o=x.getErrorCode()===Wm.NO_ERROR,C=x.getStatus();if(!o||ote(C,this.additionalRetryCodes_)&&this.retry){const F=x.getErrorCode()===Wm.ABORT;c(!1,new Vw(!1,null,F));return}const R=this.successCodes_.indexOf(C)!==-1;c(!0,new Vw(R,x))})},r=(c,h)=>{const x=this.resolve_,w=this.reject_,o=h.connection;if(h.wasSuccessCode)try{const C=this.callback_(o,o.getResponse());ste(C)?x(C):x()}catch(C){w(C)}else if(o!==null){const C=bj();C.serverResponse=o.getErrorText(),this.errorCallback_?w(this.errorCallback_(o,C)):w(C)}else if(h.canceled){const C=this.appDelete_?QV():Zee();w(C)}else{const C=Wee();w(C)}};this.canceled_?r(!1,new Vw(!1,null,!0)):this.backoffId_=rte(e,r,this.timeout_)}getPromise(){return this.promise_}cancel(e){this.canceled_=!0,this.appDelete_=e||!1,this.backoffId_!==null&&nte(this.backoffId_),this.pendingConnection_!==null&&this.pendingConnection_.abort()}}class Vw{constructor(e,r,c){this.wasSuccessCode=e,this.connection=r,this.canceled=!!c}}function cte(t,e){e!==null&&e.length>0&&(t.Authorization="Firebase "+e)}function ute(t,e){t["X-Firebase-Storage-Version"]="webjs/"+(e??"AppManager")}function dte(t,e){e&&(t["X-Firebase-GMPID"]=e)}function hte(t,e){e!==null&&(t["X-Firebase-AppCheck"]=e)}function pte(t,e,r,c,h,x,w=!0){const o=JV(t.urlParams),C=t.url+o,R=Object.assign({},t.headers);return dte(R,e),cte(R,r),ute(R,x),hte(R,c),new lte(C,t.method,R,t.body,t.successCodes,t.additionalRetryCodes,t.handler,t.errorHandler,t.timeout,t.progressCallback,h,w)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function mte(){return typeof BlobBuilder<"u"?BlobBuilder:typeof WebKitBlobBuilder<"u"?WebKitBlobBuilder:void 0}function fte(...t){const e=mte();if(e!==void 0){const r=new e;for(let c=0;c<t.length;c++)r.append(t[c]);return r.getBlob()}else{if(Sj())return new Blob(t);throw new oa(aa.UNSUPPORTED_ENVIRONMENT,"This browser doesn't seem to support creating Blobs")}}function gte(t,e,r){return t.webkitSlice?t.webkitSlice(e,r):t.mozSlice?t.mozSlice(e,r):t.slice?t.slice(e,r):null}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function yte(t){if(typeof atob>"u")throw ete("base-64");return atob(t)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Fu={RAW:"raw",BASE64:"base64",BASE64URL:"base64url",DATA_URL:"data_url"};class kC{constructor(e,r){this.data=e,this.contentType=r||null}}function xte(t,e){switch(t){case Fu.RAW:return new kC(e6(e));case Fu.BASE64:case Fu.BASE64URL:return new kC(t6(t,e));case Fu.DATA_URL:return new kC(vte(e),bte(e))}throw bj()}function e6(t){const e=[];for(let r=0;r<t.length;r++){let c=t.charCodeAt(r);if(c<=127)e.push(c);else if(c<=2047)e.push(192|c>>6,128|c&63);else if((c&64512)===55296)if(!(r<t.length-1&&(t.charCodeAt(r+1)&64512)===56320))e.push(239,191,189);else{const x=c,w=t.charCodeAt(++r);c=65536|(x&1023)<<10|w&1023,e.push(240|c>>18,128|c>>12&63,128|c>>6&63,128|c&63)}else(c&64512)===56320?e.push(239,191,189):e.push(224|c>>12,128|c>>6&63,128|c&63)}return new Uint8Array(e)}function _te(t){let e;try{e=decodeURIComponent(t)}catch{throw K0(Fu.DATA_URL,"Malformed data URL.")}return e6(e)}function t6(t,e){switch(t){case Fu.BASE64:{const h=e.indexOf("-")!==-1,x=e.indexOf("_")!==-1;if(h||x)throw K0(t,"Invalid character '"+(h?"-":"_")+"' found: is it base64url encoded?");break}case Fu.BASE64URL:{const h=e.indexOf("+")!==-1,x=e.indexOf("/")!==-1;if(h||x)throw K0(t,"Invalid character '"+(h?"+":"/")+"' found: is it base64 encoded?");e=e.replace(/-/g,"+").replace(/_/g,"/");break}}let r;try{r=yte(e)}catch(h){throw h.message.includes("polyfill")?h:K0(t,"Invalid character found")}const c=new Uint8Array(r.length);for(let h=0;h<r.length;h++)c[h]=r.charCodeAt(h);return c}class i6{constructor(e){this.base64=!1,this.contentType=null;const r=e.match(/^data:([^,]+)?,/);if(r===null)throw K0(Fu.DATA_URL,"Must be formatted 'data:[<mediatype>][;base64],<data>");const c=r[1]||null;c!=null&&(this.base64=wte(c,";base64"),this.contentType=this.base64?c.substring(0,c.length-7):c),this.rest=e.substring(e.indexOf(",")+1)}}function vte(t){const e=new i6(t);return e.base64?t6(Fu.BASE64,e.rest):_te(e.rest)}function bte(t){return new i6(t).contentType}function wte(t,e){return t.length>=e.length?t.substring(t.length-e.length)===e:!1}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Kh{constructor(e,r){let c=0,h="";X4(e)?(this.data_=e,c=e.size,h=e.type):e instanceof ArrayBuffer?(r?this.data_=new Uint8Array(e):(this.data_=new Uint8Array(e.byteLength),this.data_.set(new Uint8Array(e))),c=this.data_.length):e instanceof Uint8Array&&(r?this.data_=e:(this.data_=new Uint8Array(e.length),this.data_.set(e)),c=e.length),this.size_=c,this.type_=h}size(){return this.size_}type(){return this.type_}slice(e,r){if(X4(this.data_)){const c=this.data_,h=gte(c,e,r);return h===null?null:new Kh(h)}else{const c=new Uint8Array(this.data_.buffer,e,r-e);return new Kh(c,!0)}}static getBlob(...e){if(Sj()){const r=e.map(c=>c instanceof Kh?c.data_:c);return new Kh(fte.apply(null,r))}else{const r=e.map(w=>wj(w)?xte(Fu.RAW,w).data:w.data_);let c=0;r.forEach(w=>{c+=w.byteLength});const h=new Uint8Array(c);let x=0;return r.forEach(w=>{for(let o=0;o<w.length;o++)h[x++]=w[o]}),new Kh(h,!0)}}uploadData(){return this.data_}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function r6(t){let e;try{e=JSON.parse(t)}catch{return null}return ate(e)?e:null}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ste(t){if(t.length===0)return null;const e=t.lastIndexOf("/");return e===-1?"":t.slice(0,e)}function Tte(t,e){const r=e.split("/").filter(c=>c.length>0).join("/");return t.length===0?r:t+"/"+r}function n6(t){const e=t.lastIndexOf("/",t.length-2);return e===-1?t:t.slice(e+1)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Nte(t,e){return e}class Qo{constructor(e,r,c,h){this.server=e,this.local=r||e,this.writable=!!c,this.xform=h||Nte}}let Uw=null;function Ate(t){return!wj(t)||t.length<2?t:n6(t)}function s6(){if(Uw)return Uw;const t=[];t.push(new Qo("bucket")),t.push(new Qo("generation")),t.push(new Qo("metageneration")),t.push(new Qo("name","fullPath",!0));function e(x,w){return Ate(w)}const r=new Qo("name");r.xform=e,t.push(r);function c(x,w){return w!==void 0?Number(w):w}const h=new Qo("size");return h.xform=c,t.push(h),t.push(new Qo("timeCreated")),t.push(new Qo("updated")),t.push(new Qo("md5Hash",null,!0)),t.push(new Qo("cacheControl",null,!0)),t.push(new Qo("contentDisposition",null,!0)),t.push(new Qo("contentEncoding",null,!0)),t.push(new Qo("contentLanguage",null,!0)),t.push(new Qo("contentType",null,!0)),t.push(new Qo("metadata","customMetadata",!0)),Uw=t,Uw}function Cte(t,e){function r(){const c=t.bucket,h=t.fullPath,x=new Ol(c,h);return e._makeStorageReference(x)}Object.defineProperty(t,"ref",{get:r})}function Ete(t,e,r){const c={};c.type="file";const h=r.length;for(let x=0;x<h;x++){const w=r[x];c[w.local]=w.xform(c,e[w.server])}return Cte(c,t),c}function a6(t,e,r){const c=r6(e);return c===null?null:Ete(t,c,r)}function Ite(t,e,r,c){const h=r6(e);if(h===null||!wj(h.downloadTokens))return null;const x=h.downloadTokens;if(x.length===0)return null;const w=encodeURIComponent;return x.split(",").map(R=>{const F=t.bucket,$=t.fullPath,Y="/b/"+w(F)+"/o/"+w($),H=_T(Y,r,c),X=JV({alt:"media",token:R});return H+X})[0]}function Pte(t,e){const r={},c=e.length;for(let h=0;h<c;h++){const x=e[h];x.writable&&(r[x.server]=t[x.local])}return JSON.stringify(r)}class Tj{constructor(e,r,c,h){this.url=e,this.method=r,this.handler=c,this.timeout=h,this.urlParams={},this.headers={},this.body=null,this.errorHandler=null,this.progressCallback=null,this.successCodes=[200],this.additionalRetryCodes=[]}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function o6(t){if(!t)throw bj()}function jte(t,e){function r(c,h){const x=a6(t,h,e);return o6(x!==null),x}return r}function Rte(t,e){function r(c,h){const x=a6(t,h,e);return o6(x!==null),Ite(x,h,t.host,t._protocol)}return r}function l6(t){function e(r,c){let h;return r.getStatus()===401?r.getErrorText().includes("Firebase App Check token is invalid")?h=Gee():h=$ee():r.getStatus()===402?h=qee(t.bucket):r.getStatus()===403?h=Hee(t.path):h=c,h.status=r.getStatus(),h.serverResponse=c.serverResponse,h}return e}function c6(t){const e=l6(t);function r(c,h){let x=e(c,h);return c.getStatus()===404&&(x=Uee(t.path)),x.serverResponse=h.serverResponse,x}return r}function kte(t,e,r){const c=e.fullServerUrl(),h=_T(c,t.host,t._protocol),x="GET",w=t.maxOperationRetryTime,o=new Tj(h,x,Rte(t,r),w);return o.errorHandler=c6(e),o}function Dte(t,e){const r=e.fullServerUrl(),c=_T(r,t.host,t._protocol),h="DELETE",x=t.maxOperationRetryTime;function w(C,R){}const o=new Tj(c,h,w,x);return o.successCodes=[200,204],o.errorHandler=c6(e),o}function Mte(t,e){return t&&t.contentType||e&&e.type()||"application/octet-stream"}function Ote(t,e,r){const c=Object.assign({},r);return c.fullPath=t.path,c.size=e.size(),c.contentType||(c.contentType=Mte(null,e)),c}function Lte(t,e,r,c,h){const x=e.bucketOnlyServerUrl(),w={"X-Goog-Upload-Protocol":"multipart"};function o(){let ge="";for(let Ae=0;Ae<2;Ae++)ge=ge+Math.random().toString().slice(2);return ge}const C=o();w["Content-Type"]="multipart/related; boundary="+C;const R=Ote(e,c,h),F=Pte(R,r),$="--"+C+`\r
Content-Type: application/json; charset=utf-8\r
\r
`+F+`\r
--`+C+`\r
Content-Type: `+R.contentType+`\r
\r
`,Y=`\r
--`+C+"--",H=Kh.getBlob($,c,Y);if(H===null)throw Qee();const X={name:R.fullPath},he=_T(x,t.host,t._protocol),se="POST",de=t.maxUploadRetryTime,K=new Tj(he,se,jte(t,r),de);return K.urlParams=X,K.headers=w,K.body=H.uploadData(),K.errorHandler=l6(e),K}class Fte{constructor(){this.sent_=!1,this.xhr_=new XMLHttpRequest,this.initXhr(),this.errorCode_=Wm.NO_ERROR,this.sendPromise_=new Promise(e=>{this.xhr_.addEventListener("abort",()=>{this.errorCode_=Wm.ABORT,e()}),this.xhr_.addEventListener("error",()=>{this.errorCode_=Wm.NETWORK_ERROR,e()}),this.xhr_.addEventListener("load",()=>{e()})})}send(e,r,c,h){if(this.sent_)throw x0("cannot .send() more than once");if(this.sent_=!0,this.xhr_.open(r,e,!0),h!==void 0)for(const x in h)h.hasOwnProperty(x)&&this.xhr_.setRequestHeader(x,h[x].toString());return c!==void 0?this.xhr_.send(c):this.xhr_.send(),this.sendPromise_}getErrorCode(){if(!this.sent_)throw x0("cannot .getErrorCode() before sending");return this.errorCode_}getStatus(){if(!this.sent_)throw x0("cannot .getStatus() before sending");try{return this.xhr_.status}catch{return-1}}getResponse(){if(!this.sent_)throw x0("cannot .getResponse() before sending");return this.xhr_.response}getErrorText(){if(!this.sent_)throw x0("cannot .getErrorText() before sending");return this.xhr_.statusText}abort(){this.xhr_.abort()}getResponseHeader(e){return this.xhr_.getResponseHeader(e)}addUploadProgressListener(e){this.xhr_.upload!=null&&this.xhr_.upload.addEventListener("progress",e)}removeUploadProgressListener(e){this.xhr_.upload!=null&&this.xhr_.upload.removeEventListener("progress",e)}}class zte extends Fte{initXhr(){this.xhr_.responseType="text"}}function Nj(){return new zte}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class of{constructor(e,r){this._service=e,r instanceof Ol?this._location=r:this._location=Ol.makeFromUrl(r,e.host)}toString(){return"gs://"+this._location.bucket+"/"+this._location.path}_newRef(e,r){return new of(e,r)}get root(){const e=new Ol(this._location.bucket,"");return this._newRef(this._service,e)}get bucket(){return this._location.bucket}get fullPath(){return this._location.path}get name(){return n6(this._location.path)}get storage(){return this._service}get parent(){const e=Ste(this._location.path);if(e===null)return null;const r=new Ol(this._location.bucket,e);return new of(this._service,r)}_throwIfRoot(e){if(this._location.path==="")throw tte(e)}}function Bte(t,e,r){t._throwIfRoot("uploadBytes");const c=Lte(t.storage,t._location,s6(),new Kh(e,!0),r);return t.storage.makeRequestWithTokens(c,Nj).then(h=>({metadata:h,ref:t}))}function Vte(t){t._throwIfRoot("getDownloadURL");const e=kte(t.storage,t._location,s6());return t.storage.makeRequestWithTokens(e,Nj).then(r=>{if(r===null)throw Jee();return r})}function Ute(t){t._throwIfRoot("deleteObject");const e=Dte(t.storage,t._location);return t.storage.makeRequestWithTokens(e,Nj)}function qte(t,e){const r=Tte(t._location.path,e),c=new Ol(t._location.bucket,r);return new of(t.storage,c)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function $te(t){return/^[A-Za-z]+:\/\//.test(t)}function Gte(t,e){return new of(t,e)}function u6(t,e){if(t instanceof Aj){const r=t;if(r._bucket==null)throw Kee();const c=new of(r,r._bucket);return e!=null?u6(c,e):c}else return e!==void 0?qte(t,e):t}function Hte(t,e){if(e&&$te(e)){if(t instanceof Aj)return Gte(t,e);throw uI("To use ref(service, url), the first argument must be a Storage instance.")}else return u6(t,e)}function K4(t,e){const r=e==null?void 0:e[KV];return r==null?null:Ol.makeFromBucketSpec(r,t)}function Wte(t,e,r,c={}){t.host=`${e}:${r}`,t._protocol="http";const{mockUserToken:h}=c;h&&(t._overrideAuthToken=typeof h=="string"?h:Vz(h,t.app.options.projectId))}class Aj{constructor(e,r,c,h,x){this.app=e,this._authProvider=r,this._appCheckProvider=c,this._url=h,this._firebaseVersion=x,this._bucket=null,this._host=YV,this._protocol="https",this._appId=null,this._deleted=!1,this._maxOperationRetryTime=Bee,this._maxUploadRetryTime=Vee,this._requests=new Set,h!=null?this._bucket=Ol.makeFromBucketSpec(h,this._host):this._bucket=K4(this._host,this.app.options)}get host(){return this._host}set host(e){this._host=e,this._url!=null?this._bucket=Ol.makeFromBucketSpec(this._url,e):this._bucket=K4(e,this.app.options)}get maxUploadRetryTime(){return this._maxUploadRetryTime}set maxUploadRetryTime(e){Y4("time",0,Number.POSITIVE_INFINITY,e),this._maxUploadRetryTime=e}get maxOperationRetryTime(){return this._maxOperationRetryTime}set maxOperationRetryTime(e){Y4("time",0,Number.POSITIVE_INFINITY,e),this._maxOperationRetryTime=e}async _getAuthToken(){if(this._overrideAuthToken)return this._overrideAuthToken;const e=this._authProvider.getImmediate({optional:!0});if(e){const r=await e.getToken();if(r!==null)return r.accessToken}return null}async _getAppCheckToken(){const e=this._appCheckProvider.getImmediate({optional:!0});return e?(await e.getToken()).token:null}_delete(){return this._deleted||(this._deleted=!0,this._requests.forEach(e=>e.cancel()),this._requests.clear()),Promise.resolve()}_makeStorageReference(e){return new of(this,e)}_makeRequest(e,r,c,h,x=!0){if(this._deleted)return new ite(QV());{const w=pte(e,this._appId,c,h,r,this._firebaseVersion,x);return this._requests.add(w),w.getPromise().then(()=>this._requests.delete(w),()=>this._requests.delete(w)),w}}async makeRequestWithTokens(e,r){const[c,h]=await Promise.all([this._getAuthToken(),this._getAppCheckToken()]);return this._makeRequest(e,r,c,h).getPromise()}}const Q4="@firebase/storage",J4="0.13.2";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const d6="storage";function Zte(t,e,r){return t=As(t),Bte(t,e,r)}function Xte(t){return t=As(t),Vte(t)}function Yte(t){return t=As(t),Ute(t)}function h6(t,e){return t=As(t),Hte(t,e)}function Kte(t=IP(),e){t=As(t);const c=YS(t,d6).getImmediate({identifier:e}),h=Fz("storage");return h&&Qte(c,...h),c}function Qte(t,e,r,c={}){Wte(t,e,r,c)}function Jte(t,{instanceIdentifier:e}){const r=t.getProvider("app").getImmediate(),c=t.getProvider("auth-internal"),h=t.getProvider("app-check-internal");return new Aj(r,c,h,e,ff)}function eie(){tf(new wp(d6,Jte,"PUBLIC").setMultipleInstances(!0)),Vu(Q4,J4,""),Vu(Q4,J4,"esm2017")}eie();const tie={apiKey:void 0,authDomain:void 0,projectId:void 0,storageBucket:void 0,messagingSenderId:void 0,appId:void 0},Cj=$z(tie),uy=MK(Cj),rn=See(Cj),p6=Kte(Cj),m6=ue.createContext(null);function iu(){const t=ue.useContext(m6);if(!t)throw new Error("useAuth must be used within an AuthProvider");return t}function iie({children:t}){const[e,r]=ue.useState(null),[c,h]=ue.useState(null),[x,w]=ue.useState(!0),[o,C]=ue.useState(null);ue.useEffect(()=>{const H=SY(uy,async X=>{if(X){r(X);try{const he=await Ap(qn(rn,"operators",X.uid));he.exists()?h({id:he.id,...he.data()}):h({id:X.uid,email:X.email,firstName:"",lastName:""})}catch(he){console.error("Error fetching user profile:",he),C(he.message)}}else r(null),h(null);w(!1)});return()=>H()},[]);const Y={user:e,userProfile:c,loading:x,error:o,signIn:async(H,X)=>{C(null);try{return(await xY(uy,H,X)).user}catch(he){throw C(he.message),he}},signOut:async()=>{C(null);try{await TY(uy)}catch(H){throw C(H.message),H}},resetPassword:async H=>{C(null);try{await yY(uy,H,{})}catch(X){throw C(X.message),X}},isAuthenticated:!!e};return n.jsx(m6.Provider,{value:Y,children:t})}/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var rie={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const nie=t=>t.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase().trim(),Lt=(t,e)=>{const r=ue.forwardRef(({color:c="currentColor",size:h=24,strokeWidth:x=2,absoluteStrokeWidth:w,className:o="",children:C,...R},F)=>ue.createElement("svg",{ref:F,...rie,width:h,height:h,stroke:c,strokeWidth:w?Number(x)*24/Number(h):x,className:["lucide",`lucide-${nie(t)}`,o].join(" "),...R},[...e.map(([$,Y])=>ue.createElement($,Y)),...Array.isArray(C)?C:[C]]));return r.displayName=`${t}`,r};/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fS=Lt("Activity",[["path",{d:"M22 12h-4l-3 9L9 3l-3 9H2",key:"d5dnw9"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Cs=Lt("AlertCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const jv=Lt("AlertOctagon",[["polygon",{points:"7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2",key:"h1p8hx"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ir=Lt("AlertTriangle",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z",key:"c3ski4"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const sie=Lt("Ambulance",[["path",{d:"M10 10H6",key:"1bsnug"}],["path",{d:"M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2",key:"wrbu53"}],["path",{d:"M19 18h2a1 1 0 0 0 1-1v-3.28a1 1 0 0 0-.684-.948l-1.923-.641a1 1 0 0 1-.578-.502l-1.539-3.076A1 1 0 0 0 16.382 8H14",key:"lrkjwd"}],["path",{d:"M8 8v4",key:"1fwk8c"}],["path",{d:"M9 18h6",key:"x1upvd"}],["circle",{cx:"17",cy:"18",r:"2",key:"332jqn"}],["circle",{cx:"7",cy:"18",r:"2",key:"19iecd"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const aie=Lt("Archive",[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mc=Lt("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fc=Lt("ArrowRight",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gS=Lt("Award",[["circle",{cx:"12",cy:"8",r:"6",key:"1vp47v"}],["path",{d:"M15.477 12.89 17 22l-5-3-5 3 1.523-9.11",key:"em7aur"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oie=Lt("BarChart3",[["path",{d:"M3 3v18h18",key:"1s2lah"}],["path",{d:"M18 17V9",key:"2bz60n"}],["path",{d:"M13 17V5",key:"1frdt8"}],["path",{d:"M8 17v-3",key:"17ska0"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const lie=Lt("Battery",[["rect",{width:"16",height:"10",x:"2",y:"7",rx:"2",ry:"2",key:"1w10f2"}],["line",{x1:"22",x2:"22",y1:"11",y2:"13",key:"4dh1rd"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const cie=Lt("Beaker",[["path",{d:"M4.5 3h15",key:"c7n0jr"}],["path",{d:"M6 3v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V3",key:"m1uhx7"}],["path",{d:"M6 14h12",key:"4cwo0f"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wc=Lt("Bell",[["path",{d:"M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9",key:"1qo2s2"}],["path",{d:"M10.3 21a1.94 1.94 0 0 0 3.4 0",key:"qgo35s"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yS=Lt("BookOpen",[["path",{d:"M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z",key:"vv98re"}],["path",{d:"M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z",key:"1cyq3y"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const uie=Lt("Book",[["path",{d:"M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20",key:"t4utmx"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const f6=Lt("Box",[["path",{d:"M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z",key:"hh9hay"}],["path",{d:"m3.3 7 8.7 5 8.7-5",key:"g66t2b"}],["path",{d:"M12 22V12",key:"d0xqtd"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const die=Lt("Bug",[["path",{d:"m8 2 1.88 1.88",key:"fmnt4t"}],["path",{d:"M14.12 3.88 16 2",key:"qol33r"}],["path",{d:"M9 7.13v-1a3.003 3.003 0 1 1 6 0v1",key:"d7y7pr"}],["path",{d:"M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6",key:"xs1cw7"}],["path",{d:"M12 20v-9",key:"1qisl0"}],["path",{d:"M6.53 9C4.6 8.8 3 7.1 3 5",key:"32zzws"}],["path",{d:"M6 13H2",key:"82j7cp"}],["path",{d:"M3 21c0-2.1 1.7-3.9 3.8-4",key:"4p0ekp"}],["path",{d:"M20.97 5c0 2.1-1.6 3.8-3.5 4",key:"18gb23"}],["path",{d:"M22 13h-4",key:"1jl80f"}],["path",{d:"M17.2 17c2.1.1 3.8 1.9 3.8 4",key:"k3fwyw"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vl=Lt("Building2",[["path",{d:"M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z",key:"1b4qmf"}],["path",{d:"M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2",key:"i71pzd"}],["path",{d:"M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2",key:"10jefs"}],["path",{d:"M10 6h4",key:"1itunk"}],["path",{d:"M10 10h4",key:"tcdvrf"}],["path",{d:"M10 14h4",key:"kelpxr"}],["path",{d:"M10 18h4",key:"1ulq68"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zy=Lt("Building",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",ry:"2",key:"76otgf"}],["path",{d:"M9 22v-4h6v4",key:"r93iot"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const hie=Lt("Cable",[["path",{d:"M4 9a2 2 0 0 1-2-2V5h6v2a2 2 0 0 1-2 2Z",key:"1s6oa5"}],["path",{d:"M3 5V3",key:"1k5hjh"}],["path",{d:"M7 5V3",key:"1t1388"}],["path",{d:"M19 15V6.5a3.5 3.5 0 0 0-7 0v11a3.5 3.5 0 0 1-7 0V9",key:"1ytv72"}],["path",{d:"M17 21v-2",key:"ds4u3f"}],["path",{d:"M21 21v-2",key:"eo0ou"}],["path",{d:"M22 19h-6v-2a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2Z",key:"sdz6o8"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pie=Lt("Calculator",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["line",{x1:"8",x2:"16",y1:"6",y2:"6",key:"x4nwl0"}],["line",{x1:"16",x2:"16",y1:"14",y2:"18",key:"wjye3r"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M8 18h.01",key:"lrp35t"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const il=Lt("Calendar",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bl=Lt("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mie=Lt("Car",[["path",{d:"M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2",key:"5owen"}],["circle",{cx:"7",cy:"17",r:"2",key:"u2ysq9"}],["path",{d:"M9 17h6",key:"r8uit2"}],["circle",{cx:"17",cy:"17",r:"2",key:"axvx0g"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qr=Lt("CheckCircle2",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fie=Lt("CheckCircle",[["path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14",key:"g774vq"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gie=Lt("CheckSquare",[["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}],["path",{d:"M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11",key:"1jnkn4"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ru=Lt("Check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fn=Lt("ChevronDown",[["path",{d:"m6 9 6 6 6-6",key:"qrunsl"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const e3=Lt("ChevronLeft",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ko=Lt("ChevronRight",[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $n=Lt("ChevronUp",[["path",{d:"m18 15-6-6-6 6",key:"153udz"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const g6=Lt("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const y6=Lt("Clapperboard",[["path",{d:"M20.2 6 3 11l-.9-2.4c-.3-1.1.3-2.2 1.3-2.5l13.5-4c1.1-.3 2.2.3 2.5 1.3Z",key:"1tn4o7"}],["path",{d:"m6.2 5.3 3.1 3.9",key:"iuk76l"}],["path",{d:"m12.4 3.4 3.1 4",key:"6hsd6n"}],["path",{d:"M3 11h18v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2Z",key:"ltgou9"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ul=Lt("ClipboardCheck",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"m9 14 2 2 4-4",key:"df797q"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ll=Lt("ClipboardList",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"M12 11h4",key:"1jrz19"}],["path",{d:"M12 16h4",key:"n85exb"}],["path",{d:"M8 11h.01",key:"1dfujw"}],["path",{d:"M8 16h.01",key:"18s6g9"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const x6=Lt("Clipboard",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wu=Lt("Clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ej=Lt("Cloud",[["path",{d:"M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z",key:"p7xjir"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Op=Lt("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const t3=Lt("Cpu",[["rect",{x:"4",y:"4",width:"16",height:"16",rx:"2",key:"1vbyd7"}],["rect",{x:"9",y:"9",width:"6",height:"6",key:"o3kz5p"}],["path",{d:"M15 2v2",key:"13l42r"}],["path",{d:"M15 20v2",key:"15mkzm"}],["path",{d:"M2 15h2",key:"1gxd5l"}],["path",{d:"M2 9h2",key:"1bbxkp"}],["path",{d:"M20 15h2",key:"19e6y8"}],["path",{d:"M20 9h2",key:"19tzq7"}],["path",{d:"M9 2v2",key:"165o2o"}],["path",{d:"M9 20v2",key:"i2bqo8"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yie=Lt("Crosshair",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"22",x2:"18",y1:"12",y2:"12",key:"l9bcsi"}],["line",{x1:"6",x2:"2",y1:"12",y2:"12",key:"13hhkx"}],["line",{x1:"12",x2:"12",y1:"6",y2:"2",key:"10w3f3"}],["line",{x1:"12",x2:"12",y1:"22",y2:"18",key:"15g9kq"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vc=Lt("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xie=Lt("Droplets",[["path",{d:"M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.84-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z",key:"1ptgy4"}],["path",{d:"M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97",key:"1sl1rz"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _ie=Lt("Ear",[["path",{d:"M6 8.5a6.5 6.5 0 1 1 13 0c0 6-6 6-6 10a3.5 3.5 0 1 1-7 0",key:"1dfaln"}],["path",{d:"M15 8.5a2.5 2.5 0 0 0-5 0v1a2 2 0 1 1 0 4",key:"1qnva7"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _6=Lt("Expand",[["path",{d:"m21 21-6-6m6 6v-4.8m0 4.8h-4.8",key:"1c15vz"}],["path",{d:"M3 16.2V21m0 0h4.8M3 21l6-6",key:"1fsnz2"}],["path",{d:"M21 7.8V3m0 0h-4.8M21 3l-6 6",key:"hawz9i"}],["path",{d:"M3 7.8V3m0 0h4.8M3 3l6 6",key:"u9ee12"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vie=Lt("ExternalLink",[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const v6=Lt("EyeOff",[["path",{d:"M9.88 9.88a3 3 0 1 0 4.24 4.24",key:"1jxqfv"}],["path",{d:"M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68",key:"9wicm4"}],["path",{d:"M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61",key:"1jreej"}],["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ga=Lt("Eye",[["path",{d:"M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z",key:"rwhkz3"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const eb=Lt("FileCheck",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"m9 15 2 2 4-4",key:"1grp1n"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bie=Lt("FileDown",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M12 18v-6",key:"17g6i2"}],["path",{d:"m9 15 3 3 3-3",key:"1npd3o"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wie=Lt("FileImage",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["circle",{cx:"10",cy:"12",r:"2",key:"737tya"}],["path",{d:"m20 17-1.296-1.296a2.41 2.41 0 0 0-3.408 0L9 22",key:"wt3hpn"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rs=Lt("FileText",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Sie=Lt("File",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const lf=Lt("Flag",[["path",{d:"M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z",key:"i9b6wo"}],["line",{x1:"4",x2:"4",y1:"22",y2:"15",key:"1cm3nv"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Tie=Lt("Flame",[["path",{d:"M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z",key:"96xj49"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Zm=Lt("FolderKanban",[["path",{d:"M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z",key:"1fr9dc"}],["path",{d:"M8 10v4",key:"tgpxqk"}],["path",{d:"M12 10v2",key:"hh53o1"}],["path",{d:"M16 10v6",key:"1d6xys"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const dI=Lt("FolderOpen",[["path",{d:"m6 14 1.5-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.54 6a2 2 0 0 1-1.95 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2",key:"usdka0"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const b6=Lt("Footprints",[["path",{d:"M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 10 3.8 10 5.5c0 3.11-2 5.66-2 8.68V16a2 2 0 1 1-4 0Z",key:"1dudjm"}],["path",{d:"M20 20v-2.38c0-2.12 1.03-3.12 1-5.62-.03-2.72-1.49-6-4.5-6C14.63 6 14 7.8 14 9.5c0 3.11 2 5.66 2 8.68V20a2 2 0 1 0 4 0Z",key:"l2t8xc"}],["path",{d:"M16 17h4",key:"1dejxt"}],["path",{d:"M4 13h4",key:"1bwh8b"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rv=Lt("Gauge",[["path",{d:"m12 14 4-4",key:"9kzdfg"}],["path",{d:"M3.34 19a10 10 0 1 1 17.32 0",key:"19p75a"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const i3=Lt("Globe",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const w6=Lt("GraduationCap",[["path",{d:"M21.42 10.922a1 1 0 0 0-.019-1.838L12.83 5.18a2 2 0 0 0-1.66 0L2.6 9.08a1 1 0 0 0 0 1.832l8.57 3.908a2 2 0 0 0 1.66 0z",key:"j76jl0"}],["path",{d:"M22 10v6",key:"1lu8f3"}],["path",{d:"M6 12.5V16a6 3 0 0 0 12 0v-3.5",key:"1r8lef"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Nie=Lt("Grid3x3",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}],["path",{d:"M9 3v18",key:"fh3hqa"}],["path",{d:"M15 3v18",key:"14nvp0"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Aie=Lt("Hammer",[["path",{d:"m15 12-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 0 1 0-3L12 9",key:"1afvon"}],["path",{d:"M17.64 15 22 10.64",key:"zsji6s"}],["path",{d:"m20.91 11.7-1.25-1.25c-.6-.6-.93-1.4-.93-2.25v-.86L16.01 4.6a5.56 5.56 0 0 0-3.94-1.64H9l.92.82A6.18 6.18 0 0 1 12 8.4v1.56l2 2h2.47l2.26 1.91",key:"lehyy1"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Cie=Lt("Hand",[["path",{d:"M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0",key:"aigmz7"}],["path",{d:"M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2",key:"1n6bmn"}],["path",{d:"M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8",key:"a9iiix"}],["path",{d:"M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15",key:"1s1gnw"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qc=Lt("HardHat",[["path",{d:"M2 18a1 1 0 0 0 1 1h18a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v2z",key:"1dej2m"}],["path",{d:"M10 10V5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v5",key:"1p9q5i"}],["path",{d:"M4 15v-3a6 6 0 0 1 6-6h0",key:"1uc279"}],["path",{d:"M14 6h0a6 6 0 0 1 6 6v3",key:"1j9mnm"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const r3=Lt("Hash",[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Eie=Lt("Home",[["path",{d:"m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",key:"y5dka4"}],["polyline",{points:"9 22 9 12 15 12 15 22",key:"e2us08"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const By=Lt("Image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ns=Lt("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Iie=Lt("Key",[["circle",{cx:"7.5",cy:"15.5",r:"5.5",key:"yqb3hr"}],["path",{d:"m21 2-9.6 9.6",key:"1j0ho8"}],["path",{d:"m15.5 7.5 3 3L22 7l-3-3",key:"1rn1fs"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vT=Lt("Layers",[["path",{d:"m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z",key:"8b97xw"}],["path",{d:"m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65",key:"dd6zsq"}],["path",{d:"m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65",key:"ep9fru"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pie=Lt("LayoutDashboard",[["rect",{width:"7",height:"9",x:"3",y:"3",rx:"1",key:"10lvy0"}],["rect",{width:"7",height:"5",x:"14",y:"3",rx:"1",key:"16une8"}],["rect",{width:"7",height:"9",x:"14",y:"12",rx:"1",key:"1hutg5"}],["rect",{width:"7",height:"5",x:"3",y:"16",rx:"1",key:"ldoo1y"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const jie=Lt("Leaf",[["path",{d:"M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z",key:"nnexq3"}],["path",{d:"M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12",key:"mt58a7"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rie=Lt("Link",[["path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71",key:"1cjeqo"}],["path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71",key:"19qd67"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const kie=Lt("ListChecks",[["path",{d:"m3 17 2 2 4-4",key:"1jhpwq"}],["path",{d:"m3 7 2 2 4-4",key:"1obspn"}],["path",{d:"M13 6h8",key:"15sg57"}],["path",{d:"M13 12h8",key:"h98zly"}],["path",{d:"M13 18h8",key:"oe0vm4"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Die=Lt("List",[["line",{x1:"8",x2:"21",y1:"6",y2:"6",key:"7ey8pc"}],["line",{x1:"8",x2:"21",y1:"12",y2:"12",key:"rjfblc"}],["line",{x1:"8",x2:"21",y1:"18",y2:"18",key:"c3b1m8"}],["line",{x1:"3",x2:"3.01",y1:"6",y2:"6",key:"1g7gq3"}],["line",{x1:"3",x2:"3.01",y1:"12",y2:"12",key:"1pjlvk"}],["line",{x1:"3",x2:"3.01",y1:"18",y2:"18",key:"28t2mc"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ro=Lt("Loader2",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const S6=Lt("Lock",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Mie=Lt("LogOut",[["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}],["polyline",{points:"16 17 21 12 16 7",key:"1gabdz"}],["line",{x1:"21",x2:"9",y1:"12",y2:"12",key:"1uyos4"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bT=Lt("Mail",[["rect",{width:"20",height:"16",x:"2",y:"4",rx:"2",key:"18n3k1"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wn=Lt("MapPin",[["path",{d:"M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z",key:"2oe9fu"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const n3=Lt("Map",[["polygon",{points:"3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21",key:"ok2ie8"}],["line",{x1:"9",x2:"9",y1:"3",y2:"18",key:"w34qz5"}],["line",{x1:"15",x2:"15",y1:"6",y2:"21",key:"volv9a"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oie=Lt("Maximize2",[["polyline",{points:"15 3 21 3 21 9",key:"mznyad"}],["polyline",{points:"9 21 3 21 3 15",key:"1avn1i"}],["line",{x1:"21",x2:"14",y1:"3",y2:"10",key:"ota7mn"}],["line",{x1:"3",x2:"10",y1:"21",y2:"14",key:"1atl0r"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const s3=Lt("Maximize",[["path",{d:"M8 3H5a2 2 0 0 0-2 2v3",key:"1dcmit"}],["path",{d:"M21 8V5a2 2 0 0 0-2-2h-3",key:"1e4gt3"}],["path",{d:"M3 16v3a2 2 0 0 0 2 2h3",key:"wsl5sc"}],["path",{d:"M16 21h3a2 2 0 0 0 2-2v-3",key:"18trek"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Lie=Lt("Menu",[["line",{x1:"4",x2:"20",y1:"12",y2:"12",key:"1e0a9i"}],["line",{x1:"4",x2:"20",y1:"6",y2:"6",key:"1owob3"}],["line",{x1:"4",x2:"20",y1:"18",y2:"18",key:"yk5zj1"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const T6=Lt("MessageSquare",[["path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",key:"1lielz"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const N6=Lt("Minimize2",[["polyline",{points:"4 14 10 14 10 20",key:"11kfnr"}],["polyline",{points:"20 10 14 10 14 4",key:"rlmsce"}],["line",{x1:"14",x2:"21",y1:"10",y2:"3",key:"o5lafz"}],["line",{x1:"3",x2:"10",y1:"21",y2:"14",key:"1atl0r"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fie=Lt("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zie=Lt("Moon",[["path",{d:"M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z",key:"a7tn18"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qd=Lt("MoreVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xS=Lt("Mountain",[["path",{d:"m8 3 4 8 5-5 5 15H2L8 3z",key:"otkl63"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const cf=Lt("Navigation",[["polygon",{points:"3 11 22 2 13 21 11 13 3 11",key:"1ltx0t"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Bie=Lt("Package",[["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}],["path",{d:"M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z",key:"hh9hay"}],["path",{d:"m3.3 7 8.7 5 8.7-5",key:"g66t2b"}],["path",{d:"M12 22V12",key:"d0xqtd"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const A6=Lt("Palette",[["circle",{cx:"13.5",cy:"6.5",r:".5",fill:"currentColor",key:"1okk4w"}],["circle",{cx:"17.5",cy:"10.5",r:".5",fill:"currentColor",key:"f64h9f"}],["circle",{cx:"8.5",cy:"7.5",r:".5",fill:"currentColor",key:"fotxhn"}],["circle",{cx:"6.5",cy:"12.5",r:".5",fill:"currentColor",key:"qy21gx"}],["path",{d:"M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z",key:"12rzf8"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wT=Lt("PenLine",[["path",{d:"M12 20h9",key:"t2du7b"}],["path",{d:"M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z",key:"ymcmye"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vie=Lt("PenTool",[["path",{d:"m12 19 7-7 3 3-7 7-3-3z",key:"rklqx2"}],["path",{d:"m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z",key:"1et58u"}],["path",{d:"m2 2 7.586 7.586",key:"etlp93"}],["circle",{cx:"11",cy:"11",r:"2",key:"xmgehs"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Uie=Lt("Pencil",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const a3=Lt("PhoneCall",[["path",{d:"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z",key:"foiqr5"}],["path",{d:"M14.05 2a9 9 0 0 1 8 7.94",key:"vmijpz"}],["path",{d:"M14.05 6A5 5 0 0 1 18 10",key:"13nbpp"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Hd=Lt("Phone",[["path",{d:"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z",key:"foiqr5"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Zn=Lt("Plane",[["path",{d:"M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z",key:"1v9wt8"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vr=Lt("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const C6=Lt("Printer",[["polyline",{points:"6 9 6 2 18 2 18 9",key:"1306q4"}],["path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2",key:"143wyd"}],["rect",{width:"12",height:"8",x:"6",y:"14",key:"5ipwut"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qie=Lt("Radar",[["path",{d:"M19.07 4.93A10 10 0 0 0 6.99 3.34",key:"z3du51"}],["path",{d:"M4 6h.01",key:"oypzma"}],["path",{d:"M2.29 9.62A10 10 0 1 0 21.31 8.35",key:"qzzz0"}],["path",{d:"M16.24 7.76A6 6 0 1 0 8.23 16.67",key:"1yjesh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M17.99 11.66A6 6 0 0 1 15.77 16.67",key:"1u2y91"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"m13.41 10.59 5.66-5.66",key:"mhq4k0"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Jc=Lt("Radio",[["path",{d:"M4.9 19.1C1 15.2 1 8.8 4.9 4.9",key:"1vaf9d"}],["path",{d:"M7.8 16.2c-2.3-2.3-2.3-6.1 0-8.5",key:"u1ii0m"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M16.2 7.8c2.3 2.3 2.3 6.1 0 8.5",key:"1j5fej"}],["path",{d:"M19.1 4.9C23 8.8 23 15.1 19.1 19",key:"10b0cb"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const eu=Lt("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _S=Lt("Route",[["circle",{cx:"6",cy:"19",r:"3",key:"1kj8tv"}],["path",{d:"M9 19h8.5a3.5 3.5 0 0 0 0-7h-11a3.5 3.5 0 0 1 0-7H15",key:"1d8sl"}],["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const o3=Lt("Ruler",[["path",{d:"M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0Z",key:"icamh8"}],["path",{d:"m14.5 12.5 2-2",key:"inckbg"}],["path",{d:"m11.5 9.5 2-2",key:"fmmyf7"}],["path",{d:"m8.5 6.5 2-2",key:"vc6u1g"}],["path",{d:"m17.5 15.5 2-2",key:"wo5hmg"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const tb=Lt("Save",[["path",{d:"M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z",key:"1owoqh"}],["polyline",{points:"17 21 17 13 7 13 7 21",key:"1md35c"}],["polyline",{points:"7 3 7 8 15 8",key:"8nz8an"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $ie=Lt("Scale",[["path",{d:"m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z",key:"7g6ntu"}],["path",{d:"m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z",key:"ijws7r"}],["path",{d:"M7 21h10",key:"1b0cd5"}],["path",{d:"M12 3v18",key:"108xh3"}],["path",{d:"M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2",key:"3gwbw2"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const nu=Lt("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const hI=Lt("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Gie=Lt("Settings2",[["path",{d:"M20 7h-9",key:"3s1dr2"}],["path",{d:"M14 17H5",key:"gfn3mx"}],["circle",{cx:"17",cy:"17",r:"3",key:"18b49y"}],["circle",{cx:"7",cy:"7",r:"3",key:"dfmy0x"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const kv=Lt("Settings",[["path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z",key:"1qme2f"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const E6=Lt("ShieldAlert",[["path",{d:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10",key:"1irkt0"}],["path",{d:"M12 8v4",key:"1got3b"}],["path",{d:"M12 16h.01",key:"1drbdi"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ij=Lt("ShieldCheck",[["path",{d:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10",key:"1irkt0"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ds=Lt("Shield",[["path",{d:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10",key:"1irkt0"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Hie=Lt("Shirt",[["path",{d:"M20.38 3.46 16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z",key:"1wgbhj"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wie=Lt("Siren",[["path",{d:"M7 12a5 5 0 0 1 5-5v0a5 5 0 0 1 5 5v6H7v-6Z",key:"rmc51c"}],["path",{d:"M5 20a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v2H5v-2Z",key:"yyvmjy"}],["path",{d:"M21 12h1",key:"jtio3y"}],["path",{d:"M18.5 4.5 18 5",key:"g5sp9y"}],["path",{d:"M2 12h1",key:"1uaihz"}],["path",{d:"M12 2v1",key:"11qlp1"}],["path",{d:"m4.929 4.929.707.707",key:"1i51kw"}],["path",{d:"M12 12v6",key:"3ahymv"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const I6=Lt("Smartphone",[["rect",{width:"14",height:"20",x:"5",y:"2",rx:"2",ry:"2",key:"1yt0o3"}],["path",{d:"M12 18h.01",key:"mhygvu"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const uf=Lt("SquarePen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4Z",key:"1lpok0"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vS=Lt("Square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const P6=Lt("StarOff",[["path",{d:"M8.34 8.34 2 9.27l5 4.87L5.82 21 12 17.77 18.18 21l-.59-3.43",key:"16m0ql"}],["path",{d:"M18.42 12.76 22 9.27l-6.91-1L12 2l-1.44 2.91",key:"1vt8nq"}],["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const j6=Lt("Star",[["polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2",key:"8f66p6"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const R6=Lt("Sun",[["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"m17.66 17.66 1.41 1.41",key:"ptbguv"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m6.34 17.66-1.41 1.41",key:"1m8zz5"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Zie=Lt("Sunrise",[["path",{d:"M12 2v8",key:"1q4o3n"}],["path",{d:"m4.93 10.93 1.41 1.41",key:"2a7f42"}],["path",{d:"M2 18h2",key:"j10viu"}],["path",{d:"M20 18h2",key:"wocana"}],["path",{d:"m19.07 10.93-1.41 1.41",key:"15zs5n"}],["path",{d:"M22 22H2",key:"19qnx5"}],["path",{d:"m8 6 4-4 4 4",key:"ybng9g"}],["path",{d:"M16 18a4 4 0 0 0-8 0",key:"1lzouq"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const l3=Lt("Tag",[["path",{d:"M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z",key:"vktsd0"}],["circle",{cx:"7.5",cy:"7.5",r:".5",fill:"currentColor",key:"kqv944"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const go=Lt("Target",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["circle",{cx:"12",cy:"12",r:"6",key:"1vlfrh"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xie=Lt("ThermometerSun",[["path",{d:"M12 9a4 4 0 0 0-2 7.5",key:"1jvsq6"}],["path",{d:"M12 3v2",key:"1w22ol"}],["path",{d:"m6.6 18.4-1.4 1.4",key:"w2yidj"}],["path",{d:"M20 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z",key:"iof6y5"}],["path",{d:"M4 13H2",key:"118le4"}],["path",{d:"M6.34 7.34 4.93 5.93",key:"1brd51"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const k6=Lt("Thermometer",[["path",{d:"M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z",key:"17jzev"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yie=Lt("ThumbsDown",[["path",{d:"M17 14V2",key:"8ymqnk"}],["path",{d:"M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22h0a3.13 3.13 0 0 1-3-3.88Z",key:"s6e0r"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Kie=Lt("ThumbsUp",[["path",{d:"M7 10v12",key:"1qc93n"}],["path",{d:"M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z",key:"y3tblf"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ln=Lt("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qie=Lt("TreePine",[["path",{d:"m17 14 3 3.3a1 1 0 0 1-.7 1.7H4.7a1 1 0 0 1-.7-1.7L7 14h-.3a1 1 0 0 1-.7-1.7L9 9h-.2A1 1 0 0 1 8 7.3L12 3l4 4.3a1 1 0 0 1-.8 1.7H15l3 3.3a1 1 0 0 1-.7 1.7H17Z",key:"cpyugq"}],["path",{d:"M12 22v-3",key:"kmzjlo"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const D6=Lt("Truck",[["path",{d:"M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2",key:"wrbu53"}],["path",{d:"M15 18H9",key:"1lyqi6"}],["path",{d:"M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14",key:"lysw3i"}],["circle",{cx:"17",cy:"18",r:"2",key:"332jqn"}],["circle",{cx:"7",cy:"18",r:"2",key:"19iecd"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _2=Lt("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Jie=Lt("UserCheck",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["polyline",{points:"16 11 18 13 22 9",key:"1pwet4"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ere=Lt("UserX",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"17",x2:"22",y1:"8",y2:"13",key:"3nzzx3"}],["line",{x1:"22",x2:"17",y1:"8",y2:"13",key:"1swrse"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fa=Lt("User",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ds=Lt("Users",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["path",{d:"M16 3.13a4 4 0 0 1 0 7.75",key:"1da9ce"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const tre=Lt("Volume2",[["polygon",{points:"11 5 6 9 2 9 2 15 6 15 11 19 11 5",key:"16drj5"}],["path",{d:"M15.54 8.46a5 5 0 0 1 0 7.07",key:"ltjumu"}],["path",{d:"M19.07 4.93a10 10 0 0 1 0 14.14",key:"1kegas"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const v2=Lt("Weight",[["circle",{cx:"12",cy:"5",r:"3",key:"rqqgnr"}],["path",{d:"M6.5 8a2 2 0 0 0-1.905 1.46L2.1 18.5A2 2 0 0 0 4 21h16a2 2 0 0 0 1.925-2.54L19.4 9.5A2 2 0 0 0 17.48 8Z",key:"56o5sh"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ire=Lt("Wheat",[["path",{d:"M2 22 16 8",key:"60hf96"}],["path",{d:"M3.47 12.53 5 11l1.53 1.53a3.5 3.5 0 0 1 0 4.94L5 19l-1.53-1.53a3.5 3.5 0 0 1 0-4.94Z",key:"1rdhi6"}],["path",{d:"M7.47 8.53 9 7l1.53 1.53a3.5 3.5 0 0 1 0 4.94L9 15l-1.53-1.53a3.5 3.5 0 0 1 0-4.94Z",key:"1sdzmb"}],["path",{d:"M11.47 4.53 13 3l1.53 1.53a3.5 3.5 0 0 1 0 4.94L13 11l-1.53-1.53a3.5 3.5 0 0 1 0-4.94Z",key:"eoatbi"}],["path",{d:"M20 2h2v2a4 4 0 0 1-4 4h-2V6a4 4 0 0 1 4-4Z",key:"19rau1"}],["path",{d:"M11.47 17.47 13 19l-1.53 1.53a3.5 3.5 0 0 1-4.94 0L5 19l1.53-1.53a3.5 3.5 0 0 1 4.94 0Z",key:"tc8ph9"}],["path",{d:"M15.47 13.47 17 15l-1.53 1.53a3.5 3.5 0 0 1-4.94 0L9 15l1.53-1.53a3.5 3.5 0 0 1 4.94 0Z",key:"2m8kc5"}],["path",{d:"M19.47 9.47 21 11l-1.53 1.53a3.5 3.5 0 0 1-4.94 0L13 11l1.53-1.53a3.5 3.5 0 0 1 4.94 0Z",key:"vex3ng"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rre=Lt("WifiOff",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const M6=Lt("Wifi",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const by=Lt("Wind",[["path",{d:"M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2",key:"1k4u03"}],["path",{d:"M9.6 4.6A2 2 0 1 1 11 8H2",key:"b7d0fd"}],["path",{d:"M12.6 19.4A2 2 0 1 0 14 16H2",key:"1p5cb3"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bf=Lt("Wrench",[["path",{d:"M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z",key:"cbrjhi"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zl=Lt("XCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const cs=Lt("X",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pj=Lt("Zap",[["polygon",{points:"13 2 3 14 12 14 11 22 21 10 12 10 13 2",key:"45s27k"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const nre=Lt("ZoomIn",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]]);class sre extends jI.Component{constructor(r){super(r);xw(this,"handleReload",()=>{window.location.reload()});xw(this,"handleGoHome",()=>{window.location.href="/"});xw(this,"handleRetry",()=>{this.setState({hasError:!1,error:null,errorInfo:null})});this.state={hasError:!1,error:null,errorInfo:null}}static getDerivedStateFromError(r){return{hasError:!0,error:r}}componentDidCatch(r,c){console.error("ErrorBoundary caught an error:",r,c),this.setState({errorInfo:c})}render(){var r,c;if(this.state.hasError){const h=(c=(r=this.state.error)==null?void 0:r.message)==null?void 0:c.includes("Loading chunk");return n.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 px-4",children:n.jsxs("div",{className:"max-w-md w-full text-center",children:[n.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4",children:n.jsx(ir,{className:"w-8 h-8 text-red-600"})}),n.jsx("h1",{className:"text-xl font-semibold text-gray-900 mb-2",children:h?"Update Available":"Something went wrong"}),n.jsx("p",{className:"text-gray-600 mb-6",children:h?"A new version of the application is available. Please refresh the page to continue.":"An unexpected error occurred. Our team has been notified and is working on a fix."}),!1,n.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 justify-center",children:[n.jsxs("button",{onClick:this.handleReload,className:"inline-flex items-center justify-center gap-2 px-4 py-2 bg-aeria-navy text-white rounded-lg hover:bg-aeria-navy/90 transition-colors",children:[n.jsx(eu,{className:"w-4 h-4"}),"Refresh Page"]}),n.jsxs("button",{onClick:this.handleGoHome,className:"inline-flex items-center justify-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors",children:[n.jsx(Eie,{className:"w-4 h-4"}),"Go to Dashboard"]})]}),!h&&n.jsx("button",{onClick:this.handleRetry,className:"mt-4 text-sm text-aeria-navy hover:underline",children:"Try again without refreshing"})]})})}return this.props.children}}const are=[{name:"Dashboard",href:"/",icon:Pie},{name:"Projects",href:"/projects",icon:Zm},{name:"Forms",href:"/forms",icon:Ll},{name:"Policies",href:"/policies",icon:yS}],ore=[{name:"Safety Dashboard",href:"/safety",icon:Ds},{name:"Incidents",href:"/incidents",icon:ir},{name:"CAPAs",href:"/capas",icon:go}],lre=[{name:"Operators",href:"/operators",icon:ds},{name:"Aircraft",href:"/aircraft",icon:Zn},{name:"Clients",href:"/clients",icon:Vl}];function c3({mobile:t,onClose:e}){var $,Y,H;const{userProfile:r,signOut:c}=iu(),h=tu(),[x,w]=ue.useState(!0),[o,C]=ue.useState(!0),R=async()=>{await c(),h("/login")},F=({item:X})=>n.jsxs(RL,{to:X.href,onClick:t?e:void 0,className:({isActive:he})=>`flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${he?"bg-aeria-sky text-aeria-navy":"text-gray-600 hover:bg-gray-100 hover:text-gray-900"}`,children:[n.jsx(X.icon,{className:"w-5 h-5"}),X.name]});return n.jsxs("div",{className:"flex flex-col h-full bg-white",children:[n.jsxs("div",{className:"flex items-center justify-between h-16 px-4 border-b border-gray-200",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("div",{className:"w-8 h-8 bg-aeria-navy rounded-lg flex items-center justify-center",children:n.jsx("span",{className:"text-white font-bold text-sm",children:"A"})}),n.jsx("span",{className:"font-semibold text-aeria-navy",children:"Aeria Ops"})]}),t&&n.jsx("button",{onClick:e,className:"p-2 text-gray-500 hover:text-gray-700",children:n.jsx(cs,{className:"w-5 h-5"})})]}),n.jsxs("nav",{className:"flex-1 px-3 py-4 space-y-1 overflow-y-auto",children:[are.map(X=>n.jsx(F,{item:X},X.name)),n.jsxs("div",{className:"pt-4",children:[n.jsxs("button",{onClick:()=>C(!o),className:"flex items-center justify-between w-full px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider hover:text-gray-700",children:[n.jsxs("span",{className:"flex items-center gap-2",children:[n.jsx(Ds,{className:"w-4 h-4"}),"Safety"]}),n.jsx(fn,{className:`w-4 h-4 transition-transform ${o?"":"-rotate-90"}`})]}),o&&n.jsx("div",{className:"mt-1 space-y-1",children:ore.map(X=>n.jsx(F,{item:X},X.name))})]}),n.jsxs("div",{className:"pt-4",children:[n.jsxs("button",{onClick:()=>w(!x),className:"flex items-center justify-between w-full px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider hover:text-gray-700",children:["Libraries",n.jsx(fn,{className:`w-4 h-4 transition-transform ${x?"":"-rotate-90"}`})]}),x&&n.jsx("div",{className:"mt-1 space-y-1",children:lre.map(X=>n.jsx(F,{item:X},X.name))})]})]}),n.jsxs("div",{className:"border-t border-gray-200 p-3",children:[n.jsxs(RL,{to:"/settings",onClick:t?e:void 0,className:({isActive:X})=>`flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${X?"bg-aeria-sky text-aeria-navy":"text-gray-600 hover:bg-gray-100 hover:text-gray-900"}`,children:[n.jsx(kv,{className:"w-5 h-5"}),"Settings"]}),n.jsxs("div",{className:"flex items-center gap-3 px-3 py-2 mt-1",children:[n.jsx("div",{className:"w-8 h-8 bg-aeria-blue rounded-full flex items-center justify-center",children:n.jsx("span",{className:"text-white text-sm font-medium",children:(($=r==null?void 0:r.firstName)==null?void 0:$[0])||((H=(Y=r==null?void 0:r.email)==null?void 0:Y[0])==null?void 0:H.toUpperCase())||"?"})}),n.jsx("div",{className:"flex-1 min-w-0",children:n.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:r!=null&&r.firstName?`${r.firstName} ${r.lastName}`:r==null?void 0:r.email})}),n.jsx("button",{onClick:R,className:"p-1.5 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100",title:"Sign out",children:n.jsx(Mie,{className:"w-4 h-4"})})]})]})]})}function cre(){const[t,e]=ue.useState(!1);return n.jsxs("div",{className:"min-h-screen bg-gray-50",children:[t&&n.jsx("div",{className:"fixed inset-0 bg-black/50 z-40 lg:hidden",onClick:()=>e(!1)}),n.jsx("div",{className:`fixed inset-y-0 left-0 w-64 z-50 lg:hidden transform transition-transform duration-200 ${t?"translate-x-0":"-translate-x-full"}`,children:n.jsx(c3,{mobile:!0,onClose:()=>e(!1)})}),n.jsx("div",{className:"hidden lg:fixed lg:inset-y-0 lg:left-0 lg:w-64 lg:block border-r border-gray-200",children:n.jsx(c3,{})}),n.jsxs("div",{className:"lg:pl-64",children:[n.jsxs("div",{className:"sticky top-0 z-30 flex items-center h-16 px-4 bg-white border-b border-gray-200 lg:hidden",children:[n.jsx("button",{onClick:()=>e(!0),className:"p-2 -ml-2 text-gray-500 hover:text-gray-700",children:n.jsx(Lie,{className:"w-6 h-6"})}),n.jsxs("div",{className:"flex items-center gap-2 ml-3",children:[n.jsx("div",{className:"w-7 h-7 bg-aeria-navy rounded-lg flex items-center justify-center",children:n.jsx("span",{className:"text-white font-bold text-xs",children:"A"})}),n.jsx("span",{className:"font-semibold text-aeria-navy",children:"Aeria Ops"})]})]}),n.jsx("main",{className:"p-4 lg:p-8",children:n.jsx(TW,{})})]})]})}function ure(){const{signIn:t,resetPassword:e,error:r}=iu(),[c,h]=ue.useState(""),[x,w]=ue.useState(""),[o,C]=ue.useState(!1),[R,F]=ue.useState(!1),[$,Y]=ue.useState(""),[H,X]=ue.useState(!1),[he,se]=ue.useState(""),[de,K]=ue.useState(!1),[ge,Ae]=ue.useState(!1),[Te,Ce]=ue.useState(""),ne=async ke=>{ke.preventDefault(),Y(""),F(!0);try{await t(c,x)}catch(Ve){switch(Ve.code){case"auth/invalid-email":Y("Invalid email address");break;case"auth/user-disabled":Y("This account has been disabled");break;case"auth/user-not-found":case"auth/wrong-password":case"auth/invalid-credential":Y("Invalid email or password");break;case"auth/too-many-requests":Y("Too many failed attempts. Please try again later.");break;default:Y("Failed to sign in. Please try again.")}}finally{F(!1)}},ae=async ke=>{ke.preventDefault(),Ce(""),K(!0);try{await e(he),Ae(!0)}catch(Ve){switch(Ve.code){case"auth/invalid-email":Ce("Please enter a valid email address");break;case"auth/user-not-found":Ae(!0);break;default:Ce("Failed to send reset email. Please try again.")}}finally{K(!1)}},q=()=>{se(c),Ae(!1),Ce(""),X(!0)},oe=()=>{X(!1),se(""),Ae(!1),Ce("")};return n.jsxs("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 px-4",children:[n.jsxs("div",{className:"w-full max-w-md",children:[n.jsxs("div",{className:"text-center mb-8",children:[n.jsx("div",{className:"w-16 h-16 bg-aeria-navy rounded-2xl flex items-center justify-center mx-auto mb-4",children:n.jsx("span",{className:"text-white font-bold text-2xl",children:"A"})}),n.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Aeria Ops"}),n.jsx("p",{className:"text-gray-600 mt-1",children:"Sign in to your account"})]}),n.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 p-6",children:n.jsxs("form",{onSubmit:ne,className:"space-y-4",children:[($||r)&&n.jsxs("div",{className:"flex items-center gap-2 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm",role:"alert","aria-live":"polite",children:[n.jsx(Cs,{className:"w-4 h-4 flex-shrink-0","aria-hidden":"true"}),n.jsx("span",{children:$||r})]}),n.jsxs("div",{children:[n.jsx("label",{htmlFor:"email",className:"label",children:"Email address"}),n.jsx("input",{id:"email",type:"email",value:c,onChange:ke=>h(ke.target.value),className:"input",placeholder:"you@example.com",required:!0,autoComplete:"email",autoFocus:!0,"aria-describedby":"email-hint"})]}),n.jsxs("div",{children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("label",{htmlFor:"password",className:"label",children:"Password"}),n.jsx("button",{type:"button",onClick:q,className:"text-xs text-aeria-navy hover:text-aeria-navy/80 hover:underline",children:"Forgot password?"})]}),n.jsxs("div",{className:"relative",children:[n.jsx("input",{id:"password",type:o?"text":"password",value:x,onChange:ke=>w(ke.target.value),className:"input pr-10",placeholder:"",required:!0,autoComplete:"current-password","aria-describedby":"password-hint"}),n.jsx("button",{type:"button",onClick:()=>C(!o),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600","aria-label":o?"Hide password":"Show password",children:o?n.jsx(v6,{className:"w-4 h-4","aria-hidden":"true"}):n.jsx(ga,{className:"w-4 h-4","aria-hidden":"true"})})]})]}),n.jsx("button",{type:"submit",disabled:R,className:"btn-primary w-full flex items-center justify-center gap-2","aria-busy":R,children:R?n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin","aria-hidden":"true"}),"Signing in..."]}):"Sign in"})]})}),n.jsx("p",{className:"text-center text-sm text-gray-500 mt-6",children:"Need an account? Contact your administrator."})]}),H&&n.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50",role:"dialog","aria-modal":"true","aria-labelledby":"reset-modal-title",children:n.jsxs("div",{className:"bg-white rounded-xl shadow-xl w-full max-w-md",children:[n.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-200",children:[n.jsx("h2",{id:"reset-modal-title",className:"text-lg font-semibold text-gray-900",children:"Reset Password"}),n.jsx("button",{type:"button",onClick:oe,className:"p-1 text-gray-400 hover:text-gray-600 rounded","aria-label":"Close modal",children:n.jsx(cs,{className:"w-5 h-5","aria-hidden":"true"})})]}),n.jsx("div",{className:"p-4",children:ge?n.jsxs("div",{className:"text-center py-4",children:[n.jsx("div",{className:"w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4",children:n.jsx(qr,{className:"w-6 h-6 text-green-600","aria-hidden":"true"})}),n.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Check your email"}),n.jsxs("p",{className:"text-gray-600 text-sm mb-4",children:["If an account exists for ",n.jsx("strong",{children:he}),", you'll receive a password reset link shortly."]}),n.jsx("p",{className:"text-gray-500 text-xs mb-4",children:"Don't see it? Check your spam folder."}),n.jsx("button",{type:"button",onClick:oe,className:"btn-primary",children:"Back to Login"})]}):n.jsxs("form",{onSubmit:ae,className:"space-y-4",children:[n.jsx("p",{className:"text-gray-600 text-sm",children:"Enter your email address and we'll send you a link to reset your password."}),Te&&n.jsxs("div",{className:"flex items-center gap-2 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm",role:"alert","aria-live":"polite",children:[n.jsx(Cs,{className:"w-4 h-4 flex-shrink-0","aria-hidden":"true"}),n.jsx("span",{children:Te})]}),n.jsxs("div",{children:[n.jsx("label",{htmlFor:"reset-email",className:"label",children:"Email address"}),n.jsxs("div",{className:"relative",children:[n.jsx(bT,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400","aria-hidden":"true"}),n.jsx("input",{id:"reset-email",type:"email",value:he,onChange:ke=>se(ke.target.value),className:"input pl-10",placeholder:"you@example.com",required:!0,autoFocus:!0})]})]}),n.jsxs("div",{className:"flex gap-3",children:[n.jsx("button",{type:"button",onClick:oe,className:"flex-1 px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors",children:"Cancel"}),n.jsx("button",{type:"submit",disabled:de,className:"flex-1 btn-primary flex items-center justify-center gap-2","aria-busy":de,children:de?n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin","aria-hidden":"true"}),"Sending..."]}):"Send Reset Link"})]})]})})]})})]})}const u3={draft:{label:"Draft",color:"bg-gray-100 text-gray-700"},surveyed:{label:"Surveyed",color:"bg-blue-100 text-blue-700"},planned:{label:"Planned",color:"bg-yellow-100 text-yellow-700"},approved:{label:"Approved",color:"bg-green-100 text-green-700"},completed:{label:"Completed",color:"bg-purple-100 text-purple-700"}},Q0={siteSurvey:{id:"siteSurvey",label:"Site Survey",description:"Location, boundary, obstacles",color:"#3B82F6",elements:["siteLocation","operationsBoundary","obstacles"]},flightPlan:{id:"flightPlan",label:"Flight Plan",description:"Launch, recovery, flight geography",color:"#22C55E",elements:["launchPoint","recoveryPoint","flightGeography","contingencyVolume","groundRiskBuffer"]},emergency:{id:"emergency",label:"Emergency",description:"Muster points, evacuation routes",color:"#EF4444",elements:["musterPoints","evacuationRoutes"]}},In={siteLocation:{type:"marker",layer:"siteSurvey",label:"Site Location",color:"#3B82F6",icon:"map-pin",description:"Center point of the operation site"},operationsBoundary:{type:"polygon",layer:"siteSurvey",label:"Operations Boundary",color:"#3B82F6",fillOpacity:.1,strokeWidth:2,strokeStyle:"solid",description:"Area where operations will take place"},obstacles:{type:"marker",layer:"siteSurvey",label:"Obstacle",color:"#F59E0B",icon:"alert-triangle",description:"Identified obstacles (towers, wires, etc.)"},launchPoint:{type:"marker",layer:"flightPlan",label:"Launch Point",color:"#22C55E",icon:"plane-takeoff",description:"RPAS launch/takeoff location"},recoveryPoint:{type:"marker",layer:"flightPlan",label:"Recovery Point",color:"#F97316",icon:"plane-landing",description:"RPAS landing/recovery location"},pilotPosition:{type:"marker",layer:"flightPlan",label:"Pilot Position",color:"#8B5CF6",icon:"user",description:"Remote pilot operating position"},flightGeography:{type:"polygon",layer:"flightPlan",label:"Flight Geography",color:"#22C55E",fillOpacity:.05,strokeWidth:2,strokeStyle:"dashed",description:"Intended flight area (SORA)"},contingencyVolume:{type:"polygon",layer:"flightPlan",label:"Contingency Volume",color:"#EAB308",fillOpacity:.05,strokeWidth:2,strokeStyle:"dotted",description:"Buffer for abnormal situations (SORA)"},groundRiskBuffer:{type:"polygon",layer:"flightPlan",label:"Ground Risk Buffer",color:"#F97316",fillOpacity:.03,strokeWidth:1,strokeStyle:"dotted",description:"Extended ground risk area (SORA)"},musterPoints:{type:"marker",layer:"emergency",label:"Muster Point",color:"#EF4444",icon:"flag",description:"Emergency assembly location"},evacuationRoutes:{type:"line",layer:"emergency",label:"Evacuation Route",color:"#EF4444",strokeWidth:3,strokeStyle:"solid",arrowEnd:!0,description:"Primary evacuation path"}},J0={streets:{id:"streets",label:"Streets",style:"mapbox://styles/mapbox/streets-v12",icon:"map"},satellite:{id:"satellite",label:"Satellite",style:"mapbox://styles/mapbox/satellite-streets-v12",icon:"globe"},outdoors:{id:"outdoors",label:"Outdoors",style:"mapbox://styles/mapbox/outdoors-v12",icon:"mountain"}},pI={controlled:{id:"controlled",label:"Controlled Ground",description:"Access strictly controlled, no uninvolved people",density:"0",color:"#22C55E"},remote:{id:"remote",label:"Remote/Uninhabited",description:"Wilderness, no permanent structures",density:"< 1/km",color:"#86EFAC"},lightly:{id:"lightly",label:"Lightly Populated",description:"Rural areas, scattered buildings",density:"1-50/km",color:"#FEF08A"},sparsely:{id:"sparsely",label:"Sparsely Populated",description:"Small towns, light residential",density:"50-500/km",color:"#FDE047"},suburban:{id:"suburban",label:"Suburban",description:"Residential neighborhoods",density:"500-5000/km",color:"#FDBA74"},highdensity:{id:"highdensity",label:"High Density Urban",description:"Urban centers, high-rise areas",density:"> 5000/km",color:"#FCA5A5"},assembly:{id:"assembly",label:"Assembly of People",description:"Events, stadiums, gatherings",density:"Variable",color:"#F87171"}},dre=(t,e,r=null)=>({type:"Point",coordinates:r!==null?[t,e,r]:[t,e]}),hre=t=>({type:"Polygon",coordinates:[t]}),pre=t=>({type:"LineString",coordinates:t}),rp=(t,e,r={})=>({id:r.id||`marker_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,type:"marker",elementType:r.elementType||"generic",geometry:dre(t,e,r.altitude),properties:{label:r.label||"",description:r.description||"",icon:r.icon||"map-pin",color:r.color||"#3B82F6",...r.properties},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}),jj=(t,e={})=>({id:e.id||`polygon_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,type:"polygon",elementType:e.elementType||"generic",geometry:hre(t),properties:{label:e.label||"",description:e.description||"",color:e.color||"#3B82F6",fillOpacity:e.fillOpacity||.1,strokeWidth:e.strokeWidth||2,strokeStyle:e.strokeStyle||"solid",area:e.area||null,...e.properties},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}),mre=(t,e={})=>({id:e.id||`line_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,type:"line",elementType:e.elementType||"generic",geometry:pre(t),properties:{label:e.label||"",description:e.description||"",color:e.color||"#EF4444",strokeWidth:e.strokeWidth||3,strokeStyle:e.strokeStyle||"solid",arrowEnd:e.arrowEnd||!1,distance:e.distance||null,...e.properties},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}),O6=(t,e,r={})=>({...rp(t,e,{elementType:"obstacles",icon:"alert-triangle",color:"#F59E0B",...r}),obstacleType:r.obstacleType||"other",height:r.height||null,radius:r.radius||null,lighted:r.lighted||!1,notes:r.notes||""}),L6=(t,e,r={})=>({...rp(t,e,{elementType:"musterPoints",icon:"flag",color:"#EF4444",...r}),isPrimary:r.isPrimary||!1,capacity:r.capacity||null,accessibility:r.accessibility||"",notes:r.notes||""}),F6=(t,e={})=>({...mre(t,{elementType:"evacuationRoutes",color:"#EF4444",strokeWidth:3,arrowEnd:!0,...e}),isPrimary:e.isPrimary||!1,surfaceType:e.surfaceType||"",estimatedTime:e.estimatedTime||null,notes:e.notes||""}),tx=()=>({siteSurvey:{siteLocation:null,operationsBoundary:null,obstacles:[]},flightPlan:{launchPoint:null,recoveryPoint:null,pilotPosition:null,flightGeography:null,contingencyVolume:null,groundRiskBuffer:null},emergency:{musterPoints:[],evacuationRoutes:[]}}),ST=()=>({locationName:"",address:"",accessInstructions:"",population:{category:null,adjacentCategory:null,density:null,justification:"",assessmentDate:null},surroundings:{terrain:"",vegetation:"",structures:"",waterFeatures:"",wildlife:""},access:{vehicleAccess:!0,parkingAvailable:!0,permissionsRequired:[],landOwner:"",accessNotes:""},photos:[],surveyDate:null,surveyedBy:null,notes:""}),TT=()=>({aircraft:[],primaryAircraftId:null,operationType:"VLOS",maxAltitudeAGL:120,maxDistanceFromPilot:null,flightDuration:null,totalFlights:1,airspace:{classification:"G",controlled:!1,restrictions:[],nearestAerodrome:"",aerodromeDistance:null,aerodromeDirection:"",notamRequired:!1,atcCoordinationRequired:!1,notams:[],notes:""},areaType:null,flightGeographyMethod:"manual",contingencyBuffer:null,groundRiskBufferMethod:"altitude",groundRiskBuffer:null,adjacentAreaConsidered:!1,localWeatherFactors:"",siteContingencies:[],notes:""}),NT=()=>({localEmergencyNotes:"",nearestHospital:{name:"",address:"",distance:null,estimatedTime:null,phone:""},nearestFireStation:{name:"",distance:null,phone:""},siteEvacuationProcedure:"",flyAwayProcedure:"",notes:""}),AT=()=>({populationCategory:null,adjacentAreaPopulation:null,operationType:"VLOS",maxAltitudeAGL:120,uaCharacteristic:null,iGRC:null,fGRC:null,initialARC:null,residualARC:null,sail:null,containment:{method:"none",evidence:""},mitigationOverrides:{},osoCompliance:{},calculationDate:null,isValid:!1,validationNotes:""}),CT=(t={})=>{const e=new Date().toISOString();return{id:t.id||`site_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:t.name||"New Site",description:t.description||"",status:t.status||"draft",order:t.order||0,mapData:tx(),siteSurvey:ST(),flightPlan:TT(),emergency:NT(),soraAssessment:AT(),createdAt:e,updatedAt:e,createdBy:t.createdBy||null}},z6=t=>{var o,C,R,F,$,Y,H,X,he,se,de,K,ge,Ae;const e={minLng:1/0,maxLng:-1/0,minLat:1/0,maxLat:-1/0};let r=!1;const c=Te=>{var ae;if(!((ae=Te==null?void 0:Te.geometry)!=null&&ae.coordinates))return;const[Ce,ne]=Te.geometry.coordinates;e.minLng=Math.min(e.minLng,Ce),e.maxLng=Math.max(e.maxLng,Ce),e.minLat=Math.min(e.minLat,ne),e.maxLat=Math.max(e.maxLat,ne),r=!0},h=Te=>{var Ce,ne;(ne=(Ce=Te==null?void 0:Te.geometry)==null?void 0:Ce.coordinates)!=null&&ne[0]&&Te.geometry.coordinates[0].forEach(([ae,q])=>{e.minLng=Math.min(e.minLng,ae),e.maxLng=Math.max(e.maxLng,ae),e.minLat=Math.min(e.minLat,q),e.maxLat=Math.max(e.maxLat,q),r=!0})},x=Te=>{var Ce;(Ce=Te==null?void 0:Te.geometry)!=null&&Ce.coordinates&&Te.geometry.coordinates.forEach(([ne,ae])=>{e.minLng=Math.min(e.minLng,ne),e.maxLng=Math.max(e.maxLng,ne),e.minLat=Math.min(e.minLat,ae),e.maxLat=Math.max(e.maxLat,ae),r=!0})},w=t==null?void 0:t.mapData;return!w||(c((o=w.siteSurvey)==null?void 0:o.siteLocation),h((C=w.siteSurvey)==null?void 0:C.operationsBoundary),(F=(R=w.siteSurvey)==null?void 0:R.obstacles)==null||F.forEach(c),c(($=w.flightPlan)==null?void 0:$.launchPoint),c((Y=w.flightPlan)==null?void 0:Y.recoveryPoint),c((H=w.flightPlan)==null?void 0:H.pilotPosition),h((X=w.flightPlan)==null?void 0:X.flightGeography),h((he=w.flightPlan)==null?void 0:he.contingencyVolume),h((se=w.flightPlan)==null?void 0:se.groundRiskBuffer),(K=(de=w.emergency)==null?void 0:de.musterPoints)==null||K.forEach(c),(Ae=(ge=w.emergency)==null?void 0:ge.evacuationRoutes)==null||Ae.forEach(x),!r)?null:[[e.minLng,e.minLat],[e.maxLng,e.maxLat]]},fre=t=>{if(!Array.isArray(t)||t.length===0)return null;const e={minLng:1/0,maxLng:-1/0,minLat:1/0,maxLat:-1/0};let r=!1;return t.forEach(c=>{const h=z6(c);h&&(e.minLng=Math.min(e.minLng,h[0][0]),e.maxLng=Math.max(e.maxLng,h[1][0]),e.minLat=Math.min(e.minLat,h[0][1]),e.maxLat=Math.max(e.maxLat,h[1][1]),r=!0)}),r?[[e.minLng,e.minLat],[e.maxLng,e.maxLat]]:null},gre=(t,e)=>{const c=t.lat*Math.PI/180,h=e.lat*Math.PI/180,x=(e.lat-t.lat)*Math.PI/180,w=(e.lng-t.lng)*Math.PI/180,o=Math.sin(x/2)*Math.sin(x/2)+Math.cos(c)*Math.cos(h)*Math.sin(w/2)*Math.sin(w/2);return 6371e3*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))},Rj=t=>{var h,x;if(!((x=(h=t==null?void 0:t.geometry)==null?void 0:h.coordinates)!=null&&x[0]))return null;const e=t.geometry.coordinates[0];if(e.length<3)return null;const r=6371e3;let c=0;for(let w=0;w<e.length-1;w++){const[o,C]=e[w],[R,F]=e[w+1],$=C*Math.PI/180,Y=F*Math.PI/180,H=(R-o)*Math.PI/180;c+=H*(2+Math.sin($)+Math.sin(Y))}return c=Math.abs(c*r*r/2),c},B6=t=>{var r,c,h,x,w,o,C,R,F,$,Y;const e=[];return(c=(r=t==null?void 0:t.mapData)==null?void 0:r.siteSurvey)!=null&&c.siteLocation||e.push({section:"siteSurvey",field:"siteLocation",message:"Site location not set"}),(x=(h=t==null?void 0:t.siteSurvey)==null?void 0:h.population)!=null&&x.category||e.push({section:"siteSurvey",field:"population",message:"Population category not assessed"}),(o=(w=t==null?void 0:t.mapData)==null?void 0:w.flightPlan)!=null&&o.launchPoint||e.push({section:"flightPlan",field:"launchPoint",message:"Launch point not set"}),(R=(C=t==null?void 0:t.mapData)==null?void 0:C.flightPlan)!=null&&R.recoveryPoint||e.push({section:"flightPlan",field:"recoveryPoint",message:"Recovery point not set"}),(Y=($=(F=t==null?void 0:t.mapData)==null?void 0:F.emergency)==null?void 0:$.musterPoints)!=null&&Y.length||e.push({section:"emergency",field:"musterPoints",message:"No muster points defined"}),{isComplete:e.length===0,issues:e,completeness:{siteSurvey:!e.some(H=>H.section==="siteSurvey"),flightPlan:!e.some(H=>H.section==="flightPlan"),emergency:!e.some(H=>H.section==="emergency")}}},V6=t=>{var r,c,h,x,w,o,C,R,F,$,Y,H,X;const e=(t==null?void 0:t.mapData)||{};return{hasLocation:!!((r=e.siteSurvey)!=null&&r.siteLocation),hasBoundary:!!((c=e.siteSurvey)!=null&&c.operationsBoundary),obstacleCount:((x=(h=e.siteSurvey)==null?void 0:h.obstacles)==null?void 0:x.length)||0,hasLaunchPoint:!!((w=e.flightPlan)!=null&&w.launchPoint),hasRecoveryPoint:!!((o=e.flightPlan)!=null&&o.recoveryPoint),hasPilotPosition:!!((C=e.flightPlan)!=null&&C.pilotPosition),hasFlightGeography:!!((R=e.flightPlan)!=null&&R.flightGeography),musterPointCount:(($=(F=e.emergency)==null?void 0:F.musterPoints)==null?void 0:$.length)||0,evacuationRouteCount:((H=(Y=e.emergency)==null?void 0:Y.evacuationRoutes)==null?void 0:H.length)||0,boundaryArea:(X=e.siteSurvey)!=null&&X.operationsBoundary?Rj(e.siteSurvey.operationsBoundary):null}},ib="2.0.0",U6=t=>{var h,x,w;if(!t)return!1;if(Array.isArray(t.sites)&&t.sites.length>0){const o=t.sites[0];if(o!=null&&o.mapData&&(o==null?void 0:o.siteSurvey)!==void 0)return!1}const e=t.siteSurvey&&(t.siteSurvey.location||t.siteSurvey.population||((h=t.siteSurvey.obstacles)==null?void 0:h.length)>0),r=t.flightPlan&&(t.flightPlan.launchRecovery||t.flightPlan.operationType),c=t.emergencyPlan&&(((x=t.emergencyPlan.musterPoints)==null?void 0:x.length)>0||((w=t.emergencyPlan.evacuationRoutes)==null?void 0:w.length)>0);return e||r||c},yre=t=>{var e,r,c,h,x,w;if(!t)return{status:"invalid",message:"No project data"};if(Array.isArray(t.sites)&&t.sites.length>0){const o=t.sites[0];if(o!=null&&o.mapData)return{status:"current",message:"Project uses multi-site structure",version:t.projectVersion||ib,siteCount:t.sites.length}}return U6(t)?{status:"needs_migration",message:"Project has legacy single-site data that can be migrated",hasLegacyData:{siteSurvey:!!((e=t.siteSurvey)!=null&&e.location)||!!((c=(r=t.siteSurvey)==null?void 0:r.population)!=null&&c.category),flightPlan:!!((h=t.flightPlan)!=null&&h.operationType),emergency:((w=(x=t.emergencyPlan)==null?void 0:x.musterPoints)==null?void 0:w.length)>0}}:{status:"new",message:"New project without site data"}},Dd=t=>{var c;if(!t)return null;let e,r;if(t.lat!==void 0&&t.lng!==void 0)r=parseFloat(t.lat),e=parseFloat(t.lng);else if(t.latitude!==void 0&&t.longitude!==void 0)r=parseFloat(t.latitude),e=parseFloat(t.longitude);else if(((c=t.coordinates)==null?void 0:c.lat)!==void 0)r=parseFloat(t.coordinates.lat),e=parseFloat(t.coordinates.lng);else if(Array.isArray(t)&&t.length>=2)e=parseFloat(t[0]),r=parseFloat(t[1]);else if(typeof t=="string"&&t.includes(",")){const h=t.split(",").map(x=>parseFloat(x.trim()));h.length>=2&&!isNaN(h[0])&&!isNaN(h[1])&&(r=h[0],e=h[1])}return isNaN(r)||isNaN(e)?null:{lng:e,lat:r}},ev=t=>{var e;if(!t||!Array.isArray(t))return null;if(Array.isArray(t[0])&&t[0].length===2){const r=t[0],c=t[t.length-1];return(r[0]!==c[0]||r[1]!==c[1])&&(t=[...t,r]),t}if(((e=t[0])==null?void 0:e.lat)!==void 0){const r=t.map(x=>[parseFloat(x.lng||x.longitude),parseFloat(x.lat||x.latitude)]),c=r[0],h=r[r.length-1];return(c[0]!==h[0]||c[1]!==h[1])&&r.push([...c]),r}return null},xre=(t,e)=>{const r=tx(),c=ST();if(!t)return{mapData:r,surveyData:c};const h=t.location;if(h){const x=Dd(h);x&&(r.siteSurvey.siteLocation=rp(x.lng,x.lat,{elementType:"siteLocation",label:e,description:h.address||h.description||"",...In.siteLocation})),c.locationName=h.name||"",c.address=h.address||h.description||"",c.accessInstructions=h.accessInstructions||""}if(t.boundary){const x=ev(t.boundary);x&&(r.siteSurvey.operationsBoundary=jj(x,{elementType:"operationsBoundary",label:"Operations Boundary",...In.operationsBoundary}))}return Array.isArray(t.obstacles)&&(r.siteSurvey.obstacles=t.obstacles.map(x=>{let w=null;return x.location?w=Dd(x.location):x.lat!==void 0&&x.lng!==void 0?w={lat:x.lat,lng:x.lng}:x.coordinates&&(w=Dd(x.coordinates)),w?O6(w.lng,w.lat,{obstacleType:x.type||"other",height:x.height||null,label:x.type||"Obstacle",description:x.description||x.notes||"",notes:x.notes||""}):null}).filter(Boolean)),t.airspace&&(c.airspace={...c.airspace,classification:t.airspace.classification||"G",restrictions:t.airspace.restrictions||[],nearestAerodrome:t.airspace.nearestAerodrome||"",aerodromeDistance:t.airspace.aerodromeDistance||null}),t.population&&(c.population={category:t.population.category||null,adjacentCategory:t.population.adjacentCategory||null,density:t.population.density||null,justification:t.population.justification||"",assessmentDate:t.population.assessmentDate||null}),t.surroundings&&(c.surroundings={...c.surroundings,...t.surroundings}),t.access&&(c.access={...c.access,vehicleAccess:t.access.vehicleAccess??!0,parkingAvailable:t.access.parkingAvailable??!0,permissionsRequired:t.access.permissionsRequired||[],accessNotes:t.access.accessNotes||""}),c.photos=t.photos||[],c.notes=t.notes||"",c.surveyDate=t.surveyDate||null,c.surveyedBy=t.surveyedBy||null,{mapData:r,surveyData:c}},_re=(t,e)=>{const r=e||tx(),c=TT();if(!t)return{mapData:r,flightPlanData:c};if(t.launchRecovery){const h=t.launchRecovery;if(h.launchPoint){const x=Dd(h.launchPoint);x&&(r.flightPlan.launchPoint=rp(x.lng,x.lat,{elementType:"launchPoint",label:"Launch Point",description:h.launchPoint.description||"",...In.launchPoint}))}if(h.recoveryPoint){const x=Dd(h.recoveryPoint);x&&(r.flightPlan.recoveryPoint=rp(x.lng,x.lat,{elementType:"recoveryPoint",label:"Recovery Point",description:h.recoveryPoint.description||"",...In.recoveryPoint}))}}if(t.launchPoint){const h=Dd(t.launchPoint);h&&!r.flightPlan.launchPoint&&(r.flightPlan.launchPoint=rp(h.lng,h.lat,{elementType:"launchPoint",label:"Launch Point",...In.launchPoint}))}if(t.recoveryPoint){const h=Dd(t.recoveryPoint);h&&!r.flightPlan.recoveryPoint&&(r.flightPlan.recoveryPoint=rp(h.lng,h.lat,{elementType:"recoveryPoint",label:"Recovery Point",...In.recoveryPoint}))}if(t.flightGeography||t.flightBoundary){const h=ev(t.flightGeography||t.flightBoundary);h&&(r.flightPlan.flightGeography=jj(h,{elementType:"flightGeography",label:"Flight Geography",...In.flightGeography}))}return c.operationType=t.operationType||"VLOS",c.maxAltitudeAGL=t.maxAltitudeAGL||120,c.maxDistanceFromPilot=t.maxDistanceFromPilot||null,{mapData:r,flightPlanData:c}},vre=(t,e)=>{var h,x;const r=e||tx(),c=NT();return t?(Array.isArray(t.musterPoints)&&(r.emergency.musterPoints=t.musterPoints.map((w,o)=>{let C=null;return w.location?C=Dd(w.location):w.lat!==void 0&&w.lng!==void 0?C={lat:w.lat,lng:w.lng}:w.coordinates&&(C=Dd(w.coordinates)),C?L6(C.lng,C.lat,{isPrimary:o===0||w.isPrimary||!1,label:w.name||w.label||`Muster Point ${o+1}`,description:w.description||"",notes:w.notes||""}):null}).filter(Boolean)),Array.isArray(t.evacuationRoutes)&&(r.emergency.evacuationRoutes=t.evacuationRoutes.map((w,o)=>{let C=null;return w.path?C=ev(w.path):w.coordinates?C=ev(w.coordinates):Array.isArray(w)&&w.length>0&&(C=ev(w)),!C||C.length<2?null:(C[0][0]===C[C.length-1][0]&&C[0][1]===C[C.length-1][1]&&(C=C.slice(0,-1)),F6(C,{isPrimary:o===0||w.isPrimary||!1,label:w.name||w.label||`Evacuation Route ${o+1}`,description:w.description||"",notes:w.notes||""}))}).filter(Boolean)),t.hospital&&(c.nearestHospital={name:t.hospital.name||"",address:t.hospital.address||"",distance:t.hospital.distance||null,estimatedTime:t.hospital.estimatedTime||null,phone:t.hospital.phone||""}),c.siteEvacuationProcedure=((h=t.procedures)==null?void 0:h.evacuation)||"",c.flyAwayProcedure=((x=t.procedures)==null?void 0:x.flyAway)||"",c.localEmergencyNotes=t.notes||"",{mapData:r,emergencyData:c}):{mapData:r,emergencyData:c}},bre=(t,e,r)=>{const c=AT();return e!=null&&e.population&&(c.populationCategory=e.population.category,c.adjacentPopulation=e.population.adjacentCategory),r&&(c.operationType=r.operationType||"VLOS",c.maxAltitudeAGL=r.maxAltitudeAGL||120),t&&(c.uaCharacteristic=t.uaCharacteristic||null,c.iGRC=t.iGRC||null,c.fGRC=t.fGRC||null,c.initialARC=t.initialARC||null,c.residualARC=t.residualARC||null,c.sail=t.sail||null,t.mitigations&&(c.mitigationOverrides=t.mitigations)),c},wre=(t,e={})=>{var H,X,he,se,de,K,ge,Ae,Te;if(!t)throw new Error("No project provided for migration");if(yre(t).status==="current")return t;const c=JSON.parse(JSON.stringify(t)),h=e.siteName||((X=(H=t.siteSurvey)==null?void 0:H.location)==null?void 0:X.name)||t.name||"Primary Site",{mapData:x,surveyData:w}=xre(t.siteSurvey,h),{mapData:o,flightPlanData:C}=_re(t.flightPlan,x),{mapData:R,emergencyData:F}=vre(t.emergencyPlan,o),$=bre(t.soraAssessment,w,C),Y={id:`site_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:h,description:t.description||"",status:"draft",order:0,mapData:R,siteSurvey:w,flightPlan:C,emergency:F,soraAssessment:$,createdAt:t.createdAt||new Date().toISOString(),updatedAt:new Date().toISOString(),createdBy:null,migratedFromLegacy:!0};return c.sites=[Y],c.projectVersion=ib,c.migratedAt=new Date().toISOString(),c._legacyData={siteSurvey:t.siteSurvey,flightPlan:t.flightPlan,emergencyPlan:t.emergencyPlan,soraAssessment:t.soraAssessment},c.flightPlan={aircraft:((he=t.flightPlan)==null?void 0:he.aircraft)||[],weatherMinimums:((se=t.flightPlan)==null?void 0:se.weatherMinimums)||{minVisibility:3,minCeiling:500,maxWind:10,maxGust:15,precipitation:!1,notes:""},contingencies:((de=t.flightPlan)==null?void 0:de.contingencies)||[],additionalProcedures:((K=t.flightPlan)==null?void 0:K.additionalProcedures)||""},c.emergencyPlan={contacts:((ge=t.emergencyPlan)==null?void 0:ge.contacts)||[{type:"emergency",name:"Local Emergency",phone:"911",notes:""},{type:"fic",name:"FIC Edmonton",phone:"1-866-541-4102",notes:"For fly-away reporting"}],firstAid:((Ae=t.emergencyPlan)==null?void 0:Ae.firstAid)||null,procedures:((Te=t.emergencyPlan)==null?void 0:Te.procedures)||{}},c.siteSurvey=null,c.soraAssessment=null,c},mI="__COORDS__:";function Sre(t){if(!Array.isArray(t)||t.length===0)return!1;const e=t[0];return!!(Array.isArray(e)&&e.length>=2&&typeof e[0]=="number"&&typeof e[1]=="number")}function bS(t){if(t==null||typeof t!="object")return t;if(Array.isArray(t))return Sre(t)?mI+JSON.stringify(t):t.map(r=>bS(r));const e={};for(const r of Object.keys(t))e[r]=bS(t[r]);return e}function wS(t){if(t==null)return t;if(typeof t=="string"&&t.startsWith(mI))try{return JSON.parse(t.slice(mI.length))}catch{return console.warn("Failed to parse coordinates:",t),t}if(typeof t!="object")return t;if(Array.isArray(t))return t.map(r=>wS(r));const e={};for(const r of Object.keys(t))e[r]=wS(t[r]);return e}const q6=Mp(rn,"projects");async function ET(t={}){let e=is(q6,pa("createdAt","desc"));return t.status&&(e=is(e,ha("status","==",t.status))),t.limit&&(e=is(e,Qy(t.limit))),(await Kd(e)).docs.map(c=>{const h=wS(c.data());return{id:c.id,...h}})}async function $6(t){const e=qn(rn,"projects",t),r=await Ap(e);if(!r.exists())throw new Error("Project not found");const c=wS(r.data());return{id:r.id,...c}}const Tre=()=>{const t={};return["OSO-01","OSO-02","OSO-03","OSO-04","OSO-05","OSO-06","OSO-07","OSO-08","OSO-09","OSO-10","OSO-11","OSO-12","OSO-13","OSO-14","OSO-15","OSO-16","OSO-17","OSO-18","OSO-19","OSO-20","OSO-21","OSO-22","OSO-23","OSO-24"].forEach(r=>{t[r]={robustness:"none",evidence:""}}),t},G6=()=>({aircraft:[],operationType:"VLOS",maxAltitudeAGL:120,flightAreaType:"uncontrolled",groundType:"sparsely_populated",overPeople:!1,nearAerodrome:!1,aerodromeDistance:null,weatherMinimums:{minVisibility:3,minCeiling:500,maxWind:10,maxGust:15,precipitation:!1,notes:""},contingencies:[{trigger:"Loss of C2 Link",action:"Return to Home (RTH) automatically engages. If no RTH within 30 seconds, land in place.",priority:"high"},{trigger:"Low Battery Warning",action:"Immediately return to launch point. Land with minimum 20% remaining.",priority:"high"},{trigger:"GPS Loss",action:"Switch to ATTI mode, maintain visual contact, manual return and land.",priority:"high"},{trigger:"Fly-Away",action:"Attempt to regain control. If unsuccessful, contact FIC Edmonton (1-866-541-4102) immediately.",priority:"critical"},{trigger:"Deteriorating Weather",action:'Land immediately if conditions fall below minimums. Do not attempt to "push through."',priority:"medium"},{trigger:"Aircraft in Vicinity",action:"Descend and hold position or land. Give way to all manned aircraft.",priority:"high"}],additionalProcedures:""}),H6=()=>({hazards:[],overallRiskAcceptable:null,reviewNotes:"",reviewedBy:"",reviewDate:"",approvedBy:"",approvalDate:""});async function W6(t){const e=CT({name:t.siteName||"Primary Site",description:"",order:0}),r={...t,status:"draft",projectVersion:ib,sections:{siteSurvey:!1,flightPlan:!1},crew:[],sites:[e],activeSiteId:e.id,flightPlan:{aircraft:[],weatherMinimums:{minVisibility:3,minCeiling:500,maxWind:10,maxGust:15,precipitation:!1,notes:""},contingencies:G6().contingencies,additionalProcedures:""},hseRiskAssessment:H6(),soraDefaults:{uaCharacteristic:"1m_25ms",mitigations:{M1A:{enabled:!1,robustness:"none",evidence:""},M1B:{enabled:!1,robustness:"none",evidence:""},M1C:{enabled:!1,robustness:"none",evidence:""},M2:{enabled:!1,robustness:"none",evidence:""}},initialARC:"ARC-b",tmpr:{enabled:!0,type:"VLOS",robustness:"low",evidence:""},containment:{method:"",robustness:"none",evidence:""},osoCompliance:Tre()},emergencyPlan:{contacts:[{type:"emergency",name:"Local Emergency",phone:"911",notes:""},{type:"fic",name:"FIC Edmonton",phone:"1-866-541-4102",notes:"For fly-away reporting"}],firstAid:null,procedures:{}},ppe:{required:[{item:"High-Visibility Vest",specification:"ANSI Type R Class 2",notes:""},{item:"Sun Protection",specification:"Sunscreen, hat",notes:""},{item:"First Aid Kit",specification:"As per assessment",notes:""},{item:"Communication Device",specification:"Radio/cell phone",notes:""}],siteSpecific:"",notes:""},communications:{primaryMethod:"cell",backupMethod:"radio",radioChannels:[],checkInFrequency:"",checkInProcedure:"",emergencyStopWord:"STOP STOP STOP",aeronauticalRadioRequired:!1},approvals:{preparedBy:null,preparedDate:null,reviewedBy:null,reviewedDate:null,approvedBy:null,approvedDate:null,crewAcknowledgments:[]},tailgate:null,siteSurvey:null,soraAssessment:null,riskAssessment:null,createdAt:Pn(),updatedAt:Pn()},c=bS(r);return{id:(await ex(q6,c)).id,...r}}async function Z6(t,e){const r=qn(rn,"projects",t),c=bS(e);await Gl(r,{...c,updatedAt:Pn()})}async function kj(t){const e=qn(rn,"projects",t);await Jy(e)}const X6=Mp(rn,"clients");async function ix(){const t=is(X6,pa("name","asc"));return(await Kd(t)).docs.map(r=>({id:r.id,...r.data()}))}async function Dj(t){const e={...t,createdAt:Pn(),updatedAt:Pn()};return{id:(await ex(X6,e)).id,...e}}async function Y6(t,e){const r=qn(rn,"clients",t);await Gl(r,{...e,updatedAt:Pn()})}async function K6(t){const e=qn(rn,"clients",t);await Jy(e)}const Q6=Mp(rn,"operators");async function rx(){const t=is(Q6,pa("lastName","asc"));return(await Kd(t)).docs.map(r=>({id:r.id,...r.data()}))}async function J6(t){const e={...t,status:"active",createdAt:Pn(),updatedAt:Pn()};return{id:(await ex(Q6,e)).id,...e}}async function Mj(t,e){const r=qn(rn,"operators",t);await Gl(r,{...e,updatedAt:Pn()})}async function eU(t){const e=qn(rn,"operators",t);await Jy(e)}const tU=Mp(rn,"aircraft");async function IT(){const t=is(tU,pa("nickname","asc"));return(await Kd(t)).docs.map(r=>({id:r.id,...r.data()}))}async function iU(t){const e={...t,status:"airworthy",createdAt:Pn(),updatedAt:Pn()};return{id:(await ex(tU,e)).id,...e}}async function rU(t,e){const r=qn(rn,"aircraft",t);await Gl(r,{...e,updatedAt:Pn()})}async function nU(t){const e=qn(rn,"aircraft",t);await Jy(e)}const Nre=Mp(rn,"forms");async function sU(t={}){let e=is(Nre,pa("createdAt","desc"));return t.projectId&&(e=is(e,ha("projectId","==",t.projectId))),t.type&&(e=is(e,ha("type","==",t.type))),t.limit&&(e=is(e,Qy(t.limit))),(await Kd(e)).docs.map(c=>({id:c.id,...c.data()}))}function aU(t){if(!t)return t;if(U6(t))return wre(t);if(Array.isArray(t.sites)&&t.sites.length>0)return d3(t);if(!(t.hseRiskAssessment&&t.soraAssessment)&&t.riskAssessment){const r=t.riskAssessment||{};r.sora;const h={hazards:(r.hazards||[]).map(x=>({id:x.id||Date.now().toString(),category:x.category||"environmental",description:x.description||"",likelihood:x.likelihood||3,severity:x.severity||3,controlType:x.controlType||"administrative",controls:x.controls||"",residualLikelihood:x.residualLikelihood||2,residualSeverity:x.residualSeverity||2,responsible:x.responsible||"",verification:x.verification||""})),overallRiskAcceptable:r.overallRiskAcceptable||null,reviewNotes:r.reviewNotes||"",reviewedBy:r.reviewedBy||"",reviewDate:r.reviewDate||"",approvedBy:"",approvalDate:""};t.hseRiskAssessment=h,t.riskAssessment=null}if(!Array.isArray(t.sites)||t.sites.length===0){const r=CT({name:"Primary Site",order:0});t.sites=[r],t.activeSiteId=r.id,t.projectVersion=ib}return d3(t)}function d3(t){return Array.isArray(t.sites)||(t.sites=[]),!t.activeSiteId&&t.sites.length>0&&(t.activeSiteId=t.sites[0].id),t.sites=t.sites.map(e=>({...e,mapData:e.mapData||tx(),siteSurvey:e.siteSurvey||ST(),flightPlan:e.flightPlan||TT(),emergency:e.emergency||NT(),soraAssessment:e.soraAssessment||AT()})),t.flightPlan||(t.flightPlan=G6()),t.hseRiskAssessment||(t.hseRiskAssessment=H6()),t.emergencyPlan||(t.emergencyPlan={contacts:[{type:"emergency",name:"Local Emergency",phone:"911",notes:""},{type:"fic",name:"FIC Edmonton",phone:"1-866-541-4102",notes:"For fly-away reporting"}],firstAid:null,procedures:{}}),t}const Are=Object.freeze(Object.defineProperty({__proto__:null,CURRENT_PROJECT_VERSION:ib,createAircraft:iU,createClient:Dj,createDefaultSite:CT,createOperator:J6,createProject:W6,deleteAircraft:nU,deleteClient:K6,deleteOperator:eU,deleteProject:kj,getAircraft:IT,getClients:ix,getDefaultSiteEmergencyData:NT,getDefaultSiteFlightPlanData:TT,getDefaultSiteMapData:tx,getDefaultSiteSoraData:AT,getDefaultSiteSurveyData:ST,getForms:sU,getOperators:rx,getProject:$6,getProjects:ET,migrateProjectToDecoupledStructure:aU,updateAircraft:rU,updateClient:Y6,updateOperator:Mj,updateProject:Z6},Symbol.toStringTag,{value:"Module"}));function Lo(t){const e=Object.prototype.toString.call(t);return t instanceof Date||typeof t=="object"&&e==="[object Date]"?new t.constructor(+t):typeof t=="number"||e==="[object Number]"||typeof t=="string"||e==="[object String]"?new Date(t):new Date(NaN)}function Wd(t,e){return t instanceof Date?new t.constructor(e):new Date(e)}function h3(t,e){const r=Lo(t);return isNaN(e)?Wd(t,NaN):(r.setDate(r.getDate()+e),r)}const oU=6048e5,Cre=864e5;let Ere={};function PT(){return Ere}function df(t,e){var o,C,R,F;const r=PT(),c=(e==null?void 0:e.weekStartsOn)??((C=(o=e==null?void 0:e.locale)==null?void 0:o.options)==null?void 0:C.weekStartsOn)??r.weekStartsOn??((F=(R=r.locale)==null?void 0:R.options)==null?void 0:F.weekStartsOn)??0,h=Lo(t),x=h.getDay(),w=(x<c?7:0)+x-c;return h.setDate(h.getDate()-w),h.setHours(0,0,0,0),h}function SS(t){return df(t,{weekStartsOn:1})}function lU(t){const e=Lo(t),r=e.getFullYear(),c=Wd(t,0);c.setFullYear(r+1,0,4),c.setHours(0,0,0,0);const h=SS(c),x=Wd(t,0);x.setFullYear(r,0,4),x.setHours(0,0,0,0);const w=SS(x);return e.getTime()>=h.getTime()?r+1:e.getTime()>=w.getTime()?r:r-1}function TS(t){const e=Lo(t);return e.setHours(0,0,0,0),e}function p3(t){const e=Lo(t),r=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds()));return r.setUTCFullYear(e.getFullYear()),+t-+r}function cU(t,e){const r=TS(t),c=TS(e),h=+r-p3(r),x=+c-p3(c);return Math.round((h-x)/Cre)}function Ire(t){const e=lU(t),r=Wd(t,0);return r.setFullYear(e,0,4),r.setHours(0,0,0,0),SS(r)}function uU(t){return Wd(t,Date.now())}function Pre(t,e){const r=TS(t),c=TS(e);return+r==+c}function jre(t){return t instanceof Date||typeof t=="object"&&Object.prototype.toString.call(t)==="[object Date]"}function Rre(t){if(!jre(t)&&typeof t!="number")return!1;const e=Lo(t);return!isNaN(Number(e))}function jT(t,e){const r=Lo(t),c=Lo(e),h=m3(r,c),x=Math.abs(cU(r,c));r.setDate(r.getDate()-h*x);const w=+(m3(r,c)===-h),o=h*(x-w);return o===0?0:o}function m3(t,e){const r=t.getFullYear()-e.getFullYear()||t.getMonth()-e.getMonth()||t.getDate()-e.getDate()||t.getHours()-e.getHours()||t.getMinutes()-e.getMinutes()||t.getSeconds()-e.getSeconds()||t.getMilliseconds()-e.getMilliseconds();return r<0?-1:r>0?1:r}function kre(t){const e=Lo(t),r=Wd(t,0);return r.setFullYear(e.getFullYear(),0,1),r.setHours(0,0,0,0),r}const Dre={lessThanXSeconds:{one:"less than a second",other:"less than {{count}} seconds"},xSeconds:{one:"1 second",other:"{{count}} seconds"},halfAMinute:"half a minute",lessThanXMinutes:{one:"less than a minute",other:"less than {{count}} minutes"},xMinutes:{one:"1 minute",other:"{{count}} minutes"},aboutXHours:{one:"about 1 hour",other:"about {{count}} hours"},xHours:{one:"1 hour",other:"{{count}} hours"},xDays:{one:"1 day",other:"{{count}} days"},aboutXWeeks:{one:"about 1 week",other:"about {{count}} weeks"},xWeeks:{one:"1 week",other:"{{count}} weeks"},aboutXMonths:{one:"about 1 month",other:"about {{count}} months"},xMonths:{one:"1 month",other:"{{count}} months"},aboutXYears:{one:"about 1 year",other:"about {{count}} years"},xYears:{one:"1 year",other:"{{count}} years"},overXYears:{one:"over 1 year",other:"over {{count}} years"},almostXYears:{one:"almost 1 year",other:"almost {{count}} years"}},Mre=(t,e,r)=>{let c;const h=Dre[t];return typeof h=="string"?c=h:e===1?c=h.one:c=h.other.replace("{{count}}",e.toString()),r!=null&&r.addSuffix?r.comparison&&r.comparison>0?"in "+c:c+" ago":c};function DC(t){return(e={})=>{const r=e.width?String(e.width):t.defaultWidth;return t.formats[r]||t.formats[t.defaultWidth]}}const Ore={full:"EEEE, MMMM do, y",long:"MMMM do, y",medium:"MMM d, y",short:"MM/dd/yyyy"},Lre={full:"h:mm:ss a zzzz",long:"h:mm:ss a z",medium:"h:mm:ss a",short:"h:mm a"},Fre={full:"{{date}} 'at' {{time}}",long:"{{date}} 'at' {{time}}",medium:"{{date}}, {{time}}",short:"{{date}}, {{time}}"},zre={date:DC({formats:Ore,defaultWidth:"full"}),time:DC({formats:Lre,defaultWidth:"full"}),dateTime:DC({formats:Fre,defaultWidth:"full"})},Bre={lastWeek:"'last' eeee 'at' p",yesterday:"'yesterday at' p",today:"'today at' p",tomorrow:"'tomorrow at' p",nextWeek:"eeee 'at' p",other:"P"},Vre=(t,e,r,c)=>Bre[t];function _0(t){return(e,r)=>{const c=r!=null&&r.context?String(r.context):"standalone";let h;if(c==="formatting"&&t.formattingValues){const w=t.defaultFormattingWidth||t.defaultWidth,o=r!=null&&r.width?String(r.width):w;h=t.formattingValues[o]||t.formattingValues[w]}else{const w=t.defaultWidth,o=r!=null&&r.width?String(r.width):t.defaultWidth;h=t.values[o]||t.values[w]}const x=t.argumentCallback?t.argumentCallback(e):e;return h[x]}}const Ure={narrow:["B","A"],abbreviated:["BC","AD"],wide:["Before Christ","Anno Domini"]},qre={narrow:["1","2","3","4"],abbreviated:["Q1","Q2","Q3","Q4"],wide:["1st quarter","2nd quarter","3rd quarter","4th quarter"]},$re={narrow:["J","F","M","A","M","J","J","A","S","O","N","D"],abbreviated:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],wide:["January","February","March","April","May","June","July","August","September","October","November","December"]},Gre={narrow:["S","M","T","W","T","F","S"],short:["Su","Mo","Tu","We","Th","Fr","Sa"],abbreviated:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],wide:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},Hre={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"}},Wre={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"}},Zre=(t,e)=>{const r=Number(t),c=r%100;if(c>20||c<10)switch(c%10){case 1:return r+"st";case 2:return r+"nd";case 3:return r+"rd"}return r+"th"},Xre={ordinalNumber:Zre,era:_0({values:Ure,defaultWidth:"wide"}),quarter:_0({values:qre,defaultWidth:"wide",argumentCallback:t=>t-1}),month:_0({values:$re,defaultWidth:"wide"}),day:_0({values:Gre,defaultWidth:"wide"}),dayPeriod:_0({values:Hre,defaultWidth:"wide",formattingValues:Wre,defaultFormattingWidth:"wide"})};function v0(t){return(e,r={})=>{const c=r.width,h=c&&t.matchPatterns[c]||t.matchPatterns[t.defaultMatchWidth],x=e.match(h);if(!x)return null;const w=x[0],o=c&&t.parsePatterns[c]||t.parsePatterns[t.defaultParseWidth],C=Array.isArray(o)?Kre(o,$=>$.test(w)):Yre(o,$=>$.test(w));let R;R=t.valueCallback?t.valueCallback(C):C,R=r.valueCallback?r.valueCallback(R):R;const F=e.slice(w.length);return{value:R,rest:F}}}function Yre(t,e){for(const r in t)if(Object.prototype.hasOwnProperty.call(t,r)&&e(t[r]))return r}function Kre(t,e){for(let r=0;r<t.length;r++)if(e(t[r]))return r}function Qre(t){return(e,r={})=>{const c=e.match(t.matchPattern);if(!c)return null;const h=c[0],x=e.match(t.parsePattern);if(!x)return null;let w=t.valueCallback?t.valueCallback(x[0]):x[0];w=r.valueCallback?r.valueCallback(w):w;const o=e.slice(h.length);return{value:w,rest:o}}}const Jre=/^(\d+)(th|st|nd|rd)?/i,ene=/\d+/i,tne={narrow:/^(b|a)/i,abbreviated:/^(b\.?\s?c\.?|b\.?\s?c\.?\s?e\.?|a\.?\s?d\.?|c\.?\s?e\.?)/i,wide:/^(before christ|before common era|anno domini|common era)/i},ine={any:[/^b/i,/^(a|c)/i]},rne={narrow:/^[1234]/i,abbreviated:/^q[1234]/i,wide:/^[1234](th|st|nd|rd)? quarter/i},nne={any:[/1/i,/2/i,/3/i,/4/i]},sne={narrow:/^[jfmasond]/i,abbreviated:/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i,wide:/^(january|february|march|april|may|june|july|august|september|october|november|december)/i},ane={narrow:[/^j/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^ja/i,/^f/i,/^mar/i,/^ap/i,/^may/i,/^jun/i,/^jul/i,/^au/i,/^s/i,/^o/i,/^n/i,/^d/i]},one={narrow:/^[smtwf]/i,short:/^(su|mo|tu|we|th|fr|sa)/i,abbreviated:/^(sun|mon|tue|wed|thu|fri|sat)/i,wide:/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)/i},lne={narrow:[/^s/i,/^m/i,/^t/i,/^w/i,/^t/i,/^f/i,/^s/i],any:[/^su/i,/^m/i,/^tu/i,/^w/i,/^th/i,/^f/i,/^sa/i]},cne={narrow:/^(a|p|mi|n|(in the|at) (morning|afternoon|evening|night))/i,any:/^([ap]\.?\s?m\.?|midnight|noon|(in the|at) (morning|afternoon|evening|night))/i},une={any:{am:/^a/i,pm:/^p/i,midnight:/^mi/i,noon:/^no/i,morning:/morning/i,afternoon:/afternoon/i,evening:/evening/i,night:/night/i}},dne={ordinalNumber:Qre({matchPattern:Jre,parsePattern:ene,valueCallback:t=>parseInt(t,10)}),era:v0({matchPatterns:tne,defaultMatchWidth:"wide",parsePatterns:ine,defaultParseWidth:"any"}),quarter:v0({matchPatterns:rne,defaultMatchWidth:"wide",parsePatterns:nne,defaultParseWidth:"any",valueCallback:t=>t+1}),month:v0({matchPatterns:sne,defaultMatchWidth:"wide",parsePatterns:ane,defaultParseWidth:"any"}),day:v0({matchPatterns:one,defaultMatchWidth:"wide",parsePatterns:lne,defaultParseWidth:"any"}),dayPeriod:v0({matchPatterns:cne,defaultMatchWidth:"any",parsePatterns:une,defaultParseWidth:"any"})},hne={code:"en-US",formatDistance:Mre,formatLong:zre,formatRelative:Vre,localize:Xre,match:dne,options:{weekStartsOn:0,firstWeekContainsDate:1}};function pne(t){const e=Lo(t);return cU(e,kre(e))+1}function mne(t){const e=Lo(t),r=+SS(e)-+Ire(e);return Math.round(r/oU)+1}function dU(t,e){var F,$,Y,H;const r=Lo(t),c=r.getFullYear(),h=PT(),x=(e==null?void 0:e.firstWeekContainsDate)??(($=(F=e==null?void 0:e.locale)==null?void 0:F.options)==null?void 0:$.firstWeekContainsDate)??h.firstWeekContainsDate??((H=(Y=h.locale)==null?void 0:Y.options)==null?void 0:H.firstWeekContainsDate)??1,w=Wd(t,0);w.setFullYear(c+1,0,x),w.setHours(0,0,0,0);const o=df(w,e),C=Wd(t,0);C.setFullYear(c,0,x),C.setHours(0,0,0,0);const R=df(C,e);return r.getTime()>=o.getTime()?c+1:r.getTime()>=R.getTime()?c:c-1}function fne(t,e){var o,C,R,F;const r=PT(),c=(e==null?void 0:e.firstWeekContainsDate)??((C=(o=e==null?void 0:e.locale)==null?void 0:o.options)==null?void 0:C.firstWeekContainsDate)??r.firstWeekContainsDate??((F=(R=r.locale)==null?void 0:R.options)==null?void 0:F.firstWeekContainsDate)??1,h=dU(t,e),x=Wd(t,0);return x.setFullYear(h,0,c),x.setHours(0,0,0,0),df(x,e)}function gne(t,e){const r=Lo(t),c=+df(r,e)-+fne(r,e);return Math.round(c/oU)+1}function Kn(t,e){const r=t<0?"-":"",c=Math.abs(t).toString().padStart(e,"0");return r+c}const Fh={y(t,e){const r=t.getFullYear(),c=r>0?r:1-r;return Kn(e==="yy"?c%100:c,e.length)},M(t,e){const r=t.getMonth();return e==="M"?String(r+1):Kn(r+1,2)},d(t,e){return Kn(t.getDate(),e.length)},a(t,e){const r=t.getHours()/12>=1?"pm":"am";switch(e){case"a":case"aa":return r.toUpperCase();case"aaa":return r;case"aaaaa":return r[0];case"aaaa":default:return r==="am"?"a.m.":"p.m."}},h(t,e){return Kn(t.getHours()%12||12,e.length)},H(t,e){return Kn(t.getHours(),e.length)},m(t,e){return Kn(t.getMinutes(),e.length)},s(t,e){return Kn(t.getSeconds(),e.length)},S(t,e){const r=e.length,c=t.getMilliseconds(),h=Math.trunc(c*Math.pow(10,r-3));return Kn(h,e.length)}},qg={midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},f3={G:function(t,e,r){const c=t.getFullYear()>0?1:0;switch(e){case"G":case"GG":case"GGG":return r.era(c,{width:"abbreviated"});case"GGGGG":return r.era(c,{width:"narrow"});case"GGGG":default:return r.era(c,{width:"wide"})}},y:function(t,e,r){if(e==="yo"){const c=t.getFullYear(),h=c>0?c:1-c;return r.ordinalNumber(h,{unit:"year"})}return Fh.y(t,e)},Y:function(t,e,r,c){const h=dU(t,c),x=h>0?h:1-h;if(e==="YY"){const w=x%100;return Kn(w,2)}return e==="Yo"?r.ordinalNumber(x,{unit:"year"}):Kn(x,e.length)},R:function(t,e){const r=lU(t);return Kn(r,e.length)},u:function(t,e){const r=t.getFullYear();return Kn(r,e.length)},Q:function(t,e,r){const c=Math.ceil((t.getMonth()+1)/3);switch(e){case"Q":return String(c);case"QQ":return Kn(c,2);case"Qo":return r.ordinalNumber(c,{unit:"quarter"});case"QQQ":return r.quarter(c,{width:"abbreviated",context:"formatting"});case"QQQQQ":return r.quarter(c,{width:"narrow",context:"formatting"});case"QQQQ":default:return r.quarter(c,{width:"wide",context:"formatting"})}},q:function(t,e,r){const c=Math.ceil((t.getMonth()+1)/3);switch(e){case"q":return String(c);case"qq":return Kn(c,2);case"qo":return r.ordinalNumber(c,{unit:"quarter"});case"qqq":return r.quarter(c,{width:"abbreviated",context:"standalone"});case"qqqqq":return r.quarter(c,{width:"narrow",context:"standalone"});case"qqqq":default:return r.quarter(c,{width:"wide",context:"standalone"})}},M:function(t,e,r){const c=t.getMonth();switch(e){case"M":case"MM":return Fh.M(t,e);case"Mo":return r.ordinalNumber(c+1,{unit:"month"});case"MMM":return r.month(c,{width:"abbreviated",context:"formatting"});case"MMMMM":return r.month(c,{width:"narrow",context:"formatting"});case"MMMM":default:return r.month(c,{width:"wide",context:"formatting"})}},L:function(t,e,r){const c=t.getMonth();switch(e){case"L":return String(c+1);case"LL":return Kn(c+1,2);case"Lo":return r.ordinalNumber(c+1,{unit:"month"});case"LLL":return r.month(c,{width:"abbreviated",context:"standalone"});case"LLLLL":return r.month(c,{width:"narrow",context:"standalone"});case"LLLL":default:return r.month(c,{width:"wide",context:"standalone"})}},w:function(t,e,r,c){const h=gne(t,c);return e==="wo"?r.ordinalNumber(h,{unit:"week"}):Kn(h,e.length)},I:function(t,e,r){const c=mne(t);return e==="Io"?r.ordinalNumber(c,{unit:"week"}):Kn(c,e.length)},d:function(t,e,r){return e==="do"?r.ordinalNumber(t.getDate(),{unit:"date"}):Fh.d(t,e)},D:function(t,e,r){const c=pne(t);return e==="Do"?r.ordinalNumber(c,{unit:"dayOfYear"}):Kn(c,e.length)},E:function(t,e,r){const c=t.getDay();switch(e){case"E":case"EE":case"EEE":return r.day(c,{width:"abbreviated",context:"formatting"});case"EEEEE":return r.day(c,{width:"narrow",context:"formatting"});case"EEEEEE":return r.day(c,{width:"short",context:"formatting"});case"EEEE":default:return r.day(c,{width:"wide",context:"formatting"})}},e:function(t,e,r,c){const h=t.getDay(),x=(h-c.weekStartsOn+8)%7||7;switch(e){case"e":return String(x);case"ee":return Kn(x,2);case"eo":return r.ordinalNumber(x,{unit:"day"});case"eee":return r.day(h,{width:"abbreviated",context:"formatting"});case"eeeee":return r.day(h,{width:"narrow",context:"formatting"});case"eeeeee":return r.day(h,{width:"short",context:"formatting"});case"eeee":default:return r.day(h,{width:"wide",context:"formatting"})}},c:function(t,e,r,c){const h=t.getDay(),x=(h-c.weekStartsOn+8)%7||7;switch(e){case"c":return String(x);case"cc":return Kn(x,e.length);case"co":return r.ordinalNumber(x,{unit:"day"});case"ccc":return r.day(h,{width:"abbreviated",context:"standalone"});case"ccccc":return r.day(h,{width:"narrow",context:"standalone"});case"cccccc":return r.day(h,{width:"short",context:"standalone"});case"cccc":default:return r.day(h,{width:"wide",context:"standalone"})}},i:function(t,e,r){const c=t.getDay(),h=c===0?7:c;switch(e){case"i":return String(h);case"ii":return Kn(h,e.length);case"io":return r.ordinalNumber(h,{unit:"day"});case"iii":return r.day(c,{width:"abbreviated",context:"formatting"});case"iiiii":return r.day(c,{width:"narrow",context:"formatting"});case"iiiiii":return r.day(c,{width:"short",context:"formatting"});case"iiii":default:return r.day(c,{width:"wide",context:"formatting"})}},a:function(t,e,r){const h=t.getHours()/12>=1?"pm":"am";switch(e){case"a":case"aa":return r.dayPeriod(h,{width:"abbreviated",context:"formatting"});case"aaa":return r.dayPeriod(h,{width:"abbreviated",context:"formatting"}).toLowerCase();case"aaaaa":return r.dayPeriod(h,{width:"narrow",context:"formatting"});case"aaaa":default:return r.dayPeriod(h,{width:"wide",context:"formatting"})}},b:function(t,e,r){const c=t.getHours();let h;switch(c===12?h=qg.noon:c===0?h=qg.midnight:h=c/12>=1?"pm":"am",e){case"b":case"bb":return r.dayPeriod(h,{width:"abbreviated",context:"formatting"});case"bbb":return r.dayPeriod(h,{width:"abbreviated",context:"formatting"}).toLowerCase();case"bbbbb":return r.dayPeriod(h,{width:"narrow",context:"formatting"});case"bbbb":default:return r.dayPeriod(h,{width:"wide",context:"formatting"})}},B:function(t,e,r){const c=t.getHours();let h;switch(c>=17?h=qg.evening:c>=12?h=qg.afternoon:c>=4?h=qg.morning:h=qg.night,e){case"B":case"BB":case"BBB":return r.dayPeriod(h,{width:"abbreviated",context:"formatting"});case"BBBBB":return r.dayPeriod(h,{width:"narrow",context:"formatting"});case"BBBB":default:return r.dayPeriod(h,{width:"wide",context:"formatting"})}},h:function(t,e,r){if(e==="ho"){let c=t.getHours()%12;return c===0&&(c=12),r.ordinalNumber(c,{unit:"hour"})}return Fh.h(t,e)},H:function(t,e,r){return e==="Ho"?r.ordinalNumber(t.getHours(),{unit:"hour"}):Fh.H(t,e)},K:function(t,e,r){const c=t.getHours()%12;return e==="Ko"?r.ordinalNumber(c,{unit:"hour"}):Kn(c,e.length)},k:function(t,e,r){let c=t.getHours();return c===0&&(c=24),e==="ko"?r.ordinalNumber(c,{unit:"hour"}):Kn(c,e.length)},m:function(t,e,r){return e==="mo"?r.ordinalNumber(t.getMinutes(),{unit:"minute"}):Fh.m(t,e)},s:function(t,e,r){return e==="so"?r.ordinalNumber(t.getSeconds(),{unit:"second"}):Fh.s(t,e)},S:function(t,e){return Fh.S(t,e)},X:function(t,e,r){const c=t.getTimezoneOffset();if(c===0)return"Z";switch(e){case"X":return y3(c);case"XXXX":case"XX":return Fm(c);case"XXXXX":case"XXX":default:return Fm(c,":")}},x:function(t,e,r){const c=t.getTimezoneOffset();switch(e){case"x":return y3(c);case"xxxx":case"xx":return Fm(c);case"xxxxx":case"xxx":default:return Fm(c,":")}},O:function(t,e,r){const c=t.getTimezoneOffset();switch(e){case"O":case"OO":case"OOO":return"GMT"+g3(c,":");case"OOOO":default:return"GMT"+Fm(c,":")}},z:function(t,e,r){const c=t.getTimezoneOffset();switch(e){case"z":case"zz":case"zzz":return"GMT"+g3(c,":");case"zzzz":default:return"GMT"+Fm(c,":")}},t:function(t,e,r){const c=Math.trunc(t.getTime()/1e3);return Kn(c,e.length)},T:function(t,e,r){const c=t.getTime();return Kn(c,e.length)}};function g3(t,e=""){const r=t>0?"-":"+",c=Math.abs(t),h=Math.trunc(c/60),x=c%60;return x===0?r+String(h):r+String(h)+e+Kn(x,2)}function y3(t,e){return t%60===0?(t>0?"-":"+")+Kn(Math.abs(t)/60,2):Fm(t,e)}function Fm(t,e=""){const r=t>0?"-":"+",c=Math.abs(t),h=Kn(Math.trunc(c/60),2),x=Kn(c%60,2);return r+h+e+x}const x3=(t,e)=>{switch(t){case"P":return e.date({width:"short"});case"PP":return e.date({width:"medium"});case"PPP":return e.date({width:"long"});case"PPPP":default:return e.date({width:"full"})}},hU=(t,e)=>{switch(t){case"p":return e.time({width:"short"});case"pp":return e.time({width:"medium"});case"ppp":return e.time({width:"long"});case"pppp":default:return e.time({width:"full"})}},yne=(t,e)=>{const r=t.match(/(P+)(p+)?/)||[],c=r[1],h=r[2];if(!h)return x3(t,e);let x;switch(c){case"P":x=e.dateTime({width:"short"});break;case"PP":x=e.dateTime({width:"medium"});break;case"PPP":x=e.dateTime({width:"long"});break;case"PPPP":default:x=e.dateTime({width:"full"});break}return x.replace("{{date}}",x3(c,e)).replace("{{time}}",hU(h,e))},xne={p:hU,P:yne},_ne=/^D+$/,vne=/^Y+$/,bne=["D","DD","YY","YYYY"];function wne(t){return _ne.test(t)}function Sne(t){return vne.test(t)}function Tne(t,e,r){const c=Nne(t,e,r);if(console.warn(c),bne.includes(t))throw new RangeError(c)}function Nne(t,e,r){const c=t[0]==="Y"?"years":"days of the month";return`Use \`${t.toLowerCase()}\` instead of \`${t}\` (in \`${e}\`) for formatting ${c} to the input \`${r}\`; see: https://github.com/date-fns/date-fns/blob/master/docs/unicodeTokens.md`}const Ane=/[yYQqMLwIdDecihHKkms]o|(\w)\1*|''|'(''|[^'])+('|$)|./g,Cne=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g,Ene=/^'([^]*?)'?$/,Ine=/''/g,Pne=/[a-zA-Z]/;function bc(t,e,r){var F,$,Y,H;const c=PT(),h=c.locale??hne,x=c.firstWeekContainsDate??(($=(F=c.locale)==null?void 0:F.options)==null?void 0:$.firstWeekContainsDate)??1,w=c.weekStartsOn??((H=(Y=c.locale)==null?void 0:Y.options)==null?void 0:H.weekStartsOn)??0,o=Lo(t);if(!Rre(o))throw new RangeError("Invalid time value");let C=e.match(Cne).map(X=>{const he=X[0];if(he==="p"||he==="P"){const se=xne[he];return se(X,h.formatLong)}return X}).join("").match(Ane).map(X=>{if(X==="''")return{isToken:!1,value:"'"};const he=X[0];if(he==="'")return{isToken:!1,value:jne(X)};if(f3[he])return{isToken:!0,value:X};if(he.match(Pne))throw new RangeError("Format string contains an unescaped latin alphabet character `"+he+"`");return{isToken:!1,value:X}});h.localize.preprocessor&&(C=h.localize.preprocessor(o,C));const R={firstWeekContainsDate:x,weekStartsOn:w,locale:h};return C.map(X=>{if(!X.isToken)return X.value;const he=X.value;(Sne(he)||wne(he))&&Tne(he,e,String(t));const se=f3[he[0]];return se(o,he,h.localize,R)}).join("")}function jne(t){const e=t.match(Ene);return e?e[1].replace(Ine,"'"):t}function _3(t,e){const r=Lo(t),c=Lo(e);return+r<+c}function Rne(t,e,r){const c=df(t,r),h=df(e,r);return+c==+h}function kne(t,e){return Rne(t,uU(t),e)}function Dne(t){return Pre(t,uU(t))}const hf={controlled:{label:"Controlled Ground Area",density:0,description:"Areas controlled where unauthorized people are not allowed to enter"},remote:{label:"Remote (< 5 ppl/km)",density:5,description:"Areas where people may be, such as forests, deserts, large farm parcels"},lightly:{label:"Lightly Populated (< 50 ppl/km)",density:50,description:"Areas of small farms, residential areas with very large lots (~4 acres)"},sparsely:{label:"Sparsely Populated (< 500 ppl/km)",density:500,description:"Areas of homes and small businesses with large lot sizes (~1 acre)"},suburban:{label:"Suburban (< 5,000 ppl/km)",density:5e3,description:"Single-family homes on small lots, apartment complexes, commercial buildings"},highdensity:{label:"High Density Metro (< 50,000 ppl/km)",density:5e4,description:"Areas of mostly large multistory buildings, downtown areas"},assembly:{label:"Assembly of People (> 50,000 ppl/km)",density:1e5,description:"Large gatherings such as professional sporting events, large concerts"}},tv={"1m_25ms":{label:"1m / 25 m/s",maxDimension:1,maxSpeed:25,description:"Small consumer drones"},"3m_35ms":{label:"3m / 35 m/s",maxDimension:3,maxSpeed:35,description:"Medium commercial UAS"},"8m_75ms":{label:"8m / 75 m/s",maxDimension:8,maxSpeed:75,description:"Large industrial UAS"},"20m_120ms":{label:"20m / 120 m/s",maxDimension:20,maxSpeed:120,description:"Large fixed-wing UAS"},"40m_200ms":{label:"40m / 200 m/s",maxDimension:40,maxSpeed:200,description:"Very large UAS"}},Mne={controlled:{"1m_25ms":1,"3m_35ms":1,"8m_75ms":2,"20m_120ms":3,"40m_200ms":3},remote:{"1m_25ms":2,"3m_35ms":3,"8m_75ms":4,"20m_120ms":5,"40m_200ms":6},lightly:{"1m_25ms":3,"3m_35ms":4,"8m_75ms":5,"20m_120ms":6,"40m_200ms":7},sparsely:{"1m_25ms":4,"3m_35ms":5,"8m_75ms":6,"20m_120ms":7,"40m_200ms":8},suburban:{"1m_25ms":5,"3m_35ms":6,"8m_75ms":7,"20m_120ms":8,"40m_200ms":9},highdensity:{"1m_25ms":6,"3m_35ms":7,"8m_75ms":8,"20m_120ms":9,"40m_200ms":10},assembly:{"1m_25ms":7,"3m_35ms":8,"8m_75ms":null,"20m_120ms":null,"40m_200ms":null}},pU={M1A:{name:"M1(A) - Strategic Mitigation: Sheltering",description:"People on ground are sheltered by structures",reductions:{none:0,low:-1,medium:-2},maxRobustness:"medium",notes:"Cannot be combined with M1(B) at medium robustness"},M1B:{name:"M1(B) - Strategic Mitigation: Operational Restrictions",description:"Spacetime-based restrictions reduce exposure",reductions:{none:0,medium:-1,high:-2},minRobustness:"medium",notes:"Cannot be combined with M1(A) at medium robustness"},M1C:{name:"M1(C) - Tactical Mitigation: Ground Observation",description:"Observers can warn people in operational area",reductions:{none:0,low:-1},maxRobustness:"low",notes:"Limited to -1 reduction at low robustness only"},M2:{name:"M2 - Effects of UA Impact Dynamics Reduced",description:"Parachute, autorotation, or frangibility reduces impact energy",reductions:{none:0,medium:-1,high:-2},minRobustness:"medium",notes:"Can claim additional reduction with demonstrated 3+ orders of magnitude risk reduction"}},mU={"ARC-a":{description:"Atypical airspace (segregated, restricted)",encounters:"Negligible",notes:"Risk acceptably low without tactical mitigation"},"ARC-b":{description:"Uncontrolled airspace, rural, low altitude",encounters:"Low",notes:"Typical for rural VLOS operations below 400ft"},"ARC-c":{description:"Controlled airspace or urban uncontrolled",encounters:"Medium",notes:"Requires coordination with ANSP in controlled airspace"},"ARC-d":{description:"Airport/heliport environment or high traffic",encounters:"High",notes:"Requires specific approval and coordination"}},fU={VLOS:{description:"Visual Line of Sight - See and avoid by remote pilot",arcReduction:1,maxResidualARC:"ARC-b",robustnessRequired:"low"},EVLOS:{description:"Extended VLOS - Visual observers provide separation",arcReduction:1,maxResidualARC:"ARC-b",robustnessRequired:"low"},DAA:{description:"Detect and Avoid system onboard",arcReduction:2,maxResidualARC:"ARC-a",robustnessRequired:"medium"}},One={1:{"ARC-a":"I","ARC-b":"II","ARC-c":"IV","ARC-d":"VI"},2:{"ARC-a":"I","ARC-b":"II","ARC-c":"IV","ARC-d":"VI"},3:{"ARC-a":"II","ARC-b":"II","ARC-c":"IV","ARC-d":"VI"},4:{"ARC-a":"III","ARC-b":"III","ARC-c":"IV","ARC-d":"VI"},5:{"ARC-a":"IV","ARC-b":"IV","ARC-c":"IV","ARC-d":"VI"},6:{"ARC-a":"V","ARC-b":"V","ARC-c":"V","ARC-d":"VI"},7:{"ARC-a":"VI","ARC-b":"VI","ARC-c":"VI","ARC-d":"VI"}},Ld={I:"bg-green-100 text-green-800 border-green-300",II:"bg-green-200 text-green-800 border-green-400",III:"bg-yellow-100 text-yellow-800 border-yellow-300",IV:"bg-orange-100 text-orange-800 border-orange-300",V:"bg-red-100 text-red-800 border-red-300",VI:"bg-red-200 text-red-900 border-red-400"},fI={I:"Lowest assurance - Declaration may be sufficient",II:"Low assurance - Standard operating procedures",III:"Medium assurance - Validated procedures required",IV:"Medium-High assurance - Comprehensive safety case",V:"High assurance - Extensive demonstration required",VI:"Highest assurance - Full airworthiness demonstration"},Lne={controlled:{I:"low",II:"low",III:"low",IV:"low",V:"low",VI:"medium"},remote:{I:"low",II:"low",III:"low",IV:"low",V:"low",VI:"medium"},lightly:{I:"low",II:"low",III:"low",IV:"low",V:"medium",VI:"medium"},sparsely:{I:"low",II:"low",III:"low",IV:"medium",V:"medium",VI:"high"},suburban:{I:"low",II:"low",III:"medium",IV:"medium",V:"high",VI:"high"},highdensity:{I:"low",II:"medium",III:"medium",IV:"high",V:"high",VI:"high"},assembly:{I:"medium",II:"medium",III:"high",IV:"high",V:"high",VI:"high"}},qw={none:{label:"None",description:"No specific containment measures",robustnessAchievable:"none",evidenceRequired:[]},procedural:{label:"Procedural",description:"Operational procedures and flight planning to stay within boundaries",robustnessAchievable:"low",evidenceRequired:["Flight planning procedures","Boundary awareness training","Visual reference points identified"]},sw_geofence:{label:"Software Geofencing",description:"Software-based geofencing that alerts pilot when approaching boundaries",robustnessAchievable:"medium",evidenceRequired:["Geofence configuration documented","Alert/warning system tested","Pilot response procedures","Geofence accuracy specifications"]},hw_geofence:{label:"Hardware Geofencing",description:"Hardware-enforced geofencing with automatic position limiting",robustnessAchievable:"medium",evidenceRequired:["Hardware geofence specifications","Independent position source","Automatic boundary enforcement tested","Failure mode analysis"]},flight_termination:{label:"Flight Termination System",description:"Independent system to terminate flight if boundaries exceeded",robustnessAchievable:"high",evidenceRequired:["FTS specifications and design","Independent trigger mechanism","Demonstrated reliability data","Testing and verification records","Activation criteria defined"]},parachute_fts:{label:"Parachute + Flight Termination",description:"Flight termination with parachute recovery system",robustnessAchievable:"high",evidenceRequired:["Parachute specifications","Combined FTS + parachute testing","Descent rate and footprint analysis","Reliability demonstration","Activation altitude requirements"]}},Fne={technical:{label:"Technical Issue with UAS",osos:["OSO-01","OSO-02","OSO-03","OSO-04","OSO-05","OSO-06","OSO-07","OSO-10","OSO-11"]},external:{label:"Deterioration of External Systems",osos:["OSO-08","OSO-13"]},human:{label:"Human Error",osos:["OSO-09","OSO-12","OSO-16","OSO-17","OSO-18","OSO-19","OSO-20"]},operating:{label:"Adverse Operating Conditions",osos:["OSO-21","OSO-22","OSO-23","OSO-24"]}},zne=[{id:"OSO-01",category:"technical",name:"Ensure the Operator is competent and/or proven",description:"Operator demonstrates competency for the operation",requirements:{I:"O",II:"L",III:"M",IV:"H",V:"H",VI:"H"},responsibility:"operator",evidenceGuidance:{low:["Pilot certificate/license","Basic flight training records","Operator registration"],medium:["Recurrent training records","Type-specific training","Competency assessments","Operations manual"],high:["Third-party competency verification","Audited training program","Continuous assessment program"]}},{id:"OSO-02",category:"technical",name:"UAS manufactured by competent and/or proven entity",description:"Manufacturer has documented quality and design processes",requirements:{I:"O",II:"O",III:"L",IV:"M",V:"H",VI:"H"},responsibility:"designer",evidenceGuidance:{low:["Manufacturer declaration","Basic product documentation"],medium:["ISO 9001 or equivalent QMS certification","Design documentation"],high:["Aviation authority approved design organization","Full design assurance"]}},{id:"OSO-03",category:"technical",name:"UAS maintained by competent and/or proven entity",description:"Maintenance performed by trained personnel per procedures",requirements:{I:"L",II:"L",III:"M",IV:"M",V:"H",VI:"H"},responsibility:"operator",evidenceGuidance:{low:["Maintenance log","Basic maintenance training records"],medium:["Documented maintenance program","Certified maintenance personnel","Maintenance tracking system"],high:["Approved maintenance organization","Audited maintenance program","Component tracking"]}},{id:"OSO-04",category:"technical",name:"UAS developed to Airworthiness Design Standard (ADS)",description:"UAS components essential to safe ops designed to ADS",requirements:{I:"O",II:"O",III:"O",IV:"L",V:"M",VI:"H"},responsibility:"designer",evidenceGuidance:{low:["Reference to industry standards used","Basic design documentation"],medium:["Compliance matrix to recognized standard","Design verification evidence"],high:["Full airworthiness certification","Type certificate or equivalent"]}},{id:"OSO-05",category:"technical",name:"UAS designed considering system safety and reliability",description:"System safety and reliability analysis performed",requirements:{I:"O",II:"O",III:"L",IV:"M",V:"H",VI:"H"},responsibility:"designer",evidenceGuidance:{low:["Basic hazard identification","Manufacturer reliability data"],medium:["Functional Hazard Analysis (FHA)","FMEA or equivalent","Reliability targets defined"],high:["Full safety assessment per ARP4761 or equivalent","Demonstrated reliability data"]}},{id:"OSO-06",category:"technical",name:"C3 link characteristics appropriate for operation",description:"Command, control, communication link meets operational needs",requirements:{I:"O",II:"L",III:"L",IV:"M",V:"H",VI:"H"},responsibility:"designer",evidenceGuidance:{low:["C3 link specifications","Range and latency data","Basic link testing"],medium:["Link budget analysis","Interference assessment","Link loss procedures"],high:["Certified C3 link performance","Redundant link capability","Full spectrum analysis"]}},{id:"OSO-07",category:"technical",name:"Conformity check of UAS configuration",description:"Inspection of UAS to ensure condition for safe operation",requirements:{I:"L",II:"L",III:"M",IV:"M",V:"H",VI:"H"},responsibility:"operator",evidenceGuidance:{low:["Pre-flight checklist","Visual inspection records"],medium:["Configuration control log","Software version verification","Component tracking"],high:["Independent conformity inspection","Airworthiness release documentation"]}},{id:"OSO-08",category:"external",name:"Operational procedures defined, validated and adhered to",description:"Procedures exist, are validated, and crew adheres to them",requirements:{I:"L",II:"M",III:"H",IV:"H",V:"H",VI:"H"},responsibility:"operator",evidenceGuidance:{low:["Basic operating procedures","Emergency procedures documented"],medium:["Validated operations manual","Procedure compliance records","Crew briefing records"],high:["Third-party validated procedures","Audited procedure compliance","Continuous improvement process"]}},{id:"OSO-09",category:"human",name:"Remote crew trained and current",description:"Crew training for normal and emergency procedures",requirements:{I:"L",II:"L",III:"M",IV:"M",V:"H",VI:"H"},responsibility:"operator",evidenceGuidance:{low:["Initial training records","Currency requirements met"],medium:["Recurrent training program","Emergency procedure training","Competency checks"],high:["Simulator-based training","Third-party assessed competency","CRM training"]}},{id:"OSO-10",category:"technical",name:"Safe recovery from technical issue",description:"Procedures exist to safely recover from a technical failure",requirements:{I:"L",II:"L",III:"M",IV:"M",V:"H",VI:"H"},responsibility:"operator",evidenceGuidance:{low:["Emergency landing procedures","Basic failure response procedures"],medium:["Failure mode procedures","Recovery training evidence","Tested contingency procedures"],high:["Automatic safe recovery systems","Demonstrated recovery capability","Validated through testing"]}},{id:"OSO-11",category:"technical",name:"Safe recovery from C3 link issues",description:"Procedures and systems to recover from communication failures",requirements:{I:"L",II:"L",III:"M",IV:"M",V:"H",VI:"H"},responsibility:"operator",evidenceGuidance:{low:["Link loss procedures","Return-to-home settings documented"],medium:["Automatic link loss behavior tested","Backup C3 procedures","Training on link loss"],high:["Redundant C3 link","Demonstrated safe behavior on link loss","Certified link loss response"]}},{id:"OSO-12",category:"human",name:"Remote crew trained to handle technical emergencies",description:"Crew competent to manage technical failures and degraded modes",requirements:{I:"L",II:"L",III:"M",IV:"M",V:"H",VI:"H"},responsibility:"operator",evidenceGuidance:{low:["Emergency procedure training records","Basic troubleshooting capability"],medium:["Scenario-based emergency training","Regular drills conducted","Assessment records"],high:["Simulator training for emergencies","Third-party competency verification","Stress training"]}},{id:"OSO-13",category:"external",name:"External services supporting UAS operations are adequate",description:"CNS, UTM, weather services adequate for operation",requirements:{I:"L",II:"L",III:"M",IV:"H",V:"H",VI:"H"},responsibility:"operator",evidenceGuidance:{low:["Weather source identified","NOTAM check process","Basic communication plan"],medium:["Validated weather services","UTM integration where required","ATC coordination procedures"],high:["Certified external service providers","Redundant services","SLA with service providers"]}},{id:"OSO-16",category:"human",name:"Multi-crew coordination",description:"Coordination between multiple crew members",requirements:{I:"L",II:"L",III:"M",IV:"M",V:"H",VI:"H"},responsibility:"operator",evidenceGuidance:{low:["Defined crew roles","Basic communication procedures"],medium:["CRM principles applied","Briefing/debriefing procedures","Team training"],high:["Formal CRM training","Crew composition requirements","Third-party assessed coordination"]}},{id:"OSO-17",category:"human",name:"Remote crew fit to operate",description:"Crew fitness-for-duty (medical, fatigue, substances)",requirements:{I:"L",II:"L",III:"M",IV:"M",V:"H",VI:"H"},responsibility:"operator",evidenceGuidance:{low:["Self-declaration of fitness","Basic fitness requirements documented"],medium:["Medical certificate","Fatigue management policy","Substance policy"],high:["Aviation medical certificate","Fatigue risk management system","Random testing program"]}},{id:"OSO-18",category:"human",name:"Automatic protection of flight envelope from human error",description:"Automatic systems prevent exceeding flight envelope",requirements:{I:"O",II:"O",III:"L",IV:"M",V:"H",VI:"H"},responsibility:"designer",evidenceGuidance:{low:["Basic geofencing capability","Altitude limits implemented"],medium:["Validated envelope protection","Tested limit functions","Override procedures"],high:["Certified flight envelope protection","Independent monitoring","Full automation testing"]}},{id:"OSO-19",category:"human",name:"Safe recovery from human error",description:"Procedures and systems for recovery from human error",requirements:{I:"O",II:"O",III:"L",IV:"M",V:"M",VI:"H"},responsibility:"designer",evidenceGuidance:{low:["Basic error recovery procedures","Undo/cancel functions"],medium:["Error-tolerant interface design","Recovery mode procedures","Training on error recovery"],high:["Formal HMI assessment","Demonstrated error recovery capability","Independent verification"]}},{id:"OSO-20",category:"human",name:"Human Factors evaluation performed, HMI appropriate",description:"HMI assessed and found appropriate for the mission",requirements:{I:"O",II:"L",III:"L",IV:"M",V:"M",VI:"H"},responsibility:"designer",evidenceGuidance:{low:["Basic HMI description","User feedback considered"],medium:["HMI assessment performed","Workload analysis","Usability testing"],high:["Formal HF evaluation per standards","Independent HMI assessment","Certified HMI design"]}},{id:"OSO-21",category:"operating",name:"Automatic protection of flight envelope from adverse conditions",description:"Automatic systems protect operation from adverse environmental conditions",requirements:{I:"O",II:"O",III:"L",IV:"M",V:"H",VI:"H"},responsibility:"designer",evidenceGuidance:{low:["Environmental limits defined","Basic sensor monitoring"],medium:["Automatic response to adverse conditions","Tested environmental protection"],high:["Certified environmental protection systems","Redundant sensing","Full automation validation"]}},{id:"OSO-22",category:"operating",name:"Remote crew able to control UAS in adverse conditions",description:"Crew can safely manage UAS when faced with adverse conditions",requirements:{I:"L",II:"L",III:"M",IV:"M",V:"H",VI:"H"},responsibility:"operator",evidenceGuidance:{low:["Adverse condition procedures","Basic training on weather effects"],medium:["Scenario training for adverse conditions","Decision-making procedures","Competency assessment"],high:["Simulator training for adverse conditions","Third-party verified competency","Stress testing"]}},{id:"OSO-23",category:"operating",name:"Environmental conditions defined, measurable and adhered to",description:"Weather and environmental limits documented and followed",requirements:{I:"L",II:"L",III:"M",IV:"M",V:"H",VI:"H"},responsibility:"operator",evidenceGuidance:{low:["Weather limits defined","Weather briefing procedure"],medium:["Weather monitoring during ops","Go/no-go criteria","Real-time weather updates"],high:["Validated weather sources","Continuous monitoring systems","Automatic alerts"]}},{id:"OSO-24",category:"operating",name:"UAS designed and qualified for adverse environmental conditions",description:"UAS can handle defined adverse environmental conditions",requirements:{I:"O",II:"O",III:"M",IV:"H",V:"H",VI:"H"},responsibility:"designer",evidenceGuidance:{low:["Environmental envelope defined by manufacturer"],medium:["Environmental testing performed","IP rating where applicable","Temperature range verified"],high:["Certified environmental qualification","Full environmental testing to standards","Independent verification"]}}];function RT(t,e){var r;return((r=Mne[t])==null?void 0:r[e])??null}function kT(t,e={}){var h,x,w,o,C;if(t===null)return null;let r=0;if((h=e.M1A)!=null&&h.enabled&&e.M1A.robustness){const R=e.M1A.robustness;R==="low"?r-=1:R==="medium"&&(r-=2)}if((x=e.M1B)!=null&&x.enabled&&e.M1B.robustness){const R=e.M1B.robustness;((w=e.M1A)==null?void 0:w.robustness)==="medium"?console.warn("M1A(medium) cannot be combined with M1B"):R==="medium"?r-=1:R==="high"&&(r-=2)}if((o=e.M1C)!=null&&o.enabled&&e.M1C.robustness==="low"&&(r-=1),(C=e.M2)!=null&&C.enabled&&e.M2.robustness){const R=e.M2.robustness;R==="medium"?r-=1:R==="high"&&(r-=2)}const c=t+r;return Math.max(1,c)}function Bne(t){return t!==null&&t<=7}function DT(t,e={}){const r=["ARC-a","ARC-b","ARC-c","ARC-d"],c=r.indexOf(t);if(c===-1)return"ARC-b";if(e!=null&&e.enabled&&(e!=null&&e.type)){const h=fU[e.type];if(h){const x=["none","low","medium","high"],w=x.indexOf(e.robustness||"none"),o=x.indexOf(h.robustnessRequired||"low");if(w>=o){const C=Math.max(0,c-h.arcReduction);return r[C]}}}return t}function MT(t,e){var c;if(t===null||t>7)return null;const r=Math.min(7,Math.max(1,t));return((c=One[r])==null?void 0:c[e])??null}function Vne(t){const e=t*180;return e<5e3?5e3:e>35e3?35e3:e}function Une(t,e){var r;return((r=Lne[t])==null?void 0:r[e])??"low"}function qne(t,e,r){const c=t.requirements[e],h={O:0,L:1,M:2,H:3},x={none:0,low:1,medium:2,high:3},w=h[c]??0,o=x[r]??0;return{required:c,requiredLabel:c==="O"?"Optional":c==="L"?"Low":c==="M"?"Medium":"High",actual:r,compliant:o>=w,gap:w>o?w-o:0}}function gU(t,e={}){const r=zne.map(w=>{const o=e[w.id]||{robustness:"none"};return{...w,...qne(w,t,o.robustness),evidence:o.evidence||""}}),c=r.filter(w=>w.compliant),h=r.filter(w=>!w.compliant&&w.required!=="O"),x=r.filter(w=>w.required==="O");return{results:r,summary:{total:r.length,compliant:c.length,nonCompliant:h.length,optional:x.length,overallCompliant:h.length===0}}}const Ou=[{id:"pol-1001",number:"1001",title:"RPAS Operations Policy",category:"rpas",description:"Establishes the framework for all remotely piloted aircraft system operations, defining responsibilities, authorization requirements, and operational standards.",version:"3.0",effectiveDate:"2025-01-15",reviewDate:"2026-01-15",owner:"Chief Pilot",status:"active",keywords:["operations","framework","authorization","standards","rpas","drone"],relatedPolicies:["1002","1003","1009"],regulatoryRefs:["CARs 901","CARs 903","SFOC Guidelines"],sections:["Purpose and Scope","Responsibilities","Authorization Requirements","Operational Categories","Training Requirements","Documentation","Compliance Monitoring"]},{id:"pol-1002",number:"1002",title:"Flight Authorization Procedure",category:"rpas",description:"Defines the process for obtaining internal flight authorization, including risk assessment review, crew qualification verification, and operational approval.",version:"2.1",effectiveDate:"2024-09-01",reviewDate:"2025-09-01",owner:"Operations Manager",status:"active",keywords:["authorization","approval","risk assessment","flight","permission"],relatedPolicies:["1001","1005","1006"],regulatoryRefs:["CARs 901.71","CARs 903.03"],sections:["Authorization Request Process","Risk Assessment Requirements","Crew Qualification Verification","Site Survey Requirements","Approval Authority Matrix","Documentation Requirements"]},{id:"pol-1003",number:"1003",title:"Airspace Authorization",category:"rpas",description:"Procedures for obtaining airspace authorization from NAV CANADA and operating in controlled airspace, including NOTAM requirements.",version:"2.0",effectiveDate:"2024-06-15",reviewDate:"2025-06-15",owner:"Chief Pilot",status:"active",keywords:["airspace","NAV CANADA","controlled","authorization","ATC"],relatedPolicies:["1001","1004"],regulatoryRefs:["CARs 901.64","CARs 901.65","NAV CANADA RPAS Guidelines"],sections:["Airspace Classification Overview","Authorization Requirements by Class","NAV CANADA Application Process","NOTAM Procedures","Real-time Coordination","Emergency Procedures"]},{id:"pol-1004",number:"1004",title:"NOTAM Procedures",category:"rpas",description:"Procedures for filing, managing, and monitoring NOTAMs for drone operations, including timing requirements and coordination protocols.",version:"1.5",effectiveDate:"2024-08-01",reviewDate:"2025-08-01",owner:"Operations Manager",status:"active",keywords:["NOTAM","notice","airmen","filing","airspace"],relatedPolicies:["1003"],regulatoryRefs:["CARs 602.73","NAV CANADA NOTAM Manual"],sections:["NOTAM Requirements","Filing Procedures","Timing Requirements","Content Standards","Monitoring and Updates","Cancellation Procedures"]},{id:"pol-1005",number:"1005",title:"Weather Minimums and Limitations",category:"rpas",description:"Defines weather minimums for safe operations, including visibility, wind, precipitation, and temperature limitations for different aircraft types.",version:"2.2",effectiveDate:"2024-11-01",reviewDate:"2025-11-01",owner:"Chief Pilot",status:"active",keywords:["weather","minimums","wind","visibility","conditions","limitations"],relatedPolicies:["1002","1006"],regulatoryRefs:["CARs 901.22","Manufacturer Limitations"],sections:["Weather Assessment Requirements","Visibility Minimums","Wind Limitations","Precipitation Restrictions","Temperature Limits","Weather Monitoring During Operations"]},{id:"pol-1006",number:"1006",title:"Emergency Procedures",category:"rpas",description:"Standard emergency procedures for RPAS operations including flyaways, loss of control link, battery emergencies, and collision response.",version:"3.1",effectiveDate:"2024-12-01",reviewDate:"2025-06-01",owner:"Chief Pilot",status:"active",keywords:["emergency","flyaway","loss of link","battery","collision","procedures"],relatedPolicies:["1001","1007"],regulatoryRefs:["CARs 901.73","Transport Canada Advisory Circulars"],sections:["Emergency Classification","Flyaway Procedures","Loss of Control Link","Low Battery Emergency","Collision/Near-Miss Response","Post-Emergency Reporting"]},{id:"pol-1007",number:"1007",title:"Incident Reporting",category:"rpas",description:"Requirements and procedures for reporting safety incidents, accidents, and near-misses, including Transport Canada notification requirements.",version:"2.0",effectiveDate:"2024-07-01",reviewDate:"2025-07-01",owner:"Safety Manager",status:"active",keywords:["incident","accident","reporting","notification","safety","near-miss"],relatedPolicies:["1006","1045","1046"],regulatoryRefs:["CARs 901.75","TSB Regulations"],sections:["Reportable Events Definition","Internal Reporting Process","Transport Canada Notification","TSB Notification Requirements","Investigation Procedures","Documentation Requirements"]},{id:"pol-1008",number:"1008",title:"Aircraft Registration",category:"rpas",description:"Procedures for registering and marking RPAS with Transport Canada, including renewal requirements and record keeping.",version:"1.3",effectiveDate:"2024-03-01",reviewDate:"2025-03-01",owner:"Operations Manager",status:"due",keywords:["registration","marking","Transport Canada","aircraft","renewal"],relatedPolicies:["1009"],regulatoryRefs:["CARs 901.03","CARs 901.05"],sections:["Registration Requirements","Marking Requirements","Registration Process","Renewal Procedures","Record Keeping","Fleet Management"]},{id:"pol-1009",number:"1009",title:"Aircraft Maintenance",category:"rpas",description:"Maintenance requirements, inspection schedules, and airworthiness standards for the RPAS fleet, including pre-flight and periodic inspections.",version:"2.5",effectiveDate:"2024-10-15",reviewDate:"2025-10-15",owner:"Maintenance Manager",status:"active",keywords:["maintenance","inspection","airworthiness","pre-flight","periodic"],relatedPolicies:["1001","1008"],regulatoryRefs:["CARs 901.29","Manufacturer Maintenance Manuals"],sections:["Maintenance Philosophy","Pre-flight Inspection","Periodic Inspection Schedule","Component Life Limits","Maintenance Documentation","Defect Reporting and Rectification"]},{id:"pol-1010",number:"1010",title:"Pilot Certification",category:"rpas",description:"Requirements for pilot certification, currency, and proficiency, including Basic and Advanced certificate requirements.",version:"2.1",effectiveDate:"2024-05-01",reviewDate:"2025-05-01",owner:"Chief Pilot",status:"active",keywords:["certification","pilot","basic","advanced","currency","proficiency"],relatedPolicies:["1001","1011"],regulatoryRefs:["CARs 901.54","CARs 901.55","CARs 901.56"],sections:["Certification Requirements","Basic vs Advanced Operations","Currency Requirements","Proficiency Standards","Recertification Process","Record Keeping"]},{id:"pol-1011",number:"1011",title:"Flight Review Program",category:"rpas",description:"Internal flight review program for maintaining pilot proficiency, including annual check requirements and remedial training.",version:"1.8",effectiveDate:"2024-04-01",reviewDate:"2025-04-01",owner:"Chief Pilot",status:"active",keywords:["flight review","proficiency","check","annual","training"],relatedPolicies:["1010"],regulatoryRefs:["CARs 901.57"],sections:["Flight Review Requirements","Review Schedule","Evaluation Criteria","Remedial Training","Documentation","Examiner Qualifications"]},{id:"pol-1012",number:"1012",title:"SFOC Operations",category:"rpas",description:"Procedures for conducting operations under Special Flight Operations Certificates, including application process and compliance requirements.",version:"2.3",effectiveDate:"2024-08-15",reviewDate:"2025-08-15",owner:"Chief Pilot",status:"active",keywords:["SFOC","special","operations","certificate","Transport Canada"],relatedPolicies:["1001","1002","1003"],regulatoryRefs:["CARs 903","Transport Canada SFOC Guidelines"],sections:["SFOC Requirements","Application Process","Operational Conditions","Compliance Monitoring","Reporting Requirements","Renewal Process"]},{id:"pol-1013",number:"1013",title:"Crew Resource Management",category:"crm",description:"CRM principles and practices for RPAS operations, including communication, decision making, and situational awareness.",version:"2.0",effectiveDate:"2024-06-01",reviewDate:"2025-06-01",owner:"Chief Pilot",status:"active",keywords:["CRM","crew","resource","management","communication","teamwork"],relatedPolicies:["1014","1017","1018"],regulatoryRefs:["Transport Canada CRM Guidelines","ICAO Doc 9995"],sections:["CRM Principles","Communication Standards","Situational Awareness","Workload Management","Team Coordination","Error Management"]},{id:"pol-1014",number:"1014",title:"Briefing and Debriefing",category:"crm",description:"Requirements for pre-flight briefings, operational briefings, and post-flight debriefings to ensure effective crew coordination.",version:"1.7",effectiveDate:"2024-05-15",reviewDate:"2025-05-15",owner:"Operations Manager",status:"active",keywords:["briefing","debriefing","pre-flight","post-flight","coordination"],relatedPolicies:["1013","1015"],regulatoryRefs:["CARs 901.71"],sections:["Pre-Flight Briefing Requirements","Briefing Content Standards","Operational Briefings","Debriefing Process","Lessons Learned Documentation","Briefing Checklists"]},{id:"pol-1015",number:"1015",title:"Visual Observer Procedures",category:"crm",description:"Requirements, responsibilities, and procedures for visual observers supporting RPAS operations.",version:"2.2",effectiveDate:"2024-07-01",reviewDate:"2025-07-01",owner:"Chief Pilot",status:"active",keywords:["visual observer","VO","spotter","EVLOS","procedures"],relatedPolicies:["1013","1016","1021"],regulatoryRefs:["CARs 901.70","CARs 901.71"],sections:["Visual Observer Requirements","Qualifications and Training","Communication Protocols","Positioning Requirements","Handover Procedures","Documentation"]},{id:"pol-1016",number:"1016",title:"Crew Composition",category:"crm",description:"Requirements for crew composition based on operation type, complexity, and risk level.",version:"1.5",effectiveDate:"2024-04-01",reviewDate:"2025-04-01",owner:"Operations Manager",status:"active",keywords:["crew","composition","staffing","roles","requirements"],relatedPolicies:["1013","1015"],regulatoryRefs:["CARs 901.69"],sections:["Minimum Crew Requirements","Role Definitions","Complexity-Based Staffing","Qualification Matrix","Crew Assignment Process","Substitution Procedures"]},{id:"pol-1017",number:"1017",title:"Aeronautical Decision Making",category:"crm",description:"Framework for aeronautical decision making including the FORDEC model and risk-based decision processes.",version:"2.1",effectiveDate:"2024-09-01",reviewDate:"2025-09-01",owner:"Chief Pilot",status:"active",keywords:["decision making","FORDEC","ADM","risk","judgment"],relatedPolicies:["1013","1018"],regulatoryRefs:["Transport Canada ADM Guidelines"],sections:["Decision Making Framework","FORDEC Model","Risk Assessment Integration","Go/No-Go Decisions","In-Flight Decision Making","Post-Decision Review"]},{id:"pol-1018",number:"1018",title:"Threat and Error Management",category:"crm",description:"TEM model implementation for identifying, managing, and mitigating threats and errors in RPAS operations.",version:"1.8",effectiveDate:"2024-10-01",reviewDate:"2025-10-01",owner:"Safety Manager",status:"active",keywords:["TEM","threat","error","management","safety"],relatedPolicies:["1013","1017"],regulatoryRefs:["ICAO Doc 9995","Transport Canada SMS Guidelines"],sections:["TEM Model Overview","Threat Identification","Error Classification","Countermeasures","Undesired Aircraft States","TEM Training Requirements"]},{id:"pol-1019",number:"1019",title:"Fatigue Risk Management",category:"crm",description:"Fatigue risk management system including duty time limitations, rest requirements, and fatigue reporting.",version:"2.0",effectiveDate:"2024-11-15",reviewDate:"2025-11-15",owner:"Operations Manager",status:"active",keywords:["fatigue","duty time","rest","FRMS","hours"],relatedPolicies:["1020"],regulatoryRefs:["Transport Canada FRMS Guidelines"],sections:["Fatigue Risk Factors","Duty Time Limitations","Rest Requirements","Fatigue Reporting","Scheduling Considerations","Fatigue Countermeasures"]},{id:"pol-1020",number:"1020",title:"Fitness for Duty",category:"crm",description:"Requirements for crew fitness for duty including medical fitness, substance use policy, and self-assessment.",version:"1.6",effectiveDate:"2024-08-01",reviewDate:"2025-08-01",owner:"Operations Manager",status:"active",keywords:["fitness","duty","medical","IMSAFE","impairment"],relatedPolicies:["1019"],regulatoryRefs:["CARs 602.02","Transport Canada Guidelines"],sections:["Fitness Standards","IMSAFE Checklist","Medical Requirements","Substance Use Policy","Self-Declaration","Return to Duty Process"]},{id:"pol-1021",number:"1021",title:"Communication Procedures",category:"crm",description:"Standard communication procedures for crew coordination, including radio procedures and emergency communications.",version:"1.9",effectiveDate:"2024-06-15",reviewDate:"2025-06-15",owner:"Chief Pilot",status:"active",keywords:["communication","radio","procedures","crew","coordination"],relatedPolicies:["1013","1015"],regulatoryRefs:["CARs 901.71"],sections:["Communication Standards","Radio Procedures","Crew Communication","External Communications","Emergency Communications","Communication Equipment"]},{id:"pol-1022",number:"1022",title:"Health and Safety Policy",category:"hse",description:"Overarching health and safety policy establishing commitment, responsibilities, and HSE management system framework.",version:"3.0",effectiveDate:"2025-01-01",reviewDate:"2026-01-01",owner:"HSE Manager",status:"active",keywords:["health","safety","policy","HSE","OHS","management"],relatedPolicies:["1023","1024"],regulatoryRefs:["OH&S Act","COR Requirements"],sections:["Policy Statement","Management Commitment","Responsibilities","HSE Management System","Performance Monitoring","Continuous Improvement"]},{id:"pol-1023",number:"1023",title:"Hazard Identification and Risk Assessment",category:"hse",description:"Procedures for identifying workplace hazards and conducting risk assessments using the 5x5 risk matrix.",version:"2.4",effectiveDate:"2024-09-01",reviewDate:"2025-09-01",owner:"HSE Manager",status:"active",keywords:["hazard","HIRA","risk assessment","matrix","identification"],relatedPolicies:["1022","1024"],regulatoryRefs:["OH&S Act","COR Requirements","CSA Z1002"],sections:["Hazard Identification Process","Risk Assessment Methodology","5x5 Risk Matrix","Risk Ranking and Prioritization","Control Measures","Documentation Requirements"]},{id:"pol-1024",number:"1024",title:"Site Safety",category:"hse",description:"Site-specific safety requirements including site setup, hazard controls, and safe work practices for field operations.",version:"2.1",effectiveDate:"2024-07-15",reviewDate:"2025-07-15",owner:"HSE Manager",status:"active",keywords:["site","safety","field","setup","controls"],relatedPolicies:["1022","1023","1025"],regulatoryRefs:["OH&S Act","COR Requirements"],sections:["Site Assessment","Site Setup Requirements","Exclusion Zones","Signage Requirements","Traffic Management","Site Inspections"]},{id:"pol-1025",number:"1025",title:"Personal Protective Equipment",category:"hse",description:"PPE requirements, selection, use, maintenance, and training for all operational activities.",version:"2.0",effectiveDate:"2024-06-01",reviewDate:"2025-06-01",owner:"HSE Manager",status:"active",keywords:["PPE","protective","equipment","safety gear","protection"],relatedPolicies:["1024"],regulatoryRefs:["OH&S Act","CSA Standards"],sections:["PPE Requirements by Task","Selection Criteria","Use and Limitations","Inspection and Maintenance","Training Requirements","Procurement Standards"]},{id:"pol-1026",number:"1026",title:"Emergency Response Plan",category:"hse",description:"Emergency response procedures for medical emergencies, fires, severe weather, and other emergency situations.",version:"2.5",effectiveDate:"2024-10-01",reviewDate:"2025-04-01",owner:"HSE Manager",status:"active",keywords:["emergency","response","plan","ERP","evacuation"],relatedPolicies:["1006","1027","1028"],regulatoryRefs:["OH&S Act","Fire Code"],sections:["Emergency Classification","Response Procedures","Evacuation Procedures","Emergency Contacts","Emergency Equipment","Drill Requirements"]},{id:"pol-1027",number:"1027",title:"First Aid",category:"hse",description:"First aid requirements, equipment, training, and response procedures for workplace injuries.",version:"1.8",effectiveDate:"2024-05-01",reviewDate:"2025-05-01",owner:"HSE Manager",status:"active",keywords:["first aid","medical","injury","treatment","kit"],relatedPolicies:["1026"],regulatoryRefs:["OH&S Act","First Aid Regulation"],sections:["First Aid Requirements","Training Standards","First Aid Kit Contents","Response Procedures","Record Keeping","Medical Transportation"]},{id:"pol-1028",number:"1028",title:"Fire Prevention and Response",category:"hse",description:"Fire prevention measures, fire fighting equipment, and emergency response procedures for fire incidents.",version:"1.6",effectiveDate:"2024-04-15",reviewDate:"2025-04-15",owner:"HSE Manager",status:"active",keywords:["fire","prevention","extinguisher","response","LiPo"],relatedPolicies:["1026"],regulatoryRefs:["Fire Code","NFPA Standards"],sections:["Fire Prevention Measures","LiPo Battery Safety","Fire Fighting Equipment","Fire Response Procedures","Evacuation","Post-Fire Procedures"]},{id:"pol-1029",number:"1029",title:"Vehicle Safety",category:"hse",description:"Vehicle safety requirements including inspections, safe driving practices, and incident response.",version:"1.5",effectiveDate:"2024-03-01",reviewDate:"2025-03-01",owner:"HSE Manager",status:"due",keywords:["vehicle","driving","safety","inspection","fleet"],relatedPolicies:["1024"],regulatoryRefs:["Traffic Safety Act","Company Fleet Policy"],sections:["Vehicle Inspection Requirements","Safe Driving Practices","Journey Management","Loading and Securing","Incident Response","Maintenance Requirements"]},{id:"pol-1030",number:"1030",title:"Working at Heights",category:"hse",description:"Safety requirements for working at heights including fall protection, equipment, and rescue procedures.",version:"1.7",effectiveDate:"2024-06-01",reviewDate:"2025-06-01",owner:"HSE Manager",status:"active",keywords:["heights","fall protection","ladder","scaffold","rescue"],relatedPolicies:["1025"],regulatoryRefs:["OH&S Act","Fall Protection Code"],sections:["Working at Heights Definition","Fall Protection Requirements","Equipment Standards","Training Requirements","Rescue Procedures","Inspection Requirements"]},{id:"pol-1031",number:"1031",title:"Hazardous Materials",category:"hse",description:"Handling, storage, and disposal of hazardous materials including batteries, fuels, and chemicals.",version:"2.0",effectiveDate:"2024-08-01",reviewDate:"2025-08-01",owner:"HSE Manager",status:"active",keywords:["hazmat","hazardous","materials","WHMIS","SDS","battery"],relatedPolicies:["1028","1032"],regulatoryRefs:["WHMIS Regulations","TDG Act"],sections:["WHMIS Requirements","SDS Management","Storage Requirements","Handling Procedures","Spill Response","Disposal Procedures"]},{id:"pol-1032",number:"1032",title:"Environmental Protection",category:"hse",description:"Environmental protection measures including spill prevention, waste management, and environmental incident response.",version:"1.8",effectiveDate:"2024-07-01",reviewDate:"2025-07-01",owner:"HSE Manager",status:"active",keywords:["environmental","protection","spill","waste","pollution"],relatedPolicies:["1031"],regulatoryRefs:["Environmental Protection Act","Spill Reporting Regulation"],sections:["Environmental Responsibilities","Spill Prevention","Waste Management","Spill Response","Reporting Requirements","Remediation Procedures"]},{id:"pol-1033",number:"1033",title:"Noise Management",category:"hse",description:"Noise exposure assessment, hearing protection, and noise management for operations in noisy environments.",version:"1.4",effectiveDate:"2024-05-15",reviewDate:"2025-05-15",owner:"HSE Manager",status:"active",keywords:["noise","hearing","protection","exposure","decibels"],relatedPolicies:["1025"],regulatoryRefs:["OH&S Act","Noise Exposure Regulation"],sections:["Noise Exposure Limits","Assessment Requirements","Hearing Protection","Engineering Controls","Monitoring","Training"]},{id:"pol-1034",number:"1034",title:"Heat and Cold Stress",category:"hse",description:"Prevention and management of heat and cold stress for outdoor operations in extreme temperatures.",version:"1.6",effectiveDate:"2024-04-01",reviewDate:"2025-04-01",owner:"HSE Manager",status:"active",keywords:["heat","cold","stress","temperature","thermal","hypothermia"],relatedPolicies:["1025","1035"],regulatoryRefs:["OH&S Act","ACGIH TLVs"],sections:["Temperature Thresholds","Heat Stress Prevention","Cold Stress Prevention","Work/Rest Schedules","Hydration Requirements","Emergency Response"]},{id:"pol-1035",number:"1035",title:"Sun and UV Protection",category:"hse",description:"Protection measures for sun and UV exposure during outdoor operations.",version:"1.3",effectiveDate:"2024-06-01",reviewDate:"2025-06-01",owner:"HSE Manager",status:"active",keywords:["sun","UV","protection","sunscreen","shade"],relatedPolicies:["1025","1034"],regulatoryRefs:["OH&S Act","Cancer Prevention Guidelines"],sections:["UV Exposure Risks","Protection Measures","PPE Requirements","Work Scheduling","Training","Medical Monitoring"]},{id:"pol-1036",number:"1036",title:"Electrical Safety",category:"hse",description:"Electrical safety requirements for working near electrical infrastructure and using electrical equipment.",version:"1.9",effectiveDate:"2024-09-01",reviewDate:"2025-09-01",owner:"HSE Manager",status:"active",keywords:["electrical","safety","power","lines","shock","arc flash"],relatedPolicies:["1024"],regulatoryRefs:["OH&S Act","Electrical Code","Utility Safety Rules"],sections:["Electrical Hazards","Safe Approach Distances","Equipment Requirements","Lockout/Tagout","Emergency Response","Training Requirements"]},{id:"pol-1037",number:"1037",title:"Lone Worker Safety",category:"hse",description:"Safety procedures for personnel working alone or in remote locations.",version:"1.7",effectiveDate:"2024-08-15",reviewDate:"2025-08-15",owner:"HSE Manager",status:"active",keywords:["lone","worker","remote","isolated","check-in"],relatedPolicies:["1026"],regulatoryRefs:["OH&S Act","Working Alone Regulation"],sections:["Lone Worker Definition","Risk Assessment","Communication Requirements","Check-In Procedures","Emergency Response","Technology Solutions"]},{id:"pol-1038",number:"1038",title:"Wildlife and Insect Hazards",category:"hse",description:"Safety measures for wildlife encounters and insect hazards in outdoor operations.",version:"1.5",effectiveDate:"2024-05-01",reviewDate:"2025-05-01",owner:"HSE Manager",status:"active",keywords:["wildlife","insect","bear","tick","bee","animal"],relatedPolicies:["1024","1026"],regulatoryRefs:["Wildlife Act","OH&S Act"],sections:["Wildlife Hazard Assessment","Prevention Measures","Bear Safety","Insect Protection","Emergency Response","Reporting"]},{id:"pol-1039",number:"1039",title:"Workplace Violence and Harassment",category:"hse",description:"Prevention and response procedures for workplace violence and harassment.",version:"2.1",effectiveDate:"2024-10-01",reviewDate:"2025-10-01",owner:"HR Manager",status:"active",keywords:["violence","harassment","workplace","prevention","investigation"],relatedPolicies:["1022"],regulatoryRefs:["OH&S Act","Human Rights Code"],sections:["Policy Statement","Definitions","Prevention Measures","Reporting Procedures","Investigation Process","Support Resources"]},{id:"pol-1040",number:"1040",title:"Incident Investigation",category:"hse",description:"Procedures for investigating workplace incidents and near-misses to identify root causes and prevent recurrence.",version:"2.3",effectiveDate:"2024-11-01",reviewDate:"2025-11-01",owner:"HSE Manager",status:"active",keywords:["incident","investigation","root cause","analysis","near miss"],relatedPolicies:["1007","1041"],regulatoryRefs:["OH&S Act","COR Requirements"],sections:["Investigation Requirements","Investigation Team","Root Cause Analysis","Documentation","Corrective Actions","Lessons Learned"]},{id:"pol-1041",number:"1041",title:"Corrective and Preventive Actions",category:"hse",description:"CAPA process for addressing non-conformances, incidents, and opportunities for improvement.",version:"2.0",effectiveDate:"2024-09-15",reviewDate:"2025-09-15",owner:"HSE Manager",status:"active",keywords:["CAPA","corrective","preventive","action","improvement"],relatedPolicies:["1040"],regulatoryRefs:["COR Requirements","ISO 45001"],sections:["CAPA Process","Root Cause Requirements","Action Planning","Implementation","Effectiveness Verification","Closure Criteria"]},{id:"pol-1042",number:"1042",title:"Safety Meetings",category:"hse",description:"Requirements for toolbox talks, safety meetings, and safety committee activities.",version:"1.6",effectiveDate:"2024-04-01",reviewDate:"2025-04-01",owner:"HSE Manager",status:"active",keywords:["safety meeting","toolbox","talk","committee","communication"],relatedPolicies:["1022"],regulatoryRefs:["OH&S Act","COR Requirements"],sections:["Meeting Requirements","Toolbox Talk Program","Safety Committee","Documentation","Participation Requirements","Topics and Content"]},{id:"pol-1043",number:"1043",title:"Contractor Safety Management",category:"hse",description:"Safety requirements for contractors, subcontractors, and visitors to worksites.",version:"1.9",effectiveDate:"2024-07-15",reviewDate:"2025-07-15",owner:"HSE Manager",status:"active",keywords:["contractor","subcontractor","visitor","management","orientation"],relatedPolicies:["1022","1024"],regulatoryRefs:["OH&S Act","Prime Contractor Regulation"],sections:["Contractor Pre-Qualification","Safety Requirements","Orientation Requirements","Monitoring and Supervision","Non-Compliance","Documentation"]},{id:"pol-1044",number:"1044",title:"Training and Competency",category:"hse",description:"HSE training requirements, competency assessment, and training records management.",version:"2.2",effectiveDate:"2024-08-01",reviewDate:"2025-08-01",owner:"HSE Manager",status:"active",keywords:["training","competency","qualification","assessment","certification"],relatedPolicies:["1010","1011"],regulatoryRefs:["OH&S Act","COR Requirements"],sections:["Training Matrix","Mandatory Training","Competency Assessment","Refresher Requirements","Records Management","Training Evaluation"]},{id:"pol-1045",number:"1045",title:"Records and Documentation",category:"hse",description:"Requirements for HSE records retention, documentation standards, and record management.",version:"1.8",effectiveDate:"2024-06-15",reviewDate:"2025-06-15",owner:"HSE Manager",status:"active",keywords:["records","documentation","retention","filing","audit"],relatedPolicies:["1022"],regulatoryRefs:["OH&S Act","COR Requirements","Privacy Act"],sections:["Document Control","Required Records","Retention Periods","Storage Requirements","Access and Confidentiality","Disposal Procedures"]}],Oj={rpas:{id:"rpas",name:"RPAS Operations",icon:Zn,color:"blue",description:"Policies governing remotely piloted aircraft system operations"},crm:{id:"crm",name:"Crew Resource Management",icon:ds,color:"purple",description:"Policies for crew coordination, communication, and decision making"},hse:{id:"hse",name:"Health, Safety & Environment",icon:Qc,color:"green",description:"Workplace health, safety, and environmental protection policies"}},xp=t=>{const e=new Date,r=new Date(t.reviewDate),c=Math.ceil((r-e)/(1e3*60*60*24));return t.status==="draft"?{status:"draft",label:"Draft",color:"gray",icon:rs}:c<0?{status:"overdue",label:"Review Overdue",color:"red",icon:Cs}:c<=30?{status:"due",label:"Review Due",color:"amber",icon:Wu}:{status:"active",label:"Active",color:"green",icon:qr}},v3=t=>new Date(t).toLocaleDateString("en-CA",{year:"numeric",month:"short",day:"numeric"});function $ne({selected:t,onChange:e}){return n.jsxs("div",{className:"flex flex-wrap gap-2",children:[n.jsx("button",{onClick:()=>e(null),className:`px-4 py-2 rounded-full text-sm font-medium transition-colors ${t===null?"bg-aeria-navy text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:"All Policies"}),Object.values(Oj).map(r=>n.jsxs("button",{onClick:()=>e(r.id),className:`px-4 py-2 rounded-full text-sm font-medium transition-colors flex items-center gap-2 ${t===r.id?r.color==="blue"?"bg-blue-600 text-white":r.color==="purple"?"bg-purple-600 text-white":"bg-green-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[n.jsx(r.icon,{className:"w-4 h-4"}),r.name]},r.id))]})}function gI({policy:t}){const{label:e,color:r,icon:c}=xp(t),h={gray:"bg-gray-100 text-gray-700 border-gray-200",green:"bg-green-100 text-green-700 border-green-200",amber:"bg-amber-100 text-amber-700 border-amber-200",red:"bg-red-100 text-red-700 border-red-200"};return n.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded border text-xs font-medium ${h[r]}`,children:[n.jsx(c,{className:"w-3 h-3"}),e]})}function b3({policy:t,view:e,onClick:r}){const c=Oj[t.category];xp(t);const h={blue:"bg-blue-100 text-blue-700 border-blue-200",purple:"bg-purple-100 text-purple-700 border-purple-200",green:"bg-green-100 text-green-700 border-green-200"};return e==="list"?n.jsxs("button",{onClick:r,className:"w-full p-4 bg-white border border-gray-200 rounded-lg hover:border-gray-300 hover:shadow-sm transition-all text-left flex items-center gap-4",children:[n.jsx("div",{className:"w-16 text-center flex-shrink-0",children:n.jsx("span",{className:`inline-block px-3 py-1 rounded-lg text-sm font-bold ${h[c.color]}`,children:t.number})}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsx("h3",{className:"font-medium text-gray-900 truncate",children:t.title}),n.jsx("p",{className:"text-sm text-gray-500 truncate mt-0.5",children:t.description})]}),n.jsxs("div",{className:"flex items-center gap-3 flex-shrink-0",children:[n.jsx("span",{className:`px-2 py-0.5 rounded text-xs font-medium ${h[c.color]}`,children:c.name}),n.jsx(gI,{policy:t}),n.jsx(ko,{className:"w-5 h-5 text-gray-400"})]})]}):n.jsxs("button",{onClick:r,className:"p-4 bg-white border border-gray-200 rounded-lg hover:border-gray-300 hover:shadow-md transition-all text-left h-full flex flex-col",children:[n.jsxs("div",{className:"flex items-start justify-between mb-3",children:[n.jsx("span",{className:`px-3 py-1 rounded-lg text-sm font-bold ${h[c.color]}`,children:t.number}),n.jsx(gI,{policy:t})]}),n.jsx("h3",{className:"font-medium text-gray-900 mb-2",children:t.title}),n.jsx("p",{className:"text-sm text-gray-500 flex-1 line-clamp-2",children:t.description}),n.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-100 flex items-center justify-between text-xs text-gray-500",children:[n.jsxs("span",{className:"flex items-center gap-1",children:[n.jsx(il,{className:"w-3 h-3"}),"v",t.version]}),n.jsxs("span",{className:"flex items-center gap-1",children:[n.jsx(fa,{className:"w-3 h-3"}),t.owner]})]})]})}function Gne({policy:t,onClose:e}){var w,o,C;if(!t)return null;const r=Oj[t.category],c=xp(t),h={blue:"bg-blue-100 text-blue-700 border-blue-200",purple:"bg-purple-100 text-purple-700 border-purple-200",green:"bg-green-100 text-green-700 border-green-200"},x={blue:"bg-blue-50 border-blue-200",purple:"bg-purple-50 border-purple-200",green:"bg-green-50 border-green-200"};return n.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",children:n.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col",children:[n.jsx("div",{className:`p-6 border-b ${x[r.color]}`,children:n.jsxs("div",{className:"flex items-start justify-between",children:[n.jsxs("div",{className:"flex items-start gap-4",children:[n.jsx("div",{className:`p-3 rounded-lg ${h[r.color]}`,children:n.jsx(r.icon,{className:"w-6 h-6"})}),n.jsxs("div",{children:[n.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[n.jsx("span",{className:`px-2 py-0.5 rounded text-sm font-bold ${h[r.color]}`,children:t.number}),n.jsx(gI,{policy:t})]}),n.jsx("h2",{className:"text-xl font-bold text-gray-900",children:t.title}),n.jsx("p",{className:"text-sm text-gray-500 mt-1",children:r.name})]})]}),n.jsx("button",{onClick:e,className:"p-2 hover:bg-white/50 rounded-lg transition-colors",children:n.jsx(cs,{className:"w-5 h-5 text-gray-500"})})]})}),n.jsxs("div",{className:"flex-1 overflow-y-auto p-6 space-y-6",children:[n.jsxs("div",{children:[n.jsx("h3",{className:"text-sm font-medium text-gray-500 mb-2",children:"Description"}),n.jsx("p",{className:"text-gray-700",children:t.description})]}),n.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[n.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[n.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Version"}),n.jsx("p",{className:"font-medium text-gray-900",children:t.version})]}),n.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[n.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Effective Date"}),n.jsx("p",{className:"font-medium text-gray-900",children:v3(t.effectiveDate)})]}),n.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[n.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Review Date"}),n.jsx("p",{className:`font-medium ${c.status==="overdue"?"text-red-600":c.status==="due"?"text-amber-600":"text-gray-900"}`,children:v3(t.reviewDate)})]}),n.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[n.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Owner"}),n.jsx("p",{className:"font-medium text-gray-900",children:t.owner})]})]}),n.jsxs("div",{children:[n.jsx("h3",{className:"text-sm font-medium text-gray-500 mb-3",children:"Sections"}),n.jsx("div",{className:"bg-gray-50 rounded-lg p-4",children:n.jsx("ol",{className:"space-y-2",children:t.sections.map((R,F)=>n.jsxs("li",{className:"flex items-center gap-3",children:[n.jsx("span",{className:"w-6 h-6 rounded-full bg-white border border-gray-200 flex items-center justify-center text-xs font-medium text-gray-500",children:F+1}),n.jsx("span",{className:"text-gray-700",children:R})]},F))})})]}),((w=t.regulatoryRefs)==null?void 0:w.length)>0&&n.jsxs("div",{children:[n.jsx("h3",{className:"text-sm font-medium text-gray-500 mb-3",children:"Regulatory References"}),n.jsx("div",{className:"flex flex-wrap gap-2",children:t.regulatoryRefs.map((R,F)=>n.jsxs("span",{className:"inline-flex items-center gap-1 px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm",children:[n.jsx($ie,{className:"w-3 h-3"}),R]},F))})]}),((o=t.relatedPolicies)==null?void 0:o.length)>0&&n.jsxs("div",{children:[n.jsx("h3",{className:"text-sm font-medium text-gray-500 mb-3",children:"Related Policies"}),n.jsx("div",{className:"flex flex-wrap gap-2",children:t.relatedPolicies.map(R=>{const F=Ou.find($=>$.number===R);return F?n.jsxs("span",{className:"inline-flex items-center gap-1 px-3 py-1 bg-aeria-navy/10 text-aeria-navy rounded-full text-sm",children:[n.jsx(Rie,{className:"w-3 h-3"}),R," - ",F.title]},R):null})})]}),((C=t.keywords)==null?void 0:C.length)>0&&n.jsxs("div",{children:[n.jsx("h3",{className:"text-sm font-medium text-gray-500 mb-3",children:"Keywords"}),n.jsx("div",{className:"flex flex-wrap gap-2",children:t.keywords.map((R,F)=>n.jsx("span",{className:"px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs",children:R},F))})]})]}),n.jsxs("div",{className:"p-4 border-t border-gray-200 bg-gray-50 flex items-center justify-between",children:[n.jsxs("div",{className:"text-sm text-gray-500",children:["Policy ID: ",t.id]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsxs("button",{className:"btn-secondary flex items-center gap-2",children:[n.jsx(C6,{className:"w-4 h-4"}),"Print"]}),n.jsxs("button",{className:"btn-secondary flex items-center gap-2",children:[n.jsx(vc,{className:"w-4 h-4"}),"Download"]}),n.jsxs("button",{className:"btn-primary flex items-center gap-2",children:[n.jsx(yS,{className:"w-4 h-4"}),"View Full Policy"]})]})]})]})})}function Hne({searchQuery:t,categoryFilter:e}){return n.jsxs("div",{className:"text-center py-12",children:[n.jsx(dI,{className:"w-12 h-12 mx-auto text-gray-300 mb-4"}),n.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No policies found"}),n.jsx("p",{className:"text-gray-500",children:t?`No policies match "${t}"`:e?"No policies in this category":"No policies available"})]})}function Wne(){return n.jsxs("div",{className:"space-y-6 animate-pulse",children:[n.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:n.jsxs("div",{className:"flex items-start justify-between",children:[n.jsxs("div",{children:[n.jsx("div",{className:"h-8 w-64 bg-gray-200 rounded mb-2"}),n.jsx("div",{className:"h-4 w-48 bg-gray-100 rounded"})]}),n.jsx("div",{className:"flex items-center gap-4",children:[1,2,3,4].map(t=>n.jsxs("div",{className:"text-center px-4",children:[n.jsx("div",{className:"h-8 w-12 bg-gray-200 rounded mx-auto mb-1"}),n.jsx("div",{className:"h-3 w-10 bg-gray-100 rounded mx-auto"})]},t))})]})}),n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4 space-y-4",children:[n.jsx("div",{className:"h-10 bg-gray-100 rounded-lg"}),n.jsx("div",{className:"flex gap-2",children:[1,2,3,4].map(t=>n.jsx("div",{className:"h-8 w-24 bg-gray-100 rounded-full"},t))})]}),n.jsx("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[1,2,3,4,5].map(t=>n.jsx("div",{className:"p-4 border-b border-gray-100",children:n.jsxs("div",{className:"flex items-center gap-4",children:[n.jsx("div",{className:"h-10 w-10 bg-gray-200 rounded-lg"}),n.jsxs("div",{className:"flex-1",children:[n.jsx("div",{className:"h-5 w-48 bg-gray-200 rounded mb-2"}),n.jsx("div",{className:"h-4 w-96 bg-gray-100 rounded"})]}),n.jsx("div",{className:"h-6 w-20 bg-gray-100 rounded-full"})]})},t))})]})}function Zne(){const[t,e]=ue.useState(!0),[r,c]=ue.useState(""),[h,x]=ue.useState(null),[w,o]=ue.useState("list"),[C,R]=ue.useState("number"),[F,$]=ue.useState("asc"),[Y,H]=ue.useState(null);ue.useEffect(()=>{const de=setTimeout(()=>{e(!1)},300);return()=>clearTimeout(de)},[]);const X=ue.useMemo(()=>{let de=[...Ou];if(h&&(de=de.filter(K=>K.category===h)),r){const K=r.toLowerCase();de=de.filter(ge=>{var Ae;return ge.number.includes(K)||ge.title.toLowerCase().includes(K)||ge.description.toLowerCase().includes(K)||((Ae=ge.keywords)==null?void 0:Ae.some(Te=>Te.toLowerCase().includes(K)))})}return de.sort((K,ge)=>{let Ae=0;switch(C){case"number":Ae=K.number.localeCompare(ge.number,void 0,{numeric:!0});break;case"title":Ae=K.title.localeCompare(ge.title);break;case"date":Ae=new Date(K.effectiveDate)-new Date(ge.effectiveDate);break;default:Ae=0}return F==="asc"?Ae:-Ae}),de},[r,h,C,F]),he=ue.useMemo(()=>{const de=Ou.length,K=Ou.filter(Te=>xp(Te).status==="active").length,ge=Ou.filter(Te=>xp(Te).status==="due").length,Ae=Ou.filter(Te=>xp(Te).status==="overdue").length;return{all:de,active:K,due:ge,overdue:Ae}},[]),se=de=>{C===de?$(K=>K==="asc"?"desc":"asc"):(R(de),$("asc"))};return t?n.jsx(Wne,{}):n.jsxs("div",{className:"space-y-6",children:[n.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:n.jsxs("div",{className:"flex items-start justify-between",children:[n.jsxs("div",{children:[n.jsxs("h1",{className:"text-2xl font-bold text-gray-900 flex items-center gap-3",children:[n.jsx(uie,{className:"w-7 h-7 text-aeria-navy"}),"Policy & Procedure Library"]}),n.jsx("p",{className:"text-gray-500 mt-1",children:"Access and manage organizational policies and procedures"})]}),n.jsxs("div",{className:"flex items-center gap-4",children:[n.jsxs("div",{className:"text-center px-4",children:[n.jsx("p",{className:"text-2xl font-bold text-gray-900",children:he.all}),n.jsx("p",{className:"text-xs text-gray-500",children:"Total"})]}),n.jsxs("div",{className:"text-center px-4 border-l border-gray-200",children:[n.jsx("p",{className:"text-2xl font-bold text-green-600",children:he.active}),n.jsx("p",{className:"text-xs text-gray-500",children:"Active"})]}),n.jsxs("div",{className:"text-center px-4 border-l border-gray-200",children:[n.jsx("p",{className:"text-2xl font-bold text-amber-600",children:he.due}),n.jsx("p",{className:"text-xs text-gray-500",children:"Due"})]}),n.jsxs("div",{className:"text-center px-4 border-l border-gray-200",children:[n.jsx("p",{className:"text-2xl font-bold text-red-600",children:he.overdue}),n.jsx("p",{className:"text-xs text-gray-500",children:"Overdue"})]})]})]})}),n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4 space-y-4",children:[n.jsxs("div",{className:"flex items-center gap-4",children:[n.jsxs("div",{className:"flex-1 relative",children:[n.jsx(nu,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"}),n.jsx("input",{type:"text",placeholder:"Search by number, title, or keyword...",value:r,onChange:de=>c(de.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-aeria-navy focus:border-transparent"}),r&&n.jsx("button",{onClick:()=>c(""),className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600",children:n.jsx(cs,{className:"w-4 h-4"})})]}),n.jsxs("div",{className:"flex items-center border border-gray-300 rounded-lg overflow-hidden",children:[n.jsx("button",{onClick:()=>o("list"),className:`p-2 ${w==="list"?"bg-aeria-navy text-white":"bg-white text-gray-500 hover:bg-gray-50"}`,children:n.jsx(Die,{className:"w-5 h-5"})}),n.jsx("button",{onClick:()=>o("grid"),className:`p-2 ${w==="grid"?"bg-aeria-navy text-white":"bg-white text-gray-500 hover:bg-gray-50"}`,children:n.jsx(Nie,{className:"w-5 h-5"})})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("span",{className:"text-sm text-gray-500",children:"Sort:"}),n.jsxs("button",{onClick:()=>se("number"),className:`px-3 py-1 text-sm rounded ${C==="number"?"bg-aeria-navy text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:["Number ",C==="number"&&(F==="asc"?"":"")]}),n.jsxs("button",{onClick:()=>se("title"),className:`px-3 py-1 text-sm rounded ${C==="title"?"bg-aeria-navy text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:["Title ",C==="title"&&(F==="asc"?"":"")]}),n.jsxs("button",{onClick:()=>se("date"),className:`px-3 py-1 text-sm rounded ${C==="date"?"bg-aeria-navy text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:["Date ",C==="date"&&(F==="asc"?"":"")]})]})]}),n.jsx($ne,{selected:h,onChange:x})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("p",{className:"text-sm text-gray-500",children:["Showing ",X.length," of ",Ou.length," policies"]}),(r||h)&&n.jsx("button",{onClick:()=>{c(""),x(null)},className:"text-sm text-aeria-navy hover:underline",children:"Clear filters"})]}),X.length===0?n.jsx(Hne,{searchQuery:r,categoryFilter:h}):w==="list"?n.jsx("div",{className:"space-y-2",children:X.map(de=>n.jsx(b3,{policy:de,view:"list",onClick:()=>H(de)},de.id))}):n.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:X.map(de=>n.jsx(b3,{policy:de,view:"grid",onClick:()=>H(de)},de.id))}),Y&&n.jsx(Gne,{policy:Y,onClose:()=>H(null)})]})}function Xne(t){var R,F;const e=(t==null?void 0:t.soraAssessment)||{},r=e.populationCategory||((F=(R=t==null?void 0:t.siteSurvey)==null?void 0:R.population)==null?void 0:F.category)||"sparsely",c=e.uaCharacteristics||"1m_25ms",h=RT(r,c),x=kT(h,e.mitigations||{}),w=e.initialARC||"ARC-b",o=DT(w,e.tmpr||{});return{sail:MT(x,o),fGRC:x,residualARC:o}}const Yne=()=>{const t=Ou.length,e=Ou.filter(c=>xp(c).status==="due").length,r=Ou.filter(c=>xp(c).status==="overdue").length;return{totalPolicies:t,reviewDue:e,reviewOverdue:r}};function Kne(){const{userProfile:t}=iu(),[e,r]=ue.useState(!0),[c,h]=ue.useState({activeProjects:0,formsThisWeek:0,expiringCerts:0,completedToday:0,totalSites:0}),[x,w]=ue.useState([]),[o,C]=ue.useState([]),[R,F]=ue.useState([]),[$,Y]=ue.useState({}),[H,X]=ue.useState([]),he=ue.useMemo(()=>Yne(),[]);ue.useEffect(()=>{se()},[]);const se=async()=>{r(!0);try{const[ne,ae,q]=await Promise.all([ET(),sU(),rx()]);X(ne);const oe=ne.filter(tt=>tt.status==="active").length,ke=ae.filter(tt=>{if(!tt.createdAt)return!1;const zt=tt.createdAt.toDate?tt.createdAt.toDate():new Date(tt.createdAt);return kne(zt)}).length,Ve=ae.filter(tt=>{if(!tt.completedAt)return!1;const zt=tt.completedAt.toDate?tt.completedAt.toDate():new Date(tt.completedAt);return Dne(zt)}).length,ie=h3(new Date,30),ze=q.filter(tt=>(tt.certifications||[]).some(vt=>{if(!vt.expiryDate)return!1;const Ot=new Date(vt.expiryDate);return _3(Ot,ie)})),ve=ze.length;let Le=0;const Ke={I:0,II:0,III:0,IV:0,V:0,VI:0};ne.forEach(tt=>{var vt;const zt=Array.isArray(tt.sites)?tt.sites:[];if(Le+=zt.length||1,zt.forEach(Ot=>{const Et=Xne(Ot);Et.sail&&Ke[Et.sail]!==void 0&&Ke[Et.sail]++}),zt.length===0&&((vt=tt.soraAssessment)!=null&&vt.sail)){const Ot=tt.soraAssessment.sail;Ke[Ot]!==void 0&&Ke[Ot]++}}),Y(Ke),h({activeProjects:oe,formsThisWeek:ke,expiringCerts:ve,completedToday:Ve,totalSites:Le});const Pe=[...ne].sort((tt,zt)=>{var Et,yi;const vt=(Et=tt.updatedAt)!=null&&Et.toDate?tt.updatedAt.toDate():new Date(tt.updatedAt||0);return((yi=zt.updatedAt)!=null&&yi.toDate?zt.updatedAt.toDate():new Date(zt.updatedAt||0))-vt}).slice(0,5);w(Pe);const It=[...ae].sort((tt,zt)=>{var Et,yi;const vt=(Et=tt.createdAt)!=null&&Et.toDate?tt.createdAt.toDate():new Date(tt.createdAt||0);return((yi=zt.createdAt)!=null&&yi.toDate?zt.createdAt.toDate():new Date(zt.createdAt||0))-vt}).slice(0,5);C(It),F(ze)}catch(ne){console.error("Error loading dashboard data:",ne)}finally{r(!1)}},de=()=>{const ne=new Date().getHours();return ne<12?"Good morning":ne<18?"Good afternoon":"Good evening"},K=ne=>{var q;const ae=ne.startDate||((q=ne.dates)==null?void 0:q.startDate);if(!ae)return"No date";try{return bc(new Date(ae),"MMM d")}catch{return"Invalid date"}},ge={draft:"bg-gray-100 text-gray-700",planning:"bg-blue-100 text-blue-700",active:"bg-green-100 text-green-700",completed:"bg-purple-100 text-purple-700",archived:"bg-gray-100 text-gray-500"},Ae=ue.useMemo(()=>{const ne=["I","II","III","IV","V","VI"];let ae=-1;return Object.entries($).forEach(([q,oe])=>{if(oe>0){const ke=ne.indexOf(q);ke>ae&&(ae=ke)}}),ae>=0?ne[ae]:null},[$]),Te=Object.values($).reduce((ne,ae)=>ne+ae,0),Ce=[{name:"Active Projects",value:c.activeProjects,icon:Zm,color:"bg-blue-500",link:"/projects?status=active"},{name:"Operation Sites",value:c.totalSites,icon:Wn,color:"bg-indigo-500",link:"/projects"},{name:"Forms This Week",value:c.formsThisWeek,icon:Ll,color:"bg-green-500",link:"/forms"},{name:"Expiring Certs",value:c.expiringCerts,icon:ir,color:c.expiringCerts>0?"bg-amber-500":"bg-gray-400",link:"/operators"}];return n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{children:[n.jsxs("h1",{className:"text-2xl font-bold text-gray-900",children:[de(),", ",(t==null?void 0:t.firstName)||"there"]}),n.jsx("p",{className:"text-gray-600 mt-1",children:"Here's what's happening with your operations."})]}),n.jsxs("div",{className:"flex flex-wrap gap-3",children:[n.jsxs(dr,{to:"/projects",className:"btn-primary inline-flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"New Project"]}),n.jsxs(dr,{to:"/forms",className:"btn-secondary inline-flex items-center gap-2",children:[n.jsx(Ll,{className:"w-4 h-4"}),"Start Form"]}),n.jsxs(dr,{to:"/policies",className:"btn-secondary inline-flex items-center gap-2",children:[n.jsx(yS,{className:"w-4 h-4"}),"View Policies"]})]}),e?n.jsx("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[1,2,3,4].map(ne=>n.jsx("div",{className:"card animate-pulse",children:n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("div",{className:"p-2 rounded-lg bg-gray-200 w-9 h-9"}),n.jsxs("div",{children:[n.jsx("div",{className:"h-6 w-8 bg-gray-200 rounded mb-1"}),n.jsx("div",{className:"h-4 w-20 bg-gray-100 rounded"})]})]})},ne))}):n.jsx("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:Ce.map(ne=>n.jsx(dr,{to:ne.link,className:"card hover:shadow-md transition-shadow",children:n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("div",{className:`p-2 rounded-lg ${ne.color}`,children:n.jsx(ne.icon,{className:"w-5 h-5 text-white"})}),n.jsxs("div",{children:[n.jsx("p",{className:"text-2xl font-bold text-gray-900",children:ne.value}),n.jsx("p",{className:"text-sm text-gray-500",children:ne.name})]})]})},ne.name))}),!e&&n.jsxs("div",{className:"grid lg:grid-cols-2 gap-6",children:[n.jsxs("div",{className:"card",children:[n.jsxs("div",{className:"flex items-center justify-between mb-4",children:[n.jsxs("h2",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[n.jsx(Ds,{className:"w-5 h-5 text-aeria-navy"}),"SORA Overview"]}),Ae&&n.jsxs("span",{className:"px-3 py-1 rounded-full text-sm font-bold",style:{backgroundColor:Ld[Ae],color:Ae==="I"||Ae==="II"?"#1F2937":"#FFFFFF"},children:["Max SAIL ",Ae]})]}),Te>0?n.jsxs(n.Fragment,{children:[n.jsxs("p",{className:"text-sm text-gray-600 mb-4",children:[Te," site",Te!==1?"s":""," with SORA assessments"]}),n.jsxs("div",{className:"space-y-2",children:[n.jsx("div",{className:"flex h-4 rounded-full overflow-hidden bg-gray-100",children:["I","II","III","IV","V","VI"].map(ne=>{const ae=$[ne]||0,q=Te>0?ae/Te*100:0;return q===0?null:n.jsx("div",{className:"h-full transition-all",style:{width:`${q}%`,backgroundColor:Ld[ne]},title:`SAIL ${ne}: ${ae}`},ne)})}),n.jsx("div",{className:"flex flex-wrap gap-3 mt-3",children:["I","II","III","IV","V","VI"].map(ne=>{const ae=$[ne]||0;return ae===0?null:n.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[n.jsx("div",{className:"w-3 h-3 rounded",style:{backgroundColor:Ld[ne]}}),n.jsxs("span",{className:"text-gray-600",children:["SAIL ",ne,": ",ae]})]},ne)})})]})]}):n.jsxs("div",{className:"text-center py-6 text-gray-500",children:[n.jsx(Ds,{className:"w-10 h-10 mx-auto mb-2 text-gray-300"}),n.jsx("p",{children:"No SORA assessments completed"}),n.jsx("p",{className:"text-sm mt-1",children:"Complete site surveys and flight plans to generate assessments"})]})]}),n.jsxs("div",{className:"card",children:[n.jsxs("div",{className:"flex items-center justify-between mb-4",children:[n.jsxs("h2",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[n.jsx(yS,{className:"w-5 h-5 text-aeria-navy"}),"Policy Library"]}),n.jsx(dr,{to:"/policies",className:"text-sm text-aeria-blue hover:text-aeria-navy",children:"View all "})]}),n.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-4",children:[n.jsxs("div",{className:"text-center p-3 bg-gray-50 rounded-lg",children:[n.jsx("p",{className:"text-2xl font-bold text-gray-900",children:he.totalPolicies}),n.jsx("p",{className:"text-xs text-gray-500",children:"Total Policies"})]}),n.jsxs("div",{className:"text-center p-3 bg-amber-50 rounded-lg",children:[n.jsx("p",{className:"text-2xl font-bold text-amber-600",children:he.reviewDue}),n.jsx("p",{className:"text-xs text-amber-700",children:"Review Due"})]}),n.jsxs("div",{className:"text-center p-3 bg-red-50 rounded-lg",children:[n.jsx("p",{className:"text-2xl font-bold text-red-600",children:he.reviewOverdue}),n.jsx("p",{className:"text-xs text-red-700",children:"Overdue"})]})]}),(he.reviewDue>0||he.reviewOverdue>0)&&n.jsx("div",{className:"p-3 bg-amber-50 border border-amber-200 rounded-lg",children:n.jsxs("div",{className:"flex items-start gap-2",children:[n.jsx(Cs,{className:"w-4 h-4 text-amber-600 flex-shrink-0 mt-0.5"}),n.jsxs("div",{children:[n.jsx("p",{className:"text-sm font-medium text-amber-900",children:"Policy Review Required"}),n.jsxs("p",{className:"text-xs text-amber-700 mt-0.5",children:[he.reviewDue+he.reviewOverdue," policies need review"]})]})]})}),n.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-100",children:[n.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"Quick Access"}),n.jsxs("div",{className:"flex flex-wrap gap-2",children:[n.jsx(dr,{to:"/policies?category=rpas",className:"px-3 py-1.5 text-xs bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200",children:"RPAS Operations"}),n.jsx(dr,{to:"/policies?category=crm",className:"px-3 py-1.5 text-xs bg-purple-100 text-purple-700 rounded-full hover:bg-purple-200",children:"CRM"}),n.jsx(dr,{to:"/policies?category=hse",className:"px-3 py-1.5 text-xs bg-orange-100 text-orange-700 rounded-full hover:bg-orange-200",children:"HSE"})]})]})]})]}),n.jsxs("div",{className:"grid lg:grid-cols-2 gap-6",children:[n.jsxs("div",{className:"card",children:[n.jsxs("div",{className:"flex items-center justify-between mb-4",children:[n.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Recent Projects"}),n.jsxs(dr,{to:"/projects",className:"text-sm text-aeria-blue hover:text-aeria-navy inline-flex items-center gap-1",children:["View all",n.jsx(fc,{className:"w-4 h-4"})]})]}),e?n.jsx("div",{className:"space-y-3",children:[1,2,3].map(ne=>n.jsxs("div",{className:"animate-pulse flex items-center gap-3 p-2",children:[n.jsx("div",{className:"w-8 h-8 bg-gray-200 rounded"}),n.jsxs("div",{className:"flex-1",children:[n.jsx("div",{className:"h-4 w-32 bg-gray-200 rounded mb-1"}),n.jsx("div",{className:"h-3 w-24 bg-gray-100 rounded"})]})]},ne))}):x.length===0?n.jsxs("div",{className:"text-center py-8 text-gray-500",children:[n.jsx(Zm,{className:"w-10 h-10 mx-auto mb-2 text-gray-300"}),n.jsx("p",{children:"No projects yet"}),n.jsx(dr,{to:"/projects",className:"text-sm text-aeria-blue hover:underline mt-1 inline-block",children:"Create your first project"})]}):n.jsx("div",{className:"space-y-2",children:x.map(ne=>{const q=(Array.isArray(ne.sites)?ne.sites:[]).length;return n.jsxs(dr,{to:`/projects/${ne.id}`,className:"flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 transition-colors",children:[n.jsx("div",{className:"w-8 h-8 bg-aeria-sky rounded flex items-center justify-center flex-shrink-0",children:n.jsx(Zm,{className:"w-4 h-4 text-aeria-navy"})}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsx("p",{className:"font-medium text-gray-900 truncate",children:ne.name}),n.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[n.jsx("span",{children:K(ne)}),q>0&&n.jsxs("span",{className:"flex items-center gap-1",children:[n.jsx(vT,{className:"w-3 h-3"}),q," site",q!==1?"s":""]}),n.jsx("span",{className:`px-1.5 py-0.5 rounded ${ge[ne.status]}`,children:ne.status})]})]}),n.jsx(fc,{className:"w-4 h-4 text-gray-400"})]},ne.id)})})]}),n.jsxs("div",{className:"card",children:[n.jsxs("div",{className:"flex items-center justify-between mb-4",children:[n.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Recent Forms"}),n.jsxs(dr,{to:"/forms",className:"text-sm text-aeria-blue hover:text-aeria-navy inline-flex items-center gap-1",children:["View all",n.jsx(fc,{className:"w-4 h-4"})]})]}),e?n.jsx("div",{className:"space-y-3",children:[1,2,3].map(ne=>n.jsxs("div",{className:"animate-pulse flex items-center gap-3 p-2",children:[n.jsx("div",{className:"w-8 h-8 bg-gray-200 rounded"}),n.jsxs("div",{className:"flex-1",children:[n.jsx("div",{className:"h-4 w-32 bg-gray-200 rounded mb-1"}),n.jsx("div",{className:"h-3 w-24 bg-gray-100 rounded"})]})]},ne))}):o.length===0?n.jsxs("div",{className:"text-center py-8 text-gray-500",children:[n.jsx(Ll,{className:"w-10 h-10 mx-auto mb-2 text-gray-300"}),n.jsx("p",{children:"No forms completed"}),n.jsx(dr,{to:"/forms",className:"text-sm text-aeria-blue hover:underline mt-1 inline-block",children:"Start a form"})]}):n.jsx("div",{className:"space-y-2",children:o.map(ne=>{var ae;return n.jsxs("div",{className:"flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 transition-colors",children:[n.jsx("div",{className:"w-8 h-8 bg-green-100 rounded flex items-center justify-center flex-shrink-0",children:n.jsx(Ll,{className:"w-4 h-4 text-green-600"})}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsx("p",{className:"font-medium text-gray-900 truncate",children:ne.type||"Form"}),n.jsx("p",{className:"text-xs text-gray-500",children:(ae=ne.createdAt)!=null&&ae.toDate?bc(ne.createdAt.toDate(),"MMM d, h:mm a"):"Unknown date"})]}),n.jsx("span",{className:`text-xs px-2 py-0.5 rounded ${ne.status==="completed"?"bg-green-100 text-green-700":"bg-gray-100 text-gray-600"}`,children:ne.status||"draft"})]},ne.id)})})]})]}),!e&&R.length>0?n.jsx("div",{className:"card border-amber-200 bg-amber-50",children:n.jsxs("div",{className:"flex items-start gap-3",children:[n.jsx(ir,{className:"w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5"}),n.jsxs("div",{className:"flex-1",children:[n.jsx("h3",{className:"font-medium text-amber-900",children:"Certification Alerts"}),n.jsxs("p",{className:"text-sm text-amber-700 mt-1",children:[R.length," operator",R.length>1?"s have":" has"," certifications expiring within 30 days."]}),n.jsx("div",{className:"mt-3 space-y-2",children:R.slice(0,3).map(ne=>{var ae;return n.jsxs("div",{className:"flex items-center gap-2 text-sm text-amber-800",children:[n.jsx(ds,{className:"w-4 h-4"}),n.jsxs("span",{className:"font-medium",children:[ne.firstName," ",ne.lastName]}),n.jsxs("span",{className:"text-amber-600",children:["- ",(ae=ne.certifications)==null?void 0:ae.filter(q=>{if(!q.expiryDate)return!1;const oe=new Date(q.expiryDate);return _3(oe,h3(new Date,30))}).map(q=>q.type||q.name).join(", ")]})]},ne.id)})}),n.jsx(dr,{to:"/operators",className:"text-sm text-amber-800 font-medium hover:underline mt-3 inline-block",children:"View all operators "})]})]})}):e?null:n.jsx("div",{className:"card border-green-200 bg-green-50",children:n.jsxs("div",{className:"flex items-start gap-3",children:[n.jsx(qr,{className:"w-5 h-5 text-green-600 flex-shrink-0 mt-0.5"}),n.jsxs("div",{children:[n.jsx("h3",{className:"font-medium text-green-900",children:"All Certifications Current"}),n.jsx("p",{className:"text-sm text-green-700 mt-1",children:"No certifications are expiring in the next 30 days."}),n.jsx(dr,{to:"/operators",className:"text-sm text-green-800 font-medium hover:underline mt-2 inline-block",children:"Manage operators "})]})]})})]})}function Lj({isOpen:t,onClose:e,title:r,children:c,size:h="md",showClose:x=!0}){if(ue.useEffect(()=>{const o=C=>{C.key==="Escape"&&e()};return t&&(document.addEventListener("keydown",o),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",o),document.body.style.overflow="unset"}},[t,e]),!t)return null;const w={sm:"max-w-md",md:"max-w-lg",lg:"max-w-2xl",xl:"max-w-4xl",full:"max-w-6xl"};return n.jsxs("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:[n.jsx("div",{className:"fixed inset-0 bg-black/50 transition-opacity",onClick:e}),n.jsx("div",{className:"flex min-h-full items-center justify-center p-4",children:n.jsxs("div",{className:`relative w-full ${w[h]} bg-white rounded-xl shadow-xl transform transition-all`,onClick:o=>o.stopPropagation(),children:[(r||x)&&n.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-gray-200",children:[r&&n.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:r}),x&&n.jsx("button",{onClick:e,className:"p-1 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100 transition-colors",children:n.jsx(cs,{className:"w-5 h-5"})})]}),n.jsx("div",{className:"px-6 py-4",children:c})]})})]})}function Fj({children:t}){return n.jsx("div",{className:"flex items-center justify-end gap-3 pt-4 mt-4 border-t border-gray-200",children:t})}function Qne({isOpen:t,onClose:e}){const r=tu(),{user:c}=iu(),[h,x]=ue.useState(!1),[w,o]=ue.useState(""),[C,R]=ue.useState([]),[F,$]=ue.useState(!0),[Y,H]=ue.useState(!1),[X,he]=ue.useState({name:"",projectCode:"",clientId:"",clientName:"",dateType:"single",startDate:"",endDate:"",description:""}),[se,de]=ue.useState({name:"",shortName:""});ue.useEffect(()=>{t&&K()},[t]);const K=async()=>{$(!0);try{const oe=await ix();R(oe)}catch(oe){console.error("Error loading clients:",oe)}finally{$(!1)}},ge=oe=>{const{name:ke,value:Ve}=oe.target;if(he(ie=>({...ie,[ke]:Ve})),ke==="clientId"&&Ve){const ie=C.find(ze=>ze.id===Ve);if(ie){const ze=new Date().getFullYear(),ve=`${ie.shortName||ie.name.substring(0,3).toUpperCase()}-${ze}-001`;he(Le=>({...Le,clientId:Ve,clientName:ie.name,projectCode:Le.projectCode||ve}))}}},Ae=oe=>{const{name:ke,value:Ve}=oe.target;if(de(ie=>({...ie,[ke]:Ve})),ke==="name"&&!se.shortName){const ie=Ve.split(" ").map(ze=>ze[0]).join("").toUpperCase().substring(0,4);de(ze=>({...ze,shortName:ie}))}},Te=async()=>{if(se.name.trim())try{const oe=await Dj({name:se.name.trim(),shortName:se.shortName.trim()||se.name.substring(0,3).toUpperCase()});R(ke=>[...ke,oe]),he(ke=>({...ke,clientId:oe.id,clientName:oe.name})),H(!1),de({name:"",shortName:""})}catch{o("Failed to create client")}},Ce=async oe=>{oe.preventDefault(),o(""),x(!0);try{if(!X.name.trim())throw new Error("Project name is required");if(!X.startDate)throw new Error("Start date is required");if(X.dateType==="range"&&!X.endDate)throw new Error("End date is required for date range");if(X.dateType==="range"&&X.endDate<X.startDate)throw new Error("End date must be after start date");const ke={name:X.name.trim(),projectCode:X.projectCode.trim()||ne(),clientId:X.clientId||null,clientName:X.clientName||"No Client",dates:{type:X.dateType,startDate:X.startDate,endDate:X.dateType==="range"?X.endDate:X.startDate},description:X.description.trim(),objectives:"",deliverables:"",authorization:"",createdBy:c.uid},Ve=await W6(ke);e(),r(`/projects/${Ve.id}`)}catch(ke){o(ke.message)}finally{x(!1)}},ne=()=>{const oe=new Date().getFullYear(),ke=Math.random().toString(36).substring(2,5).toUpperCase();return`PRJ-${oe}-${ke}`},ae=()=>{he({name:"",projectCode:"",clientId:"",clientName:"",dateType:"single",startDate:"",endDate:"",description:""}),o(""),H(!1)},q=()=>{ae(),e()};return n.jsx(Lj,{isOpen:t,onClose:q,title:"New Project",size:"lg",children:n.jsxs("form",{onSubmit:Ce,children:[w&&n.jsxs("div",{className:"flex items-center gap-2 p-3 mb-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm",children:[n.jsx(Cs,{className:"w-4 h-4 flex-shrink-0"}),n.jsx("span",{children:w})]}),n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{children:[n.jsxs("label",{htmlFor:"name",className:"label",children:["Project Name ",n.jsx("span",{className:"text-red-500",children:"*"})]}),n.jsx("input",{id:"name",name:"name",type:"text",value:X.name,onChange:ge,className:"input",placeholder:"e.g., Quintette Mine Survey",autoFocus:!0})]}),n.jsxs("div",{children:[n.jsx("label",{htmlFor:"clientId",className:"label",children:"Client"}),Y?n.jsxs("div",{className:"space-y-3 p-3 bg-gray-50 rounded-lg",children:[n.jsxs("div",{children:[n.jsx("label",{className:"label text-xs",children:"Client Name"}),n.jsx("input",{type:"text",name:"name",value:se.name,onChange:Ae,className:"input",placeholder:"e.g., Pacific Salmon Foundation"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label text-xs",children:"Short Name (for project codes)"}),n.jsx("input",{type:"text",name:"shortName",value:se.shortName,onChange:Ae,className:"input",placeholder:"e.g., PSF",maxLength:6})]}),n.jsxs("div",{className:"flex gap-2",children:[n.jsx("button",{type:"button",onClick:Te,className:"btn-primary text-sm",disabled:!se.name.trim(),children:"Add Client"}),n.jsx("button",{type:"button",onClick:()=>H(!1),className:"btn-secondary text-sm",children:"Cancel"})]})]}):n.jsxs("div",{className:"flex gap-2",children:[n.jsxs("select",{id:"clientId",name:"clientId",value:X.clientId,onChange:ge,className:"input flex-1",disabled:F,children:[n.jsx("option",{value:"",children:"Select a client..."}),C.map(oe=>n.jsx("option",{value:oe.id,children:oe.name},oe.id))]}),n.jsxs("button",{type:"button",onClick:()=>H(!0),className:"btn-secondary inline-flex items-center gap-1",title:"Add new client",children:[n.jsx(vr,{className:"w-4 h-4"}),n.jsx(Vl,{className:"w-4 h-4"})]})]})]}),n.jsxs("div",{children:[n.jsxs("label",{htmlFor:"projectCode",className:"label",children:["Project Code",n.jsx("span",{className:"text-gray-400 font-normal ml-1",children:"(auto-generated if blank)"})]}),n.jsx("input",{id:"projectCode",name:"projectCode",type:"text",value:X.projectCode,onChange:ge,className:"input",placeholder:"e.g., PSF-2026-001"})]}),n.jsxs("div",{children:[n.jsxs("label",{className:"label",children:["Project Date(s) ",n.jsx("span",{className:"text-red-500",children:"*"})]}),n.jsxs("div",{className:"flex gap-4 mb-3",children:[n.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[n.jsx("input",{type:"radio",name:"dateType",value:"single",checked:X.dateType==="single",onChange:ge,className:"w-4 h-4 text-aeria-navy"}),n.jsx("span",{className:"text-sm",children:"Single Day"})]}),n.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[n.jsx("input",{type:"radio",name:"dateType",value:"range",checked:X.dateType==="range",onChange:ge,className:"w-4 h-4 text-aeria-navy"}),n.jsx("span",{className:"text-sm",children:"Date Range"})]})]}),n.jsxs("div",{className:"flex gap-3",children:[n.jsxs("div",{className:"flex-1",children:[n.jsx("label",{htmlFor:"startDate",className:"label text-xs",children:X.dateType==="single"?"Date":"Start Date"}),n.jsx("input",{id:"startDate",name:"startDate",type:"date",value:X.startDate,onChange:ge,className:"input"})]}),X.dateType==="range"&&n.jsxs("div",{className:"flex-1",children:[n.jsx("label",{htmlFor:"endDate",className:"label text-xs",children:"End Date"}),n.jsx("input",{id:"endDate",name:"endDate",type:"date",value:X.endDate,onChange:ge,min:X.startDate,className:"input"})]})]})]}),n.jsxs("div",{children:[n.jsx("label",{htmlFor:"description",className:"label",children:"Description"}),n.jsx("textarea",{id:"description",name:"description",value:X.description,onChange:ge,className:"input min-h-[100px]",placeholder:"Brief overview of the project scope and purpose..."})]})]}),n.jsxs(Fj,{children:[n.jsx("button",{type:"button",onClick:q,className:"btn-secondary",children:"Cancel"}),n.jsx("button",{type:"submit",disabled:h,className:"btn-primary",children:h?"Creating...":"Create Project"})]})]})})}const Jne={draft:"bg-gray-100 text-gray-700",planning:"bg-blue-100 text-blue-700",active:"bg-green-100 text-green-700",completed:"bg-purple-100 text-purple-700",archived:"bg-gray-100 text-gray-500"},ese={draft:"Draft",planning:"Planning",active:"Active",completed:"Completed",archived:"Archived"};function tse(){const t=tu(),[e,r]=ue.useState([]),[c,h]=ue.useState([]),[x,w]=ue.useState(!0),[o,C]=ue.useState(""),[R,F]=ue.useState("all"),[$,Y]=ue.useState(!1),[H,X]=ue.useState(null);ue.useEffect(()=>{he()},[]);const he=async()=>{w(!0);try{const[Ae,Te]=await Promise.all([ET(),ix()]);r(Ae),h(Te)}catch(Ae){console.error("Error loading data:",Ae)}finally{w(!1)}},se=Ae=>Ae.clientId&&c.find(Te=>Te.id===Ae.clientId)||null,de=async(Ae,Te)=>{if(confirm(`Are you sure you want to delete "${Te}"? This cannot be undone.`)){try{await kj(Ae),r(Ce=>Ce.filter(ne=>ne.id!==Ae))}catch(Ce){console.error("Error deleting project:",Ce),alert("Failed to delete project")}X(null)}},K=e.filter(Ae=>{var ne,ae;const Te=Ae.name.toLowerCase().includes(o.toLowerCase())||((ne=Ae.projectCode)==null?void 0:ne.toLowerCase().includes(o.toLowerCase()))||((ae=Ae.clientName)==null?void 0:ae.toLowerCase().includes(o.toLowerCase())),Ce=R==="all"||Ae.status===R;return Te&&Ce}),ge=Ae=>{if(!(Ae!=null&&Ae.startDate))return"No date set";try{const Te=bc(new Date(Ae.startDate),"MMM d, yyyy");if(Ae.type==="range"&&Ae.endDate&&Ae.endDate!==Ae.startDate){const Ce=bc(new Date(Ae.endDate),"MMM d, yyyy");return`${Te} - ${Ce}`}return Te}catch{return"Invalid date"}};return n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[n.jsxs("div",{children:[n.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Projects"}),n.jsx("p",{className:"text-gray-600 mt-1",children:"Manage your operations plans"})]}),n.jsxs("button",{onClick:()=>Y(!0),className:"btn-primary inline-flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"New Project"]})]}),n.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[n.jsxs("div",{className:"relative flex-1",children:[n.jsx(nu,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),n.jsx("input",{type:"text",placeholder:"Search projects...",value:o,onChange:Ae=>C(Ae.target.value),className:"input pl-9"})]}),n.jsxs("select",{value:R,onChange:Ae=>F(Ae.target.value),className:"input w-full sm:w-40",children:[n.jsx("option",{value:"all",children:"All Status"}),n.jsx("option",{value:"draft",children:"Draft"}),n.jsx("option",{value:"planning",children:"Planning"}),n.jsx("option",{value:"active",children:"Active"}),n.jsx("option",{value:"completed",children:"Completed"}),n.jsx("option",{value:"archived",children:"Archived"})]})]}),x?n.jsxs("div",{className:"card text-center py-12",children:[n.jsx("div",{className:"w-8 h-8 border-4 border-aeria-navy border-t-transparent rounded-full animate-spin mx-auto mb-4"}),n.jsx("p",{className:"text-gray-500",children:"Loading projects..."})]}):K.length===0?n.jsxs("div",{className:"card text-center py-12",children:[n.jsx(Zm,{className:"w-12 h-12 mx-auto mb-4 text-gray-300"}),e.length===0?n.jsxs(n.Fragment,{children:[n.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-1",children:"No projects yet"}),n.jsx("p",{className:"text-gray-500 mb-4",children:"Create your first project to get started with operations planning."}),n.jsxs("button",{onClick:()=>Y(!0),className:"btn-primary inline-flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Create Project"]})]}):n.jsxs(n.Fragment,{children:[n.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-1",children:"No matching projects"}),n.jsx("p",{className:"text-gray-500",children:"Try adjusting your search or filters."})]})]}):n.jsx("div",{className:"space-y-3",children:K.map(Ae=>{const Te=se(Ae);return n.jsx("div",{className:"card hover:shadow-md transition-shadow group cursor-pointer",onClick:()=>t(`/projects/${Ae.id}`),children:n.jsxs("div",{className:"flex items-center gap-4",children:[Te!=null&&Te.logo?n.jsx("div",{className:"w-10 h-10 rounded-lg border bg-white flex items-center justify-center p-1 flex-shrink-0",children:n.jsx("img",{src:Te.logo,alt:Te.name,className:"max-w-full max-h-full object-contain"})}):Ae.clientId?n.jsx("div",{className:"w-10 h-10 bg-gradient-to-br from-aeria-blue to-aeria-navy rounded-lg flex items-center justify-center flex-shrink-0",children:n.jsx(Vl,{className:"w-5 h-5 text-white"})}):n.jsx("div",{className:"w-10 h-10 bg-aeria-sky rounded-lg flex items-center justify-center flex-shrink-0",children:n.jsx(Zm,{className:"w-5 h-5 text-aeria-navy"})}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[n.jsx(dr,{to:`/projects/${Ae.id}`,className:"font-semibold text-gray-900 hover:text-aeria-blue truncate",children:Ae.name}),n.jsx("span",{className:`px-2 py-0.5 text-xs font-medium rounded-full ${Jne[Ae.status]}`,children:ese[Ae.status]})]}),n.jsxs("div",{className:"flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-gray-500",children:[n.jsxs("span",{className:"inline-flex items-center gap-1",children:[n.jsx(il,{className:"w-3.5 h-3.5"}),ge(Ae.dates)]}),Ae.clientName&&n.jsxs("span",{className:"inline-flex items-center gap-1",children:[n.jsx(Vl,{className:"w-3.5 h-3.5"}),Ae.clientName]}),Ae.projectCode&&n.jsx("span",{className:"text-gray-400 font-mono text-xs",children:Ae.projectCode})]})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(dr,{to:`/projects/${Ae.id}`,className:"p-2 text-gray-400 hover:text-aeria-blue rounded-lg hover:bg-gray-100 opacity-0 group-hover:opacity-100 transition-opacity",children:n.jsx(ko,{className:"w-5 h-5"})}),n.jsxs("div",{className:"relative",children:[n.jsx("button",{onClick:Ce=>{Ce.stopPropagation(),X(H===Ae.id?null:Ae.id)},className:"p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100",children:n.jsx(Qd,{className:"w-4 h-4"})}),H===Ae.id&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>X(null)}),n.jsxs("div",{className:"absolute right-0 mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-20",children:[n.jsxs("button",{onClick:Ce=>{Ce.stopPropagation(),alert("Duplicate feature coming soon"),X(null)},className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2",children:[n.jsx(Op,{className:"w-4 h-4"}),"Duplicate"]}),n.jsxs("button",{onClick:Ce=>{Ce.stopPropagation(),de(Ae.id,Ae.name)},className:"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2",children:[n.jsx(Ln,{className:"w-4 h-4"}),"Delete"]})]})]})]})]})]})},Ae.id)})}),n.jsx(Qne,{isOpen:$,onClose:()=>{Y(!1),he()}})]})}function ise({site:t,index:e,calculations:r,onNavigate:c,onSelect:h}){var he,se,de,K,ge,Ae,Te,Ce,ne,ae,q,oe,ke,Ve,ie;const x=(r==null?void 0:r[t.id])||{},w=t.mapData||{},o={siteSurvey:{location:!!((he=w.siteSurvey)!=null&&he.siteLocation),boundary:!!((se=w.siteSurvey)!=null&&se.operationsBoundary),population:!!((K=(de=t.siteSurvey)==null?void 0:de.population)!=null&&K.category)},flightPlan:{launchPoint:!!((ge=w.flightPlan)!=null&&ge.launchPoint),recoveryPoint:!!((Ae=w.flightPlan)!=null&&Ae.recoveryPoint),operationType:!!((Te=t.flightPlan)!=null&&Te.operationType)},emergency:{musterPoint:(((ne=(Ce=w.emergency)==null?void 0:Ce.musterPoints)==null?void 0:ne.length)||0)>0,route:(((q=(ae=w.emergency)==null?void 0:ae.evacuationRoutes)==null?void 0:q.length)||0)>0},sora:{population:!!((oe=t.soraAssessment)!=null&&oe.populationCategory),uaChar:!!((ke=t.soraAssessment)!=null&&ke.uaCharacteristics),sail:!!x.sail}},C=Object.values(o.siteSurvey).every(Boolean),R=Object.values(o.flightPlan).every(Boolean),F=Object.values(o.emergency).every(Boolean),$=Object.values(o.sora).every(Boolean),Y=[...Object.values(o.siteSurvey),...Object.values(o.flightPlan),...Object.values(o.emergency),...Object.values(o.sora)],H=Y.filter(Boolean).length,X=Math.round(H/Y.length*100);return n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden hover:shadow-md transition-shadow",children:[n.jsxs("div",{className:"p-4 cursor-pointer",onClick:()=>h==null?void 0:h(t.id),children:[n.jsxs("div",{className:"flex items-start justify-between mb-3",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("div",{className:"w-10 h-10 rounded-lg flex items-center justify-center text-white font-bold",style:{backgroundColor:`hsl(${e*60}, 70%, 50%)`},children:e+1}),n.jsxs("div",{children:[n.jsx("h3",{className:"font-semibold text-gray-900",children:t.name||`Site ${e+1}`}),n.jsx("p",{className:"text-sm text-gray-500",children:((Ve=t.siteSurvey)==null?void 0:Ve.location)||"Location not set"})]})]}),x.sail&&n.jsxs("span",{className:"px-3 py-1 rounded-full text-sm font-bold",style:{backgroundColor:Ld[x.sail],color:x.sail==="I"||x.sail==="II"?"#1F2937":"#FFFFFF"},children:["SAIL ",x.sail]})]}),n.jsxs("div",{className:"mb-4",children:[n.jsxs("div",{className:"flex items-center justify-between text-xs mb-1",children:[n.jsx("span",{className:"text-gray-500",children:"Completion"}),n.jsxs("span",{className:`font-medium ${X===100?"text-green-600":X>=50?"text-amber-600":"text-gray-600"}`,children:[X,"%"]})]}),n.jsx("div",{className:"w-full bg-gray-200 rounded-full h-1.5",children:n.jsx("div",{className:`h-1.5 rounded-full transition-all ${X===100?"bg-green-500":X>=50?"bg-amber-500":"bg-gray-400"}`,style:{width:`${X}%`}})})]}),n.jsxs("div",{className:"grid grid-cols-4 gap-2 text-xs",children:[n.jsxs("div",{className:`p-2 rounded text-center ${C?"bg-green-50 text-green-700":"bg-gray-50 text-gray-500"}`,children:[n.jsx(Wn,{className:"w-4 h-4 mx-auto mb-1"}),"Survey"]}),n.jsxs("div",{className:`p-2 rounded text-center ${R?"bg-green-50 text-green-700":"bg-gray-50 text-gray-500"}`,children:[n.jsx(Zn,{className:"w-4 h-4 mx-auto mb-1"}),"Flight"]}),n.jsxs("div",{className:`p-2 rounded text-center ${F?"bg-green-50 text-green-700":"bg-gray-50 text-gray-500"}`,children:[n.jsx(lf,{className:"w-4 h-4 mx-auto mb-1"}),"Emergency"]}),n.jsxs("div",{className:`p-2 rounded text-center ${$?"bg-green-50 text-green-700":"bg-gray-50 text-gray-500"}`,children:[n.jsx(Ds,{className:"w-4 h-4 mx-auto mb-1"}),"SORA"]})]})]}),n.jsxs("div",{className:"px-4 py-2 bg-gray-50 border-t border-gray-100 flex items-center justify-between",children:[n.jsxs("span",{className:"text-xs text-gray-500",children:[((ie=t.flightPlan)==null?void 0:ie.operationType)||"VLOS","  GRC: ",x.fGRC??"?"]}),n.jsxs("button",{onClick:()=>h==null?void 0:h(t.id),className:"text-xs text-aeria-navy hover:underline flex items-center gap-1",children:["View Details",n.jsx(ko,{className:"w-3 h-3"})]})]})]})}function w3({project:t,sites:e,calculations:r}){const c=ue.useMemo(()=>{const w=["I","II","III","IV","V","VI"];let o=-1;return e.forEach(C=>{const R=r[C.id],F=w.indexOf(R==null?void 0:R.sail);F>o&&(o=F)}),o>=0?w[o]:null},[e,r]),h=ue.useMemo(()=>e.every(w=>{const o=r[w.id];return(o==null?void 0:o.fGRC)===null||(o==null?void 0:o.fGRC)<=7}),[e,r]),x=[...new Set(e.map(w=>{var o;return((o=w.flightPlan)==null?void 0:o.operationType)||"VLOS"}))];return n.jsx("div",{className:"bg-gradient-to-r from-aeria-navy to-aeria-navy/80 text-white rounded-xl p-6",children:n.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center justify-between gap-4",children:[n.jsxs("div",{children:[n.jsx("h1",{className:"text-2xl font-bold mb-2",children:(t==null?void 0:t.name)||"Unnamed Project"}),n.jsxs("div",{className:"flex flex-wrap items-center gap-4 text-white/80 text-sm",children:[n.jsxs("span",{className:"flex items-center gap-1",children:[n.jsx(rs,{className:"w-4 h-4"}),(t==null?void 0:t.projectCode)||"No Code"]}),n.jsxs("span",{className:"flex items-center gap-1",children:[n.jsx(ds,{className:"w-4 h-4"}),(t==null?void 0:t.clientName)||"No Client"]}),n.jsxs("span",{className:"flex items-center gap-1",children:[n.jsx(il,{className:"w-4 h-4"}),t!=null&&t.startDate?new Date(t.startDate).toLocaleDateString():"No Date"]})]})]}),n.jsxs("div",{className:"flex items-center gap-6",children:[n.jsxs("div",{className:"text-center",children:[n.jsx("p",{className:"text-white/70 text-xs mb-1",children:"Sites"}),n.jsx("p",{className:"text-3xl font-bold",children:e.length})]}),n.jsxs("div",{className:"text-center",children:[n.jsx("p",{className:"text-white/70 text-xs mb-1",children:"Operations"}),n.jsx("p",{className:"text-lg font-medium",children:x.join(", ")})]}),n.jsxs("div",{className:"text-center",children:[n.jsx("p",{className:"text-white/70 text-xs mb-1",children:"Governing SAIL"}),c?n.jsx("span",{className:"inline-block px-4 py-1 rounded-full text-lg font-bold",style:{backgroundColor:Ld[c],color:c==="I"||c==="II"?"#1F2937":"#FFFFFF"},children:c}):n.jsx("span",{className:"text-lg",children:"N/A"})]}),n.jsxs("div",{className:"text-center",children:[n.jsx("p",{className:"text-white/70 text-xs mb-1",children:"SORA Scope"}),h?n.jsx(qr,{className:"w-8 h-8 mx-auto text-green-400"}):n.jsx(zl,{className:"w-8 h-8 mx-auto text-red-400"})]})]})]})})}function rse({project:t,sites:e,calculations:r}){const c=ue.useMemo(()=>{var C,R,F,$;let h=0,x=0,w=0,o=0;return e.forEach(Y=>{var H,X,he,se,de,K,ge,Ae,Te,Ce;h+=((he=(X=(H=Y.mapData)==null?void 0:H.emergency)==null?void 0:X.musterPoints)==null?void 0:he.length)||0,x+=((K=(de=(se=Y.mapData)==null?void 0:se.emergency)==null?void 0:de.evacuationRoutes)==null?void 0:K.length)||0,(Ae=(ge=Y.mapData)==null?void 0:ge.flightPlan)!=null&&Ae.launchPoint&&w++,(Ce=(Te=Y.mapData)==null?void 0:Te.siteSurvey)!=null&&Ce.operationsBoundary&&o++}),{aircraft:((C=t==null?void 0:t.aircraft)==null?void 0:C.length)||0,crew:((R=t==null?void 0:t.crew)==null?void 0:R.length)||0,musterPoints:h,routes:x,sitesWithLaunch:w,sitesWithBoundary:o,emergencyContacts:(($=(F=t==null?void 0:t.emergencyPlan)==null?void 0:F.contacts)==null?void 0:$.length)||0}},[t,e]);return n.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3",children:[n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 text-center",children:[n.jsx(Zn,{className:"w-5 h-5 mx-auto text-gray-400 mb-1"}),n.jsx("p",{className:"text-xl font-bold text-gray-900",children:c.aircraft}),n.jsx("p",{className:"text-xs text-gray-500",children:"Aircraft"})]}),n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 text-center",children:[n.jsx(ds,{className:"w-5 h-5 mx-auto text-gray-400 mb-1"}),n.jsx("p",{className:"text-xl font-bold text-gray-900",children:c.crew}),n.jsx("p",{className:"text-xs text-gray-500",children:"Crew"})]}),n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 text-center",children:[n.jsx(go,{className:"w-5 h-5 mx-auto text-gray-400 mb-1"}),n.jsxs("p",{className:"text-xl font-bold text-gray-900",children:[c.sitesWithBoundary,"/",e.length]}),n.jsx("p",{className:"text-xs text-gray-500",children:"Boundaries"})]}),n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 text-center",children:[n.jsx(cf,{className:"w-5 h-5 mx-auto text-gray-400 mb-1"}),n.jsxs("p",{className:"text-xl font-bold text-gray-900",children:[c.sitesWithLaunch,"/",e.length]}),n.jsx("p",{className:"text-xs text-gray-500",children:"Launch Points"})]}),n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 text-center",children:[n.jsx(lf,{className:"w-5 h-5 mx-auto text-gray-400 mb-1"}),n.jsx("p",{className:"text-xl font-bold text-gray-900",children:c.musterPoints}),n.jsx("p",{className:"text-xs text-gray-500",children:"Muster Points"})]}),n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 text-center",children:[n.jsx(ir,{className:"w-5 h-5 mx-auto text-gray-400 mb-1"}),n.jsx("p",{className:"text-xl font-bold text-gray-900",children:c.routes}),n.jsx("p",{className:"text-xs text-gray-500",children:"Evac Routes"})]}),n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 text-center",children:[n.jsx(Ds,{className:"w-5 h-5 mx-auto text-gray-400 mb-1"}),n.jsx("p",{className:"text-xl font-bold text-gray-900",children:c.emergencyContacts}),n.jsx("p",{className:"text-xs text-gray-500",children:"Contacts"})]})]})}function nse({onNavigate:t,onExport:e}){return n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[n.jsx("h3",{className:"font-medium text-gray-900 mb-3",children:"Quick Actions"}),n.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2",children:[n.jsxs("button",{onClick:()=>t==null?void 0:t("siteSurvey"),className:"p-3 bg-blue-50 hover:bg-blue-100 rounded-lg text-blue-700 text-sm text-center transition-colors",children:[n.jsx(Wn,{className:"w-5 h-5 mx-auto mb-1"}),"Site Survey"]}),n.jsxs("button",{onClick:()=>t==null?void 0:t("flightPlan"),className:"p-3 bg-green-50 hover:bg-green-100 rounded-lg text-green-700 text-sm text-center transition-colors",children:[n.jsx(Zn,{className:"w-5 h-5 mx-auto mb-1"}),"Flight Plan"]}),n.jsxs("button",{onClick:()=>t==null?void 0:t("emergency"),className:"p-3 bg-red-50 hover:bg-red-100 rounded-lg text-red-700 text-sm text-center transition-colors",children:[n.jsx(ir,{className:"w-5 h-5 mx-auto mb-1"}),"Emergency"]}),n.jsxs("button",{onClick:()=>t==null?void 0:t("sora"),className:"p-3 bg-purple-50 hover:bg-purple-100 rounded-lg text-purple-700 text-sm text-center transition-colors",children:[n.jsx(Ds,{className:"w-5 h-5 mx-auto mb-1"}),"SORA"]})]}),n.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-100 flex flex-wrap gap-2",children:[n.jsxs("button",{onClick:()=>e==null?void 0:e("operations-plan"),className:"px-4 py-2 bg-aeria-navy text-white rounded-lg text-sm flex items-center gap-2 hover:bg-aeria-navy/90",children:[n.jsx(vc,{className:"w-4 h-4"}),"Export Operations Plan"]}),n.jsxs("button",{onClick:()=>e==null?void 0:e("sora"),className:"px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm flex items-center gap-2 hover:bg-gray-200",children:[n.jsx(vc,{className:"w-4 h-4"}),"Export SORA"]})]})]})}function sse({project:t,sites:e,calculations:r}){var o,C,R,F,$,Y;const c=ue.useMemo(()=>{const H=Object.values(r).map(he=>he.sail).filter(Boolean);if(H.length===0)return null;const X=["I","II","III","IV","V","VI"];return H.reduce((he,se)=>X.indexOf(se)>X.indexOf(he)?se:he,"I")},[r]),h=[{id:"ops_manual",name:"Operations Manual",required:!0,sailRequired:"I",present:!!((o=t==null?void 0:t.documents)!=null&&o.opsManual)},{id:"emergency_plan",name:"Emergency Response Plan",required:!0,sailRequired:"I",present:!!((C=t==null?void 0:t.documents)!=null&&C.emergencyPlan)||e.every(H=>{var X;return(X=H.emergency)==null?void 0:X.localEmergencyNotes})},{id:"risk_assessment",name:"Risk Assessment",required:!0,sailRequired:"I",present:e.some(H=>{var X;return(X=H.soraAssessment)==null?void 0:X.sail})},{id:"pilot_certs",name:"Pilot Certifications",required:!0,sailRequired:"I",present:((t==null?void 0:t.crew)||[]).some(H=>{var X;return((X=H.certifications)==null?void 0:X.length)>0})},{id:"insurance",name:"Insurance Certificate",required:!0,sailRequired:"I",present:!!((R=t==null?void 0:t.documents)!=null&&R.insurance)},{id:"maintenance_log",name:"Maintenance Records",required:c&&["III","IV","V","VI"].includes(c),sailRequired:"III",present:!!((F=t==null?void 0:t.documents)!=null&&F.maintenanceLog)},{id:"training_records",name:"Training Records",required:c&&["II","III","IV","V","VI"].includes(c),sailRequired:"II",present:!!(($=t==null?void 0:t.documents)!=null&&$.trainingRecords)},{id:"flight_auth",name:"Flight Authorization (SFOC)",required:c&&["IV","V","VI"].includes(c),sailRequired:"IV",present:!!((Y=t==null?void 0:t.documents)!=null&&Y.sfoc)}],x=h.filter(H=>H.required),w=x.filter(H=>H.present);return n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[n.jsxs("div",{className:"flex items-center justify-between mb-3",children:[n.jsxs("h3",{className:"font-medium text-gray-900 flex items-center gap-2",children:[n.jsx(rs,{className:"w-4 h-4"}),"Document Checklist"]}),n.jsxs("span",{className:"text-sm text-gray-500",children:[w.length,"/",x.length," complete"]})]}),n.jsx("div",{className:"space-y-2",children:h.map(H=>n.jsxs("div",{className:`flex items-center justify-between py-1.5 px-2 rounded ${H.required?"":"opacity-50"}`,children:[n.jsxs("div",{className:"flex items-center gap-2",children:[H.present?n.jsx(qr,{className:"w-4 h-4 text-green-500"}):H.required?n.jsx(zl,{className:"w-4 h-4 text-red-500"}):n.jsx("div",{className:"w-4 h-4 rounded-full border-2 border-gray-300"}),n.jsx("span",{className:`text-sm ${H.present?"text-gray-700":H.required?"text-gray-900 font-medium":"text-gray-500"}`,children:H.name})]}),H.sailRequired&&n.jsxs("span",{className:"text-xs text-gray-400",children:["SAIL ",H.sailRequired,"+"]})]},H.id))})]})}function ase({project:t,onNavigate:e}){const r=(t==null?void 0:t.crew)||[],c={pic:r.filter(h=>h.role==="PIC"||h.role==="pic"),vo:r.filter(h=>h.role==="VO"||h.role==="vo"),other:r.filter(h=>!["PIC","pic","VO","vo"].includes(h.role))};return n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[n.jsxs("div",{className:"flex items-center justify-between mb-3",children:[n.jsxs("h3",{className:"font-medium text-gray-900 flex items-center gap-2",children:[n.jsx(ds,{className:"w-4 h-4"}),"Crew Assignment"]}),n.jsx("button",{onClick:()=>e==null?void 0:e("crew"),className:"text-xs text-aeria-navy hover:underline",children:"Manage"})]}),r.length===0?n.jsx("p",{className:"text-sm text-gray-500",children:"No crew assigned yet"}):n.jsxs("div",{className:"space-y-2",children:[n.jsxs("div",{className:"flex items-center justify-between text-sm",children:[n.jsx("span",{className:"text-gray-600",children:"Pilots in Command (PIC)"}),n.jsx("span",{className:"font-medium",children:c.pic.length})]}),n.jsxs("div",{className:"flex items-center justify-between text-sm",children:[n.jsx("span",{className:"text-gray-600",children:"Visual Observers (VO)"}),n.jsx("span",{className:"font-medium",children:c.vo.length})]}),c.other.length>0&&n.jsxs("div",{className:"flex items-center justify-between text-sm",children:[n.jsx("span",{className:"text-gray-600",children:"Other Crew"}),n.jsx("span",{className:"font-medium",children:c.other.length})]}),n.jsx("div",{className:"pt-2 border-t border-gray-100",children:n.jsxs("div",{className:"flex items-center justify-between text-sm font-medium",children:[n.jsx("span",{className:"text-gray-900",children:"Total Crew"}),n.jsx("span",{children:r.length})]})})]})]})}function ose({project:t,sites:e,calculations:r}){const c=ue.useMemo(()=>{const o=Object.values(r).map(R=>R.sail).filter(Boolean);if(o.length===0)return null;const C=["I","II","III","IV","V","VI"];return o.reduce((R,F)=>C.indexOf(F)>C.indexOf(R)?F:R,"I")},[r]),h=[{id:"rpas_reg",name:"RPAS Registration",description:"Aircraft registered with Transport Canada",status:((t==null?void 0:t.aircraft)||[]).every(o=>o.registration)?"complete":"incomplete"},{id:"pilot_cert",name:"Pilot Certificate",description:"Valid Advanced Operations certificate",status:((t==null?void 0:t.crew)||[]).some(o=>{var C;return(C=o.certifications)==null?void 0:C.includes("advanced")})?"complete":"incomplete"},{id:"sora_complete",name:"SORA Assessment",description:"All sites have valid SORA assessment",status:e.every(o=>{var C;return(C=r[o.id])==null?void 0:C.sail})?"complete":"incomplete"},{id:"airspace_auth",name:"Airspace Authorization",description:"Required for controlled airspace",status:e.some(o=>{var C,R,F,$;return((R=(C=o.flightPlan)==null?void 0:C.airspace)==null?void 0:R.controlled)&&!(($=(F=o.flightPlan)==null?void 0:F.airspace)!=null&&$.atcCoordinationRequired)})?"required":e.some(o=>{var C,R;return(R=(C=o.flightPlan)==null?void 0:C.airspace)==null?void 0:R.controlled})?"complete":"not_required"},{id:"notam",name:"NOTAM Filed",description:"Notice to Airmen if required",status:e.some(o=>{var C,R;return((R=(C=o.flightPlan)==null?void 0:C.airspace)==null?void 0:R.notamRequired)&&!(t!=null&&t.notamFiled)})?"required":"not_required"},{id:"sfoc",name:"SFOC Application",description:"Special Flight Operations Certificate",status:c&&["IV","V","VI"].includes(c)?(t==null?void 0:t.sfocStatus)==="approved"?"complete":"required":"not_required"}],x={complete:n.jsx(qr,{className:"w-4 h-4 text-green-500"}),incomplete:n.jsx(zl,{className:"w-4 h-4 text-red-500"}),required:n.jsx(Cs,{className:"w-4 h-4 text-amber-500"}),not_required:n.jsx("div",{className:"w-4 h-4 rounded-full border-2 border-gray-300"})},w={complete:"text-green-700 bg-green-50",incomplete:"text-red-700 bg-red-50",required:"text-amber-700 bg-amber-50",not_required:"text-gray-500 bg-gray-50"};return n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[n.jsxs("div",{className:"flex items-center justify-between mb-3",children:[n.jsxs("h3",{className:"font-medium text-gray-900 flex items-center gap-2",children:[n.jsx(Ds,{className:"w-4 h-4"}),"Regulatory Compliance"]}),c&&n.jsxs("span",{className:"text-xs px-2 py-0.5 rounded bg-blue-100 text-blue-700",children:["Max SAIL ",c]})]}),n.jsx("div",{className:"space-y-2",children:h.map(o=>n.jsx("div",{className:`flex items-center justify-between py-1.5 px-2 rounded ${w[o.status]}`,children:n.jsxs("div",{className:"flex items-center gap-2",children:[x[o.status],n.jsxs("div",{children:[n.jsx("span",{className:"text-sm font-medium",children:o.name}),n.jsx("p",{className:"text-xs opacity-75",children:o.description})]})]})},o.id))})]})}function lse({project:t}){const e=(t==null?void 0:t.timeline)||{},r=[{id:"created",label:"Project Created",date:t==null?void 0:t.createdAt,status:"complete"},{id:"survey",label:"Site Surveys",date:e.surveyComplete,status:e.surveyComplete?"complete":"pending"},{id:"sora",label:"SORA Assessment",date:e.soraComplete,status:e.soraComplete?"complete":"pending"},{id:"review",label:"Review & Approval",date:e.reviewComplete,status:e.reviewComplete?"complete":"pending"},{id:"operation",label:"Operation Date",date:(t==null?void 0:t.operationDate)||(t==null?void 0:t.startDate),status:"upcoming"}];return n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[n.jsxs("h3",{className:"font-medium text-gray-900 flex items-center gap-2 mb-4",children:[n.jsx(il,{className:"w-4 h-4"}),"Project Timeline"]}),n.jsxs("div",{className:"relative",children:[n.jsx("div",{className:"absolute left-2 top-2 bottom-2 w-0.5 bg-gray-200"}),n.jsx("div",{className:"space-y-4",children:r.map((c,h)=>n.jsxs("div",{className:"flex items-start gap-3 relative",children:[n.jsx("div",{className:`w-4 h-4 rounded-full border-2 flex-shrink-0 z-10 ${c.status==="complete"?"bg-green-500 border-green-500":c.status==="upcoming"?"bg-blue-500 border-blue-500":"bg-white border-gray-300"}`,children:c.status==="complete"&&n.jsx(ru,{className:"w-3 h-3 text-white",style:{marginLeft:"0.5px",marginTop:"0.5px"}})}),n.jsxs("div",{className:"flex-1 -mt-0.5",children:[n.jsx("p",{className:`text-sm font-medium ${c.status==="complete"?"text-gray-900":"text-gray-500"}`,children:c.label}),c.date&&n.jsx("p",{className:"text-xs text-gray-400",children:new Date(c.date).toLocaleDateString("en-CA",{month:"short",day:"numeric",year:"numeric"})})]})]},c.id))})]})]})}function cse({project:t,onUpdate:e,onNavigateToSection:r,onExport:c}){const h=ue.useMemo(()=>Array.isArray(t==null?void 0:t.sites)?t.sites:[],[t==null?void 0:t.sites]),x=ue.useMemo(()=>{const o={};return h.forEach(C=>{var de,K;const R=C.soraAssessment||{},F=R.populationCategory||((K=(de=C.siteSurvey)==null?void 0:de.population)==null?void 0:K.category)||"sparsely",$=R.uaCharacteristics||"1m_25ms",Y=RT(F,$),H=kT(Y,R.mitigations||{}),X=R.initialARC||"ARC-b",he=DT(X,R.tmpr||{}),se=MT(H,he);o[C.id]={population:F,uaChar:$,iGRC:Y,fGRC:H,initialARC:X,residualARC:he,sail:se,withinScope:H!==null&&H<=7}}),o},[h]),w=o=>{e==null||e({activeSiteId:o}),r==null||r("siteSurvey")};return h.length===0?n.jsxs("div",{className:"space-y-6",children:[n.jsx(w3,{project:t,sites:[],calculations:{}}),n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-12 text-center",children:[n.jsx(Wn,{className:"w-12 h-12 mx-auto text-gray-300 mb-4"}),n.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Operation Sites"}),n.jsx("p",{className:"text-gray-500 mb-6",children:"Add your first operation site to get started."}),n.jsx("button",{onClick:()=>r==null?void 0:r("siteSurvey"),className:"btn-primary",children:"Add First Site"})]})]}):n.jsxs("div",{className:"space-y-6",children:[n.jsx(w3,{project:t,sites:h,calculations:x}),n.jsx(rse,{project:t,sites:h,calculations:x}),n.jsx(nse,{onNavigate:r,onExport:c}),n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[n.jsx(sse,{project:t,sites:h,calculations:x}),n.jsx(ase,{project:t,onNavigate:r}),n.jsx(ose,{project:t,sites:h,calculations:x}),n.jsx(lse,{project:t})]}),n.jsxs("div",{children:[n.jsxs("div",{className:"flex items-center justify-between mb-4",children:[n.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Operation Sites"}),n.jsxs("button",{onClick:()=>r==null?void 0:r("siteSurvey"),className:"text-sm text-aeria-navy hover:underline flex items-center gap-1",children:["Manage Sites",n.jsx(ko,{className:"w-4 h-4"})]})]}),n.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:h.map((o,C)=>n.jsx(ise,{site:o,index:C,calculations:x,onNavigate:r,onSelect:w},o.id))})]}),Object.values(x).some(o=>o.fGRC!==null&&o.fGRC>7)&&n.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:n.jsxs("div",{className:"flex items-start gap-3",children:[n.jsx(ir,{className:"w-6 h-6 text-red-500 flex-shrink-0"}),n.jsxs("div",{children:[n.jsx("h3",{className:"font-medium text-red-800",children:"Operations Outside SORA Scope"}),n.jsx("p",{className:"text-sm text-red-700 mt-1",children:"One or more sites have a final GRC exceeding 7. These operations require additional regulatory approval beyond SORA methodology."})]})]})})]})}const use=[{id:"crew",key:null,label:"Crew & Roles",description:"Assign team members and define their responsibilities for the operation.",icon:ds,alwaysOn:!0},{id:"siteSurvey",key:"siteSurvey",label:"Site Survey",description:"Document the operational area including location, airspace, obstacles, and access routes.",icon:Wn,alwaysOn:!1},{id:"flightPlan",key:"flightPlan",label:"Flight Plan",description:"Define aircraft, flight profile, weather minimums, and contingency procedures.",icon:Zn,alwaysOn:!1},{id:"riskAssessment",key:null,label:"Risk Assessment",description:"SORA assessment (when Flight Plan is enabled) and HSE hazard identification.",icon:ir,alwaysOn:!0},{id:"emergencyPlan",key:null,label:"Emergency Plan",description:"Emergency contacts, muster points, evacuation routes, and response procedures.",icon:E6,alwaysOn:!0},{id:"ppe",key:null,label:"PPE Requirements",description:"Required personal protective equipment for the operation.",icon:Qc,alwaysOn:!0},{id:"communications",key:null,label:"Communications",description:"Communication methods, radio channels, check-in protocols, and emergency procedures.",icon:Jc,alwaysOn:!0},{id:"approvals",key:null,label:"Approvals & Signatures",description:"Document review, approval chain, and crew acknowledgments.",icon:eb,alwaysOn:!0}];function dse({project:t,onUpdate:e}){const r=c=>{var x;const h=((x=t.sections)==null?void 0:x[c])??!1;e({sections:{...t.sections,[c]:!h}})};return n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"card",children:[n.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Operations Plan Sections"}),n.jsx("p",{className:"text-sm text-gray-500 mb-6",children:"Enable or disable sections based on your operation requirements. Some sections are always included for safety compliance."}),n.jsx("div",{className:"space-y-3",children:use.map(c=>{var w;const h=c.alwaysOn||((w=t.sections)==null?void 0:w[c.key]),x=c.icon;return n.jsxs("div",{className:`flex items-start gap-4 p-4 rounded-lg border transition-colors ${h?"bg-aeria-sky/30 border-aeria-light-blue/30":"bg-gray-50 border-gray-200"}`,children:[n.jsx("div",{className:`p-2 rounded-lg ${h?"bg-aeria-blue text-white":"bg-gray-200 text-gray-500"}`,children:n.jsx(x,{className:"w-5 h-5"})}),n.jsxs("div",{className:"flex-1",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("h3",{className:`font-medium ${h?"text-gray-900":"text-gray-500"}`,children:c.label}),c.alwaysOn&&n.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 text-xs font-medium bg-gray-200 text-gray-600 rounded-full",children:[n.jsx(S6,{className:"w-3 h-3"}),"Required"]})]}),n.jsx("p",{className:`text-sm mt-1 ${h?"text-gray-600":"text-gray-400"}`,children:c.description})]}),n.jsx("div",{className:"flex-shrink-0",children:c.alwaysOn?n.jsx("div",{className:"w-10 h-6 flex items-center justify-center",children:n.jsx(qr,{className:"w-5 h-5 text-green-500"})}):n.jsx("button",{onClick:()=>r(c.key),className:`relative w-10 h-6 rounded-full transition-colors ${h?"bg-aeria-navy":"bg-gray-300"}`,children:n.jsx("span",{className:`absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${h?"translate-x-4":"translate-x-0"}`})})})]},c.id)})})]}),n.jsx("div",{className:"card bg-blue-50 border-blue-200",children:n.jsxs("div",{className:"flex gap-3",children:[n.jsx(ir,{className:"w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"}),n.jsxs("div",{children:[n.jsx("h3",{className:"font-medium text-blue-900",children:"About Risk Assessment"}),n.jsxs("p",{className:"text-sm text-blue-700 mt-1",children:["When the ",n.jsx("strong",{children:"Flight Plan"})," section is enabled, the Risk Assessment will include the full ",n.jsx("strong",{children:"SORA 2.5"})," (Specific Operations Risk Assessment) wizard. This calculates Ground Risk Class, Air Risk Class, and determines the required SAIL level and Operational Safety Objectives."]}),n.jsxs("p",{className:"text-sm text-blue-700 mt-2",children:["The ",n.jsx("strong",{children:"HSE Hazard Assessment"})," is always included regardless of whether Flight Plan is enabled."]})]})]})})]})}const hse=[{value:"PIC",label:"Pilot in Command",description:"Primary flight operations authority"},{value:"VO",label:"Visual Observer",description:"Maintains visual contact with aircraft"},{value:"Safety Lead",label:"Safety Lead",description:"Oversees HSE compliance"},{value:"Project Lead",label:"Project Lead",description:"Overall project coordination"},{value:"First Aid",label:"First Aid Attendant",description:"Designated first aid responder"},{value:"Ground Support",label:"Ground Support",description:"Equipment and logistics"},{value:"Other",label:"Other",description:"Custom role"}],S3={PIC:"bg-blue-100 text-blue-700 border-blue-200",VO:"bg-green-100 text-green-700 border-green-200","Safety Lead":"bg-orange-100 text-orange-700 border-orange-200","Project Lead":"bg-purple-100 text-purple-700 border-purple-200","First Aid":"bg-red-100 text-red-700 border-red-200","Ground Support":"bg-gray-100 text-gray-700 border-gray-200",Other:"bg-gray-100 text-gray-700 border-gray-200"};function pse({project:t,onUpdate:e}){var ae,q,oe,ke,Ve;const[r,c]=ue.useState([]),[h,x]=ue.useState(!0),[w,o]=ue.useState(!1),[C,R]=ue.useState(""),[F,$]=ue.useState(""),[Y,H]=ue.useState("");ue.useEffect(()=>{X()},[]);const X=async()=>{try{const ie=await rx();c(ie.filter(ze=>ze.status==="active"))}catch(ie){console.error("Error loading operators:",ie)}finally{x(!1)}},he=ie=>r.find(ze=>ze.id===ie),se=()=>{var Le;if(!C||!F)return;const ie=F==="Other"?Y:F;if(!ie)return;const ze=he(C);if(!ze)return;const ve={operatorId:C,operatorName:`${ze.firstName} ${ze.lastName}`,role:ie,isPrimary:!((Le=t.crew)!=null&&Le.some(Ke=>Ke.role===ie))};e({crew:[...t.crew||[],ve]}),R(""),$(""),H(""),o(!1)},de=ie=>{const ze=[...t.crew||[]];ze.splice(ie,1),e({crew:ze})},K=ie=>{const ze=t.crew[ie],ve=t.crew.map((Le,Ke)=>Le.role===ze.role?{...Le,isPrimary:Ke===ie}:Le);e({crew:ve})},ge=ie=>{var Le;if(!((Le=ie==null?void 0:ie.certifications)!=null&&Le.length))return null;let ze=!1,ve=!1;return ie.certifications.forEach(Ke=>{if(!Ke.expiryDate)return;const Pe=jT(new Date(Ke.expiryDate),new Date);Pe<0?ze=!0:Pe<=90&&(ve=!0)}),ze?{status:"expired",color:"text-red-500",icon:zl}:ve?{status:"expiring",color:"text-amber-500",icon:ir}:{status:"valid",color:"text-green-500",icon:qr}},Ae=r.filter(ie=>{var ze;return!((ze=t.crew)!=null&&ze.some(ve=>ve.operatorId===ie.id))}),Te=(ae=t.crew)==null?void 0:ae.some(ie=>ie.role==="PIC"),Ce=(q=t.crew)==null?void 0:q.some(ie=>ie.role==="First Aid"),ne=(oe=t.sections)==null?void 0:oe.flightPlan;return n.jsxs("div",{className:"space-y-6",children:[ne&&!Te&&n.jsxs("div",{className:"flex items-center gap-3 p-4 bg-amber-50 border border-amber-200 rounded-lg",children:[n.jsx(ir,{className:"w-5 h-5 text-amber-600 flex-shrink-0"}),n.jsxs("div",{children:[n.jsx("p",{className:"font-medium text-amber-800",children:"PIC Required"}),n.jsx("p",{className:"text-sm text-amber-700",children:"Flight Plan is enabled. At least one Pilot in Command must be assigned."})]})]}),!Ce&&n.jsxs("div",{className:"flex items-center gap-3 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[n.jsx(ir,{className:"w-5 h-5 text-blue-600 flex-shrink-0"}),n.jsxs("div",{children:[n.jsx("p",{className:"font-medium text-blue-800",children:"First Aid Attendant Recommended"}),n.jsx("p",{className:"text-sm text-blue-700",children:"Consider assigning a designated First Aid attendant for field operations."})]})]}),n.jsxs("div",{className:"card",children:[n.jsxs("div",{className:"flex items-center justify-between mb-4",children:[n.jsxs("h2",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[n.jsx(ds,{className:"w-5 h-5 text-aeria-blue"}),"Crew Members"]}),n.jsxs("button",{onClick:()=>o(!0),className:"btn-primary text-sm inline-flex items-center gap-1",disabled:Ae.length===0,children:[n.jsx(vr,{className:"w-4 h-4"}),"Add Crew"]})]}),((ke=t.crew)==null?void 0:ke.length)===0||!t.crew?n.jsxs("div",{className:"text-center py-8",children:[n.jsx(ds,{className:"w-10 h-10 mx-auto mb-2 text-gray-300"}),n.jsx("p",{className:"text-gray-500",children:"No crew members assigned yet."}),Ae.length>0?n.jsx("button",{onClick:()=>o(!0),className:"text-sm text-aeria-blue hover:underline mt-2",children:"Add your first crew member"}):n.jsxs("p",{className:"text-sm text-gray-400 mt-2",children:[n.jsx("a",{href:"/operators",className:"text-aeria-blue hover:underline",children:"Add operators"})," first to assign them to projects."]})]}):n.jsx("div",{className:"space-y-3",children:t.crew.map((ie,ze)=>{var Pe,It;const ve=he(ie.operatorId),Le=ge(ve),Ke=Le==null?void 0:Le.icon;return n.jsxs("div",{className:"flex items-center gap-4 p-4 bg-gray-50 rounded-lg border border-gray-200",children:[n.jsx("div",{className:"w-10 h-10 bg-aeria-blue rounded-full flex items-center justify-center flex-shrink-0",children:n.jsx("span",{className:"text-white font-medium",children:ve?`${(Pe=ve.firstName)==null?void 0:Pe[0]}${(It=ve.lastName)==null?void 0:It[0]}`:"??"})}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("span",{className:"font-medium text-gray-900",children:ie.operatorName}),Le&&n.jsx(Ke,{className:`w-4 h-4 ${Le.color}`,title:`Certifications: ${Le.status}`}),ie.isPrimary&&n.jsx("span",{className:"px-1.5 py-0.5 text-xs bg-aeria-navy text-white rounded",children:"Primary"})]}),n.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[n.jsx("span",{className:`px-2 py-0.5 text-xs font-medium rounded-full border ${S3[ie.role]||S3.Other}`,children:ie.role}),(ve==null?void 0:ve.phone)&&n.jsxs("span",{className:"text-xs text-gray-500 flex items-center gap-1",children:[n.jsx(Hd,{className:"w-3 h-3"}),ve.phone]})]})]}),n.jsxs("div",{className:"flex items-center gap-1",children:[!ie.isPrimary&&t.crew.filter(tt=>tt.role===ie.role).length>1&&n.jsx("button",{onClick:()=>K(ze),className:"px-2 py-1 text-xs text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded",children:"Make Primary"}),n.jsx("button",{onClick:()=>de(ze),className:"p-1.5 text-gray-400 hover:text-red-500 rounded hover:bg-red-50",children:n.jsx(Ln,{className:"w-4 h-4"})})]})]},ze)})})]}),w&&n.jsxs("div",{className:"card border-aeria-light-blue",children:[n.jsx("h3",{className:"font-medium text-gray-900 mb-4",children:"Add Crew Member"}),n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4 mb-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Operator"}),n.jsxs("select",{value:C,onChange:ie=>R(ie.target.value),className:"input",children:[n.jsx("option",{value:"",children:"Select operator..."}),Ae.map(ie=>n.jsxs("option",{value:ie.id,children:[ie.firstName," ",ie.lastName]},ie.id))]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Role"}),n.jsxs("select",{value:F,onChange:ie=>$(ie.target.value),className:"input",children:[n.jsx("option",{value:"",children:"Select role..."}),hse.map(ie=>n.jsx("option",{value:ie.value,children:ie.label},ie.value))]})]}),F==="Other"&&n.jsxs("div",{className:"sm:col-span-2",children:[n.jsx("label",{className:"label",children:"Custom Role Name"}),n.jsx("input",{type:"text",value:Y,onChange:ie=>H(ie.target.value),className:"input",placeholder:"Enter custom role..."})]})]}),C&&n.jsx("div",{className:"p-3 bg-gray-50 rounded-lg mb-4",children:(()=>{var ve,Le;const ie=he(C),ze=ge(ie);return ie?n.jsxs("div",{className:"flex items-start gap-3",children:[n.jsx(fa,{className:"w-5 h-5 text-gray-400 mt-0.5"}),n.jsxs("div",{className:"flex-1",children:[n.jsxs("p",{className:"font-medium text-gray-900",children:[ie.firstName," ",ie.lastName]}),((ve=ie.roles)==null?void 0:ve.length)>0&&n.jsxs("p",{className:"text-sm text-gray-500",children:["Qualified: ",ie.roles.join(", ")]}),((Le=ie.certifications)==null?void 0:Le.length)>0&&n.jsxs("div",{className:"flex items-center gap-1 mt-1 text-sm",children:[n.jsx(gS,{className:"w-3.5 h-3.5 text-gray-400"}),n.jsxs("span",{className:"text-gray-500",children:[ie.certifications.length," certification",ie.certifications.length!==1?"s":""]}),ze&&ze.status!=="valid"&&n.jsxs("span",{className:`ml-1 ${ze.color}`,children:["(",ze.status,")"]})]})]})]}):null})()}),n.jsxs("div",{className:"flex justify-end gap-2",children:[n.jsx("button",{onClick:()=>{o(!1),R(""),$(""),H("")},className:"btn-secondary text-sm",children:"Cancel"}),n.jsx("button",{onClick:se,disabled:!C||!F||F==="Other"&&!Y,className:"btn-primary text-sm",children:"Add to Crew"})]})]}),((Ve=t.crew)==null?void 0:Ve.length)>0&&n.jsxs("div",{className:"card",children:[n.jsx("h3",{className:"font-medium text-gray-900 mb-3",children:"Emergency Contacts (from crew)"}),n.jsx("div",{className:"space-y-3",children:t.crew.map((ie,ze)=>{var Le;const ve=he(ie.operatorId);return(Le=ve==null?void 0:ve.emergencyContact)!=null&&Le.name?n.jsxs("div",{className:"py-2 border-b border-gray-100 last:border-0",children:[n.jsxs("div",{className:"flex items-center justify-between text-sm",children:[n.jsxs("span",{className:"text-gray-600",children:[ie.operatorName,"'s emergency contact"]}),n.jsxs("span",{className:"text-gray-900 font-medium",children:[ve.emergencyContact.name,ve.emergencyContact.relationship&&n.jsxs("span",{className:"text-gray-500 font-normal ml-1",children:["(",ve.emergencyContact.relationship,")"]})]})]}),n.jsxs("div",{className:"flex items-center gap-4 text-xs text-gray-500 mt-1",children:[ve.emergencyContact.phone&&n.jsxs("span",{className:"inline-flex items-center gap-1",children:[n.jsx(Hd,{className:"w-3 h-3"}),ve.emergencyContact.phone]}),ve.emergencyContact.email&&n.jsxs("span",{className:"inline-flex items-center gap-1",children:[n.jsx("span",{children:""}),ve.emergencyContact.email]})]})]},ze):null})})]})]})}var yU={exports:{}};(function(t,e){(function(r,c){t.exports=c()})(a7,function(){var r,c,h;function x(o,C){if(!r)r=C;else if(!c)c=C;else{var R="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+r+")(sharedChunk); ("+c+")(sharedChunk); self.onerror = null;",F={};r(F),h=C(F),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(h.workerUrl=window.URL.createObjectURL(new Blob([R],{type:"text/javascript"})))}}x(["exports"],function(o){var C=1e-6,R=typeof Float32Array<"u"?Float32Array:Array;function F(l,i){var a=i[0],u=i[1],p=i[2],g=i[3],y=a*g-p*u;return y?(l[0]=g*(y=1/y),l[1]=-u*y,l[2]=-p*y,l[3]=a*y,l):null}function $(){var l=new R(9);return R!=Float32Array&&(l[1]=0,l[2]=0,l[3]=0,l[5]=0,l[6]=0,l[7]=0),l[0]=1,l[4]=1,l[8]=1,l}function Y(l,i){var a=i[0],u=i[1],p=i[2],g=i[3],y=i[4],v=i[5],T=i[6],N=i[7],I=i[8];return l[0]=y*I-v*N,l[1]=p*N-u*I,l[2]=u*v-p*y,l[3]=v*T-g*I,l[4]=a*I-p*T,l[5]=p*g-a*v,l[6]=g*N-y*T,l[7]=u*T-a*N,l[8]=a*y-u*g,l}function H(l,i,a){var u=i[0],p=i[1],g=i[2],y=i[3],v=i[4],T=i[5],N=i[6],I=i[7],P=i[8],j=a[0],O=a[1],L=a[2],U=a[3],Z=a[4],G=a[5],ee=a[6],le=a[7],me=a[8];return l[0]=j*u+O*y+L*N,l[1]=j*p+O*v+L*I,l[2]=j*g+O*T+L*P,l[3]=U*u+Z*y+G*N,l[4]=U*p+Z*v+G*I,l[5]=U*g+Z*T+G*P,l[6]=ee*u+le*y+me*N,l[7]=ee*p+le*v+me*I,l[8]=ee*g+le*T+me*P,l}function X(){var l=new R(16);return R!=Float32Array&&(l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[11]=0,l[12]=0,l[13]=0,l[14]=0),l[0]=1,l[5]=1,l[10]=1,l[15]=1,l}function he(l){var i=new R(16);return i[0]=l[0],i[1]=l[1],i[2]=l[2],i[3]=l[3],i[4]=l[4],i[5]=l[5],i[6]=l[6],i[7]=l[7],i[8]=l[8],i[9]=l[9],i[10]=l[10],i[11]=l[11],i[12]=l[12],i[13]=l[13],i[14]=l[14],i[15]=l[15],i}function se(l){return l[0]=1,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=1,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[10]=1,l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,l}function de(l,i){var a=i[0],u=i[1],p=i[2],g=i[3],y=i[4],v=i[5],T=i[6],N=i[7],I=i[8],P=i[9],j=i[10],O=i[11],L=i[12],U=i[13],Z=i[14],G=i[15],ee=a*v-u*y,le=a*T-p*y,me=a*N-g*y,we=u*T-p*v,be=u*N-g*v,Re=p*N-g*T,Me=I*U-P*L,je=I*Z-j*L,Be=I*G-O*L,Ge=P*Z-j*U,ut=P*G-O*U,lt=j*G-O*Z,ct=ee*lt-le*ut+me*Ge+we*Be-be*je+Re*Me;return ct?(l[0]=(v*lt-T*ut+N*Ge)*(ct=1/ct),l[1]=(p*ut-u*lt-g*Ge)*ct,l[2]=(U*Re-Z*be+G*we)*ct,l[3]=(j*be-P*Re-O*we)*ct,l[4]=(T*Be-y*lt-N*je)*ct,l[5]=(a*lt-p*Be+g*je)*ct,l[6]=(Z*me-L*Re-G*le)*ct,l[7]=(I*Re-j*me+O*le)*ct,l[8]=(y*ut-v*Be+N*Me)*ct,l[9]=(u*Be-a*ut-g*Me)*ct,l[10]=(L*be-U*me+G*ee)*ct,l[11]=(P*me-I*be-O*ee)*ct,l[12]=(v*je-y*Ge-T*Me)*ct,l[13]=(a*Ge-u*je+p*Me)*ct,l[14]=(U*le-L*we-Z*ee)*ct,l[15]=(I*we-P*le+j*ee)*ct,l):null}function K(l,i,a){var u=i[0],p=i[1],g=i[2],y=i[3],v=i[4],T=i[5],N=i[6],I=i[7],P=i[8],j=i[9],O=i[10],L=i[11],U=i[12],Z=i[13],G=i[14],ee=i[15],le=a[0],me=a[1],we=a[2],be=a[3];return l[0]=le*u+me*v+we*P+be*U,l[1]=le*p+me*T+we*j+be*Z,l[2]=le*g+me*N+we*O+be*G,l[3]=le*y+me*I+we*L+be*ee,l[4]=(le=a[4])*u+(me=a[5])*v+(we=a[6])*P+(be=a[7])*U,l[5]=le*p+me*T+we*j+be*Z,l[6]=le*g+me*N+we*O+be*G,l[7]=le*y+me*I+we*L+be*ee,l[8]=(le=a[8])*u+(me=a[9])*v+(we=a[10])*P+(be=a[11])*U,l[9]=le*p+me*T+we*j+be*Z,l[10]=le*g+me*N+we*O+be*G,l[11]=le*y+me*I+we*L+be*ee,l[12]=(le=a[12])*u+(me=a[13])*v+(we=a[14])*P+(be=a[15])*U,l[13]=le*p+me*T+we*j+be*Z,l[14]=le*g+me*N+we*O+be*G,l[15]=le*y+me*I+we*L+be*ee,l}function ge(l,i,a){var u,p,g,y,v,T,N,I,P,j,O,L,U=a[0],Z=a[1],G=a[2];return i===l?(l[12]=i[0]*U+i[4]*Z+i[8]*G+i[12],l[13]=i[1]*U+i[5]*Z+i[9]*G+i[13],l[14]=i[2]*U+i[6]*Z+i[10]*G+i[14],l[15]=i[3]*U+i[7]*Z+i[11]*G+i[15]):(p=i[1],g=i[2],y=i[3],v=i[4],T=i[5],N=i[6],I=i[7],P=i[8],j=i[9],O=i[10],L=i[11],l[0]=u=i[0],l[1]=p,l[2]=g,l[3]=y,l[4]=v,l[5]=T,l[6]=N,l[7]=I,l[8]=P,l[9]=j,l[10]=O,l[11]=L,l[12]=u*U+v*Z+P*G+i[12],l[13]=p*U+T*Z+j*G+i[13],l[14]=g*U+N*Z+O*G+i[14],l[15]=y*U+I*Z+L*G+i[15]),l}function Ae(l,i,a){var u=a[0],p=a[1],g=a[2];return l[0]=i[0]*u,l[1]=i[1]*u,l[2]=i[2]*u,l[3]=i[3]*u,l[4]=i[4]*p,l[5]=i[5]*p,l[6]=i[6]*p,l[7]=i[7]*p,l[8]=i[8]*g,l[9]=i[9]*g,l[10]=i[10]*g,l[11]=i[11]*g,l[12]=i[12],l[13]=i[13],l[14]=i[14],l[15]=i[15],l}function Te(l,i,a){var u=Math.sin(a),p=Math.cos(a),g=i[4],y=i[5],v=i[6],T=i[7],N=i[8],I=i[9],P=i[10],j=i[11];return i!==l&&(l[0]=i[0],l[1]=i[1],l[2]=i[2],l[3]=i[3],l[12]=i[12],l[13]=i[13],l[14]=i[14],l[15]=i[15]),l[4]=g*p+N*u,l[5]=y*p+I*u,l[6]=v*p+P*u,l[7]=T*p+j*u,l[8]=N*p-g*u,l[9]=I*p-y*u,l[10]=P*p-v*u,l[11]=j*p-T*u,l}function Ce(l,i,a){var u=Math.sin(a),p=Math.cos(a),g=i[0],y=i[1],v=i[2],T=i[3],N=i[8],I=i[9],P=i[10],j=i[11];return i!==l&&(l[4]=i[4],l[5]=i[5],l[6]=i[6],l[7]=i[7],l[12]=i[12],l[13]=i[13],l[14]=i[14],l[15]=i[15]),l[0]=g*p-N*u,l[1]=y*p-I*u,l[2]=v*p-P*u,l[3]=T*p-j*u,l[8]=g*u+N*p,l[9]=y*u+I*p,l[10]=v*u+P*p,l[11]=T*u+j*p,l}function ne(l,i,a){var u=Math.sin(a),p=Math.cos(a),g=i[0],y=i[1],v=i[2],T=i[3],N=i[4],I=i[5],P=i[6],j=i[7];return i!==l&&(l[8]=i[8],l[9]=i[9],l[10]=i[10],l[11]=i[11],l[12]=i[12],l[13]=i[13],l[14]=i[14],l[15]=i[15]),l[0]=g*p+N*u,l[1]=y*p+I*u,l[2]=v*p+P*u,l[3]=T*p+j*u,l[4]=N*p-g*u,l[5]=I*p-y*u,l[6]=P*p-v*u,l[7]=j*p-T*u,l}function ae(l,i){return l[0]=i[0],l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=i[1],l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[10]=i[2],l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,l}function q(l,i,a){var u,p,g,y=a[0],v=a[1],T=a[2],N=Math.sqrt(y*y+v*v+T*T);return N<C?null:(y*=N=1/N,v*=N,T*=N,u=Math.sin(i),p=Math.cos(i),l[0]=y*y*(g=1-p)+p,l[1]=v*y*g+T*u,l[2]=T*y*g-v*u,l[3]=0,l[4]=y*v*g-T*u,l[5]=v*v*g+p,l[6]=T*v*g+y*u,l[7]=0,l[8]=y*T*g+v*u,l[9]=v*T*g-y*u,l[10]=T*T*g+p,l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,l)}function oe(l,i){var a=i[0],u=i[1],p=i[2],g=i[4],y=i[5],v=i[6],T=i[8],N=i[9],I=i[10];return l[0]=Math.sqrt(a*a+u*u+p*p),l[1]=Math.sqrt(g*g+y*y+v*v),l[2]=Math.sqrt(T*T+N*N+I*I),l}function ke(l,i){var a=i[0],u=i[1],p=i[2],g=i[3],y=a+a,v=u+u,T=p+p,N=a*y,I=u*y,P=u*v,j=p*y,O=p*v,L=p*T,U=g*y,Z=g*v,G=g*T;return l[0]=1-P-L,l[1]=I+G,l[2]=j-Z,l[3]=0,l[4]=I-G,l[5]=1-N-L,l[6]=O+U,l[7]=0,l[8]=j+Z,l[9]=O-U,l[10]=1-N-P,l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,l}var Ve=K;function ie(){var l=new R(3);return R!=Float32Array&&(l[0]=0,l[1]=0,l[2]=0),l}function ze(l){var i=new R(3);return i[0]=l[0],i[1]=l[1],i[2]=l[2],i}function ve(l){var i=l[0],a=l[1],u=l[2];return Math.sqrt(i*i+a*a+u*u)}function Le(l,i,a){var u=new R(3);return u[0]=l,u[1]=i,u[2]=a,u}function Ke(l,i,a,u){return l[0]=i,l[1]=a,l[2]=u,l}function Pe(l,i,a){return l[0]=i[0]+a[0],l[1]=i[1]+a[1],l[2]=i[2]+a[2],l}function It(l,i,a){return l[0]=i[0]-a[0],l[1]=i[1]-a[1],l[2]=i[2]-a[2],l}function tt(l,i,a){return l[0]=i[0]*a[0],l[1]=i[1]*a[1],l[2]=i[2]*a[2],l}function zt(l,i,a){return l[0]=Math.min(i[0],a[0]),l[1]=Math.min(i[1],a[1]),l[2]=Math.min(i[2],a[2]),l}function vt(l,i,a){return l[0]=Math.max(i[0],a[0]),l[1]=Math.max(i[1],a[1]),l[2]=Math.max(i[2],a[2]),l}function Ot(l,i,a){return l[0]=i[0]*a,l[1]=i[1]*a,l[2]=i[2]*a,l}function Et(l,i,a,u){return l[0]=i[0]+a[0]*u,l[1]=i[1]+a[1]*u,l[2]=i[2]+a[2]*u,l}function yi(l,i){var a=i[0]-l[0],u=i[1]-l[1],p=i[2]-l[2];return Math.sqrt(a*a+u*u+p*p)}function mi(l,i){var a=i[0]-l[0],u=i[1]-l[1],p=i[2]-l[2];return a*a+u*u+p*p}function ht(l){var i=l[0],a=l[1],u=l[2];return i*i+a*a+u*u}function hi(l,i){return l[0]=-i[0],l[1]=-i[1],l[2]=-i[2],l}function ni(l,i){var a=i[0],u=i[1],p=i[2],g=a*a+u*u+p*p;return g>0&&(g=1/Math.sqrt(g)),l[0]=i[0]*g,l[1]=i[1]*g,l[2]=i[2]*g,l}function ui(l,i){return l[0]*i[0]+l[1]*i[1]+l[2]*i[2]}function Fi(l,i,a){var u=i[0],p=i[1],g=i[2],y=a[0],v=a[1],T=a[2];return l[0]=p*T-g*v,l[1]=g*y-u*T,l[2]=u*v-p*y,l}function Ii(l,i,a,u){var p=i[0],g=i[1],y=i[2];return l[0]=p+u*(a[0]-p),l[1]=g+u*(a[1]-g),l[2]=y+u*(a[2]-y),l}function Bi(l,i,a){var u=i[0],p=i[1],g=i[2],y=a[3]*u+a[7]*p+a[11]*g+a[15];return l[0]=(a[0]*u+a[4]*p+a[8]*g+a[12])/(y=y||1),l[1]=(a[1]*u+a[5]*p+a[9]*g+a[13])/y,l[2]=(a[2]*u+a[6]*p+a[10]*g+a[14])/y,l}function Ki(l,i,a){var u=i[0],p=i[1],g=i[2];return l[0]=u*a[0]+p*a[3]+g*a[6],l[1]=u*a[1]+p*a[4]+g*a[7],l[2]=u*a[2]+p*a[5]+g*a[8],l}function $r(l,i,a){var u=a[0],p=a[1],g=a[2],y=a[3],v=i[0],T=i[1],N=i[2],I=p*N-g*T,P=g*v-u*N,j=u*T-p*v;return l[0]=v+y*(I+=I)+p*(j+=j)-g*(P+=P),l[1]=T+y*P+g*I-u*j,l[2]=N+y*j+u*P-p*I,l}function nn(l){return l[0]=0,l[1]=0,l[2]=0,l}function Gn(l,i){return l[0]===i[0]&&l[1]===i[1]&&l[2]===i[2]}var Tr=It,jt=tt,bi=ve;function ar(){var l=new R(4);return R!=Float32Array&&(l[0]=0,l[1]=0,l[2]=0,l[3]=0),l}function li(l,i,a){return l[0]=i[0]*a,l[1]=i[1]*a,l[2]=i[2]*a,l[3]=i[3]*a,l}function ai(l,i){var a=i[0],u=i[1],p=i[2],g=i[3],y=a*a+u*u+p*p+g*g;return y>0&&(y=1/Math.sqrt(y)),l[0]=a*y,l[1]=u*y,l[2]=p*y,l[3]=g*y,l}function Jt(l,i){return l[0]*i[0]+l[1]*i[1]+l[2]*i[2]+l[3]*i[3]}function Vi(l,i,a){var u=i[0],p=i[1],g=i[2],y=i[3];return l[0]=a[0]*u+a[4]*p+a[8]*g+a[12]*y,l[1]=a[1]*u+a[5]*p+a[9]*g+a[13]*y,l[2]=a[2]*u+a[6]*p+a[10]*g+a[14]*y,l[3]=a[3]*u+a[7]*p+a[11]*g+a[15]*y,l}function fi(){var l=new R(4);return R!=Float32Array&&(l[0]=0,l[1]=0,l[2]=0),l[3]=1,l}function vi(l){return l[0]=0,l[1]=0,l[2]=0,l[3]=1,l}function Pi(l,i,a){a*=.5;var u=i[0],p=i[1],g=i[2],y=i[3],v=Math.sin(a),T=Math.cos(a);return l[0]=u*T+y*v,l[1]=p*T+g*v,l[2]=g*T-p*v,l[3]=y*T-u*v,l}function Nr(l,i,a){a*=.5;var u=i[0],p=i[1],g=i[2],y=i[3],v=Math.sin(a),T=Math.cos(a);return l[0]=u*T-g*v,l[1]=p*T+y*v,l[2]=g*T+u*v,l[3]=y*T-p*v,l}ie(),ar();var er,Wr,kr,di=ai,or=(er=ie(),Wr=Le(1,0,0),kr=Le(0,1,0),function(l,i,a){var u=ui(i,a);return u<-.999999?(Fi(er,Wr,i),bi(er)<1e-6&&Fi(er,kr,i),ni(er,er),function(p,g,y){y*=.5;var v=Math.sin(y);p[0]=v*g[0],p[1]=v*g[1],p[2]=v*g[2],p[3]=Math.cos(y)}(l,er,Math.PI),l):u>.999999?(l[0]=0,l[1]=0,l[2]=0,l[3]=1,l):(Fi(er,i,a),l[0]=er[0],l[1]=er[1],l[2]=er[2],l[3]=1+u,di(l,l))});function jn(){var l=new R(2);return R!=Float32Array&&(l[0]=0,l[1]=0),l}function Da(l,i){var a=new R(2);return a[0]=l,a[1]=i,a}function ms(l,i,a){return l[0]=i,l[1]=a,l}function pt(l,i,a){return l[0]=i[0]+a[0],l[1]=i[1]+a[1],l}function oi(l,i,a){return l[0]=i[0]-a[0],l[1]=i[1]-a[1],l}function Mi(l,i,a){return l[0]=i[0]*a,l[1]=i[1]*a,l}function qi(l){var i=l[0],a=l[1];return Math.sqrt(i*i+a*a)}function Xn(l,i){var a=i[0],u=i[1],p=a*a+u*u;return p>0&&(p=1/Math.sqrt(p)),l[0]=i[0]*p,l[1]=i[1]*p,l}function mr(l,i){return l[0]*i[0]+l[1]*i[1]}fi(),fi(),$();var sn,al,Ma=oi;function fs(l){return l&&l.__esModule&&Object.prototype.hasOwnProperty.call(l,"default")?l.default:l}jn();var ol=function(){if(al)return sn;function l(i,a,u,p){this.cx=3*i,this.bx=3*(u-i)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*a,this.by=3*(p-a)-this.cy,this.ay=1-this.cy-this.by,this.p1x=i,this.p1y=a,this.p2x=u,this.p2y=p}return al=1,sn=l,l.prototype={sampleCurveX:function(i){return((this.ax*i+this.bx)*i+this.cx)*i},sampleCurveY:function(i){return((this.ay*i+this.by)*i+this.cy)*i},sampleCurveDerivativeX:function(i){return(3*this.ax*i+2*this.bx)*i+this.cx},solveCurveX:function(i,a){if(a===void 0&&(a=1e-6),i<0)return 0;if(i>1)return 1;for(var u=i,p=0;p<8;p++){var g=this.sampleCurveX(u)-i;if(Math.abs(g)<a)return u;var y=this.sampleCurveDerivativeX(u);if(Math.abs(y)<1e-6)break;u-=g/y}var v=0,T=1;for(u=i,p=0;p<20&&(g=this.sampleCurveX(u),!(Math.abs(g-i)<a));p++)i>g?v=u:T=u,u=.5*(T-v)+v;return u},solve:function(i,a){return this.sampleCurveY(this.solveCurveX(i,a))}},sn}(),ll=fs(ol);function wt(l,i){this.x=l,this.y=i}function Xa(l,i){if(Array.isArray(l)){if(!Array.isArray(i)||l.length!==i.length)return!1;for(let a=0;a<l.length;a++)if(!Xa(l[a],i[a]))return!1;return!0}if(typeof l=="object"&&l!==null&&i!==null){if(typeof i!="object"||Object.keys(l).length!==Object.keys(i).length)return!1;for(const a in l)if(!Xa(l[a],i[a]))return!1;return!0}return l===i}wt.prototype={clone(){return new wt(this.x,this.y)},add(l){return this.clone()._add(l)},sub(l){return this.clone()._sub(l)},multByPoint(l){return this.clone()._multByPoint(l)},divByPoint(l){return this.clone()._divByPoint(l)},mult(l){return this.clone()._mult(l)},div(l){return this.clone()._div(l)},rotate(l){return this.clone()._rotate(l)},rotateAround(l,i){return this.clone()._rotateAround(l,i)},matMult(l){return this.clone()._matMult(l)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(l){return this.x===l.x&&this.y===l.y},dist(l){return Math.sqrt(this.distSqr(l))},distSqr(l){const i=l.x-this.x,a=l.y-this.y;return i*i+a*a},angle(){return Math.atan2(this.y,this.x)},angleTo(l){return Math.atan2(this.y-l.y,this.x-l.x)},angleWith(l){return this.angleWithSep(l.x,l.y)},angleWithSep(l,i){return Math.atan2(this.x*i-this.y*l,this.x*l+this.y*i)},_matMult(l){const i=l[2]*this.x+l[3]*this.y;return this.x=l[0]*this.x+l[1]*this.y,this.y=i,this},_add(l){return this.x+=l.x,this.y+=l.y,this},_sub(l){return this.x-=l.x,this.y-=l.y,this},_mult(l){return this.x*=l,this.y*=l,this},_div(l){return this.x/=l,this.y/=l,this},_multByPoint(l){return this.x*=l.x,this.y*=l.y,this},_divByPoint(l){return this.x/=l.x,this.y/=l.y,this},_unit(){return this._div(this.mag()),this},_perp(){const l=this.y;return this.y=this.x,this.x=-l,this},_rotate(l){const i=Math.cos(l),a=Math.sin(l),u=a*this.x+i*this.y;return this.x=i*this.x-a*this.y,this.y=u,this},_rotateAround(l,i){const a=Math.cos(l),u=Math.sin(l),p=i.y+u*(this.x-i.x)+a*(this.y-i.y);return this.x=i.x+a*(this.x-i.x)-u*(this.y-i.y),this.y=p,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:wt},wt.convert=function(l){if(l instanceof wt)return l;if(Array.isArray(l))return new wt(+l[0],+l[1]);if(l.x!==void 0&&l.y!==void 0)return new wt(+l.x,+l.y);throw new Error("Expected [x, y] or {x, y} point format")};const Oi=Math.PI/180,Xr=180/Math.PI;function Zi(l){return l*Oi}function Ze(l){return l*Xr}const te=[[0,0],[1,0],[1,1],[0,1]];function pe(l){if(l<=0)return 0;if(l>=1)return 1;const i=l*l,a=i*l;return 4*(l<.5?a:3*(l-i)+a-.75)}function Ne(l,i,a,u){const p=new ll(l,i,a,u);return function(g){return p.solve(g)}}const Ue=Ne(.25,.1,.25,1);function Ie(l,i,a){return Math.min(a,Math.max(i,l))}function Xe(l,i,a){return(a=Ie((a-l)/(i-l),0,1))*a*(3-2*a)}function Je(l,i,a){const u=a-i,p=((l-i)%u+u)%u+i;return p===i?a:p}function He(l,i,a){if(!l.length)return a(null,[]);let u=l.length;const p=new Array(l.length);let g=null;l.forEach((y,v)=>{i(y,(T,N)=>{T&&(g=T),p[v]=N,--u===0&&a(g,p)})})}let it=1;function At(){return it++}function St(l){return l<=1?1:Math.pow(2,Math.ceil(Math.log2(l)))}function Ht(l,i){l.forEach(a=>{i[a]&&(i[a]=i[a].bind(i))})}function ci(l,i,a){const u={};for(const p in l)u[p]=i.call(this,l[p],p,l);return u}function wi(l,i,a){const u={};for(const p in l)i.call(this,l[p],p,l)&&(u[p]=l[p]);return u}function zi(l){return Array.isArray(l)?l.map(zi):typeof l=="object"&&l?ci(l,zi):l}function $i(l,i){for(let a=0;a<l.length;a++)if(i.indexOf(l[a])>=0)return!0;return!1}const Ei={};function Ni(l){Ei[l]||(typeof console<"u"&&console.warn(l),Ei[l]=!0)}function Br(l,i,a){return(a.y-l.y)*(i.x-l.x)>(i.y-l.y)*(a.x-l.x)}function Nn(l){let i=0;for(let a,u,p=0,g=l.length,y=g-1;p<g;y=p++)a=l[p],u=l[y],i+=(u.x-a.x)*(a.y+u.y);return i}function gn([l,i,a]){const u=Zi(i+90),p=Zi(a);return{x:l*Math.cos(u)*Math.sin(p),y:l*Math.sin(u)*Math.sin(p),z:l*Math.cos(p),azimuthal:i,polar:a}}function Rn(l){return(typeof self<"u"||l!==void 0)&&typeof WorkerGlobalScope<"u"&&(l!==void 0?l:self)instanceof WorkerGlobalScope}function Yr(l){const i={};if(l.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(a,u,p,g)=>{const y=p||g;return i[u]=!y||y.toLowerCase(),""}),i["max-age"]){const a=parseInt(i["max-age"],10);isNaN(a)?delete i["max-age"]:i["max-age"]=a}return i}let cr=null;function Jr(l,i){return[l[4*i],l[4*i+1],l[4*i+2],l[4*i+3]]}function Or(l,i,a,u){for(;i<a;){const p=i+a>>1;l[p]<u?i=p+1:a=p}return i}function Lr(l,i,a,u){for(;i<a;){const p=i+a>>1;l[p]<=u?i=p+1:a=p}return i}function yn(l){return l>0?1/(1.001-l):1+l}function Es(l){return l>0?1-1/(1.001-l):-l}function Is(l,i,a){return(l-i.min)*(a.max-a.min)/(i.max-i.min)+a.min}const ns={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!ns.API_URL)return null;try{const l=new URL(ns.API_URL);return l.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":l.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",BUILDING_GEN_URL:"https://api.mapbox.com/mapbox-gl-js/building-gen/building_gen_v1.2.4.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function wl(l){return ns.API_URL_REGEX.test(l)}function Zs(l){return ns.API_SPRITE_REGEX.test(l)}let Oa,Xs,Ms,la,Os,cl;function xn(){return Oa==null&&(Oa=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),Oa}const xa={now:()=>la!==void 0?la:performance.now(),setNow(l){la=l},restoreNow(){la=void 0},frame(l){const i=requestAnimationFrame(l);return{cancel:()=>cancelAnimationFrame(i)}},getImageData(l,i=0){const{width:a,height:u}=l;Os||(Os=document.createElement("canvas"));const p=Os.getContext("2d",{willReadFrequently:!0});if(!p)throw new Error("failed to create canvas 2d context");return(a>Os.width||u>Os.height)&&(Os.width=a,Os.height=u),p.clearRect(-i,-i,a+2*i,u+2*i),p.drawImage(l,0,0,a,u),p.getImageData(-i,-i,a+2*i,u+2*i)},resolveURL:l=>(Xs||(Xs=document.createElement("a")),Xs.href=l,Xs.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(Ms==null&&(Ms=window.matchMedia("(prefers-reduced-motion: reduce)")),Ms.matches)},hasCanvasFingerprintNoise(){if(cl!==void 0)return cl;if(!xn())return cl=!1,!1;const l=new OffscreenCanvas(85,1),i=l.getContext("2d",{willReadFrequently:!0});let a=0;for(let p=0;p<l.width;++p)i.fillStyle=`rgba(${a++},${a++},${a++}, 255)`,i.fillRect(p,0,1,1);const u=i.getImageData(0,0,l.width,l.height);a=0;for(let p=0;p<u.data.length;++p)if(p%4!=3&&a++!==u.data[p])return cl=!0,!0;return cl=!1,!1}};function Sl(l,i){const a=l.indexOf("?");if(a<0)return`${l}?${new URLSearchParams(i).toString()}`;const u=new URLSearchParams(l.slice(a));for(const p in i)u.set(p,i[p]);return`${l.slice(0,a)}?${u.toString()}`}function Tl(l,i={persistentParams:[]}){const a=l.indexOf("?");if(a<0)return l;const u=new URLSearchParams,p=new URLSearchParams(l.slice(a));for(const y of i.persistentParams){const v=p.get(y);v&&u.set(y,v)}const g=u.toString();return`${l.slice(0,a)}${g.length>0?`?${g}`:""}`}const Sf="mapbox-tiles";let zp=500,Bp=50;const Vp=["language","worldview","jobid"];let Ps,Ya;function Ka(){try{return caches}catch{}}function js(){const l=Ka();l&&Ps==null&&(Ps=l.open(Sf))}let Fo=1/0;const wc={supported:!1,testSupport:function(l){!Hl&&yo&&(eh?Nl(l):Sc=l)}};let Sc,yo,Hl=!1,eh=!1;const Tf=typeof self<"u"?self:{};function Nl(l){const i=l.createTexture();l.bindTexture(l.TEXTURE_2D,i);try{if(l.texImage2D(l.TEXTURE_2D,0,l.RGBA,l.RGBA,l.UNSIGNED_BYTE,yo),l.isContextLost())return;wc.supported=!0}catch{}l.deleteTexture(i),Hl=!0}Tf.document&&(yo=Tf.document.createElement("img"),yo.onload=function(){Sc&&Nl(Sc),Sc=null,eh=!0},yo.onerror=function(){Hl=!0,Sc=null},yo.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const Ca={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze(Ca);class id extends Error{constructor(i,a,u){a===401&&wl(u)&&(i+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(i),this.status=a,this.url=u}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const Wl=Rn()?()=>self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,xo=function(l,i){if(!(/^file:/.test(a=l.url)||/^file:/.test(Wl())&&!/^\w+:/.test(a))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(u,p){const g=new AbortController,y=new Request(u.url,{method:u.method||"GET",body:u.body,credentials:u.credentials,headers:u.headers,referrer:Wl(),referrerPolicy:u.referrerPolicy,signal:g.signal});let v=!1,T=!1;const N=(I=y.url).indexOf("sku=")>0&&wl(I);var I;u.type==="json"&&y.headers.set("Accept","application/json");const P=(O,L,U)=>{if(T)return;if(O&&O.message!=="SecurityError"&&Ni(O.toString()),L&&U)return j(L);const Z=Date.now();fetch(y).then(G=>{if(G.ok){const ee=N?G.clone():null;return j(G,ee,Z)}return p(new id(G.statusText,G.status,u.url))}).catch(G=>{G.name!=="AbortError"&&p(new Error(`${G.message} ${u.url}`))})},j=(O,L,U)=>{(u.type==="arrayBuffer"?O.arrayBuffer():u.type==="json"?O.json():O.text()).then(Z=>{T||(L&&U&&function(G,ee,le){if(js(),Ps==null)return;const me=Yr(ee.headers.get("Cache-Control")||"");if(me["no-store"])return;const we={status:ee.status,statusText:ee.statusText,headers:new Headers};ee.headers.forEach((Me,je)=>we.headers.set(je,Me)),me["max-age"]&&we.headers.set("Expires",new Date(le+1e3*me["max-age"]).toUTCString());const be=we.headers.get("Expires");if(!be||new Date(be).getTime()-le<42e4)return;let Re=Tl(G.url,{persistentParams:Vp});if(ee.status===206){const Me=G.headers.get("Range");if(!Me)return;we.status=200,Re=Sl(Re,{range:Me})}(function(Me,je){if(Ya===void 0)try{new Response(new ReadableStream),Ya=!0}catch{Ya=!1}Ya?je(Me.body):Me.blob().then(je).catch(Be=>Ni(Be.message))})(ee,Me=>{const je=new Response((Be=ee.status)!==200&&Be!==404&&[101,103,204,205,304].includes(Be)?null:Me,we);var Be;js(),Ps!=null&&Ps.then(Ge=>Ge.put(Re,je)).catch(Ge=>Ni(Ge.message))})}(y,L,U),v=!0,p(null,Z,O.headers))}).catch(Z=>{T||p(new Error(Z.message))})};return N?function(O,L){if(js(),Ps==null)return L(null);Ps.then(U=>{let Z=Tl(O.url,{persistentParams:Vp});const G=O.headers.get("Range");G&&(Z=Sl(Z,{range:G})),U.match(Z).then(ee=>{const le=function(me){if(!me)return!1;const we=new Date(me.headers.get("Expires")||0),be=Yr(me.headers.get("Cache-Control")||"");return Number(we)>Date.now()&&!be["no-cache"]}(ee);U.delete(Z).catch(L),le&&U.put(Z,ee.clone()).catch(L),L(null,ee,le)}).catch(L)}).catch(L)}(y,P):P(null,null),{cancel:()=>{T=!0,v||g.abort()}}}(l,i);if(Rn(self)&&self.worker.actor)return self.worker.actor.send("getResource",l,i,void 0,!0)}var a;return function(u,p){const g=new XMLHttpRequest;g.open(u.method||"GET",u.url,!0),u.type==="arrayBuffer"&&(g.responseType="arraybuffer");for(const y in u.headers)g.setRequestHeader(y,u.headers[y]);return u.type==="json"&&(g.responseType="text",g.setRequestHeader("Accept","application/json")),g.withCredentials=u.credentials==="include",g.onerror=()=>{p(new Error(g.statusText))},g.onload=()=>{if((g.status>=200&&g.status<300||g.status===0)&&g.response!==null){let y=g.response;if(u.type==="json")try{y=JSON.parse(g.response)}catch(T){return p(T)}const v=new Headers;g.getAllResponseHeaders().trim().split(/[\r\n]+/).forEach(T=>{const N=T.split(": "),I=N.shift(),P=N.join(": ");v.append(I,P)}),p(null,y,v)}else p(new id(g.statusText,g.status,u.url))},g.send(u.body),{cancel:()=>g.abort()}}(l,i)},su=function(l,i){return xo(Object.assign(l,{type:"arrayBuffer"}),i)};function rd(l){const i=document.createElement("a");return i.href=l,i.protocol===location.protocol&&i.host===location.host}const Tc="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let hr,Zl;hr=[],Zl=0;const Yn=function(l,i){if(wc.supported&&(l.headers||(l.headers={}),l.headers.accept="image/webp,*/*"),Zl>=ns.MAX_PARALLEL_IMAGE_REQUESTS){const g={requestParameters:l,callback:i,cancelled:!1,cancel(){this.cancelled=!0}};return hr.push(g),g}Zl++;let a=!1;const u=()=>{if(!a)for(a=!0,Zl--;hr.length&&Zl<ns.MAX_PARALLEL_IMAGE_REQUESTS;){const g=hr.shift(),{requestParameters:y,callback:v,cancelled:T}=g;T||(g.cancel=Yn(y,v).cancel)}},p=su(l,(g,y,v)=>{u(),g?i(g):y&&(self.createImageBitmap?function(T,N){const I=new Blob([new Uint8Array(T)],{type:"image/png"});createImageBitmap(I).then(P=>{N(null,P)}).catch(P=>{N(new Error(`Could not load image because of ${P.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(y,(T,N)=>i(T,N,v)):function(T,N){const I=new Image;I.onload=()=>{N(null,I),URL.revokeObjectURL(I.src),I.onload=null,requestAnimationFrame(()=>{I.src=Tc})},I.onerror=()=>N(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const P=new Blob([new Uint8Array(T)],{type:"image/png"});I.src=T.byteLength?URL.createObjectURL(P):Tc}(y,(T,N)=>i(T,N,v)))});return{cancel:()=>{p.cancel(),u()}}};var Nf,Af,au,Al={exports:{}},ou={exports:{}},Nc={exports:{}},Cf=function(){if(au)return Al.exports;au=1;var l=(Nf||(Nf=1,ou.exports=function(a,u){var p,g,y,v,T,N,I,P;for(g=a.length-(p=3&a.length),y=u,T=3432918353,N=461845907,P=0;P<g;)I=255&a.charCodeAt(P)|(255&a.charCodeAt(++P))<<8|(255&a.charCodeAt(++P))<<16|(255&a.charCodeAt(++P))<<24,++P,y=27492+(65535&(v=5*(65535&(y=(y^=I=(65535&(I=(I=(65535&I)*T+(((I>>>16)*T&65535)<<16)&4294967295)<<15|I>>>17))*N+(((I>>>16)*N&65535)<<16)&4294967295)<<13|y>>>19))+((5*(y>>>16)&65535)<<16)&4294967295))+(((v>>>16)+58964&65535)<<16);switch(I=0,p){case 3:I^=(255&a.charCodeAt(P+2))<<16;case 2:I^=(255&a.charCodeAt(P+1))<<8;case 1:y^=I=(65535&(I=(I=(65535&(I^=255&a.charCodeAt(P)))*T+(((I>>>16)*T&65535)<<16)&4294967295)<<15|I>>>17))*N+(((I>>>16)*N&65535)<<16)&4294967295}return y^=a.length,y=2246822507*(65535&(y^=y>>>16))+((2246822507*(y>>>16)&65535)<<16)&4294967295,y=3266489909*(65535&(y^=y>>>13))+((3266489909*(y>>>16)&65535)<<16)&4294967295,(y^=y>>>16)>>>0}),ou.exports),i=(Af||(Af=1,Nc.exports=function(a,u){for(var p,g=a.length,y=u^g,v=0;g>=4;)p=1540483477*(65535&(p=255&a.charCodeAt(v)|(255&a.charCodeAt(++v))<<8|(255&a.charCodeAt(++v))<<16|(255&a.charCodeAt(++v))<<24))+((1540483477*(p>>>16)&65535)<<16),y=1540483477*(65535&y)+((1540483477*(y>>>16)&65535)<<16)^(p=1540483477*(65535&(p^=p>>>24))+((1540483477*(p>>>16)&65535)<<16)),g-=4,++v;switch(g){case 3:y^=(255&a.charCodeAt(v+2))<<16;case 2:y^=(255&a.charCodeAt(v+1))<<8;case 1:y=1540483477*(65535&(y^=255&a.charCodeAt(v)))+((1540483477*(y>>>16)&65535)<<16)}return y=1540483477*(65535&(y^=y>>>13))+((1540483477*(y>>>16)&65535)<<16),(y^=y>>>15)>>>0}),Nc.exports);return Al.exports=l,Al.exports.murmur3=l,Al.exports.murmur2=i,Al.exports}(),La=fs(Cf);class ul{constructor(i,...a){Object.assign(this,a[0]||{}),this.type=i}}class nd extends ul{constructor(i,a={}){super("error",Object.assign({error:i},a))}}function lu(l,i,a){a[l]&&a[l].indexOf(i)!==-1||(a[l]=a[l]||[],a[l].push(i))}function Xl(l,i,a){if(a&&a[l]){const u=a[l].indexOf(i);u!==-1&&a[l].splice(u,1)}}class zo{on(i,a){return this._listeners=this._listeners||{},lu(i,a,this._listeners),this}off(i,a){return Xl(i,a,this._listeners),Xl(i,a,this._oneTimeListeners),this}once(i,a){return a?(this._oneTimeListeners=this._oneTimeListeners||{},lu(i,a,this._oneTimeListeners),this):new Promise(u=>{this.once(i,u)})}fire(i,a){const u=typeof i=="string"?new ul(i,a):i,p=u.type;if(this.listens(p)){u.target=this;const g=this._listeners&&this._listeners[p]?this._listeners[p].slice():[];for(const T of g)T.call(this,u);const y=this._oneTimeListeners&&this._oneTimeListeners[p]?this._oneTimeListeners[p].slice():[];for(const T of y)Xl(p,T,this._oneTimeListeners),T.call(this,u);const v=this._eventedParent;if(v){const T=typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData;Object.assign(u,T),v.fire(u)}}else u instanceof nd&&console.error(u.error);return this}listens(i){return!!(this._listeners&&this._listeners[i]&&this._listeners[i].length>0||this._oneTimeListeners&&this._oneTimeListeners[i]&&this._oneTimeListeners[i].length>0||this._eventedParent&&this._eventedParent.listens(i))}setEventedParent(i,a){return this._eventedParent=i,this._eventedParentData=a,this}}class Ys{constructor(i){typeof i=="string"?this.name=i:(this.name=i.name,this.iconsetId=i.iconsetId)}static from(i){return new Ys(i)}static toString(i){return i.iconsetId?`${i.name}${i.iconsetId}`:i.name}static parse(i){const[a,u]=i.split("");return new Ys({name:a,iconsetId:u})}static isEqual(i,a){return i.name===a.name&&i.iconsetId===a.iconsetId}toString(){return Ys.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}}var Qa,Ac={},Ef=function(){if(Qa)return Ac;Qa=1;var l={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function i(g){return(g=Math.round(g))<0?0:g>255?255:g}function a(g){return i(g[g.length-1]==="%"?parseFloat(g)/100*255:parseInt(g))}function u(g){return(y=g[g.length-1]==="%"?parseFloat(g)/100:parseFloat(g))<0?0:y>1?1:y;var y}function p(g,y,v){return v<0?v+=1:v>1&&(v-=1),6*v<1?g+(y-g)*v*6:2*v<1?y:3*v<2?g+(y-g)*(2/3-v)*6:g}try{Ac.parseCSSColor=function(g){var y,v=g.replace(/ /g,"").toLowerCase();if(v in l)return l[v].slice();if(v[0]==="#")return v.length===4?(y=parseInt(v.substr(1),16))>=0&&y<=4095?[(3840&y)>>4|(3840&y)>>8,240&y|(240&y)>>4,15&y|(15&y)<<4,1]:null:v.length===7&&(y=parseInt(v.substr(1),16))>=0&&y<=16777215?[(16711680&y)>>16,(65280&y)>>8,255&y,1]:null;var T=v.indexOf("("),N=v.indexOf(")");if(T!==-1&&N+1===v.length){var I=v.substr(0,T),P=v.substr(T+1,N-(T+1)).split(","),j=1;switch(I){case"rgba":if(P.length!==4)return null;j=u(P.pop());case"rgb":return P.length!==3?null:[a(P[0]),a(P[1]),a(P[2]),j];case"hsla":if(P.length!==4)return null;j=u(P.pop());case"hsl":if(P.length!==3)return null;var O=(parseFloat(P[0])%360+360)%360/360,L=u(P[1]),U=u(P[2]),Z=U<=.5?U*(L+1):U+L-U*L,G=2*U-Z;return[i(255*p(G,Z,O+1/3)),i(255*p(G,Z,O)),i(255*p(G,Z,O-1/3)),j];default:return null}}return null}}catch{}return Ac}();class Ar{constructor(i,a,u,p=1){this.r=i,this.g=a,this.b=u,this.a=p}static parse(i){if(!i)return;if(i instanceof Ar)return i;if(typeof i!="string")return;const a=Ef.parseCSSColor(i);return a?new Ar(a[0]/255,a[1]/255,a[2]/255,a[3]):void 0}toString(){const[i,a,u,p]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*i)},${Math.round(255*a)},${Math.round(255*u)},${p})`}toNonPremultipliedRenderColor(i){const{r:a,g:u,b:p,a:g}=this;return new Up(i,a,u,p,g)}toPremultipliedRenderColor(i){const{r:a,g:u,b:p,a:g}=this;return new qp(i,a*g,u*g,p*g,g)}clone(){return new Ar(this.r,this.g,this.b,this.a)}}class Cc{constructor(i,a,u,p,g,y=!1){if(this.premultiplied=!1,this.premultiplied=y,i){const v=i.image.height,T=v*v;this.premultiplied?(a=g===0?0:a/g*(v-1),u=g===0?0:u/g*(v-1),p=g===0?0:p/g*(v-1)):(a*=v-1,u*=v-1,p*=v-1);const N=Math.floor(a),I=Math.floor(u),P=Math.floor(p),j=Math.ceil(a),O=Math.ceil(u),L=Math.ceil(p),U=a-N,Z=u-I,G=p-P,ee=i.image.data,le=4*(N+I*T+P*v),me=4*(N+I*T+L*v),we=4*(N+O*T+P*v),be=4*(N+O*T+L*v),Re=4*(j+I*T+P*v),Me=4*(j+I*T+L*v),je=4*(j+O*T+P*v),Be=4*(j+O*T+L*v);if(le<0||Be>=ee.length)throw new Error("out of range");this.r=Si(Si(Si(ee[le],ee[me],G),Si(ee[we],ee[be],G),Z),Si(Si(ee[Re],ee[Me],G),Si(ee[je],ee[Be],G),Z),U)/255*(this.premultiplied?g:1),this.g=Si(Si(Si(ee[le+1],ee[me+1],G),Si(ee[we+1],ee[be+1],G),Z),Si(Si(ee[Re+1],ee[Me+1],G),Si(ee[je+1],ee[Be+1],G),Z),U)/255*(this.premultiplied?g:1),this.b=Si(Si(Si(ee[le+2],ee[me+2],G),Si(ee[we+2],ee[be+2],G),Z),Si(Si(ee[Re+2],ee[Me+2],G),Si(ee[je+2],ee[Be+2],G),Z),U)/255*(this.premultiplied?g:1),this.a=g}else this.r=a,this.g=u,this.b=p,this.a=g}toArray(){const{r:i,g:a,b:u,a:p}=this;return[255*i,255*a,255*u,p]}toHslaArray(){let{r:i,g:a,b:u,a:p}=this;if(this.premultiplied){if(p===0)return[0,0,0,0];const L=1/p;i*=L,a*=L,u*=L}const g=Math.min(Math.max(i,0),1),y=Math.min(Math.max(a,0),1),v=Math.min(Math.max(u,0),1),T=Math.min(g,y,v),N=Math.max(g,y,v),I=N-T,P=.5*(T+N);if(I===0)return[0,0,100*P,p];const j=P>.5?I/(2-N-T):I/(N+T);let O;switch(N){case g:O=60*((y-v)/I+(y<v?6:0));break;case y:O=60*((v-g)/I+2);break;default:O=60*((g-y)/I+4)}return[O,100*j,100*P,p]}toArray01(){const{r:i,g:a,b:u,a:p}=this;return[i,a,u,p]}toArray01Scaled(i){const{r:a,g:u,b:p}=this;return[a*i,u*i,p*i]}toArray01Linear(){const{r:i,g:a,b:u,a:p}=this;return[Math.pow(i,2.2),Math.pow(a,2.2),Math.pow(u,2.2),p]}}class Up extends Cc{constructor(i,a,u,p,g){super(i,a,u,p,g,!1)}}class qp extends Cc{constructor(i,a,u,p,g){super(i,a,u,p,g,!0)}}function Si(l,i,a){return l*(1-a)+i*a}function sd(l,i,a){return l.map((u,p)=>Si(u,i[p],a))}Ar.black=new Ar(0,0,0,1),Ar.white=new Ar(1,1,1,1),Ar.transparent=new Ar(0,0,0,0),Ar.red=new Ar(1,0,0,1),Ar.blue=new Ar(0,0,1,1);var Yl=Object.freeze({__proto__:null,array:sd,color:function(l,i,a){return new Ar(Si(l.r,i.r,a),Si(l.g,i.g,a),Si(l.b,i.b,a),Si(l.a,i.a,a))},number:Si});class Ls extends Error{constructor(i,a){super(a),this.message=a,this.key=i}}class ad{constructor(i,a=[]){this.parent=i,this.bindings={};for(const[u,p]of a)this.bindings[u]=p}concat(i){return new ad(this,i)}get(i){if(this.bindings[i])return this.bindings[i];if(this.parent)return this.parent.get(i);throw new Error(`${i} not found in scope.`)}has(i){return!!this.bindings[i]||!!this.parent&&this.parent.has(i)}}const _a={kind:"null"},ii={kind:"number"},br={kind:"string"},gr={kind:"boolean"},ca={kind:"color"},Ec={kind:"object"},wr={kind:"value"},va={kind:"collator"},Ic={kind:"formatted"},Kl={kind:"resolvedImage"};function as(l,i){return{kind:"array",itemType:l,N:i}}function k(l){if(l.kind==="array"){const i=k(l.itemType);return typeof l.N=="number"?`array<${i}, ${l.N}>`:l.itemType.kind==="value"?"array":`array<${i}>`}return l.kind}const re=[_a,ii,br,gr,ca,Ic,Ec,as(wr),Kl];function ye(l,i){if(i.kind==="error")return null;if(l.kind==="array"){if(i.kind==="array"&&(i.N===0&&i.itemType.kind==="value"||!ye(l.itemType,i.itemType))&&(typeof l.N!="number"||l.N===i.N))return null}else{if(l.kind===i.kind)return null;if(l.kind==="value"){for(const a of re)if(!ye(a,i))return null}}return`Expected ${k(l)} but found ${k(i)} instead.`}function We(l,i){return i.some(a=>a.kind===l.kind)}function Pt(l,i){return i.some(a=>a==="null"?l===null:a==="array"?Array.isArray(l):a==="object"?l&&!Array.isArray(l)&&typeof l=="object":a===typeof l)}function qt(l,i){return l.kind==="array"&&i.kind==="array"?l.N===i.N&&qt(l.itemType,i.itemType):l.kind===i.kind}class Ti{constructor(i,a,u){this.sensitivity=i?a?"variant":"case":a?"accent":"base",this.locale=u,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(i,a){return this.collator.compare(i,a)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class An{constructor(i,a,u,p,g){this.text=i.normalize?i.normalize():i,this.image=a,this.scale=u,this.fontStack=p,this.textColor=g}}class an{constructor(i){this.sections=i}static fromString(i){return new an([new An(i,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(i=>i.text.length!==0||!!i.image&&i.image.hasPrimary())}static factory(i){return i instanceof an?i:an.fromString(i)}toString(){return this.sections.length===0?"":this.sections.map(i=>i.text).join("")}serialize(){const i=["format"];for(const a of this.sections){if(a.image){const p=a.image.getPrimary().id.toString();i.push(["image",p]);continue}i.push(a.text);const u={};a.fontStack&&(u["text-font"]=["literal",a.fontStack.split(",")]),a.scale&&(u["font-scale"]=a.scale),a.textColor&&(u["text-color"]=["rgba"].concat(a.textColor.toNonPremultipliedRenderColor(null).toArray())),i.push(u)}return i}}class Er{constructor(i,a={}){this.id=Ys.from(i),this.params=a.params,this.sx=a.sx||1,this.sy=a.sy||1}toString(){return JSON.stringify(this)}static parse(i){let a,u,p,g;try{({id:a,params:u,sx:p,sy:g}=JSON.parse(i)||{})}catch{return null}return a?new Er(a,{params:u,sx:p,sy:g}):null}scaleSelf(i,a=i){return this.sx*=i,this.sy*=a,this}}class Cn{constructor(i,a,u,p,g=!1){this.primaryId=Ys.from(i),this.primaryOptions=a,u&&(this.secondaryId=Ys.from(u)),this.secondaryOptions=p,this.available=g}toString(){return this.primaryId&&this.secondaryId?`[${this.primaryId.name},${this.secondaryId.name}]`:this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new Er(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new Er(this.secondaryId,this.secondaryOptions):null}static from(i){return typeof i=="string"?Cn.build({name:i}):i}static build(i,a,u,p){return!i||typeof i=="object"&&!("name"in i)?null:new Cn(i,u,a,p)}}function Ks(l,i,a,u){return typeof l=="number"&&l>=0&&l<=255&&typeof i=="number"&&i>=0&&i<=255&&typeof a=="number"&&a>=0&&a<=255?u===void 0||typeof u=="number"&&u>=0&&u<=1?null:`Invalid rgba value [${[l,i,a,u].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof u=="number"?[l,i,a,u]:[l,i,a]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Ja(l){if(l===null||typeof l=="string"||typeof l=="boolean"||typeof l=="number"||l instanceof Ar||l instanceof Ti||l instanceof an||l instanceof Cn)return!0;if(Array.isArray(l)){for(const i of l)if(!Ja(i))return!1;return!0}if(typeof l=="object"){for(const i in l)if(!Ja(l[i]))return!1;return!0}return!1}function un(l){if(l===null)return _a;if(typeof l=="string")return br;if(typeof l=="boolean")return gr;if(typeof l=="number")return ii;if(l instanceof Ar)return ca;if(l instanceof Ti)return va;if(l instanceof an)return Ic;if(l instanceof Cn)return Kl;if(Array.isArray(l)){const i=l.length;let a;for(const u of l){const p=un(u);if(a){if(a===p)continue;a=wr;break}a=p}return as(a||wr,i)}return Ec}function eo(l){const i=typeof l;return l===null?"":i==="string"||i==="number"||i==="boolean"?String(l):l instanceof an||l instanceof Cn||l instanceof Ar?l.toString():JSON.stringify(l)}class Bo{constructor(i,a){this.type=i,this.value=a}static parse(i,a){if(i.length!==2)return a.error(`'literal' expression requires exactly one argument, but found ${i.length-1} instead.`);if(!Ja(i[1]))return a.error("invalid value");const u=i[1];let p=un(u);const g=a.expectedType;return p.kind!=="array"||p.N!==0||!g||g.kind!=="array"||typeof g.N=="number"&&g.N!==0||(p=g),new Bo(p,u)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Ar?["rgba"].concat(this.value.toNonPremultipliedRenderColor(null).toArray()):this.value instanceof an?this.value.serialize():this.value}}class gs{constructor(i){this.name="ExpressionEvaluationError",this.message=i}toJSON(){return this.message}}const cu={string:br,number:ii,boolean:gr,object:Ec};class Di{constructor(i,a){this.type=i,this.args=a}static parse(i,a){if(i.length<2)return a.error("Expected at least one argument.");let u,p=1;const g=i[0];if(g==="array"){let v,T;if(i.length>2){const N=i[1];if(typeof N!="string"||!(N in cu)||N==="object")return a.error('The item type argument of "array" must be one of string, number, boolean',1);v=cu[N],p++}else v=wr;if(i.length>3){if(i[2]!==null&&(typeof i[2]!="number"||i[2]<0||i[2]!==Math.floor(i[2])))return a.error('The length argument to "array" must be a positive integer literal',2);T=i[2],p++}u=as(v,T)}else u=cu[g];const y=[];for(;p<i.length;p++){const v=a.parse(i[p],p,wr);if(!v)return null;y.push(v)}return new Di(u,y)}evaluate(i){for(let a=0;a<this.args.length;a++){const u=this.args[a].evaluate(i);if(!ye(this.type,un(u)))return u;if(a===this.args.length-1)throw new gs(`The expression ${JSON.stringify(this.args[a].serialize())} evaluated to ${k(un(u))} but was expected to be of type ${k(this.type)}.`)}return null}eachChild(i){this.args.forEach(i)}outputDefined(){return this.args.every(i=>i.outputDefined())}serialize(){const i=this.type,a=[i.kind];if(i.kind==="array"){const u=i.itemType;if(u.kind==="string"||u.kind==="number"||u.kind==="boolean"){a.push(u.kind);const p=i.N;(typeof p=="number"||this.args.length>1)&&a.push(p)}}return a.concat(this.args.map(u=>u.serialize()))}}class si{constructor(i){this.type=Ic,this.sections=i}static parse(i,a){if(i.length<2)return a.error("Expected at least one argument.");const u=i[1];if(!Array.isArray(u)&&typeof u=="object")return a.error("First argument must be an image or text section.");const p=[];let g=!1;for(let y=1;y<=i.length-1;++y){const v=i[y];if(g&&typeof v=="object"&&!Array.isArray(v)){g=!1;let T=null;if(v["font-scale"]&&(T=a.parseObjectValue(v["font-scale"],y,"font-scale",ii),!T))return null;let N=null;if(v["text-font"]&&(N=a.parseObjectValue(v["text-font"],y,"text-font",as(br)),!N))return null;let I=null;if(v["text-color"]&&(I=a.parseObjectValue(v["text-color"],y,"text-color",ca),!I))return null;const P=p[p.length-1];P.scale=T,P.font=N,P.textColor=I}else{const T=a.parse(i[y],y,wr);if(!T)return null;const N=T.type.kind;if(N!=="string"&&N!=="value"&&N!=="null"&&N!=="resolvedImage")return a.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");g=!0,p.push({content:T,scale:null,font:null,textColor:null})}}return new si(p)}evaluate(i){return new an(this.sections.map(a=>{const u=a.content.evaluate(i);return qt(un(u),Kl)?new An("",u,null,null,null):new An(eo(u),null,a.scale?a.scale.evaluate(i):null,a.font?a.font.evaluate(i).join(","):null,a.textColor?a.textColor.evaluate(i):null)}))}eachChild(i){for(const a of this.sections)i(a.content),a.scale&&i(a.scale),a.font&&i(a.font),a.textColor&&i(a.textColor)}outputDefined(){return!1}serialize(){const i=["format"];for(const a of this.sections){i.push(a.content.serialize());const u={};a.scale&&(u["font-scale"]=a.scale.serialize()),a.font&&(u["text-font"]=a.font.serialize()),a.textColor&&(u["text-color"]=a.textColor.serialize()),i.push(u)}return i}}class th{constructor(i,a,u,p){this._imageWarnHistory={},this.type=Kl,this.namePrimary=i,this.nameSecondary=a,u&&(this.paramsPrimary=u.params,this.iconsetIdPrimary=u.iconset?u.iconset.id:void 0),p&&(this.paramsSecondary=p.params,this.iconsetIdSecondary=p.iconset?p.iconset.id:void 0)}static parse(i,a){if(i.length<2)return a.error("Expected two or more arguments.");let u=1;const p=[];function g(){if(u<i.length){const v=a.parse(i[u],u++,br);return v?(p.push({image:v,options:{}}),!0):(a.error(p.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function y(){if(u<i.length){const T=i[u];if((v=T)===null||typeof v!="object"||Array.isArray(v))return!0;const N=T.params,I=T.iconset,P=a.concat(u);if(!N&&!I)return u++,!0;if(N){if(typeof N!="object"||N.constructor!==Object)return P.error('Image options "params" should be an object'),!1;const j={},O=P.concat(void 0,"params");for(const L in N){if(!L)return O.error("Image parameter name should be non-empty"),!1;const U=O.concat(void 0,L).parse(N[L],void 0,ca,void 0,{typeAnnotation:"coerce"});if(!U)return!1;j[L]=U}p[p.length-1].options.params=j}if(I){if(typeof I!="object"||I.constructor!==Object)return P.error('Image options "iconset" should be an object'),!1;if(!I.id)return P.error('Image options "iconset" should have an "id" property'),!1;p[p.length-1].options.iconset=I}return u++,!0}var v;return!0}for(let v=0;v<2;v++)if(!g()||!y())return;return new th(p[0].image,p[1]?p[1].image:void 0,p[0].options,p[1]?p[1].options:void 0)}evaluateParams(i,a){const u={};if(a){for(const p in a)if(a[p])try{u[p]=a[p].evaluate(i)}catch{continue}if(Object.keys(u).length!==0)return{params:u}}}evaluate(i){const a={name:this.namePrimary.evaluate(i),iconsetId:this.iconsetIdPrimary},u=this.nameSecondary?{name:this.nameSecondary.evaluate(i),iconsetId:this.iconsetIdSecondary}:void 0,p=Cn.build(a,u,this.paramsPrimary?this.evaluateParams(i,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(i,this.paramsSecondary):void 0);if(p&&i.availableImages){const g=p.getPrimary().id;if(p.available=i.availableImages.some(y=>Ys.isEqual(y,g)),p.available){const y=p.getSecondary()?p.getSecondary().id:null;y&&(p.available=i.availableImages.some(v=>Ys.isEqual(v,y)))}}return p}eachChild(i){if(i(this.namePrimary),this.paramsPrimary)for(const a in this.paramsPrimary)this.paramsPrimary[a]&&i(this.paramsPrimary[a]);if(this.nameSecondary&&(i(this.nameSecondary),this.paramsSecondary))for(const a in this.paramsSecondary)this.paramsSecondary[a]&&i(this.paramsSecondary[a])}outputDefined(){return!1}serializeOptions(i,a){const u={};if(a&&(u.iconset={id:a}),i){u.params={};for(const p in i)i[p]&&(u.params[p]=i[p].serialize())}return Object.keys(u).length>0?u:void 0}serialize(){const i=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){const a=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);a&&i.push(a)}if(this.nameSecondary&&(i.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){const a=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);a&&i.push(a)}return i}}function ji(l){return $p(l)?"string":Ai(l)?"number":ax(l)?"boolean":Array.isArray(l)?"array":l===null?"null":If(l)?"object":typeof l}function If(l){return l!=null&&!Array.isArray(l)&&typeof l!="function"&&!(l instanceof String||l instanceof Number||l instanceof Boolean)&&typeof l=="object"}function $p(l){return typeof l=="string"||l instanceof String}function Ai(l){return typeof l=="number"||l instanceof Number}function ax(l){return typeof l=="boolean"||l instanceof Boolean}const ox={"to-boolean":gr,"to-color":ca,"to-number":ii,"to-string":br};class Ql{constructor(i,a){this.type=i,this.args=a}static parse(i,a){if(i.length<2)return a.error("Expected at least one argument.");const u=i[0],p=[];let g=_a;if(u==="to-array"){if(!Array.isArray(i[1]))return null;const y=i[1].length;if(a.expectedType){if(a.expectedType.kind!=="array")return a.error(`Expected ${a.expectedType.kind} but found array.`);g=as(a.expectedType.itemType,y)}else{if(!(y>0&&Ja(i[1][0])))return null;g=as(un(i[1][0]),y)}for(let v=0;v<y;v++){const T=i[1][v];let N;if(Array.isArray(T))N=a.parse(T,void 0,g.itemType);else{const I=ji(T);if(I!==g.itemType.kind)return a.error(`Expected ${g.itemType.kind} but found ${I}.`);N=a.registry.literal.parse(["literal",T===void 0?null:T],a)}if(!N)return null;p.push(N)}}else{if((u==="to-boolean"||u==="to-string")&&i.length!==2)return a.error("Expected one argument.");g=ox[u];for(let y=1;y<i.length;y++){const v=a.parse(i[y],y,wr);if(!v)return null;p.push(v)}}return new Ql(g,p)}evaluate(i){if(this.type.kind==="boolean")return!!this.args[0].evaluate(i);if(this.type.kind==="color"){let a,u;for(const p of this.args){if(a=p.evaluate(i),u=null,a instanceof Ar)return a;if(typeof a=="string"){const g=i.parseColor(a);if(g)return g}else if(Array.isArray(a)&&(u=a.length<3||a.length>4?`Invalid rbga value ${JSON.stringify(a)}: expected an array containing either three or four numeric values.`:Ks(a[0],a[1],a[2],a[3]),!u))return new Ar(a[0]/255,a[1]/255,a[2]/255,a[3])}throw new gs(u||`Could not parse color from value '${typeof a=="string"?a:String(JSON.stringify(a))}'`)}if(this.type.kind==="number"){let a=null;for(const u of this.args){if(a=u.evaluate(i),a===null)return 0;const p=Number(a);if(!isNaN(p))return p}throw new gs(`Could not convert ${JSON.stringify(a)} to number.`)}return this.type.kind==="formatted"?an.fromString(eo(this.args[0].evaluate(i))):this.type.kind==="resolvedImage"?Cn.build(eo(this.args[0].evaluate(i))):this.type.kind==="array"?this.args.map(a=>a.evaluate(i)):eo(this.args[0].evaluate(i))}eachChild(i){this.args.forEach(i)}outputDefined(){return this.args.every(i=>i.outputDefined())}serialize(){if(this.type.kind==="formatted")return new si([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new th(this.args[0]).serialize();const i=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild(a=>{i.push(a.serialize())}),i}}const sb=["Unknown","Point","LineString","Polygon"];class ih{constructor(i,a,u){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=i,this.options=a,this.iconImageUseTheme=u}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?sb[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(i){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const i=this.featureDistanceData.center,a=this.featureDistanceData.scale,{x:u,y:p}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(u*a-i[0])+this.featureDistanceData.bearing[1]*(p*a-i[1])}return 0}parseColor(i){let a=this._parseColorCache[i];return a||(a=this._parseColorCache[i]=Ar.parse(i)),a}getConfig(i){return this.options?this.options.get(i):null}}class to{constructor(i,a,u,p,g){this.name=i,this.type=a,this._evaluate=u,this.args=p,this._overloadIndex=g}evaluate(i){if(!this._evaluate){const a=to.definitions[this.name];this._evaluate=Array.isArray(a)?a[2]:a.overloads[this._overloadIndex][1]}return this._evaluate(i,this.args)}eachChild(i){this.args.forEach(i)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(i=>i.serialize()))}static parse(i,a){const u=i[0],p=to.definitions[u];if(!p)return a.error(`Unknown expression "${u}". If you wanted a literal array, use ["literal", [...]].`,0);const g=Array.isArray(p)?p[0]:p.type,y=Array.isArray(p)?[[p[1],p[2]]]:p.overloads,v=[];let T=null,N=-1;for(const[I,P]of y){if(Array.isArray(I)&&I.length!==i.length-1)continue;v.push(I),N++,T=new zf(a.registry,a.path,null,a.scope,void 0,a._scope,a.options,a.iconImageUseTheme);const j=[];let O=!1;for(let L=1;L<i.length;L++){const U=i[L],Z=Array.isArray(I)?I[L-1]:I.type,G=T.parse(U,1+j.length,Z);if(!G){O=!0;break}j.push(G)}if(!O)if(Array.isArray(I)&&I.length!==j.length)T.error(`Expected ${I.length} arguments, but found ${j.length} instead.`);else{for(let L=0;L<j.length;L++){const U=Array.isArray(I)?I[L]:I.type,Z=j[L];T.concat(L+1).checkSubtype(U,Z.type)}if(T.errors.length===0)return new to(u,g,P,j,N)}}if(v.length===1)a.errors.push(...T.errors);else{const I=(v.length?v:y.map(([j])=>j)).map(lx).join(" | "),P=[];for(let j=1;j<i.length;j++){const O=a.parse(i[j],1+P.length);if(!O)return null;P.push(k(O.type))}a.error(`Expected arguments of type ${I}, but found (${P.join(", ")}) instead.`)}return null}static register(i,a){to.definitions=a;for(const u in a)i[u]=to}}function lx(l){return Array.isArray(l)?`(${l.map(k).join(", ")})`:`(${k(l.type)}...)`}class Jl{constructor(i,a,u){this.type=va,this.locale=u,this.caseSensitive=i,this.diacriticSensitive=a}static parse(i,a){if(i.length!==2)return a.error("Expected one argument.");const u=i[1];if(typeof u!="object"||Array.isArray(u))return a.error("Collator options argument must be an object.");const p=u["case-sensitive"]===void 0?a.parse(!1,1,gr):a.parseObjectValue(u["case-sensitive"],1,"case-sensitive",gr);if(!p)return null;const g=u["diacritic-sensitive"]===void 0?a.parse(!1,1,gr):a.parseObjectValue(u["diacritic-sensitive"],1,"diacritic-sensitive",gr);if(!g)return null;let y=null;return u.locale&&(y=a.parseObjectValue(u.locale,1,"locale",br),!y)?null:new Jl(p,g,y)}evaluate(i){return new Ti(this.caseSensitive.evaluate(i),this.diacriticSensitive.evaluate(i),this.locale?this.locale.evaluate(i):null)}eachChild(i){i(this.caseSensitive),i(this.diacriticSensitive),this.locale&&i(this.locale)}outputDefined(){return!1}serialize(){const i={};return i["case-sensitive"]=this.caseSensitive.serialize(),i["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(i.locale=this.locale.serialize()),["collator",i]}}function Pf(l,i,a=0,u=l.length-1,p=uu){for(;u>a;){if(u-a>600){const T=u-a+1,N=i-a+1,I=Math.log(T),P=.5*Math.exp(2*I/3),j=.5*Math.sqrt(I*P*(T-P)/T)*(N-T/2<0?-1:1);Pf(l,i,Math.max(a,Math.floor(i-N*P/T+j)),Math.min(u,Math.floor(i+(T-N)*P/T+j)),p)}const g=l[i];let y=a,v=u;for(dl(l,a,i),p(l[u],g)>0&&dl(l,a,u);y<v;){for(dl(l,y,v),y++,v--;p(l[y],g)<0;)y++;for(;p(l[v],g)>0;)v--}p(l[a],g)===0?dl(l,a,v):(v++,dl(l,v,u)),v<=i&&(a=v+1),i<=v&&(u=v-1)}}function dl(l,i,a){const u=l[i];l[i]=l[a],l[a]=u}function uu(l,i){return l<i?-1:l>i?1:0}function GT(l){let i=0;for(let a,u,p=0,g=l.length,y=g-1;p<g;y=p++)a=l[p],u=l[y],i+=(u.x-a.x)*(a.y+u.y);return i}function Gp(l,i){l[0]=Math.min(l[0],i[0]),l[1]=Math.min(l[1],i[1]),l[2]=Math.max(l[2],i[0]),l[3]=Math.max(l[3],i[1])}function Hp(l,i){return!(l[0]<=i[0]||l[2]>=i[2]||l[1]<=i[1]||l[3]>=i[3])}function jf(l,i,a){const u=l[0]-i[0],p=l[1]-i[1],g=l[0]-a[0],y=l[1]-a[1];return u*y-g*p===0&&u*g<=0&&p*y<=0}function ab(l,i,a){return i[1]>l[1]!=a[1]>l[1]&&l[0]<(a[0]-i[0])*(l[1]-i[1])/(a[1]-i[1])+i[0]}function hl(l,i,a=!1){let u=!1;for(let p=0,g=i.length;p<g;p++){const y=i[p];for(let v=0,T=y.length,N=T-1;v<T;N=v++){const I=y[N],P=y[v];if(jf(l,I,P))return a;ab(l,I,P)&&(u=!u)}}return u}function ob(l,i,a,u){const p=u[0]-a[0],g=u[1]-a[1],y=(l[0]-a[0])*g-p*(l[1]-a[1]),v=(i[0]-a[0])*g-p*(i[1]-a[1]);return y>0&&v<0||y<0&&v>0}function Rf(l,i,a,u){return(p=[u[0]-a[0],u[1]-a[1]])[0]*(g=[i[0]-l[0],i[1]-l[1]])[1]-p[1]*g[0]!==0&&!(!ob(l,i,a,u)||!ob(a,u,l,i));var p,g}function Wp(l){const i=new wt(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),a=new wt(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(const u of l[0])i.x>u.x&&(i.x=u.x),i.y>u.y&&(i.y=u.y),a.x<u.x&&(a.x=u.x),a.y<u.y&&(a.y=u.y);return{min:i,max:a}}const du=8192;function HT(l,i){const a=(180+l[0])/360,u=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+l[1]*Math.PI/360)))/360,p=Math.pow(2,i.z);return[Math.round(a*p*du),Math.round(u*p*du)]}function lb(l,i){for(let a=0;a<i.length;a++)if(hl(l,i[a]))return!0;return!1}function WT(l,i,a){for(const u of a)for(let p=0,g=u.length,y=g-1;p<g;y=p++)if(Rf(l,i,u[y],u[p]))return!0;return!1}function cx(l,i){for(let a=0;a<l.length;++a)if(!hl(l[a],i))return!1;for(let a=0;a<l.length-1;++a)if(WT(l[a],l[a+1],i))return!1;return!0}function ZT(l,i){for(let a=0;a<i.length;a++)if(cx(l,i[a]))return!0;return!1}function Pc(l,i,a){const u=[];for(let p=0;p<l.length;p++){const g=[];for(let y=0;y<l[p].length;y++){const v=HT(l[p][y],a);Gp(i,v),g.push(v)}u.push(g)}return u}function cb(l,i,a){const u=[];for(let p=0;p<l.length;p++){const g=Pc(l[p],i,a);u.push(g)}return u}function ub(l,i,a,u){if(l[0]<a[0]||l[0]>a[2]){const p=.5*u;let g=l[0]-a[0]>p?-u:a[0]-l[0]>p?u:0;g===0&&(g=l[0]-a[2]>p?-u:a[2]-l[0]>p?u:0),l[0]+=g}Gp(i,l)}function kf(l,i,a,u){const p=Math.pow(2,u.z)*du,g=[u.x*du,u.y*du],y=[];if(!l)return y;for(const v of l)for(const T of v){const N=[T.x+g[0],T.y+g[1]];ub(N,i,a,p),y.push(N)}return y}function ux(l,i,a,u){const p=Math.pow(2,u.z)*du,g=[u.x*du,u.y*du],y=[];if(!l)return y;for(const T of l){const N=[];for(const I of T){const P=[I.x+g[0],I.y+g[1]];Gp(i,P),N.push(P)}y.push(N)}if(i[2]-i[0]<=p/2){(v=i)[0]=v[1]=1/0,v[2]=v[3]=-1/0;for(const T of y)for(const N of T)ub(N,i,a,p)}var v;return y}class hu{constructor(i,a){this.type=gr,this.geojson=i,this.geometries=a}static parse(i,a){if(i.length!==2)return a.error(`'within' expression requires exactly one argument, but found ${i.length-1} instead.`);if(Ja(i[1])){const u=i[1];if(u.type==="FeatureCollection")for(let p=0;p<u.features.length;++p){const g=u.features[p].geometry.type;if(g==="Polygon"||g==="MultiPolygon")return new hu(u,u.features[p].geometry)}else if(u.type==="Feature"){const p=u.geometry.type;if(p==="Polygon"||p==="MultiPolygon")return new hu(u,u.geometry)}else if(u.type==="Polygon"||u.type==="MultiPolygon")return new hu(u,u)}return a.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(i){if(i.geometry()!=null&&i.canonicalID()!=null){if(i.geometryType()==="Point")return function(a,u){const p=[1/0,1/0,-1/0,-1/0],g=[1/0,1/0,-1/0,-1/0],y=a.canonicalID();if(!y)return!1;if(u.type==="Polygon"){const v=Pc(u.coordinates,g,y),T=kf(a.geometry(),p,g,y);if(!Hp(p,g))return!1;for(const N of T)if(!hl(N,v))return!1}if(u.type==="MultiPolygon"){const v=cb(u.coordinates,g,y),T=kf(a.geometry(),p,g,y);if(!Hp(p,g))return!1;for(const N of T)if(!lb(N,v))return!1}return!0}(i,this.geometries);if(i.geometryType()==="LineString")return function(a,u){const p=[1/0,1/0,-1/0,-1/0],g=[1/0,1/0,-1/0,-1/0],y=a.canonicalID();if(!y)return!1;if(u.type==="Polygon"){const v=Pc(u.coordinates,g,y),T=ux(a.geometry(),p,g,y);if(!Hp(p,g))return!1;for(const N of T)if(!cx(N,v))return!1}if(u.type==="MultiPolygon"){const v=cb(u.coordinates,g,y),T=ux(a.geometry(),p,g,y);if(!Hp(p,g))return!1;for(const N of T)if(!ZT(N,v))return!1}return!0}(i,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const _o={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},dx=1/298.257223563,hx=dx*(2-dx),rh=Math.PI/180;class nh{static fromTile(i,a,u){const p=Math.PI*(1-2*(i+.5)/Math.pow(2,a)),g=Math.atan(.5*(Math.exp(p)-Math.exp(-p)))/rh;return new nh(g,u)}static get units(){return _o}constructor(i,a){if(i===void 0)throw new Error("No latitude given.");if(a&&!_o[a])throw new Error(`Unknown unit ${a}. Use one of: ${Object.keys(_o).join(", ")}`);const u=6378.137*rh*(a?_o[a]:1),p=Math.cos(i*rh),g=1/(1-hx*(1-p*p)),y=Math.sqrt(g);this.kx=u*y*p,this.ky=u*y*g*(1-hx)}distance(i,a){const u=Vo(i[0]-a[0])*this.kx,p=(i[1]-a[1])*this.ky;return Math.sqrt(u*u+p*p)}bearing(i,a){const u=Vo(a[0]-i[0])*this.kx;return Math.atan2(u,(a[1]-i[1])*this.ky)/rh}destination(i,a,u){const p=u*rh;return this.offset(i,Math.sin(p)*a,Math.cos(p)*a)}offset(i,a,u){return[i[0]+a/this.kx,i[1]+u/this.ky]}lineDistance(i){let a=0;for(let u=0;u<i.length-1;u++)a+=this.distance(i[u],i[u+1]);return a}area(i){let a=0;for(let u=0;u<i.length;u++){const p=i[u];for(let g=0,y=p.length,v=y-1;g<y;v=g++)a+=Vo(p[g][0]-p[v][0])*(p[g][1]+p[v][1])*(u?-1:1)}return Math.abs(a)/2*this.kx*this.ky}along(i,a){let u=0;if(a<=0)return i[0];for(let p=0;p<i.length-1;p++){const g=i[p],y=i[p+1],v=this.distance(g,y);if(u+=v,u>a)return Df(g,y,(a-(u-v))/v)}return i[i.length-1]}pointToSegmentDistance(i,a,u){let[p,g]=a,y=Vo(u[0]-p)*this.kx,v=(u[1]-g)*this.ky;if(y!==0||v!==0){const T=(Vo(i[0]-p)*this.kx*y+(i[1]-g)*this.ky*v)/(y*y+v*v);T>1?(p=u[0],g=u[1]):T>0&&(p+=y/this.kx*T,g+=v/this.ky*T)}return y=Vo(i[0]-p)*this.kx,v=(i[1]-g)*this.ky,Math.sqrt(y*y+v*v)}pointOnLine(i,a){let u=1/0,p=i[0][0],g=i[0][1],y=0,v=0;for(let T=0;T<i.length-1;T++){let N=i[T][0],I=i[T][1],P=Vo(i[T+1][0]-N)*this.kx,j=(i[T+1][1]-I)*this.ky,O=0;P===0&&j===0||(O=(Vo(a[0]-N)*this.kx*P+(a[1]-I)*this.ky*j)/(P*P+j*j),O>1?(N=i[T+1][0],I=i[T+1][1]):O>0&&(N+=P/this.kx*O,I+=j/this.ky*O)),P=Vo(a[0]-N)*this.kx,j=(a[1]-I)*this.ky;const L=P*P+j*j;L<u&&(u=L,p=N,g=I,y=T,v=O)}return{point:[p,g],index:y,t:Math.max(0,Math.min(1,v))}}lineSlice(i,a,u){let p=this.pointOnLine(u,i),g=this.pointOnLine(u,a);if(p.index>g.index||p.index===g.index&&p.t>g.t){const N=p;p=g,g=N}const y=[p.point],v=p.index+1,T=g.index;!px(u[v],y[0])&&v<=T&&y.push(u[v]);for(let N=v+1;N<=T;N++)y.push(u[N]);return px(u[T],g.point)||y.push(g.point),y}lineSliceAlong(i,a,u){let p=0;const g=[];for(let y=0;y<u.length-1;y++){const v=u[y],T=u[y+1],N=this.distance(v,T);if(p+=N,p>i&&g.length===0&&g.push(Df(v,T,(i-(p-N))/N)),p>=a)return g.push(Df(v,T,(a-(p-N))/N)),g;p>i&&g.push(T)}return g}bufferPoint(i,a){const u=a/this.ky,p=a/this.kx;return[i[0]-p,i[1]-u,i[0]+p,i[1]+u]}bufferBBox(i,a){const u=a/this.ky,p=a/this.kx;return[i[0]-p,i[1]-u,i[2]+p,i[3]+u]}insideBBox(i,a){return Vo(i[0]-a[0])>=0&&Vo(i[0]-a[2])<=0&&i[1]>=a[1]&&i[1]<=a[3]}}function px(l,i){return l[0]===i[0]&&l[1]===i[1]}function Df(l,i,a){const u=Vo(i[0]-l[0]);return[l[0]+u*a,l[1]+(i[1]-l[1])*a]}function Vo(l){for(;l<-180;)l+=360;for(;l>180;)l-=360;return l}class Zp{constructor(i=[],a=(u,p)=>u<p?-1:u>p?1:0){if(this.data=i,this.length=this.data.length,this.compare=a,this.length>0)for(let u=(this.length>>1)-1;u>=0;u--)this._down(u)}push(i){this.data.push(i),this._up(this.length++)}pop(){if(this.length===0)return;const i=this.data[0],a=this.data.pop();return--this.length>0&&(this.data[0]=a,this._down(0)),i}peek(){return this.data[0]}_up(i){const{data:a,compare:u}=this,p=a[i];for(;i>0;){const g=i-1>>1,y=a[g];if(u(p,y)>=0)break;a[i]=y,i=g}a[i]=p}_down(i){const{data:a,compare:u}=this,p=this.length>>1,g=a[i];for(;i<p;){let y=1+(i<<1);const v=y+1;if(v<this.length&&u(a[v],a[y])<0&&(y=v),u(a[y],g)>=0)break;a[i]=a[y],i=y}a[i]=g}}var Bt=8192;function mx(l,i){return i.dist-l.dist}function fx(l){const i=[1/0,1/0,-1/0,-1/0];if(i.length!==l.length)return!1;for(let a=0;a<i.length;a++)if(i[a]!==l[a])return!1;return!0}function Xp(l){return l[1]-l[0]+1}function ec(l,i){const a=l[1]>=l[0]&&l[1]<i;return a||console.warn("Distance Expression: Index is out of range"),a}function gx(l,i){if(l[0]>l[1])return[null,null];const a=Xp(l);if(i){if(a===2)return[l,null];const u=Math.floor(a/2);return[[l[0],l[0]+u],[l[0]+u,l[1]]]}{if(a===1)return[l,null];const u=Math.floor(a/2)-1;return[[l[0],l[0]+u],[l[0]+u+1,l[1]]]}}function od(l,i){const a=[1/0,1/0,-1/0,-1/0];if(!ec(i,l.length))return a;for(let u=i[0];u<=i[1];++u)Gp(a,l[u]);return a}function ld(l){const i=[1/0,1/0,-1/0,-1/0];for(let a=0;a<l.length;++a)for(let u=0;u<l[a].length;++u)Gp(i,l[a][u]);return i}function pu(l,i,a){if(fx(l)||fx(i))return NaN;let u=0,p=0;return l[2]<i[0]&&(u=i[0]-l[2]),l[0]>i[2]&&(u=l[0]-i[2]),l[1]>i[3]&&(p=l[1]-i[3]),l[3]<i[1]&&(p=i[1]-l[3]),a.distance([0,0],[u,p])}function Mf(l){return 360*l-180}function db(l){return 360/Math.PI*Math.atan(Math.exp((180-360*l)*Math.PI/180))-90}function Of(l,i){const a=Math.pow(2,i.z),u=(l.y/Bt+i.y)/a;return[Mf((l.x/Bt+i.x)/a),db(u)]}function XT(l,i){const a=[];for(let u=0;u<l.length;++u)a.push(Of(l[u],i));return a}function hb(l,i,a){const u=a.pointOnLine(i,l).point;return a.distance(l,u)}function yx(l,i,a,u,p){const g=a.slice(u[0],u[1]+1);let y=1/0;for(let v=i[0];v<=i[1];++v)if((y=Math.min(y,hb(l[v],g,p)))===0)return 0;return y}function mu(l,i,a,u,p){const g=Math.min(p.pointToSegmentDistance(l,a,u),p.pointToSegmentDistance(i,a,u)),y=Math.min(p.pointToSegmentDistance(a,l,i),p.pointToSegmentDistance(u,l,i));return Math.min(g,y)}function pr(l,i,a,u,p){if(!ec(i,l.length)||!ec(u,a.length))return NaN;let g=1/0;for(let y=i[0];y<i[1];++y)for(let v=u[0];v<u[1];++v){if(Rf(l[y],l[y+1],a[v],a[v+1]))return 0;g=Math.min(g,mu(l[y],l[y+1],a[v],a[v+1],p))}return g}function YT(l,i,a,u,p){if(!ec(i,l.length)||!ec(u,a.length))return NaN;let g=1/0;for(let y=i[0];y<=i[1];++y)for(let v=u[0];v<=u[1];++v)if((g=Math.min(g,p.distance(l[y],a[v])))===0)return g;return g}function KT(l,i,a){if(hl(l,i,!0))return 0;let u=1/0;for(const p of i){const g=p.length;if(g<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(p[0]!==p[g-1]&&(u=Math.min(u,a.pointToSegmentDistance(l,p[g-1],p[0])))===0||(u=Math.min(u,hb(l,p,a)))===0)return u}return u}function QT(l,i,a,u){if(!ec(i,l.length))return NaN;for(let g=i[0];g<=i[1];++g)if(hl(l[g],a,!0))return 0;let p=1/0;for(let g=i[0];g<i[1];++g)for(const y of a)for(let v=0,T=y.length,N=T-1;v<T;N=v++){if(Rf(l[g],l[g+1],y[N],y[v]))return 0;p=Math.min(p,mu(l[g],l[g+1],y[N],y[v],u))}return p}function xx(l,i){for(const a of l)for(let u=0;u<=a.length-1;++u)if(hl(a[u],i,!0))return!0;return!1}function JT(l,i,a,u=1/0){const p=ld(l),g=ld(i);if(u!==1/0&&pu(p,g,a)>=u)return u;if(Hp(p,g)){if(xx(l,i))return 0}else if(xx(i,l))return 0;let y=u;for(const v of l)for(let T=0,N=v.length,I=N-1;T<N;I=T++)for(const P of i)for(let j=0,O=P.length,L=O-1;j<O;L=j++){if(Rf(v[I],v[T],P[L],P[j]))return 0;y=Math.min(y,mu(v[I],v[T],P[L],P[j],a))}return y}function on(l,i,a,u,p,g,y){if(g===null||y===null)return;const v=pu(od(u,g),od(p,y),a);v<i&&l.push({dist:v,range1:g,range2:y})}function eN(l,i,a,u,p=1/0){let g=Math.min(u.distance(l[0],a[0][0]),p);if(g===0)return g;const y=new Zp([{dist:0,range1:[0,l.length-1],range2:[0,0]}],mx),v=i?50:100,T=ld(a);for(;y.length;){const N=y.pop();if(N.dist>=g)continue;const I=N.range1;if(Xp(I)<=v){if(!ec(I,l.length))return NaN;if(i){const P=QT(l,I,a,u);if((g=Math.min(g,P))===0)return g}else for(let P=I[0];P<=I[1];++P){const j=KT(l[P],a,u);if((g=Math.min(g,j))===0)return g}}else{const P=gx(I,i);if(P[0]!==null){const j=pu(od(l,P[0]),T,u);j<g&&y.push({dist:j,range1:P[0],range2:[0,0]})}if(P[1]!==null){const j=pu(od(l,P[1]),T,u);j<g&&y.push({dist:j,range1:P[1],range2:[0,0]})}}}return g}function pb(l,i,a,u,p,g=1/0){let y=Math.min(g,p.distance(l[0],a[0]));if(y===0)return y;const v=new Zp([{dist:0,range1:[0,l.length-1],range2:[0,a.length-1]}],mx),T=i?50:100,N=u?50:100;for(;v.length;){const I=v.pop();if(I.dist>=y)continue;const P=I.range1,j=I.range2;if(Xp(P)<=T&&Xp(j)<=N){if(!ec(P,l.length)||!ec(j,a.length))return NaN;if(i&&u?y=Math.min(y,pr(l,P,a,j,p)):i||u?i&&!u?y=Math.min(y,yx(a,j,l,P,p)):!i&&u&&(y=Math.min(y,yx(l,P,a,j,p))):y=Math.min(y,YT(l,P,a,j,p)),y===0)return y}else{const O=gx(P,i),L=gx(j,u);on(v,y,p,l,a,O[0],L[0]),on(v,y,p,l,a,O[0],L[1]),on(v,y,p,l,a,O[1],L[0]),on(v,y,p,l,a,O[1],L[1])}}return y}function _x(l,i,a,u,p=1/0){let g=p;const y=od(l,[0,l.length-1]);for(const v of a)if(!(g!==1/0&&pu(y,od(v,[0,v.length-1]),u)>=g)&&(g=Math.min(g,pb(l,i,v,!0,u,g)),g===0))return g;return g}function Lf(l,i,a,u,p=1/0){let g=p;const y=od(l,[0,l.length-1]);for(const v of a){if(g!==1/0&&pu(y,ld(v),u)>=g)continue;const T=eN(l,i,v,u,g);if(isNaN(T))return T;if((g=Math.min(g,T))===0)return g}return g}function vx(l){return l==="Point"||l==="MultiPoint"||l==="LineString"||l==="MultiLineString"||l==="Polygon"||l==="MultiPolygon"}class cd{constructor(i,a){this.type=ii,this.geojson=i,this.geometries=a}static parse(i,a){if(i.length!==2)return a.error(`'distance' expression requires either one argument, but found ' ${i.length-1} instead.`);if(Ja(i[1])){const u=i[1];if(u.type==="FeatureCollection"){for(let p=0;p<u.features.length;++p)if(vx(u.features[p].geometry.type))return new cd(u,u.features[p].geometry)}else if(u.type==="Feature"){if(vx(u.geometry.type))return new cd(u,u.geometry)}else if(vx(u.type))return new cd(u,u)}return a.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(i){const a=i.geometry(),u=i.canonicalID();if(a!=null&&u!=null){if(i.geometryType()==="Point")return function(p,g,y){const v=[];for(const N of p)for(const I of N)v.push(Of(I,g));const T=new nh(v[0][1],"meters");return y.type==="Point"||y.type==="MultiPoint"||y.type==="LineString"?pb(v,!1,y.type==="Point"?[y.coordinates]:y.coordinates,y.type==="LineString",T):y.type==="MultiLineString"?_x(v,!1,y.coordinates,T):y.type==="Polygon"||y.type==="MultiPolygon"?Lf(v,!1,y.type==="Polygon"?[y.coordinates]:y.coordinates,T):null}(a,u,this.geometries);if(i.geometryType()==="LineString")return function(p,g,y){const v=[];for(const N of p){const I=[];for(const P of N)I.push(Of(P,g));v.push(I)}const T=new nh(v[0][0][1],"meters");if(y.type==="Point"||y.type==="MultiPoint"||y.type==="LineString")return _x(y.type==="Point"?[y.coordinates]:y.coordinates,y.type==="LineString",v,T);if(y.type==="MultiLineString"){let N=1/0;for(let I=0;I<y.coordinates.length;I++){const P=_x(y.coordinates[I],!0,v,T,N);if(isNaN(P))return P;if((N=Math.min(N,P))===0)return N}return N}if(y.type==="Polygon"||y.type==="MultiPolygon"){let N=1/0;for(let I=0;I<v.length;I++){const P=Lf(v[I],!0,y.type==="Polygon"?[y.coordinates]:y.coordinates,T,N);if(isNaN(P))return P;if((N=Math.min(N,P))===0)return N}return N}return null}(a,u,this.geometries);if(i.geometryType()==="Polygon")return function(p,g,y){const v=[];for(const N of function(I){const P=I.length;if(P<=1)return[I];const j=[];let O,L;for(let U=0;U<P;U++){const Z=GT(I[U]);Z!==0&&(I[U].area=Math.abs(Z),L===void 0&&(L=Z<0),L===Z<0?(O&&j.push(O),O=[I[U]]):O.push(I[U]))}return O&&j.push(O),j}(p)){const I=[];for(let P=0;P<N.length;++P)I.push(XT(N[P],g));v.push(I)}const T=new nh(v[0][0][0][1],"meters");if(y.type==="Point"||y.type==="MultiPoint"||y.type==="LineString")return Lf(y.type==="Point"?[y.coordinates]:y.coordinates,y.type==="LineString",v,T);if(y.type==="MultiLineString"){let N=1/0;for(let I=0;I<y.coordinates.length;I++){const P=Lf(y.coordinates[I],!0,v,T,N);if(isNaN(P))return P;if((N=Math.min(N,P))===0)return N}return N}return y.type==="Polygon"||y.type==="MultiPolygon"?function(N,I,P){let j=1/0;for(const O of N)for(const L of I){const U=JT(O,L,P,j);if(isNaN(U))return U;if((j=Math.min(j,U))===0)return j}return j}(y.type==="Polygon"?[y.coordinates]:y.coordinates,v,T):null}(a,u,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function sh(l){if(l instanceof to&&(l.name==="get"&&l.args.length===1||l.name==="feature-state"||l.name==="has"&&l.args.length===1||l.name==="properties"||l.name==="geometry-type"||l.name==="id"||/^filter-/.test(l.name))||l instanceof hu||l instanceof cd)return!1;if(l instanceof oh)return l.featureConstant;let i=!0;return l.eachChild(a=>{i&&!sh(a)&&(i=!1)}),i}function Yp(l){if(l instanceof to&&l.name==="feature-state")return!1;let i=!0;return l.eachChild(a=>{i&&!Yp(a)&&(i=!1)}),i}function ah(l,i){if(l instanceof to&&i.indexOf(l.name)>=0)return!1;let a=!0;return l.eachChild(u=>{a&&!ah(u,i)&&(a=!1)}),a}function mb(l,i,a){return[l,i,a].filter(Boolean).join("")}function bx(l,i){switch(l){case"string":return eo(i);case"number":return+i;case"boolean":return!!i;case"color":return Ar.parse(i);case"formatted":return an.fromString(eo(i));case"resolvedImage":return Cn.build(eo(i))}return i}function fb(l,i,a,u){return u!==void 0&&(l=u*Math.round(l/u)),i!==void 0&&l<i&&(l=i),a!==void 0&&l>a&&(l=a),l}class oh{constructor(i,a,u,p=!1){this.type=i,this.key=a,this.scope=u,this.featureConstant=p}static parse(i,a){let u=a.expectedType;if(u==null&&(u=wr),i.length<2||i.length>3)return a.error("Invalid number of arguments for 'config' expression.");const p=a.parse(i[1],1);if(!(p instanceof Bo))return a.error("Key name of 'config' expression must be a string literal.");let g,y=!0;const v=eo(p.value);if(i.length>=3){const T=a.parse(i[2],2);if(!(T instanceof Bo))return a.error("Scope of 'config' expression must be a string literal.");g=eo(T.value)}if(a.options){const T=mb(v,g,a._scope),N=a.options.get(T);N&&(y=sh(N.value||N.default))}return new oh(u,v,g,y)}evaluate(i){const a=mb(this.key,this.scope,i.scope),u=i.getConfig(a);if(!u)return null;const{type:p,value:g,values:y,minValue:v,maxValue:T,stepValue:N}=u,I=u.default.evaluate(i);let P=I;if(g){const j=i.scope;i.scope=(j||"").split("").slice(1).join(""),P=g.evaluate(i),i.scope=j}return p&&(P=bx(p,P)),P===void 0||v===void 0&&T===void 0&&N===void 0||(typeof P=="number"?P=fb(P,v,T,N):Array.isArray(P)&&(P=P.map(j=>typeof j=="number"?fb(j,v,T,N):j))),g!==void 0&&P!==void 0&&y&&!y.includes(P)&&(P=I,p&&(P=bx(p,P))),(p&&p!==this.type||P!==void 0&&!qt(un(P),this.type))&&(P=bx(this.type.kind,P)),P}eachChild(){}outputDefined(){return!1}serialize(){const i=["config",this.key];return this.scope&&i.concat(this.scope),i}}class Ff{constructor(i,a){this.type=a.type,this.name=i,this.boundExpression=a}static parse(i,a){if(i.length!==2||typeof i[1]!="string")return a.error("'var' expression requires exactly one string literal argument.");const u=i[1];return a.scope.has(u)?new Ff(u,a.scope.get(u)):a.error(`Unknown variable "${u}". Make sure "${u}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(i){return this.boundExpression.evaluate(i)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class zf{constructor(i,a=[],u,p=new ad,g=[],y,v,T){this.registry=i,this.path=a,this.key=a.map(N=>typeof N=="string"?`['${N}']`:`[${N}]`).join(""),this.scope=p,this.errors=g,this.expectedType=u,this._scope=y,this.options=v,this.iconImageUseTheme=T}parse(i,a,u,p,g={}){return a||u?this.concat(a,null,u,p)._parse(i,g):this._parse(i,g)}parseObjectValue(i,a,u,p,g,y={}){return this.concat(a,u,p,g)._parse(i,y)}_parse(i,a){function u(p,g,y){return y==="assert"?new Di(g,[p]):y==="coerce"?new Ql(g,[p]):p}if(i!==null&&typeof i!="string"&&typeof i!="boolean"&&typeof i!="number"||(i=["literal",i]),Array.isArray(i)){if(i.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const p=typeof i[0]=="string"?this.registry[i[0]]:void 0;if(p){let g=p.parse(i,this);if(!g)return null;if(this.expectedType){const y=this.expectedType,v=g.type;if(y.kind!=="string"&&y.kind!=="number"&&y.kind!=="boolean"&&y.kind!=="object"&&y.kind!=="array"||v.kind!=="value")if(y.kind!=="color"&&y.kind!=="formatted"&&y.kind!=="resolvedImage"||v.kind!=="value"&&v.kind!=="string"){if(this.checkSubtype(y,v))return null}else g=u(g,y,a.typeAnnotation||"coerce");else g=u(g,y,a.typeAnnotation||"assert")}if(!(g instanceof Bo)&&g.type.kind!=="resolvedImage"&&wx(g)){const y=new ih(this._scope,this.options,this.iconImageUseTheme);try{g=new Bo(g.type,g.evaluate(y))}catch(v){return this.error(v.message),null}}return g}return Ql.parse(["to-array",i],this)}return this.error(i===void 0?"'undefined' value invalid. Use null instead.":typeof i=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof i} instead.`)}concat(i,a,u,p){let g=typeof i=="number"?this.path.concat(i):this.path;g=typeof a=="string"?g.concat(a):g;const y=p?this.scope.concat(p):this.scope;return new zf(this.registry,g,u||null,y,this.errors,this._scope,this.options,this.iconImageUseTheme)}error(i,...a){const u=`${this.key}${a.map(p=>`[${p}]`).join("")}`;this.errors.push(new Ls(u,i))}checkSubtype(i,a){const u=ye(i,a);return u&&this.error(u),u}}function wx(l){if(l instanceof Ff)return wx(l.boundExpression);if(l instanceof to&&l.name==="error"||l instanceof Jl||l instanceof hu||l instanceof cd||l instanceof oh)return!1;const i=l instanceof Ql||l instanceof Di;let a=!0;return l.eachChild(u=>{a=i?a&&wx(u):a&&u instanceof Bo}),!!a&&sh(l)&&ah(l,["zoom","heatmap-density","worldview","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function Bf(l,i){const a=l.length-1;let u,p,g=0,y=a,v=0;for(;g<=y;)if(v=Math.floor((g+y)/2),u=l[v],p=l[v+1],u<=i){if(v===a||i<p)return v;g=v+1}else{if(!(u>i))throw new gs("Input is not a number.");y=v-1}return 0}class Kp{constructor(i,a,u){this.type=i,this.input=a,this.labels=[],this.outputs=[];for(const[p,g]of u)this.labels.push(p),this.outputs.push(g)}static parse(i,a){if(i.length-1<4)return a.error(`Expected at least 4 arguments, but found only ${i.length-1}.`);if((i.length-1)%2!=0)return a.error("Expected an even number of arguments.");const u=a.parse(i[1],1,ii);if(!u)return null;const p=[];let g=null;a.expectedType&&a.expectedType.kind!=="value"&&(g=a.expectedType);for(let y=1;y<i.length;y+=2){const v=y===1?-1/0:i[y],T=i[y+1],N=y,I=y+1;if(typeof v!="number")return a.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',N);if(p.length&&p[p.length-1][0]>=v)return a.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',N);const P=a.parse(T,I,g);if(!P)return null;g=g||P.type,p.push([v,P])}return new Kp(g,u,p)}evaluate(i){const a=this.labels,u=this.outputs;if(a.length===1)return u[0].evaluate(i);const p=this.input.evaluate(i);if(p<=a[0])return u[0].evaluate(i);const g=a.length;return p>=a[g-1]?u[g-1].evaluate(i):u[Bf(a,p)].evaluate(i)}eachChild(i){i(this.input);for(const a of this.outputs)i(a)}outputDefined(){return this.outputs.every(i=>i.outputDefined())}serialize(){const i=["step",this.input.serialize()];for(let a=0;a<this.labels.length;a++)a>0&&i.push(this.labels[a]),i.push(this.outputs[a].serialize());return i}}const gb=.95047,yb=1.08883,xb=4/29,lh=6/29,_b=3*lh*lh,tN=lh*lh*lh,iN=Math.PI/180,rN=180/Math.PI;function Sx(l){return l>tN?Math.pow(l,1/3):l/_b+xb}function Tx(l){return l>lh?l*l*l:_b*(l-xb)}function Nx(l){return 255*(l<=.0031308?12.92*l:1.055*Math.pow(l,1/2.4)-.055)}function Ax(l){return(l/=255)<=.04045?l/12.92:Math.pow((l+.055)/1.055,2.4)}function vb(l){const i=Ax(l.r),a=Ax(l.g),u=Ax(l.b),p=Sx((.4124564*i+.3575761*a+.1804375*u)/gb),g=Sx((.2126729*i+.7151522*a+.072175*u)/1);return{l:116*g-16,a:500*(p-g),b:200*(g-Sx((.0193339*i+.119192*a+.9503041*u)/yb)),alpha:l.a}}function Vf(l){let i=(l.l+16)/116,a=isNaN(l.a)?i:i+l.a/500,u=isNaN(l.b)?i:i-l.b/200;return i=1*Tx(i),a=gb*Tx(a),u=yb*Tx(u),new Ar(Nx(3.2404542*a-1.5371385*i-.4985314*u),Nx(-.969266*a+1.8760108*i+.041556*u),Nx(.0556434*a-.2040259*i+1.0572252*u),l.alpha)}function Uf(l,i,a){const u=i-l;return l+a*(u>180||u<-180?u-360*Math.round(u/360):u)}const ch={forward:vb,reverse:Vf,interpolate:function(l,i,a){return{l:Si(l.l,i.l,a),a:Si(l.a,i.a,a),b:Si(l.b,i.b,a),alpha:Si(l.alpha,i.alpha,a)}}},Qp={forward:function(l){const{l:i,a,b:u}=vb(l),p=Math.atan2(u,a)*rN;return{h:p<0?p+360:p,c:Math.sqrt(a*a+u*u),l:i,alpha:l.a}},reverse:function(l){const i=l.h*iN,a=l.c;return Vf({l:l.l,a:Math.cos(i)*a,b:Math.sin(i)*a,alpha:l.alpha})},interpolate:function(l,i,a){return{h:Uf(l.h,i.h,a),c:Si(l.c,i.c,a),l:Si(l.l,i.l,a),alpha:Si(l.alpha,i.alpha,a)}}};var bb=Object.freeze({__proto__:null,hcl:Qp,lab:ch});class Uo{constructor(i,a,u,p,g){this.type=i,this.operator=a,this.interpolation=u,this.input=p,this.labels=[],this.outputs=[];for(const[y,v]of g)this.labels.push(y),this.outputs.push(v)}static interpolationFactor(i,a,u,p){let g=0;if(i.name==="exponential")g=qf(a,i.base,u,p);else if(i.name==="linear")g=qf(a,1,u,p);else if(i.name==="cubic-bezier"){const y=i.controlPoints;g=new ll(y[0],y[1],y[2],y[3]).solve(qf(a,1,u,p))}return g}static parse(i,a){let[u,p,g,...y]=i;if(!Array.isArray(p)||p.length===0)return a.error("Expected an interpolation type expression.",1);if(p[0]==="linear")p={name:"linear"};else if(p[0]==="exponential"){const N=p[1];if(typeof N!="number")return a.error("Exponential interpolation requires a numeric base.",1,1);p={name:"exponential",base:N}}else{if(p[0]!=="cubic-bezier")return a.error(`Unknown interpolation type ${String(p[0])}`,1,0);{const N=p.slice(1);if(N.length!==4||N.some(I=>typeof I!="number"||I<0||I>1))return a.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);p={name:"cubic-bezier",controlPoints:N}}}if(i.length-1<4)return a.error(`Expected at least 4 arguments, but found only ${i.length-1}.`);if(i.length-1>3&&(i.length-1)%2!=0)return a.error("Expected an even number of arguments.");if(g=a.parse(g,2,ii),!g)return null;const v=[];let T=null;u==="interpolate-hcl"||u==="interpolate-lab"?T=ca:a.expectedType&&a.expectedType.kind!=="value"&&(T=a.expectedType);for(let N=0;N<y.length;N+=2){const I=y[N],P=y[N+1],j=N+3,O=N+4;if(typeof I!="number")return a.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',j);if(v.length&&v[v.length-1][0]>=I)return a.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',j);const L=a.parse(P,O,T);if(!L)return null;T=T||L.type,v.push([I,L])}return T.kind==="number"||T.kind==="color"||T.kind==="array"&&T.itemType.kind==="number"&&typeof T.N=="number"?new Uo(T,u,p,g,v):a.error(`Type ${k(T)} is not interpolatable.`)}evaluate(i){const a=this.labels,u=this.outputs;if(a.length===1)return u[0].evaluate(i);const p=this.input.evaluate(i);if(p<=a[0])return u[0].evaluate(i);const g=a.length;if(p>=a[g-1])return u[g-1].evaluate(i);const y=Bf(a,p),v=Uo.interpolationFactor(this.interpolation,p,a[y],a[y+1]),T=u[y].evaluate(i),N=u[y+1].evaluate(i);return this.operator==="interpolate"?Yl[this.type.kind.toLowerCase()](T,N,v):this.operator==="interpolate-hcl"?Qp.reverse(Qp.interpolate(Qp.forward(T),Qp.forward(N),v)):ch.reverse(ch.interpolate(ch.forward(T),ch.forward(N),v))}eachChild(i){i(this.input);for(const a of this.outputs)i(a)}outputDefined(){return this.outputs.every(i=>i.outputDefined())}serialize(){let i;i=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];const a=[this.operator,i,this.input.serialize()];for(let u=0;u<this.labels.length;u++)a.push(this.labels[u],this.outputs[u].serialize());return a}}function qf(l,i,a,u){const p=u-a,g=l-a;return p===0?0:i===1?g/p:(Math.pow(i,g)-1)/(Math.pow(i,p)-1)}class Jp{constructor(i,a){this.type=i,this.args=a}static parse(i,a){if(i.length<2)return a.error("Expectected at least one argument.");let u=null;const p=a.expectedType;p&&p.kind!=="value"&&(u=p);const g=[];for(const v of i.slice(1)){const T=a.parse(v,1+g.length,u,void 0,{typeAnnotation:"omit"});if(!T)return null;u=u||T.type,g.push(T)}const y=p&&g.some(v=>ye(p,v.type));return new Jp(y?wr:u,g)}evaluate(i){let a,u=null,p=0;for(const g of this.args){if(p++,u=g.evaluate(i),u&&u instanceof Cn&&!u.available&&(a||(a=u),u=null,p===this.args.length))return a;if(u!==null)break}return u}eachChild(i){this.args.forEach(i)}outputDefined(){return this.args.every(i=>i.outputDefined())}serialize(){const i=["coalesce"];return this.eachChild(a=>{i.push(a.serialize())}),i}}class jc{constructor(i,a){this.type=a.type,this.bindings=[].concat(i),this.result=a}evaluate(i){return this.result.evaluate(i)}eachChild(i){for(const a of this.bindings)i(a[1]);i(this.result)}static parse(i,a){if(i.length<4)return a.error(`Expected at least 3 arguments, but found ${i.length-1} instead.`);const u=[];for(let g=1;g<i.length-1;g+=2){const y=i[g];if(typeof y!="string")return a.error(`Expected string, but found ${typeof y} instead.`,g);if(/[^a-zA-Z0-9_]/.test(y))return a.error("Variable names must contain only alphanumeric characters or '_'.",g);const v=a.parse(i[g+1],g+1);if(!v)return null;u.push([y,v])}const p=a.parse(i[i.length-1],i.length-1,a.expectedType,u);return p?new jc(u,p):null}outputDefined(){return this.result.outputDefined()}serialize(){const i=["let"];for(const[a,u]of this.bindings)i.push(a,u.serialize());return i.push(this.result.serialize()),i}}class $f{constructor(i,a,u){this.type=i,this.index=a,this.input=u}static parse(i,a){if(i.length!==3)return a.error(`Expected 2 arguments, but found ${i.length-1} instead.`);const u=a.parse(i[1],1,ii),p=a.parse(i[2],2,as(a.expectedType||wr));return u&&p?new $f(p.type.itemType,u,p):null}evaluate(i){const a=this.index.evaluate(i),u=this.input.evaluate(i);if(a<0)throw new gs("Array index out of bounds: negative index");if(a>=u.length)throw new gs("Array index out of bounds: index exceeds array size");if(a!==Math.floor(a))throw new gs("Array index must be an integer. Use at-interpolated for fractional indices");return u[a]}eachChild(i){i(this.index),i(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class Gf{constructor(i,a,u){this.type=i,this.index=a,this.input=u}static parse(i,a){if(i.length!==3)return a.error(`Expected 2 arguments, but found ${i.length-1} instead.`);const u=a.parse(i[1],1,ii),p=a.parse(i[2],2,as(a.expectedType||wr));return u&&p?new Gf(p.type.itemType,u,p):null}evaluate(i){const a=this.index.evaluate(i),u=this.input.evaluate(i);if(a<0)throw new gs(`Array index out of bounds: ${a} < 0.`);if(a>u.length-1)throw new gs(`Array index out of bounds: ${a} > ${u.length-1}.`);if(a===Math.floor(a))return u[a];const p=Math.floor(a),g=Math.ceil(a),y=u[p],v=u[g];if(typeof y!="number"||typeof v!="number")throw new gs(`Cannot interpolate between non-number values at index ${a}.`);const T=a-p;return y*(1-T)+v*T}eachChild(i){i(this.index),i(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}}class Cx{constructor(i,a){this.type=gr,this.needle=i,this.haystack=a}static parse(i,a){if(i.length!==3)return a.error(`Expected 2 arguments, but found ${i.length-1} instead.`);const u=a.parse(i[1],1,wr),p=a.parse(i[2],2,wr);return u&&p?We(u.type,[gr,br,ii,_a,wr])?new Cx(u,p):a.error(`Expected first argument to be of type boolean, string, number or null, but found ${k(u.type)} instead`):null}evaluate(i){const a=this.needle.evaluate(i),u=this.haystack.evaluate(i);if(u==null)return!1;if(!Pt(a,["boolean","string","number","null"]))throw new gs(`Expected first argument to be of type boolean, string, number or null, but found ${k(un(a))} instead.`);if(!Pt(u,["string","array"]))throw new gs(`Expected second argument to be of type array or string, but found ${k(un(u))} instead.`);return u.indexOf(a)>=0}eachChild(i){i(this.needle),i(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class uh{constructor(i,a,u){this.type=ii,this.needle=i,this.haystack=a,this.fromIndex=u}static parse(i,a){if(i.length<=2||i.length>=5)return a.error(`Expected 3 or 4 arguments, but found ${i.length-1} instead.`);const u=a.parse(i[1],1,wr),p=a.parse(i[2],2,wr);if(!u||!p)return null;if(!We(u.type,[gr,br,ii,_a,wr]))return a.error(`Expected first argument to be of type boolean, string, number or null, but found ${k(u.type)} instead`);if(i.length===4){const g=a.parse(i[3],3,ii);return g?new uh(u,p,g):null}return new uh(u,p)}evaluate(i){const a=this.needle.evaluate(i),u=this.haystack.evaluate(i);if(!Pt(a,["boolean","string","number","null"]))throw new gs(`Expected first argument to be of type boolean, string, number or null, but found ${k(un(a))} instead.`);if(!Pt(u,["string","array"]))throw new gs(`Expected second argument to be of type array or string, but found ${k(un(u))} instead.`);if(this.fromIndex){const p=this.fromIndex.evaluate(i);return u.indexOf(a,p)}return u.indexOf(a)}eachChild(i){i(this.needle),i(this.haystack),this.fromIndex&&i(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const i=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),i]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class em{constructor(i,a,u,p,g,y){this.inputType=i,this.type=a,this.input=u,this.cases=p,this.outputs=g,this.otherwise=y}static parse(i,a){if(i.length<5)return a.error(`Expected at least 4 arguments, but found only ${i.length-1}.`);if(i.length%2!=1)return a.error("Expected an even number of arguments.");let u,p;a.expectedType&&a.expectedType.kind!=="value"&&(p=a.expectedType);const g={},y=[];for(let N=2;N<i.length-1;N+=2){let I=i[N];const P=i[N+1];Array.isArray(I)||(I=[I]);const j=a.concat(N);if(I.length===0)return j.error("Expected at least one branch label.");for(const L of I){if(typeof L!="number"&&typeof L!="string")return j.error("Branch labels must be numbers or strings.");if(typeof L=="number"&&Math.abs(L)>Number.MAX_SAFE_INTEGER)return j.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof L=="number"&&Math.floor(L)!==L)return j.error("Numeric branch labels must be integer values.");if(u){if(j.checkSubtype(u,un(L)))return null}else u=un(L);if(g[String(L)]!==void 0)return j.error("Branch labels must be unique.");g[String(L)]=y.length}const O=a.parse(P,N,p);if(!O)return null;p=p||O.type,y.push(O)}const v=a.parse(i[1],1,wr);if(!v)return null;const T=a.parse(i[i.length-1],i.length-1,p);return T?v.type.kind!=="value"&&a.concat(1).checkSubtype(u,v.type)?null:new em(u,p,v,g,y,T):null}evaluate(i){const a=this.input.evaluate(i);return(qt(un(a),this.inputType)&&this.outputs[this.cases[a]]||this.otherwise).evaluate(i)}eachChild(i){i(this.input),this.outputs.forEach(i),i(this.otherwise)}outputDefined(){return this.outputs.every(i=>i.outputDefined())&&this.otherwise.outputDefined()}serialize(){const i=["match",this.input.serialize()],a=Object.keys(this.cases).sort(),u=[],p={};for(const y of a){const v=p[this.cases[y]];v===void 0?(p[this.cases[y]]=u.length,u.push([this.cases[y],[y]])):u[v][1].push(y)}const g=y=>this.inputType.kind==="number"?Number(y):y;for(const[y,v]of u)i.push(v.length===1?g(v[0]):v.map(g)),i.push(this.outputs[y].serialize());return i.push(this.otherwise.serialize()),i}}class tm{constructor(i,a,u){this.type=i,this.branches=a,this.otherwise=u}static parse(i,a){if(i.length<4)return a.error(`Expected at least 3 arguments, but found only ${i.length-1}.`);if(i.length%2!=0)return a.error("Expected an odd number of arguments.");let u;a.expectedType&&a.expectedType.kind!=="value"&&(u=a.expectedType);const p=[];for(let y=1;y<i.length-1;y+=2){const v=a.parse(i[y],y,gr);if(!v)return null;const T=a.parse(i[y+1],y+1,u);if(!T)return null;p.push([v,T]),u=u||T.type}const g=a.parse(i[i.length-1],i.length-1,u);return g?new tm(u,p,g):null}evaluate(i){for(const[a,u]of this.branches)if(a.evaluate(i))return u.evaluate(i);return this.otherwise.evaluate(i)}eachChild(i){for(const[a,u]of this.branches)i(a),i(u);i(this.otherwise)}outputDefined(){return this.branches.every(([i,a])=>a.outputDefined())&&this.otherwise.outputDefined()}serialize(){const i=["case"];return this.eachChild(a=>{i.push(a.serialize())}),i}}class Hf{constructor(i,a,u,p){this.type=i,this.input=a,this.beginIndex=u,this.endIndex=p}static parse(i,a){if(i.length<=2||i.length>=5)return a.error(`Expected 3 or 4 arguments, but found ${i.length-1} instead.`);const u=a.parse(i[1],1,wr),p=a.parse(i[2],2,ii);if(!u||!p)return null;if(!We(u.type,[as(wr),br,wr]))return a.error(`Expected first argument to be of type array or string, but found ${k(u.type)} instead`);if(i.length===4){const g=a.parse(i[3],3,ii);return g?new Hf(u.type,u,p,g):null}return new Hf(u.type,u,p)}evaluate(i){const a=this.input.evaluate(i),u=this.beginIndex.evaluate(i);if(!Pt(a,["string","array"]))throw new gs(`Expected first argument to be of type array or string, but found ${k(un(a))} instead.`);if(this.endIndex){const p=this.endIndex.evaluate(i);return a.slice(u,p)}return a.slice(u)}eachChild(i){i(this.input),i(this.beginIndex),this.endIndex&&i(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const i=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),i]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}class Ex{constructor(i,a){this.type=as(br),this.str=i,this.delimiter=a}static parse(i,a){if(i.length!==3)return a.error(`Expected 2 arguments, but found ${i.length-1} instead.`);const u=a.parse(i[1],1,br),p=a.parse(i[2],2,br);return u&&p?new Ex(u,p):void 0}evaluate(i){const a=this.str.evaluate(i),u=this.delimiter.evaluate(i);return a.split(u)}eachChild(i){i(this.str),i(this.delimiter)}outputDefined(){return!1}serialize(){return["split",this.str.serialize(),this.delimiter.serialize()]}}function Ix(l,i){return l==="=="||l==="!="?i.kind==="boolean"||i.kind==="string"||i.kind==="number"||i.kind==="null"||i.kind==="value":i.kind==="string"||i.kind==="number"||i.kind==="value"}function Px(l,i,a,u){return u.compare(i,a)===0}function dh(l,i,a){const u=l!=="=="&&l!=="!=";return class xU{constructor(g,y,v){this.type=gr,this.lhs=g,this.rhs=y,this.collator=v,this.hasUntypedArgument=g.type.kind==="value"||y.type.kind==="value"}static parse(g,y){if(g.length!==3&&g.length!==4)return y.error("Expected two or three arguments.");const v=g[0];let T=y.parse(g[1],1,wr);if(!T)return null;if(!Ix(v,T.type))return y.concat(1).error(`"${v}" comparisons are not supported for type '${k(T.type)}'.`);let N=y.parse(g[2],2,wr);if(!N)return null;if(!Ix(v,N.type))return y.concat(2).error(`"${v}" comparisons are not supported for type '${k(N.type)}'.`);if(T.type.kind!==N.type.kind&&T.type.kind!=="value"&&N.type.kind!=="value")return y.error(`Cannot compare types '${k(T.type)}' and '${k(N.type)}'.`);u&&(T.type.kind==="value"&&N.type.kind!=="value"?T=new Di(N.type,[T]):T.type.kind!=="value"&&N.type.kind==="value"&&(N=new Di(T.type,[N])));let I=null;if(g.length===4){if(T.type.kind!=="string"&&N.type.kind!=="string"&&T.type.kind!=="value"&&N.type.kind!=="value")return y.error("Cannot use collator to compare non-string types.");if(I=y.parse(g[3],3,va),!I)return null}return new xU(T,N,I)}evaluate(g){const y=this.lhs.evaluate(g),v=this.rhs.evaluate(g);if(u&&this.hasUntypedArgument){const T=un(y),N=un(v);if(T.kind!==N.kind||T.kind!=="string"&&T.kind!=="number")throw new gs(`Expected arguments for "${l}" to be (string, string) or (number, number), but found (${T.kind}, ${N.kind}) instead.`)}if(this.collator&&!u&&this.hasUntypedArgument){const T=un(y),N=un(v);if(T.kind!=="string"||N.kind!=="string")return i(g,y,v)}return this.collator?a(g,y,v,this.collator.evaluate(g)):i(g,y,v)}eachChild(g){g(this.lhs),g(this.rhs),this.collator&&g(this.collator)}outputDefined(){return!0}serialize(){const g=[l];return this.eachChild(y=>{g.push(y.serialize())}),g}}}const nN=dh("==",function(l,i,a){return i===a},Px),sN=dh("!=",function(l,i,a){return i!==a},function(l,i,a,u){return!Px(0,i,a,u)}),wb=dh("<",function(l,i,a){return i<a},function(l,i,a,u){return u.compare(i,a)<0}),Sb=dh(">",function(l,i,a){return i>a},function(l,i,a,u){return u.compare(i,a)>0}),Wf=dh("<=",function(l,i,a){return i<=a},function(l,i,a,u){return u.compare(i,a)<=0}),aN=dh(">=",function(l,i,a){return i>=a},function(l,i,a,u){return u.compare(i,a)>=0});class Zf{constructor(i,a,u,p,g,y){this.type=br,this.number=i,this.locale=a,this.currency=u,this.unit=p,this.minFractionDigits=g,this.maxFractionDigits=y}static parse(i,a){if(i.length!==3)return a.error("Expected two arguments.");const u=a.parse(i[1],1,ii);if(!u)return null;const p=i[2];if(typeof p!="object"||Array.isArray(p))return a.error("NumberFormat options argument must be an object.");let g=null;if(p.locale&&(g=a.parseObjectValue(p.locale,2,"locale",br),!g))return null;let y=null;if(p.currency&&(y=a.parseObjectValue(p.currency,2,"currency",br),!y))return null;let v=null;if(p.unit&&(v=a.parseObjectValue(p.unit,2,"unit",br),!v))return null;let T=null;if(p["min-fraction-digits"]&&(T=a.parseObjectValue(p["min-fraction-digits"],2,"min-fraction-digits",ii),!T))return null;let N=null;return p["max-fraction-digits"]&&(N=a.parseObjectValue(p["max-fraction-digits"],2,"max-fraction-digits",ii),!N)?null:new Zf(u,g,y,v,T,N)}evaluate(i){return new Intl.NumberFormat(this.locale?this.locale.evaluate(i):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(i):void 0,unit:this.unit?this.unit.evaluate(i):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(i):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(i):void 0}).format(this.number.evaluate(i))}eachChild(i){i(this.number),this.locale&&i(this.locale),this.currency&&i(this.currency),this.unit&&i(this.unit),this.minFractionDigits&&i(this.minFractionDigits),this.maxFractionDigits&&i(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const i={};return this.locale&&(i.locale=this.locale.serialize()),this.currency&&(i.currency=this.currency.serialize()),this.unit&&(i.unit=this.unit.serialize()),this.minFractionDigits&&(i["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(i["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),i]}}class jx{constructor(i){this.type=ii,this.input=i}static parse(i,a){if(i.length!==2)return a.error(`Expected 1 argument, but found ${i.length-1} instead.`);const u=a.parse(i[1],1);return u?u.type.kind!=="array"&&u.type.kind!=="string"&&u.type.kind!=="value"?a.error(`Expected argument of type string or array, but found ${k(u.type)} instead.`):new jx(u):null}evaluate(i){const a=this.input.evaluate(i);if(typeof a=="string"||Array.isArray(a))return a.length;throw new gs(`Expected value to be of type string or array, but found ${k(un(a))} instead.`)}eachChild(i){i(this.input)}outputDefined(){return!1}serialize(){const i=["length"];return this.eachChild(a=>{i.push(a.serialize())}),i}}function Tb(l){return function(){l=1831565813+(l|=0)|0;let i=Math.imul(l^l>>>15,1|l);return i=i+Math.imul(i^i>>>7,61|i)^i,((i^i>>>14)>>>0)/4294967296}}const ud={"==":nN,"!=":sN,">":Sb,"<":wb,">=":aN,"<=":Wf,array:Di,at:$f,"at-interpolated":Gf,boolean:Di,case:tm,coalesce:Jp,collator:Jl,format:si,image:th,in:Cx,"index-of":uh,interpolate:Uo,"interpolate-hcl":Uo,"interpolate-lab":Uo,length:jx,let:jc,literal:Bo,match:em,number:Di,"number-format":Zf,object:Di,slice:Hf,step:Kp,string:Di,"to-boolean":Ql,"to-color":Ql,"to-number":Ql,"to-string":Ql,var:Ff,within:hu,distance:cd,config:oh,split:Ex};function Rx(l,[i,a,u,p]){i=i.evaluate(l),a=a.evaluate(l),u=u.evaluate(l);const g=p?p.evaluate(l):1,y=Ks(i,a,u,g);if(y)throw new gs(y);return new Ar(i/255,a/255,u/255,g)}function Nb(l,[i,a,u,p]){i=i.evaluate(l),a=a.evaluate(l),u=u.evaluate(l);const g=p?p.evaluate(l):1,y=function(N,I,P,j){return typeof N=="number"&&N>=0&&N<=360?typeof I=="number"&&I>=0&&I<=100&&typeof P=="number"&&P>=0&&P<=100?j===void 0||typeof j=="number"&&j>=0&&j<=1?null:`Invalid hsla value [${[N,I,P,j].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof j=="number"?[N,I,P,j]:[N,I,P]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof j=="number"?[N,I,P,j]:[N,I,P]).join(", ")}]: 'h' must be between 0 and 360.`}(i,a,u,g);if(y)throw new gs(y);const v=`hsla(${i}, ${a}%, ${u}%, ${g})`,T=Ar.parse(v);if(!T)throw new gs(`Failed to parse HSLA color: ${v}`);return T}function Ab(l,i){return l in i}function kx(l,i){const a=i[l];return a===void 0?null:a}function fu(l){return{type:l}}function dd(l){if(l instanceof oh)return new Set([l.key]);let i=new Set;return l.eachChild(a=>{i=new Set([...i,...dd(a)])}),i}function Xf(l){if(l instanceof to&&l.name==="is-active-floor")return!0;let i=!1;return l.eachChild(a=>{!i&&Xf(a)&&(i=!0)}),i}function Cb(l){return{result:"success",value:l}}function gu(l){return{result:"error",value:l}}function Dx(l,i){return!!l&&!!l.parameters&&l.parameters.indexOf(i)>-1}function Yf(l){return l["property-type"]==="data-driven"}function Mx(l){return Dx(l.expression,"measure-light")}function Eb(l){return Dx(l.expression,"zoom")}function Ox(l){return!!l.expression&&l.expression.interpolated}function Kf(l){return typeof l=="object"&&l!==null&&!Array.isArray(l)}function Ib(l){return l}function Lx(l,i){const a=i.type==="color",u=l.stops&&typeof l.stops[0][0]=="object",p=u||!(u||l.property!==void 0),g=l.type||(Ox(i)?"exponential":"interval");if(a&&((l=Object.assign({},l)).stops&&(l.stops=l.stops.map(N=>[N[0],Ar.parse(N[1])])),l.default=Ar.parse(l.default?l.default:i.default)),l.colorSpace&&l.colorSpace!=="rgb"&&!bb[l.colorSpace])throw new Error(`Unknown color space: ${l.colorSpace}`);let y,v,T;if(g==="exponential")y=Pb;else if(g==="interval")y=oN;else if(g==="categorical"){y=hh,v=Object.create(null);for(const N of l.stops)v[N[0]]=N[1];T=typeof l.stops[0][0]}else{if(g!=="identity")throw new Error(`Unknown function type "${g}"`);y=lN}if(u){const N={},I=[];for(let O=0;O<l.stops.length;O++){const L=l.stops[O],U=L[0].zoom;N[U]===void 0&&(N[U]={zoom:U,type:l.type,property:l.property,default:l.default,stops:[]},I.push(U)),N[U].stops.push([L[0].value,L[1]])}const P=[];for(const O of I)P.push([N[O].zoom,Lx(N[O],i)]);const j={name:"linear"};return{kind:"composite",interpolationType:j,interpolationFactor:Uo.interpolationFactor.bind(void 0,j),zoomStops:P.map(O=>O[0]),evaluate:({zoom:O},L)=>Pb({stops:P,base:l.base},i,O).evaluate(O,L)}}if(p){const N=g==="exponential"?{name:"exponential",base:l.base!==void 0?l.base:1}:null;return{kind:"camera",interpolationType:N,interpolationFactor:Uo.interpolationFactor.bind(void 0,N),zoomStops:l.stops.map(I=>I[0]),evaluate:({zoom:I})=>y(l,i,I,v,T)}}return{kind:"source",evaluate(N,I){const P=I&&I.properties?I.properties[l.property]:void 0;return P===void 0?im(l.default,i.default):y(l,i,P,v,T)}}}function im(l,i,a){return l!==void 0?l:i!==void 0?i:a!==void 0?a:void 0}function hh(l,i,a,u,p){return im(typeof a===p?u[a]:void 0,l.default,i.default)}function oN(l,i,a){if(!Ai(a))return im(l.default,i.default);const u=l.stops.length;if(u===1||a<=l.stops[0][0])return l.stops[0][1];if(a>=l.stops[u-1][0])return l.stops[u-1][1];const p=Bf(l.stops.map(g=>g[0]),a);return l.stops[p][1]}function Pb(l,i,a){const u=l.base!==void 0?l.base:1;if(!Ai(a))return im(l.default,i.default);const p=l.stops.length;if(p===1||a<=l.stops[0][0])return l.stops[0][1];if(a>=l.stops[p-1][0])return l.stops[p-1][1];const g=Bf(l.stops.map(I=>I[0]),a),y=function(I,P,j,O){const L=O-j,U=I-j;return L===0?0:P===1?U/L:(Math.pow(P,U)-1)/(Math.pow(P,L)-1)}(a,u,l.stops[g][0],l.stops[g+1][0]),v=l.stops[g][1],T=l.stops[g+1][1];let N=Yl[i.type]||Ib;if(l.colorSpace&&l.colorSpace!=="rgb"){const I=bb[l.colorSpace];N=(P,j)=>I.reverse(I.interpolate(I.forward(P),I.forward(j),y))}return typeof v.evaluate=="function"?{evaluate(...I){const P=v.evaluate.apply(void 0,I),j=T.evaluate.apply(void 0,I);if(P!==void 0&&j!==void 0)return N(P,j,y)}}:N(v,T,y)}function lN(l,i,a){return i.type==="color"?a=Ar.parse(a):i.type==="formatted"?a=an.fromString(a.toString()):i.type==="resolvedImage"?a=Cn.build(a.toString()):ji(a)===i.type||i.type==="enum"&&i.values[a]||(a=void 0),im(a,l.default,i.default)}to.register(ud,{error:[{kind:"error"},[br],(l,[i])=>{throw new gs(i.evaluate(l))}],typeof:[br,[wr],(l,[i])=>k(un(i.evaluate(l)))],"to-rgba":[as(ii,4),[ca],(l,[i])=>i.evaluate(l).toNonPremultipliedRenderColor(null).toArray()],"to-hsla":[as(ii,4),[ca],(l,[i])=>i.evaluate(l).toNonPremultipliedRenderColor(null).toHslaArray()],rgb:[ca,[ii,ii,ii],Rx],rgba:[ca,[ii,ii,ii,ii],Rx],hsl:[ca,[ii,ii,ii],Nb],hsla:[ca,[ii,ii,ii,ii],Nb],has:{type:gr,overloads:[[[br],(l,[i])=>Ab(i.evaluate(l),l.properties())],[[br,Ec],(l,[i,a])=>Ab(i.evaluate(l),a.evaluate(l))]]},get:{type:wr,overloads:[[[br],(l,[i])=>kx(i.evaluate(l),l.properties())],[[br,Ec],(l,[i,a])=>kx(i.evaluate(l),a.evaluate(l))]]},"feature-state":[wr,[br],(l,[i])=>kx(i.evaluate(l),l.featureState||{})],properties:[Ec,[],l=>l.properties()],"geometry-type":[br,[],l=>l.geometryType()],worldview:[br,[],l=>l.globals.worldview||""],"is-active-floor":[gr,fu(br),(l,i)=>{if(!(l.globals.activeFloors&&l.globals.activeFloors.size>0))return!1;const a=l.globals.activeFloors;return i.some(u=>{const p=u.evaluate(l);return a.has(p)})}],id:[wr,[],l=>l.id()],zoom:[ii,[],l=>l.globals.zoom],pitch:[ii,[],l=>l.globals.pitch||0],"distance-from-center":[ii,[],l=>l.distanceFromCenter()],"measure-light":[ii,[br],(l,[i])=>l.measureLight(i.evaluate(l))],"heatmap-density":[ii,[],l=>l.globals.heatmapDensity||0],"line-progress":[ii,[],l=>l.globals.lineProgress||0],"raster-value":[ii,[],l=>l.globals.rasterValue||0],"raster-particle-speed":[ii,[],l=>l.globals.rasterParticleSpeed||0],"sky-radial-progress":[ii,[],l=>l.globals.skyRadialProgress||0],accumulated:[wr,[],l=>l.globals.accumulated===void 0?null:l.globals.accumulated],"+":[ii,fu(ii),(l,i)=>{let a=0;for(const u of i)a+=u.evaluate(l);return a}],"*":[ii,fu(ii),(l,i)=>{let a=1;for(const u of i)a*=u.evaluate(l);return a}],"-":{type:ii,overloads:[[[ii,ii],(l,[i,a])=>i.evaluate(l)-a.evaluate(l)],[[ii],(l,[i])=>-i.evaluate(l)]]},"/":[ii,[ii,ii],(l,[i,a])=>i.evaluate(l)/a.evaluate(l)],"%":[ii,[ii,ii],(l,[i,a])=>i.evaluate(l)%a.evaluate(l)],ln2:[ii,[],()=>Math.LN2],pi:[ii,[],()=>Math.PI],e:[ii,[],()=>Math.E],"^":[ii,[ii,ii],(l,[i,a])=>Math.pow(i.evaluate(l),a.evaluate(l))],sqrt:[ii,[ii],(l,[i])=>Math.sqrt(i.evaluate(l))],log10:[ii,[ii],(l,[i])=>Math.log(i.evaluate(l))/Math.LN10],ln:[ii,[ii],(l,[i])=>Math.log(i.evaluate(l))],log2:[ii,[ii],(l,[i])=>Math.log2(i.evaluate(l))],sin:[ii,[ii],(l,[i])=>Math.sin(i.evaluate(l))],cos:[ii,[ii],(l,[i])=>Math.cos(i.evaluate(l))],tan:[ii,[ii],(l,[i])=>Math.tan(i.evaluate(l))],asin:[ii,[ii],(l,[i])=>Math.asin(i.evaluate(l))],acos:[ii,[ii],(l,[i])=>Math.acos(i.evaluate(l))],atan:[ii,[ii],(l,[i])=>Math.atan(i.evaluate(l))],min:[ii,fu(ii),(l,i)=>Math.min(...i.map(a=>a.evaluate(l)))],max:[ii,fu(ii),(l,i)=>Math.max(...i.map(a=>a.evaluate(l)))],abs:[ii,[ii],(l,[i])=>Math.abs(i.evaluate(l))],round:[ii,[ii],(l,[i])=>{const a=i.evaluate(l);return a<0?-Math.round(-a):Math.round(a)}],floor:[ii,[ii],(l,[i])=>Math.floor(i.evaluate(l))],ceil:[ii,[ii],(l,[i])=>Math.ceil(i.evaluate(l))],"filter-==":[gr,[br,wr],(l,[i,a])=>l.properties()[i.value]===a.value],"filter-id-==":[gr,[wr],(l,[i])=>l.id()===i.value],"filter-type-==":[gr,[br],(l,[i])=>l.geometryType()===i.value],"filter-<":[gr,[br,wr],(l,[i,a])=>{const u=l.properties()[i.value],p=a.value;return typeof u==typeof p&&u<p}],"filter-id-<":[gr,[wr],(l,[i])=>{const a=l.id(),u=i.value;return typeof a==typeof u&&a<u}],"filter->":[gr,[br,wr],(l,[i,a])=>{const u=l.properties()[i.value],p=a.value;return typeof u==typeof p&&u>p}],"filter-id->":[gr,[wr],(l,[i])=>{const a=l.id(),u=i.value;return typeof a==typeof u&&a>u}],"filter-<=":[gr,[br,wr],(l,[i,a])=>{const u=l.properties()[i.value],p=a.value;return typeof u==typeof p&&u<=p}],"filter-id-<=":[gr,[wr],(l,[i])=>{const a=l.id(),u=i.value;return typeof a==typeof u&&a<=u}],"filter->=":[gr,[br,wr],(l,[i,a])=>{const u=l.properties()[i.value],p=a.value;return typeof u==typeof p&&u>=p}],"filter-id->=":[gr,[wr],(l,[i])=>{const a=l.id(),u=i.value;return typeof a==typeof u&&a>=u}],"filter-has":[gr,[wr],(l,[i])=>i.value in l.properties()],"filter-has-id":[gr,[],l=>l.id()!==null&&l.id()!==void 0],"filter-type-in":[gr,[as(br)],(l,[i])=>i.value.indexOf(l.geometryType())>=0],"filter-id-in":[gr,[as(wr)],(l,[i])=>i.value.indexOf(l.id())>=0],"filter-in-small":[gr,[br,as(wr)],(l,[i,a])=>a.value.indexOf(l.properties()[i.value])>=0],"filter-in-large":[gr,[br,as(wr)],(l,[i,a])=>function(u,p,g,y){for(;g<=y;){const v=g+y>>1;if(p[v]===u)return!0;p[v]>u?y=v-1:g=v+1}return!1}(l.properties()[i.value],a.value,0,a.value.length-1)],all:{type:gr,overloads:[[[gr,gr],(l,[i,a])=>i.evaluate(l)&&a.evaluate(l)],[fu(gr),(l,i)=>{for(const a of i)if(!a.evaluate(l))return!1;return!0}]]},any:{type:gr,overloads:[[[gr,gr],(l,[i,a])=>i.evaluate(l)||a.evaluate(l)],[fu(gr),(l,i)=>{for(const a of i)if(a.evaluate(l))return!0;return!1}]]},"!":[gr,[gr],(l,[i])=>!i.evaluate(l)],"is-supported-script":[gr,[br],(l,[i])=>{const a=l.globals&&l.globals.isSupportedScript;return!a||a(i.evaluate(l))}],upcase:[br,[br],(l,[i])=>i.evaluate(l).toUpperCase()],downcase:[br,[br],(l,[i])=>i.evaluate(l).toLowerCase()],concat:[br,fu(wr),(l,i)=>i.map(a=>eo(a.evaluate(l))).join("")],"resolved-locale":[br,[va],(l,[i])=>i.evaluate(l).resolvedLocale()],random:[ii,[ii,ii,wr],(l,i)=>{const[a,u,p]=i.map(y=>y.evaluate(l));if(a>u||a===u)return a;let g;if(typeof p=="string")g=function(y){let v=0;if(y.length===0)return v;for(let T=0;T<y.length;T++)v=(v<<5)-v+y.charCodeAt(T),v&=v;return v}(p);else{if(typeof p!="number")throw new gs(`Invalid seed input: ${p}`);g=p}return a+Tb(g)()*(u-a)}]});class Qf{constructor(i,a,u,p,g){this.expression=i,this._warningHistory={},this._scope=u,this._options=p,this._iconImageUseTheme=g,this._evaluator=new ih(u,p,g),this._defaultValue=a?function(y){return y.type==="color"&&(Kf(y.default)||Array.isArray(y.default))?new Ar(0,0,0,0):y.type==="color"?Ar.parse(y.default)||null:y.default===void 0?null:y.default}(a):null,this._enumValues=a&&a.type==="enum"?a.values:null,this.configDependencies=dd(i),this.isIndoorDependent=Xf(i)}evaluateWithoutErrorHandling(i,a,u,p,g,y,v,T){return this._evaluator.globals=i,this._evaluator.feature=a,this._evaluator.featureState=u,this._evaluator.canonical=p||null,this._evaluator.availableImages=g||null,this._evaluator.formattedSection=y,this._evaluator.featureTileCoord=v||null,this._evaluator.featureDistanceData=T||null,this.expression.evaluate(this._evaluator)}evaluate(i,a,u,p,g,y,v,T,N){this._evaluator||(this._evaluator=new ih(this._scope,this._options,this._iconImageUseTheme)),this._evaluator.globals=i,this._evaluator.feature=a||null,this._evaluator.featureState=u||null,this._evaluator.canonical=p||null,this._evaluator.availableImages=g||null,this._evaluator.formattedSection=y||null,this._evaluator.featureTileCoord=v||null,this._evaluator.featureDistanceData=T||null,this._evaluator.iconImageUseTheme=N||null;try{const I=this.expression.evaluate(this._evaluator);if(I==null||typeof I=="number"&&I!=I)return this._defaultValue;if(this._enumValues&&!(I in this._enumValues))throw new gs(`Expected value to be one of ${Object.keys(this._enumValues).map(P=>JSON.stringify(P)).join(", ")}, but found ${JSON.stringify(I)} instead.`);return I}catch(I){const P=I;return this._warningHistory[P.message]||(this._warningHistory[P.message]=!0,typeof console<"u"&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${P.message}`)),this._defaultValue}}}function rm(l){return Array.isArray(l)&&l.length>0&&typeof l[0]=="string"&&l[0]in ud}function yu(l,i,a,u,p){const g=new zf(ud,[],i?function(v){const T={color:ca,string:br,number:ii,enum:br,boolean:gr,formatted:Ic,resolvedImage:Kl};return v.type==="array"?as(T[v.value]||wr,v.length):T[v.type]}(i):void 0,void 0,void 0,a,u,p),y=g.parse(l,void 0,void 0,void 0,i&&i.type==="string"?{typeAnnotation:"coerce"}:void 0);return y?Cb(new Qf(y,i,a,u,p)):gu(g.errors)}class nm{constructor(i,a,u,p){this.kind=i,this._styleExpression=a,this.isLightConstant=u,this.isLineProgressConstant=p,this.isStateDependent=i!=="constant"&&!Yp(a.expression),this.configDependencies=dd(a.expression),this.isIndoorDependent=Xf(a.expression)}evaluateWithoutErrorHandling(i,a,u,p,g,y){return this._styleExpression.evaluateWithoutErrorHandling(i,a,u,p,g,y)}evaluate(i,a,u,p,g,y,v){return this._styleExpression.evaluate(i,a,u,p,g,y,void 0,void 0,v)}}class hd{constructor(i,a,u,p,g,y){this.kind=i,this.zoomStops=u,this._styleExpression=a,this.isStateDependent=i!=="camera"&&!Yp(a.expression),this.isIndoorDependent=Xf(a.expression),this.isLightConstant=g,this.isLineProgressConstant=y,this.configDependencies=dd(a.expression),this.interpolationType=p}evaluateWithoutErrorHandling(i,a,u,p,g,y){return this._styleExpression.evaluateWithoutErrorHandling(i,a,u,p,g,y)}evaluate(i,a,u,p,g,y){return this._styleExpression.evaluate(i,a,u,p,g,y)}interpolationFactor(i,a,u){return this.interpolationType?Uo.interpolationFactor(this.interpolationType,i,a,u):0}}function Jf(l,i,a,u,p){if((l=yu(l,i,a,u,p)).result==="error")return l;const g=l.value.expression,y=sh(g);if(!y&&!Yf(i))return gu([new Ls("","data expressions not supported")]);const v=ah(g,["zoom","pitch","distance-from-center"]);if(!v&&!Eb(i))return gu([new Ls("","zoom expressions not supported")]);const T=ah(g,["measure-light"]);if(!T&&!Mx(i))return gu([new Ls("","measure-light expression not supported")]);const N=ah(g,["line-progress"]);if(!N&&!function(j){return Dx(j.expression,"line-progress")}(i))return gu([new Ls("","line-progress expression not supported")]);const I=i.expression&&i.expression.relaxZoomRestriction,P=eg(g);return P||v||I?P instanceof Ls?gu([P]):P instanceof Uo&&!Ox(i)?gu([new Ls("",'"interpolate" expressions cannot be used with this property')]):Cb(P?new hd(y&&N?"camera":"composite",l.value,P.labels,P instanceof Uo?P.interpolation:void 0,T,N):new nm(y&&N?"constant":"source",l.value,T,N)):gu([new Ls("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class sm{constructor(i,a){this._parameters=i,this._specification=a,Object.assign(this,Lx(this._parameters,this._specification))}static deserialize(i){return new sm(i._parameters,i._specification)}static serialize(i){return{_parameters:i._parameters,_specification:i._specification}}}function eg(l){let i=null;if(l instanceof jc)i=eg(l.result);else if(l instanceof Jp){for(const a of l.args)if(i=eg(a),i)break}else(l instanceof Kp||l instanceof Uo)&&l.input instanceof to&&l.input.name==="zoom"&&(i=l);return i instanceof Ls||l.eachChild(a=>{const u=eg(a);u instanceof Ls?i=u:i&&u&&i!==u&&(i=new Ls("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),i}var tc,jb,cN=function(){if(jb)return tc;jb=1,tc=i;var l=3;function i(a,u,p){var g=this.cells=[];if(a instanceof ArrayBuffer){this.arrayBuffer=a;var y=new Int32Array(this.arrayBuffer);a=y[0],this.d=(u=y[1])+2*(p=y[2]);for(var v=0;v<this.d*this.d;v++){var T=y[l+v],N=y[l+v+1];g.push(T===N?null:y.subarray(T,N))}var I=y[l+g.length+1];this.keys=y.subarray(y[l+g.length],I),this.bboxes=y.subarray(I),this.insert=this._insertReadonly}else{this.d=u+2*p;for(var P=0;P<this.d*this.d;P++)g.push([]);this.keys=[],this.bboxes=[]}this.n=u,this.extent=a,this.padding=p,this.scale=u/a,this.uid=0;var j=p/u*a;this.min=-j,this.max=a+j}return i.prototype.insert=function(a,u,p,g,y){this._forEachCell(u,p,g,y,this._insertCell,this.uid++),this.keys.push(a),this.bboxes.push(u),this.bboxes.push(p),this.bboxes.push(g),this.bboxes.push(y)},i.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},i.prototype._insertCell=function(a,u,p,g,y,v){this.cells[y].push(v)},i.prototype.query=function(a,u,p,g,y){var v=this.min,T=this.max;if(a<=v&&u<=v&&T<=p&&T<=g&&!y)return Array.prototype.slice.call(this.keys);var N=[];return this._forEachCell(a,u,p,g,this._queryCell,N,{},y),N},i.prototype._queryCell=function(a,u,p,g,y,v,T,N){var I=this.cells[y];if(I!==null)for(var P=this.keys,j=this.bboxes,O=0;O<I.length;O++){var L=I[O];if(T[L]===void 0){var U=4*L;(N?N(j[U+0],j[U+1],j[U+2],j[U+3]):a<=j[U+2]&&u<=j[U+3]&&p>=j[U+0]&&g>=j[U+1])?(T[L]=!0,v.push(P[L])):T[L]=!1}}},i.prototype._forEachCell=function(a,u,p,g,y,v,T,N){for(var I=this._convertToCellCoord(a),P=this._convertToCellCoord(u),j=this._convertToCellCoord(p),O=this._convertToCellCoord(g),L=I;L<=j;L++)for(var U=P;U<=O;U++){var Z=this.d*U+L;if((!N||N(this._convertFromCellCoord(L),this._convertFromCellCoord(U),this._convertFromCellCoord(L+1),this._convertFromCellCoord(U+1)))&&y.call(this,a,u,p,g,Z,v,T,N))return}},i.prototype._convertFromCellCoord=function(a){return(a-this.padding)/this.scale},i.prototype._convertToCellCoord=function(a){return Math.max(0,Math.min(this.d-1,Math.floor(a*this.scale)+this.padding))},i.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var a=this.cells,u=l+this.cells.length+1+1,p=0,g=0;g<this.cells.length;g++)p+=this.cells[g].length;var y=new Int32Array(u+p+this.keys.length+this.bboxes.length);y[0]=this.extent,y[1]=this.n,y[2]=this.padding;for(var v=u,T=0;T<a.length;T++){var N=a[T];y[l+T]=v,y.set(N,v),v+=N.length}return y[l+a.length]=v,y.set(this.keys,v),y[l+a.length+1]=v+=this.keys.length,y.set(this.bboxes,v),v+=this.bboxes.length,y.buffer},tc}(),pd=fs(cN);const tg={};function Yt(l,i,a={}){Object.defineProperty(l,"_classRegistryKey",{value:i,writable:!1}),tg[i]={klass:l,omit:a.omit||[]}}Yt(Object,"Object"),pd.serialize=function(l,i){const a=l.toArrayBuffer();return i&&i.add(a),{buffer:a}},pd.deserialize=function(l){return new pd(l.buffer)},Object.defineProperty(pd,"name",{value:"Grid"}),Yt(pd,"Grid"),delete wt.prototype.constructor,Yt(Ar,"Color"),Yt(Error,"Error"),Yt(an,"Formatted"),Yt(An,"FormattedSection"),Yt(id,"AJAXError"),Yt(Cn,"ResolvedImage"),Yt(sm,"StylePropertyFunction"),Yt(Qf,"StyleExpression",{omit:["_evaluator"]}),Yt(Ys,"ImageId"),Yt(Er,"ImageVariant"),Yt(hd,"ZoomDependentExpression"),Yt(nm,"ZoomConstantExpression"),Yt(to,"CompoundExpression",{omit:["_evaluate"]});for(const l in ud)tg[ud[l]._classRegistryKey]||Yt(ud[l],`Expression${l}`);function Fx(l){return l&&(l instanceof ArrayBuffer||l.constructor&&l.constructor.name==="ArrayBuffer")}function Cl(l,i){if(l==null||typeof l=="boolean"||typeof l=="number"||typeof l=="string"||l instanceof Boolean||l instanceof Number||l instanceof String||l instanceof Date||l instanceof RegExp)return l;if(Fx(l)||l instanceof ImageBitmap)return i&&i.add(l),l;if(ArrayBuffer.isView(l))return i&&i.add(l.buffer),l;if(l instanceof ImageData)return i&&i.add(l.data.buffer),l;if(Array.isArray(l)){const a=[];for(const u of l)a.push(Cl(u,i));return a}if(l instanceof Map){const a={$name:"Map",entries:[]};for(const[u,p]of l.entries())a.entries.push(Cl(u),Cl(p,i));return a}if(l instanceof Set){const a={$name:"Set"};let u=0;for(const p of l.values())a[++u]=Cl(p);return a}if(typeof l=="bigint")return{$name:"BigInt",value:l.toString()};if(typeof l=="object"){const a=l.constructor,u=a._classRegistryKey;if(!u)throw new Error(`Can't serialize object of unregistered class "${a.name}".`);const p=a.serialize?a.serialize(l,i):{};if(!a.serialize){for(const g in l)l.hasOwnProperty(g)&&(tg[u].omit.indexOf(g)>=0||(p[g]=Cl(l[g],i)));l instanceof Error&&(p.message=l.message)}if(p.$name)throw new Error("$name property is reserved for worker serialization logic.");return u!=="Object"&&(p.$name=u),p}throw new Error("can't serialize object of type "+typeof l)}function Rc(l){if(l==null||typeof l=="boolean"||typeof l=="number"||typeof l=="string"||l instanceof Boolean||l instanceof Number||l instanceof String||l instanceof Date||l instanceof RegExp||Fx(l)||l instanceof ImageBitmap||ArrayBuffer.isView(l)||l instanceof ImageData)return l;if(Array.isArray(l))return l.map(Rc);if(typeof l=="object"){const i=l.$name||"Object";if(i==="Map"){const p=l.entries||[],g=new Map;for(let y=0;y<p.length;y+=2)g.set(Rc(p[y]),Rc(p[y+1]));return g}if(i==="Set"){const p=new Set;for(const g of Object.keys(l))g!=="$name"&&p.add(Rc(l[g]));return p}if(i==="BigInt")return BigInt(l.value);const{klass:a}=tg[i];if(!a)throw new Error(`Can't deserialize unregistered class "${i}".`);if(a.deserialize)return a.deserialize(l);const u=Object.create(a.prototype);for(const p of Object.keys(l))p!=="$name"&&(u[p]=Rc(l[p]));return u}throw new Error("can't deserialize object of type "+typeof l)}const Rb=l=>l>=1536&&l<=1791,kb=l=>l>=1872&&l<=1919,ig=l=>l>=2208&&l<=2303,rg=l=>l>=11904&&l<=12031,zx=l=>l>=12032&&l<=12255,Bx=l=>l>=12272&&l<=12287,ph=l=>l>=12288&&l<=12351,mh=l=>l>=12352&&l<=12447,am=l=>l>=12448&&l<=12543,ic=l=>l>=12544&&l<=12591,Db=l=>l>=12704&&l<=12735,Mb=l=>l>=12736&&l<=12783,Ob=l=>l>=12784&&l<=12799,Lb=l=>l>=12800&&l<=13055,Vx=l=>l>=13056&&l<=13311,fh=l=>l>=13312&&l<=19903,ng=l=>l>=19968&&l<=40959,Ux=l=>l>=40960&&l<=42127,sg=l=>l>=42128&&l<=42191,Fb=l=>l>=44032&&l<=55215,zb=l=>l>=63744&&l<=64255,qx=l=>l>=64336&&l<=65023,Bb=l=>l>=65040&&l<=65055,$x=l=>l>=65072&&l<=65103,Vb=l=>l>=65104&&l<=65135,Gx=l=>l>=65136&&l<=65279,Hx=l=>l>=65280&&l<=65519;function Wx(l){for(const i of l)if(xu(i.charCodeAt(0)))return!0;return!1}function uN(l){for(const i of l)if(!dN(i.charCodeAt(0)))return!1;return!0}function dN(l){return!(Rb(l)||kb(l)||ig(l)||qx(l)||Gx(l))}function Ub(l){return!(l<11904||!(Db(l)||ic(l)||$x(l)||zb(l)||Vx(l)||rg(l)||Mb(l)||ph(l)||fh(l)||ng(l)||Lb(l)||Hx(l)||mh(l)||Bx(l)||zx(l)||Ob(l)||am(l)||Bb(l)||sg(l)||Ux(l)))}function xu(l){return!(l!==746&&l!==747&&(l<4352||!(Db(l)||ic(l)||$x(l)&&!(l>=65097&&l<=65103)||zb(l)||Vx(l)||rg(l)||Mb(l)||!(!ph(l)||l>=12296&&l<=12305||l>=12308&&l<=12319||l===12336)||fh(l)||ng(l)||Lb(l)||(i=>i>=12592&&i<=12687)(l)||(i=>i>=43360&&i<=43391)(l)||(i=>i>=55216&&i<=55295)(l)||(i=>i>=4352&&i<=4607)(l)||Fb(l)||mh(l)||Bx(l)||(i=>i>=12688&&i<=12703)(l)||zx(l)||Ob(l)||am(l)&&l!==12540||!(!Hx(l)||l===65288||l===65289||l===65293||l>=65306&&l<=65310||l===65339||l===65341||l===65343||l>=65371&&l<=65503||l===65507||l>=65512&&l<=65519)||!(!Vb(l)||l>=65112&&l<=65118||l>=65123&&l<=65126)||(i=>i>=5120&&i<=5759)(l)||(i=>i>=6320&&i<=6399)(l)||Bb(l)||(i=>i>=19904&&i<=19967)(l)||Ux(l)||sg(l))))}function qb(l){return l===12312||l===12313||l===12316||l===12540||l===12448}function Zx(l){return!(xu(l)||function(i){return!!((a=>a>=128&&a<=255)(i)&&(i===167||i===169||i===174||i===177||i===188||i===189||i===190||i===215||i===247)||(a=>a>=8192&&a<=8303)(i)&&(i===8214||i===8224||i===8225||i===8240||i===8241||i===8251||i===8252||i===8258||i===8263||i===8264||i===8265||i===8273)||(a=>a>=8448&&a<=8527)(i)||(a=>a>=8528&&a<=8591)(i)||(a=>a>=8960&&a<=9215)(i)&&(i>=8960&&i<=8967||i>=8972&&i<=8991||i>=8996&&i<=9e3||i===9003||i>=9085&&i<=9114||i>=9150&&i<=9165||i===9167||i>=9169&&i<=9179||i>=9186&&i<=9215)||(a=>a>=9216&&a<=9279)(i)&&i!==9251||(a=>a>=9280&&a<=9311)(i)||(a=>a>=9312&&a<=9471)(i)||(a=>a>=9632&&a<=9727)(i)||(a=>a>=9728&&a<=9983)(i)&&!(i>=9754&&i<=9759)||(a=>a>=11008&&a<=11263)(i)&&(i>=11026&&i<=11055||i>=11088&&i<=11097||i>=11192&&i<=11243)||ph(i)||am(i)||(a=>a>=57344&&a<=63743)(i)||$x(i)||Vb(i)||Hx(i)||i===8734||i===8756||i===8757||i>=9984&&i<=10087||i>=10102&&i<=10131||i===65532||i===65533)}(l))}function ag(l){return Rb(l)||kb(l)||ig(l)||qx(l)||Gx(l)}function $b(l){return l>=1424&&l<=2303||qx(l)||Gx(l)}function hN(l,i){return!(!i&&$b(l)||l>=2304&&l<=3583||l>=3840&&l<=4255||(a=>a>=6016&&a<=6143)(l))}function _u(l){for(const i of l)if($b(i.charCodeAt(0)))return!0;return!1}const io={unavailable:"unavailable",deferred:"deferred",loading:"loading",parsing:"parsing",parsed:"parsed",loaded:"loaded",error:"error"};let vu=null,Fa=io.unavailable,bu=null;const Gb=function(l){l&&typeof l=="string"&&l.indexOf("NetworkError")>-1&&(Fa=io.error),vu&&vu(l)};function Xx(){Yx.fire(new ul("pluginStateChange",{pluginStatus:Fa,pluginURL:bu}))}const Yx=new zo,Kx=function(){return Fa},Qx=function(){if(Fa!==io.deferred||!bu)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");Fa=io.loading,Xx(),bu&&su({url:bu},l=>{l?Gb(l):(Fa=io.loaded,Xx())})},El={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>Fa===io.loaded||El.applyArabicShaping!=null,isLoading:()=>Fa===io.loading,setState(l){Fa=l.pluginStatus,bu=l.pluginURL},isParsing:()=>Fa===io.parsing,isParsed:()=>Fa===io.parsed,getPluginURL:()=>bu};class Vr{constructor(i,a){this.zoom=i,a?(this.now=a.now,this.fadeDuration=a.fadeDuration,this.transition=a.transition,this.pitch=a.pitch,this.brightness=a.brightness,this.worldview=a.worldview,this.activeFloors=a.activeFloors):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(i){return function(a,u){for(const p of a)if(!hN(p.charCodeAt(0),u))return!1;return!0}(i,El.isLoaded())}}class om{constructor(i,a,u,p,g){this.property=i,this.value=a,this.expression=function(y,v,T,N,I){if(Kf(y))return new sm(y,v);if(rm(y)||Array.isArray(y)&&y.length>0){const P=Jf(y,v,T,N,I);if(P.result==="error")throw new Error(P.value.map(j=>`${j.key}: ${j.message}`).join(", "));return P.value}{let P=y;return typeof y=="string"&&v.type==="color"&&(P=Ar.parse(y)),{kind:"constant",configDependencies:new Set,isIndoorDependent:!1,evaluate:()=>P}}}(a===void 0?i.specification.default:a,i.specification,u,p,g)}isIndoorDependent(){return this.expression.isIndoorDependent}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(i,a,u,p){return this.property.possiblyEvaluate(this,i,a,u,p)}}class lm{constructor(i,a,u,p){this.property=i,this.value=new om(i,void 0,a,u,p)}transitioned(i,a){return new Hb(this.property,this.value,a,Object.assign({},i.transition,this.transition),i.now)}untransitioned(){return new Hb(this.property,this.value,null,{},0)}}class gh{constructor(i,a,u,p){this._properties=i,this._values=Object.create(i.defaultTransitionablePropertyValues),this._scope=a,this._options=u,this._iconImageUseTheme=p,this._isIndoorDependent=!1,this.configDependencies=new Set}getValue(i){return zi(this._values[i].value.value)}setValue(i,a){this._values.hasOwnProperty(i)||(this._values[i]=new lm(this._values[i].property,this._scope,this._options,this._iconImageUseTheme)),this._values[i].value=new om(this._values[i].property,a===null?void 0:zi(a),this._scope,this._options,this._iconImageUseTheme),this._values[i].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[i].value.expression.configDependencies]),this._isIndoorDependent=this._isIndoorDependent||this._values[i].value.isIndoorDependent())}setTransitionOrValue(i,a){a&&(this._options=a);const u=this._properties.properties;if(i)for(const p in i){const g=i[p];if(p.endsWith("-transition")){const y=p.slice(0,-11);u[y]&&this.setTransition(y,g)}else u.hasOwnProperty(p)&&this.setValue(p,g)}}getTransition(i){return zi(this._values[i].transition)}setTransition(i,a){this._values.hasOwnProperty(i)||(this._values[i]=new lm(this._values[i].property)),this._values[i].transition=zi(a)||void 0}serialize(){const i={};for(const a of Object.keys(this._values)){const u=this.getValue(a);u!==void 0&&(i[a]=u);const p=this.getTransition(a);p!==void 0&&(i[`${a}-transition`]=p)}return i}transitioned(i,a){const u=new Wb(this._properties);for(const p of Object.keys(this._values))u._values[p]=this._values[p].transitioned(i,a._values[p]);return u}untransitioned(){const i=new Wb(this._properties);for(const a of Object.keys(this._values))i._values[a]=this._values[a].untransitioned();return i}isIndoorDependent(){return this._isIndoorDependent}}class Hb{constructor(i,a,u,p,g){const y=p.delay||0,v=p.duration||0;g=g||0,this.property=i,this.value=a,this.begin=g+y,this.end=this.begin+v,i.specification.transition&&(p.delay||p.duration)&&(this.prior=u)}possiblyEvaluate(i,a,u){const p=i.now||0,g=this.value.possiblyEvaluate(i,a,u),y=this.prior;if(y){if(p>this.end)return this.prior=null,g;if(this.value.isDataDriven())return this.prior=null,g;if(p<this.begin)return y.possiblyEvaluate(i,a,u);{const v=(p-this.begin)/(this.end-this.begin);return this.property.interpolate(y.possiblyEvaluate(i,a,u),g,pe(v))}}return g}}class Wb{constructor(i){this._properties=i,this._values=Object.create(i.defaultTransitioningPropertyValues)}possiblyEvaluate(i,a,u){const p=new za(this._properties);for(const g of Object.keys(this._values))p._values[g]=this._values[g].possiblyEvaluate(i,a,u);return p}hasTransition(){for(const i of Object.keys(this._values))if(this._values[i].prior)return!0;return!1}}class Jx{constructor(i,a,u,p){this._properties=i,this._values=Object.create(i.defaultPropertyValues),this._scope=a,this._options=u,this._iconImageUseTheme=p,this._isIndoorDependent=!1,this.configDependencies=new Set}getValue(i){return zi(this._values[i].value)}setValue(i,a){this._values[i]=new om(this._values[i].property,a===null?void 0:zi(a),this._scope,this._options,this._iconImageUseTheme),this._values[i].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[i].expression.configDependencies]),this._isIndoorDependent=this._isIndoorDependent||this._values[i].isIndoorDependent())}serialize(){const i={};for(const a of Object.keys(this._values)){const u=this.getValue(a);u!==void 0&&(i[a]=u)}return i}possiblyEvaluate(i,a,u,p){const g=new za(this._properties);for(const y of Object.keys(this._values))g._values[y]=this._values[y].possiblyEvaluate(i,a,u,p);return g}isIndoorDependent(){return this._isIndoorDependent}}class md{constructor(i,a,u,p){this.property=i,this.value=a,this.parameters=u,this.iconImageUseTheme=p}isConstant(){return this.value.kind==="constant"}constantOr(i){return this.value.kind==="constant"?this.value.value:i}evaluate(i,a,u,p){return this.property.evaluate(this.value,this.parameters,i,a,u,p,this.iconImageUseTheme)}}class za{constructor(i){this._properties=i,this._values=Object.create(i.defaultPossiblyEvaluatedValues)}get(i){return this._values[i]}}class Dt{constructor(i){this.specification=i}possiblyEvaluate(i,a){return i.expression.evaluate(a)}interpolate(i,a,u){const p=Yl[this.specification.type];return p?p(i,a,u):i}}class $t{constructor(i,a){this.specification=i,this.overrides=a}possiblyEvaluate(i,a,u,p,g){return i.expression.kind==="constant"||i.expression.kind==="camera"?new md(this,{kind:"constant",value:i.expression.evaluate(a,null,{},u,p,void 0,g)},a):new md(this,i.expression,a,g)}interpolate(i,a,u){if(i.value.kind!=="constant"||a.value.kind!=="constant")return i;if(i.value.value===void 0||a.value.value===void 0)return new md(this,{kind:"constant",value:void 0},i.parameters);const p=Yl[this.specification.type];return p?new md(this,{kind:"constant",value:p(i.value.value,a.value.value,u)},i.parameters):i}evaluate(i,a,u,p,g,y,v){return i.kind==="constant"?i.value:i.evaluate(a,u,p,g,y,void 0,v)}}class yh{constructor(i){this.specification=i}possiblyEvaluate(i,a,u,p){return!!i.expression.evaluate(a,null,{},u,p)}interpolate(){return!1}}class kn{constructor(i){this.properties=i,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const a=new Vr(0,{});for(const u in i){const p=i[u];p.specification.overridable&&this.overridableProperties.push(u);const g=this.defaultPropertyValues[u]=new om(p,void 0),y=this.defaultTransitionablePropertyValues[u]=new lm(p);this.defaultTransitioningPropertyValues[u]=y.untransitioned(),this.defaultPossiblyEvaluatedValues[u]=g.possiblyEvaluate(a)}}}Yt($t,"DataDrivenProperty"),Yt(Dt,"DataConstantProperty"),Yt(yh,"ColorRampProperty");var et=JSON.parse('{"$version":8,"$root":{"version":{"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow"},"rain":{"type":"rain"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor"},"imports":{"type":"array","value":"import"},"iconsets":{"type":"iconsets"},"schema":{"type":"schema"},"sources":{"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"type":"featuresets"}},"featuresets":{"*":{"type":"featureset"}},"featureset":{"metadata":{"type":"*"},"selectors":{"type":"array","value":"selector"}},"selector":{"layer":{"type":"string"},"properties":{"type":"selectorProperty"},"featureNamespace":{"type":"string"},"_uniqueFeatureID":{"type":"boolean"}},"selectorProperty":{"*":{"type":"*"}},"model":{"type":"string"},"import":{"id":{"type":"string"},"url":{"type":"string"},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","expression":{}},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string"},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false},"shadow-quality":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]}},"shadow-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"shadow-draw-before-layer":{"type":"string"}},"properties_light_ambient":{"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"type":"enum","values":{"sprite":1}},"url":{"type":"string"}},"iconset_source":{"type":{"type":"enum","values":{"source":1}},"source":{"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"type":"enum","values":{"video":1}},"urls":{"type":"array","value":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"type":"enum","values":{"image":1}},"url":{"type":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"modelNodeOverride":{"orientation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360}},"modelNodeOverrides":{"*":{"type":"modelNodeOverride"}},"modelMaterialOverride":{"model-color":{"type":"color"},"model-color-mix-intensity":{"type":"number"},"model-opacity":{"type":"number"},"model-emissive-strength":{"type":"number"}},"modelMaterialOverrides":{"*":{"type":"modelMaterialOverride"}},"modelSourceModel":{"uri":{"type":"string"},"position":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[-180,-90],"maximum":[180,90]},"orientation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360},"nodeOverrides":{"type":"modelNodeOverrides"},"materialOverrides":{"type":"modelMaterialOverrides"},"nodeOverrideNames":{"type":"array","value":"string"},"materialOverrideNames":{"type":"array","value":"string"},"featureProperties":{"type":"*"}},"modelSourceModels":{"*":{"type":"modelSourceModel"}},"source_model":{"type":{"type":"enum","values":{"model":1,"batched-model":1}},"url":{"type":"string"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"},"models":{"type":"modelSourceModels"}},"layer":{"id":{"type":"string"},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"building":{},"raster":{},"raster-particle":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{},"clip":{}}},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"},"appearances":{"type":"array","value":"appearance","supported-layer-types":["symbol"]}},"appearance":{"condition":{"type":"boolean","expression":{"interpolated":true,"parameters":["zoom","pitch","feature","feature-state","measure-light","distance-from-center"]},"property-type":"data-driven"},"name":{"type":"string"},"properties":{"type":"*"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_building","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"model-allow-density-reduction":{"type":"boolean","default":true}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{}},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","expression":{}},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-extrusion-edge-radius":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"layout_building":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"building-facade":{"type":"boolean","default":false,"expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-facade-floors":{"type":"number","minimum":1,"maximum":200,"default":3,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-unit-width":{"type":"number","minimum":1,"maximum":20,"default":3.1,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-window":{"type":"array","length":2,"value":"number","minimum":0.1,"maximum":1,"default":[0.9,0.9],"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-roof-shape":{"type":"enum","values":{"flat":1,"hipped":1,"gabled":1,"parapet":1,"mansard":1,"skillion":1,"pyramidal":1},"default":"flat","expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"building-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"building-flip-roof-orientation":{"property-type":"data-driven","type":"boolean","default":false,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","expression":{}},"line-cross-slope":{"type":"number","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","expression":{"parameters":["zoom"]}}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]}},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]}},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]}},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{"parameters":["zoom"]}},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"icon-size":{"type":"number","default":1,"minimum":0,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":[0.1,0.1],"maximum":[10,10],"expression":{}},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"appearance":true,"use-theme":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":[0.1,0.1],"maximum":[10,10],"expression":{}},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]}},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]}},"text-rotate":{"type":"number","default":0,"period":360,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_building":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*"}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"high-color":{"type":"color","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"space-color":{"type":"color","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"horizon-blend":{"type":"number","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.4,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","default":0.71,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.57,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","default":0.7,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective"}},"colorTheme":{"data":{"type":"string","expression":{}}},"indoor_source":{"sourceId":{"type":"string"},"sourceLayers":{"type":"array","value":"string"}},"indoor":{"*":{"type":"indoor_source"}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator"},"center":{"type":"array","length":2,"value":"number","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string"},"exaggeration":{"type":"number","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_building","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"flat"},"fill-extrusion-base-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"terrain"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true}},"paint_building":{"building-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"parameters":[]},"transition":true},"building-ambient-occlusion-ground-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-cast-shadows":{"type":"boolean","default":true},"building-color":{"type":"color","default":"rgba(193, 154, 127, 1)","use-theme":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-emissive-strength":{"type":"number","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-facade-emissive-chance":{"type":"number","default":0.35,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["measure-light","zoom"]}},"building-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"building-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"building-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"building-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-gradient":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["line-progress"]}},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1]},"line-trim-fade-range":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-trim-color":{"type":"color","default":"transparent","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"line-border-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"use-theme":true,"expression":{"interpolated":true,"parameters":["heatmap-density"]}},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-image-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{}},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-value"]}},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]}},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"raster-array-band":{"type":"string"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string"},"raster-particle-count":{"type":"number","default":512,"minimum":1},"raster-particle-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-particle-speed"]}},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-shadow-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-accent-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]}},"background-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]}},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]}},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]}},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"use-theme":true,"expression":{"interpolated":true,"parameters":["sky-radial-progress"]}},"sky-atmosphere-halo-color":{"type":"color","default":"white","use-theme":true},"sky-atmosphere-color":{"type":"color","default":"white","use-theme":true},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"use-theme":true,"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d"},"model-cast-shadows":{"type":"boolean","default":true},"model-receive-shadows":{"type":"boolean","default":true},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"model-front-cutoff":{"type":"array","value":"number","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]},"model-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{}}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"promoteId":{"*":{"type":"*"}}}');function Zb(l){return l instanceof Number||l instanceof String||l instanceof Boolean?l.valueOf():l}function og(l){if(Array.isArray(l))return l.map(og);if(l instanceof Object&&!(l instanceof Number||l instanceof String||l instanceof Boolean)){const i={};for(const a in l)i[a]=og(l[a]);return i}return Zb(l)}function e_(l){if(l===!0||l===!1)return!0;if(!Array.isArray(l)||l.length===0)return!1;switch(l[0]){case"has":return l.length>=2&&l[1]!=="$id"&&l[1]!=="$type";case"in":return l.length>=3&&(typeof l[1]!="string"||Array.isArray(l[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return l.length!==3||Array.isArray(l[1])||Array.isArray(l[2]);case"any":case"all":for(const i of l.slice(1))if(!e_(i)&&typeof i!="boolean")return!1;return!0;default:return!0}}function t_(l,i="",a=null,u="fill"){if(l==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};e_(l)||(l=cm(l));const p=l;let g=!0;try{g=function(I){if(!xh(I))return I;let P=og(I);return i_(P),P=Xb(P),P}(p)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(p,null,2)}
        `)}let y=null,v=null;if(u!=="background"&&u!=="sky"&&u!=="slot"){v=et[`filter_${u}`];const I=yu(g,v,i,a);if(I.result==="error")throw new Error(I.value.map(P=>`${P.key}: ${P.message}`).join(", "));y=(P,j,O)=>I.value.evaluate(P,j,{},O)}let T=null,N=null;if(g!==p){const I=yu(p,v,i,a);if(I.result==="error")throw new Error(I.value.map(P=>`${P.key}: ${P.message}`).join(", "));T=(P,j,O,L,U)=>I.value.evaluate(P,j,{},O,void 0,void 0,L,U),N=!sh(I.value.expression)}return{filter:y,dynamicFilter:T||void 0,needGeometry:r_(g),needFeature:!!N}}function Xb(l){if(!Array.isArray(l))return l;const i=function(a){if(pN.has(a[0])){for(let u=1;u<a.length;u++)if(xh(a[u]))return!0}return a}(l);return i===!0?i:i.map(a=>Xb(a))}function i_(l){let i=!1;const a=[];if(l[0]==="case"){for(let u=1;u<l.length-1;u+=2)i=i||xh(l[u]),a.push(l[u+1]);a.push(l[l.length-1])}else if(l[0]==="match"){i=i||xh(l[1]);for(let u=2;u<l.length-1;u+=2)a.push(l[u+1]);a.push(l[l.length-1])}else if(l[0]==="step"){i=i||xh(l[1]);for(let u=1;u<l.length-1;u+=2)a.push(l[u+1])}i&&(l.length=0,l.push("any",...a));for(let u=1;u<l.length;u++)i_(l[u])}function xh(l){if(!Array.isArray(l))return!1;if((i=l[0])==="pitch"||i==="distance-from-center")return!0;var i;for(let a=1;a<l.length;a++)if(xh(l[a]))return!0;return!1}const pN=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function mN(l,i){return l<i?-1:l>i?1:0}function r_(l){if(!Array.isArray(l))return!1;if(l[0]==="within"||l[0]==="distance")return!0;for(let i=1;i<l.length;i++)if(r_(l[i]))return!0;return!1}function cm(l){if(!l)return!0;const i=l[0];return l.length<=1?i!=="any":i==="=="?rc(l[1],l[2],"=="):i==="!="?lg(rc(l[1],l[2],"==")):i==="<"||i===">"||i==="<="||i===">="?rc(l[1],l[2],i):i==="any"?(a=l.slice(1),["any"].concat(a.map(cm))):i==="all"?["all"].concat(l.slice(1).map(cm)):i==="none"?["all"].concat(l.slice(1).map(cm).map(lg)):i==="in"?n_(l[1],l.slice(2)):i==="!in"?lg(n_(l[1],l.slice(2))):i==="has"?Yb(l[1]):i!=="!has"||lg(Yb(l[1]));var a}function rc(l,i,a){switch(l){case"$type":return[`filter-type-${a}`,i];case"$id":return[`filter-id-${a}`,i];default:return[`filter-${a}`,l,i]}}function n_(l,i){if(i.length===0)return!1;switch(l){case"$type":return["filter-type-in",["literal",i]];case"$id":return["filter-id-in",["literal",i]];default:return i.length>200&&!i.some(a=>typeof a!=typeof i[0])?["filter-in-large",l,["literal",i.sort(mN)]]:["filter-in-small",l,["literal",i]]}}function Yb(l){switch(l){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",l]}}function lg(l){return["!",l]}const um="";function fd(l,i){return i?`${l}${um}${i}`:l}let s_;const a_=()=>s_||(s_=new kn({"icon-size":new $t(et.layout_symbol["icon-size"]),"icon-image":new $t(et.layout_symbol["icon-image"]),"icon-rotate":new $t(et.layout_symbol["icon-rotate"]),"icon-offset":new $t(et.layout_symbol["icon-offset"]),"text-size":new $t(et.layout_symbol["text-size"]),"text-rotate":new $t(et.layout_symbol["text-rotate"]),"text-offset":new $t(et.layout_symbol["text-offset"])}));class Kb{constructor(i,a,u,p,g,y){const v=yu(i,et.appearance.condition);if(v.result==="success"&&(this.condition=v.value),this.name=a,u){this.properties=new za(a_()),this.unevaluatedLayout=new Jx(a_(),p,g,y);for(const T in u)this.unevaluatedLayout.setValue(T,u[T])}}isActive(i){return!(this.condition||!i.isHidden||this.name!=="hidden")||this.condition.evaluate(i.globals,i.feature,i.featureState,i.canonical)}getCondition(){return this.condition}getName(){return this.name}getProperty(i){return this.properties.get(i)}getUnevaluatedProperties(){return this.unevaluatedLayout}getUnevaluatedProperty(i){return this.unevaluatedLayout._values[i]}recalculate(i,a,u){this.unevaluatedLayout&&(this.properties=this.unevaluatedLayout.possiblyEvaluate(i,void 0,a,u))}serialize(){const i={};return i.condition=this.condition.expression.serialize(),this.name&&(i.name=this.name),this.unevaluatedLayout&&(i.properties=this.unevaluatedLayout.serialize()),i}hasIconProperties(){const i=this.hasProperty("icon-image"),a=this.hasProperty("icon-size"),u=this.hasProperty("icon-offset"),p=this.hasProperty("icon-rotate");return i||a||u||p}hasTextProperties(){const i=this.hasProperty("text-size"),a=this.hasProperty("text-offset"),u=this.hasProperty("text-rotate");return i||a||u}hasProperty(i){return this.getUnevaluatedProperty(i).value!==void 0}}const Qb="-transition",Jb=new Set(["fill","line","background","hillshade","raster"]);class Ba extends zo{constructor(i,a,u,p,g,y){if(super(),this.id=i.id,this.fqid=fd(this.id,u),this.type=i.type,this.scope=u,this.lut=p,this.options=g,this.iconImageUseTheme=y,this.appearances=new Array,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.expressionDependencies={isIndoorDependent:!1,configDependencies:new Set},i.type!=="custom"){if(this.metadata=i.metadata,this.minzoom=i.minzoom,this.maxzoom=i.maxzoom,i.type&&i.type!=="background"&&i.type!=="sky"&&i.type!=="slot"){this.source=i.source,this.sourceLayer=i["source-layer"],this.filter=i.filter;const v=yu(this.filter,et[`filter_${i.type}`]);v.result!=="error"&&(this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...v.value.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||v.value.isIndoorDependent)}if(i.slot&&(this.slot=i.slot),i.appearances&&this.setAppearances(i.appearances),a.layout&&(this._unevaluatedLayout=new Jx(a.layout,this.scope,g,this.iconImageUseTheme),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...this._unevaluatedLayout.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||this._unevaluatedLayout.isIndoorDependent()),a.paint){this._transitionablePaint=new gh(a.paint,this.scope,g);for(const v in i.paint)this.setPaintProperty(v,i.paint[v]);for(const v in i.layout)this.setLayoutProperty(v,i.layout[v]);this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...this._transitionablePaint.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||this._transitionablePaint.isIndoorDependent(),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new za(a.paint)}}}onAdd(i){}onRemove(i){}isDraped(i){return!this.is3D(!0)&&Jb.has(this.type)}getLayoutProperty(i){return i==="visibility"?this.visibility:this._unevaluatedLayout.getValue(i)}setLayoutProperty(i,a){if(this.type==="custom"&&i==="visibility")return void(this.visibility=a);const u=this._unevaluatedLayout;u._properties.properties[i]&&(u.setValue(i,a),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...u.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||u.isIndoorDependent(),i==="visibility"&&this.possiblyEvaluateVisibility())}setAppearances(i){this.appearances=[],i.forEach(a=>{this.appearances.push(new Kb(a.condition,a.name,a.properties,this.scope,this.options,this.iconImageUseTheme))})}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(i){return i.endsWith(Qb)?this._transitionablePaint.getTransition(i.slice(0,-11)):this._transitionablePaint.getValue(i)}isPaintProperty(i){return!!this._transitionablePaint._properties.properties[i]}setPaintProperty(i,a){const u=this._transitionablePaint,p=u._properties.properties;if(i.endsWith(Qb)){const P=i.slice(0,-11);return p[P]&&u.setTransition(P,a||void 0),!1}if(!p[i])return!1;const g=u._values[i],y=g.value.isDataDriven(),v=g.value;u.setValue(i,a),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...u.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||u.isIndoorDependent(),this._handleSpecialPaintPropertyUpdate(i);const T=u._values[i].value,N=T.isDataDriven(),I=i.endsWith("pattern")||i==="line-dasharray";return N||y||I||this._handleOverridablePaintPropertyUpdate(i,v,T)}_handleSpecialPaintPropertyUpdate(i){}getProgramIds(){return null}getDefaultProgramParams(i,a,u){return null}_handleOverridablePaintPropertyUpdate(i,a,u){return!1}isHidden(i){return!!(this.minzoom&&i<this.minzoom)||!!(this.maxzoom&&i>=this.maxzoom)||this.visibility==="none"}updateTransitions(i){this._transitioningPaint=this._transitionablePaint.transitioned(i,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(i,a){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(i,void 0,a,this.iconImageUseTheme)),this.paint=this._transitioningPaint.possiblyEvaluate(i,void 0,a)}serialize(){const i={id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.appearances.length!==0&&(i.appearances=this.appearances.map(a=>a.serialize())),wi(i,(a,u)=>!(a===void 0||u==="layout"&&!Object.keys(a).length||u==="paint"&&!Object.keys(a).length))}is3D(i){return!1}hasElevation(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}_clear(){}isStateDependent(){for(const i in this.paint._values){const a=this.paint.get(i);if(a instanceof md&&Yf(a.property.specification)&&(a.value.kind==="source"||a.value.kind==="composite")&&a.value.isStateDependent)return!0}for(const i of this.appearances)if(!Yp(i.condition.expression))return!0;return!1}compileFilter(i){this._filterCompiled||(this._featureFilter=t_(this.filter,this.scope,i),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(i){this._stats&&(i.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}getAppearances(){return this.appearances}queryRenderedFeatures(i,a,u){return{}}queryRadius(i){}queryIntersectsFeature(i,a,u,p,g,y,v,T,N,I){}}const e1={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class wu{constructor(i,a){this._structArray=i,this._pos1=a*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}const fN=new ArrayBuffer(0);class en{constructor(){this._reallocCount=0,this.capacity=0,this.length=0}static serialize(i,a){return i._trim(),a&&i.arrayBuffer&&a.add(i.arrayBuffer),{length:i.length,arrayBuffer:i.arrayBuffer}}static deserialize(i){const a=Object.create(this.prototype);return a.arrayBuffer=i.arrayBuffer,a.length=i.length,i.arrayBuffer?a.capacity=i.arrayBuffer.byteLength/a.bytesPerElement:(a.capacity=0,a.arrayBuffer=fN),a._refreshViews(),a}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(i){this.reserve(i),this.length=i}reserve(i){if(i>this.capacity){this._reallocCount++,this.capacity=Math.max(i,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const a=this.uint8;this._refreshViews(),a&&this.uint8.set(a)}}reserveForAdditional(i){this.reserve(this.length+i)}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...i){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...i){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function sr(l,i=1){let a=0,u=0;return{members:l.map(p=>{const g=e1[p.type].BYTES_PER_ELEMENT,y=a=t1(a,Math.max(i,g)),v=p.components||1;return u=Math.max(u,g),a+=g*v,{name:p.name,type:p.type,components:v,offset:y}}),size:t1(a,Math.max(u,i)),alignment:i}}function t1(l,i){return Math.ceil(l/i)*i}class Su extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(i,a){const u=this.length;return this.resize(u+1),this.emplace(u,i,a)}emplace(i,a,u){const p=2*i;return this.int16[p+0]=a,this.int16[p+1]=u,i}}Su.prototype.bytesPerElement=4,Yt(Su,"StructArrayLayout2i4");class kc extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(i,a,u){const p=this.length;return this.resize(p+1),this.emplace(p,i,a,u)}emplace(i,a,u,p){const g=3*i;return this.int16[g+0]=a,this.int16[g+1]=u,this.int16[g+2]=p,i}}kc.prototype.bytesPerElement=6,Yt(kc,"StructArrayLayout3i6");class Dc extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(i,a,u,p){const g=this.length;return this.resize(g+1),this.emplace(g,i,a,u,p)}emplace(i,a,u,p,g){const y=4*i;return this.int16[y+0]=a,this.int16[y+1]=u,this.int16[y+2]=p,this.int16[y+3]=g,i}}Dc.prototype.bytesPerElement=8,Yt(Dc,"StructArrayLayout4i8");class Qs extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i){const a=this.length;return this.resize(a+1),this.emplace(a,i)}emplace(i,a){return this.float32[1*i+0]=a,i}}Qs.prototype.bytesPerElement=4,Yt(Qs,"StructArrayLayout1f4");class _h extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,a,u){const p=this.length;return this.resize(p+1),this.emplace(p,i,a,u)}emplace(i,a,u,p){const g=4*i,y=2*i;return this.int16[g+0]=a,this.int16[g+1]=u,this.float32[y+1]=p,i}}_h.prototype.bytesPerElement=8,Yt(_h,"StructArrayLayout2i1f8");class o_ extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(i,a,u){const p=this.length;return this.resize(p+1),this.emplace(p,i,a,u)}emplace(i,a,u,p){const g=4*i;return this.int16[g+0]=a,this.int16[g+1]=u,this.int16[g+2]=p,i}}o_.prototype.bytesPerElement=8,Yt(o_,"StructArrayLayout3i8");class l_ extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(i,a,u,p,g){const y=this.length;return this.resize(y+1),this.emplace(y,i,a,u,p,g)}emplace(i,a,u,p,g,y){const v=5*i;return this.int16[v+0]=a,this.int16[v+1]=u,this.int16[v+2]=p,this.int16[v+3]=g,this.int16[v+4]=y,i}}l_.prototype.bytesPerElement=10,Yt(l_,"StructArrayLayout5i10");class c_ extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,a,u,p,g,y,v){const T=this.length;return this.resize(T+1),this.emplace(T,i,a,u,p,g,y,v)}emplace(i,a,u,p,g,y,v,T){const N=6*i,I=12*i,P=3*i;return this.int16[N+0]=a,this.int16[N+1]=u,this.uint8[I+4]=p,this.uint8[I+5]=g,this.uint8[I+6]=y,this.uint8[I+7]=v,this.float32[P+2]=T,i}}c_.prototype.bytesPerElement=12,Yt(c_,"StructArrayLayout2i4ub1f12");class pl extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,a,u){const p=this.length;return this.resize(p+1),this.emplace(p,i,a,u)}emplace(i,a,u,p){const g=3*i;return this.float32[g+0]=a,this.float32[g+1]=u,this.float32[g+2]=p,i}}pl.prototype.bytesPerElement=12,Yt(pl,"StructArrayLayout3f12");class nc extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,a,u,p,g){const y=this.length;return this.resize(y+1),this.emplace(y,i,a,u,p,g)}emplace(i,a,u,p,g,y){const v=6*i,T=3*i;return this.uint16[v+0]=a,this.uint16[v+1]=u,this.uint16[v+2]=p,this.uint16[v+3]=g,this.float32[T+2]=y,i}}nc.prototype.bytesPerElement=12,Yt(nc,"StructArrayLayout4ui1f12");class vh extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(i,a,u,p){const g=this.length;return this.resize(g+1),this.emplace(g,i,a,u,p)}emplace(i,a,u,p,g){const y=4*i;return this.uint16[y+0]=a,this.uint16[y+1]=u,this.uint16[y+2]=p,this.uint16[y+3]=g,i}}vh.prototype.bytesPerElement=8,Yt(vh,"StructArrayLayout4ui8");class bh extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(i,a,u,p,g,y){const v=this.length;return this.resize(v+1),this.emplace(v,i,a,u,p,g,y)}emplace(i,a,u,p,g,y,v){const T=6*i;return this.int16[T+0]=a,this.int16[T+1]=u,this.int16[T+2]=p,this.int16[T+3]=g,this.int16[T+4]=y,this.int16[T+5]=v,i}}bh.prototype.bytesPerElement=12,Yt(bh,"StructArrayLayout6i12");class u_ extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(i,a,u,p,g,y,v,T,N,I,P,j){const O=this.length;return this.resize(O+1),this.emplace(O,i,a,u,p,g,y,v,T,N,I,P,j)}emplace(i,a,u,p,g,y,v,T,N,I,P,j,O){const L=12*i;return this.int16[L+0]=a,this.int16[L+1]=u,this.int16[L+2]=p,this.int16[L+3]=g,this.uint16[L+4]=y,this.uint16[L+5]=v,this.uint16[L+6]=T,this.uint16[L+7]=N,this.int16[L+8]=I,this.int16[L+9]=P,this.int16[L+10]=j,this.int16[L+11]=O,i}}u_.prototype.bytesPerElement=24,Yt(u_,"StructArrayLayout4i4ui4i24");class d_ extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,a,u,p,g,y){const v=this.length;return this.resize(v+1),this.emplace(v,i,a,u,p,g,y)}emplace(i,a,u,p,g,y,v){const T=10*i,N=5*i;return this.int16[T+0]=a,this.int16[T+1]=u,this.int16[T+2]=p,this.float32[N+2]=g,this.float32[N+3]=y,this.float32[N+4]=v,i}}d_.prototype.bytesPerElement=20,Yt(d_,"StructArrayLayout3i3f20");class Tu extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,a,u,p){const g=this.length;return this.resize(g+1),this.emplace(g,i,a,u,p)}emplace(i,a,u,p,g){const y=4*i;return this.float32[y+0]=a,this.float32[y+1]=u,this.float32[y+2]=p,this.float32[y+3]=g,i}}Tu.prototype.bytesPerElement=16,Yt(Tu,"StructArrayLayout4f16");class h_ extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(i){const a=this.length;return this.resize(a+1),this.emplace(a,i)}emplace(i,a){return this.uint32[1*i+0]=a,i}}h_.prototype.bytesPerElement=4,Yt(h_,"StructArrayLayout1ul4");class qo extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(i,a){const u=this.length;return this.resize(u+1),this.emplace(u,i,a)}emplace(i,a,u){const p=2*i;return this.uint16[p+0]=a,this.uint16[p+1]=u,i}}qo.prototype.bytesPerElement=4,Yt(qo,"StructArrayLayout2ui4");class dm extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(i,a,u,p,g,y,v,T,N,I,P,j,O){const L=this.length;return this.resize(L+1),this.emplace(L,i,a,u,p,g,y,v,T,N,I,P,j,O)}emplace(i,a,u,p,g,y,v,T,N,I,P,j,O,L){const U=20*i,Z=10*i;return this.int16[U+0]=a,this.int16[U+1]=u,this.int16[U+2]=p,this.int16[U+3]=g,this.int16[U+4]=y,this.float32[Z+3]=v,this.float32[Z+4]=T,this.float32[Z+5]=N,this.float32[Z+6]=I,this.int16[U+14]=P,this.uint32[Z+8]=j,this.uint16[U+18]=O,this.uint16[U+19]=L,i}}dm.prototype.bytesPerElement=40,Yt(dm,"StructArrayLayout5i4f1i1ul2ui40");class cg extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(i,a,u,p,g,y,v){const T=this.length;return this.resize(T+1),this.emplace(T,i,a,u,p,g,y,v)}emplace(i,a,u,p,g,y,v,T){const N=8*i;return this.int16[N+0]=a,this.int16[N+1]=u,this.int16[N+2]=p,this.int16[N+4]=g,this.int16[N+5]=y,this.int16[N+6]=v,this.int16[N+7]=T,i}}cg.prototype.bytesPerElement=16,Yt(cg,"StructArrayLayout3i2i2i16");class ug extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(i,a,u,p,g){const y=this.length;return this.resize(y+1),this.emplace(y,i,a,u,p,g)}emplace(i,a,u,p,g,y){const v=4*i,T=8*i;return this.float32[v+0]=a,this.float32[v+1]=u,this.float32[v+2]=p,this.int16[T+6]=g,this.int16[T+7]=y,i}}ug.prototype.bytesPerElement=16,Yt(ug,"StructArrayLayout2f1f2i16");class dg extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,a,u,p,g,y){const v=this.length;return this.resize(v+1),this.emplace(v,i,a,u,p,g,y)}emplace(i,a,u,p,g,y,v){const T=20*i,N=5*i;return this.uint8[T+0]=a,this.uint8[T+1]=u,this.float32[N+1]=p,this.float32[N+2]=g,this.float32[N+3]=y,this.float32[N+4]=v,i}}dg.prototype.bytesPerElement=20,Yt(dg,"StructArrayLayout2ub4f20");class ys extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(i,a,u){const p=this.length;return this.resize(p+1),this.emplace(p,i,a,u)}emplace(i,a,u,p){const g=3*i;return this.uint16[g+0]=a,this.uint16[g+1]=u,this.uint16[g+2]=p,i}}ys.prototype.bytesPerElement=6,Yt(ys,"StructArrayLayout3ui6");class hm extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(i,a,u,p,g,y,v,T,N,I,P,j,O,L,U,Z,G,ee,le,me,we){const be=this.length;return this.resize(be+1),this.emplace(be,i,a,u,p,g,y,v,T,N,I,P,j,O,L,U,Z,G,ee,le,me,we)}emplace(i,a,u,p,g,y,v,T,N,I,P,j,O,L,U,Z,G,ee,le,me,we,be){const Re=30*i,Me=15*i,je=60*i;return this.int16[Re+0]=a,this.int16[Re+1]=u,this.int16[Re+2]=p,this.float32[Me+2]=g,this.float32[Me+3]=y,this.uint16[Re+8]=v,this.uint16[Re+9]=T,this.uint32[Me+5]=N,this.uint32[Me+6]=I,this.uint32[Me+7]=P,this.uint16[Re+16]=j,this.uint16[Re+17]=O,this.uint16[Re+18]=L,this.float32[Me+10]=U,this.float32[Me+11]=Z,this.uint8[je+48]=G,this.uint8[je+49]=ee,this.uint8[je+50]=le,this.uint32[Me+13]=me,this.int16[Re+28]=we,this.uint8[je+58]=be,i}}hm.prototype.bytesPerElement=60,Yt(hm,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class wh extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(i,a,u,p,g,y,v,T,N,I,P,j,O,L,U,Z,G,ee,le,me,we,be,Re,Me,je,Be,Ge,ut,lt,ct,xt,gt,yt){const st=this.length;return this.resize(st+1),this.emplace(st,i,a,u,p,g,y,v,T,N,I,P,j,O,L,U,Z,G,ee,le,me,we,be,Re,Me,je,Be,Ge,ut,lt,ct,xt,gt,yt)}emplace(i,a,u,p,g,y,v,T,N,I,P,j,O,L,U,Z,G,ee,le,me,we,be,Re,Me,je,Be,Ge,ut,lt,ct,xt,gt,yt,st){const bt=20*i,mt=40*i,Tt=80*i;return this.float32[bt+0]=a,this.float32[bt+1]=u,this.int16[mt+4]=p,this.int16[mt+5]=g,this.int16[mt+6]=y,this.int16[mt+7]=v,this.int16[mt+8]=T,this.int16[mt+9]=N,this.int16[mt+10]=I,this.int16[mt+11]=P,this.int16[mt+12]=j,this.uint16[mt+13]=O,this.uint16[mt+14]=L,this.uint16[mt+15]=U,this.uint16[mt+16]=Z,this.uint16[mt+17]=G,this.uint16[mt+18]=ee,this.uint16[mt+19]=le,this.uint16[mt+20]=me,this.uint16[mt+21]=we,this.uint16[mt+22]=be,this.uint16[mt+23]=Re,this.uint16[mt+24]=Me,this.uint16[mt+25]=je,this.uint16[mt+26]=Be,this.uint16[mt+27]=Ge,this.uint32[bt+14]=ut,this.float32[bt+15]=lt,this.float32[bt+16]=ct,this.float32[bt+17]=xt,this.float32[bt+18]=gt,this.uint8[Tt+76]=yt,this.uint16[mt+39]=st,i}}wh.prototype.bytesPerElement=80,Yt(wh,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");class hg extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,a,u,p,g,y){const v=this.length;return this.resize(v+1),this.emplace(v,i,a,u,p,g,y)}emplace(i,a,u,p,g,y,v){const T=6*i;return this.float32[T+0]=a,this.float32[T+1]=u,this.float32[T+2]=p,this.float32[T+3]=g,this.float32[T+4]=y,this.float32[T+5]=v,i}}hg.prototype.bytesPerElement=24,Yt(hg,"StructArrayLayout6f24");class gd extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,a,u,p,g){const y=this.length;return this.resize(y+1),this.emplace(y,i,a,u,p,g)}emplace(i,a,u,p,g,y){const v=5*i;return this.float32[v+0]=a,this.float32[v+1]=u,this.float32[v+2]=p,this.float32[v+3]=g,this.float32[v+4]=y,i}}gd.prototype.bytesPerElement=20,Yt(gd,"StructArrayLayout5f20");class pg extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,a,u,p,g,y,v){const T=this.length;return this.resize(T+1),this.emplace(T,i,a,u,p,g,y,v)}emplace(i,a,u,p,g,y,v,T){const N=7*i;return this.float32[N+0]=a,this.float32[N+1]=u,this.float32[N+2]=p,this.float32[N+3]=g,this.float32[N+4]=y,this.float32[N+5]=v,this.float32[N+6]=T,i}}pg.prototype.bytesPerElement=28,Yt(pg,"StructArrayLayout7f28");class p_ extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,a,u,p,g,y,v,T,N,I,P){const j=this.length;return this.resize(j+1),this.emplace(j,i,a,u,p,g,y,v,T,N,I,P)}emplace(i,a,u,p,g,y,v,T,N,I,P,j){const O=11*i;return this.float32[O+0]=a,this.float32[O+1]=u,this.float32[O+2]=p,this.float32[O+3]=g,this.float32[O+4]=y,this.float32[O+5]=v,this.float32[O+6]=T,this.float32[O+7]=N,this.float32[O+8]=I,this.float32[O+9]=P,this.float32[O+10]=j,i}}p_.prototype.bytesPerElement=44,Yt(p_,"StructArrayLayout11f44");class pm extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,a,u,p,g,y,v,T,N){const I=this.length;return this.resize(I+1),this.emplace(I,i,a,u,p,g,y,v,T,N)}emplace(i,a,u,p,g,y,v,T,N,I){const P=9*i;return this.float32[P+0]=a,this.float32[P+1]=u,this.float32[P+2]=p,this.float32[P+3]=g,this.float32[P+4]=y,this.float32[P+5]=v,this.float32[P+6]=T,this.float32[P+7]=N,this.float32[P+8]=I,i}}pm.prototype.bytesPerElement=36,Yt(pm,"StructArrayLayout9f36");class yd extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,a){const u=this.length;return this.resize(u+1),this.emplace(u,i,a)}emplace(i,a,u){const p=2*i;return this.float32[p+0]=a,this.float32[p+1]=u,i}}yd.prototype.bytesPerElement=8,Yt(yd,"StructArrayLayout2f8");class m_ extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(i,a,u,p){const g=this.length;return this.resize(g+1),this.emplace(g,i,a,u,p)}emplace(i,a,u,p,g){const y=6*i;return this.uint32[3*i+0]=a,this.uint16[y+2]=u,this.uint16[y+3]=p,this.uint16[y+4]=g,i}}m_.prototype.bytesPerElement=12,Yt(m_,"StructArrayLayout1ul3ui12");class mm extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(i){const a=this.length;return this.resize(a+1),this.emplace(a,i)}emplace(i,a){return this.uint16[1*i+0]=a,i}}mm.prototype.bytesPerElement=2,Yt(mm,"StructArrayLayout1ui2");class f_ extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,a,u,p,g,y,v,T,N,I,P,j,O,L,U,Z){const G=this.length;return this.resize(G+1),this.emplace(G,i,a,u,p,g,y,v,T,N,I,P,j,O,L,U,Z)}emplace(i,a,u,p,g,y,v,T,N,I,P,j,O,L,U,Z,G){const ee=16*i;return this.float32[ee+0]=a,this.float32[ee+1]=u,this.float32[ee+2]=p,this.float32[ee+3]=g,this.float32[ee+4]=y,this.float32[ee+5]=v,this.float32[ee+6]=T,this.float32[ee+7]=N,this.float32[ee+8]=I,this.float32[ee+9]=P,this.float32[ee+10]=j,this.float32[ee+11]=O,this.float32[ee+12]=L,this.float32[ee+13]=U,this.float32[ee+14]=Z,this.float32[ee+15]=G,i}}f_.prototype.bytesPerElement=64,Yt(f_,"StructArrayLayout16f64");class fm extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,a,u,p,g,y,v){const T=this.length;return this.resize(T+1),this.emplace(T,i,a,u,p,g,y,v)}emplace(i,a,u,p,g,y,v,T){const N=10*i,I=5*i;return this.uint16[N+0]=a,this.uint16[N+1]=u,this.uint16[N+2]=p,this.uint16[N+3]=g,this.float32[I+2]=y,this.float32[I+3]=v,this.float32[I+4]=T,i}}fm.prototype.bytesPerElement=20,Yt(fm,"StructArrayLayout4ui3f20");class g_ extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(i){const a=this.length;return this.resize(a+1),this.emplace(a,i)}emplace(i,a){return this.int16[1*i+0]=a,i}}g_.prototype.bytesPerElement=2,Yt(g_,"StructArrayLayout1i2");class mg extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(i){const a=this.length;return this.resize(a+1),this.emplace(a,i)}emplace(i,a){return this.uint8[1*i+0]=a,i}}mg.prototype.bytesPerElement=1,Yt(mg,"StructArrayLayout1ub1");class i1 extends wu{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}i1.prototype.size=40;class r1 extends dm{get(i){return new i1(this,i)}}Yt(r1,"CollisionBoxArray");class n1 extends wu{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(i){this._structArray.uint8[this._pos1+49]=i}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(i){this._structArray.uint8[this._pos1+50]=i}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(i){this._structArray.uint32[this._pos4+13]=i}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(i){this._structArray.uint8[this._pos1+58]=i}}n1.prototype.size=60;class s1 extends hm{get(i){return new n1(this,i)}}Yt(s1,"PlacedSymbolArray");class a1 extends wu{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(i){this._structArray.uint32[this._pos4+14]=i}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(i){this._structArray.float32[this._pos4+18]=i}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}}a1.prototype.size=80;class o1 extends wh{get(i){return new a1(this,i)}}Yt(o1,"SymbolInstanceArray");class gm extends Qs{getoffsetX(i){return this.float32[1*i+0]}}Yt(gm,"GlyphOffsetArray");class l1 extends Su{getx(i){return this.int16[2*i+0]}gety(i){return this.int16[2*i+1]}}Yt(l1,"SymbolLineVertexArray");class c1 extends wu{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}c1.prototype.size=12;class ym extends m_{get(i){return new c1(this,i)}}Yt(ym,"FeatureIndexArray");class u1 extends qo{geta_centroid_pos0(i){return this.uint16[2*i+0]}geta_centroid_pos1(i){return this.uint16[2*i+1]}}Yt(u1,"FillExtrusionCentroidArray");class y_ extends wu{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}y_.prototype.size=6;class d1 extends kc{get(i){return new y_(this,i)}}Yt(d1,"FillExtrusionWallArray");const h1=sr([{name:"a_pos",components:2,type:"Int16"}],4),p1=sr([{name:"a_circle_z_offset",components:1,type:"Float32"}],4),m1=sr([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class dn{constructor(i=[]){this.segments=i}_prepareSegment(i,a,u,p){let g=this.segments[this.segments.length-1];return i>dn.MAX_VERTEX_ARRAY_LENGTH&&Ni(`Max vertices per segment is ${dn.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${i}`),(!g||g.vertexLength+i>dn.MAX_VERTEX_ARRAY_LENGTH||g.sortKey!==p)&&(g={vertexOffset:a,primitiveOffset:u,vertexLength:0,primitiveLength:0},p!==void 0&&(g.sortKey=p),this.segments.push(g)),g}prepareSegment(i,a,u,p){return this._prepareSegment(i,a.length,u.length,p)}get(){return this.segments}destroy(){for(const i of this.segments)for(const a in i.vaos)i.vaos[a].destroy()}static simpleSegment(i,a,u,p){return new dn([{vertexOffset:i,primitiveOffset:a,vertexLength:u,primitiveLength:p,vaos:{},sortKey:0}])}}function f1(l,i){return 256*(l=Ie(Math.floor(l),0,255))+Ie(Math.floor(i),0,255)}dn.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Yt(dn,"SegmentVector");const g1=sr([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),gN=sr([{name:"a_pattern_b",components:4,type:"Uint16"}]),yN=sr([{name:"a_dash",components:4,type:"Uint16"}]);class xm{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(i,a,u,p){this.ids.push(y1(i)),this.positions.push(a,u,p)}eachPosition(i,a){const u=y1(i);let p=0,g=this.ids.length-1;for(;p<g;){const y=p+g>>1;this.ids[y]>=u?g=y:p=y+1}for(;this.ids[p]===u;)a(this.positions[3*p],this.positions[3*p+1],this.positions[3*p+2]),p++}static serialize(i,a){const u=new Float64Array(i.ids),p=new Uint32Array(i.positions);return x_(u,p,0,u.length-1),a&&(a.add(u.buffer),a.add(p.buffer)),{ids:u,positions:p}}static deserialize(i){const a=new xm;let u;a.ids=i.ids,a.positions=i.positions;for(const p of a.ids)p!==u&&a.uniqueIds.push(p),u=p;return a.indexed=!0,a}}function y1(l){const i=+l;return Number.isSafeInteger(i)?i:La(String(l))}function x_(l,i,a,u){for(;a<u;){const p=l[a+u>>1];let g=a-1,y=u+1;for(;;){do g++;while(l[g]<p);do y--;while(l[y]>p);if(g>=y)break;_m(l,g,y),_m(i,3*g,3*y),_m(i,3*g+1,3*y+1),_m(i,3*g+2,3*y+2)}y-a<u-y?(x_(l,i,a,y),a=y+1):(x_(l,i,y+1,u),u=y)}}function _m(l,i,a){const u=l[i];l[i]=l[a],l[a]=u}Yt(xm,"FeaturePositionMap");class Il{constructor(i){this.gl=i.gl,this.initialized=!1}fetchUniformLocation(i,a){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(i,a),this.initialized=!0),!!this.location}set(i,a,u){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class $o extends Il{constructor(i){super(i),this.current=0}set(i,a,u){this.fetchUniformLocation(i,a)&&this.current!==u&&(this.current=u,this.gl.uniform1i(this.location,u))}}class es extends Il{constructor(i){super(i),this.current=0}set(i,a,u){this.fetchUniformLocation(i,a)&&this.current!==u&&(this.current=u,this.gl.uniform1f(this.location,u))}}class Go extends Il{constructor(i){super(i),this.current=[0,0]}set(i,a,u){this.fetchUniformLocation(i,a)&&(u[0]===this.current[0]&&u[1]===this.current[1]||(this.current=u,this.gl.uniform2f(this.location,u[0],u[1])))}}class vm extends Il{constructor(i){super(i),this.current=[0,0,0]}set(i,a,u){this.fetchUniformLocation(i,a)&&(u[0]===this.current[0]&&u[1]===this.current[1]&&u[2]===this.current[2]||(this.current=u,this.gl.uniform3f(this.location,u[0],u[1],u[2])))}}class fg extends Il{constructor(i){super(i),this.current=[0,0,0,0]}set(i,a,u){this.fetchUniformLocation(i,a)&&(u[0]===this.current[0]&&u[1]===this.current[1]&&u[2]===this.current[2]&&u[3]===this.current[3]||(this.current=u,this.gl.uniform4f(this.location,u[0],u[1],u[2],u[3])))}}class x1 extends Il{constructor(i){super(i),this.current=Ar.transparent.toPremultipliedRenderColor(null)}set(i,a,u){this.fetchUniformLocation(i,a)&&(u.r===this.current.r&&u.g===this.current.g&&u.b===this.current.b&&u.a===this.current.a||(this.current=u,this.gl.uniform4f(this.location,u.r,u.g,u.b,u.a)))}}const xN=new Float32Array(16);class Sh extends Il{constructor(i){super(i),this.current=xN}set(i,a,u){if(this.fetchUniformLocation(i,a)){if(u[12]!==this.current[12]||u[0]!==this.current[0])return this.current=u,void this.gl.uniformMatrix4fv(this.location,!1,u);for(let p=1;p<16;p++)if(u[p]!==this.current[p]){this.current=u,this.gl.uniformMatrix4fv(this.location,!1,u);break}}}}const tR=new Float32Array(9),m=new Float32Array(4);class s extends Il{constructor(i){super(i),this.current=m}set(i,a,u){if(this.fetchUniformLocation(i,a)){for(let p=0;p<4;p++)if(u[p]!==this.current[p]){this.current=u,this.gl.uniformMatrix2fv(this.location,!1,u);break}}}}function d(l){return[f1(255*l.r,255*l.g),f1(255*l.b,255*l.a)]}function f(l,i,a,u,p,g,y,v){return!!l&&(l.kind==="composite"||l.kind==="source"?l.evaluate(new Vr(0,{brightness:g,worldview:v}),i,a,p,u,y)==="none":l.value==="none")}class _{constructor(i,a,u,p){this.value=i,this.uniformNames=a.map(g=>`u_${g}`),this.type=u,this.context=p}setUniform(i,a,u,p,g){const y=p.constantOr(this.value);a.set(i,g,y instanceof Ar?y.toPremultipliedRenderColor(this.lutExpression&&this.lutExpression.kind==="constant"&&this.lutExpression.value==="none"?null:this.context.lut):y)}getBinding(i,a){return this.type==="color"?new x1(i):new es(i)}}class b{constructor(i,a){this.uniformNames=a.map(u=>`u_${u}`),this.pattern=null,this.patternTransition=null,this.pixelRatio=1}setConstantPatternPositions(i,a){this.pixelRatio=i.pixelRatio||1,this.pattern=i.tl.concat(i.br),this.patternTransition=a?a.tl.concat(a.br):this.pattern}setUniform(i,a,u,p,g){let y=null;g!=="u_pattern"&&g!=="u_dash"||(y=this.pattern),g==="u_pattern_b"&&(y=this.patternTransition),g==="u_pixel_ratio"&&(y=this.pixelRatio),y&&a.set(i,g,y)}getBinding(i,a){return a==="u_pattern"||a==="u_pattern_b"||a==="u_dash"?new fg(i):new es(i)}}class S{constructor(i,a,u,p){this.expression=i,this.type=u,this.maxValue=0,this.paintVertexAttributes=a.map(g=>({name:`a_${g}`,type:"Float32",components:u==="color"?2:1,offset:0})),this.paintVertexArray=new p}populatePaintArray(i,a,u,p,g,y,v,T){const N=this.paintVertexArray.length,I=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate(new Vr(0,{brightness:y,worldview:T}),a,{},g,p,v):this.expression.kind==="constant"&&this.expression.value,P=f(this.lutExpression,a,{},p,g,y,v,T);this.paintVertexArray.resize(i),this._setPaintValue(N,i,I,P?null:this.context.lut)}updatePaintArray(i,a,u,p,g,y,v,T){const N=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate({zoom:0,brightness:v,worldview:T},u,p,void 0,g):this.expression.kind==="constant"&&this.expression.value,I=f(this.lutExpression,u,p,g,void 0,v,void 0,T);this._setPaintValue(i,a,N,I?null:this.context.lut)}_setPaintValue(i,a,u,p){if(this.type==="color"){const g=d(u.toPremultipliedRenderColor(p));for(let y=i;y<a;y++)this.paintVertexArray.emplace(y,g[0],g[1])}else{for(let g=i;g<a;g++)this.paintVertexArray.emplace(g,u);this.maxValue=Math.max(this.maxValue,Math.abs(u))}}upload(i){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=i.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&this.lutExpression.kind!=="constant"&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||this.expression.kind!=="constant"&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class A{constructor(i,a,u,p,g,y){this.expression=i,this.uniformNames=a.map(v=>`u_${v}_t`),this.type=u,this.useIntegerZoom=p,this.context=g,this.maxValue=0,this.paintVertexAttributes=a.map(v=>({name:`a_${v}`,type:"Float32",components:u==="color"?4:2,offset:0})),this.paintVertexArray=new y}populatePaintArray(i,a,u,p,g,y,v,T){const N=this.expression.evaluate(new Vr(this.context.zoom,{brightness:y,worldview:T}),a,{},g,p,v),I=this.expression.evaluate(new Vr(this.context.zoom+1,{brightness:y,worldview:T}),a,{},g,p,v),P=f(this.lutExpression,a,{},p,g,y,v,T),j=this.paintVertexArray.length;this.paintVertexArray.resize(i),this._setPaintValue(j,i,N,I,P?null:this.context.lut)}updatePaintArray(i,a,u,p,g,y,v,T){const N=this.expression.evaluate({zoom:this.context.zoom,brightness:v,worldview:T},u,p,void 0,g),I=this.expression.evaluate({zoom:this.context.zoom+1,brightness:v,worldview:T},u,p,void 0,g),P=f(this.lutExpression,u,p,g,void 0,v,void 0,T);this._setPaintValue(i,a,N,I,P?null:this.context.lut)}_setPaintValue(i,a,u,p,g){if(this.type==="color"){const y=d(u.toPremultipliedRenderColor(g)),v=d(p.toPremultipliedRenderColor(g));for(let T=i;T<a;T++)this.paintVertexArray.emplace(T,y[0],y[1],v[0],v[1])}else{for(let y=i;y<a;y++)this.paintVertexArray.emplace(y,u,p);this.maxValue=Math.max(this.maxValue,Math.abs(u),Math.abs(p))}}upload(i){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=i.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(i,a,u,p,g){const y=this.useIntegerZoom?Math.floor(u.zoom):u.zoom,v=Ie(this.expression.interpolationFactor(y,this.context.zoom,this.context.zoom+1),0,1);a.set(i,g,v)}getBinding(i,a){return new es(i)}}class E{constructor(i,a,u,p,g){this.expression=i,this.layerId=g,this.paintVertexAttributes=(u==="array"?yN:g1).members;for(let y=0;y<a.length;++y);this.paintVertexArray=new p,this.paintTransitionVertexArray=new vh}populatePaintArray(i,a,u,p){const g=this.paintVertexArray.length;this.paintVertexArray.resize(i),this._setPaintValues(g,i,a.patterns&&a.patterns[this.layerId],u)}updatePaintArray(i,a,u,p,g,y,v){this._setPaintValues(i,a,u.patterns&&u.patterns[this.layerId],y)}_setPaintValues(i,a,u,p){if(!p||!u)return;const g=p[u[0]],y=p[u[1]];if(g){if(g){const{tl:v,br:T,pixelRatio:N}=g;for(let I=i;I<a;I++)this.paintVertexArray.emplace(I,v[0],v[1],T[0],T[1],N)}if(y){this.paintTransitionVertexArray.resize(this.paintVertexArray.length);const{tl:v,br:T}=y;for(let N=i;N<a;N++)this.paintTransitionVertexArray.emplace(N,v[0],v[1],T[0],T[1])}}}upload(i){const a=this.expression.isStateDependent||!this.expression.isLightConstant;this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=i.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,a)),this.paintTransitionVertexArray&&this.paintTransitionVertexArray.length&&(this.paintTransitionVertexBuffer=i.createVertexBuffer(this.paintTransitionVertexArray,gN.members,a))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy(),this.paintTransitionVertexBuffer&&this.paintTransitionVertexBuffer.destroy()}}class D{constructor(i,a,u=()=>!0){this.binders={},this._buffers=[],this.context=a;const p=[];for(const g in i.paint._values){const y=i.paint.get(g);if(g.endsWith("-use-theme")||!u(g)||!(y instanceof md&&Yf(y.property.specification)))continue;const v=z(g,i.type),T=y.value,N=y.property.specification.type,I=!!y.property.useIntegerZoom,P=g==="line-dasharray"||g.endsWith("pattern"),j=i.paint.get(`${g}-use-theme`),O=g==="line-dasharray"&&i.layout.get("line-cap").value.kind!=="constant"||j&&j.value.kind!=="constant";if(T.kind!=="constant"||O)if(T.kind==="source"||O||P){const L=W(g,N,"source");this.binders[g]=P?new E(T,v,N,L,i.id):new S(T,v,N,L),p.push(`/a_${g}`)}else{const L=W(g,N,"composite");this.binders[g]=new A(T,v,N,I,a,L),p.push(`/z_${g}`)}else this.binders[g]=P?new b(T.value,v):new _(T.value,v,N,a),p.push(`/u_${g}`);j&&(this.binders[g].lutExpression=j.value)}this.cacheKey=p.sort().join("")}getMaxValue(i){const a=this.binders[i];return a instanceof S||a instanceof A?a.maxValue:0}populatePaintArrays(i,a,u,p,g,y,v,T){for(const N in this.binders){const I=this.binders[N];I.context=this.context,(I instanceof S||I instanceof A||I instanceof E)&&I.populatePaintArray(i,a,u,p,g,y,v,T)}}setConstantPatternPositions(i,a){for(const u in this.binders){const p=this.binders[u];p instanceof b&&p.setConstantPatternPositions(i,a)}}getPatternTransitionVertexBuffer(i){const a=this.binders[i];return a instanceof E?a.paintTransitionVertexBuffer:null}updatePaintArrays(i,a,u,p,g,y,v,T,N,I){let P=!1;const j=Object.keys(i),O=j.length!==0&&!T,L=O?j:a.uniqueIds;this.context.lut=g.lut;for(const U in this.binders){const Z=this.binders[U];if(Z.context=this.context,(Z instanceof S||Z instanceof A||Z instanceof E)&&Z.expression&&Z.expression.kind&&Z.expression.kind!=="constant"&&(Z.expression.isStateDependent===!0||Z.expression.isLightConstant===!1)){const G=g.paint.get(U);Z.expression=G.value;for(const ee of L){const le=i[ee.toString()];a.eachPosition(ee,(me,we,be)=>{const Re=p.feature(me);Z.updatePaintArray(we,be,Re,le,y,v,N,I)})}if(!O)for(const ee of u.uniqueIds){const le=i[ee.toString()];u.eachPosition(ee,(me,we,be)=>{const Re=p.feature(me);Z.updatePaintArray(we,be,Re,le,y,v,N,I)})}P=!0}}return P}defines(){const i=[];for(const a in this.binders){const u=this.binders[a];(u instanceof _||u instanceof b)&&i.push(...u.uniformNames.map(p=>`#define HAS_UNIFORM_${p}`))}return i}getPaintVertexBuffers(){return this._buffers}getUniforms(i){const a=[];for(const u in this.binders){const p=this.binders[u];if(p instanceof _||p instanceof b||p instanceof A)for(const g of p.uniformNames)a.push({name:g,property:u,binding:p.getBinding(i,g)})}return a}setUniforms(i,a,u,p,g){for(const{name:y,property:v,binding:T}of u)this.binders[v].setUniform(i,T,g,p.get(v),y)}updatePaintBuffers(){this._buffers=[];for(const i in this.binders){const a=this.binders[i];(a instanceof S||a instanceof A||a instanceof E)&&a.paintVertexBuffer&&this._buffers.push(a.paintVertexBuffer),a instanceof E&&a.paintTransitionVertexBuffer&&this._buffers.push(a.paintTransitionVertexBuffer)}}upload(i){for(const a in this.binders){const u=this.binders[a];(u instanceof S||u instanceof A||u instanceof E)&&u.upload(i)}this.updatePaintBuffers()}destroy(){for(const i in this.binders){const a=this.binders[i];(a instanceof S||a instanceof A||a instanceof E)&&a.destroy()}}}class M{constructor(i,a,u=()=>!0){this.programConfigurations={};for(const p of i)this.programConfigurations[p.id]=new D(p,a,u);this.needsUpload=!1,this._featureMap=new xm,this._featureMapWithoutIds=new xm,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(i,a,u,p,g,y,v,T,N){for(const I in this.programConfigurations)this.programConfigurations[I].populatePaintArrays(i,a,p,g,y,v,T,N);a.id!==void 0?this._featureMap.add(a.id,u,this._bufferOffset,i):(this._featureMapWithoutIds.add(this._idlessCounter,u,this._bufferOffset,i),this._idlessCounter+=1),this._bufferOffset=i,this.needsUpload=!0}updatePaintArrays(i,a,u,p,g,y,v,T){for(const N of u)this.needsUpload=this.programConfigurations[N.id].updatePaintArrays(i,this._featureMap,this._featureMapWithoutIds,a,N,p,g,y,v||0,T)||this.needsUpload}get(i){return this.programConfigurations[i]}upload(i){if(this.needsUpload){for(const a in this.programConfigurations)this.programConfigurations[a].upload(i);this.needsUpload=!1}}destroy(){for(const i in this.programConfigurations)this.programConfigurations[i].destroy()}}const B={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio","pattern_b"],"fill-pattern":["pattern","pixel_ratio","pattern_b"],"fill-extrusion-pattern":["pattern","pixel_ratio","pattern_b"],"line-dasharray":["dash"],"fill-bridge-guard-rail-color":["structure_color"],"fill-tunnel-structure-color":["structure_color"]};function z(l,i){return B[l]||[l.replace(`${i}-`,"").replace(/-/g,"_")]}const V={"line-pattern":{source:nc,composite:nc},"fill-pattern":{source:nc,composite:nc},"fill-extrusion-pattern":{source:nc,composite:nc},"line-dasharray":{source:vh,composite:vh}},Q={color:{source:yd,composite:Tu},number:{source:Qs,composite:yd}};function W(l,i,a){const u=V[l];return u&&u[a]||Q[i][a]}Yt(_,"ConstantBinder"),Yt(b,"PatternConstantBinder"),Yt(S,"SourceExpressionBinder"),Yt(E,"PatternCompositeBinder"),Yt(A,"CompositeExpressionBinder"),Yt(D,"ProgramConfiguration",{omit:["_buffers"]}),Yt(M,"ProgramConfigurationSet");const J=Bt/Math.PI/2,ce=64,_e=[ce,32,16],xe=-J,fe=J;function Fe(l,i,a,u=J){return a=Zi(a),[l*Math.sin(a)*u,-i*u,l*Math.cos(a)*u]}function De(l,i,a){return Fe(Math.cos(Zi(l)),Math.sin(Zi(l)),i,a)}const Oe=63710088e-1,Ee=2*Math.PI*Oe;class Se{constructor(i,a){if(isNaN(i)||isNaN(a))throw new Error(`Invalid LngLat object: (${i}, ${a})`);if(this.lng=+i,this.lat=+a,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Se(Je(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(i){const a=Math.PI/180,u=this.lat*a,p=i.lat*a,g=Math.sin(u)*Math.sin(p)+Math.cos(u)*Math.cos(p)*Math.cos((i.lng-this.lng)*a);return Oe*Math.acos(Math.min(g,1))}toBounds(i=0){const a=360*i/40075017,u=a/Math.cos(Math.PI/180*this.lat);return new qe({lng:this.lng-u,lat:this.lat-a},{lng:this.lng+u,lat:this.lat+a})}toEcef(i){return De(this.lat,this.lng,J+i*J/Oe)}static convert(i){if(i instanceof Se)return i;if(Array.isArray(i)&&(i.length===2||i.length===3))return new Se(Number(i[0]),Number(i[1]));if(!Array.isArray(i)&&typeof i=="object"&&i!==null)return new Se(Number("lng"in i?i.lng:i.lon),Number(i.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class qe{constructor(i,a){i&&(a?this.setSouthWest(i).setNorthEast(a):Array.isArray(i)&&i.length===4?this.setSouthWest([i[0],i[1]]).setNorthEast([i[2],i[3]]):this.setSouthWest(i[0]).setNorthEast(i[1]))}setNorthEast(i){return this._ne=i instanceof Se?new Se(i.lng,i.lat):Se.convert(i),this}setSouthWest(i){return this._sw=i instanceof Se?new Se(i.lng,i.lat):Se.convert(i),this}extend(i){const a=this._sw,u=this._ne;let p,g;if(i instanceof Se)p=i,g=i;else{if(!(i instanceof qe))return Array.isArray(i)?i.length===4||i.every(Array.isArray)?this.extend(qe.convert(i)):this.extend(Se.convert(i)):typeof i=="object"&&i!==null&&i.hasOwnProperty("lat")&&(i.hasOwnProperty("lon")||i.hasOwnProperty("lng"))?this.extend(Se.convert(i)):this;if(p=i._sw,g=i._ne,!p||!g)return this}return a||u?(a.lng=Math.min(p.lng,a.lng),a.lat=Math.min(p.lat,a.lat),u.lng=Math.max(g.lng,u.lng),u.lat=Math.max(g.lat,u.lat)):(this._sw=new Se(p.lng,p.lat),this._ne=new Se(g.lng,g.lat)),this}getCenter(){return new Se((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new Se(this.getWest(),this.getNorth())}getSouthEast(){return new Se(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(i){const{lng:a,lat:u}=Se.convert(i);let p=this._sw.lng<=a&&a<=this._ne.lng;return this._sw.lng>this._ne.lng&&(p=this._sw.lng>=a&&a>=this._ne.lng),this._sw.lat<=u&&u<=this._ne.lat&&p}static convert(i){if(i)return i instanceof qe?i:new qe(i)}}function Ye(l){return Ee*Math.cos(l*Math.PI/180)}function Qe(l){return(180+l)/360}function at(l){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+l*Math.PI/360)))/360}function nt(l,i){return l/Ye(i)}function ft(l){return 360*l-180}function Nt(l){return 360/Math.PI*Math.atan(Math.exp((180-360*l)*Math.PI/180))-90}function rt(l,i){return l*Ye(Nt(i))}const $e=85.051129;function dt(l){return Math.cos(Zi(Ie(l,-85.051129,$e)))}function ot(l,i){const a=Ie(i,0,25.5),u=Math.pow(2,a);return dt(l)*Ee/(512*u)}function Ct(l){return 1/Math.cos(l*Math.PI/180)}function Rt(l,i=0){const a=Math.exp(Math.PI*(1-(l.y+i/Bt)/(1<<l.z)*2));return 80150034*a/(a*a+1)/Bt/(1<<l.z)}class Ut{constructor(i,a,u=0){this.x=+i,this.y=+a,this.z=+u}static fromLngLat(i,a=0){const u=Se.convert(i);return new Ut(Qe(u.lng),at(u.lat),nt(a,u.lat))}toLngLat(){return new Se(ft(this.x),Nt(this.y))}toAltitude(){return rt(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/Ee*Ct(Nt(this.y))}}function kt(l,i,a,u,p,g,y,v,T){const N=(i+u)/2,I=(a+p)/2,P=new wt(N,I);v(P),function(j,O,L,U,Z,G){const ee=L-Z,le=U-G;return Math.abs((U-O)*ee-(L-j)*le)/Math.hypot(ee,le)}(P.x,P.y,g.x,g.y,y.x,y.y)>=T?(kt(l,i,a,N,I,g,P,v,T),kt(l,N,I,u,p,P,y,v,T)):l.push(y)}function Mt(l,i,a){let u=l[0],p=u.x,g=u.y;i(u);const y=[u];for(let v=1;v<l.length;v++){const T=l[v],{x:N,y:I}=T;i(T),kt(y,p,g,N,I,u,T,i,a),p=N,g=I,u=T}return y}function ei(l,i,a,u){if(u(i,a)){const p=i.add(a)._mult(.5);ei(l,i,p,u),ei(l,p,a,u)}else l.push(a)}function Qt(l,i){let a=l[0];const u=[a];for(let p=1;p<l.length;p++){const g=l[p];ei(u,a,g,i),a=g}return u}const Wt=Math.pow(2,14)-1,Kt=-Wt-1;function gi(l,i){const a=Math.round(l.x*i),u=Math.round(l.y*i);return l.x=Ie(a,Kt,Wt),l.y=Ie(u,Kt,Wt),(a<l.x||a>l.x+1||u<l.y||u>l.y+1)&&Ni("Geometry exceeds allowed extent, reduce your vector tile buffer size"),l}function Ci(l,i,a){const u=l.loadGeometry(),p=l.extent,g=Bt/p;if(i&&a&&a.projection.isReprojectedInTileSpace){const y=1<<i.z,{scale:v,x:T,y:N,projection:I}=a,P=j=>{const O=ft((i.x+j.x/p)/y),L=Nt((i.y+j.y/p)/y),U=I.project(O,L);j.x=(U.x*v-T)*p,j.y=(U.y*v-N)*p};for(let j=0;j<u.length;j++)if(l.type!==1)u[j]=Mt(u[j],P,1);else{const O=[];for(const L of u[j])L.x<0||L.x>=p||L.y<0||L.y>=p||(P(L),O.push(L));u[j]=O}}for(const y of u)for(const v of y)gi(v,g);return u}function Hi(l,i){return{type:l.type,id:l.id,properties:l.properties,geometry:i?Ci(l):[]}}class lr{constructor(i,a,u,p,g){this.properties={},this.extent=u,this.type=0,this.id=void 0,this._pbf=i,this._geometry=-1,this._keys=p,this._values=g,i.readFields(ki,this,a)}loadGeometry(){const i=this._pbf;i.pos=this._geometry;const a=i.readVarint()+i.pos,u=[];let p,g=1,y=0,v=0,T=0;for(;i.pos<a;){if(y<=0){const N=i.readVarint();g=7&N,y=N>>3}if(y--,g===1||g===2)v+=i.readSVarint(),T+=i.readSVarint(),g===1&&(p&&u.push(p),p=[]),p&&p.push(new wt(v,T));else{if(g!==7)throw new Error(`unknown command ${g}`);p&&p.push(p[0].clone())}}return p&&u.push(p),u}bbox(){const i=this._pbf;i.pos=this._geometry;const a=i.readVarint()+i.pos;let u=1,p=0,g=0,y=0,v=1/0,T=-1/0,N=1/0,I=-1/0;for(;i.pos<a;){if(p<=0){const P=i.readVarint();u=7&P,p=P>>3}if(p--,u===1||u===2)g+=i.readSVarint(),y+=i.readSVarint(),g<v&&(v=g),g>T&&(T=g),y<N&&(N=y),y>I&&(I=y);else if(u!==7)throw new Error(`unknown command ${u}`)}return[v,N,T,I]}toGeoJSON(i,a,u){const p=this.extent*Math.pow(2,u),g=this.extent*i,y=this.extent*a,v=this.loadGeometry();function T(j){return[360*(j.x+g)/p-180,360/Math.PI*Math.atan(Math.exp((1-2*(j.y+y)/p)*Math.PI))-90]}function N(j){return j.map(T)}let I;if(this.type===1){const j=[];for(const L of v)j.push(L[0]);const O=N(j);I=j.length===1?{type:"Point",coordinates:O[0]}:{type:"MultiPoint",coordinates:O}}else if(this.type===2){const j=v.map(N);I=j.length===1?{type:"LineString",coordinates:j[0]}:{type:"MultiLineString",coordinates:j}}else{if(this.type!==3)throw new Error("unknown feature type");{const j=function(L){const U=L.length;if(U<=1)return[L];const Z=[];let G,ee;for(let le=0;le<U;le++){const me=yr(L[le]);me!==0&&(ee===void 0&&(ee=me<0),ee===me<0?(G&&Z.push(G),G=[L[le]]):G&&G.push(L[le]))}return G&&Z.push(G),Z}(v),O=[];for(const L of j)O.push(L.map(N));I=O.length===1?{type:"Polygon",coordinates:O[0]}:{type:"MultiPolygon",coordinates:O}}}const P={type:"Feature",geometry:I,properties:this.properties};return this.id!=null&&(P.id=this.id),P}}function ki(l,i,a){l===1?i.id=a.readVarint():l===2?function(u,p){const g=u.readVarint()+u.pos;for(;u.pos<g;){const y=p._keys[u.readVarint()],v=p._values[u.readVarint()];p.properties[y]=v}}(a,i):l===3?i.type=a.readVarint():l===4&&(i._geometry=a.pos)}function yr(l){let i=0;for(let a,u,p=0,g=l.length,y=g-1;p<g;y=p++)a=l[p],u=l[y],i+=(u.x-a.x)*(a.y+u.y);return i}lr.types=["Unknown","Point","LineString","Polygon"];class Li{constructor(i,a){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=i,this._keys=[],this._values=[],this._features=[],i.readFields(Dr,this,a),this.length=this._features.length}feature(i){if(i<0||i>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[i];const a=this._pbf.readVarint()+this._pbf.pos;return new lr(this._pbf,a,this.extent,this._keys,this._values)}}function Dr(l,i,a){l===15?i.version=a.readVarint():l===1?i.name=a.readString():l===5?i.extent=a.readVarint():l===2?i._features.push(a.pos):l===3?i._keys.push(a.readString()):l===4&&i._values.push(function(u){let p=null;const g=u.readVarint()+u.pos;for(;u.pos<g;){const y=u.readVarint()>>3;p=y===1?u.readString():y===2?u.readFloat():y===3?u.readDouble():y===4?u.readVarint64():y===5?u.readVarint():y===6?u.readSVarint():y===7?u.readBoolean():null}if(p==null)throw new Error("unknown feature value");return p}(a))}class Rr{constructor(i,a){this.layers=i.readFields(Fr,{},a)}}function Fr(l,i,a){if(l===3){const u=new Li(a,a.readVarint()+a.pos);u.length&&(i[u.name]=u)}}const ur="3d_elevation_id",Ui="level";class Ir{constructor(){this._valid=!1}reset(i){return this.feature=i,this._valid=!0,this._geometry=i.loadGeometry(),this._geometry.length!==0&&this._geometry[0].length!==0||(this._valid=!1),this}geometry(i,a){return this._valid&&i(a(this._geometry)),this}require(i,a,u){return this.get(i,!0,a,u)}optional(i,a,u){return this.get(i,!1,a,u)}success(){return this._valid}get(i,a,u,p){const g=this.feature.properties.hasOwnProperty(i)?+this.feature.properties[i]:void 0;return this._valid&&g!==void 0&&!Number.isNaN(g)?u(p?p(g):g):a&&(this._valid=!1),this}}class hn{constructor(i,a){this.featureFunc=i,this.vertexFunc=a}parseFeature(i,a,u){return this.featureFunc(i,a,u)}parseVertex(i,a,u){return this.vertexFunc(i,a,u)}}const pn=new hn((l,i,a)=>l.reset(i).require(ur,u=>{a.id=u}).optional("fixed_height_relative",u=>{a.constantHeight=u},rr.decodeRelativeHeight).geometry(u=>{a.bounds=u},Wp).success(),(l,i,a)=>l.reset(i).require(ur,u=>{a.id=u}).require("elevation_idx",u=>{a.idx=u}).require("extent",u=>{a.extent=u}).require("height_relative",u=>{a.height=u},rr.decodeRelativeHeight).geometry(u=>{a.position=u},rr.getPoint).success()),Pr=new hn((l,i,a)=>l.reset(i).require(ur,u=>{a.id=u}).optional("fixed_height",u=>{a.constantHeight=u},rr.decodeMetricHeight).geometry(u=>{a.bounds=u},Wp).success(),(l,i,a)=>l.reset(i).require(ur,u=>{a.id=u}).require("elevation_idx",u=>{a.idx=u}).require("extent",u=>{a.extent=u}).require("height",u=>{a.height=u},rr.decodeMetricHeight).geometry(u=>{a.position=u},rr.getPoint).success());class rr{static getPoint(i){return Da(i[0][0].x,i[0][0].y)}static decodeRelativeHeight(i){return 1e-4*i*5}static decodeMetricHeight(i){return 1e-4*i}static getVersionSchema(i){return i?i==="1.0.1"?Pr:void 0:pn}static parse(i){const a=[],u=[],p=i.length,g=new Ir;for(let y=0;y<p;y++){const v=i.feature(y),T=v.properties.version,N=rr.getVersionSchema(T);if(N===void 0){Ni(`Unknown elevation feature version number ${T||"(unknown)"}`);continue}const I=v.properties.type;if(!I)continue;const P=lr.types[v.type];if(P==="Point"&&I==="curve_point"){const j={};N.parseVertex(g,v,j)&&a.push(j)}else if(P==="Polygon"&&I==="curve_meta"){const j={};N.parseFeature(g,v,j)&&u.push(j)}}return{vertices:a,features:u}}}class Gi{constructor(i,a){this.pos=i,this.dir=a}intersectsPlane(i,a,u){const p=mr(a,this.dir);if(Math.abs(p)<1e-6)return!1;const g=((i[0]-this.pos[0])*a[0]+(i[1]-this.pos[1])*a[1])/p;return u[0]=this.pos[0]+this.dir[0]*g,u[1]=this.pos[1]+this.dir[1]*g,!0}}class Zr{constructor(i,a){this.pos=i,this.dir=a}intersectsPlane(i,a,u){const p=ui(a,this.dir);if(Math.abs(p)<1e-6)return!1;const g=((i[0]-this.pos[0])*a[0]+(i[1]-this.pos[1])*a[1]+(i[2]-this.pos[2])*a[2])/p;return u[0]=this.pos[0]+this.dir[0]*g,u[1]=this.pos[1]+this.dir[1]*g,u[2]=this.pos[2]+this.dir[2]*g,!0}closestPointOnSphere(i,a,u){if(function(O,L){var U=O[0],Z=O[1],G=O[2],ee=L[0],le=L[1],me=L[2];return Math.abs(U-ee)<=C*Math.max(1,Math.abs(U),Math.abs(ee))&&Math.abs(Z-le)<=C*Math.max(1,Math.abs(Z),Math.abs(le))&&Math.abs(G-me)<=C*Math.max(1,Math.abs(G),Math.abs(me))}(this.pos,i)||a===0)return u[0]=u[1]=u[2]=0,!1;const[p,g,y]=this.dir,v=this.pos[0]-i[0],T=this.pos[1]-i[1],N=this.pos[2]-i[2],I=p*p+g*g+y*y,P=2*(v*p+T*g+N*y),j=P*P-4*I*(v*v+T*T+N*N-a*a);if(j<0){const O=Math.max(-P/2,0),L=v+p*O,U=T+g*O,Z=N+y*O,G=Math.hypot(L,U,Z);return u[0]=L*a/G,u[1]=U*a/G,u[2]=Z*a/G,!1}{const O=(-P-Math.sqrt(j))/(2*I);if(O<0){const L=Math.hypot(v,T,N);return u[0]=v*a/L,u[1]=T*a/L,u[2]=N*a/L,!1}return u[0]=v+p*O,u[1]=T+g*O,u[2]=N+y*O,!0}}}class Dn{constructor(i,a,u,p,g){this.TL=i,this.TR=a,this.BR=u,this.BL=p,this.horizon=g}static fromInvProjectionMatrix(i,a,u){const p=[-1,1,1],g=[1,1,1],y=[1,-1,1],v=[-1,-1,1],T=Bi(p,p,i),N=Bi(g,g,i),I=Bi(y,y,i),P=Bi(v,v,i);return new Dn(T,N,I,P,a/u)}}function Kr(l,i,a){let u=1/0,p=-1/0;const g=[];for(const y of l){Tr(g,y,i);const v=ui(g,a);u=Math.min(u,v),p=Math.max(p,v)}return[u,p]}function tn(l,i){let a=!0;for(let u=0;u<l.planes.length;u++){const p=l.planes[u];let g=0;for(let y=0;y<i.length;y++)g+=+(ui(p,i[y])+p[3]>=0);if(g===0)return 0;g!==i.length&&(a=!1)}return a?2:1}function Va(l,i){for(const a of l.projections){const u=Kr(i,l.points[0],a.axis);if(a.projection[1]<u[0]||a.projection[0]>u[1])return 0}return 1}function ro(l,i){let a=0;const u=[0,0,0,0];for(let p=0;p<l.length;p++)u[0]=l[p][0],u[1]=l[p][1],u[2]=l[p][2],u[3]=1,Jt(u,i)>=0&&a++;return a}class Fs{constructor(i,a){this.points=i||new Array(8).fill([0,0,0]),this.planes=a||new Array(6).fill([0,0,0,0]),this.bounds=jr.fromPoints(this.points),this.projections=[],this.frustumEdges=[Tr([],this.points[2],this.points[3]),Tr([],this.points[0],this.points[3]),Tr([],this.points[4],this.points[0]),Tr([],this.points[5],this.points[1]),Tr([],this.points[6],this.points[2]),Tr([],this.points[7],this.points[3])];for(const u of this.frustumEdges){const p=[0,-u[2],u[1]],g=[u[2],0,-u[0]];this.projections.push({axis:p,projection:Kr(this.points,this.points[0],p)}),this.projections.push({axis:g,projection:Kr(this.points,this.points[0],g)})}}static fromInvProjectionMatrix(i,a,u,p){const g=Math.pow(2,u),y=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(N=>{const I=Vi([],N,i),P=1/I[3]/a*g;return(j=I)[0]=(O=I)[0]*(L=[P,P,p?1/I[3]:P,P])[0],j[1]=O[1]*L[1],j[2]=O[2]*L[2],j[3]=O[3]*L[3],j;var j,O,L}),v=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(N=>{const I=ni([],Fi([],Tr([],y[N[0]],y[N[1]]),Tr([],y[N[2]],y[N[1]]))),P=-ui(I,y[N[1]]);return I.concat(P)}),T=[];for(let N=0;N<y.length;N++)T.push([y[N][0],y[N][1],y[N][2]]);return new Fs(T,v)}intersectsPrecise(i,a,u){for(let p=0;p<a.length;p++)if(!ro(i,a[p]))return 0;for(let p=0;p<this.planes.length;p++)if(!ro(i,this.planes[p]))return 0;for(const p of u)for(const g of this.frustumEdges){const y=Fi([],p,g),v=ve(y);if(v===0)continue;Ot(y,y,1/v);const T=Kr(this.points,this.points[0],y),N=Kr(i,this.points[0],y);if(T[0]>N[1]||N[0]>T[1])return 0}return 1}containsPoint(i){for(const a of this.planes){const u=a[3];if(ui([a[0],a[1],a[2]],i)+u<0)return!1}return!0}}class jr{static fromPoints(i){const a=[1/0,1/0,1/0],u=[-1/0,-1/0,-1/0];for(const p of i)zt(a,a,p),vt(u,u,p);return new jr(a,u)}static fromTileIdAndHeight(i,a,u){const p=1<<i.canonical.z,g=i.canonical.x,y=i.canonical.y;return new jr([g/p,y/p,a],[(g+1)/p,(y+1)/p,u])}static applyTransform(i,a){const u=i.getCorners();for(let p=0;p<u.length;++p)Bi(u[p],u[p],a);return jr.fromPoints(u)}static applyTransformFast(i,a){const u=[a[12],a[13],a[14]],p=[...u];for(let g=0;g<3;g++)for(let y=0;y<3;y++){const v=a[4*y+g],T=v*i.min[y],N=v*i.max[y];u[g]+=Math.min(T,N),p[g]+=Math.max(T,N)}return new jr(u,p)}static projectAabbCorners(i,a){const u=i.getCorners();for(let p=0;p<u.length;++p)Bi(u[p],u[p],a);return u}constructor(i,a){this.min=i,this.max=a,this.center=Ot([],Pe([],this.min,this.max),.5)}quadrant(i){const a=[i%2==0,i<2],u=ze(this.min),p=ze(this.max);for(let g=0;g<a.length;g++)u[g]=a[g]?this.min[g]:this.center[g],p[g]=a[g]?this.center[g]:this.max[g];return p[2]=this.max[2],new jr(u,p)}distanceX(i){return Math.max(Math.min(this.max[0],i[0]),this.min[0])-i[0]}distanceY(i){return Math.max(Math.min(this.max[1],i[1]),this.min[1])-i[1]}distanceZ(i){return Math.max(Math.min(this.max[2],i[2]),this.min[2])-i[2]}getCorners(){const i=this.min,a=this.max;return[[i[0],i[1],i[2]],[a[0],i[1],i[2]],[a[0],a[1],i[2]],[i[0],a[1],i[2]],[i[0],i[1],a[2]],[a[0],i[1],a[2]],[a[0],a[1],a[2]],[i[0],a[1],a[2]]]}intersects(i){return this.intersectsAabb(i.bounds)?tn(i,this.getCorners()):0}intersectsFlat(i){return this.intersectsAabb(i.bounds)?tn(i,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(i,a){return a||this.intersects(i)?Va(i,this.getCorners()):0}intersectsPreciseFlat(i,a){return a||this.intersectsFlat(i)?Va(i,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(i){for(let a=0;a<3;++a)if(this.min[a]>i.max[a]||i.min[a]>this.max[a])return!1;return!0}intersectsAabbXY(i){return!(this.min[0]>i.max[0]||i.min[0]>this.max[0]||this.min[1]>i.max[1]||i.min[1]>this.max[1])}encapsulate(i){for(let a=0;a<3;a++)this.min[a]=Math.min(this.min[a],i.min[a]),this.max[a]=Math.max(this.max[a],i.max[a])}encapsulatePoint(i){for(let a=0;a<3;a++)this.min[a]=Math.min(this.min[a],i[a]),this.max[a]=Math.max(this.max[a],i[a])}closestPoint(i){return[Math.max(Math.min(this.max[0],i[0]),this.min[0]),Math.max(Math.min(this.max[1],i[1]),this.min[1]),Math.max(Math.min(this.max[2],i[2]),this.min[2])]}}Yt(jr,"Aabb");class vo{constructor(i,a){this.feature=i,this.metersToTile=a,this.index=0}get(){const i=this.feature.vertices[this.index],a=this.feature.vertexProps[this.index].dir,u=a[1],p=-a[0],g=(i.extent+1)*this.metersToTile;return[new wt(Math.trunc(i.position[0]+u*g),Math.trunc(i.position[1]+p*g)),new wt(Math.trunc(i.position[0]-u*g),Math.trunc(i.position[1]-p*g))]}next(){this.index++}valid(){return this.index<this.feature.vertices.length}}class ua{constructor(i,a,u,p,g,y){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this._tmpVec2=[jn(),jn(),jn(),jn(),jn(),jn(),jn()],this.id=i,this.heightRange={min:u,max:u},this.safeArea=a,this.constantHeight=u,this.constantHeight==null&&(this.constantHeight!=null||p.length!==0)){this.vertices=p,this.edges=g,this.edges=this.edges.filter(v=>{return v.a<this.vertices.length&&v.b<this.vertices.length&&!((T=this.vertices[v.a].position)[0]===(N=this.vertices[v.b].position)[0]&&T[1]===N[1]);var T,N}),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(const v of this.vertices)this.vertexProps.push({dir:Da(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,v.height),this.heightRange.max=Math.max(this.heightRange.max,v.height);for(const v of this.edges){const T=this.vertices[v.a].position,N=this.vertices[v.b].position,I=oi(jn(),N,T),P=qi(I),j=Mi(jn(),I,1/P);this.edgeProps.push({vec:I,dir:j,len:P});const O=this.vertexProps[v.a].dir,L=this.vertexProps[v.b].dir;pt(O,O,j),pt(L,L,j)}for(const v of this.vertexProps)v.dir[0]===0&&v.dir[1]===0||Xn(v.dir,v.dir);this.tessellate(y)}}pointElevation(i){if(this.constantHeight!=null)return this.constantHeight;const a=this.getClosestEdge(i);if(a==null)return 0;const[u,p]=a;return Si(this.vertices[this.edges[u].a].height,this.vertices[this.edges[u].b].height,p)}computeSlopeNormal(i,a){const u=this.getClosestEdge(i);if(!u)return Le(0,0,1);const p=u[0],g=this.edges[p],y=this.edgeProps[p].vec,v=Le(y[0],y[1],(this.vertices[g.b].height-this.vertices[g.a].height)*a),T=Le(v[1],-v[0],0);Fi(T,T,v);const N=ve(T);return N>0?Ot(T,T,1/N):Ke(T,0,0,1)}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(i){if(this.edges.length===0)return;let a=0,u=Number.POSITIVE_INFINITY,p=0;const[g,y,v,T,N,I,P]=this._tmpVec2;ms(P,i.x,i.y);const j=new Gi(P,null);for(let O=0;O<this.edges.length;O++){const L=this.edges[O],U=this.edgeProps[O].dir;j.dir=U;const Z=this.vertices[L.a].position,G=this.vertices[L.b].position,ee=j.intersectsPlane(Z,this.vertexProps[L.a].dir,g),le=j.intersectsPlane(G,this.vertexProps[L.b].dir,y);if(!ee||!le)continue;oi(v,y,g),oi(T,P,g);const me=mr(v,v),we=me>0?mr(T,v)/me:0,be=Ie(we,0,1),Re=Math.abs((we-be)*this.edgeProps[O].len);oi(N,P,Z),ms(I,U[1],-U[0]);const Me=Re+Math.abs(mr(N,I));Me<u&&(a=O,u=Me,p=be)}return[a,p]}tessellate(i){const a=ie(),u=ie(),p=ie(),g=ie();for(let y=this.edges.length-1;y>=0;--y){const v=this.edges[y].a,T=this.edges[y].b,{position:N,height:I,extent:P}=this.vertices[v],{position:j,height:O,extent:L}=this.vertices[T],U=this.vertexProps[v].dir,Z=this.vertexProps[T].dir;if(Ke(a,N[0]/i,N[1]/i,I),Ke(u,j[0]/i,j[1]/i,O),Ke(p,U[1],-U[0],0),Ot(p,p,P),Ke(g,Z[1],-Z[0],0),Ot(g,g,L),this.distSqLines(Le(a[0]+.5*p[0],a[1]+.5*p[1],a[2]+.5*p[2]),Le(u[0]-.5*g[0],u[1]-.5*g[1],u[2]-.5*g[2]),Le(a[0]-.5*p[0],a[1]-.5*p[1],a[2]-.5*p[2]),Le(u[0]+.5*g[0],u[1]+.5*g[1],u[2]+.5*g[2]))<=.0025000000000000005)continue;const G=this.vertices.length,ee=pt(jn(),N,j);this.vertices.push({position:Mi(ee,ee,.5),height:.5*(I+O),extent:.5*(P+L)});const le=pt(jn(),U,Z);this.vertexProps.push({dir:Xn(le,le)}),this.edges.splice(y,1),this.edgeProps.splice(y,1),this.edges.push({a:v,b:G}),this.edges.push({a:G,b:T});const me=oi(jn(),this.vertices[G].position,N),we=qi(me),be={vec:me,dir:Mi(jn(),me,1/we),len:we};this.edgeProps.push(be),this.edgeProps.push(be)}}distSqLines(i,a,u,p){const g=It(ie(),a,i),y=It(ie(),p,u),v=It(ie(),i,u),T=ui(g,g),N=ui(g,y),I=ui(g,v),P=ui(y,y),j=ui(y,v),O=T*P-N*N;if(O===0)return mi(Ii(g,u,p,ui(v,y)/ui(y,y)),i);const L=(T*j-N*I)/O;return mi(Ii(g,i,a,(N*j-I*P)/O),Ii(y,u,p,L))}}class no{static parseFrom(i,a){const u=rr.parse(i);if(!u)return[];let{vertices:p,features:g}=u;const y=1/Rt(a);g.sort((I,P)=>I.id-P.id),p.sort((I,P)=>I.id-P.id||I.idx-P.idx),p=p.filter((I,P,j)=>P===j.findIndex(O=>O.id===I.id&&O.idx===I.idx));const v=new Array;let T=0;const N=p.length;for(const I of g){if(I.constantHeight){v.push(new ua(I.id,I.bounds,I.constantHeight));continue}for(;T!==N&&p[T].id<I.id;)T++;if(T===N||p[T].id!==I.id)continue;const P=new Array,j=new Array,O=T;for(;T!==N&&p[T].id===I.id;){const L=p[T];if(P.push({position:L.position,height:L.height,extent:L.extent}),T!==O&&p[T-1].idx===L.idx-1){const U=T-O;j.push({a:U-1,b:U})}T++}v.push(new ua(I.id,I.bounds,void 0,P,j,y))}return v}static getElevationFeature(i,a){if(!a)return;const u=+i.properties[ur];return Number.isNaN(u)?void 0:a.find(p=>p.id===u)}}class ml{constructor(i,a){this.zScale=1,this.xOffset=0,this.yOffset=0,i.equals(a)||(this.zScale=Math.pow(2,a.z-i.z),this.xOffset=(i.x*this.zScale-a.x)*Bt,this.yOffset=(i.y*this.zScale-a.y)*Bt)}constantElevation(i,a){if(i.constantHeight!=null)return this.computeBiasedHeight(i.constantHeight,a)}pointElevation(i,a,u){const p=this.constantElevation(a,u);return p??(i.x=i.x*this.zScale+this.xOffset,i.y=i.y*this.zScale+this.yOffset,this.computeBiasedHeight(a.pointElevation(i),u))}computeBiasedHeight(i,a){return a<=0?i:i+a*Xe(0,a,i>=0?i:Math.abs(.5*i))}}Yt(ua,"ElevationFeature");class Ua{constructor(i){this.zoom=i.zoom,this.overscaling=i.overscaling,this.layers=i.layers,this.layerIds=this.layers.map(a=>a.fqid),this.index=i.index,this.hasPattern=!1,this.projection=i.projection,this.layoutVertexArray=new Su,this.indexArray=new ys,this.segments=new dn,this.programConfigurations=new M(i.layers,{zoom:i.zoom,lut:i.lut}),this.stateDependentLayerIds=this.layers.filter(a=>a.isStateDependent()).map(a=>a.id),this.elevationMode=this.layers[0].layout.get("circle-elevation-reference"),this.hasElevation=!1,this.elevationMode!=="none"&&(this.elevatedLayoutVertexArray=new Qs),this.worldview=i.worldview,this.hasAppearances=null}updateFootprints(i,a){}updateAppearances(i,a,u,p){}populate(i,a,u,p){const g=this.layers[0],y=[];let v=null;g.type==="circle"&&(v=g.layout.get("circle-sort-key"));for(const{feature:N,id:I,index:P,sourceLayerIndex:j}of i){const O=this.layers[0]._featureFilter.needGeometry,L=Hi(N,O);if(!this.layers[0]._featureFilter.filter(new Vr(this.zoom,{worldview:this.worldview,activeFloors:a.activeFloors}),L,u))continue;const U=v?v.evaluate(L,{},u):void 0,Z={id:I,properties:N.properties,type:N.type,sourceLayerIndex:j,index:P,geometry:O?L.geometry:Ci(N,u,p),patterns:{},sortKey:U};y.push(Z)}v&&y.sort((N,I)=>N.sortKey-I.sortKey);let T=null;p.projection.name==="globe"&&(this.globeExtVertexArray=new bh,T=p.projection);for(const N of y){const{geometry:I,index:P,sourceLayerIndex:j}=N,O=i[P].feature;this.addFeature(N,I,P,a.availableImages,u,T,a.brightness,a.elevationFeatures),a.featureIndex.insert(O,I,P,j,this.index)}this.hasElevation||(this.elevatedLayoutVertexArray=void 0)}update(i,a,u,p,g,y,v){this.programConfigurations.updatePaintArrays(i,a,g,u,p,y,v,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(i){this.uploaded||(this.layoutVertexBuffer=i.createVertexBuffer(this.layoutVertexArray,h1.members),this.indexBuffer=i.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=i.createVertexBuffer(this.globeExtVertexArray,m1.members)),this.elevatedLayoutVertexArray&&(this.elevatedLayoutVertexBuffer=i.createVertexBuffer(this.elevatedLayoutVertexArray,p1.members))),this.programConfigurations.upload(i),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy())}addFeature(i,a,u,p,g,y,v,T){let N;this.elevationMode!=="none"&&(N=no.getElevationFeature(i,T));for(const I of a)for(const P of I){const j=P.x,O=P.y;if(j<0||j>=Bt||O<0||O>=Bt)continue;if(y){const Z=y.projectTilePoint(j,O,g),G=y.upVector(g,j,O);this.addGlobeExtVertex(Z,G),this.addGlobeExtVertex(Z,G),this.addGlobeExtVertex(Z,G),this.addGlobeExtVertex(Z,G)}const L=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,i.sortKey),U=L.vertexLength;if(this.addCircleVertex(j,O,-1,-1),this.addCircleVertex(j,O,1,-1),this.addCircleVertex(j,O,1,1),this.addCircleVertex(j,O,-1,1),this.elevationMode!=="none"){const Z=N?N.pointElevation(new wt(j,O)):0;this.hasElevation=this.hasElevation||Z!==0;for(let G=0;G<4;G++)this.elevatedLayoutVertexArray.emplaceBack(Z)}this.indexArray.emplaceBack(U,U+1,U+2),this.indexArray.emplaceBack(U,U+2,U+3),L.vertexLength+=4,L.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,i,u,{},p,g,v,void 0,this.worldview)}addCircleVertex(i,a,u,p){this.layoutVertexArray.emplaceBack(2*i+(u+1)/2,2*a+(p+1)/2)}addGlobeExtVertex(i,a){this.globeExtVertexArray.emplaceBack(i.x,i.y,i.z,a[0]*16384,a[1]*16384,a[2]*16384)}}function _n(l,i){for(let a=0;a<l.length;a++)if(wo(i,l[a]))return!0;for(let a=0;a<i.length;a++)if(wo(l,i[a]))return!0;return!!ba(l,i)}function Hn(l,i,a){return!!wo(l,i)||!!sc(i,l,a)}function Qr(l,i){if(l.length===1)return Nh(i,l[0]);for(let a=0;a<i.length;a++){const u=i[a];for(let p=0;p<u.length;p++)if(wo(l,u[p]))return!0}for(let a=0;a<l.length;a++)if(Nh(i,l[a]))return!0;for(let a=0;a<i.length;a++)if(ba(l,i[a]))return!0;return!1}function ts(l,i,a){if(l.length>1){if(ba(l,i))return!0;for(let u=0;u<i.length;u++)if(sc(i[u],l,a))return!0}for(let u=0;u<l.length;u++)if(sc(l[u],i,a))return!0;return!1}function ba(l,i){if(l.length===0||i.length===0)return!1;for(let a=0;a<l.length-1;a++){const u=l[a],p=l[a+1];for(let g=0;g<i.length-1;g++)if(zn(u,p,i[g],i[g+1]))return!0}return!1}function zn(l,i,a,u){return Br(l,a,u)!==Br(i,a,u)&&Br(l,i,a)!==Br(l,i,u)}function bo(l,i,a){return(l.x-a.x)*(i.y-a.y)-(l.y-a.y)*(i.x-a.x)}function bm(l,i,a,u){const p=bo(l,i,u),g=bo(l,i,a);if(Math.sign(p)===Math.sign(g))return;const y=bo(a,u,l),v=y+g-p;return Math.sign(y)!==Math.sign(v)?[y/(y-v),g/(g-p)]:void 0}function sc(l,i,a){const u=a*a;if(i.length===1)return l.distSqr(i[0])<u;for(let p=1;p<i.length;p++)if(Th(l,i[p-1],i[p])<u)return!0;return!1}function Th(l,i,a){const u=i.distSqr(a);if(u===0)return l.distSqr(i);const p=((l.x-i.x)*(a.x-i.x)+(l.y-i.y)*(a.y-i.y))/u;return l.distSqr(p<0?i:p>1?a:a.sub(i)._mult(p)._add(i))}function Nh(l,i){let a,u,p,g=!1;for(let y=0;y<l.length;y++){a=l[y];for(let v=0,T=a.length-1;v<a.length;T=v++)u=a[v],p=a[T],u.y>i.y!=p.y>i.y&&i.x<(p.x-u.x)*(i.y-u.y)/(p.y-u.y)+u.x&&(g=!g)}return g}function wo(l,i){let a=!1;for(let u=0,p=l.length-1;u<l.length;p=u++){const g=l[u],y=l[p];g.y>i.y!=y.y>i.y&&i.x<(y.x-g.x)*(i.y-g.y)/(y.y-g.y)+g.x&&(a=!a)}return a}function ac(l,i,a,u,p){for(const y of l)if(i<=y.x&&a<=y.y&&u>=y.x&&p>=y.y)return!0;const g=[new wt(i,a),new wt(i,p),new wt(u,p),new wt(u,a)];if(l.length>2){for(const y of g)if(wo(l,y))return!0}for(let y=0;y<l.length-1;y++)if(oc(l[y],l[y+1],g))return!0;return!1}function oc(l,i,a){const u=a[0],p=a[2];if(l.x<u.x&&i.x<u.x||l.x>p.x&&i.x>p.x||l.y<u.y&&i.y<u.y||l.y>p.y&&i.y>p.y)return!1;const g=Br(l,i,a[0]);return g!==Br(l,i,a[1])||g!==Br(l,i,a[2])||g!==Br(l,i,a[3])}function Ho(l,i,a,u,p,g){let y=i.y-l.y,v=l.x-i.x;if(g=g||0){const T=y*y+v*v;if(T===0)return!0;const N=Math.sqrt(T);y/=N,v/=N}return!((a.x-l.x)*y+(a.y-l.y)*v-g<0||(u.x-l.x)*y+(u.y-l.y)*v-g<0||(p.x-l.x)*y+(p.y-l.y)*v-g<0)}function Mc(l,i,a,u,p,g,y){return!(Ho(l,i,u,p,g,y)||Ho(i,a,u,p,g,y)||Ho(a,l,u,p,g,y)||Ho(u,p,l,i,a,y)||Ho(p,g,l,i,a,y)||Ho(g,u,l,i,a,y))}function xd(l,i,a){const u=i.paint.get(l).value;return u.kind==="constant"?u.value:a.programConfigurations.get(i.id).getMaxValue(l)}function gg(l){return Math.sqrt(l[0]*l[0]+l[1]*l[1])}function iR(l,i,a,u,p){if(!i[0]&&!i[1])return l;const g=wt.convert(i)._mult(p);a==="viewport"&&g._rotate(-u);const y=[];for(let v=0;v<l.length;v++)y.push(l[v].sub(g));return y}function rR(l,i,a,u){const p=wt.convert(l)._mult(u);return i==="viewport"&&p._rotate(-a),p}let nR,sR;function aR(l,i,a){var u=2*Math.PI*6378137/256/Math.pow(2,a);return[l*u-2*Math.PI*6378137/2,i*u-2*Math.PI*6378137/2]}Yt(Ua,"CircleBucket",{omit:["layers"]});class wm{constructor(i,a,u){this.z=i,this.x=a,this.y=u,this.key=yg(0,i,i,a,u)}equals(i){return this.z===i.z&&this.x===i.x&&this.y===i.y}isChildOf(i){const a=this.z-i.z;return i.z===0||i.z<this.z&&i.x===this.x>>a&&i.y===this.y>>a}url(i,a){const u=function(g,y,v){var T=aR(256*g,256*(y=Math.pow(2,v)-y-1),v),N=aR(256*(g+1),256*(y+1),v);return T[0]+","+T[1]+","+N[0]+","+N[1]}(this.x,this.y,this.z),p=function(g,y,v){let T,N="";for(let I=g;I>0;I--)T=1<<I-1,N+=(y&T?1:0)+(v&T?2:0);return N}(this.z,this.x,this.y);return i[(this.x+this.y)%i.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(a==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",p).replace("{bbox-epsg-3857}",u)}toString(){return`${this.z}/${this.x}/${this.y}`}}class oR{constructor(i,a){this.wrap=i,this.canonical=a,this.key=yg(i,a.z,a.z,a.x,a.y)}}class qa{constructor(i,a,u,p,g){this.overscaledZ=i,this.wrap=a,this.canonical=new wm(u,+p,+g),this.key=a===0&&i===u?this.canonical.key:yg(a,i,u,p,g)}equals(i){return this.overscaledZ===i.overscaledZ&&this.wrap===i.wrap&&this.canonical.equals(i.canonical)}scaledTo(i){const a=this.canonical.z-i;return i>this.canonical.z?new qa(i,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new qa(i,this.wrap,i,this.canonical.x>>a,this.canonical.y>>a)}calculateScaledKey(i,a=!0){if(this.overscaledZ===i&&a)return this.key;if(i>this.canonical.z)return yg(this.wrap*+a,i,this.canonical.z,this.canonical.x,this.canonical.y);{const u=this.canonical.z-i;return yg(this.wrap*+a,i,i,this.canonical.x>>u,this.canonical.y>>u)}}isChildOf(i){if(i.wrap!==this.wrap)return!1;const a=this.canonical.z-i.canonical.z;return i.overscaledZ===0||i.overscaledZ<this.overscaledZ&&i.canonical.z<this.canonical.z&&i.canonical.x===this.canonical.x>>a&&i.canonical.y===this.canonical.y>>a}children(i){if(this.overscaledZ>=i)return[new qa(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const a=this.canonical.z+1,u=2*this.canonical.x,p=2*this.canonical.y;return[new qa(a,this.wrap,a,u,p),new qa(a,this.wrap,a,u+1,p),new qa(a,this.wrap,a,u,p+1),new qa(a,this.wrap,a,u+1,p+1)]}isLessThan(i){return this.wrap<i.wrap||!(this.wrap>i.wrap)&&(this.overscaledZ<i.overscaledZ||!(this.overscaledZ>i.overscaledZ)&&(this.canonical.x<i.canonical.x||!(this.canonical.x>i.canonical.x)&&this.canonical.y<i.canonical.y))}wrapped(){return new qa(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(i){return new qa(this.overscaledZ,i,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new oR(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function yg(l,i,a,u,p){const g=1<<Math.min(a,22);let y=g*(p%g)+u%g;return l&&a<22&&(y+=g*g*((l<0?-2*l-1:2*l)%(1<<2*(22-a)))),16*(32*y+a)+(i-a)}const nq=[l=>{let i=l.canonical.x-1,a=l.wrap;return i<0&&(i=(1<<l.canonical.z)-1,a--),new qa(l.overscaledZ,a,l.canonical.z,i,l.canonical.y)},l=>{let i=l.canonical.x+1,a=l.wrap;return i===1<<l.canonical.z&&(i=0,a++),new qa(l.overscaledZ,a,l.canonical.z,i,l.canonical.y)},l=>new qa(l.overscaledZ,l.wrap,l.canonical.z,l.canonical.x,(l.canonical.y===0?1<<l.canonical.z:l.canonical.y)-1),l=>new qa(l.overscaledZ,l.wrap,l.canonical.z,l.canonical.x,l.canonical.y===(1<<l.canonical.z)-1?0:l.canonical.y+1)];Yt(wm,"CanonicalTileID"),Yt(qa,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const sq=sr([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:_1}=sq,aq=sr([{name:"a_pos_3",components:3,type:"Int16"}]);var lR=sr([{name:"a_pos",type:"Int16",components:2}]);function v1(l){return l*J/Oe}const oq=[new jr([xe,xe,xe],[fe,fe,fe]),new jr([xe,xe,xe],[0,0,fe]),new jr([0,xe,xe],[fe,0,fe]),new jr([xe,0,xe],[0,fe,fe]),new jr([0,0,xe],[fe,fe,fe])];function cR(l,i,a,u=!0){const p=Ot([],l._camera.position,l.worldSize),g=[i,a,1,1];Vi(g,g,l.pixelMatrixInverse),li(g,g,1/g[3]);const y=ni([],Tr([],g,p)),v=l.globeMatrix,T=[v[12],v[13],v[14]],N=Tr([],T,p),I=ve(N),P=ni([],N),j=l.worldSize/(2*Math.PI),O=ui(P,y),L=Math.asin(j/I);if(L<Math.acos(O)){if(!u)return null;const Be=[],Ge=[];Ot(Be,y,I/O),ni(Ge,Tr(Ge,Be,N)),ni(y,Pe(y,N,Ot(y,Ge,Math.tan(L)*I)))}const U=[];new Zr(p,y).closestPointOnSphere(T,j,U);const Z=ni([],Jr(v,0)),G=ni([],Jr(v,1)),ee=ni([],Jr(v,2)),le=ui(Z,U),me=ui(G,U),we=ui(ee,U),be=Ze(Math.asin(-me/j));let Re=Ze(Math.atan2(le,we));Re=l.center.lng+function(Be,Ge){const ut=(Ge-Be+180)%360-180;return ut<-180?ut+360:ut}(l.center.lng,Re);const Me=Qe(Re),je=Ie(at(be),0,1);return new Ut(Me,je)}class lq{constructor(i,a,u){this.a=Tr([],i,u),this.b=Tr([],a,u),this.center=u;const p=ni([],this.a),g=ni([],this.b);this.angle=Math.acos(ui(p,g))}}function _N(l,i){if(l.angle===0)return null;let a;return a=l.a[i]===0?1/l.angle*.5*Math.PI:1/l.angle*Math.atan(l.b[i]/l.a[i]/Math.sin(l.angle)-1/Math.tan(l.angle)),a<0||a>1?null:function(u,p,g,y){const v=Math.sin(g);return u*(Math.sin((1-y)*g)/v)+p*(Math.sin(y*g)/v)}(l.a[i],l.b[i],l.angle,Ie(a,0,1))+l.center[i]}function Nu(l){if(l.z<=1)return oq[l.z+2*l.y+l.x];const i=vN(b1(l));return jr.fromPoints(i)}function _d(l,i,a){return Ot(l,l,1-a),Et(l,l,i,a)}function uR(l,i,a){for(const u of l)Bi(u,u,i),Ot(u,u,a)}function dR(l,i,a,u){const p=i/l.worldSize,g=l.globeMatrix;if(a.z<=1){const je=Nu(a).getCorners();return uR(je,g,p),jr.fromPoints(je)}const y=b1(a,u),v=vN(y,J+v1(l._tileCoverLift));uR(v,g,p);const T=Number.MAX_VALUE,N=[-T,-T,-T],I=[T,T,T];if(y.contains(l.center)){for(const Ge of v)zt(I,I,Ge),vt(N,N,Ge);N[2]=0;const je=l.point,Be=[je.x*p,je.y*p,0];return zt(I,I,Be),vt(N,N,Be),new jr(I,N)}if(l._tileCoverLift>0){for(const je of v)zt(I,I,je),vt(N,N,je);return new jr(I,N)}const P=[g[12]*p,g[13]*p,g[14]*p],j=y.getCenter(),O=Ie(l.center.lat,-85.051129,$e),L=Ie(j.lat,-85.051129,$e),U=Qe(l.center.lng),Z=at(O);let G=U-Qe(j.lng);const ee=Z-at(L);G>.5?G-=1:G<-.5&&(G+=1);let le=0;Math.abs(G)>Math.abs(ee)?le=G>=0?1:3:(le=ee>=0?0:2,Et(P,P,[g[4]*p,g[5]*p,g[6]*p],-Math.sin(Zi(ee>=0?y.getSouth():y.getNorth()))*J));const me=v[le],we=v[(le+1)%4],be=new lq(me,we,P),Re=[_N(be,0)||me[0],_N(be,1)||me[1],_N(be,2)||me[2]],Me=Ah(l.zoom);if(Me>0){const je=function({x:Ge,y:ut,z:lt},ct,xt,gt,yt){const st=1/(1<<lt);let bt=Ge*st,mt=bt+st,Tt=ut*st,_t=Tt+st,Zt=0;const Xt=(bt+mt)/2-gt;return Xt>.5?Zt=-1:Xt<-.5&&(Zt=1),bt=((bt+Zt)*ct-(gt*=ct))*xt+gt,mt=((mt+Zt)*ct-gt)*xt+gt,Tt=(Tt*ct-(yt*=ct))*xt+yt,_t=(_t*ct-yt)*xt+yt,[[bt,_t,0],[mt,_t,0],[mt,Tt,0],[bt,Tt,0]]}(a,i,l._pixelsPerMercatorPixel,U,Z);for(let Ge=0;Ge<v.length;Ge++)_d(v[Ge],je[Ge],Me);const Be=Pe([],je[le],je[(le+1)%4]);Ot(Be,Be,.5),_d(Re,Be,Me)}for(const je of v)zt(I,I,je),vt(N,N,je);return I[2]=Math.min(me[2],we[2]),zt(I,I,Re),vt(N,N,Re),new jr(I,N)}function b1({x:l,y:i,z:a},u=!1){const p=1/(1<<a),g=new Se(ft(l*p),i===(1<<a)-1&&u?-90:Nt((i+1)*p)),y=new Se(ft((l+1)*p),i===0&&u?90:Nt(i*p));return new qe(g,y)}function vN(l,i=J){const a=Zi(l.getNorth()),u=Zi(l.getSouth()),p=Math.cos(a),g=Math.cos(u),y=Math.sin(a),v=Math.sin(u),T=l.getWest(),N=l.getEast();return[Fe(g,v,T,i),Fe(g,v,N,i),Fe(p,y,N,i),Fe(p,y,T,i)]}function __(l,i,a,u){const p=1<<a.z,g=(l/Bt+a.x)/p;return De(Nt((i/Bt+a.y)/p),ft(g),u)}function w1({min:l,max:i}){return 16383/Math.max(i[0]-l[0],i[1]-l[1],i[2]-l[2])}const hR=new Float64Array(16);function S1(l){const i=w1(l),a=ae(hR,[i,i,i]);return ge(a,a,hi([],l.min))}function bN(l){const i=function(u,p){return u[0]=1,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=1,u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=1,u[11]=0,u[12]=p[0],u[13]=p[1],u[14]=p[2],u[15]=1,u}(hR,l.min),a=1/w1(l);return Ae(i,i,[a,a,a])}function wN(l){const i=Bt/(2*Math.PI);return l/(2*Math.PI)/i}function pR(l,i){return Bt/(512*Math.pow(2,l))*w1(Nu(i))}function mR(l,i,a,u,p){const g=wN(a),y=[l,i,-a/(2*Math.PI)],v=se(new Float64Array(16));return ge(v,v,y),Ae(v,v,[g,g,g]),Te(v,v,Zi(-p)),Ce(v,v,Zi(-u)),v}function Ah(l){return Xe(5,6,l)}function fR(l,i){const a=De(i.lat,i.lng),u=function(L){const U=De(L._center.lat,L._center.lng);let Z=Fi([],Le(0,1,0),U);const G=q([],-L.angle,U);Z=Bi(Z,Z,G),q(G,-L._pitch,Z);const ee=ni([],U);return Ot(ee,ee,v1(L.cameraToCenterDistance/L.pixelsPerMeter)),Bi(ee,ee,G),Pe([],U,ee)}(l);return y=(p=It([],u,a))[0],v=p[1],T=p[2],N=(g=a)[0],I=g[1],P=g[2],O=(j=Math.sqrt((y*y+v*v+T*T)*(N*N+I*I+P*P)))&&ui(p,g)/j,Math.acos(Math.min(Math.max(O,-1),1));var p,g,y,v,T,N,I,P,j,O}function SN(l,i){return fR(l,i)>Math.PI/2*1.01}const gR=Zi(85),cq=Math.cos(gR),uq=Math.sin(gR),dq=X(),yR=l=>{const i=[];return l.paint.get("circle-pitch-alignment")==="map"&&i.push("PITCH_WITH_MAP"),l.paint.get("circle-pitch-scale")==="map"&&i.push("SCALE_WITH_MAP"),i};function xR(l,i,a,u,p,g,y,v,T){if(g&&l.queryGeometry.isAboveHorizon)return!1;g&&(T*=l.pixelToTileUnitsFactor);const N=l.tileID.canonical,I=a.projection.upVectorScale(N,a.center.lat,a.worldSize).metersToTile;for(const P of i)for(const j of P){const O=j.add(v),L=p&&a.elevation?a.elevation.exaggeration()*p.getElevationAt(O.x,O.y,!0):0,U=a.projection.projectTilePoint(O.x,O.y,N);if(L>0){const le=a.projection.upVector(N,O.x,O.y);U.x+=le[0]*I*L,U.y+=le[1]*I*L,U.z+=le[2]*I*L}const Z=g?O:hq(U.x,U.y,U.z,u),G=g?l.tilespaceRays.map(le=>mq(le,L)):l.queryGeometry.screenGeometry,ee=Vi([],[U.x,U.y,U.z,1],u);if(!y&&g?T*=ee[3]/a.cameraToCenterDistance:y&&!g&&(T*=a.cameraToCenterDistance/ee[3]),g){const le=Nt((j.y/Bt+N.y)/(1<<N.z));T/=a.projection.pixelsPerMeter(le,1)/nt(1,le)}if(Hn(G,Z,T))return!0}return!1}function hq(l,i,a,u){const p=Vi([],[l,i,a,1],u);return new wt(p[0]/p[3],p[1]/p[3])}const _R=Le(0,0,0),pq=Le(0,0,1);function mq(l,i){const a=ie();return _R[2]=i,l.intersectsPlane(_R,pq,a),new wt(a[0],a[1])}class vR extends Ua{}let bR,wR,SR,TR;function NR(l,{width:i,height:a},u,p){if(p){if(p instanceof Uint8ClampedArray)p=new Uint8Array(p.buffer);else if(p.length!==i*a*u)throw new RangeError("mismatched image size")}else p=new Uint8Array(i*a*u);return l.width=i,l.height=a,l.data=p,l}function AR(l,i,a){const{width:u,height:p}=i;u===l.width&&p===l.height||(TN(l,i,{x:0,y:0},{x:0,y:0},{width:Math.min(l.width,u),height:Math.min(l.height,p)},a,null),l.width=u,l.height=p,l.data=i.data)}function TN(l,i,a,u,p,g,y,v){if(p.width===0||p.height===0)return i;if(p.width>l.width||p.height>l.height||a.x>l.width-p.width||a.y>l.height-p.height)throw new RangeError("out of range source coordinates for image copy");if(p.width>i.width||p.height>i.height||u.x>i.width-p.width||u.y>i.height-p.height)throw new RangeError("out of range destination coordinates for image copy");const T=l.data,N=i.data,I=g===4&&v;for(let P=0;P<p.height;P++){const j=((a.y+P)*l.width+a.x)*g,O=((u.y+P)*i.width+u.x)*g;if(I)for(let L=0;L<p.width;L++){const U=j+L*g+3,Z=O+L*g;N[Z+0]=255,N[Z+1]=255,N[Z+2]=255,N[Z+3]=T[U]}else if(y)for(let L=0;L<p.width;L++){const U=j+L*g,Z=O+L*g,G=new Ar(T[U+0]/255,T[U+1]/255,T[U+2]/255,T[U+3]).toNonPremultipliedRenderColor(y).toArray();N[Z+0]=G[0],N[Z+1]=G[1],N[Z+2]=G[2],N[Z+3]=G[3]}else for(let L=0;L<p.width*g;L++)N[O+L]=T[j+L]}return i}Yt(vR,"HeatmapBucket",{omit:["layers"]});class Ch{constructor(i,a){NR(this,i,1,a)}resize(i){AR(this,new Ch(i),1)}clone(){return new Ch({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(i,a,u,p,g){TN(i,a,u,p,g,1,null)}}class wa{constructor(i,a){NR(this,i,4,a)}resize(i){AR(this,new wa(i),4)}replace(i,a){a?this.data.set(i):this.data=i instanceof Uint8ClampedArray?new Uint8Array(i.buffer):i}clone(){return new wa({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(i,a,u,p,g,y,v){TN(i,a,u,p,g,4,y,v)}}class CR{constructor(i,a){this.width=i.width,this.height=i.height,this.data=a instanceof Uint8Array?new Float32Array(a.buffer):a}}function v_(l){const i={},a=l.resolution||256,u=l.clips?l.clips.length:1,p=l.image||new wa({width:a,height:u}),g=(y,v,T)=>{i[l.evaluationKey]=T;const N=l.expression.evaluate(i),I=N?N.toNonPremultipliedRenderColor(null):null;I&&(p.data[y+v+0]=Math.floor(255*I.r),p.data[y+v+1]=Math.floor(255*I.g),p.data[y+v+2]=Math.floor(255*I.b),p.data[y+v+3]=Math.floor(255*I.a))};if(l.clips)for(let y=0,v=0;y<u;++y,v+=4*a)for(let T=0,N=0;T<a;T++,N+=4){const I=T/(a-1),{start:P,end:j}=l.clips[y];g(v,N,P*(1-I)+j*I)}else for(let y=0,v=0;y<a;y++,v+=4)g(0,v,y/(a-1));return p}Yt(Ch,"AlphaImage"),Yt(wa,"RGBAImage");const fq=sr([{name:"a_pos",components:2,type:"Int16"}],4),gq=sr([{name:"a_road_z_offset",components:1,type:"Float32"}],4),yq=sr([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),xq=sr([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function xg(l,i,a=2){const u=i&&i.length,p=u?i[0]*a:l.length;let g=ER(l,0,p,a,!0);const y=[];if(!g||g.next===g.prev)return y;let v,T,N;if(u&&(g=function(I,P,j,O){const L=[];for(let U=0,Z=P.length;U<Z;U++){const G=ER(I,P[U]*O,U<Z-1?P[U+1]*O:I.length,O,!1);G===G.next&&(G.steiner=!0),L.push(Aq(G))}L.sort(Sq);for(let U=0;U<L.length;U++)j=Tq(L[U],j);return j}(l,i,g,a)),l.length>80*a){v=l[0],T=l[1];let I=v,P=T;for(let j=a;j<p;j+=a){const O=l[j],L=l[j+1];O<v&&(v=O),L<T&&(T=L),O>I&&(I=O),L>P&&(P=L)}N=Math.max(I-v,P-T),N=N!==0?32767/N:0}return b_(g,y,a,v,T,N,0),y}function ER(l,i,a,u,p){let g;if(p===function(y,v,T,N){let I=0;for(let P=v,j=T-N;P<T;P+=N)I+=(y[j]-y[P])*(y[P+1]+y[j+1]),j=P;return I}(l,i,a,u)>0)for(let y=i;y<a;y+=u)g=RR(y/u|0,l[y],l[y+1],g);else for(let y=a-u;y>=i;y-=u)g=RR(y/u|0,l[y],l[y+1],g);return g&&_g(g,g.next)&&(T_(g),g=g.next),g}function Sm(l,i){if(!l)return l;i||(i=l);let a,u=l;do if(a=!1,u.steiner||!_g(u,u.next)&&zs(u.prev,u,u.next)!==0)u=u.next;else{if(T_(u),u=i=u.prev,u===u.next)break;a=!0}while(a||u!==i);return i}function b_(l,i,a,u,p,g,y){if(!l)return;!y&&g&&function(T,N,I,P){let j=T;do j.z===0&&(j.z=NN(j.x,j.y,N,I,P)),j.prevZ=j.prev,j.nextZ=j.next,j=j.next;while(j!==T);j.prevZ.nextZ=null,j.prevZ=null,function(O){let L,U=1;do{let Z,G=O;O=null;let ee=null;for(L=0;G;){L++;let le=G,me=0;for(let be=0;be<U&&(me++,le=le.nextZ,le);be++);let we=U;for(;me>0||we>0&&le;)me!==0&&(we===0||!le||G.z<=le.z)?(Z=G,G=G.nextZ,me--):(Z=le,le=le.nextZ,we--),ee?ee.nextZ=Z:O=Z,Z.prevZ=ee,ee=Z;G=le}ee.nextZ=null,U*=2}while(L>1)}(j)}(l,u,p,g);let v=l;for(;l.prev!==l.next;){const T=l.prev,N=l.next;if(g?vq(l,u,p,g):_q(l))i.push(T.i,l.i,N.i),T_(l),l=N.next,v=N.next;else if((l=N)===v){y?y===1?b_(l=bq(Sm(l),i),i,a,u,p,g,2):y===2&&wq(l,i,a,u,p,g):b_(Sm(l),i,a,u,p,g,1);break}}}function _q(l){const i=l.prev,a=l,u=l.next;if(zs(i,a,u)>=0)return!1;const p=i.x,g=a.x,y=u.x,v=i.y,T=a.y,N=u.y,I=Math.min(p,g,y),P=Math.min(v,T,N),j=Math.max(p,g,y),O=Math.max(v,T,N);let L=u.next;for(;L!==i;){if(L.x>=I&&L.x<=j&&L.y>=P&&L.y<=O&&w_(p,v,g,T,y,N,L.x,L.y)&&zs(L.prev,L,L.next)>=0)return!1;L=L.next}return!0}function vq(l,i,a,u){const p=l.prev,g=l,y=l.next;if(zs(p,g,y)>=0)return!1;const v=p.x,T=g.x,N=y.x,I=p.y,P=g.y,j=y.y,O=Math.min(v,T,N),L=Math.min(I,P,j),U=Math.max(v,T,N),Z=Math.max(I,P,j),G=NN(O,L,i,a,u),ee=NN(U,Z,i,a,u);let le=l.prevZ,me=l.nextZ;for(;le&&le.z>=G&&me&&me.z<=ee;){if(le.x>=O&&le.x<=U&&le.y>=L&&le.y<=Z&&le!==p&&le!==y&&w_(v,I,T,P,N,j,le.x,le.y)&&zs(le.prev,le,le.next)>=0||(le=le.prevZ,me.x>=O&&me.x<=U&&me.y>=L&&me.y<=Z&&me!==p&&me!==y&&w_(v,I,T,P,N,j,me.x,me.y)&&zs(me.prev,me,me.next)>=0))return!1;me=me.nextZ}for(;le&&le.z>=G;){if(le.x>=O&&le.x<=U&&le.y>=L&&le.y<=Z&&le!==p&&le!==y&&w_(v,I,T,P,N,j,le.x,le.y)&&zs(le.prev,le,le.next)>=0)return!1;le=le.prevZ}for(;me&&me.z<=ee;){if(me.x>=O&&me.x<=U&&me.y>=L&&me.y<=Z&&me!==p&&me!==y&&w_(v,I,T,P,N,j,me.x,me.y)&&zs(me.prev,me,me.next)>=0)return!1;me=me.nextZ}return!0}function bq(l,i){let a=l;do{const u=a.prev,p=a.next.next;!_g(u,p)&&PR(u,a,a.next,p)&&S_(u,p)&&S_(p,u)&&(i.push(u.i,a.i,p.i),T_(a),T_(a.next),a=l=p),a=a.next}while(a!==l);return Sm(a)}function wq(l,i,a,u,p,g){let y=l;do{let v=y.next.next;for(;v!==y.prev;){if(y.i!==v.i&&Cq(y,v)){let T=jR(y,v);return y=Sm(y,y.next),T=Sm(T,T.next),b_(y,i,a,u,p,g,0),void b_(T,i,a,u,p,g,0)}v=v.next}y=y.next}while(y!==l)}function Sq(l,i){let a=l.x-i.x;return a===0&&(a=l.y-i.y,a===0)&&(a=(l.next.y-l.y)/(l.next.x-l.x)-(i.next.y-i.y)/(i.next.x-i.x)),a}function Tq(l,i){const a=function(p,g){let y=g;const v=p.x,T=p.y;let N,I=-1/0;if(_g(p,y))return y;do{if(_g(p,y.next))return y.next;if(T<=y.y&&T>=y.next.y&&y.next.y!==y.y){const U=y.x+(T-y.y)*(y.next.x-y.x)/(y.next.y-y.y);if(U<=v&&U>I&&(I=U,N=y.x<y.next.x?y:y.next,U===v))return N}y=y.next}while(y!==g);if(!N)return null;const P=N,j=N.x,O=N.y;let L=1/0;y=N;do{if(v>=y.x&&y.x>=j&&v!==y.x&&IR(T<O?v:I,T,j,O,T<O?I:v,T,y.x,y.y)){const U=Math.abs(T-y.y)/(v-y.x);S_(y,p)&&(U<L||U===L&&(y.x>N.x||y.x===N.x&&Nq(N,y)))&&(N=y,L=U)}y=y.next}while(y!==P);return N}(l,i);if(!a)return i;const u=jR(a,l);return Sm(u,u.next),Sm(a,a.next)}function Nq(l,i){return zs(l.prev,l,i.prev)<0&&zs(i.next,l,l.next)<0}function NN(l,i,a,u,p){return(l=1431655765&((l=858993459&((l=252645135&((l=16711935&((l=(l-a)*p|0)|l<<8))|l<<4))|l<<2))|l<<1))|(i=1431655765&((i=858993459&((i=252645135&((i=16711935&((i=(i-u)*p|0)|i<<8))|i<<4))|i<<2))|i<<1))<<1}function Aq(l){let i=l,a=l;do(i.x<a.x||i.x===a.x&&i.y<a.y)&&(a=i),i=i.next;while(i!==l);return a}function IR(l,i,a,u,p,g,y,v){return(p-y)*(i-v)>=(l-y)*(g-v)&&(l-y)*(u-v)>=(a-y)*(i-v)&&(a-y)*(g-v)>=(p-y)*(u-v)}function w_(l,i,a,u,p,g,y,v){return!(l===y&&i===v)&&IR(l,i,a,u,p,g,y,v)}function Cq(l,i){return l.next.i!==i.i&&l.prev.i!==i.i&&!function(a,u){let p=a;do{if(p.i!==a.i&&p.next.i!==a.i&&p.i!==u.i&&p.next.i!==u.i&&PR(p,p.next,a,u))return!0;p=p.next}while(p!==a);return!1}(l,i)&&(S_(l,i)&&S_(i,l)&&function(a,u){let p=a,g=!1;const y=(a.x+u.x)/2,v=(a.y+u.y)/2;do p.y>v!=p.next.y>v&&p.next.y!==p.y&&y<(p.next.x-p.x)*(v-p.y)/(p.next.y-p.y)+p.x&&(g=!g),p=p.next;while(p!==a);return g}(l,i)&&(zs(l.prev,l,i.prev)||zs(l,i.prev,i))||_g(l,i)&&zs(l.prev,l,l.next)>0&&zs(i.prev,i,i.next)>0)}function zs(l,i,a){return(i.y-l.y)*(a.x-i.x)-(i.x-l.x)*(a.y-i.y)}function _g(l,i){return l.x===i.x&&l.y===i.y}function PR(l,i,a,u){const p=N1(zs(l,i,a)),g=N1(zs(l,i,u)),y=N1(zs(a,u,l)),v=N1(zs(a,u,i));return p!==g&&y!==v||!(p!==0||!T1(l,a,i))||!(g!==0||!T1(l,u,i))||!(y!==0||!T1(a,l,u))||!(v!==0||!T1(a,i,u))}function T1(l,i,a){return i.x<=Math.max(l.x,a.x)&&i.x>=Math.min(l.x,a.x)&&i.y<=Math.max(l.y,a.y)&&i.y>=Math.min(l.y,a.y)}function N1(l){return l>0?1:l<0?-1:0}function S_(l,i){return zs(l.prev,l,l.next)<0?zs(l,i,l.next)>=0&&zs(l,l.prev,i)>=0:zs(l,i,l.prev)<0||zs(l,l.next,i)<0}function jR(l,i){const a=AN(l.i,l.x,l.y),u=AN(i.i,i.x,i.y),p=l.next,g=i.prev;return l.next=i,i.prev=l,a.next=p,p.prev=a,u.next=a,a.prev=u,g.next=u,u.prev=g,u}function RR(l,i,a,u){const p=AN(l,i,a);return u?(p.next=u.next,p.prev=u,u.next.prev=p,u.next=p):(p.prev=p,p.next=p),p}function T_(l){l.next.prev=l.prev,l.prev.next=l.next,l.prevZ&&(l.prevZ.nextZ=l.nextZ),l.nextZ&&(l.nextZ.prevZ=l.prevZ)}function AN(l,i,a){return{i:l,x:i,y:a,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function N_(l,i){const a=l.length;if(a<=1)return[l];const u=[];let p,g;for(let y=0;y<a;y++){const v=Nn(l[y]);v!==0&&(l[y].area=Math.abs(v),g===void 0&&(g=v<0),g===v<0?(p&&u.push(p),p=[l[y]]):p.push(l[y]))}if(p&&u.push(p),i>1)for(let y=0;y<u.length;y++)u[y].length<=i||(Pf(u[y],i,1,u[y].length-1,Eq),u[y]=u[y].slice(0,i));return u}function Eq(l,i){return i.area-l.area}function kR(l,i,a=1){if(!l)return null;const u=typeof l=="string"?Cn.from(l).getPrimary():l.getPrimary(),p=typeof l=="string"?null:l.getSecondary();for(const g of[u,p]){if(!g)continue;const y=g.id.toString();i.has(y)||i.set(y,[]),g.scaleSelf(a),i.get(y).push(g)}return{primary:u.toString(),secondary:p?p.toString():null}}function CN(l,i,a,u){const p=u.patternDependencies;let g=!1;for(const y of i){const v=y.paint.get(`${l}-pattern`);v.isConstant()||(g=!0),kR(v.constantOr(null),p,a)&&(g=!0)}return g}function EN(l,i,a,u,p,g){const y=g.patternDependencies;for(const v of i){const T=v.paint.get(`${l}-pattern`).value;if(T.kind!=="constant"){let N=T.evaluate({zoom:u},a,{},g.availableImages);N=N&&N.name?N.name:N;const I=kR(N,y,p);if(!I)continue;const{primary:P,secondary:j}=I;P&&(a.patterns[v.id]=[P,j].filter(Boolean))}}return a}class vd{constructor(){this.portals=[]}static isOnBorder(i,a){return i<=0&&a<=0||i>=Bt&&a>=Bt}static evaluate(i){if(i.length===0)return new vd;let a=[];for(const T of i)a.push(...T.portals);if(a.length===0)return new vd;for(const T of a){const N=T.va,I=T.vb;(vd.isOnBorder(N.x,I.x)||vd.isOnBorder(N.y,I.y))&&(T.type="border")}const u=a.filter(T=>T.type!=="unevaluated"),p=a.filter(T=>T.type==="unevaluated");if(p.length===0)return new vd;p.sort((T,N)=>T.hash===N.hash?T.isTunnel===N.isTunnel?0:T.isTunnel?-1:1:T.hash<N.hash?1:-1),a=u.concat(p);let g=u.length,y=g,v=g;do if(y++,y===a.length||a[g].hash!==a[y].hash){if(y-g===2){v<g&&(a[v]=a[g],a[g]=null);const T=a[v],N=a[y-1];T.type=T.isTunnel!==N.isTunnel?"tunnel":"polygon",T.connection={a:T.connection.a,b:N.connection.a},v++}g=y}while(g!==a.length);return a.splice(v),a.sort((T,N)=>T.hash<N.hash?1:-1),{portals:a}}}Yt(vd,"ElevationPortalGraph");class Iq{constructor(i,a,u){this.outPositions=i,this.outNormals=a,this.outIndices=u,this.vertexLookup=new Map}addVertex(i,a,u){let p=i[2];u!=null&&(p*=u);const g=`${i[0]},${i[1]},${i[2]},${a[0]},${a[1]},${a[2]}`,y=this.vertexLookup.get(g);if(y!=null)return y;const v=this.outPositions.length;this.vertexLookup.set(g,v);const T=Math.trunc(16384*a[0]),N=Math.trunc(16384*a[1]),I=Math.trunc(16384*a[2]);return this.outPositions.emplaceBack(i[0],i[1],p),this.outNormals.emplaceBack(T,N,I),v}addTriangle(i,a,u){this.outIndices.emplaceBack(i,a,u)}addTriangles(i,a,u){if(i.length===0)return;const p=u.length===1,g=ie(),y=ie();for(let v=0;v<i.length;v+=3){const T=a[i[v+0]],N=a[i[v+1]],I=a[i[v+2]],P=p?u[0]:u[i[v+1]],j=p?u[0]:u[i[v+2]];Ke(g,T.x,T.y,p?u[0]:u[i[v+0]]);const O=this.addVertex(g,y);Ke(g,N.x,N.y,P);const L=this.addVertex(g,y);Ke(g,I.x,I.y,j);const U=this.addVertex(g,y);this.outIndices.emplaceBack(O,L,U)}}addQuad(i,a,u,p,g,y){const v=this.addVertex(i,g,y),T=this.addVertex(a,g,y),N=this.addVertex(u,g,y),I=this.addVertex(p,g,y);this.addTriangle(v,T,N),this.addTriangle(N,I,v)}getVertexCount(){return this.outPositions.length}clearVertexLookup(){this.vertexLookup.clear()}}class Wo{constructor(i,a,u,p){this.unevaluatedPortals=new vd,this.bridgeFeatureSections=[],this.tunnelFeatureSections=[],this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new _h,this.vertexNormals=new o_,this.indexArray=new ys,this.tileToMeters=Rt(i),this.bridgeProgramConfigurations=new M(a,{zoom:u,lut:p},g=>g!=="fill-tunnel-structure-color"),this.tunnelProgramConfigurations=new M(a,{zoom:u,lut:p},g=>g!=="fill-bridge-guard-rail-color")}addVertices(i,a){const u=this.unevalVertices.length;for(let p=0;p<i.length;p++)this.unevalVertices.push(i[p]),this.unevalHeights.push(a[p]);return u}addTriangles(i,a,u){const p=u?this.unevalTunnelTriangles:this.unevalTriangles;for(const g of i)p.push(g+a)}addRenderableRing(i,a,u,p,g,y){const v=[new wt(g.min.x,g.min.y),new wt(g.max.x,g.min.y),new wt(g.max.x,g.max.y),new wt(g.min.x,g.max.y)];for(let T=0;T<u-1;T++){const N=a+T,I=N+1,P=this.unevalVertices[N],j=this.unevalVertices[I];if(!(P.x>=g.min.x&&P.x<=g.max.x&&P.y>=g.min.y&&P.y<=g.max.y||j.x>=g.min.x&&j.x<=g.max.x&&j.y>=g.min.y&&j.y<=g.max.y||oc(P,j,v))||this.isOnBorder(P.x,j.x)||this.isOnBorder(P.y,j.y))continue;const O=Wo.computeEdgeHash(this.unevalVertices[N],this.unevalVertices[I]);let L,U=this.vertexHashLookup.get(Wo.computePosHash(P));U!=null?L=U.next:(U=this.vertexHashLookup.get(Wo.computePosHash(j)),L=U!=null?U.prev:O),this.unevalEdges.push({polygonIdx:i,a:N,b:I,hash:O,portalHash:L,isTunnel:p,type:"unevaluated",featureInfo:y})}}addPortalCandidates(i,a,u,p,g){if(a.length!==0){this.vertexHashLookup.clear();for(const y of a){if(y.length===0)continue;const v=y[0];let T=Wo.computeEdgeHash(v[v.length-2],v[v.length-1]);for(let N=0;N<v.length-1;N++){const I=v[N+0],P=v[N+1],j=Da(P.x-I.x,P.y-I.y),O=qi(j);if(O===0)continue;let L="unevaluated";const U=p.pointElevation(I),Z=p.pointElevation(P);Math.abs(U)<.01&&Math.abs(Z)<.01?L="entrance":(this.isOnBorder(I.x,P.x)||this.isOnBorder(I.y,P.y))&&(L="border");const G=Wo.computeEdgeHash(I,P);this.unevaluatedPortals.portals.push({connection:{a:i,b:void 0},va:I,vb:P,vab:j,length:O,hash:G,isTunnel:u,type:L});const ee=Wo.computePosHash(I);this.vertexHashLookup.set(ee,{prev:T,next:G}),T=G}}}}construct(i){if(this.unevalVertices.length===0)return;const a=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),u=j=>{j.primitiveLength=this.indexArray.length-j.primitiveOffset},p=new Iq(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(i.portals,this.unevalEdges);const g=a(),y=a(),v=a(),T=(j,O)=>{j.sort((U,Z)=>U.type===O&&Z.type!==O?-1:U.type!==O&&Z.type===O?1:0);const L=j.findIndex(U=>U.type!==O);return L>=0?L:j.length};let N=0;this.unevalEdges.length>0&&(N=T(this.unevalEdges,"none"),this.constructBridgeStructures(p,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:N},this.tileToMeters)),u(v);const I=a(),P=a();if(this.unevalEdges.length>0){const j=this.unevalEdges.splice(N),O=T(j,"tunnel")+N;this.unevalEdges.push(...j),this.constructTunnelStructures(p,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:N},{min:N,max:O})}u(I),p.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),u(P),p.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),u(y),p.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),u(g),this.maskSegments=dn.simpleSegment(0,P.primitiveOffset,0,P.primitiveLength),this.depthSegments=dn.simpleSegment(0,y.primitiveOffset,0,y.primitiveLength),this.renderableBridgeSegments=dn.simpleSegment(0,v.primitiveOffset,0,v.primitiveLength),this.renderableTunnelSegments=dn.simpleSegment(0,I.primitiveOffset,0,I.primitiveLength),this.shadowCasterSegments=dn.simpleSegment(0,g.primitiveOffset,0,g.primitiveLength)}update(i,a,u,p,g,y,v,T){this.bridgeProgramConfigurations.updatePaintArrays(i,a,g,u,p,y,v,T),this.tunnelProgramConfigurations.updatePaintArrays(i,a,g,u,p,y,v,T)}upload(i){this.vertexBuffer||this.vertexPositions.length===0||this.vertexNormals.length===0||this.indexArray.length===0||(this.vertexBuffer=i.createVertexBuffer(this.vertexPositions,yq.members),this.vertexBufferNormal=i.createVertexBuffer(this.vertexNormals,xq.members),this.indexBuffer=i.createIndexBuffer(this.indexArray),this.bridgeProgramConfigurations.upload(i),this.tunnelProgramConfigurations.upload(i))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableBridgeSegments.destroy(),this.renderableTunnelSegments.destroy(),this.shadowCasterSegments.destroy()),this.bridgeProgramConfigurations.destroy(),this.tunnelProgramConfigurations.destroy()}populatePaintArrays(i,a,u,p,g){const y=(v,T)=>{for(let N=0;N<T.length-1;N++){const I=T[N].featureIndex,P=T[N+1].vertexStart,j=i.feature(I);v.populatePaintArrays(P,j,I,{},u,a,p,void 0,g)}};y(this.bridgeProgramConfigurations,this.bridgeFeatureSections),y(this.tunnelProgramConfigurations,this.tunnelFeatureSections)}computeVertexConnections(i,a,u,p,g){const y=new Map;for(let v=p;v<g;v++){const T=u[v],N=T.a,I=T.b,P=Wo.computePosHash(i[N]),j=Wo.computePosHash(i[I]);let O=y.get(P);O||(O={},y.set(P,O));let L=y.get(j);L||(L={},y.set(j,L)),a[N]<=0&&a[I]<=0||(O.to=I,L.from=N)}return y}isTerminalVertex(i,a){const u=Wo.computePosHash(this.unevalVertices[i]),p=a.get(u);return!p||!p.from||!p.to}constructBridgeStructures(i,a,u,p,g,y){i.clearVertexLookup();const v=this.computeVertexConnections(a,u,p,g.min,g.max),T=1/y,N=.5*T,I=(xt,gt)=>Ke(xt,a[gt].x,a[gt].y,u[gt]*T),P=ie(),j=ie(),O=ie(),L=ie(),U=ie(),Z=(xt,gt)=>{const yt=v.get(Wo.computePosHash(a[gt])),st=yt.from,bt=yt.to;if(!st||!bt)return;I(P,st),I(j,gt),I(O,bt),nn(L),Gn(P,j)||(Tr(U,j,P),ni(L,U)),Gn(O,j)||(Tr(U,O,j),Pe(L,L,ni(U,U)));const mt=bi(L);return mt>0?Ot(xt,L,1/mt):void 0};let G=Number.POSITIVE_INFINITY;this.sortSubarray(p,g.min,g.max,(xt,gt)=>xt.featureInfo.featureIndex-gt.featureInfo.featureIndex);const ee=ie(),le=ie(),me=ie(),we=ie(),be=ie(),Re=ie(),Me=ie(),je=ie(),Be=ie(),Ge=[ie(),ie(),ie(),ie()],ut=[ie(),ie(),ie(),ie()],lt=[{coord:new wt(0,0),height:0},{coord:new wt(0,0),height:0}],ct=(xt,gt)=>xt>gt;for(let xt=g.min;xt<g.max;xt++){const gt=p[xt];if(!gt.featureInfo.guardRailEnabled||!this.prepareEdgePoints(lt,a,u,gt,ct))continue;const[yt,st]=lt;if(Ke(ee,yt.coord.x,yt.coord.y,T*yt.height),Ke(le,st.coord.x,st.coord.y,T*st.height),Gn(ee,le))continue;Tr(me,le,ee),ni(me,me);const bt=Z(je,gt.a)||me,mt=Z(Be,gt.b)||me;Ke(we,bt[1],-bt[0],0),ni(we,we),Ke(be,mt[1],-mt[0],0),ni(be,be),Fi(je,we,bt),ni(Re,je),Fi(je,be,mt),ni(Me,je),Pe(Ge[0],ee,Ot(je,Tr(je,we,Re),N)),Pe(Ge[1],ee,Ot(je,Pe(je,we,Re),N)),Pe(Ge[2],ee,Ot(je,Re,N)),Ge[3]=ee,Pe(ut[0],le,Ot(je,Tr(je,be,Me),N)),Pe(ut[1],le,Ot(je,Pe(je,be,Me),N)),Pe(ut[2],le,Ot(je,Me,N)),ut[3]=le,G=this.addFeatureSection(gt.featureInfo.featureIndex,G,this.bridgeFeatureSections,i);const Tt=i.addVertex(Ge[0],we,y),_t=i.addVertex(Ge[1],we,y),Zt=i.addVertex(ut[0],be,y),Xt=i.addVertex(ut[1],be,y);i.addTriangle(Tt,_t,Zt),i.addTriangle(_t,Xt,Zt);const Ft=i.addVertex(Ge[1],Re,y),Vt=i.addVertex(Ge[2],Re,y),xi=i.addVertex(ut[1],Me,y),ri=i.addVertex(ut[2],Me,y);i.addTriangle(Ft,Vt,xi),i.addTriangle(Vt,ri,xi),hi(we,we),hi(be,be);const Gt=i.addVertex(Ge[2],we,y),Ri=i.addVertex(Ge[3],we,y),tr=i.addVertex(ut[2],be,y),Cr=i.addVertex(ut[3],be,y);i.addTriangle(Gt,Ri,tr),i.addTriangle(Ri,Cr,tr);const Qi=this.isTerminalVertex(gt.a,v),Ur=this.isTerminalVertex(gt.b,v);yt.height<.01&&Qi&&i.addQuad(Ge[3],Ge[2],Ge[1],Ge[0],hi(bt,bt),y),st.height<.01&&Ur&&i.addQuad(ut[0],ut[1],ut[2],ut[3],mt,y)}this.bridgeFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:i.getVertexCount()})}constructTunnelStructures(i,a,u,p,g,y){i.clearVertexLookup();let v=Number.POSITIVE_INFINITY;const T=(G,ee)=>G.featureInfo.featureIndex-ee.featureInfo.featureIndex;this.sortSubarray(p,g.min,g.max,T),this.sortSubarray(p,y.min,y.max,T);const N=G=>ni(G,G),I=[{coord:new wt(0,0),height:0},{coord:new wt(0,0),height:0}],P=(G,ee)=>G<ee,j=ie(),O=ie(),L=ie(),U=ie(),Z=ie();for(let G=g.min;G<g.max;G++){if(!this.prepareEdgePoints(I,a,u,p[G],P))continue;const[ee,le]=I,me=N(Ke(Z,-(le.coord.y-ee.coord.y),le.coord.x-ee.coord.x,0));v=this.addFeatureSection(p[G].featureInfo.featureIndex,v,this.tunnelFeatureSections,i),i.addQuad(Ke(j,ee.coord.x,ee.coord.y,ee.height),Ke(O,le.coord.x,le.coord.y,le.height),Ke(L,le.coord.x,le.coord.y,p[G].isTunnel?-.1:0),Ke(U,ee.coord.x,ee.coord.y,p[G].isTunnel?-.1:0),me)}for(let G=y.min;G<y.max;G++){const ee=p[G];ee.isTunnel&&([ee.a,ee.b]=[ee.b,ee.a]);const le=a[ee.a],me=a[ee.b],we=N(Ke(Z,-(me.y-le.y),me.x-le.x,0));v=this.addFeatureSection(ee.featureInfo.featureIndex,v,this.tunnelFeatureSections,i),i.addQuad(Ke(j,me.x,me.y,0),Ke(O,le.x,le.y,0),Ke(L,le.x,le.y,u[ee.a]+4),Ke(U,me.x,me.y,u[ee.b]+4),we),i.addQuad(Ke(j,le.x,le.y,0),Ke(O,me.x,me.y,0),Ke(L,me.x,me.y,u[ee.b]+4),Ke(U,le.x,le.y,u[ee.a]+4),we)}this.tunnelFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:i.getVertexCount()})}setElevatedPoint(i,a,u,p){i.coord.x=a,i.coord.y=u,i.height=p}prepareEdgePoints(i,a,u,p,g){let y=a[p.a].x,v=a[p.a].y,T=a[p.b].x,N=a[p.b].y,I=u[p.a],P=u[p.b];const j=g(I,0),O=g(P,0);if(j&&O)return this.setElevatedPoint(i[0],y,v,I),this.setElevatedPoint(i[1],T,N,P),!0;if(!j&&!O)return!1;if(j){if(!O){const L=P/(P-I);T=Si(T,y,L),N=Si(N,v,L),P=Si(P,I,L)}}else{const L=I/(I-P);y=Si(y,T,L),v=Si(v,N,L),I=Si(I,P,L)}return this.setElevatedPoint(i[0],y,v,I),this.setElevatedPoint(i[1],T,N,P),!0}prepareEdges(i,a){if(a.length===0)return;a.sort((v,T)=>v.hash===T.hash?T.polygonIdx-v.polygonIdx:T.hash>v.hash?1:-1);let u=0,p=0,g=0,y=a[u].polygonIdx;do p++,(p===a.length||a[u].hash!==a[p].hash)&&((p-u===1||a[p-1].polygonIdx!==y)&&(g<u&&(a[g]=a[u],a[u]=null),a[g].type="none",g++),u=p,u!==a.length&&(y=a[u].polygonIdx));while(u!==a.length);if(a.splice(g),a.length!==0&&i.length!==0){a.sort((N,I)=>N.portalHash<I.portalHash?1:-1);let v=0,T=0;for(;v!==a.length&&T!==i.length;){const N=a[v],I=i[T];N.portalHash>I.hash?v++:I.hash>N.portalHash?T++:(N.type=I.type,v++)}}}isOnBorder(i,a){return i<=0&&a<=0||i>=Bt&&a>=Bt}addFeatureSection(i,a,u,p){return i!==a&&(a=i,u.push({featureIndex:i,vertexStart:p.getVertexCount()}),p.clearVertexLookup()),a}sortSubarray(i,a,u,p){const g=i.slice(a,u);g.sort(p),i.splice(a,g.length,...g)}static computeEdgeHash(i,a){return(i.y===a.y&&i.x>a.x||i.y>a.y)&&([i,a]=[a,i]),BigInt(Wo.computePosHash(i))<<32n|BigInt(Wo.computePosHash(a))}static computePosHash(i){return((65535&i.x)<<16|65535&i.y)>>>0}}function Pq(l,i){return l>i?1:l<i?-1:0}class IN{constructor(i=Pq,a=!1){this._compare=i,this._root=null,this._size=0,this._noDuplicates=!!a}rotateLeft(i){var a=i.right;a&&(i.right=a.left,a.left&&(a.left.parent=i),a.parent=i.parent),i.parent?i===i.parent.left?i.parent.left=a:i.parent.right=a:this._root=a,a&&(a.left=i),i.parent=a}rotateRight(i){var a=i.left;a&&(i.left=a.right,a.right&&(a.right.parent=i),a.parent=i.parent),i.parent?i===i.parent.left?i.parent.left=a:i.parent.right=a:this._root=a,a&&(a.right=i),i.parent=a}_splay(i){for(;i.parent;){var a=i.parent;a.parent?a.left===i&&a.parent.left===a?(this.rotateRight(a.parent),this.rotateRight(a)):a.right===i&&a.parent.right===a?(this.rotateLeft(a.parent),this.rotateLeft(a)):a.left===i&&a.parent.right===a?(this.rotateRight(a),this.rotateLeft(a)):(this.rotateLeft(a),this.rotateRight(a)):a.left===i?this.rotateRight(a):this.rotateLeft(a)}}splay(i){for(var a,u,p,g,y;i.parent;)(u=(a=i.parent).parent)&&u.parent?((p=u.parent).left===u?p.left=i:p.right=i,i.parent=p):(i.parent=null,this._root=i),g=i.left,y=i.right,i===a.left?(u&&(u.left===a?(a.right?(u.left=a.right,u.left.parent=u):u.left=null,a.right=u,u.parent=a):(g?(u.right=g,g.parent=u):u.right=null,i.left=u,u.parent=i)),y?(a.left=y,y.parent=a):a.left=null,i.right=a,a.parent=i):(u&&(u.right===a?(a.left?(u.right=a.left,u.right.parent=u):u.right=null,a.left=u,u.parent=a):(y?(u.left=y,y.parent=u):u.left=null,i.right=u,u.parent=i)),g?(a.right=g,g.parent=a):a.right=null,i.left=a,a.parent=i)}replace(i,a){i.parent?i===i.parent.left?i.parent.left=a:i.parent.right=a:this._root=a,a&&(a.parent=i.parent)}minNode(i=this._root){if(i)for(;i.left;)i=i.left;return i}maxNode(i=this._root){if(i)for(;i.right;)i=i.right;return i}insert(i,a){var u=this._root,p=null,g=this._compare;if(this._noDuplicates)for(;u;){if(p=u,g(u.key,i)===0)return;u=g(u.key,i)<0?u.right:u.left}else for(;u;)p=u,u=g(u.key,i)<0?u.right:u.left;return u={key:i,data:a,left:null,right:null,parent:p},p?g(p.key,u.key)<0?p.right=u:p.left=u:this._root=u,this.splay(u),this._size++,u}find(i){for(var a=this._root,u=this._compare;a;){var p=u(a.key,i);if(p<0)a=a.right;else{if(!(p>0))return a;a=a.left}}return null}contains(i){for(var a=this._root,u=this._compare;a;){var p=u(i,a.key);if(p===0)return!0;a=p<0?a.left:a.right}return!1}remove(i){var a=this.find(i);if(!a)return!1;if(this.splay(a),a.left)if(a.right){var u=this.minNode(a.right);u.parent!==a&&(this.replace(u,u.right),u.right=a.right,u.right.parent=u),this.replace(a,u),u.left=a.left,u.left.parent=u}else this.replace(a,a.left);else this.replace(a,a.right);return this._size--,!0}removeNode(i){if(!i)return!1;if(this.splay(i),i.left)if(i.right){var a=this.minNode(i.right);a.parent!==i&&(this.replace(a,a.right),a.right=i.right,a.right.parent=a),this.replace(i,a),a.left=i.left,a.left.parent=a}else this.replace(i,i.left);else this.replace(i,i.right);return this._size--,!0}erase(i){var a=this.find(i);if(a){this.splay(a);var u=a.left,p=a.right,g=null;u&&(u.parent=null,g=this.maxNode(u),this.splay(g),this._root=g),p&&(u?g.right=p:this._root=p,p.parent=g),this._size--}}pop(){var i=this._root,a=null;if(i){for(;i.left;)i=i.left;a={key:i.key,data:i.data},this.remove(i.key)}return a}next(i){var a=i;if(a)if(a.right)for(a=a.right;a&&a.left;)a=a.left;else for(a=i.parent;a&&a.right===i;)i=a,a=a.parent;return a}prev(i){var a=i;if(a)if(a.left)for(a=a.left;a&&a.right;)a=a.right;else for(a=i.parent;a&&a.left===i;)i=a,a=a.parent;return a}forEach(i){for(var a=this._root,u=[],p=!1,g=0;!p;)a?(u.push(a),a=a.left):u.length>0?(i(a=u.pop(),g++),a=a.right):p=!0;return this}range(i,a,u,p){const g=[],y=this._compare;let v,T=this._root;for(;g.length!==0||T;)if(T)g.push(T),T=T.left;else{if(T=g.pop(),v=y(T.key,a),v>0)break;if(y(T.key,i)>=0&&u.call(p,T))return this;T=T.right}return this}keys(){for(var i=this._root,a=[],u=[],p=!1;!p;)i?(a.push(i),i=i.left):a.length>0?(i=a.pop(),u.push(i.key),i=i.right):p=!0;return u}values(){for(var i=this._root,a=[],u=[],p=!1;!p;)i?(a.push(i),i=i.left):a.length>0?(i=a.pop(),u.push(i.data),i=i.right):p=!0;return u}at(i){for(var a=this._root,u=[],p=!1,g=0;!p;)if(a)u.push(a),a=a.left;else if(u.length>0){if(a=u.pop(),g===i)return a;g++,a=a.right}else p=!0;return null}load(i=[],a=[],u=!1){if(this._size!==0)throw new Error("bulk-load: tree is not empty");const p=i.length;return u&&jN(i,a,0,p-1,this._compare),this._root=PN(null,i,a,0,p),this._size=p,this}min(){var i=this.minNode(this._root);return i?i.key:null}max(){var i=this.maxNode(this._root);return i?i.key:null}isEmpty(){return this._root===null}get size(){return this._size}static createTree(i,a,u,p,g){return new IN(u,g).load(i,a,p)}}function PN(l,i,a,u,p){const g=p-u;if(g>0){const y=u+Math.floor(g/2),v={key:i[y],data:a[y],parent:l};return v.left=PN(v,i,a,u,y),v.right=PN(v,i,a,y+1,p),v}return null}function jN(l,i,a,u,p){if(a>=u)return;const g=l[a+u>>1];let y=a-1,v=u+1;for(;;){do y++;while(p(l[y],g)<0);do v--;while(p(l[v],g)>0);if(y>=v)break;let T=l[y];l[y]=l[v],l[v]=T,T=i[y],i[y]=i[v],i[v]=T}jN(l,i,a,v,p),jN(l,i,v+1,u,p)}const DR=11102230246251565e-32,So=134217729,jq=(3+8*DR)*DR;function RN(l,i,a,u,p){let g,y,v,T,N=i[0],I=u[0],P=0,j=0;I>N==I>-N?(g=N,N=i[++P]):(g=I,I=u[++j]);let O=0;if(P<l&&j<a)for(I>N==I>-N?(y=N+g,v=g-(y-N),N=i[++P]):(y=I+g,v=g-(y-I),I=u[++j]),g=y,v!==0&&(p[O++]=v);P<l&&j<a;)I>N==I>-N?(y=g+N,T=y-g,v=g-(y-T)+(N-T),N=i[++P]):(y=g+I,T=y-g,v=g-(y-T)+(I-T),I=u[++j]),g=y,v!==0&&(p[O++]=v);for(;P<l;)y=g+N,T=y-g,v=g-(y-T)+(N-T),N=i[++P],g=y,v!==0&&(p[O++]=v);for(;j<a;)y=g+I,T=y-g,v=g-(y-T)+(I-T),I=u[++j],g=y,v!==0&&(p[O++]=v);return g===0&&O!==0||(p[O++]=g),O}function A_(l){return new Float64Array(l)}const vg=A_(4),MR=A_(8),OR=A_(12),LR=A_(16),Zo=A_(4);function C_(l,i,a){i===null?(l.inOut=!1,l.otherInOut=!0):(l.isSubject===i.isSubject?(l.inOut=!i.inOut,l.otherInOut=i.otherInOut):(l.inOut=!i.otherInOut,l.otherInOut=i.isVertical()?!i.inOut:i.inOut),i&&(l.prevInResult=!FR(i,a)||i.isVertical()?i.prevInResult:i)),l.resultTransition=FR(l,a)?function(u,p){let g,y=!u.inOut,v=!u.otherInOut;switch(p){case 0:g=y&&v;break;case 1:g=y||v;break;case 3:g=y!==v;break;case 2:g=u.isSubject?y&&!v:v&&!y}return g?1:-1}(l,a):0}function FR(l,i){switch(l.type){case 0:switch(i){case 0:return!l.otherInOut;case 1:return l.otherInOut;case 2:return l.isSubject&&l.otherInOut||!l.isSubject&&!l.otherInOut;case 3:return!0}break;case 2:return i===0||i===1;case 3:return i===2;case 1:return!1}return!1}class bg{constructor(i,a,u,p,g){this.left=a,this.point=i,this.otherEvent=u,this.isSubject=p??!1,this.type=g||0,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0}isBelow(i){const a=this.point,u=this.otherEvent.point;return this.left?(a[0]-i[0])*(u[1]-i[1])-(u[0]-i[0])*(a[1]-i[1])>0:(u[0]-i[0])*(a[1]-i[1])-(a[0]-i[0])*(u[1]-i[1])>0}isAbove(i){return!this.isBelow(i)}isVertical(){return this.point[0]===this.otherEvent.point[0]}get inResult(){return this.resultTransition!==0}clone(){const i=new bg(this.point,this.left,this.otherEvent,this.isSubject,this.type);return i.contourId=this.contourId,i.resultTransition=this.resultTransition,i.prevInResult=this.prevInResult,i.isExteriorRing=this.isExteriorRing,i.inOut=this.inOut,i.otherInOut=this.otherInOut,i}}function Au(l,i){return l[0]===i[0]&&l[1]===i[1]}function kN(l,i,a){const u=function(p,g,y,v,T,N){const I=(g-N)*(y-T),P=(p-T)*(v-N),j=I-P;if(I===0||P===0||I>0!=P>0)return j;const O=Math.abs(I+P);return Math.abs(j)>=33306690738754716e-32*O?j:-function(L,U,Z,G,ee,le,me){let we,be,Re,Me,je,Be,Ge,ut,lt,ct,xt,gt,yt,st,bt,mt,Tt,_t;const Zt=L-ee,Xt=Z-ee,Ft=U-le,Vt=G-le;st=Zt*Vt,Be=So*Zt,Ge=Be-(Be-Zt),ut=Zt-Ge,Be=So*Vt,lt=Be-(Be-Vt),ct=Vt-lt,bt=ut*ct-(st-Ge*lt-ut*lt-Ge*ct),mt=Ft*Xt,Be=So*Ft,Ge=Be-(Be-Ft),ut=Ft-Ge,Be=So*Xt,lt=Be-(Be-Xt),ct=Xt-lt,Tt=ut*ct-(mt-Ge*lt-ut*lt-Ge*ct),xt=bt-Tt,je=bt-xt,vg[0]=bt-(xt+je)+(je-Tt),gt=st+xt,je=gt-st,yt=st-(gt-je)+(xt-je),xt=yt-mt,je=yt-xt,vg[1]=yt-(xt+je)+(je-mt),_t=gt+xt,je=_t-gt,vg[2]=gt-(_t-je)+(xt-je),vg[3]=_t;let xi=function(Cr,Qi){let Ur=Qi[0];for(let fr=1;fr<4;fr++)Ur+=Qi[fr];return Ur}(0,vg),ri=22204460492503146e-32*me;if(xi>=ri||-xi>=ri||(je=L-Zt,we=L-(Zt+je)+(je-ee),je=Z-Xt,Re=Z-(Xt+je)+(je-ee),je=U-Ft,be=U-(Ft+je)+(je-le),je=G-Vt,Me=G-(Vt+je)+(je-le),we===0&&be===0&&Re===0&&Me===0)||(ri=11093356479670487e-47*me+jq*Math.abs(xi),xi+=Zt*Me+Vt*we-(Ft*Re+Xt*be),xi>=ri||-xi>=ri))return xi;st=we*Vt,Be=So*we,Ge=Be-(Be-we),ut=we-Ge,Be=So*Vt,lt=Be-(Be-Vt),ct=Vt-lt,bt=ut*ct-(st-Ge*lt-ut*lt-Ge*ct),mt=be*Xt,Be=So*be,Ge=Be-(Be-be),ut=be-Ge,Be=So*Xt,lt=Be-(Be-Xt),ct=Xt-lt,Tt=ut*ct-(mt-Ge*lt-ut*lt-Ge*ct),xt=bt-Tt,je=bt-xt,Zo[0]=bt-(xt+je)+(je-Tt),gt=st+xt,je=gt-st,yt=st-(gt-je)+(xt-je),xt=yt-mt,je=yt-xt,Zo[1]=yt-(xt+je)+(je-mt),_t=gt+xt,je=_t-gt,Zo[2]=gt-(_t-je)+(xt-je),Zo[3]=_t;const Gt=RN(4,vg,4,Zo,MR);st=Zt*Me,Be=So*Zt,Ge=Be-(Be-Zt),ut=Zt-Ge,Be=So*Me,lt=Be-(Be-Me),ct=Me-lt,bt=ut*ct-(st-Ge*lt-ut*lt-Ge*ct),mt=Ft*Re,Be=So*Ft,Ge=Be-(Be-Ft),ut=Ft-Ge,Be=So*Re,lt=Be-(Be-Re),ct=Re-lt,Tt=ut*ct-(mt-Ge*lt-ut*lt-Ge*ct),xt=bt-Tt,je=bt-xt,Zo[0]=bt-(xt+je)+(je-Tt),gt=st+xt,je=gt-st,yt=st-(gt-je)+(xt-je),xt=yt-mt,je=yt-xt,Zo[1]=yt-(xt+je)+(je-mt),_t=gt+xt,je=_t-gt,Zo[2]=gt-(_t-je)+(xt-je),Zo[3]=_t;const Ri=RN(Gt,MR,4,Zo,OR);st=we*Me,Be=So*we,Ge=Be-(Be-we),ut=we-Ge,Be=So*Me,lt=Be-(Be-Me),ct=Me-lt,bt=ut*ct-(st-Ge*lt-ut*lt-Ge*ct),mt=be*Re,Be=So*be,Ge=Be-(Be-be),ut=be-Ge,Be=So*Re,lt=Be-(Be-Re),ct=Re-lt,Tt=ut*ct-(mt-Ge*lt-ut*lt-Ge*ct),xt=bt-Tt,je=bt-xt,Zo[0]=bt-(xt+je)+(je-Tt),gt=st+xt,je=gt-st,yt=st-(gt-je)+(xt-je),xt=yt-mt,je=yt-xt,Zo[1]=yt-(xt+je)+(je-mt),_t=gt+xt,je=_t-gt,Zo[2]=gt-(_t-je)+(xt-je),Zo[3]=_t;const tr=RN(Ri,OR,4,Zo,LR);return LR[tr-1]}(p,g,y,v,T,N,O)}(l[0],l[1],i[0],i[1],a[0],a[1]);return u>0?-1:u<0?1:0}function Eh(l,i){const a=l.point,u=i.point;return a[0]>u[0]?1:a[0]<u[0]?-1:a[1]!==u[1]?a[1]>u[1]?1:-1:function(p,g,y){return p.left!==g.left?p.left?1:-1:kN(y,p.otherEvent.point,g.otherEvent.point)!==0?p.isBelow(g.otherEvent.point)?-1:1:!p.isSubject&&g.isSubject?1:-1}(l,i,a)}function Ih(l,i,a){const u=new bg(i,!1,l,l.isSubject),p=new bg(i,!0,l.otherEvent,l.isSubject);return Au(l.point,l.otherEvent.point)&&console.warn("what is that, a collapsed segment?",l),u.contourId=p.contourId=l.contourId,Eh(p,l.otherEvent)>0&&(l.otherEvent.left=!0,p.left=!1),l.otherEvent.otherEvent=p,l.otherEvent=u,a.push(p),a.push(u),a}function A1(l,i){return l[0]*i[1]-l[1]*i[0]}function DN(l,i){return l[0]*i[0]+l[1]*i[1]}function MN(l,i,a){const u=function(T,N,I,P){const j=[N[0]-T[0],N[1]-T[1]],O=[P[0]-I[0],P[1]-I[1]];function L(Re,Me,je){return[Re[0]+Me*je[0],Re[1]+Me*je[1]]}const U=[I[0]-T[0],I[1]-T[1]];let Z=A1(j,O),G=Z*Z;const ee=DN(j,j);if(G>0){const Re=A1(U,O)/Z;if(Re<0||Re>1)return null;const Me=A1(U,j)/Z;return Me<0||Me>1?null:Re===0||Re===1?[L(T,Re,j)]:Me===0||Me===1?[L(I,Me,O)]:[L(T,Re,j)]}if(Z=A1(U,j),G=Z*Z,G>0)return null;const le=DN(j,U)/ee,me=le+DN(j,O)/ee,we=Math.min(le,me),be=Math.max(le,me);return we<=1&&be>=0?we===1?[L(T,we>0?we:0,j)]:be===0?[L(T,be<1?be:1,j)]:[L(T,we>0?we:0,j),L(T,be<1?be:1,j)]:null}(l.point,l.otherEvent.point,i.point,i.otherEvent.point),p=u?u.length:0;if(p===0||p===1&&(Au(l.point,i.point)||Au(l.otherEvent.point,i.otherEvent.point))||p===2&&l.isSubject===i.isSubject)return 0;if(p===1)return!Au(l.point,u[0])&&!Au(l.otherEvent.point,u[0])&&Ih(l,u[0],a),!Au(i.point,u[0])&&!Au(i.otherEvent.point,u[0])&&Ih(i,u[0],a),1;const g=[];let y=!1,v=!1;return Au(l.point,i.point)?y=!0:Eh(l,i)===1?g.push(i,l):g.push(l,i),Au(l.otherEvent.point,i.otherEvent.point)?v=!0:Eh(l.otherEvent,i.otherEvent)===1?g.push(i.otherEvent,l.otherEvent):g.push(l.otherEvent,i.otherEvent),y&&v||y?(i.type=1,l.type=i.inOut===l.inOut?2:3,y&&!v&&Ih(g[1].otherEvent,g[0].point,a),2):v?(Ih(g[0],g[1].point,a),3):g[0]!==g[3].otherEvent?(Ih(g[0],g[1].point,a),Ih(g[1],g[2].point,a),3):(Ih(g[0],g[1].point,a),Ih(g[3].otherEvent,g[2].point,a),3)}function Rq(l,i){if(l===i)return 0;if(kN(l.point,l.otherEvent.point,i.point)!==0||kN(l.point,l.otherEvent.point,i.otherEvent.point)!==0)return Au(l.point,i.point)?l.isBelow(i.otherEvent.point)?-1:1:l.point[0]===i.point[0]?l.point[1]<i.point[1]?-1:1:Eh(l,i)===1?i.isAbove(l.point)?-1:1:l.isBelow(i.point)?-1:1;if(l.isSubject!==i.isSubject)return l.isSubject?-1:1;{let a=l.point,u=i.point;if(a[0]===u[0]&&a[1]===u[1])return a=l.otherEvent.point,u=i.otherEvent.point,a[0]===u[0]&&a[1]===u[1]?0:(l.contourId??0)>(i.contourId??0)?1:-1}return Eh(l,i)===1?1:-1}class kq{constructor(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null}isExterior(){return this.holeOf==null}}function Dq(l,i,a,u){let p,g=l+1,y=i[l].point;const v=i.length;for(g<v&&(p=i[g].point);g<v&&p[0]===y[0]&&p[1]===y[1];){if(!a[g])return g;g++,g<v&&(p=i[g].point)}for(g=l-1;a[g]&&g>u;)g--;return g}function Mq(l,i,a){const u=new kq;if(l.prevInResult!=null){const p=l.prevInResult,g=p.outputContourId;if(p.resultTransition>0){const y=i[g];if(y.holeOf!=null){const v=y.holeOf;i[v].holeIds.push(a),u.holeOf=v,u.depth=i[g].depth}else i[g].holeIds.push(a),u.holeOf=g,u.depth=i[g].depth+1}else u.holeOf=null,u.depth=i[g].depth}else u.holeOf=null,u.depth=0;return u}const zR=Math.max,BR=Math.min;let C1=0;function VR(l,i,a,u,p,g){let y,v,T,N,I,P;for(y=0,v=l.length-1;y<v;y++){if(T=l[y],N=l[y+1],I=new bg(T,!1,void 0,i),P=new bg(N,!1,I,i),I.otherEvent=P,T[0]===N[0]&&T[1]===N[1])continue;I.contourId=P.contourId=a,g||(I.isExteriorRing=!1,P.isExteriorRing=!1),Eh(I,P)>0?P.left=!0:I.left=!0;const j=T[0],O=T[1];p[0]=BR(p[0],j),p[1]=BR(p[1],O),p[2]=zR(p[2],j),p[3]=zR(p[3],O),u.push(I),u.push(P)}}const E1=[];function UR(l,i,a){let u=l,p=i;typeof l[0][0][0]=="number"&&(u=[l]),typeof i[0][0][0]=="number"&&(p=[i]);let g=function(j,O,L){let U=null;return j.length*O.length===0&&(L===0?U=E1:L===2?U=j:(L===1||L===3)&&(U=j.length===0?O:j)),U}(u,p,a);if(g)return g===E1?null:g;const y=[1/0,1/0,-1/0,-1/0],v=[1/0,1/0,-1/0,-1/0],T=function(j,O,L,U,Z){const G=new Zp(void 0,Eh);let ee,le,me,we,be,Re;for(me=0,we=j.length;me<we;me++)for(ee=j[me],be=0,Re=ee.length;be<Re;be++)le=be===0,le&&C1++,VR(ee[be],!0,C1,G,L,le);for(me=0,we=O.length;me<we;me++)for(ee=O[me],be=0,Re=ee.length;be<Re;be++)le=be===0,Z===2&&(le=!1),le&&C1++,VR(ee[be],!1,C1,G,U,le);return G}(u,p,y,v,a);if(g=function(j,O,L,U,Z){let G=null;return(L[0]>U[2]||U[0]>L[2]||L[1]>U[3]||U[1]>L[3])&&(Z===0?G=E1:Z===2?G=j:(Z===1||Z===3)&&(G=j.concat(O))),G}(u,p,y,v,a),g)return g===E1?null:g;const N=function(j,O,L,U,Z,G){const ee=new IN(Rq),le=[],me=Math.min(U[2],Z[2]);let we,be,Re;for(;j.length!==0;){let Me=j.pop();if(le.push(Me),G===0&&Me.point[0]>me||G===2&&Me.point[0]>U[2])break;if(Me.left){be=we=ee.insert(Me),Re=ee.minNode(),we=we!==Re?ee.prev(we):null,be=ee.next(be);const je=we?we.key:null;let Be;if(C_(Me,je,G),be&&MN(Me,be.key,j)===2&&(C_(Me,je,G),C_(be.key,Me,G)),we&&MN(we.key,Me,j)===2){let Ge=we;Ge=Ge!==Re?ee.prev(Ge):null,Be=Ge?Ge.key:null,C_(je,Be,G),C_(Me,je,G)}}else Me=Me.otherEvent,be=we=ee.find(Me),we&&be&&(we=we!==Re?ee.prev(we):null,be=ee.next(be),ee.remove(Me),be&&we&&MN(we.key,be.key,j))}return le}(T,0,0,y,v,a),I=function(j){let O,L;const U=function(ee){let le,me,we,be,Re;const Me=[];for(me=0,we=ee.length;me<we;me++)le=ee[me],(le.left&&le.inResult||!le.left&&le.otherEvent.inResult)&&Me.push(le);let je=!1;for(;!je;)for(je=!0,me=0,we=Me.length;me<we;me++)me+1<we&&Eh(Me[me],Me[me+1])===1&&(be=Me[me],Me[me]=Me[me+1],Me[me+1]=be,je=!1);for(me=0,we=Me.length;me<we;me++)le=Me[me],le.otherPos=me;for(me=0,we=Me.length;me<we;me++)le=Me[me],le.left||(Re=le.otherPos,le.otherPos=le.otherEvent.otherPos,le.otherEvent.otherPos=Re);return Me}(j),Z={},G=[];for(O=0,L=U.length;O<L;O++){if(Z[O])continue;const ee=G.length,le=Mq(U[O],G,ee),me=Re=>{Z[Re]=!0,Re<U.length&&U[Re]&&(U[Re].outputContourId=ee)};let we=O,be=O;for(le.points.push(U[O].point);me(we),we=U[we].otherPos,me(we),le.points.push(U[we].point),we=Dq(we,U,Z,be),!(we==be||we>=U.length)&&U[we];);G.push(le)}return G}(N),P=[];for(let j=0;j<I.length;j++){let O=I[j];if(O.isExterior()){let L=[O.points];for(let U=0;U<O.holeIds.length;U++)L.push(I[O.holeIds[U]].points);P.push(L)}}return P}function I1(l,i,a,u){const p=[],g=u===0?(y,v,T,N,I,P)=>{y.push(new wt(P,T+(P-v)/(N-v)*(I-T)))}:(y,v,T,N,I,P)=>{y.push(new wt(v+(P-T)/(I-T)*(N-v),P))};for(const y of l){const v=[];for(const T of y){if(T.length<=2)continue;const N=[];for(let j=0;j<T.length-1;j++){const O=T[j].x,L=T[j].y,U=T[j+1].x,Z=T[j+1].y,G=u===0?O:L,ee=u===0?U:Z;G<i?ee>i&&g(N,O,L,U,Z,i):G>a?ee<a&&g(N,O,L,U,Z,a):N.push(T[j]),ee<i&&G>=i&&g(N,O,L,U,Z,i),ee>a&&G<=a&&g(N,O,L,U,Z,a)}let I=T[T.length-1];const P=u===0?I.x:I.y;P>=i&&P<=a&&N.push(I),N.length&&(I=N[N.length-1],N[0].x===I.x&&N[0].y===I.y||N.push(N[0]),v.push(N))}v.length&&p.push(v)}return p}function Oq(l,i){const a=UR(ON(l),ON([i]),0);return a==null?[]:qR(a)}function Lq(l,i){let u=ON(l,65536);const p=[];for(;i.valid();i.next()){const[g,y]=i.get(),v=g.x*65536,T=g.y*65536,N=y.x*65536,I=y.y*65536,P=N-v,j=I-T,O=Math.hypot(P,j);if(O===0)continue;const L=Math.trunc(j/O*3),U=-Math.trunc(P/O*3);p.push([[[v,T],[N,I],[N+L,I+U],[v+L,T+U],[v,T]]])}return p.length>0&&(u=UR(u,p,2)),qR(u,1/65536,128)}function ON(l,i=1){return[l.map(a=>a.map(u=>[u.x*i,u.y*i]))]}function qR(l,i=1,a){return l.map(u=>u.map((p,g)=>{const y=p.map(v=>{let T=v[0],N=v[1];return a&&(T=Math.round(T/a)*a,N=Math.round(N/a)*a),new wt(T*i,N*i)._round()});return g>0&&y.reverse(),y}))}class LN{constructor(i,a){this.layoutVertexArray=new Su,this.indexArray=new ys,this.lineIndexArray=new qo,this.triangleSegments=new dn,this.lineSegments=new dn,this.programConfigurations=new M(i.layers,{zoom:i.zoom,lut:i.lut}),this.uploaded=!1,a&&(this.elevatedLayoutVertexArray=new Qs)}update(i,a,u,p,g,y,v,T){this.programConfigurations.updatePaintArrays(i,a,g,u,p,y,v,T)}isEmpty(){return this.layoutVertexArray.length===0}needsUpload(){return this.programConfigurations.needsUpload}upload(i){this.uploaded||(this.layoutVertexBuffer=i.createVertexBuffer(this.layoutVertexArray,fq.members),this.indexBuffer=i.createIndexBuffer(this.indexArray),this.lineIndexBuffer=i.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=i.createVertexBuffer(this.elevatedLayoutVertexArray,gq.members))),this.programConfigurations.upload(i),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(i,a,u,p,g,y,v){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,i,a,u,p,g,y,void 0,v)}}class FN{constructor(i){this.zoom=i.zoom,this.pixelRatio=i.pixelRatio,this.overscaling=i.overscaling,this.layers=i.layers,this.layerIds=this.layers.map(a=>a.fqid),this.index=i.index,this.hasPattern=!1,this.patternFeatures=[],this.lut=i.lut,this.bufferData=new LN(i,!1),this.elevationBufferData=new LN(i,!0),this.stateDependentLayerIds=this.layers.filter(a=>a.isStateDependent()).map(a=>a.id),this.projection=i.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference"),this.sourceLayerIndex=i.sourceLayerIndex,this.worldview=i.worldview,this.hasAppearances=null}updateFootprints(i,a){}updateAppearances(i,a,u,p){}populate(i,a,u,p){this.hasPattern=CN("fill",this.layers,this.pixelRatio,a);const g=this.layers[0].layout.get("fill-sort-key"),y=[];for(const{feature:v,id:T,index:N,sourceLayerIndex:I}of i){const P=this.layers[0]._featureFilter.needGeometry,j=Hi(v,P);if(!this.layers[0]._featureFilter.filter(new Vr(this.zoom,{worldview:this.worldview,activeFloors:a.activeFloors}),j,u))continue;const O=g?g.evaluate(j,{},u,a.availableImages):void 0,L={id:T,properties:v.properties,type:v.type,sourceLayerIndex:I,index:N,geometry:P?j.geometry:Ci(v,u,p),patterns:{},sortKey:O};y.push(L)}g&&y.sort((v,T)=>v.sortKey-T.sortKey);for(const v of y){const{geometry:T,index:N,sourceLayerIndex:I}=v;if(this.hasPattern){const P=EN("fill",this.layers,v,this.zoom,this.pixelRatio,a);this.patternFeatures.push(P)}else this.addFeature(v,T,N,u,{},a.availableImages,a.brightness,a.elevationFeatures);a.featureIndex.insert(i[N].feature,T,N,I,this.index)}}update(i,a,u,p,g,y,v){this.bufferData.update(i,a,u,p,g,y,v,this.worldview),this.elevationBufferData.update(i,a,u,p,g,y,v,this.worldview),this.elevatedStructures&&this.elevatedStructures.update(i,a,u,p,g,y,v,this.worldview)}addFeatures(i,a,u,p,g,y){for(const v of this.patternFeatures)this.addFeature(v,v.geometry,v.index,a,u,p,y,i.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(i){this.bufferData.upload(i),this.elevationBufferData.upload(i),this.elevatedStructures&&this.elevatedStructures.upload(i)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(i,a,u,p,g,y=[],v,T){const N=N_(a,500);this.elevationMode!=="none"?this.addElevatedRoadFeature(i,N,p,u,T):this.addGeometry(N,this.bufferData),this.bufferData.populatePaintArrays(i,u,g,y,p,v,this.worldview),this.elevationBufferData.populatePaintArrays(i,u,g,y,p,v,this.worldview)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}setEvaluatedPortalGraph(i,a,u,p,g){this.elevatedStructures&&(this.elevatedStructures.construct(i),this.elevatedStructures.populatePaintArrays(a,u,p,g,this.worldview))}addElevatedRoadFeature(i,a,u,p,g){const y=new Array,v=no.getElevationFeature(i,g);if(!v)return void this.addGeometry(a,this.bufferData);{const N=this.clipPolygonsToTile(a,1);N.length>0&&y.push({polygons:N,elevationFeature:v,elevationTileID:u})}const T={guardRailEnabled:this.layers[0].layout.get("fill-construct-bridge-guard-rail").evaluate(i,{},u),featureIndex:p};for(const N of y)if(N.elevationFeature){if(this.elevationMode==="hd-road-base"){this.elevatedStructures||(this.elevatedStructures=new Wo(N.elevationTileID,this.layers,this.zoom,this.lut));const P=N.elevationFeature.isTunnel();let j=0;i.properties.hasOwnProperty(Ui)&&(j=+i.properties[Ui]),this.elevatedStructures.addPortalCandidates(N.elevationFeature.id,N.polygons,P,N.elevationFeature,j)}N.elevationFeature.constantHeight==null&&(N.polygons=this.prepareElevatedPolygons(N.polygons,N.elevationFeature,N.elevationTileID));const I=new ml(u,N.elevationTileID);this.addElevatedGeometry(N.polygons,I,N.elevationFeature,this.elevationMode==="hd-road-base"?0:.05,p,T)}}addElevatedGeometry(i,a,u,p,g,y){const v={elevation:u,elevationSampler:a,bias:p,index:g,featureInfo:y},[T,N]=this.addGeometry(i,this.elevationBufferData,v);this.elevationBufferData.heightRange==null?this.elevationBufferData.heightRange={min:T,max:N}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,T),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,N))}addGeometry(i,a,u){let p=Number.POSITIVE_INFINITY,g=Number.NEGATIVE_INFINITY,y=null;u&&(y=u.elevationSampler.constantElevation(u.elevation,u.bias),y!=null&&(p=y,g=y));const v=(T,N,I)=>{if(u!=null)if(N.push(T),y!=null)a.elevatedLayoutVertexArray.emplaceBack(y),I.push(y);else{const P=u.elevationSampler.pointElevation(T,u.elevation,u.bias);a.elevatedLayoutVertexArray.emplaceBack(P),I.push(P),p=Math.min(p,P),g=Math.max(g,P)}};for(const T of i){let N=0;for(const le of T)N+=le.length;const I=a.triangleSegments.prepareSegment(N,a.layoutVertexArray,a.indexArray),P=I.vertexLength,j=[],O=[],L=[],U=[],Z=[],G=a.layoutVertexArray.length;for(const le of T){if(le.length===0)continue;le!==T[0]&&O.push(j.length/2);const me=a.lineSegments.prepareSegment(le.length,a.layoutVertexArray,a.lineIndexArray),we=me.vertexLength;u&&Z.push(a.layoutVertexArray.length-G),v(le[0],L,U),a.layoutVertexArray.emplaceBack(le[0].x,le[0].y),a.lineIndexArray.emplaceBack(we+le.length-1,we),j.push(le[0].x),j.push(le[0].y);for(let be=1;be<le.length;be++)v(le[be],L,U),a.layoutVertexArray.emplaceBack(le[be].x,le[be].y),a.lineIndexArray.emplaceBack(we+be-1,we+be),j.push(le[be].x),j.push(le[be].y);me.vertexLength+=le.length,me.primitiveLength+=le.length}const ee=xg(j,O);for(let le=0;le<ee.length;le+=3)a.indexArray.emplaceBack(P+ee[le],P+ee[le+1],P+ee[le+2]);if(ee.length>0&&u&&this.elevationMode==="hd-road-base"){const le=u.elevation.isTunnel(),me=u.elevation.safeArea,we=this.elevatedStructures.addVertices(L,U);this.elevatedStructures.addTriangles(ee,we,le);const be=Z.length;if(be>0){for(let Re=0;Re<be-1;Re++)this.elevatedStructures.addRenderableRing(u.index,Z[Re]+we,Z[Re+1]-Z[Re],le,me,u.featureInfo);this.elevatedStructures.addRenderableRing(u.index,Z[be-1]+we,L.length-Z[be-1],le,me,u.featureInfo)}}I.vertexLength+=N,I.primitiveLength+=ee.length/3}return[p,g]}prepareElevatedPolygons(i,a,u){const p=1/Rt(u),g=[];for(const y of i){const v=Lq(y,new vo(a,p));g.push(...v)}return g}clipPolygonsToTile(i,a){const u=-a,p=-a,g=Bt+a,y=Bt+a;let v=0;const T=[],N=[];for(;v<i.length;v++){const j=i[v],O=Wp(j);(O.min.x>=u&&O.max.x<=g&&O.min.y>=p&&O.max.y<=y?T:N).push(j)}if(T.length===i.length)return i;const I=[new wt(u,p),new wt(g,p),new wt(g,y),new wt(u,y),new wt(u,p)],P=T;for(const j of N)P.push(...Oq(j,I));return P}}let $R,GR,HR,WR;Yt(FN,"FillBucket",{omit:["layers","patternFeatures"]}),Yt(LN,"FillBufferData"),Yt(Wo,"ElevatedStructures");class P1{constructor(i,a,u,p){if(this.triangleCount=a.length/3,this.min=new wt(0,0),this.max=new wt(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||i.length===0)return;const[g,y]=[i[0].clone(),i[0].clone()];for(let P=1;P<i.length;++P){const j=i[P];g.x=Math.min(g.x,j.x),g.y=Math.min(g.y,j.y),y.x=Math.max(y.x,j.x),y.y=Math.max(y.y,j.y)}if(p){const P=Math.ceil(Math.max(y.x-g.x,y.y-g.y)/p);u=Math.max(u,P)}if(u===0)return;this.min=g,this.max=y;const v=this.max.sub(this.min);v.x=Math.max(v.x,1),v.y=Math.max(v.y,1);const T=Math.max(v.x,v.y)/u;this.cellsX=Math.max(1,Math.ceil(v.x/T)),this.cellsY=Math.max(1,Math.ceil(v.y/T)),this.xScale=1/T,this.yScale=1/T;const N=[];for(let P=0;P<this.triangleCount;P++){const j=i[a[3*P+0]].sub(this.min),O=i[a[3*P+1]].sub(this.min),L=i[a[3*P+2]].sub(this.min),U=Cu(Math.floor(Math.min(j.x,O.x,L.x)),this.xScale,this.cellsX),Z=Cu(Math.floor(Math.max(j.x,O.x,L.x)),this.xScale,this.cellsX),G=Cu(Math.floor(Math.min(j.y,O.y,L.y)),this.yScale,this.cellsY),ee=Cu(Math.floor(Math.max(j.y,O.y,L.y)),this.yScale,this.cellsY),le=new wt(0,0),me=new wt(0,0),we=new wt(0,0),be=new wt(0,0);for(let Re=G;Re<=ee;++Re){le.y=me.y=Re*T,we.y=be.y=(Re+1)*T;for(let Me=U;Me<=Z;++Me)le.x=we.x=Me*T,me.x=be.x=(Me+1)*T,(Mc(j,O,L,le,me,be)||Mc(j,O,L,le,be,we))&&N.push({cellIdx:Re*this.cellsX+Me,triIdx:P})}}if(N.length===0)return;N.sort((P,j)=>P.cellIdx-j.cellIdx||P.triIdx-j.triIdx);let I=0;for(;I<N.length;){const P=N[I].cellIdx,j={start:this.payload.length,len:0};for(;I<N.length&&N[I].cellIdx===P;)++j.len,this.payload.push(N[I++].triIdx);this.cells[P]=j}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(i,a){if(this.triangleCount===0||this.cells.length===0||i.x>this.max.x||this.min.x>i.x||i.y>this.max.y||this.min.y>i.y)return;const u=Cu(i.x-this.min.x,this.xScale,this.cellsX),p=Cu(i.y-this.min.y,this.yScale,this.cellsY),g=this.cells[p*this.cellsX+u];if(g){this._lazyInitLookup();for(let y=0;y<g.len;y++){const v=this.payload[g.start+y],T=Math.floor(v/8),N=1<<v%8;if(!(this.lookup[T]&N)&&(this.lookup[T]|=N,a.push(v),a.length===this.triangleCount))return}}}query(i,a,u){if(this.triangleCount===0||this.cells.length===0||i.x>this.max.x||this.min.x>a.x||i.y>this.max.y||this.min.y>a.y)return;this._lazyInitLookup();const p=Cu(i.x-this.min.x,this.xScale,this.cellsX),g=Cu(a.x-this.min.x,this.xScale,this.cellsX),y=Cu(i.y-this.min.y,this.yScale,this.cellsY),v=Cu(a.y-this.min.y,this.yScale,this.cellsY);for(let T=y;T<=v;T++)for(let N=p;N<=g;N++){const I=this.cells[T*this.cellsX+N];if(I)for(let P=0;P<I.len;P++){const j=this.payload[I.start+P],O=Math.floor(j/8),L=1<<j%8;if(!(this.lookup[O]&L)&&(this.lookup[O]|=L,u.push(j),u.length===this.triangleCount))return}}}}function Cu(l,i,a){return Math.max(0,Math.min(a-1,Math.floor(l*i)))}Yt(P1,"TriangleGridIndex");class ZR{constructor(i){this.zoom=i.zoom,this.layers=i.layers,this.layerIds=this.layers.map(a=>a.fqid),this.index=i.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter(a=>a.isStateDependent()).map(a=>a.id),this.footprints=[],this.worldview=i.worldview,this.hasAppearances=null}updateFootprints(i,a){for(const u of this.footprints)a.push({footprint:u,id:i})}updateAppearances(i,a,u,p){}populate(i,a,u,p){const g=[];for(const{feature:y,id:v,index:T,sourceLayerIndex:N}of i){const I=this.layers[0]._featureFilter.needGeometry,P=Hi(y,I);if(!this.layers[0]._featureFilter.filter(new Vr(this.zoom,{worldview:this.worldview,activeFloors:a.activeFloors}),P,u))continue;const j={id:v,properties:y.properties,type:y.type,sourceLayerIndex:N,index:T,geometry:I?P.geometry:Ci(y,u,p),patterns:{}};g.push(j)}for(const y of g){const{geometry:v,index:T,sourceLayerIndex:N}=y;this.addFeature(y,v,T,u,{},a.availableImages,a.brightness),a.featureIndex.insert(i[T].feature,v,T,N,this.index)}}isEmpty(){return this.footprints.length===0}uploadPending(){return!1}upload(i){}update(i,a,u,p,g,y,v){}destroy(){}addFeature(i,a,u,p,g,y=[],v){for(const T of N_(a,2)){const N=[],I=[],P=[],j=new wt(1/0,1/0),O=new wt(-1/0,-1/0);for(const Z of T)if(Z.length!==0){Z!==T[0]&&P.push(I.length/2);for(let G=0;G<Z.length;G++)I.push(Z[G].x),I.push(Z[G].y),N.push(Z[G]),j.x=Math.min(j.x,Z[G].x),j.y=Math.min(j.y,Z[G].y),O.x=Math.max(O.x,Z[G].x),O.y=Math.max(O.y,Z[G].y)}const L=xg(I,P),U=new P1(N,L,8,256);this.footprints.push({vertices:N,indices:L,grid:U,min:j,max:O})}}}Yt(ZR,"ClipBucket",{omit:["layers"]});const Fq=sr([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),zq=sr([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),Bq=sr([{name:"a_flood_light_ground_radius",components:1,type:"Float32"}]),Vq=sr([{name:"a_centroid_pos",components:2,type:"Uint16"}]),Uq=sr([{name:"a_join_normal_inside",components:3,type:"Int16"}]),qq=sr([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),$q=sr([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:Gq}=Fq,E_=Number.MAX_SAFE_INTEGER,Hq=E_-1;function XR(l,i,a,u){return l.order<i||l.order===E_||!(l.clipMask&a)||function(p,g){return g.length!==0&&g.find(y=>y===p)===void 0}(u,l.clipScope)}function j1(l,i){return l.x-i.x||l.y-i.y}function YR(l,i){return j1(l.min,i.min)===0&&j1(l.max,i.max)===0}function zN(l,i){return!(l.min.x>i.max.x||l.max.x<i.min.x||l.min.y>i.max.y||l.max.y<i.min.y)}function R1(l,i){if(l.length!==i.length)return!1;for(let a=0;a<l.length;a++)if(l[a].sourceId!==i[a].sourceId||!YR(l[a],i[a])||l[a].order!==i[a].order||l[a].clipMask!==i[a].clipMask||!Xa(l[a].clipScope,i[a].clipScope))return!1;return!0}function KR(l,i,a){const u=1/Bt,p=1/(1<<a.canonical.z),g=(i.x*u+a.canonical.x)*p+a.wrap,y=(i.y*u+a.canonical.y)*p;return{min:new wt((l.x*u+a.canonical.x)*p+a.wrap,(l.y*u+a.canonical.y)*p),max:new wt(g,y)}}function Wq(l,i,a){const u=1<<a.canonical.z,p=((i.x-a.wrap)*u-a.canonical.x)*Bt,g=(i.y*u-a.canonical.y)*Bt;return{min:new wt(((l.x-a.wrap)*u-a.canonical.x)*Bt,(l.y*u-a.canonical.y)*Bt),max:new wt(p,g)}}function BN(l,i,a,u,p,g,y){const v=l.indices,T=l.vertices,N=[];for(let I=u;I<u+p;I+=3){const P=i[a[I+0]+g],j=i[a[I+1]+g],O=i[a[I+2]+g],L=Math.min(P.x,j.x,O.x),U=Math.max(P.x,j.x,O.x),Z=Math.min(P.y,j.y,O.y),G=Math.max(P.y,j.y,O.y);N.length=0,l.grid.query(new wt(L,Z),new wt(U,G),N);for(let ee=0;ee<N.length;ee++){const le=N[ee];if(Mc(T[v[3*le+0]],T[v[3*le+1]],T[v[3*le+2]],P,j,O,y))return!0}}return!1}function QR(l,i,a,u){if(!l||!a)return!1;let p=l.vertices;if(!i.canonical.equals(u.canonical)||i.wrap!==u.wrap){if(a.vertices.length<l.vertices.length)return QR(a,u,l,i);const g=i.canonical,y=u.canonical,v=Math.pow(2,y.z-g.z);p=l.vertices.map(T=>new wt((T.x+g.x*Bt)*v-y.x*Bt,(T.y+g.y*Bt)*v-y.y*Bt))}return BN(a,p,l.indices,0,l.indices.length,0,0)}function JR(l,i,a,u){const p=Math.pow(2,u.z-a.z);return new wt((l+a.x*Bt)*p-u.x*Bt,(i+a.y*Bt)*p-u.y*Bt)}function ek(l,i){const a=[];i.grid.queryPoint(l,a);const u=i.indices,p=i.vertices;for(let g=0;g<a.length;g++){const y=a[g];if(wo([p[u[3*y+0]],p[u[3*y+1]],p[u[3*y+2]]],l))return!0}return!1}const VN=[new wt(0,0),new wt(Bt,0),new wt(Bt,Bt),new wt(0,Bt)];function tk(l,i){const a=[];let u=[];if(!i||l.length<2)return[l];if(l.length===2)return oc(l[0],l[1],VN)?[l]:[];for(let p=0;p<l.length+2;p++){const g=l[p%l.length],y=l[(p+1)%l.length],v=oc(p===0?l[l.length-1]:l[(p-1)%l.length],g,VN),T=oc(g,y,VN),N=v||T;N&&u.push(g),N&&T||u.length>0&&(u.length>1&&a.push(u),u=[])}return u.length>1&&a.push(u),a}const UN=lr.types,Zq=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],Xq=["fill-extrusion-flood-light-ground-radius"],Yq=Math.pow(2,13),Kq=Math.pow(2,15)-1,ik=new wt(0,1),bd=2147483648;function I_(l,i,a,u,p,g,y,v){l.emplaceBack((i<<1)+y,(a<<1)+g,(Math.floor(u*Yq)<<1)+p,Math.round(v))}function P_(l,i,a){l.emplaceBack(i.x*Bt,i.y*Bt,a?1:0)}function k1(l,i,a,u,p,g){l.emplaceBack(i.x,i.y,(a.x<<1)+u,(a.y<<1)+p,g)}function j_(l,i,a){l.emplaceBack(i.x,i.y,i.z,a[0]*16384,a[1]*16384,a[2]*16384)}class rk{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class nk{constructor(){this.centroidXY=new wt(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new wt(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new wt(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0,this.buildingId=0}span(){return new wt(this.max.x-this.min.x,this.max.y-this.min.y)}}class sk{constructor(){this.acc=new wt(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(i,a){i.min.x===Number.MAX_VALUE&&(i.min.x=i.max.x=a.x,i.min.y=i.max.y=a.y)}appendEdge(i,a,u){this.accCount++,this.acc._add(a);let p=!!this.borders;a.x<i.min.x?(i.min.x=a.x,p=!0):a.x>i.max.x&&(i.max.x=a.x,p=!0),a.y<i.min.y?(i.min.y=a.y,p=!0):a.y>i.max.y&&(i.max.y=a.y,p=!0),((a.x===0||a.x===Bt)&&a.x===u.x)!=((a.y===0||a.y===Bt)&&a.y===u.y)&&this.processBorderOverlap(a,u),p&&this.checkBorderIntersection(a,u)}checkBorderIntersection(i,a){a.x<0!=i.x<0&&this.addBorderIntersection(0,Si(a.y,i.y,(0-a.x)/(i.x-a.x))),a.x>Bt!=i.x>Bt&&this.addBorderIntersection(1,Si(a.y,i.y,(Bt-a.x)/(i.x-a.x))),a.y<0!=i.y<0&&this.addBorderIntersection(2,Si(a.x,i.x,(0-a.y)/(i.y-a.y))),a.y>Bt!=i.y>Bt&&this.addBorderIntersection(3,Si(a.x,i.x,(Bt-a.y)/(i.y-a.y)))}addBorderIntersection(i,a){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const u=this.borders[i];a<u[0]&&(u[0]=a),a>u[1]&&(u[1]=a)}processBorderOverlap(i,a){if(i.x===a.x){if(i.y===a.y)return;const u=i.x===0?0:1;this.addBorderIntersection(u,a.y),this.addBorderIntersection(u,i.y)}else{const u=i.y===0?2:3;this.addBorderIntersection(u,a.x),this.addBorderIntersection(u,i.x)}}centroid(){return this.accCount===0?new wt(0,0):new wt(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((i,a)=>i+ +(a[0]!==Number.MAX_VALUE),0):0}}function ak(l,i){const a=l.add(i)._unit(),u=Ie(l.x*a.x+l.y*a.y,-1,1);var p,g,y;return y=Math.acos(u),Math.min(4,Math.max(-4,Math.tan(y)))/4*Kq*((p=l).x*(g=i).y-p.y*g.x<0?-1:1)}const Qq=[l=>l.x<0,l=>l.x>Bt,l=>l.y<0,l=>l.y>Bt];function Jq(l,i,a,u){const p=[4];if(u===0)return p;a._mult(u);const g=l.sub(a),y=i.sub(a),v=[l,i,g,y];for(let T=0;T<4;T++)for(const N of v)if(Qq[T](N)){p.push(T);break}return p}class qN{constructor(i){this.groundRadiusArray=null,this.groundRadiusBuffer=null,this.vertexArray=new l_,this.indexArray=new ys,this.programConfigurations=new M(i.layers,{zoom:i.zoom,lut:i.lut},a=>Xq.includes(a)),this._segments=new dn,this.hiddenByLandmarkVertexArray=new mg,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new dn}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(i,a,u,p=!1){const g=i.length;if(g>2){let y=Math.max(0,this._segments.get().length-1);const v=this._segments._prepareSegment(4*g,this.vertexArray.length,2*this._segmentToGroundQuads[y].length);let T;y!==this._segments.get().length-1&&(y++,this._segmentToGroundQuads[y]=[],this._segmentToRegionTriCounts[y]=[0,0,0,0,0]);{const N=i[0],I=i[1];T=ak(N.sub(i[g-1])._perp()._unit(),I.sub(N)._perp()._unit())}for(let N=0;N<g;N++){const I=N===g-1?0:N+1,P=i[N],j=i[I],O=i[I===g-1?0:I+1],L=j.sub(P)._perp()._unit(),U=ak(L,O.sub(j)._perp()._unit()),Z=T,G=U;if($N(P,j,a)||p&&ck(P,a)&&ck(j,a)){T=U;continue}const ee=v.vertexLength;k1(this.vertexArray,P,j,1,1,Z),k1(this.vertexArray,P,j,1,0,Z),k1(this.vertexArray,P,j,0,1,G),k1(this.vertexArray,P,j,0,0,G),v.vertexLength+=4;const le=Jq(P,j,L,u);for(const me of le)this._segmentToGroundQuads[y].push({id:ee,region:me}),this._segmentToRegionTriCounts[y][me]+=2,v.primitiveLength+=2;T=U}}}prepareBorderSegments(){if(!this.hasData())return;const i=this._segments.get(),a=i.length;for(let u=0;u<a;u++)this._segmentToGroundQuads[u].sort((p,g)=>p.region-g.region);for(let u=0;u<a;u++){const p=this._segmentToGroundQuads[u],g=i[u],y=this._segmentToRegionTriCounts[u];y.reduce((T,N)=>T+N,0);let v=0;for(let T=0;T<=4;T++){const N=y[T];if(N!==0){let I=this.regionSegments[T];I||(I=this.regionSegments[T]=new dn);const P={vertexOffset:g.vertexOffset,primitiveOffset:g.primitiveOffset+v,vertexLength:g.vertexLength,primitiveLength:N};I.get().push(P)}v+=N}for(let T=0;T<p.length;T++){const N=p[T].id;this.indexArray.emplaceBack(N,N+1,N+3),this.indexArray.emplaceBack(N,N+3,N+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(i,a,u,p,g,y,v){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,i,a,u,p,g,y,void 0,v)}upload(i){this.hasData()&&(this.vertexBuffer=i.createVertexBuffer(this.vertexArray,zq.members),this.indexBuffer=i.createIndexBuffer(this.indexArray),this.groundRadiusArray!=null&&(this.groundRadiusBuffer=i.createVertexBuffer(this.groundRadiusArray,Bq.members)))}uploadPaintProperties(i){this.hasData()&&this.programConfigurations.upload(i)}update(i,a,u,p,g,y,v,T){this.hasData()&&this.programConfigurations.updatePaintArrays(i,a,u,p,g,y,v,T)}updateHiddenByLandmark(i){this.updateHiddenByLandmarkRange(i.groundVertexArrayOffset,i.groundVertexCount,!!(i.flags&bd))}updateHiddenByLandmarkRange(i,a,u){if(!this.hasData())return;const p=a+i;if(a!==0){for(let g=i;g<p;++g)this.hiddenByLandmarkVertexArray.emplace(g,u?1:0);this._needsHiddenByLandmarkUpdate=!0}}uploadHiddenByLandmark(i){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=i.createVertexBuffer(this.hiddenByLandmarkVertexArray,qq.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this.groundRadiusBuffer&&this.groundRadiusBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let i=0;i<=4;i++){const a=this.regionSegments[i];a&&a.destroy()}}}}class D1{constructor(i){this.zoom=i.zoom,this.canonical=i.canonical,this.overscaling=i.overscaling,this.layers=i.layers,this.pixelRatio=i.pixelRatio,this.layerIds=this.layers.map(a=>a.fqid),this.index=i.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=i.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new ys,this.footprintVertices=new Su,this.footprintSegments=[],this.layoutVertexArray=new Dc,this.centroidVertexArray=new u1,this.wallVertexArray=new d1,this.indexArray=new ys,this.programConfigurations=new M(i.layers,{zoom:i.zoom,lut:i.lut},a=>Zq.includes(a)),this.segments=new dn,this.stateDependentLayerIds=this.layers.filter(a=>a.isStateDependent()).map(a=>a.id),this.groundEffect=new qN(i),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[],this.worldview=i.worldview,this.hasAppearances=null}updateFootprints(i,a){}updateAppearances(i,a,u,p){}populate(i,a,u,p){this.features=[],this.hasPattern=CN("fill-extrusion",this.layers,this.pixelRatio,a),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=Rt(u),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1)!==0;for(const{feature:g,id:y,index:v,sourceLayerIndex:T}of i){const N=this.layers[0]._featureFilter.needGeometry,I=Hi(g,N);if(!this.layers[0]._featureFilter.filter(new Vr(this.zoom,{worldview:this.worldview,activeFloors:a.activeFloors}),I,u))continue;const P={id:y,sourceLayerIndex:T,index:v,geometry:N?I.geometry:Ci(g,u,p),properties:g.properties,type:g.type,patterns:{}},j=this.layoutVertexArray.length,O=UN[P.type]==="Polygon";if(this.hasPattern)this.features.push({featureId:g.id,feature:EN("fill-extrusion",this.layers,P,this.zoom,this.pixelRatio,a)});else if(this.wallMode)for(const L of P.geometry)for(const U of tk(L,O))this.addFeature(g.id,P,[U],v,u,{},a.availableImages,p,a.brightness);else this.addFeature(g.id,P,P.geometry,v,u,{},a.availableImages,p,a.brightness);a.featureIndex.insert(g,P.geometry,v,T,this.index,j)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(i,a,u,p,g,y){for(const{featureId:v,feature:T}of this.features){const N=UN[T.type]==="Polygon",{geometry:I}=T;if(this.wallMode)for(const P of I)for(const j of tk(P,N))this.addFeature(v,T,[j],T.index,a,u,p,g,y);else this.addFeature(v,T,I,T.index,a,u,p,g,y)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(i,a,u,p,g,y,v){this.programConfigurations.updatePaintArrays(i,a,g,u,p,y,v,this.worldview),this.groundEffect.update(i,a,g,u,p,y,v,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(i){this.uploaded||(this.layoutVertexBuffer=i.createVertexBuffer(this.layoutVertexArray,Gq),this.indexBuffer=i.createIndexBuffer(this.indexArray),this.wallVertexBuffer=i.createVertexBuffer(this.wallVertexArray,Uq.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=i.createVertexBuffer(this.layoutVertexExtArray,$q.members,!0)),this.groundEffect.upload(i)),this.groundEffect.uploadPaintProperties(i),this.programConfigurations.upload(i),this.uploaded=!0}uploadCentroid(i){this.groundEffect.uploadHiddenByLandmark(i),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=i.createVertexBuffer(this.centroidVertexArray,Vq.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(i,a,u,p,g,y,v,T,N){const I=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(a,{})/this.tileToMeter,P=[new wt(0,0),new wt(Bt,Bt)],j=T.projection,O=j.name==="globe",L=this.wallMode||UN[a.type]==="Polygon",U=new sk;U.centroidDataIndex=this.centroidData.length;const Z=new nk;Z.buildingId=i,a.properties&&a.properties.hasOwnProperty("building_id")&&(Z.buildingId=Number(a.properties.building_id));const G=this.layers[0].paint.get("fill-extrusion-base").evaluate(a,{},g)<=0,ee=this.layers[0].paint.get("fill-extrusion-height").evaluate(a,{},g);let le;if(Z.height=ee,Z.vertexArrayOffset=this.layoutVertexArray.length,Z.groundVertexArrayOffset=this.groundEffect.vertexArray.length,O&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new bh),this.wallMode){if(O)return void Ni("Non zero fill-extrusion-line-width is not yet supported on globe.");if(u.length!==1)return;le=function(Be){const Ge=Be[0].x===Be[Be.length-1].x&&Be[0].y===Be[Be.length-1].y;(function(Ft){let Vt=0;const xi=Ft.length;for(let ri=0;ri<xi;ri++)Vt+=(Ft[(ri+1)%xi].x-Ft[ri].x)*(Ft[(ri+1)%xi].y+Ft[ri].y);return Vt>=0})(Be)||(Be=Be.reverse());const lt={geometry:[],joinNormals:[],indices:[]},ct=[],xt=[],gt=[];let yt=Be.length;for(;yt>=2&&Be[yt-1].equals(Be[yt-2]);)yt--;if(yt<(Ge?3:2))return lt;let st,bt,mt,Tt,_t,Zt=0;for(;Zt<yt-1&&Be[Zt].equals(Be[Zt+1]);)Zt++;Ge&&(st=Be[yt-2],_t=Be[Zt].sub(st)._unit()._perp());for(let Ft=Zt;Ft<yt;Ft++){if(mt=Ft===yt-1?Ge?Be[Zt+1]:void 0:Be[Ft+1],mt&&Be[Ft].equals(mt))continue;_t&&(Tt=_t),st&&(bt=st),st=Be[Ft],_t=mt?mt.sub(st)._unit()._perp():Tt,Tt=Tt||_t;let Vt=Tt.add(_t);Vt.x===0&&Vt.y===0||Vt._unit();const xi=Vt.x*_t.x+Vt.y*_t.y,ri=xi!==0?1/xi:1/0,Gt=Tt.x*_t.y-Tt.y*_t.x>0;let Ri="miter";const tr=2;Ri==="miter"&&ri>tr&&(Ri="bevel"),Ri==="bevel"&&(ri>100&&(Ri="flipbevel"),ri<tr&&(Ri="miter"));const Cr=(Qi,Ur,fr,Bn)=>{const _r=new wt(Qi.x,Qi.y),Mr=new wt(Qi.x,Qi.y);_r.x+=Ur.x*Bn,_r.y+=Ur.y*Bn,Mr.x-=Ur.x*Math.max(fr,1),Mr.y-=Ur.y*Math.max(fr,1),gt.push(Ur),ct.push(_r),xt.push(Mr)};if(Ri==="miter")Vt._mult(ri),Cr(st,Vt,0,0);else if(Ri==="flipbevel")Vt=_t.mult(-1),Cr(st,Vt,0,0),Cr(st,Vt.mult(-1),0,0);else{const Qi=-Math.sqrt(ri*ri-1),Ur=Gt?Qi:0,fr=Gt?0:Qi;bt&&Cr(st,Tt,Ur,fr),mt&&Cr(st,_t,Ur,fr)}}lt.geometry=[...ct,...xt.reverse(),ct[0]],lt.joinNormals=[...gt,...gt.reverse(),gt[gt.length-1]];const Xt=lt.geometry.length-1;for(let Ft=0;Ft<Xt/2;Ft++)if(Ft+1<Xt/2){let Vt=Ft,xi=Ft+1,ri=Xt-1-Ft,Gt=Xt-2-Ft;Vt=Vt===0?Xt-1:Vt-1,xi=xi===0?Xt-1:xi-1,ri=ri===0?Xt-1:ri-1,Gt=Gt===0?Xt-1:Gt-1,lt.indices.push(ri),lt.indices.push(xi),lt.indices.push(Vt),lt.indices.push(ri),lt.indices.push(Gt),lt.indices.push(xi)}return lt}(u[0]),u=[le.geometry]}const me=(Be,Ge)=>Be<(Ge.length-1)/2||Be===Ge.length-1,we=this.wallMode?[u]:N_(u,500);for(let Be=we.length-1;Be>=0;Be--){const Ge=we[Be];(Ge.length===0||t8(Ge[0]))&&we.splice(Be,1)}let be;if(O)be=pk(we,P,g);else{be=[];for(const Be of we)be.push({polygon:Be,bounds:P})}const Re=L?this.edgeRadius:0,Me=Re>0&&this.zoom<17,je=(Be,Ge)=>{if(Be.length===0)return!1;const ut=Be[Be.length-1];return Ge.x===ut.x&&Ge.y===ut.y};for(const{polygon:Be,bounds:Ge}of be){let ut=0,lt=0;for(const yt of Be)L&&!yt[0].equals(yt[yt.length-1])&&yt.push(yt[0]),lt+=L?yt.length-1:yt.length;const ct=this.segments.prepareSegment((L?5:4)*lt,this.layoutVertexArray,this.indexArray);Z.footprintSegIdx<0&&(Z.footprintSegIdx=this.footprintSegments.length),Z.polygonSegIdx<0&&(Z.polygonSegIdx=this.polygonSegments.length);const xt={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},gt=new rk;if(gt.vertexOffset=this.footprintVertices.length,gt.indexOffset=3*this.footprintIndices.length,gt.ringIndices=[],L){const yt=[],st=[];ut=ct.vertexLength;for(let mt=0;mt<Be.length;mt++){const Tt=Be[mt];Tt.length&&mt!==0&&st.push(yt.length/2);const _t=[];let Zt,Xt;Zt=Tt[1].sub(Tt[0])._perp()._unit(),gt.ringIndices.push(Tt.length-1);for(let Ft=1;Ft<Tt.length;Ft++){const Vt=Tt[Ft],xi=Tt[Ft===Tt.length-1?1:Ft+1],ri=Vt.clone();if(Re){Xt=xi.sub(Vt)._perp()._unit();const Gt=Zt.add(Xt)._unit(),Ri=Re*Math.min(4,1/(Zt.x*Gt.x+Zt.y*Gt.y));ri.x+=Ri*Gt.x,ri.y+=Ri*Gt.y,ri.x=Math.round(ri.x),ri.y=Math.round(ri.y),Zt=Xt}if(!G||Re!==0&&!Me||je(_t,ri)||_t.push(ri),I_(this.layoutVertexArray,ri.x,ri.y,0,0,1,1,0),this.wallMode){const Gt=me(Ft,Tt);P_(this.wallVertexArray,le.joinNormals[Ft],!Gt)}ct.vertexLength++,this.footprintVertices.emplaceBack(Vt.x,Vt.y),yt.push(Vt.x,Vt.y),O&&j_(this.layoutVertexExtArray,j.projectTilePoint(ri.x,ri.y,g),j.upVector(g,ri.x,ri.y))}G&&(Re===0||Me)&&(_t.length!==0&&je(_t,_t[0])&&_t.pop(),this.groundEffect.addData(_t,Ge,I))}const bt=this.wallMode?le.indices:xg(yt,st);for(let mt=0;mt<bt.length;mt+=3)this.footprintIndices.emplaceBack(gt.vertexOffset+bt[mt+0],gt.vertexOffset+bt[mt+1],gt.vertexOffset+bt[mt+2]),this.indexArray.emplaceBack(ut+bt[mt],ut+bt[mt+2],ut+bt[mt+1]),ct.primitiveLength++;gt.indexCount+=bt.length,gt.vertexCount+=this.footprintVertices.length-gt.vertexOffset}for(let yt=0;yt<Be.length;yt++){const st=Be[yt];U.startRing(Z,st[0]);let bt=st.length>4&&uk(st[st.length-2],st[0],st[1]),mt=Re?e8(st[st.length-2],st[0],st[1],Re):0;const Tt=[];let _t,Zt,Xt;Zt=st[1].sub(st[0])._perp()._unit();let Ft=!0;for(let Vt=1,xi=0;Vt<st.length;Vt++){let ri=st[Vt-1],Gt=st[Vt];const Ri=st[Vt===st.length-1?1:Vt+1];if(U.appendEdge(Z,Gt,ri),$N(Gt,ri,Ge)){Re&&(Zt=Ri.sub(Gt)._perp()._unit(),Ft=!Ft);continue}const tr=Gt.sub(ri)._perp(),Cr=tr.x/(Math.abs(tr.x)+Math.abs(tr.y)),Qi=tr.y>0?1:0,Ur=ri.dist(Gt);if(xi+Ur>32768&&(xi=0),Re){Xt=Ri.sub(Gt)._perp()._unit();let Mr=lk(ri,Gt,Ri,ok(Zt,Xt),Re);isNaN(Mr)&&(Mr=0);const ln=Gt.sub(ri)._unit();ri=ri.add(ln.mult(mt))._round(),Gt=Gt.add(ln.mult(-Mr))._round(),mt=Mr,Zt=Xt,G&&this.zoom>=17&&(je(Tt,ri)||Tt.push(ri),je(Tt,Gt)||Tt.push(Gt))}const fr=ct.vertexLength,Bn=st.length>4&&uk(ri,Gt,Ri);let _r=dk(xi,bt,Ft);if(I_(this.layoutVertexArray,ri.x,ri.y,Cr,Qi,0,0,_r),I_(this.layoutVertexArray,ri.x,ri.y,Cr,Qi,0,1,_r),this.wallMode){const Mr=me(Vt-1,st),ln=le.joinNormals[Vt-1];P_(this.wallVertexArray,ln,Mr),P_(this.wallVertexArray,ln,Mr)}if(xi+=Ur,_r=dk(xi,Bn,!Ft),bt=Bn,I_(this.layoutVertexArray,Gt.x,Gt.y,Cr,Qi,0,0,_r),I_(this.layoutVertexArray,Gt.x,Gt.y,Cr,Qi,0,1,_r),this.wallMode){const Mr=me(Vt,st),ln=le.joinNormals[Vt];P_(this.wallVertexArray,ln,Mr),P_(this.wallVertexArray,ln,Mr)}if(ct.vertexLength+=4,this.indexArray.emplaceBack(fr+0,fr+1,fr+2),this.indexArray.emplaceBack(fr+1,fr+3,fr+2),ct.primitiveLength+=2,Re){const Mr=ut+(Vt===1?st.length-2:Vt-2),ln=Vt===1?ut:Mr+1;if(this.indexArray.emplaceBack(fr+1,Mr,fr+3),this.indexArray.emplaceBack(Mr,ln,fr+3),ct.primitiveLength+=2,_t===void 0&&(_t=fr),!$N(Ri,st[Vt],Ge)){const vn=Vt===st.length-1?_t:ct.vertexLength;this.indexArray.emplaceBack(fr+2,fr+3,vn),this.indexArray.emplaceBack(fr+3,vn+1,vn),this.indexArray.emplaceBack(fr+3,ln,vn+1),ct.primitiveLength+=3}Ft=!Ft}if(O){const Mr=this.layoutVertexExtArray,ln=j.projectTilePoint(ri.x,ri.y,g),vn=j.projectTilePoint(Gt.x,Gt.y,g),bn=j.upVector(g,ri.x,ri.y),Vn=j.upVector(g,Gt.x,Gt.y);j_(Mr,ln,bn),j_(Mr,ln,bn),j_(Mr,vn,Vn),j_(Mr,vn,Vn)}}L&&(ut+=st.length-1),G&&Re&&this.zoom>=17&&(Tt.length!==0&&je(Tt,Tt[0])&&Tt.pop(),this.groundEffect.addData(Tt,Ge,I,Re>0))}this.footprintSegments.push(gt),xt.triangleCount=this.indexArray.length-xt.triangleArrayOffset,this.polygonSegments.push(xt),++Z.footprintSegLen,++Z.polygonSegLen}if(Z.vertexCount=this.layoutVertexArray.length-Z.vertexArrayOffset,Z.groundVertexCount=this.groundEffect.vertexArray.length-Z.groundVertexArrayOffset,Z.vertexCount!==0){if(Z.centroidXY=U.borders?ik:this.encodeCentroid(U,Z),this.centroidData.push(Z),U.borders){this.featuresOnBorder.push(U);const Be=this.featuresOnBorder.length-1;for(let Ge=0;Ge<U.borders.length;Ge++)U.borders[Ge][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[Ge].push(Be)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,a,p,y,v,g,N,void 0,this.worldview),this.groundEffect.addPaintPropertiesData(a,p,y,v,g,N,this.worldview),this.maxHeight=Math.max(this.maxHeight,ee)}}sortBorders(){for(let i=0;i<this.borderFeatureIndices.length;i++)this.borderFeatureIndices[i].sort((a,u)=>this.featuresOnBorder[a].borders[i][0]-this.featuresOnBorder[u].borders[i][0])}splitToSubtiles(){const i=[];for(let v=0;v<this.centroidData.length;v++){const T=this.centroidData[v],N=+(T.min.y+T.max.y>Bt),I=2*N+(+(T.min.x+T.max.x>Bt)^N);for(let P=0;P<T.polygonSegLen;P++){const j=T.polygonSegIdx+P;i.push({centroidIdx:v,subtile:I,polygonSegmentIdx:j,triangleSegmentIdx:this.polygonSegments[j].triangleSegIdx})}}const a=new ys;i.sort((v,T)=>v.triangleSegmentIdx===T.triangleSegmentIdx?v.subtile-T.subtile:v.triangleSegmentIdx-T.triangleSegmentIdx);let u=0,p=0,g=0;for(const v of i){if(v.triangleSegmentIdx!==u)break;g++}const y=i.length;for(;p!==i.length;){u=i[p].triangleSegmentIdx;let v=0,T=p,N=p;for(let I=T;I<g&&i[I].subtile===v;I++)N++;for(;T!==g;){const I=i[T];v=I.subtile;const P=this.centroidData[I.centroidIdx].min.clone(),j=this.centroidData[I.centroidIdx].max.clone(),O={vertexOffset:this.segments.segments[u].vertexOffset,primitiveOffset:a.length,vertexLength:this.segments.segments[u].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let L=T;L<N;L++){const U=i[L],Z=this.polygonSegments[U.polygonSegmentIdx],G=this.centroidData[U.centroidIdx].min,ee=this.centroidData[U.centroidIdx].max,le=this.indexArray.uint16;for(let me=Z.triangleArrayOffset;me<Z.triangleArrayOffset+Z.triangleCount;me++)a.emplaceBack(le[3*me],le[3*me+1],le[3*me+2]);O.primitiveLength+=Z.triangleCount,P.x=Math.min(P.x,G.x),P.y=Math.min(P.y,G.y),j.x=Math.max(j.x,ee.x),j.y=Math.max(j.y,ee.y)}O.primitiveLength>0&&this.triangleSubSegments.push({segment:O,min:P,max:j}),T=N;for(let L=T;L<g&&i[L].subtile===i[T].subtile;L++)N++}p=g;for(let I=p;I<y&&i[I].triangleSegmentIdx===i[p].triangleSegmentIdx;I++)g++}a._trim(),this.indexArray=a}getVisibleSegments(i,a,u){const p=new dn;if(this.wallMode){for(const U of this.triangleSubSegments)p.segments.push(U.segment);return p}let g=0,y=0;const v=1<<i.canonical.z;if(a){const U=a.getMinMaxForTile(i);U&&(g=U.min,y=U.max)}y+=this.maxHeight;const T=i.toUnwrapped();let N;const I=[T.canonical.x/v+T.wrap,T.canonical.y/v],P=[(T.canonical.x+1)/v+T.wrap,(T.canonical.y+1)/v],j=(U,Z,G)=>[U[0]*(1-G[0])+Z[0]*G[0],U[1]*(1-G[1])+Z[1]*G[1]],O=[],L=[];for(const U of this.triangleSubSegments){O[0]=U.min.x/Bt,O[1]=U.min.y/Bt,L[0]=U.max.x/Bt,L[1]=U.max.y/Bt;const Z=j(I,P,O),G=j(I,P,L);if(new jr([Z[0],Z[1],g],[G[0],G[1],y]).intersectsPrecise(u)===0){N&&(p.segments.push(N),N=void 0);continue}const ee=U.segment;N&&N.vertexOffset!==ee.vertexOffset&&(p.segments.push(N),N=void 0),N?(N.vertexLength+=ee.vertexLength,N.primitiveLength+=ee.primitiveLength):N={vertexOffset:ee.vertexOffset,primitiveLength:ee.primitiveLength,vertexLength:ee.vertexLength,primitiveOffset:ee.primitiveOffset,sortKey:void 0,vaos:{}}}return N&&p.segments.push(N),p}encodeCentroid(i,a){const u=i.centroid(),p=a.span(),g=Math.min(7,Math.round(p.x*this.tileToMeter/10)),y=Math.min(7,Math.round(p.y*this.tileToMeter/10));return new wt(Ie(u.x,1,8191)<<3|g,Ie(u.y,1,8191)<<3|y)}encodeBorderCentroid(i){if(!i.borders)return new wt(0,0);const a=i.borders,u=Number.MAX_VALUE;if(a[0][0]!==u||a[1][0]!==u){const p=a[0][0]!==u?0:1;return new wt(6|(a[0][0]!==u?0:65528),(a[p][0]+a[p][1])/2<<3|6)}{const p=a[2][0]!==u?2:3;return new wt((a[p][0]+a[p][1])/2<<3|6,6|(a[2][0]!==u?0:65528))}}showCentroid(i){const a=this.centroidData[i.centroidDataIndex];a.flags&=2147483647,a.centroidXY.x=0,a.centroidXY.y=0,this.writeCentroidToBuffer(a)}writeCentroidToBuffer(i){this.groundEffect.updateHiddenByLandmark(i);const a=i.vertexArrayOffset,u=i.vertexCount+i.vertexArrayOffset,p=i.flags&bd?ik:i.centroidXY,g=this.centroidVertexArray.geta_centroid_pos0(a);if(this.centroidVertexArray.geta_centroid_pos1(a)!==p.y||g!==p.x){for(let y=a;y<u;++y)this.centroidVertexArray.emplace(y,p.x,p.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const i of this.centroidData)this.writeCentroidToBuffer(i)}updateReplacement(i,a,u){if(a.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=a.updateTime;const p=a.getReplacementRegionsForTile(i.toUnwrapped());if(R1(this.activeReplacements,p))return;if(this.activeReplacements=p,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(const y of this.centroidData)y.flags&=2147483647;const g=[];for(const y of this.activeReplacements){if(y.order<u)continue;const v=Math.max(1,Math.pow(2,y.footprintTileId.canonical.z-i.canonical.z));if(y.footprint.buildingIds)for(const T of this.centroidData)T.flags&bd||y.min.x>T.max.x||T.min.x>y.max.x||y.min.y>T.max.y||T.min.y>y.max.y||y.footprint.buildingIds.has(T.buildingId)&&(T.flags|=bd);else for(const T of this.centroidData)if(!(T.flags&bd||y.min.x>T.max.x||T.min.x>y.max.x||y.min.y>T.max.y||T.min.y>y.max.y))for(let N=0;N<T.footprintSegLen;N++){const I=this.footprintSegments[T.footprintSegIdx+N];if(g.length=0,i8(this.footprintVertices,I.vertexOffset,I.vertexCount,y.footprintTileId.canonical,i.canonical,g),BN(y.footprint,g,this.footprintIndices.uint16,I.indexOffset,I.indexCount,-I.vertexOffset,-v)){T.flags|=bd;break}}}for(const y of this.centroidData)this.writeCentroidToBuffer(y);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(i,a,u){let p=!1;for(let g=0;g<u.footprintSegLen;g++){const y=this.footprintSegments[u.footprintSegIdx+g];let v=0;for(const T of y.ringIndices){for(let N=v,I=T+v-1;N<T+v;I=N++){const P=this.footprintVertices.int16[2*(N+y.vertexOffset)+0],j=this.footprintVertices.int16[2*(N+y.vertexOffset)+1],O=this.footprintVertices.int16[2*(I+y.vertexOffset)+1];j>a!=O>a&&i<(this.footprintVertices.int16[2*(I+y.vertexOffset)+0]-P)*(a-j)/(O-j)+P&&(p=!p)}v=T}}return p}getHeightAtTileCoord(i,a){let u=Number.NEGATIVE_INFINITY,p=!0;const g=4*(i+Bt)*Bt+(a+Bt);if(this.partLookup.hasOwnProperty(g)){const y=this.partLookup[g];return y?{height:y.height,hidden:!!(y.flags&bd)}:void 0}for(const y of this.centroidData)i>y.max.x||y.min.x>i||a>y.max.y||y.min.y>a||y.height<=u||this.footprintContainsPoint(i,a,y)&&(u=y.height,this.partLookup[g]=y,p=!!(y.flags&bd));if(u!==Number.NEGATIVE_INFINITY)return{height:u,hidden:p};this.partLookup[g]=void 0}}function ok(l,i){const a=l.add(i)._unit();return l.x*a.x+l.y*a.y}function e8(l,i,a,u){const p=i.sub(l)._perp()._unit(),g=a.sub(i)._perp()._unit();return lk(l,i,a,ok(p,g),u)}function lk(l,i,a,u,p){const g=Math.sqrt(1-u*u);return Math.min(l.dist(i)/3,i.dist(a)/3,p*g/u)}function $N(l,i,a){return l.x<a[0].x&&i.x<a[0].x||l.x>a[1].x&&i.x>a[1].x||l.y<a[0].y&&i.y<a[0].y||l.y>a[1].y&&i.y>a[1].y}function ck(l,i){return l.x<i[0].x||l.x>i[1].x||l.y<i[0].y||l.y>i[1].y}function t8(l){return l.every(i=>i.x<=0)||l.every(i=>i.x>=Bt)||l.every(i=>i.y<=0)||l.every(i=>i.y>=Bt)}function uk(l,i,a){if(l.x<0||l.x>=Bt||i.x<0||i.x>=Bt||a.x<0||a.x>=Bt)return!1;const u=a.sub(i),p=u.perp(),g=l.sub(i);return(u.x*g.x+u.y*g.y)/Math.sqrt((u.x*u.x+u.y*u.y)*(g.x*g.x+g.y*g.y))>-.866&&p.x*g.x+p.y*g.y<0}function dk(l,i,a){const u=i?2|l:-3&l;return a?1|u:-2&u}function hk(){const l=Math.PI/32,i=Math.tan(l),a=Oe;return a*Math.sqrt(1+2*i*i)-a}function pk(l,i,a){const u=1<<a.z,p=ft(a.x/u),g=ft((a.x+1)/u),y=Nt(a.y/u),v=Nt((a.y+1)/u);return function(T,N,I,P,j=0,O){const L=[];if(!T.length||!I||!P)return L;const U=(be,Re)=>{for(const Me of be)L.push({polygon:Me,bounds:Re})},Z=Math.ceil(Math.log2(I)),G=Math.ceil(Math.log2(P)),ee=Z-G,le=[];for(let be=0;be<Math.abs(ee);be++)le.push(ee>0?0:1);for(let be=0;be<Math.min(Z,G);be++)le.push(0),le.push(1);let me=T;if(me=I1(me,N[0].y-j,N[1].y+j,1),me=I1(me,N[0].x-j,N[1].x+j,0),!me.length)return L;const we=[];for(le.length?we.push({polygons:me,bounds:N,depth:0}):U(me,N);we.length;){const be=we.pop(),Re=be.depth,Me=le[Re],je=be.bounds[0],Be=be.bounds[1],Ge=Me===0?je.x:je.y,ut=Me===0?Be.x:Be.y,lt=O?O(Me,Ge,ut):.5*(Ge+ut),ct=I1(be.polygons,Ge-j,lt+j,Me),xt=I1(be.polygons,lt-j,ut+j,Me);if(ct.length){const gt=[je,new wt(Me===0?lt:Be.x,Me===1?lt:Be.y)];le.length>Re+1?we.push({polygons:ct,bounds:gt,depth:Re+1}):U(ct,gt)}if(xt.length){const gt=[new wt(Me===0?lt:je.x,Me===1?lt:je.y),Be];le.length>Re+1?we.push({polygons:xt,bounds:gt,depth:Re+1}):U(xt,gt)}}return L}(l,i,Math.ceil((g-p)/11.25),Math.ceil((y-v)/11.25),1,(T,N,I)=>{if(T===0)return .5*(N+I);{const P=Nt((a.y+N/Bt)/u);return(at(.5*(Nt((a.y+I/Bt)/u)+P))*u-a.y)*Bt}})}function i8(l,i,a,u,p,g){const y=Math.pow(2,u.z-p.z);for(let v=0;v<a;v++){let T=l.int16[2*(v+i)+0],N=l.int16[2*(v+i)+1];T=(T+p.x*Bt)*y-u.x*Bt,N=(N+p.y*Bt)*y-u.y*Bt,g.push(new wt(T,N))}}let mk,fk;Yt(D1,"FillExtrusionBucket",{omit:["layers","features"]}),Yt(nk,"PartData"),Yt(rk,"FootprintSegment"),Yt(sk,"BorderCentroidData"),Yt(qN,"GroundEffect");class Tm extends wt{constructor(i,a,u){super(i,a),this.z=u}}class gk extends Tm{constructor(i,a,u,p){super(i,a,u),this.w=p}}function yk(l,i,a,u){const p=a==="x"?"y":"x",g=(u-l[a])/(i[a]-l[a]);l[p]=Math.round(l[p]+(i[p]-l[p])*g),l[a]=u,l.hasOwnProperty("z")&&(l.z=Si(l.z,i.z,g)),l.hasOwnProperty("w")&&(l.w=Si(l.w,i.w,g))}function xk(l,i,a,u){const p=a,g=u;for(const y of["x","y"]){let v=l,T=i;v[y]>=T[y]&&(v=i,T=l),v[y]<p&&T[y]>p&&yk(v,T,y,p),v[y]<g&&T[y]>g&&yk(T,v,y,g)}}function M1(l,i,a,u,p,g){const y=[];for(let v=0;v<l.length;v++){const T=l[v];let N;const I=y.length;let P=0;for(let j=0;j<T.length-1;j++){let O=T[j],L=T[j+1],U=0;const Z=P;let G,ee;g&&(U=Math.hypot(L.x-O.x,L.y-O.y),P+=U,G=O,ee=L),O.x<i&&L.x<i||(O.x<i?O=new wt(i,O.y+(i-O.x)/(L.x-O.x)*(L.y-O.y))._round():L.x<i&&(L=new wt(i,O.y+(i-O.x)/(L.x-O.x)*(L.y-O.y))._round()),O.y<a&&L.y<a||(O.y<a?O=new wt(O.x+(a-O.y)/(L.y-O.y)*(L.x-O.x),a)._round():L.y<a&&(L=new wt(O.x+(a-O.y)/(L.y-O.y)*(L.x-O.x),a)._round()),O.x>=u&&L.x>=u||(O.x>=u?O=new wt(u,O.y+(u-O.x)/(L.x-O.x)*(L.y-O.y))._round():L.x>=u&&(L=new wt(u,O.y+(u-O.x)/(L.x-O.x)*(L.y-O.y))._round()),O.y>=p&&L.y>=p||(O.y>=p?O=new wt(O.x+(p-O.y)/(L.y-O.y)*(L.x-O.x),p)._round():L.y>=p&&(L=new wt(O.x+(p-O.y)/(L.y-O.y)*(L.x-O.x),p)._round()),N&&O.equals(N[N.length-1])||(N=[O],y.push(N),g&&g.push({progress:{min:Z+_k(G,ee,O)*U,max:1},parentIndex:v,prevPoint:G,nextPoint:ee})),N.push(L),g&&(g[g.length-1].progress.max=Z+_k(G,ee,L)*U,g[g.length-1].nextPoint=ee)))))}if(g&&P>0)for(let j=I;j<y.length;j++)g[j].progress.min/=P,g[j].progress.max/=P}return y}function r8(l,i,a,u,p){if(l.length<2)return void u.push(l);const g=[];for(;i.valid();){const[N,I]=i.get();for(let P=0;P<l.length-1;P++){const j=l[P],O=l[P+1],L=bm(j,O,N,I);if(L){const[U]=L,Z=new wt(Si(j.x,O.x,U),Si(j.y,O.y,U));g.push({t:P+U,distance:0,point:Z})}}i.next()}if(g.length===0)return void u.push(l);g.sort((N,I)=>N.t-I.t);let y=0,v=0,T=[];for(u.push(T);y!==l.length;){if(v===g.length){for(;y!==l.length;)T.length!==0&&T[T.length-1].equals(l[y])||T.push(l[y]),y++;break}g[v].t<=y?(T.length!==0&&T[T.length-1].equals(g[v].point)||T.push(g[v].point),Math.trunc(g[v].t),v++):(T.length!==0&&T[T.length-1].equals(l[y])||T.push(l[y]),y++)}}function _k(l,i,a){return l.x!==i.x?(a.x-l.x)/(i.x-l.x):l.y!==i.y?(a.y-l.y)/(i.y-l.y):0}function R_(l,i){return l.x*i.x+l.y*i.y}function vk(l,i){if(l.length===1){let a=0;const u=i[a++];let p;for(;!p||u.equals(p);)if(p=i[a++],!p)return 1/0;for(;a<i.length;a++){const g=i[a],y=l[0],v=p.sub(u),T=g.sub(u),N=y.sub(u),I=R_(v,v),P=R_(v,T),j=R_(T,T),O=R_(N,v),L=R_(N,T),U=I*j-P*P,Z=(j*O-P*L)/U,G=(I*L-P*O)/U,ee=u.z*(1-Z-G)+p.z*Z+g.z*G;if(isFinite(ee))return ee}return 1/0}{let a=1/0;for(const u of i)a=Math.min(a,u.z);return a}}function bk(l,i,a){let u=1/0;Qr(a,i)&&(u=vk(a,i[0]));for(let p=0;p<i.length;p++){const g=i[p],y=l[p];for(let v=0;v<g.length-1;v++){const T=g[v],N=[T,g[v+1],y[v+1],y[v],T];_n(a,N)&&(u=Math.min(u,vk(a,N)))}}return u!==1/0&&u}function wk(l,i,a,u,p,g,y,v,T,N,I){return l.projection.name==="globe"?function(P,j,O,L,U,Z,G,ee,le,me,we){const be=[],Re=[],Me=P.projection.upVectorScale(we,P.center.lat,P.worldSize).metersToTile,je=[0,0,0,1],Be=[0,0,0,1],Ge=(lt,ct,xt,gt)=>{lt[0]=ct,lt[1]=xt,lt[2]=gt,lt[3]=1},ut=hk();O>0&&(O+=ut),L+=ut;for(const lt of j){const ct=[],xt=[];for(const gt of lt){const yt=gt.x+U.x,st=gt.y+U.y,bt=P.projection.projectTilePoint(yt,st,we),mt=P.projection.upVector(we,gt.x,gt.y);let Tt=O,_t=L;if(G){const Zt=Sk(yt,st,O,L,G,ee,le,me);Tt+=Zt.base,_t+=Zt.top}O!==0?Ge(je,bt.x+mt[0]*Me*Tt,bt.y+mt[1]*Me*Tt,bt.z+mt[2]*Me*Tt):Ge(je,bt.x,bt.y,bt.z),Ge(Be,bt.x+mt[0]*Me*_t,bt.y+mt[1]*Me*_t,bt.z+mt[2]*Me*_t),Bi(je,je,Z),Bi(Be,Be,Z),ct.push(new Tm(je[0],je[1],je[2])),xt.push(new Tm(Be[0],Be[1],Be[2]))}be.push(ct),Re.push(xt)}return[be,Re]}(l,i,a,u,p,g,y,v,T,N,I):y?function(P,j,O,L,U,Z,G,ee,le){const me=[],we=[],be=[0,0,0,1];for(const Re of P){const Me=[],je=[];for(const Be of Re){const Ge=Be.x+L.x,ut=Be.y+L.y,lt=Sk(Ge,ut,j,O,Z,G,ee,le);be[0]=Ge,be[1]=ut,be[2]=lt.base,be[3]=1,Vi(be,be,U),be[3]=Math.max(be[3],1e-5);const ct=new Tm(be[0]/be[3],be[1]/be[3],be[2]/be[3]);be[0]=Ge,be[1]=ut,be[2]=lt.top,be[3]=1,Vi(be,be,U),be[3]=Math.max(be[3],1e-5);const xt=new Tm(be[0]/be[3],be[1]/be[3],be[2]/be[3]);Me.push(ct),je.push(xt)}me.push(Me),we.push(je)}return[me,we]}(i,a,u,p,g,y,v,T,N):function(P,j,O,L,U){const Z=[],G=[],ee=U[8]*j,le=U[9]*j,me=U[10]*j,we=U[11]*j,be=U[8]*O,Re=U[9]*O,Me=U[10]*O,je=U[11]*O;for(const Be of P){const Ge=[],ut=[];for(const lt of Be){const ct=lt.x+L.x,xt=lt.y+L.y,gt=U[0]*ct+U[4]*xt+U[12],yt=U[1]*ct+U[5]*xt+U[13],st=U[2]*ct+U[6]*xt+U[14],bt=U[3]*ct+U[7]*xt+U[15],mt=gt+ee,Tt=yt+le,_t=st+me,Zt=Math.max(bt+we,1e-5),Xt=gt+be,Ft=yt+Re,Vt=st+Me,xi=Math.max(bt+je,1e-5);Ge.push(new Tm(mt/Zt,Tt/Zt,_t/Zt)),ut.push(new Tm(Xt/xi,Ft/xi,Vt/xi))}Z.push(Ge),G.push(ut)}return[Z,G]}(i,a,u,p,g)}function Sk(l,i,a,u,p,g,y,v){const T=y*p.getElevationAt(l,i,!0,!0),N=g[0]!==0,I=N?g[1]===0?y*(g[0]/7-450):y*function(P,j,O){const L=Math.floor(j[0]/8),U=Math.floor(j[1]/8),Z=10*(j[0]-8*L),G=10*(j[1]-8*U),ee=P.getElevationAt(L,U,!0,!0),le=P.getMeterToDEM(O),me=Math.floor(.5*(Z*le-1)),we=Math.floor(.5*(G*le-1)),be=P.tileCoordToPixel(L,U),Re=2*me+1,Me=2*we+1,je=function(xt,gt,yt,st,bt){return[xt.getElevationAtPixel(gt,yt,!0),xt.getElevationAtPixel(gt+bt,yt,!0),xt.getElevationAtPixel(gt,yt+bt,!0),xt.getElevationAtPixel(gt+st,yt+bt,!0)]}(P,be.x-me,be.y-we,Re,Me),Be=Math.abs(je[0]-je[1]),Ge=Math.abs(je[2]-je[3]),ut=Math.abs(je[0]-je[2])+Math.abs(je[1]-je[3]),lt=Math.min(.25,.5*le*(Be+Ge)/Re),ct=Math.min(.25,.5*le*ut/Me);return ee+Math.max(lt*Z,ct*G)}(p,g,v):T;return{base:T+(a===0?-1:a),top:N?Math.max(I+u,T+a+2):T+u}}class n8{constructor(i){this._callback=i,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class s8{constructor(){this.tasks={},this.taskQueue=[],Ht(["process"],this),this.invoker=new n8(this.process),this.nextId=0}add(i,a){const u=this.nextId++,p=function({type:g,isSymbolTile:y,zoom:v}){return v=v||0,g==="message"?0:g!=="maybePrepare"||y?g!=="parseTile"||y?g==="parseTile"&&y?300-v:g==="maybePrepare"&&y?400-v:500:200-v:100-v}(a);if(p===0){try{i()}finally{}return null}return this.tasks[u]={fn:i,metadata:a,priority:p,id:u},this.taskQueue.push(u),this.invoker.trigger(),{cancel:()=>{delete this.tasks[u]}}}process(){try{if(this.taskQueue=this.taskQueue.filter(u=>!!this.tasks[u]),!this.taskQueue.length)return;const i=this.pick();if(i===null)return;const a=this.tasks[i];if(delete this.tasks[i],this.taskQueue.length&&this.invoker.trigger(),!a)return;a.fn()}finally{}}pick(){let i=null,a=1/0;for(let p=0;p<this.taskQueue.length;p++){const g=this.tasks[this.taskQueue[p]];g.priority<a&&(a=g.priority,i=p)}if(i===null)return null;const u=this.taskQueue[i];return this.taskQueue.splice(i,1),u}remove(){this.invoker.remove()}}class Tk{constructor(i,a,u){this.target=i,this.parent=a,this.mapId=u,this.callbacks={},this.cancelCallbacks={},Ht(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new s8}send(i,a,u,p,g=!1,y){const v=Math.round(1e18*Math.random()).toString(36).substring(0,10);u&&(u.metadata=y,this.callbacks[v]=u);const T=new Set;return this.target.postMessage({id:v,type:i,hasCallback:!!u,targetMapId:p,mustQueue:g,sourceMapId:this.mapId,data:Cl(a,T)},T),{cancel:()=>{u&&delete this.callbacks[v],this.target.postMessage({id:v,type:"<cancel>",targetMapId:p,sourceMapId:this.mapId})}}}receive(i){const a=i.data;if(!a)return;const u=a.id;if(u&&(!a.targetMapId||this.mapId===a.targetMapId))if(a.type==="<cancel>"){const p=this.cancelCallbacks[u];delete this.cancelCallbacks[u],p&&p.cancel()}else if(a.mustQueue||Rn(self)){const p=this.callbacks[u],g=this.scheduler.add(()=>this.processTask(u,a),p&&p.metadata||{type:"message"});g&&(this.cancelCallbacks[u]=g)}else this.processTask(u,a)}processTask(i,a){if(delete this.cancelCallbacks[i],a.type==="<response>"){const u=this.callbacks[i];delete this.callbacks[i],u&&(a.error?u(Rc(a.error)):u(null,Rc(a.data)))}else{const u=new Set,p=a.hasCallback?(y,v)=>{this.target.postMessage({id:i,type:"<response>",sourceMapId:this.mapId,error:y?Cl(y):null,data:Cl(v,u)},u)}:()=>{},g=Rc(a.data);if(this.parent[a.type])this.parent[a.type](a.sourceMapId,g,p);else if(this.parent.getWorkerSource){const y=a.type.split("."),{source:v,scope:T}=g;this.parent.getWorkerSource(a.sourceMapId,y[0],v,T)[y[1]](g,p)}else p(new Error(`Could not find function ${a.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var k_={workerUrl:"",workerClass:null,workerParams:void 0};function a8(l){return k_.workerClass!=null?new k_.workerClass:new self.Worker(k_.workerUrl,Object.assign({name:l},k_.workerParams))}const GN="mapboxgl_preloaded_worker_pool";class Nm{constructor(i){this.active={},this.name=i}acquire(i,a=Nm.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<a;){const u=a8(`${this.name||""}WorkerPool: ${i}-${this.workers.length}`);this.workers.push(u)}return this.active[i]=!0,this.workers.slice()}release(i){delete this.active[i],this.workers&&this.numActive()===0&&(this.workers.forEach(a=>{a.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[GN]}numActive(){return Object.keys(this.active).length}}Nm.workerCount=2;class wg{constructor(i,a,u="Worker",p=Nm.workerCount){this.workerPool=i,this.actors=[],this.currentActor=0,this.id=At();const g=this.workerPool.acquire(this.id,p);for(let y=0;y<g.length;y++){const v=new wg.Actor(g[y],a,this.id);v.name=`${u} ${y}`,this.actors.push(v)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(i,a,u){He(this.actors,(p,g)=>{p.send(i,a,g)},u=u||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(i=>{i.remove()}),this.actors=[],this.workerPool.release(this.id)}}let D_,HN;function O1(){return D_||(D_=new Nm),D_}wg.Actor=Tk;const WN=4096;class o8{constructor(i){this.module=i,this.memoryStack=this.module.malloc(WN),this.memoryStackNextFree=this.memoryStack}createIntArray(i){const a=this.memoryStackNextFree;return this.memoryStackNextFree+=i.length*Int32Array.BYTES_PER_ELEMENT,this.memoryStackNextFree-this.memoryStack>WN?-1:(new Int32Array(this.module.heap32.buffer,a,i.length).set(i),a)}createFloatArray(i){const a=this.memoryStackNextFree;return this.memoryStackNextFree+=i.length*Float32Array.BYTES_PER_ELEMENT,this.memoryStackNextFree-this.memoryStack>WN?-1:(new Float32Array(this.module.heapF32.buffer,a,i.length).set(i),a)}readStringBuffer(i){let a="";for(;this.module.heapU8[i]!==0;)a+=String.fromCharCode(this.module.heapU8[i]),++i;return a}setStyle(i){const a=i.normalScale;this.module.setStyle(a[0],a[1],a[2],i.tileToMeters)}setAOOptions(i,a){this.module.setAOOptions(i?1:0,a)}setMetricOptions(i,a){this.module.setMetricOptions(i?1:0,a)}setStructuralOptions(i){this.module.setStructuralOptions(i?1:0)}setFacadeOptions(i,a){this.module.setFacadeOptions(i,a?1:0)}setFauxFacadeOptions(i,a,u){this.module.setFauxFacadeOptions(i?1:0,a?1:0,u)}setFacadeClassifierOptions(i){this.module.setFacadeClassifierOptions(i)}generateMesh(i,a){this.memoryStackNextFree=this.memoryStack;for(const v of i){const T=this.createIntArray(v.ringIndices),N=this.createFloatArray(v.coordinates);if(T===-1||N===-1)return`building_gen: Out of stack memory: ${this.memoryStackNextFree-this.memoryStack}/4096`;this.module.addFeature(v.id,v.sourceId,v.minHeight,v.height,v.roofType,N,T,v.ringIndices.length-1)}for(const v of a){let T;T=v.entrances?JSON.parse(v.entrances):[];const N=this.createFloatArray(T),I=this.createFloatArray(v.coordinates);if(N===-1||I===-1)return`building_gen: Out of stack memory: ${this.memoryStackNextFree-this.memoryStack}/4096`;this.module.addFacade(v.sourceId,v.crossPerc,v.distanceToRoad,N,T.length,I,v.coordinates.length)}if(!this.module.generateMesh()){const v=this.module.getLastError();return this.readStringBuffer(v)}const u=this.module.getMeshCount(),p=new Array(u);for(let v=0;v<u;v++){const T=this.module.getPositionsPtr(v),N=this.module.getPositionsLength(v),I=new Float32Array(this.module.heapF32.buffer,T,N),P=this.module.getNormalsPtr(v),j=this.module.getNormalsLength(v),O=new Float32Array(this.module.heapF32.buffer,P,j),L=this.module.getAOPtr(v),U=this.module.getAOLength(v),Z=new Float32Array(this.module.heapF32.buffer,L,U),G=this.module.getUVPtr(v),ee=this.module.getUVLength(v),le=new Float32Array(this.module.heapF32.buffer,G,ee),me=this.module.getFauxFacadePtr(v),we=this.module.getFauxFacadeLength(v),be=new Uint8Array(this.module.heapU8.buffer,me,we),Re=this.module.getIndicesPtr(v),Me=this.module.getIndicesLength(v),je=new Int16Array(this.module.heap16.buffer,Re,Me),Be=this.module.getBuildingPart(v);p[v]={positions:I,normals:O,ao:Z,uv:le,isFauxFacade:be,indices:je,buildingPart:Be}}const g=this.module.getRingCount(),y=[];for(let v=0;v<g;v++){const T=this.module.getRingPtr(v),N=this.module.getRingLength(v),I=new Float32Array(this.module.heapF32.buffer,T,N);y.push(I)}return{meshes:p,outerRingLength:this.module.getOuterRingLength(),modifiedPolygonRings:y}}}let M_,ZN,Oc,Sg,XN,Tg=null,Ng=null,Nk=null,L1=null;function Ak(){return Rn(self)&&self.worker.dracoUrl?self.worker.dracoUrl:ZN||ns.DRACO_URL}function Ck(){if(Rn(self)&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(Sg)return Sg;const l=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return Sg=WebAssembly.validate(l)?ns.MESHOPT_SIMD_URL:ns.MESHOPT_URL,Sg}function l8(){return L1}const Ek=5120,Ik=5121,Pk=5122,jk=5123,Rk=5125,kk=5126,F1={[Ek]:Int8Array,[Ik]:Uint8Array,[Pk]:Int16Array,[jk]:Uint16Array,[Rk]:Uint32Array,[kk]:Float32Array},c8={[Ek]:"DT_INT8",[Ik]:"DT_UINT8",[Pk]:"DT_INT16",[jk]:"DT_UINT16",[Rk]:"DT_UINT32",[kk]:"DT_FLOAT32"},O_={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function Dk(l,i,a){const u=a.json.bufferViews.length,p=a.buffers.length;i.bufferView=u,a.json.bufferViews[u]={buffer:p,byteLength:l.byteLength},a.buffers[p]=l}const YN="KHR_draco_mesh_compression";function u8(l,i){const a=l.extensions&&l.extensions[YN];if(!a)return;const u=new Oc.Decoder,p=Fk(i,a.bufferView),g=new Oc.Mesh;if(!u.DecodeArrayToMesh(p,p.byteLength,g))throw new Error("Failed to decode Draco mesh");const y=i.json.accessors[l.indices],v=F1[y.componentType],T=y.count*v.BYTES_PER_ELEMENT,N=Oc._malloc(T);v===Uint16Array?u.GetTrianglesUInt16Array(g,T,N):u.GetTrianglesUInt32Array(g,T,N),Dk(Oc.memory.buffer.slice(N,N+T),y,i),Oc._free(N);for(const I of Object.keys(a.attributes)){const P=u.GetAttributeByUniqueId(g,a.attributes[I]),j=i.json.accessors[l.attributes[I]],O=c8[j.componentType],L=j.count*O_[j.type]*F1[j.componentType].BYTES_PER_ELEMENT,U=Oc._malloc(L);u.GetAttributeDataArrayForAllPoints(g,P,Oc[O],L,U),Dk(Oc.memory.buffer.slice(U,U+L),j,i),Oc._free(U)}u.destroy(),g.destroy(),delete l.extensions[YN]}const z1="EXT_meshopt_compression";function d8(l,i){if(!l.extensions||!l.extensions[z1])return;const a=l.extensions[z1],u=new Uint8Array(i.buffers[a.buffer],a.byteOffset||0,a.byteLength||0),p=new Uint8Array(a.count*a.byteStride);XN.decodeGltfBuffer(p,a.count,a.byteStride,u,a.mode,a.filter),l.buffer=i.buffers.length,l.byteOffset=0,i.buffers[l.buffer]=p.buffer,delete l.extensions[z1]}const Mk=1179937895,Ok=new TextDecoder("utf8");function Lk(l,i){return new URL(l,i).href}function h8(l,i,a,u){return fetch(Lk(l.uri,u)).then(p=>p.arrayBuffer()).then(p=>{i.buffers[a]=p})}function Fk(l,i){const a=l.json.bufferViews[i];return new Uint8Array(l.buffers[a.buffer],a.byteOffset||0,a.byteLength)}function p8(l,i,a,u){if(l.uri){const p=Lk(l.uri,u);return fetch(p).then(g=>g.blob()).then(g=>createImageBitmap(g)).then(g=>{i.images[a]=g})}if(l.bufferView!==void 0){const p=Fk(i,l.bufferView),g=new Blob([p],{type:l.mimeType});return createImageBitmap(g).then(y=>{i.images[a]=y})}}function zk(l,i=0,a){const u={json:null,images:[],buffers:[]};if(new Uint32Array(l,i,1)[0]===Mk){const I=new Uint32Array(l,i);let P=2;const j=(I[P++]>>2)-3,O=I[P++]>>2;if(P++,u.json=JSON.parse(Ok.decode(I.subarray(P,P+O))),P+=O,P<j){const L=I[P++];P++;const U=i+(P<<2);u.buffers[0]=l.slice(U,U+L)}}else u.json=JSON.parse(Ok.decode(new Uint8Array(l,i)));const{buffers:p,images:g,meshes:y,extensionsUsed:v,bufferViews:T}=u.json;let N=Promise.resolve();if(p){const I=[];for(let P=0;P<p.length;P++){const j=p[P];j.uri?I.push(h8(j,u,P,a)):u.buffers[P]||(u.buffers[P]=null)}N=Promise.all(I)}return N.then(()=>{const I=[],P=v&&v.includes(YN),j=v&&v.includes(z1);if(P&&I.push(function(){if(!Oc)return M_??(M_=function(O){let L,U=null;function Z(){L=new Uint8Array(U.buffer)}function G(){throw new Error("Unexpected Draco error.")}const ee={a:{a:G,d:function(le,me,we){return L.copyWithin(le,me,me+we)},c:function(le){const me=L.length,we=Math.max(le>>>0,Math.ceil(1.2*me)),be=Math.ceil((we-me)/65536);try{return U.grow(be),Z(),!0}catch{return!1}},b:G}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(O,ee):O.then(le=>le.arrayBuffer()).then(le=>WebAssembly.instantiate(le,ee))).then(le=>{const{Rb:me,Qb:we,P:be,T:Re,X:Me,Ja:je,La:Be,Qa:Ge,Va:ut,Wa:lt,eb:ct,jb:xt,f:gt,e:yt,yb:st,zb:bt,Ab:mt,Bb:Tt,Db:_t,Gb:Zt}=le.instance.exports;U=yt;const Xt=(()=>{let Ft=0,Vt=0,xi=0,ri=0;return Gt=>{xi&&(me(ri),me(Ft),Vt+=xi,xi=Ft=0),Ft||(Vt+=128,Ft=we(Vt));const Ri=Gt.length+7&-8;let tr=Ft;Ri>=Vt&&(xi=Ri,tr=ri=we(Ri));for(let Cr=0;Cr<Gt.length;Cr++)L[tr+Cr]=Gt[Cr];return tr}})();return Z(),gt(),{memory:yt,_free:me,_malloc:we,Mesh:class{constructor(){this.ptr=be()}destroy(){Re(this.ptr)}},Decoder:class{constructor(){this.ptr=je()}destroy(){xt(this.ptr)}DecodeArrayToMesh(Ft,Vt,xi){const ri=Xt(Ft),Gt=Be(this.ptr,ri,Vt,xi.ptr);return!!Me(Gt)}GetAttributeByUniqueId(Ft,Vt){return{ptr:Ge(this.ptr,Ft.ptr,Vt)}}GetTrianglesUInt16Array(Ft,Vt,xi){ut(this.ptr,Ft.ptr,Vt,xi)}GetTrianglesUInt32Array(Ft,Vt,xi){lt(this.ptr,Ft.ptr,Vt,xi)}GetAttributeDataArrayForAllPoints(Ft,Vt,xi,ri,Gt){ct(this.ptr,Ft.ptr,Vt.ptr,xi,ri,Gt)}},DT_INT8:st(),DT_UINT8:bt(),DT_INT16:mt(),DT_UINT16:Tt(),DT_UINT32:_t(),DT_FLOAT32:Zt()}})}(fetch(Ak())),M_.then(O=>{Oc=O,M_=void 0}))}()),j&&I.push(function(){if(XN)return;const O=function(L){let U;const Z=WebAssembly.instantiateStreaming(L,{}).then(le=>{U=le.instance,U.exports.__wasm_call_ctors()}),G={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},ee={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:Z,supported:!0,decodeGltfBuffer(le,me,we,be,Re,Me){(function(je,Be,Ge,ut,lt,ct,xt){const gt=je.exports.sbrk,yt=ut+3&-4,st=gt(yt*lt),bt=gt(ct.length),mt=new Uint8Array(je.exports.memory.buffer);mt.set(ct,bt);const Tt=Be(st,ut,lt,bt,ct.length);if(Tt===0&&xt&&xt(st,yt,lt),Ge.set(mt.subarray(st,st+ut*lt)),gt(st-gt(0)),Tt!==0)throw new Error(`Malformed buffer data: ${Tt}`)})(U,U.exports[ee[Re]],le,me,we,be,U.exports[G[Me]])}}}(fetch(Ck()));return O.ready.then(()=>{XN=O})}()),g)for(let O=0;O<g.length;O++)I.push(p8(g[O],u,O,a));return(I.length?Promise.all(I):Promise.resolve()).then(()=>{if(P&&y)for(const{primitives:O}of y)for(const L of O)u8(L,u);if(j&&y&&T)for(const O of T)d8(O,u);return u})})}function Bk(l){return fetch(l).then(i=>i.arrayBuffer()).then(i=>zk(i,0,l))}function KN(l){switch(l){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function QN(l){switch(l){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class JN{constructor(i,a,u,p){this.context=i,this.format=u,this.useMipmap=p&&p.useMipmap,this.texture=i.gl.createTexture(),this.update(a,{premultiply:p&&p.premultiply})}update(i,a){const u=i&&i instanceof HTMLVideoElement&&i.width===0?i.videoWidth:i.width,p=i&&i instanceof HTMLVideoElement&&i.height===0?i.videoHeight:i.height,{context:g}=this,{gl:y}=g,{x:v,y:T}=a&&a.position?a.position:{x:0,y:0},N=v+u,I=T+p;!this.size||this.size[0]===N&&this.size[1]===I||(y.bindTexture(y.TEXTURE_2D,null),y.deleteTexture(this.texture),this.texture=y.createTexture(),this.size=null),y.bindTexture(y.TEXTURE_2D,this.texture),g.pixelStoreUnpackFlipY.set(!1),g.pixelStoreUnpack.set(1),g.pixelStoreUnpackPremultiplyAlpha.set(this.format===y.RGBA8&&(!a||a.premultiply!==!1));const P=i instanceof HTMLImageElement||i instanceof HTMLCanvasElement||i instanceof HTMLVideoElement||i instanceof ImageData||ImageBitmap&&i instanceof ImageBitmap;if(!this.size&&N>0&&I>0){const j=this.useMipmap?Math.floor(Math.log2(Math.max(N,I)))+1:1;y.texStorage2D(y.TEXTURE_2D,j,this.format,N,I),this.size=[N,I]}this.size&&(P?y.texSubImage2D(y.TEXTURE_2D,0,v,T,KN(this.format),QN(this.format),i):"data"in i&&i.data&&y.texSubImage2D(y.TEXTURE_2D,0,v,T,u,p,KN(this.format),QN(this.format),i.data)),this.useMipmap&&y.generateMipmap(y.TEXTURE_2D)}bind(i,a,u=!1){const{context:p}=this,{gl:g}=p;g.bindTexture(g.TEXTURE_2D,this.texture),i!==this.minFilter&&(g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,i),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,this.useMipmap&&!u?i===g.NEAREST?g.NEAREST_MIPMAP_NEAREST:g.LINEAR_MIPMAP_LINEAR:i),this.minFilter=i),a!==this.wrapS&&(g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,a),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,a),this.wrapS=a)}bindExtraParam(i,a,u,p,g){const{context:y}=this,{gl:v}=y;v.bindTexture(v.TEXTURE_2D,this.texture),a!==this.magFilter&&(v.texParameteri(v.TEXTURE_2D,v.TEXTURE_MAG_FILTER,a),this.magFilter=a),i!==this.minFilter&&(v.texParameteri(v.TEXTURE_2D,v.TEXTURE_MIN_FILTER,this.useMipmap?i===v.NEAREST?v.NEAREST_MIPMAP_NEAREST:v.LINEAR_MIPMAP_LINEAR:i),this.minFilter=i),u!==this.wrapS&&(v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_S,u),this.wrapS=u),p!==this.wrapT&&(v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_T,p),this.wrapT=p),g!==this.compareMode&&(g?(v.texParameteri(v.TEXTURE_2D,v.TEXTURE_COMPARE_MODE,v.COMPARE_REF_TO_TEXTURE),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_COMPARE_FUNC,g)):v.texParameteri(v.TEXTURE_2D,v.TEXTURE_COMPARE_MODE,v.NONE),this.compareMode=g)}destroy(){const{gl:i}=this.context;i.deleteTexture(this.texture),this.texture=null}}class L_{constructor(i,a){this.context=i,this.texture=a}bind(i,a){const{context:u}=this,{gl:p}=u;p.bindTexture(p.TEXTURE_2D,this.texture),i!==this.minFilter&&(p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,i),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,i),this.minFilter=i),a!==this.wrapS&&(p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,a),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,a),this.wrapS=a)}}const m8=sr([{name:"a_pos_3f",components:3,type:"Float32"}]),f8=sr([{name:"a_color_3f",components:3,type:"Float32"}]),g8=sr([{name:"a_color_4f",components:4,type:"Float32"}]),y8=sr([{name:"a_uv_2f",components:2,type:"Float32"}]),x8=sr([{name:"a_normal_3f",components:3,type:"Float32"}]),_8=sr([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),v8=sr([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);function Vk(l,i){const a=B1(l.projection,l.zoom,l.width,l.height),u=function(g,y,v,T,N){const I=new Se(v.lng-180*Ph,v.lat),P=new Se(v.lng+180*Ph,v.lat),j=g.project(I.lng,I.lat),O=g.project(P.lng,P.lat),L=-Math.atan2(O.y-j.y,O.x-j.x),U=Ut.fromLngLat(v);U.y=Ie(U.y,-1+Ph,1-Ph);const Z=U.toLngLat(),G=g.project(Z.lng,Z.lat),ee=Ut.fromLngLat(Z);ee.x+=Ph;const le=ee.toLngLat(),me=g.project(le.lng,le.lat),we=qk(me.x-G.x,me.y-G.y,L),be=Ut.fromLngLat(Z);be.y+=Ph;const Re=be.toLngLat(),Me=g.project(Re.lng,Re.lat),je=qk(Me.x-G.x,Me.y-G.y,L),Be=Math.abs(we.x)/Math.abs(je.y),Ge=se([]);ne(Ge,Ge,-L*(1-(N?0:T)));const ut=se([]);return Ae(ut,ut,[1,1-(1-Be)*T,1]),ut[4]=-je.x/je.y*T,ne(ut,ut,L),K(ut,Ge,ut),ut}(l.projection,0,l.center,a,i),p=Uk(l);return Ae(u,u,[p,p,1]),u}function Uk(l){const i=l.projection,a=B1(l.projection,l.zoom,l.width,l.height),u=eA(i,l.center),p=eA(i,Se.convert(i.center));return Math.pow(2,u*a+(1-a)*p)}function B1(l,i,a,u,p=1/0){const g=l.range;if(!g)return 0;const y=Math.min(p,Math.max(a,u)),v=Math.log2(y/1024);return Xe(g[0]+v,g[1]+v,i)}const Ph=1/4e4;function eA(l,i){const a=Ie(i.lat,-85.051129,$e),u=new Se(i.lng-180*Ph,a),p=new Se(i.lng+180*Ph,a),g=l.project(u.lng,a),y=l.project(p.lng,a),v=Ut.fromLngLat(u),T=Ut.fromLngLat(p),N=y.x-g.x,I=y.y-g.y,P=T.x-v.x,j=T.y-v.y,O=Math.sqrt((P*P+j*j)/(N*N+I*I));return Math.log2(O)}function qk(l,i,a){const u=Math.cos(a),p=Math.sin(a);return{x:l*u-i*p,y:l*p+i*u}}function $k(l,i,a){se(l),ne(l,l,Zi(i[2])),Te(l,l,Zi(i[0])),Ce(l,l,Zi(i[1])),Ae(l,l,a),K(l,l,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function V1(l,i,a,u,p,g,y,v){const T=[a[0]-i[0],a[1]-i[1],0],N=[u[0]-i[0],u[1]-i[1],0];if(ve(T)<1e-12||ve(N)<1e-12)return vi(l);const I=Fi([],T,N);ni(I,I),It(N,u,i),T[2]=(g-p)*v,N[2]=(y-p)*v;const P=T;return Fi(P,T,N),ni(P,P),or(l,I,P)}function U1(l,i,a=!1){const u=Ah(i.zoom),p=function(g,y,v){const T=y.worldSize,N=[g[12],g[13],g[14]],I=Nt(N[1]/T),P=ft(N[0]/T),j=se([]),O=nt(1,I)*T,L=nt(1,0)*T*ot(I,y.zoom),U=1/wN(T);let Z=L*U;if(v){const me=B1(y.projection,y.zoom,y.width,y.height,1024);Z=U*y.projection.pixelSpaceConversion(y.center.lat,T,me)}const G=De(I,P);Pe(G,G,Ot([],ni([],G),O*Z*N[2]));const ee=function(me){const we=[me[0],me[1],me[2]];let be=[0,1,0];const Re=Fi([],be,we);return Fi(be,we,Re),ht(be)===0&&(be=[0,1,0],Fi(Re,we,be)),ni(Re,Re),ni(be,be),ni(we,we),[Re[0],Re[1],Re[2],0,be[0],be[1],be[2],0,we[0],we[1],we[2],0,me[0],me[1],me[2],1]}(G);Ae(j,j,[Z,Z,Z*O]),ge(j,j,[-N[0],-N[1],-N[2]]);const le=K([],y.globeMatrix,ee);return K(le,le,j),K(le,le,g),le}(l,i,a);if(u>0){const g=function(y,v){const T=v.worldSize,N=nt(1,0)*T*ot(v.center.lat,v.zoom)/wN(T),I=nt(1,v.center.lat)*T,P=se([]);Ce(P,P,Zi(v.center.lng)),Te(P,P,Zi(v.center.lat)),ge(P,P,[0,0,J]),Ae(P,P,[N,N,N*I]);const j=v.point;return ge(P,P,[-j.x,-j.y,0]),K(P,P,y),K(P,v.globeMatrix,P)}(l,i);return function(y,v,T){const N=(L,U,Z)=>{const G=ve(L),ee=ve(U),le=_d(L,U,Z);return Ot(le,le,1/ve(le)*Si(G,ee,Z))},I=N([y[0],y[1],y[2]],[v[0],v[1],v[2]],T),P=N([y[4],y[5],y[6]],[v[4],v[5],v[6]],T),j=N([y[8],y[9],y[10]],[v[8],v[9],v[10]],T),O=_d([y[12],y[13],y[14]],[v[12],v[13],v[14]],T);return[I[0],I[1],I[2],0,P[0],P[1],P[2],0,j[0],j[1],j[2],0,O[0],O[1],O[2],1]}(p,g,u)}return p}function tA(l,i,a,u){const p=jr.projectAabbCorners(u,a);let g=Number.MAX_VALUE;for(let v=0;v<p.length;++v){const T=p[v];T[0]=(.5*T[0]+.5)*i.width,T[1]=(.5-.5*T[1])*i.height,T[2]<g&&(g=T[2])}const y=function(v){const T=[];let N=0;for(let O=1;O<v.length;O++)(v[O][0]<v[N][0]||v[O][0]===v[N][0]&&v[O][1]<v[N][1])&&(N=O);let I,P=N;const j=new Uint8Array(v.length);do{if(j[P])break;T.push(new wt(v[P][0],v[P][1])),j[P]=1,I=(P+1)%v.length;for(let O=0;O<v.length;O++){if(v[O][0]===v[I][0]&&v[O][1]===v[I][1]||v[O][0]===v[P][0]&&v[O][1]===v[P][1])continue;const L=[v[O][0]-v[P][0],v[O][1]-v[P][1]],U=[v[I][0]-v[P][0],v[I][1]-v[P][1]],Z=L[0]*U[1]-L[1]*U[0];(Z>0||Z===0&&L[0]*U[0]+L[1]*U[1]>=0&&L[0]*L[0]+L[1]*L[1]>U[0]*U[0]+U[1]*U[1])&&(I=O)}P=I}while(P!==N);return T.length>0&&T.push(T[0]),T}(p);if(_n(l,y))return g}const Am=64,Ag={CoordinateSpaceTile:1,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function q1(l,i,a,u,p,g,y,v,T,N=!1){const I=a.zoom,P=a.project(u),j=ot(u.lat,I),O=1/j;se(l),ge(l,l,[P.x+y[0]*O,P.y+y[1]*O,y[2]]);let L=1,U=1;const Z=a.worldSize;if(N){if(a.projection.name==="mercator"){let me=0;a.elevation&&(me=a.elevation.getAtPointOrZero(new Ut(P.x/Z,P.y/Z),0));const we=Vi([],[P.x,P.y,me,1],a.projMatrix)[3]/a.cameraToCenterDistance;L=we,U=we*ot(a.center.lat,I)}else if(a.projection.name==="globe"){const me=U1(l,a),we=[0,0,0,1];Vi(we,we,K([],a.projMatrix,me));const be=we[3]/a.cameraToCenterDistance,Re=Ah(I),Me=a.projection.pixelsPerMeter(u.lat,Z)*ot(u.lat,I),je=a.projection.pixelsPerMeter(a.center.lat,Z)*ot(a.center.lat,I);L=be/Si(Me,dt(a.center.lat),Re),U=be*j/Me,L*=je,U*=je}}else L=O;Ae(l,l,[L,L,U]);const G=[...l],ee=i.orientation,le=[];if($k(le,[ee[0]+(p?p[0]:0),ee[1]+(p?p[1]:0),ee[2]+(p?p[2]:0)],g),K(l,G,le),v&&a.elevation){let me=0;const we=[];if(T&&a.elevation){me=function(Re,Me,je,Be,Ge){const ut=Me.elevation;if(!ut)return 0;const lt=jr.projectAabbCorners(je,Be),ct=nt(1,Ge.lat)*Me.worldSize,xt=function(Vt,xi){const ri=[0,0,1],Gt=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const Ri of Gt){const tr=Vt[Ri.corners[0]],Cr=Vt[Ri.corners[1]],Qi=Vt[Ri.corners[2]],Ur=[Cr[0]-tr[0],Cr[1]-tr[1],xi*(Cr[2]-tr[2])],fr=Fi(Ur,Ur,[Qi[0]-tr[0],Qi[1]-tr[1],xi*(Qi[2]-tr[2])]);ni(fr,fr),Ri.dotProductWithUp=ui(fr,ri)}return Gt.sort((Ri,tr)=>Ri.dotProductWithUp-tr.dotProductWithUp),Gt[0].corners}(lt,ct),gt=lt[xt[0]],yt=lt[xt[1]],st=lt[xt[2]],bt=lt[xt[3]],mt=ut.getAtPointOrZero(new Ut(gt[0]/Me.worldSize,gt[1]/Me.worldSize),0),Tt=ut.getAtPointOrZero(new Ut(yt[0]/Me.worldSize,yt[1]/Me.worldSize),0),_t=ut.getAtPointOrZero(new Ut(st[0]/Me.worldSize,st[1]/Me.worldSize),0),Zt=ut.getAtPointOrZero(new Ut(bt[0]/Me.worldSize,bt[1]/Me.worldSize),0),Xt=(mt+Zt)/2,Ft=(Tt+_t)/2;return Xt>Ft?Tt<_t?V1(Re,yt,bt,gt,Tt,Zt,mt,ct):V1(Re,st,gt,bt,_t,mt,Zt,ct):mt<Zt?V1(Re,gt,yt,st,mt,Tt,_t,ct):V1(Re,bt,st,yt,Zt,_t,Tt,ct),Math.max(Xt,Ft)}(we,a,i.aabb,l,u);const be=K([],ke([],we),le);K(l,G,be)}else me=a.elevation.getAtPointOrZero(new Ut(P.x/Z,P.y/Z),0);me!==0&&(l[14]+=me)}}class Gk{constructor(i,a,u,p,g){this.materialOverrides=new Map,this.nodeOverrides=new Map,this.materialOverrideNames=[],this.nodeOverrideNames=[],this.featureProperties={},this.id=i,this.uri=a,this.position=u!=null?new Se(u[0],u[1]):new Se(0,0),this.orientation=p??[0,0,0],this.nodes=g,this.uploaded=!1,this.aabb=new jr([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(i,a){K(i.globalMatrix,a,i.localMatrix);const u=this.nodeOverrides.get(i.name);if(u!==void 0){const y=[];g=u.orientation,se(p=y),Ce(p,p,Zi(g[1])),ne(p,p,Zi(g[2])),Te(p,p,Zi(g[0])),K(i.globalMatrix,i.globalMatrix,y)}var p,g;if(i.meshes)for(const y of i.meshes){const v=jr.applyTransformFast(y.aabb,i.globalMatrix);this.aabb.encapsulate(v)}if(i.children)for(const y of i.children)this._applyTransformations(y,i.globalMatrix)}computeBoundsAndApplyParent(){const i=se([]);this.aabb=new jr([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const a of this.nodes)this._applyTransformations(a,i)}computeModelMatrix(i,a,u,p,g,y,v=!1){q1(this.matrix,this,i.transform,this.position,a,u,p,g,y,v)}upload(i){if(!this.uploaded){for(const a of this.nodes)iA(a,i);for(const a of this.nodes)$1(a);this.uploaded=!0}}destroy(){for(const i of this.nodes)rA(i)}}function F_(l,i,a=!1){l.uploaded||(l.gfxTexture=new JN(i,l.image,a?i.gl.R8:i.gl.RGBA8,{useMipmap:l.sampler.minFilter>=i.gl.NEAREST_MIPMAP_NEAREST}),l.uploaded=!0,l.image=null)}function b8(l,i,a){l.indexBuffer=i.createIndexBuffer(l.indexArray,!1,!0),l.vertexBuffer=i.createVertexBuffer(l.vertexArray,m8.members,!1,!0),l.normalArray&&(l.normalBuffer=i.createVertexBuffer(l.normalArray,x8.members,!1,!0)),l.texcoordArray&&(l.texcoordBuffer=i.createVertexBuffer(l.texcoordArray,y8.members,!1,!0)),l.colorArray&&(l.colorBuffer=i.createVertexBuffer(l.colorArray,(l.colorArray.bytesPerElement===12?f8:g8).members,!1,!0)),l.featureArray&&(l.pbrBuffer=i.createVertexBuffer(l.featureArray,v8.members,!0)),l.segments=dn.simpleSegment(0,0,l.vertexArray.length,l.indexArray.length);const u=l.material;u.pbrMetallicRoughness.baseColorTexture&&F_(u.pbrMetallicRoughness.baseColorTexture,i),u.pbrMetallicRoughness.metallicRoughnessTexture&&F_(u.pbrMetallicRoughness.metallicRoughnessTexture,i),u.normalTexture&&F_(u.normalTexture,i),u.occlusionTexture&&F_(u.occlusionTexture,i,a),u.emissionTexture&&F_(u.emissionTexture,i)}function iA(l,i,a){if(l.meshes)for(const u of l.meshes)b8(u,i,a);if(l.children)for(const u of l.children)iA(u,i,a)}function $1(l){if(l.meshes)for(const i of l.meshes)i.indexArray.destroy(),i.vertexArray.destroy(),i.colorArray&&i.colorArray.destroy(),i.normalArray&&i.normalArray.destroy(),i.texcoordArray&&i.texcoordArray.destroy(),i.featureArray&&i.featureArray.destroy();if(l.children)for(const i of l.children)$1(i)}function w8(l){l.pbrMetallicRoughness.baseColorTexture&&l.pbrMetallicRoughness.baseColorTexture.gfxTexture&&l.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),l.pbrMetallicRoughness.metallicRoughnessTexture&&l.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&l.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),l.normalTexture&&l.normalTexture.gfxTexture&&l.normalTexture.gfxTexture.destroy(),l.emissionTexture&&l.emissionTexture.gfxTexture&&l.emissionTexture.gfxTexture.destroy(),l.occlusionTexture&&l.occlusionTexture.gfxTexture&&l.occlusionTexture.gfxTexture.destroy()}function rA(l){if(l.meshes)for(const i of l.meshes)i.vertexBuffer&&(i.vertexBuffer.destroy(),i.indexBuffer.destroy(),i.normalBuffer&&i.normalBuffer.destroy(),i.texcoordBuffer&&i.texcoordBuffer.destroy(),i.colorBuffer&&i.colorBuffer.destroy(),i.pbrBuffer&&i.pbrBuffer.destroy(),i.segments.destroy(),i.material&&w8(i.material));if(l.children)for(const i of l.children)rA(i)}function Cm(l,i){const a=l.json.bufferViews[i.bufferView],u=F1[i.componentType];return new u(l.buffers[a.buffer],(i.byteOffset||0)+(a.byteOffset||0),i.count*(a.byteStride&&a.byteStride!==O_[i.type]*u.BYTES_PER_ELEMENT?a.byteStride/u.BYTES_PER_ELEMENT:O_[i.type]))}function nA(l,i,a,u){const p=F1[i.componentType],g=function(I){switch(I){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(p),y=l.json.bufferViews[i.bufferView],v=y.byteStride?y.byteStride/p.BYTES_PER_ELEMENT:O_[i.type],T=a.float32,N=T.length/a.capacity;for(let I=0,P=0;I<i.count*v;I+=v,P+=N)for(let j=0;j<N;j++)T[P+j]=u[I+j]*g;a._trim()}function S8(l,i,a){const u=l.indices,p=l.attributes,g={};g.indexArray=new ys;const y=i.json.accessors[u],v=y.count/3;g.indexArray.reserve(v);const T=Cm(i,y);for(let j=0;j<v;j++)g.indexArray.emplaceBack(T[3*j],T[3*j+1],T[3*j+2]);g.indexArray._trim(),g.vertexArray=new pl;const N=i.json.accessors[p.POSITION];g.vertexArray.reserve(N.count);const I=Cm(i,N);for(let j=0;j<N.count;j++)g.vertexArray.emplaceBack(I[3*j],I[3*j+1],I[3*j+2]);if(g.vertexArray._trim(),g.aabb=new jr(N.min,N.max),g.centroid=function(j,O){const L=[0,0,0],U=j.length;if(U>0){for(let Z=0;Z<U;Z++){const G=3*j[Z];L[0]+=O[G],L[1]+=O[G+1],L[2]+=O[G+2]}L[0]/=U,L[1]/=U,L[2]/=U}return L}(T,I),p.COLOR_0!==void 0){const j=i.json.accessors[p.COLOR_0],O=O_[j.type],L=Cm(i,j);g.colorArray=O===3?new pl:new Tu,g.colorArray.resize(j.count),nA(i,j,g.colorArray,L)}if(p.NORMAL!==void 0){g.normalArray=new pl;const j=i.json.accessors[p.NORMAL];g.normalArray.resize(j.count);const O=Cm(i,j);nA(i,j,g.normalArray,O)}if(p.TEXCOORD_0!==void 0&&a.length>0){g.texcoordArray=new yd;const j=i.json.accessors[p.TEXCOORD_0];g.texcoordArray.resize(j.count);const O=Cm(i,j);nA(i,j,g.texcoordArray,O)}if(p._FEATURE_ID_RGBA4444!==void 0){const j=i.json.accessors[p._FEATURE_ID_RGBA4444];i.json.extensionsUsed&&i.json.extensionsUsed.includes("EXT_meshopt_compression")&&(g.featureData=Cm(i,j))}p._FEATURE_RGBA4444!==void 0&&(g.featureData=new Uint32Array(Cm(i,i.json.accessors[p._FEATURE_RGBA4444]).buffer));const P=l.material;return g.material=function(j,O){const{emissiveFactor:L=[0,0,0],alphaMode:U="OPAQUE",alphaCutoff:Z=.5,normalTexture:G,occlusionTexture:ee,emissiveTexture:le,doubleSided:me,name:we}=j,{baseColorFactor:be=[1,1,1,1],metallicFactor:Re=1,roughnessFactor:Me=1,baseColorTexture:je,metallicRoughnessTexture:Be}=j.pbrMetallicRoughness||{},Ge=ee?O[ee.index]:void 0;if(ee&&ee.extensions&&ee.extensions.KHR_texture_transform&&Ge){const ut=ee.extensions.KHR_texture_transform;Ge.offsetScale=[ut.offset[0],ut.offset[1],ut.scale[0],ut.scale[1]]}return{name:we,pbrMetallicRoughness:{baseColorFactor:new Ar(...be),metallicFactor:Re,roughnessFactor:Me,baseColorTexture:je?O[je.index]:void 0,metallicRoughnessTexture:Be?O[Be.index]:void 0},doubleSided:me,emissiveFactor:new Ar(...L),alphaMode:U,alphaCutoff:Z,normalTexture:G?O[G.index]:void 0,occlusionTexture:Ge,emissionTexture:le?O[le.index]:void 0,defined:j.defined===void 0}}(P!==void 0?i.json.materials[P]:{defined:!1},a),g}function Hk(l,i,a){const{matrix:u,rotation:p,translation:g,scale:y,mesh:v,extras:T,children:N,name:I}=l,P={};if(P.name=I,P.localMatrix=u||function(j,O,L,U){var Z=O[0],G=O[1],ee=O[2],le=O[3],me=Z+Z,we=G+G,be=ee+ee,Re=Z*me,Me=Z*we,je=Z*be,Be=G*we,Ge=G*be,ut=ee*be,lt=le*me,ct=le*we,xt=le*be,gt=U[0],yt=U[1],st=U[2];return j[0]=(1-(Be+ut))*gt,j[1]=(Me+xt)*gt,j[2]=(je-ct)*gt,j[3]=0,j[4]=(Me-xt)*yt,j[5]=(1-(Re+ut))*yt,j[6]=(Ge+lt)*yt,j[7]=0,j[8]=(je+ct)*st,j[9]=(Ge-lt)*st,j[10]=(1-(Re+Be))*st,j[11]=0,j[12]=L[0],j[13]=L[1],j[14]=L[2],j[15]=1,j}([],p||[0,0,0,1],g||[0,0,0],y||[1,1,1]),P.globalMatrix=he(P.localMatrix),v!==void 0){P.meshes=a[v];const j=P.anchor=[0,0];for(const O of P.meshes){const{min:L,max:U}=O.aabb;j[0]+=L[0]+U[0],j[1]+=L[1]+U[1]}j[0]=Math.floor(j[0]/P.meshes.length/2),j[1]=Math.floor(j[1]/P.meshes.length/2)}if(T&&(T.id&&(P.id=T.id),T.lights&&(P.lights=function(j){if(!j.length)return[];const O=function(ee){const le=atob(ee),me=new Uint8Array(le.length);for(let we=0;we<le.length;we++)me[we]=le.codePointAt(we);return me}(j),L=[],U=O.length/24,Z=new Uint16Array(O.buffer),G=new Float32Array(O.buffer);for(let ee=0;ee<U;ee++){const le=Z[2*ee*6]/30,me=Z[2*ee*6+1]/30,we=Z[2*ee*6+10]/100,be=G[6*ee+1],Re=G[6*ee+2],Me=G[6*ee+3],je=G[6*ee+4],Be=Me-be,Ge=je-Re,ut=Math.hypot(Be,Ge);L.push({pos:[be+.5*Be,Re+.5*Ge,me],normal:[Ge/ut,-Be/ut,0],width:ut,height:le,depth:we,points:[be,Re,Me,je]})}return L}(T.lights)),T.MAPBOX_geometry_bloom&&(P.isGeometryBloom=T.MAPBOX_geometry_bloom)),N){const j=[];for(const O of N)j.push(Hk(i.json.nodes[O],i,a));P.children=j}return P}function T8(l){if(l.vertices.length===0||l.indices.length===0)return null;const i=new P1(l.vertices,l.indices,8,256),[a,u]=[i.min.clone(),i.max.clone()];return{vertices:l.vertices,indices:l.indices,grid:i,min:a,max:u}}function N8(l){if(!l.extras||!l.extras.ground)return null;const i=l.extras.ground;if(!i||!Array.isArray(i)||i.length===0)return null;const a=i[0];if(!a||!Array.isArray(a)||a.length===0)return null;const u=[];for(const y of a){if(!Array.isArray(y)||y.length!==2)continue;const v=y[0],T=y[1];typeof v=="number"&&typeof T=="number"&&u.push(new wt(v,T))}if(u.length<3)return null;u.length>1&&u[u.length-1].equals(u[0])&&u.pop();let p=0;for(let y=0;y<u.length;y++){const v=u[y],T=u[(y+1)%u.length],N=u[(y+2)%u.length];p+=(v.x-T.x)*(N.y-T.y)-(N.x-T.x)*(v.y-T.y)}p>0&&u.reverse();const g=xg(u.flatMap(y=>[y.x,y.y]),[]);return g.length===0?null:{vertices:u,indices:g}}function A8(l,i){const a=[],u=[];let p=0;const g=[];for(const y of l){p=a.length;const v=y.vertexArray.float32,T=y.indexArray.uint16;for(let N=0;N<y.vertexArray.length;N++)g[0]=v[3*N+0],g[1]=v[3*N+1],g[2]=v[3*N+2],Bi(g,g,i),a.push(new wt(g[0],g[1]));for(let N=0;N<3*y.indexArray.length;N++)u.push(T[N]+p)}if(u.length%3!=0)return null;for(let y=0;y<u.length;y+=3){const v=a[u[y+0]],T=a[u[y+1]],N=a[u[y+2]];(v.x-T.x)*(N.y-T.y)-(N.x-T.x)*(v.y-T.y)>0&&([u[y+1],u[y+2]]=[u[y+2],u[y+1]])}return{vertices:a,indices:u}}function sA(l){const i=function(T,N){const I=[],P=WebGL2RenderingContext;if(T.json.textures)for(const j of T.json.textures){const O={magFilter:P.LINEAR,minFilter:P.NEAREST,wrapS:P.REPEAT,wrapT:P.REPEAT};j.sampler!==void 0&&Object.assign(O,T.json.samplers[j.sampler]),I.push({image:N[j.source],sampler:O,uploaded:!1})}return I}(l,l.images),a=function(T,N){const I=[];for(const P of T.json.meshes){const j=[];for(const O of P.primitives)j.push(S8(O,T,N));I.push(j)}return I}(l,i),{scenes:u,scene:p,nodes:g}=l.json,y=u?u[p||0].nodes:[...g.keys()],v=[];for(const T of y)v.push(Hk(g[T],l,a));return function(T,N,I){const P={},j=new Set;for(let O=0;O<T.length;O++){const L=I[N[O]];if(!L.extras)continue;const U=L.extras["mapbox:footprint:version"],Z=L.extras["mapbox:footprint:id"];(U||Z)&&j.add(O),U==="1.0.0"&&Z&&(P[Z]=O)}for(let O=0;O<T.length;O++){if(j.has(O))continue;const L=T[O],U=I[N[O]];if(!U.extras)continue;let Z=null;L.id in P&&(Z=A8(T[P[L.id]].meshes,L.localMatrix)),Z||(Z=N8(U)),Z&&(L.footprint=T8(Z))}if(j.size>0){const O=Array.from(j.values()).sort((L,U)=>L-U);for(let L=O.length-1;L>=0;L--)T.splice(O[L],1)}}(v,y,l.json.nodes),v}function C8(l){l.heightmap=new Float32Array(4096),l.heightmap.fill(-1);const i=l.vertexArray.float32,a=l.aabb.min[0]-1,u=l.aabb.min[1]-1,p=Am/(l.aabb.max[0]-a+2),g=Am/(l.aabb.max[1]-u+2);for(let y=0;y<i.length;y+=3){const v=i[y+2],T=(i[y+0]-a)*p|0,N=(i[y+1]-u)*g|0;v>l.heightmap[N*Am+T]&&(l.heightmap[N*Am+T]=v)}}function Wk(l,i,a,u,p){a.reserve(a.length+4*l.length),u.reserve(u.length+10*l.length),p.reserve(p.length+10*l.length);let g=u.length;for(const y of l){const v=Math.min(10,Math.max(4,1.3*y.height))*i,T=[-y.normal[1],y.normal[0],0],N=Math.min(.29,.1*y.width/y.depth),I=y.width-2*y.depth*i*(N+.01),P=Et([],y.pos,T,I/2),j=Et([],y.pos,T,-I/2),O=[P[0],P[1],P[2]+y.height],L=[j[0],j[1],j[2]+y.height],U=Et([],y.normal,T,N);Ot(U,U,v);const Z=Et([],y.normal,T,-N);Ot(Z,Z,v),Pe(U,P,U),Pe(Z,j,Z),P[2]+=.1,j[2]+=.1,u.emplaceBack(U[0],U[1],U[2]),u.emplaceBack(Z[0],Z[1],Z[2]),u.emplaceBack(P[0],P[1],P[2]),u.emplaceBack(j[0],j[1],j[2]),u.emplaceBack(O[0],O[1],O[2]),u.emplaceBack(L[0],L[1],L[2]),u.emplaceBack(P[0],P[1],P[2]),u.emplaceBack(j[0],j[1],j[2]),u.emplaceBack(U[0],U[1],U[2]),u.emplaceBack(Z[0],Z[1],Z[2]);const G=I/v/2;p.emplaceBack(-G-N,-1,G,.8),p.emplaceBack(G+N,-1,G,.8),p.emplaceBack(-G,0,G,1.3),p.emplaceBack(G,0,G,1.3),p.emplaceBack(G+N,-.8,G,.7),p.emplaceBack(G+N,-.8,G,.7),p.emplaceBack(0,0,G,1.3),p.emplaceBack(0,0,G,1.3),p.emplaceBack(G+N,-1.2,G,.8),p.emplaceBack(G+N,-1.2,G,.8),a.emplaceBack(6+g,4+g,8+g),a.emplaceBack(7+g,9+g,5+g),a.emplaceBack(0+g,1+g,2+g),a.emplaceBack(1+g,3+g,2+g),g+=10}}function E8(l,i){const a={};a.indexArray=new ys,a.vertexArray=new pl,a.colorArray=new Tu,Wk(l,i,a.indexArray,a.vertexArray,a.colorArray);const u={defined:!0};u.emissiveFactor=Ar.black;const p={};return p.baseColorFactor=Ar.white,u.pbrMetallicRoughness=p,a.material=u,a.aabb=new jr([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),a}const Zk=sr([{name:"a_pos_3f",components:3,type:"Float32"}]),I8=sr([{name:"a_normal_3",components:3,type:"Int16"}]),P8=sr([{name:"a_centroid_3",components:3,type:"Int16"}]),Xk=sr([{name:"a_part_color_emissive",components:2,type:"Uint16"}]),j8=sr([{name:"a_faux_facade_color_emissive",components:2,type:"Uint16"}]),R8=sr([{name:"a_faux_facade_data",components:4,type:"Uint16"}]),k8=sr([{name:"a_faux_facade_vertical_range",components:2,type:"Uint16"}]),D8=sr([{name:"a_bloom_attenuation",components:4,type:"Float32"}]),M8=sr([{name:"a_flood_light_wall_radius_1i16",components:1,type:"Uint16"}]),Yk=lr.types,G1=32767;function O8(l,i){const a=Bt+i;for(const u of l)for(const p of u)if(p.x<-i||p.x>a||p.y<-i||p.y>a)return!1;return!0}function L8(l){switch(l){case"flat":return 3;case"hipped":return 1;case"gabled":return 2;case"parapet":return 0;case"mansard":return 4;case"skillion":return 5;case"pyramidal":return 6;default:throw new Error(`Unknown roof shape: ${l}`)}}class aA{constructor(){this.layoutVertexArray=new pl,this.layoutAttenuationArray=new Tu,this.layoutColorArray=new qo,this.indexArray=new ys,this.indexArrayForConflation=new ys,this.segmentsBucket=new dn}}class oA{constructor(i){this.layoutFacadePaintArray=null,this.layoutFacadeDataArray=null,this.layoutFacadeVerticalRangeArray=null,this.segmentsBucket=new dn,this.entranceBloom=new aA;const a=66560;this.layoutVertexArray=new pl,this.layoutVertexArray.reserve(a),this.layoutNormalArray=new kc,this.layoutNormalArray.reserve(a),this.layoutCentroidArray=new kc,this.layoutCentroidArray.reserve(a),this.layoutColorArray=new qo,this.layoutColorArray.reserve(a),this.layoutFloodLightDataArray=new mm,this.layoutFloodLightDataArray.reserve(a),this.layoutAOArray=new mg,this.layoutAOArray.reserve(a),this.indexArray=new ys,this.indexArray.reserve(66560),this.indexArrayForConflation=new ys,this.segmentsBucket=new dn,this.entranceBloom=new aA,i&&(this.layoutFacadePaintArray=new qo,this.layoutFacadeDataArray=new vh,this.layoutFacadeVerticalRangeArray=new qo)}reserve(i,a,u){this.layoutVertexArray.reserveForAdditional(i),this.layoutCentroidArray.reserveForAdditional(i),this.layoutFloodLightDataArray.reserveForAdditional(i),this.layoutNormalArray.reserveForAdditional(i),this.layoutAOArray.reserveForAdditional(i),this.layoutColorArray.reserveForAdditional(i),this.indexArray.reserveForAdditional(a),u&&(this.layoutFacadePaintArray.reserveForAdditional(i),this.layoutFacadeDataArray.reserveForAdditional(i),this.layoutFacadeVerticalRangeArray.reserveForAdditional(i))}}class Kk{constructor(i){this.colorBufferUploaded=!1,this.maxHeight=0,this.replacementUpdateTime=0,this.activeReplacements=[],this.footprints=[],this.footprintsVertices=new yd,this.footprintsIndices=new mm,this.footprintsMin=new wt(1/0,1/0),this.footprintsMax=new wt(-1/0,-1/0),this.featuresOnBorder=[],this.buildingWithoutFacade=new oA(!1),this.buildingWithFacade=new oA(!0),this.indexArrayForConflationUploaded=!1,this.featureFootprintLookup=new Map,this.buildingIds=new Set,this.footprintLookup={},this.zoom=i.zoom,this.canonical=i.canonical,this.layers=i.layers,this.layerIds=this.layers.map(a=>a.fqid),this.index=i.index,this.hasPattern=!1,this.worldview=i.worldview,this.lut=i.lut,this.programConfigurations=new M(i.layers,{zoom:i.zoom,lut:i.lut}),this.stateDependentLayerIds=this.layers.filter(a=>a.isStateDependent()).map(a=>a.id),this.projection=i.projection,this.groundEffect=new qN(i),this.groundEffect.groundRadiusArray=new Qs,this.hasAppearances=null}updateFootprints(i,a){const u=new P1([],[],1),p={vertices:[],indices:new Uint32Array(0),grid:u,min:this.footprintsMin,max:this.footprintsMax,buildingIds:this.buildingIds};a.push({footprint:p,id:i})}updateAppearances(i,a,u,p){}prepare(){return function(){if(L1!=null||Nk!=null)return null;if(Ng!=null)return Ng;const i=fetch(ns.BUILDING_GEN_URL);return Ng=function(a){let u,p,g,y,v;function T(){u=new Uint8Array(v.buffer),p=new Int16Array(v.buffer),g=new Int32Array(v.buffer),y=new Float32Array(v.buffer)}function N(){throw new Error("Unexpected BuildingGen error.")}const I=()=>{},P={a:{a:N,f:function(j){const O=u.length,L=Math.max(j>>>0,Math.ceil(1.2*O)),U=Math.ceil((L-O)/65536);try{return v.grow(U),T(),!0}catch{return!1}},g:N,b:I,c:I,d:I,e:I}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(a,P):a.then(j=>j.arrayBuffer()).then(j=>WebAssembly.instantiate(j,P))).then(j=>{const O=j.instance.exports;return(0,O.g)(),v=O.f,T(),new o8({setStyle:O.h,setAOOptions:O.i,setMetricOptions:O.j,setStructuralOptions:O.k,setFacadeOptions:O.l,setFauxFacadeOptions:O.m,setFacadeClassifierOptions:O.n,addFeature:O.o,addFacade:O.p,generateMesh:O.q,getLastError:O.r,getOuterRingLength:O.s,getMeshCount:O.t,getPositionsPtr:O.u,getPositionsLength:O.v,getNormalsPtr:O.w,getNormalsLength:O.x,getAOPtr:O.y,getAOLength:O.z,getUVPtr:O.A,getUVLength:O.B,getFauxFacadePtr:O.C,getFauxFacadeLength:O.D,getIndicesPtr:O.E,getIndicesLength:O.F,getBuildingPart:O.G,getRingCount:O.H,getRingPtr:O.I,getRingLength:O.J,malloc:O.K,free:O.L,heapU8:u,heap16:p,heap32:g,heapF32:y})})}(i).then(a=>(Ng=null,L1=a,L1)).catch(a=>{Ni("Could not load building-gen"),Ng=null,Nk=a}),Ng}()}populate(i,a,u,p){const g=l8();if(!g)return;const y=Rt(u);this.tileToMeter=y,this.brightness=a.brightness,g.setStyle({normalScale:[1,-1,y],tileToMeters:y}),g.setAOOptions(!1,.3),g.setMetricOptions(!1,16),g.setStructuralOptions(!0),g.setFacadeClassifierOptions(3);const v=new Map,T=new Map;let N=0;for(const{feature:G}of i){if(Yk[G.type]!=="LineString"){v.set(G.id,G.properties.source_id);continue}const ee=this.layers[0]._featureFilter.needGeometry;if(ee&&!this.layers[0]._featureFilter.filter(new Vr(this.zoom),G,u))continue;const le=Hi(G,ee);if(!ee&&!this.layers[0]._featureFilter.filter(new Vr(this.zoom),le,u))continue;const me=ee?le.geometry:Ci(G,u,p),we=[];for(const je of me)for(const Be of je)we.push(Be.x),we.push(Be.y);const be={coordinates:we,crossPerc:G.properties.cross_perc,distanceToRoad:G.properties.distance_to_road,entrances:G.properties.entrances,sourceId:0},Re=G.properties.source_id;let Me=T.get(Re);Me||(Me=[],T.set(Re,Me)),Me.push(be),++N}this.maxHeight=0;const I=new Array,P=new Set,j=G=>{G!=null&&P.add(G)},O=(G,ee)=>{G!=null&&I.push({buildingId:G,footprintIndex:ee})},L=64*(i.length-N),U=L/2;this.buildingWithFacade.reserve(L,U,!0),this.buildingWithoutFacade.reserve(2*L,2*U,!1),this.footprintsIndices.reserve(16*(i.length-N)),this.footprintsVertices.reserve(8*(i.length-N));for(const{feature:G,id:ee,index:le,sourceLayerIndex:me}of i){if(Yk[G.type]==="LineString")continue;const we=this.layers[0]._featureFilter.needGeometry;if(we&&!this.layers[0]._featureFilter.filter(new Vr(this.zoom),G,u))continue;let be=null;if(G.properties&&G.properties.hasOwnProperty("building_id")&&(be=Number(G.properties.building_id),P.has(be)))continue;const Re=Hi(G,we);if(!we&&!this.layers[0]._featureFilter.filter(new Vr(this.zoom),Re,u))continue;const Me=we?Re.geometry:Ci(G,u,p),je=N_(Me,500);let Be=!1;for(const Ji of je)if(Ji.length!==1){Be=!0;break}if(Be){j(be);continue}if(!O8(Me,163)){j(be);continue}const Ge=this.layers[0],ut=L8(Ge.layout.get("building-roof-shape").evaluate(G,{},u)),lt=Ge.layout.get("building-base").evaluate(G,{},u),ct=Ge.layout.get("building-height").evaluate(G,{},u),xt=Ge.layout.get("building-flood-light-ground-radius").evaluate(G,{},u),gt=Ge.paint.get("building-ambient-occlusion-intensity"),yt=xt/this.tileToMeter;G.properties["building-part"]="roof";const st=Ge.paint.get("building-color").evaluate(G,{},this.canonical).toPremultipliedRenderColor(this.lut),bt=Ge.paint.get("building-emissive-strength").evaluate(G,{},this.canonical);G.properties["building-part"]="wall";const mt=Ge.paint.get("building-color").evaluate(G,{},this.canonical).toPremultipliedRenderColor(this.lut),Tt=Ge.paint.get("building-emissive-strength").evaluate(G,{},this.canonical);G.properties["building-part"]="window";const _t=Ge.paint.get("building-color").evaluate(G,{},this.canonical).toPremultipliedRenderColor(this.lut),Zt=Ge.paint.get("building-emissive-strength").evaluate(G,{},this.canonical);G.properties["building-part"]="door";const Xt=Ge.paint.get("building-color").evaluate(G,{},this.canonical).toPremultipliedRenderColor(this.lut),Ft=Ge.paint.get("building-emissive-strength").evaluate(G,{},this.canonical);let Vt=Ge.layout.get("building-flood-light-wall-radius").evaluate(G,{},u);Vt=Ie(Vt,0,2048);const xi=Vt/2048*G1,ri=v.get(ee),Gt=T.get(ri)||[],Ri=Gt.length!==0&&Ge.layout.get("building-facade").evaluate(G,{},u);g.setFacadeOptions(4,!0),g.setFauxFacadeOptions(Ri,!1,1);let tr=0,Cr=0,Qi=0,Ur=0,fr=0,Bn=0,_r=0,Mr=0,ln=0,vn=0,bn=0;if(Ri){let Ji=Math.round(Ge.layout.get("building-facade-floors").evaluate(G,{},u));if(lt===0){Ji=Math.max(1,Ji-(Gt.length>0?1:0));let Un=4;if(ct>100){const vs=[10,13,15];Un=vs[G.id?G.id%vs.length:0]}else ct<=10&&(Un=3);g.setFacadeOptions(Un,!0),fr=(ct<15?1.3:1.61803)*Un/y}else fr=lt/y;Bn=ct/y,fr=Math.min(fr,Bn),Qi=Ge.layout.get("building-facade-unit-width").evaluate(G,{},u)/y,Ur=(Bn-fr)/Ji,g.setFauxFacadeOptions(!0,!0,Qi);const Vs=Ge.layout.get("building-facade-window").evaluate(G,{},u);tr=Vs[0],Cr=Vs[1],_r=Math.floor(65535*Math.min(1,fr/Bt)),Mr=Math.floor(65535*Math.min(1,Bn/Bt)),ln=Math.floor(255*tr)<<8|Math.floor(255*Cr),vn=Math.floor(65535*Math.min(1,Qi/Bt)),bn=Math.floor(65535*Math.min(1,Ur/Bt))}const Vn=Array(je.length),Js={x:1/0,y:1/0},Sa={x:-1/0,y:-1/0},os={x:0,y:0};let _s=0;for(let Ji=0;Ji<je.length;Ji++){const Vs=je[Ji];if(Vs.length>0){const Un=[],vs=Array(Vs.length+1);vs[0]=0;for(let Rl=0;Rl<Vs.length;Rl++){const To=Vs[Rl];for(let Ko=0;Ko<To.length;Ko++){const Us=To[To.length-Ko-1];Js.x=Math.min(Js.x,Us.x),Js.y=Math.min(Js.y,Us.y),Sa.x=Math.max(Sa.x,Us.x),Sa.y=Math.max(Sa.y,Us.y),os.x+=Us.x,os.y+=Us.y,_s++,Un.push(Us.x),Un.push(Us.y)}vs[Rl+1]=Un.length}Vn[Ji]={id:G.id?G.id:0,height:ct,minHeight:lt,sourceId:0,roofType:ut,coordinates:Un,ringIndices:vs}}}os.x/=_s||1,os.y/=_s||1;const Rs=g.generateMesh(Vn,Gt);if(typeof Rs=="string"){Ni(`Unable to generate building ${G.id}: ${Rs}`),j(be);continue}if(Rs.meshes.length===0||Rs.modifiedPolygonRings.length===0){j(be);continue}const Xi=Ri?this.buildingWithFacade:this.buildingWithoutFacade;let wn=0;for(const Ji of Rs.meshes)wn+=Ji.positions.length/3;const Mn=Xi.segmentsBucket.prepareSegment(wn,Xi.layoutVertexArray,Xi.indexArray),Yo=[];let $a=null,ea=0,Ga=-1;const Eu=Xi.layoutVertexArray.length,Ea=Eu+wn;Xi.layoutVertexArray.resize(Ea),Xi.layoutCentroidArray.resize(Ea),Xi.layoutNormalArray.resize(Ea),Xi.layoutAOArray.resize(Ea),Xi.layoutColorArray.resize(Ea),Xi.layoutFloodLightDataArray.resize(Ea),Ri&&(Xi.layoutFacadePaintArray.resize(Ea),Xi.layoutFacadeDataArray.resize(Ea),Xi.layoutFacadeVerticalRangeArray.resize(Ea));const gw=Xi.indexArray.length;let Fg=0,so=Eu;for(const Ji of Rs.meshes){let Vs,Un;if(Ji.buildingPart===1)Vs=st,Un=bt;else if(Ji.buildingPart===0)Vs=mt,Un=Tt;else if(Ji.buildingPart===2)Vs=_t,Un=Zt;else{if(Ji.buildingPart!==3)continue;Vs=Xt,Un=Ft}if(Un=Ie(Un,0,1),Ji.buildingPart===3){const ls=new Array;for(let Pa=0;Pa<Ji.positions.length;Pa+=12){const Mh=Ji.positions[Pa+0],ia=Ji.positions[Pa+1],No=Ji.positions[Pa+3],uc=Ji.positions[Pa+4],ju=Ji.positions[Pa+2],GA=Ji.positions[Pa+8]-ju,HA=1,l0=No-Mh,Bg=uc-ia,zc=Math.hypot(l0,Bg);ls.push({pos:[Mh+.5*l0,ia+.5*Bg,ju],normal:[Bg/zc,-l0/zc,0],width:zc,height:GA,depth:HA,points:[Mh,ia,No,uc]})}const ta=Xi.entranceBloom.segmentsBucket.prepareSegment(10*ls.length,Xi.entranceBloom.layoutVertexArray,Xi.entranceBloom.indexArray),bs=Xi.entranceBloom.layoutVertexArray.length;ea=Xi.entranceBloom.indexArray.length,Wk(ls,.5/this.tileToMeter,Xi.entranceBloom.indexArray,Xi.entranceBloom.layoutVertexArray,Xi.entranceBloom.layoutAttenuationArray);const Ia=Xi.entranceBloom.layoutVertexArray.length-bs;Ga=Xi.entranceBloom.indexArray.length-ea;for(let Pa=0;Pa<Ia;Pa++)Xi.entranceBloom.layoutColorArray.emplaceBack(255*Xt.r<<8|255*Xt.g,255*Xt.b<<8|51*Ft);ta.vertexLength+=Ia,ta.primitiveLength+=Ga,$a={part:Ji.buildingPart,vertexOffset:bs,vertexLength:Ia}}Xi.layoutVertexArray.float32.set(Ji.positions,3*so);const vs=Ji.positions.length/3;for(let ls=0;ls<vs;++ls){const ta=3*ls;Fg=Math.max(Fg,Ji.positions[ta+2]);const bs=Ji.normals[ta+1]*G1,Ia=Ji.normals[ta+2]*G1,Pa=3*(so+ls);Xi.layoutNormalArray.int16[Pa]=Ji.normals[ta]*G1,Xi.layoutNormalArray.int16[Pa+1]=bs,Xi.layoutNormalArray.int16[Pa+2]=Ia;const Mh=Ji.ao[ls];Xi.layoutAOArray.uint8[so+ls]=255*Mh;const ia=1+(Mh-1)*gt,No=255*Vs.b*ia<<8|255*Un;Xi.layoutColorArray.uint16[2*(so+ls)]=255*Vs.r*ia<<8|255*Vs.g*ia,Xi.layoutColorArray.uint16[2*(so+ls)+1]=No}const Rl=Math.floor(os.x),To=Math.floor(os.y),Ko=Math.floor(ct);for(let ls=0;ls<vs;++ls){const ta=3*(so+ls);Xi.layoutCentroidArray.int16[ta]=Rl,Xi.layoutCentroidArray.int16[ta+1]=To,Xi.layoutCentroidArray.int16[ta+2]=Ko}if(Xi.layoutFloodLightDataArray.uint16.fill(Ji.buildingPart===0?xi:0,so,so+vs),Ri){const ls=255*_t.r<<8|255*_t.g,ta=255*_t.b<<8|255*Zt;for(let bs=0;bs<vs;++bs){const Ia=2*(so+bs);Xi.layoutFacadePaintArray.uint16[Ia]=ls,Xi.layoutFacadePaintArray.uint16[Ia+1]=ta}for(let bs=0;bs<vs;++bs)if(Ji.isFauxFacade[bs]){const Ia=Math.min(65535,Math.floor(Ji.uv[2*bs]*Rs.outerRingLength));Xi.layoutFacadeDataArray.emplace(so+bs,1|Ia,ln,vn,bn),Xi.layoutFacadeVerticalRangeArray.emplace(so+bs,_r,Mr)}else Xi.layoutFacadeDataArray.emplace(so+bs,0,0,0,0),Xi.layoutFacadeVerticalRangeArray.emplace(so+bs,0,0)}const Us=Mn.vertexLength,o0=Ji.indices.length/3,Pu=Xi.indexArray.length;Xi.indexArray.resize(Pu+o0);for(let ls=0;ls<o0;++ls){const ta=3*ls,bs=3*Pu+ta;Xi.indexArray.uint16[bs]=Us+Ji.indices[ta],Xi.indexArray.uint16[bs+1]=Us+Ji.indices[ta+1],Xi.indexArray.uint16[bs+2]=Us+Ji.indices[ta+2]}Ji.buildingPart!==1&&Ji.buildingPart!==0&&Ji.buildingPart!==2&&Ji.buildingPart!==3||Yo.push({part:Ji.buildingPart,vertexOffset:so,vertexLength:Ji.positions.length/3}),so+=vs,Mn.vertexLength+=vs,Mn.primitiveLength+=Ji.indices.length/3}this.maxHeight=Math.max(this.maxHeight,Fg);const yw=Xi.indexArray.length-gw,Iu=this.footprintsIndices.length,Td=this.footprintsVertices.length,Dh=[],jl=new wt(1/0,1/0),cc=new wt(-1/0,-1/0),a0=this.groundEffect.vertexArray.length;for(const Ji of Rs.modifiedPolygonRings){const Vs=[],Un=new wt(1/0,1/0),vs=new wt(-1/0,-1/0);for(let Rl=0;Rl<Ji.length;Rl+=2){const To=Ji.length-Rl-2;Un.x=Math.min(Un.x,Ji[To]),Un.y=Math.min(Un.y,Ji[To+1]),vs.x=Math.max(vs.x,Ji[To]),vs.y=Math.max(vs.y,Ji[To+1]);const Ko=new wt(Ji[To],Ji[To+1]);Vs.push(Ko),Dh.push(Ko.x,Ko.y),this.footprintsVertices.emplaceBack(Ko.x,Ko.y)}jl.x=Math.min(jl.x,Un.x),jl.y=Math.min(jl.y,Un.y),cc.x=Math.max(cc.x,vs.x),cc.y=Math.max(cc.y,vs.y),this.groundEffect.addData(Vs,[Un,vs],yt)}const zg=this.groundEffect.vertexArray.length-a0;this.groundEffect.groundRadiusArray.reserveForAdditional(zg);for(let Ji=0;Ji<zg;Ji++)this.groundEffect.groundRadiusArray.emplaceBack(xt);(Js.x<0||Sa.x>Bt||Js.y<0||Sa.y>Bt)&&this.featuresOnBorder.push({featureId:G.id,footprintIndex:this.footprints.length});{const Ji=xg(Dh,null,2);this.footprintsIndices.resize(this.footprintsIndices.length+Ji.length),this.footprintsIndices.uint16.set(Ji,Iu),this.buildingIds.add(be??G.id),this.footprintsMin.x=Math.min(this.footprintsMin.x,jl.x),this.footprintsMin.y=Math.min(this.footprintsMin.y,jl.y),this.footprintsMax.x=Math.max(this.footprintsMax.x,cc.x),this.footprintsMax.y=Math.max(this.footprintsMax.y,cc.y);const Vs={footprintVertexOffset:Td,footprintVertexLength:this.footprintsVertices.length-Td,footprintIndexOffset:Iu,footprintIndexLength:this.footprintsIndices.length-Iu,min:jl,max:cc,hiddenFlags:0,indicesOffset:gw,indicesLength:yw,bloomIndicesOffset:ea,bloomIndicesLength:Ga,groundEffectVertexOffset:a0,groundEffectVertexLength:zg,hasFauxFacade:Ri,height:Fg,promoteId:ee,feature:Re,parts:Yo,buildingBloom:$a},Un=this.footprints.length;G.id!==void 0&&this.featureFootprintLookup.set(G.id,Un),O(be,Un),this.footprints.push(Vs)}this.programConfigurations.populatePaintArrays(Xi.layoutVertexArray.length,G,le,{},a.availableImages,u,a.brightness),this.groundEffect.addPaintPropertiesData(G,le,{},a.availableImages,u,a.brightness),a.featureIndex.insert(G,Me,le,me,this.index,Eu)}I.forEach(({buildingId:G,footprintIndex:ee})=>{P.has(G)&&(this.footprints[ee].hiddenFlags|=4)});const Z=new Set;this.buildingIds.forEach((G,ee,le)=>{P.has(G)||Z.add(G)}),this.buildingIds=Z,this.groundEffect.prepareBorderSegments()}update(i,a,u,p,g,y,v){this.programConfigurations.updatePaintArrays(i,a,g,u,p,y,v),this.groundEffect.update(i,a,g,u,p,y,v),this.evaluate(this.layers[0],i),this.colorBufferUploaded=!1}isEmpty(){return this.buildingWithoutFacade.layoutVertexArray.length===0&&this.buildingWithFacade.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(i){const a=u=>{u.layoutVertexBuffer=i.createVertexBuffer(u.layoutVertexArray,Zk.members),u.layoutNormalBuffer=i.createVertexBuffer(u.layoutNormalArray,I8.members),u.layoutCentroidBuffer=i.createVertexBuffer(u.layoutCentroidArray,P8.members),u.layoutFloodLightDataBuffer=i.createVertexBuffer(u.layoutFloodLightDataArray,M8.members),u.layoutFacadeDataArray&&u.layoutFacadeDataArray.length&&(u.layoutFacadeDataBuffer=i.createVertexBuffer(u.layoutFacadeDataArray,R8.members)),u.layoutFacadeVerticalRangeArray&&u.layoutFacadeVerticalRangeArray.length&&(u.layoutFacadeVerticalRangeBuffer=i.createVertexBuffer(u.layoutFacadeVerticalRangeArray,k8.members)),u.entranceBloom.layoutVertexArray.length&&(u.entranceBloom.layoutVertexBuffer=i.createVertexBuffer(u.entranceBloom.layoutVertexArray,Zk.members),u.entranceBloom.layoutAttenuationBuffer=i.createVertexBuffer(u.entranceBloom.layoutAttenuationArray,D8.members)),this.uploadUpdatedColorBuffer(i),this.uploadUpdatedIndexBuffer(i)};this.uploaded||(a(this.buildingWithoutFacade),a(this.buildingWithFacade),this.groundEffect.upload(i)),this.groundEffect.uploadPaintProperties(i),this.programConfigurations.upload(i),this.uploaded=!0}destroy(){const i=a=>{a.layoutVertexBuffer&&(a.layoutVertexBuffer.destroy(),a.layoutNormalBuffer.destroy(),a.layoutColorBuffer.destroy(),a.segmentsBucket.destroy(),a.indexBuffer&&a.indexBuffer.destroy(),a.entranceBloom.layoutVertexBuffer&&(a.entranceBloom.layoutVertexBuffer.destroy(),a.entranceBloom.layoutColorBuffer.destroy(),a.entranceBloom.layoutAttenuationBuffer.destroy(),a.entranceBloom.indexBuffer.destroy(),a.entranceBloom.segmentsBucket.destroy()))};i(this.buildingWithoutFacade),i(this.buildingWithFacade),this.groundEffect.destroy(),this.programConfigurations.destroy()}updateFootprintHiddenFlags(i,a,u=!0){let p=!1;const g=u?a:0,y=0|(u?-1:~a);this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const v of i){const T=this.footprints[v],N=T.hiddenFlags&y|g;T.hiddenFlags!==N&&(T.hiddenFlags=N,p=!0,this.groundEffect.updateHiddenByLandmarkRange(T.groundEffectVertexOffset,T.groundEffectVertexLength,T.hiddenFlags!==0))}return p&&(this.indexArrayForConflationUploaded=!1),p}uploadUpdatedIndexBuffer(i){if(this.groundEffect.uploadHiddenByLandmark(i),this.indexArrayForConflationUploaded)return;const a=p=>{p.indexArray.length!==0&&(p.indexArrayForConflation.resize(p.indexArray.length),p.indexArrayForConflation.uint16.set(p.indexArray.uint16),p.entranceBloom.indexArrayForConflation.resize(p.entranceBloom.indexArray.length),p.entranceBloom.indexArrayForConflation.uint16.set(p.entranceBloom.indexArray.uint16))};a(this.buildingWithoutFacade),a(this.buildingWithFacade);for(const p of this.footprints){const g=p.hasFauxFacade?this.buildingWithFacade:this.buildingWithoutFacade,y=p.indicesOffset+p.indicesLength;if(p.hiddenFlags!==0){for(let T=p.indicesOffset;T<y;T++)g.indexArrayForConflation.uint16[3*T+0]=0,g.indexArrayForConflation.uint16[3*T+1]=0,g.indexArrayForConflation.uint16[3*T+2]=0;const v=p.bloomIndicesOffset+p.bloomIndicesLength;for(let T=p.bloomIndicesOffset;T<v;T++)g.entranceBloom.indexArrayForConflation.uint16[3*T+0]=0,g.entranceBloom.indexArrayForConflation.uint16[3*T+1]=0,g.entranceBloom.indexArrayForConflation.uint16[3*T+2]=0}}const u=p=>{p.indexArray.length!==0&&(p.indexBuffer?p.indexBuffer.updateData(p.indexArrayForConflation):p.indexBuffer=i.createIndexBuffer(p.indexArrayForConflation,!0),p.entranceBloom.indexBuffer?p.entranceBloom.indexBuffer.updateData(p.entranceBloom.indexArrayForConflation):p.entranceBloom.indexBuffer=i.createIndexBuffer(p.entranceBloom.indexArrayForConflation,!0))};u(this.buildingWithoutFacade),u(this.buildingWithFacade),this.indexArrayForConflationUploaded=!0}uploadUpdatedColorBuffer(i){const a=u=>{u.layoutColorBuffer?u.layoutColorBuffer.updateData(u.layoutColorArray):u.layoutColorBuffer=i.createVertexBuffer(u.layoutColorArray,Xk.members,!0),u.layoutFacadePaintArray&&(u.layoutFacadePaintBuffer?u.layoutFacadePaintBuffer.updateData(u.layoutFacadePaintArray):u.layoutFacadePaintBuffer=i.createVertexBuffer(u.layoutFacadePaintArray,j8.members,!0)),u.entranceBloom.layoutColorBuffer?u.entranceBloom.layoutColorBuffer.updateData(u.entranceBloom.layoutColorArray):u.entranceBloom.layoutColorBuffer=i.createVertexBuffer(u.entranceBloom.layoutColorArray,Xk.members,!0)};a(this.buildingWithoutFacade),a(this.buildingWithFacade),this.colorBufferUploaded=!0}evaluate(i,a){const u=i.paint.get("building-ambient-occlusion-intensity");for(const p of this.footprints){if(4&p.hiddenFlags)continue;const g=a[p.promoteId],y=p.feature;y.properties["building-part"]="roof";const v=i.paint.get("building-color").evaluate(y,g,this.canonical).toPremultipliedRenderColor(this.lut),T=i.paint.get("building-emissive-strength").evaluate(y,g,this.canonical);y.properties["building-part"]="wall";const N=i.paint.get("building-color").evaluate(y,g,this.canonical).toPremultipliedRenderColor(this.lut),I=i.paint.get("building-emissive-strength").evaluate(y,g,this.canonical);y.properties["building-part"]="window";const P=i.paint.get("building-color").evaluate(y,g,this.canonical).toPremultipliedRenderColor(this.lut),j=i.paint.get("building-emissive-strength").evaluate(y,g,this.canonical);y.properties["building-part"]="door";const O=i.paint.get("building-color").evaluate(y,g,this.canonical).toPremultipliedRenderColor(this.lut),L=i.paint.get("building-emissive-strength").evaluate(y,g,this.canonical),U=p.hasFauxFacade?this.buildingWithFacade:this.buildingWithoutFacade;for(const G of p.parts){let ee,le=v;G.part===1?(le=v,ee=T):G.part===0?(le=N,ee=I):G.part===2?(le=P,ee=j):G.part===3&&(le=O,ee=L),ee=Ie(ee,0,1);for(let me=0;me<G.vertexLength;me++){const we=G.vertexOffset+me,be=1+(U.layoutAOArray.uint8[we]/255-1)*u;U.layoutColorArray.emplace(we,le.r*be*255<<8|le.g*be*255,le.b*be*255<<8|255*ee),p.hasFauxFacade&&U.layoutFacadePaintArray.emplace(we,255*P.r<<8|255*P.g,255*P.b<<8|255*j)}}const Z=p.buildingBloom;if(Z)for(let G=0;G<Z.vertexLength;G++)U.entranceBloom.layoutColorArray.emplace(Z.vertexOffset+G,255*O.r<<8|255*O.g,255*O.b<<8|51*L)}}needsEvaluation(){return!this.colorBufferUploaded}updateReplacement(i,a,u){if(a.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=a.updateTime;const p=a.getReplacementRegionsForTile(i.toUnwrapped());if(R1(this.activeReplacements,p))return;this.activeReplacements=p;for(const y of this.footprints)y.hiddenFlags&=-2;const g=[];for(const y of this.activeReplacements){if(y.order<u)continue;const v=Math.max(1,Math.pow(2,y.footprintTileId.canonical.z-i.canonical.z));for(const T of this.footprints)T.min.x>y.max.x||T.max.x<y.min.x||T.min.y>y.max.y||T.max.y<y.min.y||(g.length=0,z8(this.footprintsVertices,T.footprintVertexOffset,T.footprintVertexLength,y.footprintTileId.canonical,i.canonical,g),BN(y.footprint,g,this.footprintsIndices.uint16,T.footprintIndexOffset,T.footprintIndexLength,0,-v)&&(T.hiddenFlags|=1))}this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const y of this.footprints)this.groundEffect.updateHiddenByLandmarkRange(y.groundEffectVertexOffset,y.groundEffectVertexLength,y.hiddenFlags!==0);this.indexArrayForConflationUploaded=!1}getFootprint(i){if(i.id!==void 0){const a=this.featureFootprintLookup.get(i.id);return this.footprints[a]}return null}getHeightAtTileCoord(i,a){let u=Number.NEGATIVE_INFINITY,p=!0;const g=4*(i+Bt)*Bt+(a+Bt);if(this.footprintLookup.hasOwnProperty(g)){const v=this.footprintLookup[g];return v?{height:v.height,hidden:v.hiddenFlags!==0}:void 0}const y=new wt(i,a);for(const v of this.footprints)i>v.max.x||v.min.x>i||a>v.max.y||v.min.y>a||v.height<=u||F8(y,this.footprintsVertices.float32.subarray(2*v.footprintVertexOffset,2*(v.footprintVertexOffset+v.footprintVertexLength)),this.footprintsIndices.uint16.subarray(v.footprintIndexOffset,v.footprintIndexOffset+v.footprintIndexLength))&&(u=v.height,this.footprintLookup[g]=v,p=v.hiddenFlags!==0);if(u!==Number.NEGATIVE_INFINITY)return{height:u,hidden:p};this.footprintLookup[g]=void 0}}function F8(l,i,a){for(let u=0;u<a.length;u+=3){const p=a[u],g=a[u+1],y=a[u+2],v=i[2*p+0],T=i[2*p+1],N=i[2*g+0],I=i[2*g+1],P=i[2*y+0],j=i[2*y+1],O=(v-P)*(l.y-j)-(T-j)*(l.x-P),L=(N-v)*(l.y-T)-(I-T)*(l.x-v);if(O<0!=L<0&&O!==0&&L!==0)continue;const U=(P-N)*(l.y-I)-(j-I)*(l.x-N);if(U===0||U<0==O+L<=0)return!0}return!1}function z8(l,i,a,u,p,g){const y=Math.pow(2,u.z-p.z);for(let v=0;v<a;v++){let T=l.float32[2*(v+i)+0],N=l.float32[2*(v+i)+1];T=(T+p.x*Bt)*y-u.x*Bt,N=(N+p.y*Bt)*y-u.y*Bt,g.push(new wt(T,N))}}let Qk,Jk;Yt(Kk,"BuildingBucket",{omit:["layers"]}),Yt(oA,"BuildingGeometry"),Yt(aA,"BuildingBloomGeometry");const B8=sr([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),V8=sr([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:U8}=B8,q8=sr([{name:"a_packed",components:3,type:"Float32"}]),{members:$8}=q8,G8=sr([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:H8}=G8;class eD{constructor(i,a){this.width=i,this.height=a,this.nextRow=0,this.image=new Ch({width:i,height:a}),this.positions={},this.uploaded=!1}getDash(i,a){const u=this.getKey(i,a);return this.positions[u]}trim(){const i=this.width,a=this.height=St(this.nextRow);this.image.resize({width:i,height:a})}getKey(i,a){return i.join(",")+a}getDashRanges(i,a,u){const p=[];let g=i.length%2==1?-i[i.length-1]*u:0,y=i[0]*u,v=!0;p.push({left:g,right:y,isDash:v,zeroLength:i[0]===0});let T=i[0];for(let N=1;N<i.length;N++){v=!v;const I=i[N];g=T*u,T+=I,y=T*u,p.push({left:g,right:y,isDash:v,zeroLength:I===0})}return p}addRoundDash(i,a,u){const p=a/2;for(let g=-u;g<=u;g++){const y=this.width*(this.nextRow+u+g);let v=0,T=i[v];for(let N=0;N<this.width;N++){N/T.right>1&&(T=i[++v]);const I=Math.abs(N-T.left),P=Math.abs(N-T.right),j=Math.min(I,P);let O;const L=g/u*(p+1);if(T.isDash){const U=p-Math.abs(L);O=Math.sqrt(j*j+U*U)}else O=p-Math.sqrt(j*j+L*L);this.image.data[y+N]=Math.max(0,Math.min(255,O+128))}}}addRegularDash(i,a){for(let T=i.length-1;T>=0;--T){const N=i[T],I=i[T+1];N.zeroLength?i.splice(T,1):I&&I.isDash===N.isDash&&(I.left=N.left,i.splice(T,1))}const u=i[0],p=i[i.length-1];u.isDash===p.isDash&&(u.left=p.left-this.width,p.right=u.right+this.width);const g=this.width*this.nextRow;let y=0,v=i[y];for(let T=0;T<this.width;T++){T/v.right>1&&(v=i[++y]);const N=Math.abs(T-v.left),I=Math.abs(T-v.right),P=Math.min(N,I);this.image.data[g+T]=Math.max(0,Math.min(255,(v.isDash?P:-P)+a+128))}}addDash(i,a){const u=this.getKey(i,a);if(this.positions[u])return this.positions[u];const p=a==="round",g=p?7:0,y=2*g+1;if(this.nextRow+y>this.height)return Ni("LineAtlas out of space"),null;i.length===0&&i.push(1);let v=0;for(let I=0;I<i.length;I++)i[I]<0&&(Ni("Negative value is found in line dasharray, replacing values with 0"),i[I]=0),v+=i[I];if(v!==0){const I=this.width/v,P=this.getDashRanges(i,this.width,I);p?this.addRoundDash(P,I,g):this.addRegularDash(P,a==="square"?.5*I:0)}const T=this.nextRow+g;this.nextRow+=y;const N={tl:[T,g],br:[v,0]};return this.positions[u]=N,N}}Yt(eD,"LineAtlas");const W8=lr.types,Z8=Math.cos(Math.PI/180*37.5),X8=Math.cos(Math.PI/180*5);class lA{constructor(i){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.elevationType="none",this.zoom=i.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=i.overscaling,this.pixelRatio=i.pixelRatio,this.layers=i.layers,this.layerIds=this.layers.map(a=>a.fqid),this.index=i.index,this.projection=i.projection,this.hasPattern=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(a=>{this.gradients[a.id]={}}),this.layoutVertexArray=new c_,this.layoutVertexArray2=new pl,this.patternVertexArray=new pl,this.indexArray=new ys,this.programConfigurations=new M(i.layers,{zoom:i.zoom,lut:i.lut}),this.segments=new dn,this.maxLineLength=0,this.zOffsetVertexArray=new pl,this.stateDependentLayerIds=this.layers.filter(a=>a.isStateDependent()).map(a=>a.id),this.tessellationStep=i.tessellationStep?i.tessellationStep:128,this.worldview=i.worldview,this.hasAppearances=null}updateFootprints(i,a){}updateAppearances(i,a,u,p){}populate(i,a,u,p){this.hasPattern=CN("line",this.layers,this.pixelRatio,a);const g=this.layers[0].layout.get("line-sort-key");this.tileToMeter=Rt(u);const y=this.layers[0].layout.get("line-elevation-reference");if(y==="hd-road-markup")this.elevationType="road";else{const j=this.layers[0].layout.get("line-z-offset"),O=j.isConstant()&&!j.constantOr(0);this.elevationType=y!=="sea"&&y!=="ground"&&O?"none":"offset",this.elevationType==="offset"&&y==="none"&&Ni(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`)}const v=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.elevationType==="offset"&&v!==void 0;const T=[];for(const{feature:j,id:O,index:L,sourceLayerIndex:U}of i){const Z=this.layers[0]._featureFilter.needGeometry,G=Hi(j,Z);if(!this.layers[0]._featureFilter.filter(new Vr(this.zoom,{worldview:this.worldview,activeFloors:a.activeFloors}),G,u))continue;const ee=g?g.evaluate(G,{},u):void 0,le={id:O,properties:j.properties,type:j.type,sourceLayerIndex:U,index:L,geometry:Z?G.geometry:Ci(j,u,p),patterns:{},sortKey:ee};T.push(le)}g&&T.sort((j,O)=>j.sortKey-O.sortKey);const{lineAtlas:N,featureIndex:I}=a,P=this.addConstantDashes(N);for(const j of T){const{geometry:O,index:L,sourceLayerIndex:U}=j;if(P&&this.addFeatureDashes(j,N),this.hasPattern){const Z=EN("line",this.layers,j,this.zoom,this.pixelRatio,a);this.patternFeatures.push(Z)}else this.addFeature(j,O,L,u,N.positions,a.availableImages,a.brightness,a.elevationFeatures);I.insert(i[L].feature,O,L,U,this.index)}}addConstantDashes(i){let a=!1;for(const u of this.layers){const p=u.paint.get("line-dasharray").value,g=u.layout.get("line-cap").value;if(p.kind!=="constant"||g.kind!=="constant")a=!0;else{const y=g.value,v=p.value;if(!v)continue;i.addDash(v,y)}}return a}addFeatureDashes(i,a){const u=this.zoom;for(const p of this.layers){const g=p.paint.get("line-dasharray").value,y=p.layout.get("line-cap").value;if(g.kind==="constant"&&y.kind==="constant")continue;let v,T;if(g.kind==="constant"){if(v=g.value,!v)continue}else v=g.evaluate({zoom:u},i);T=y.kind==="constant"?y.value:y.evaluate({zoom:u},i),a.addDash(v,T),i.patterns[p.id]=[a.getKey(v,T)]}}update(i,a,u,p,g,y,v,T){this.programConfigurations.updatePaintArrays(i,a,g,u,p,y,v,T)}addFeatures(i,a,u,p,g,y){for(const v of this.patternFeatures)this.addFeature(v,v.geometry,v.index,a,u,p,y,i.elevationFeatures)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(i){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=i.createVertexBuffer(this.layoutVertexArray2,$8)),this.patternVertexArray.length!==0&&(this.patternVertexBuffer=i.createVertexBuffer(this.patternVertexArray,H8)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=i.createVertexBuffer(this.zOffsetVertexArray,V8.members,!0)),this.layoutVertexBuffer=i.createVertexBuffer(this.layoutVertexArray,U8),this.indexBuffer=i.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(i),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(i,a){let u,p;if(a&&a>0?(u=`mapbox_clip_start_${a}`,p=`mapbox_clip_end_${a}`):(u="mapbox_clip_start",p="mapbox_clip_end"),i.properties&&i.properties.hasOwnProperty(u)&&i.properties.hasOwnProperty(p))return{start:+i.properties[u],end:+i.properties[p]}}addFeature(i,a,u,p,g,y,v,T){const N=this.layers[0].layout,I=N.get("line-join").evaluate(i,{}),P=N.get("line-cap").evaluate(i,{}),j=N.get("line-miter-limit"),O=N.get("line-round-limit");this.lineClips=this.lineFeatureClips(i),this.lineFeature=i;const L=!(!i.properties||!i.properties.hasOwnProperty("mapbox_line_metrics"))&&i.properties.mapbox_line_metrics;this.zOffsetValue=N.get("line-z-offset").value;const U=this.layers[0].paint.get("line-width").value;if(U.kind!=="constant"&&U.isLineProgressConstant===!1&&(this.variableWidthValue=U),this.elevationType==="road"){const Z=this.layoutVertexArray.length;if(!this.addElevatedRoadFeature(i,a,p,T,I,P,j,O)){const[G,ee]=this.clipRuntimeLinesToTile(a,1);for(let le=0;le<G.length;le++){const me=G[le],we=ee[le],be={progress:{min:we.progress.min,max:we.progress.max},nextDir:this.computeSegNextDir(we,me),prevDir:this.computeSegPrevDir(we,me)};this.addLine(me,i,p,I,P,j,O,be,L&&we.parentIndex>0?we.parentIndex:null)}this.fillNonElevatedRoadSegment(Z)}}else for(let Z=0;Z<a.length;Z++)this.addLine(a[Z],i,p,I,P,j,O,void 0,L&&Z>0?Z:null);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,i,u,g,y,p,v,void 0,this.worldview)}computeSegNextDir(i,a){return i.nextPoint.sub(a.at(-2)).unit()}computeSegPrevDir(i,a){return a[1].sub(i.prevPoint).unit()}clipLinesToTile(i,a){return M1(i,-a,-a,Bt+a,Bt+a)}clipRuntimeLinesToTile(i,a){const u=[];return[M1(i,-a,-a,Bt+a,Bt+a,u),u]}addElevatedRoadFeature(i,a,u,p,g,y,v,T){const N=[],I=no.getElevationFeature(i,p);if(I){const P=this.clipLinesToTile(a,1),j=this.prepareElevatedLines(P,I,u);for(const O of j)N.push({geometry:O,elevation:I,elevationTileID:u,segment:{progress:{min:0,max:1},nextDir:void 0,prevDir:void 0}})}if(N.length===0)return!1;for(const P of N){const j=this.layoutVertexArray.length;this.addLine(P.geometry,i,u,g,y,v,T);const O=new ml(u,P.elevationTileID);if(P.elevation)for(let L=j;L<this.layoutVertexArray.length;L++){const U=new wt(this.layoutVertexArray.int16[6*L]>>1,this.layoutVertexArray.int16[6*L+1]>>1),Z=O.pointElevation(U,P.elevation,.05);this.updateHeightRange(Z),this.zOffsetVertexArray.emplaceBack(Z,0,0)}else this.fillNonElevatedRoadSegment(j)}return!0}prepareElevatedLines(i,a,u){if(a.constantHeight!=null)return i;const p=[],g=1/Rt(u);for(const y of i)r8(y,new vo(a,g),0,p);return p}fillNonElevatedRoadSegment(i){for(let a=i;a<this.layoutVertexArray.length;a++)this.zOffsetVertexArray.emplaceBack(0,0,0)}updateHeightRange(i){this.heightRange?(this.heightRange.min=Math.min(this.heightRange.min,i),this.heightRange.max=Math.max(this.heightRange.max,i)):this.heightRange={min:i,max:i}}addLine(i,a,u,p,g,y,v,T,N){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0,this.lineClips=N?this.lineFeatureClips(a,N):this.lineClips;const I=p==="none";this.patternJoinNone=this.hasPattern&&I,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[];const P=T&&T.progress.min>0,j=T&&T.progress.max<1;if(this.lineClips){let je={min:this.lineClips.start,max:this.lineClips.end},Be=1;if(T){const lt=this.lineClips.end-this.lineClips.start;je=function(ct,xt,gt){return{min:Is(ct.min,xt,gt),max:Is(ct.max,xt,gt)}}(T.progress,{min:0,max:1},je),lt>0&&(Be=(je.max-je.min)/lt)}const Ge=+a.properties.mapbox_clip_feature_len,ut=+a.properties.mapbox_clip_seg_len;if(Number.isNaN(Ge)||Number.isNaN(ut)){for(let ct=0;ct<i.length-1;ct++)this.totalDistance+=i[ct].dist(i[ct+1]);const lt=this.totalDistance/(je.max-je.min);this.totalFeatureLength=Number.isFinite(lt)?lt:0,this.lineClips.start=je.min,this.lineClips.end=je.max,this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}else this.totalFeatureLength=Ge,this.distance=ut*Be,this.lineClips.start=je.min,this.lineClips.end=je.max,this.maxLineLength=Math.max(this.maxLineLength,this.distance);this.lineClipsArray.push(this.lineClips),this.updateScaledDistance()}const O=W8[a.type]==="Polygon";let L=i.length;for(;L>=2&&i[L-1].equals(i[L-2]);)L--;let U=0;for(;U<L-1&&i[U].equals(i[U+1]);)U++;if(L<(O?3:2))return;p==="bevel"&&(y=1.05);const Z=this.segments.prepareSegment(10*L,this.layoutVertexArray,this.indexArray);let G,ee,le,me,we,be,Re,Me;T&&T.prevDir&&(be=T.prevDir.perp()),T&&T.nextDir&&(Re=T.nextDir.perp()),this.e1=this.e2=-1,O&&(G=i[L-2],we=i[U].sub(G)._unit()._perp());for(let je=U;je<L;je++){if(le=je===L-1?O?i[U+1]:void 0:i[je+1],le&&i[je].equals(le))continue;we&&(me=we),G&&(ee=G),G=i[je],Me=this.evaluateLineProgressFeatures(ee?ee.dist(G):0),we=le?le.sub(G)._unit()._perp():me,me=me||we;const Be=ee&&le;let Ge=Be?p:O||I?"butt":g;const ut=me.x*we.x+me.y*we.y;if(I){const mt=function(Tt){if(Tt.patternJoinNone){const _t=Tt.segmentPoints.length/2,Zt=Tt.lineSoFar-Tt.segmentStart;for(let Xt=0;Xt<_t;++Xt){const Ft=Tt.segmentPoints[2*Xt+1],Vt=Math.round(Tt.segmentPoints[2*Xt])+.5+.25*Ft;Tt.patternVertexArray.emplaceBack(Vt,Zt,Tt.segmentStart),Tt.patternVertexArray.emplaceBack(Vt,Zt,Tt.segmentStart)}Tt.segmentPoints.length=0}Tt.e1=Tt.e2=-1};if(Be&&ut<X8){this.updateDistance(ee,G),this.addCurrentVertex(G,me,1,1,Z,Me),mt(this),this.addCurrentVertex(G,we,-1,-1,Z,Me);continue}if(ee){if(!le){this.updateDistance(ee,G),this.addCurrentVertex(G,me,1,1,Z,Me),mt(this);continue}Ge="miter"}}let lt=me.add(we);lt.x===0&&lt.y===0||lt._unit();const ct=lt.x*we.x+lt.y*we.y,xt=ct!==0?1/ct:1/0,gt=2*Math.sqrt(2-2*ct),yt=ct<Z8&&ee&&le,st=me.x*we.y-me.y*we.x>0,bt=this.overscaling<=16?122880/(512*this.overscaling):0;if(Be&&Ge==="round"){if(xt<v)Ge="miter";else if(xt<=2){const mt=cA(G,-10,8202);Ge=this.elevationType==="offset"&&(mt||this.hasCrossSlope)?"miter":"fakeround"}}if(Ge==="miter"&&xt>y&&(Ge="bevel"),Ge==="bevel"&&(xt>2&&(Ge="flipbevel"),xt<y&&(Ge="miter")),ee&&!(Ge==="miter"&&yt)&&this.updateDistance(ee,G),Ge==="miter")if(yt){const mt=G.dist(ee);if(mt>2*bt){const _t=G.sub(G.sub(ee)._mult(bt/mt)._round());this.updateDistance(ee,_t),this.addCurrentVertex(_t,me,0,0,Z,Me),ee=_t}this.updateDistance(ee,G),lt._mult(xt),this.addCurrentVertex(G,lt,0,0,Z,Me);const Tt=G.dist(le);if(Tt>2*bt){const _t=G.add(le.sub(G)._mult(bt/Tt)._round());this.updateDistance(G,_t),this.addCurrentVertex(_t,we,0,0,Z,Me),G=_t}}else lt._mult(xt),this.addCurrentVertex(G,lt,0,0,Z,Me);else if(Ge==="flipbevel"){if(xt>100)lt=we.mult(-1);else{const mt=xt*me.add(we).mag()/me.sub(we).mag();lt._perp()._mult(mt*(st?-1:1))}this.addCurrentVertex(G,lt,0,0,Z,Me),this.addCurrentVertex(G,lt.mult(-1),0,0,Z,Me)}else if(Ge==="bevel"||Ge==="fakeround"){Me!=null&&ee&&this.addCurrentVertex(G,Re||me,-1,-1,Z,Me);const mt=G.dist(ee)<=2*bt&&Ge!=="bevel",Tt=lt.mult(st?1:-1);Tt._mult(xt);const _t=we.mult(st?-1:1),Zt=me.mult(st?-1:1),Xt=this.evaluateLineProgressFeatures(this.distance);if(Me==null&&(this.addHalfVertex(G,Tt.x,Tt.y,!1,!st,0,Z,Xt),mt||this.addHalfVertex(G,Tt.x+2*Zt.x,Tt.y+2*Zt.y,!1,st,0,Z,Xt)),Ge==="fakeround"){const Ft=Math.round(180*gt/Math.PI/20);this.addHalfVertex(G,Zt.x,Zt.y,!1,st,0,Z,Xt);for(let Vt=0;Vt<Ft;Vt++){let xi=Vt/Ft;if(xi!==.5){const Gt=xi-.5;xi+=xi*Gt*(xi-1)*((1.0904+ut*(ut*(3.55645-1.43519*ut)-3.2452))*Gt*Gt+(.848013+ut*(.215638*ut-1.06021)))}const ri=_t.sub(Zt)._mult(xi)._add(Zt)._unit();this.addHalfVertex(G,ri.x,ri.y,!1,st,0,Z,Xt)}this.addHalfVertex(G,_t.x,_t.y,!1,st,0,Z,Xt)}mt||Me!=null||this.addHalfVertex(G,Tt.x+2*_t.x,Tt.y+2*_t.y,!1,st,0,Z,Xt),Me!=null&&le&&this.addCurrentVertex(G,be||we,1,1,Z,Me)}else if(Ge==="butt")this.addCurrentVertex(G,lt,0,0,Z,Me);else if(Ge==="square"){if(!ee){const mt=P?0:-1;this.addCurrentVertex(G,lt,mt,mt,Z,Me)}if(this.addCurrentVertex(G,lt,0,0,Z,Me),ee){const mt=j?0:1;this.addCurrentVertex(G,lt,mt,mt,Z,Me)}}else if(Ge==="round"){if(ee){const mt=!Be&&Re?Re:me;this.addCurrentVertex(G,mt,0,0,Z,Me),!Be&&j||this.addCurrentVertex(G,mt,1,1,Z,Me,!0)}if(le){const mt=!Be&&be?be:we;!Be&&P||this.addCurrentVertex(G,mt,-1,-1,Z,Me,!0),this.addCurrentVertex(G,mt,0,0,Z,Me)}}}}addVerticesTo(i,a,u,p,g,y,v,T,N,I){const P=(a.w-i.w)/this.tessellationStep|0;let j=0;const O=this.scaledDistance;if(P>1){this.lineSoFar=i.w;const U=(a.x-i.x)/P,Z=(a.y-i.y)/P,G=(a.z-i.z)/P,ee=(a.w-i.w)/P;for(let le=1;le<P;++le){i.x+=U,i.y+=Z,i.z+=G,this.lineSoFar+=ee,j+=ee;const me=this.evaluateLineProgressFeatures(this.prevDistance+j);this.scaledDistance=(this.prevDistance+j)/this.totalDistance,this.addHalfVertex(i,u,p,I,!1,v,N,me),this.addHalfVertex(i,g,y,I,!0,-T,N,me)}}this.lineSoFar=a.w,this.scaledDistance=O;const L=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(a,u,p,I,!1,v,N,L),this.addHalfVertex(a,g,y,I,!0,-T,N,L)}evaluateLineProgressFeatures(i){if(!this.variableWidthValue&&this.elevationType!=="offset")return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+i)/this.totalFeatureLength):Ni(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let a=0;return this.variableWidthValue&&this.variableWidthValue.kind!=="constant"&&(a=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.elevationType!=="offset"?{zOffset:0,variableWidth:a}:this.zOffsetValue.kind==="constant"?{zOffset:this.zOffsetValue.value,variableWidth:a}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:a}}addCurrentVertex(i,a,u,p,g,y,v=!1){const T=a.x+a.y*u,N=a.y-a.x*u,I=a.y*p-a.x,P=-a.y-a.x*p;if(y!=null){const j=this.elevationType==="offset",O=-10,L=8202,U=y.zOffset,Z=new gk(i.x,i.y,U,this.lineSoFar),G=!!j&&cA(i,O,L),ee=this.lineSoFar,le=this.distance;if(this.currentVertex)if(G){const me=this.currentVertexIsOutside,we=this.currentVertex,be=new gk(i.x,i.y,U,this.lineSoFar);if(xk(we,be,O,L),!cA(be,O,L)){if(me){this.e1=this.e2=-1,this.distance-=we.dist(Z),this.lineSoFar=we.w;const Re=this.evaluateLineProgressFeatures(we.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(we,T,N,v,!1,u,g,Re),this.addHalfVertex(we,I,P,v,!0,-p,g,Re),this.prevDistance=this.distance}this.distance=this.prevDistance+we.dist(be),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(we,be,T,N,I,P,u,p,g,v),this.distance=le,this.scaledDistance=this.distance/this.totalDistance}}else{const me=this.currentVertex;if(this.currentVertexIsOutside){xk(me,Z,O,L),this.e1=this.e2=-1,this.distance-=me.dist(Z),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=me.w;const we=this.evaluateLineProgressFeatures(me.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(me,T,N,v,!1,u,g,we),this.addHalfVertex(me,I,P,v,!0,-p,g,we),this.prevDistance=this.distance,this.distance=le,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(me,Z,T,N,I,P,u,p,g,v)}else G||(this.addHalfVertex(i,T,N,v,!1,u,g,y),this.addHalfVertex(i,I,P,v,!0,-p,g,y));this.currentVertex=Z,this.currentVertexIsOutside=G,this.lineSoFar=ee}else this.addHalfVertex(i,T,N,v,!1,u,g,y),this.addHalfVertex(i,I,P,v,!0,-p,g,y)}addHalfVertex({x:i,y:a},u,p,g,y,v,T,N){if(this.patternJoinNone&&(this.segmentPoints.length===0&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),y||this.segmentPoints.push(this.lineSoFar-this.segmentStart,v)),this.layoutVertexArray.emplaceBack((i<<1)+(g?1:0),(a<<1)+(y?1:0),Math.round(63*u)+128,Math.round(63*p)+128,1+(v===0?0:v<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){const P=Si(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,P)}const I=T.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,I),T.primitiveLength++),y?this.e2=I:this.e1=I,N!=null&&this.zOffsetVertexArray.emplaceBack(N.zOffset,N.variableWidth,N.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(i,a){this.prevDistance=this.distance,this.distance+=i.dist(a),this.updateScaledDistance()}}function cA(l,i,a){return l.x<i||l.x>a||l.y<i||l.y>a}let tD,iD;function rD(l,i,a){return i*(Bt/(l.tileSize*Math.pow(2,a-l.tileID.overscaledZ)))}Yt(lA,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const nD=(l,i,a)=>(1-a)*l+a*i;function sD(l,i){return 1/rD(l,1,i.tileZoom)}function aD(l,i,a,u){return l.translatePosMatrix(u||i.tileID.projMatrix,i,a.paint.get("line-translate"),a.paint.get("line-translate-anchor"))}const oD=l=>{const i=[];lD(l)&&i.push("RENDER_LINE_DASH"),l.paint.get("line-gradient")&&i.push("RENDER_LINE_GRADIENT");const a=l.paint.get("line-trim-offset");a[0]===0&&a[1]===0||i.push("RENDER_LINE_TRIM_OFFSET"),l.paint.get("line-border-width").constantOr(1)!==0&&i.push("RENDER_LINE_BORDER");const u=l.layout.get("line-join").constantOr("miter")==="none",p=!!l.paint.get("line-pattern").constantOr(1);return u&&p&&i.push("LINE_JOIN_NONE"),i};function lD(l){const i=l.paint.get("line-dasharray").value;return i.kind!=="constant"||i.value}let uA;const cD=()=>uA||(uA={layout:tD||(tD=new kn({"line-cap":new $t(et.layout_line["line-cap"]),"line-join":new $t(et.layout_line["line-join"]),"line-miter-limit":new Dt(et.layout_line["line-miter-limit"]),"line-round-limit":new Dt(et.layout_line["line-round-limit"]),"line-sort-key":new $t(et.layout_line["line-sort-key"]),"line-z-offset":new $t(et.layout_line["line-z-offset"]),"line-elevation-reference":new Dt(et.layout_line["line-elevation-reference"]),"line-cross-slope":new Dt(et.layout_line["line-cross-slope"]),visibility:new Dt(et.layout_line.visibility),"line-width-unit":new Dt(et.layout_line["line-width-unit"])})),paint:iD||(iD=new kn({"line-opacity":new $t(et.paint_line["line-opacity"]),"line-color":new $t(et.paint_line["line-color"]),"line-translate":new Dt(et.paint_line["line-translate"]),"line-translate-anchor":new Dt(et.paint_line["line-translate-anchor"]),"line-width":new $t(et.paint_line["line-width"]),"line-gap-width":new $t(et.paint_line["line-gap-width"]),"line-offset":new $t(et.paint_line["line-offset"]),"line-blur":new $t(et.paint_line["line-blur"]),"line-dasharray":new $t(et.paint_line["line-dasharray"]),"line-pattern":new $t(et.paint_line["line-pattern"]),"line-pattern-cross-fade":new Dt(et.paint_line["line-pattern-cross-fade"]),"line-gradient":new yh(et.paint_line["line-gradient"]),"line-trim-offset":new Dt(et.paint_line["line-trim-offset"]),"line-trim-fade-range":new Dt(et.paint_line["line-trim-fade-range"]),"line-trim-color":new Dt(et.paint_line["line-trim-color"]),"line-emissive-strength":new $t(et.paint_line["line-emissive-strength"]),"line-border-width":new $t(et.paint_line["line-border-width"]),"line-border-color":new $t(et.paint_line["line-border-color"]),"line-occlusion-opacity":new Dt(et.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"})}))},uA);class Y8 extends $t{possiblyEvaluate(i,a){return a=new Vr(Math.floor(a.zoom),{now:a.now,fadeDuration:a.fadeDuration,transition:a.transition,worldview:a.worldview}),super.possiblyEvaluate(i,a)}evaluate(i,a,u,p){return a=Object.assign({},a,{zoom:Math.floor(a.zoom)}),super.evaluate(i,a,u,p)}}let z_;function uD(l,i){return i>0?i+2*l:l}const K8=sr([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),Q8=sr([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),J8=sr([{name:"a_projected_pos",components:4,type:"Float32"}],4);sr([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const e9=sr([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),t9=sr([{name:"a_x_axis",components:3,type:"Float32"},{name:"a_y_axis",components:3,type:"Float32"}]),i9=sr([{name:"a_texb",components:2,type:"Uint16"}]),r9=sr([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),n9=sr([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);sr([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const dD=sr([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),s9=sr([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);sr([{name:"triangle",components:3,type:"Uint16"}]),sr([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),sr([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),sr([{type:"Float32",name:"offsetX"}]),sr([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var Bs=24;function a9(l,i,a){return l.sections.forEach(u=>{u.text=function(p,g,y){const v=g.layout.get("text-transform").evaluate(y,{});return v==="uppercase"?p=p.toLocaleUpperCase():v==="lowercase"&&(p=p.toLocaleLowerCase()),El.applyArabicShaping&&(p=El.applyArabicShaping(p)),p}(u.text,i,a)}),l}const B_={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};function o9(l){return l===""||l===""||l===""||l===""||l===""||l===""||l===""||l===""||l===""||l===""||l===""||l===""||l===""||l===""||l===""||l===""||l===""}function l9(l){return l===""||l===""||l===""||l===""||l===""||l===""||l===""||l===""||l===""||l===""}const dA=4294967296,hD=1/dA,pD=typeof TextDecoder>"u"?null:new TextDecoder("utf-8");let H1=class{constructor(l=new Uint8Array(16)){this.buf=ArrayBuffer.isView(l)?l:new Uint8Array(l),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(l,i,a=this.length){for(;this.pos<a;){const u=this.readVarint(),p=u>>3,g=this.pos;this.type=7&u,l(p,i,this),this.pos===g&&this.skip(u)}return i}readMessage(l,i){return this.readFields(l,i,this.readVarint()+this.pos)}readFixed32(){const l=this.dataView.getUint32(this.pos,!0);return this.pos+=4,l}readSFixed32(){const l=this.dataView.getInt32(this.pos,!0);return this.pos+=4,l}readFixed64(){const l=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*dA;return this.pos+=8,l}readSFixed64(){const l=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*dA;return this.pos+=8,l}readFloat(){const l=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,l}readDouble(){const l=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,l}readVarint(l){const i=this.buf;let a,u;return u=i[this.pos++],a=127&u,u<128?a:(u=i[this.pos++],a|=(127&u)<<7,u<128?a:(u=i[this.pos++],a|=(127&u)<<14,u<128?a:(u=i[this.pos++],a|=(127&u)<<21,u<128?a:(u=i[this.pos],a|=(15&u)<<28,function(p,g,y){const v=y.buf;let T,N;if(N=v[y.pos++],T=(112&N)>>4,N<128||(N=v[y.pos++],T|=(127&N)<<3,N<128)||(N=v[y.pos++],T|=(127&N)<<10,N<128)||(N=v[y.pos++],T|=(127&N)<<17,N<128)||(N=v[y.pos++],T|=(127&N)<<24,N<128)||(N=v[y.pos++],T|=(1&N)<<31,N<128))return Cg(p,T,g);throw new Error("Expected varint not more than 10 bytes")}(a,l,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){const l=this.readVarint();return l%2==1?(l+1)/-2:l/2}readBoolean(){return!!this.readVarint()}readString(){const l=this.readVarint()+this.pos,i=this.pos;return this.pos=l,l-i>=12&&pD?pD.decode(this.buf.subarray(i,l)):function(a,u,p){let g="",y=u;for(;y<p;){const v=a[y];let T,N,I,P=null,j=v>239?4:v>223?3:v>191?2:1;if(y+j>p)break;j===1?v<128&&(P=v):j===2?(T=a[y+1],(192&T)==128&&(P=(31&v)<<6|63&T,P<=127&&(P=null))):j===3?(T=a[y+1],N=a[y+2],(192&T)==128&&(192&N)==128&&(P=(15&v)<<12|(63&T)<<6|63&N,(P<=2047||P>=55296&&P<=57343)&&(P=null))):j===4&&(T=a[y+1],N=a[y+2],I=a[y+3],(192&T)==128&&(192&N)==128&&(192&I)==128&&(P=(15&v)<<18|(63&T)<<12|(63&N)<<6|63&I,(P<=65535||P>=1114112)&&(P=null))),P===null?(P=65533,j=1):P>65535&&(P-=65536,g+=String.fromCharCode(P>>>10&1023|55296),P=56320|1023&P),g+=String.fromCharCode(P),y+=j}return g}(this.buf,i,l)}readBytes(){const l=this.readVarint()+this.pos,i=this.buf.subarray(this.pos,l);return this.pos=l,i}readPackedVarint(l=[],i){const a=this.readPackedEnd();for(;this.pos<a;)l.push(this.readVarint(i));return l}readPackedSVarint(l=[]){const i=this.readPackedEnd();for(;this.pos<i;)l.push(this.readSVarint());return l}readPackedBoolean(l=[]){const i=this.readPackedEnd();for(;this.pos<i;)l.push(this.readBoolean());return l}readPackedFloat(l=[]){const i=this.readPackedEnd();for(;this.pos<i;)l.push(this.readFloat());return l}readPackedDouble(l=[]){const i=this.readPackedEnd();for(;this.pos<i;)l.push(this.readDouble());return l}readPackedFixed32(l=[]){const i=this.readPackedEnd();for(;this.pos<i;)l.push(this.readFixed32());return l}readPackedSFixed32(l=[]){const i=this.readPackedEnd();for(;this.pos<i;)l.push(this.readSFixed32());return l}readPackedFixed64(l=[]){const i=this.readPackedEnd();for(;this.pos<i;)l.push(this.readFixed64());return l}readPackedSFixed64(l=[]){const i=this.readPackedEnd();for(;this.pos<i;)l.push(this.readSFixed64());return l}readPackedEnd(){return this.type===2?this.readVarint()+this.pos:this.pos+1}skip(l){const i=7&l;if(i===0)for(;this.buf[this.pos++]>127;);else if(i===2)this.pos=this.readVarint()+this.pos;else if(i===5)this.pos+=4;else{if(i!==1)throw new Error(`Unimplemented type: ${i}`);this.pos+=8}}writeTag(l,i){this.writeVarint(l<<3|i)}realloc(l){let i=this.length||16;for(;i<this.pos+l;)i*=2;if(i!==this.length){const a=new Uint8Array(i);a.set(this.buf),this.buf=a,this.dataView=new DataView(a.buffer),this.length=i}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(l){this.realloc(4),this.dataView.setInt32(this.pos,l,!0),this.pos+=4}writeSFixed32(l){this.realloc(4),this.dataView.setInt32(this.pos,l,!0),this.pos+=4}writeFixed64(l){this.realloc(8),this.dataView.setInt32(this.pos,-1&l,!0),this.dataView.setInt32(this.pos+4,Math.floor(l*hD),!0),this.pos+=8}writeSFixed64(l){this.realloc(8),this.dataView.setInt32(this.pos,-1&l,!0),this.dataView.setInt32(this.pos+4,Math.floor(l*hD),!0),this.pos+=8}writeVarint(l){(l=+l||0)>268435455||l<0?function(i,a){let u,p;if(i>=0?(u=i%4294967296|0,p=i/4294967296|0):(u=~(-i%4294967296),p=~(-i/4294967296),4294967295^u?u=u+1|0:(u=0,p=p+1|0)),i>=18446744073709552e3||i<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");a.realloc(10),function(g,y,v){v.buf[v.pos++]=127&g|128,g>>>=7,v.buf[v.pos++]=127&g|128,g>>>=7,v.buf[v.pos++]=127&g|128,g>>>=7,v.buf[v.pos++]=127&g|128,v.buf[v.pos]=127&(g>>>=7)}(u,0,a),function(g,y){const v=(7&g)<<4;y.buf[y.pos++]|=v|((g>>>=3)?128:0),g&&(y.buf[y.pos++]=127&g|((g>>>=7)?128:0),g&&(y.buf[y.pos++]=127&g|((g>>>=7)?128:0),g&&(y.buf[y.pos++]=127&g|((g>>>=7)?128:0),g&&(y.buf[y.pos++]=127&g|((g>>>=7)?128:0),g&&(y.buf[y.pos++]=127&g)))))}(p,a)}(l,this):(this.realloc(4),this.buf[this.pos++]=127&l|(l>127?128:0),l<=127||(this.buf[this.pos++]=127&(l>>>=7)|(l>127?128:0),l<=127||(this.buf[this.pos++]=127&(l>>>=7)|(l>127?128:0),l<=127||(this.buf[this.pos++]=l>>>7&127))))}writeSVarint(l){this.writeVarint(l<0?2*-l-1:2*l)}writeBoolean(l){this.writeVarint(+l)}writeString(l){l=String(l),this.realloc(4*l.length),this.pos++;const i=this.pos;this.pos=function(u,p,g){for(let y,v,T=0;T<p.length;T++){if(y=p.charCodeAt(T),y>55295&&y<57344){if(!v){y>56319||T+1===p.length?(u[g++]=239,u[g++]=191,u[g++]=189):v=y;continue}if(y<56320){u[g++]=239,u[g++]=191,u[g++]=189,v=y;continue}y=v-55296<<10|y-56320|65536,v=null}else v&&(u[g++]=239,u[g++]=191,u[g++]=189,v=null);y<128?u[g++]=y:(y<2048?u[g++]=y>>6|192:(y<65536?u[g++]=y>>12|224:(u[g++]=y>>18|240,u[g++]=y>>12&63|128),u[g++]=y>>6&63|128),u[g++]=63&y|128)}return g}(this.buf,l,this.pos);const a=this.pos-i;a>=128&&mD(i,a,this),this.pos=i-1,this.writeVarint(a),this.pos+=a}writeFloat(l){this.realloc(4),this.dataView.setFloat32(this.pos,l,!0),this.pos+=4}writeDouble(l){this.realloc(8),this.dataView.setFloat64(this.pos,l,!0),this.pos+=8}writeBytes(l){const i=l.length;this.writeVarint(i),this.realloc(i);for(let a=0;a<i;a++)this.buf[this.pos++]=l[a]}writeRawMessage(l,i){this.pos++;const a=this.pos;l(i,this);const u=this.pos-a;u>=128&&mD(a,u,this),this.pos=a-1,this.writeVarint(u),this.pos+=u}writeMessage(l,i,a){this.writeTag(l,2),this.writeRawMessage(i,a)}writePackedVarint(l,i){i.length&&this.writeMessage(l,c9,i)}writePackedSVarint(l,i){i.length&&this.writeMessage(l,u9,i)}writePackedBoolean(l,i){i.length&&this.writeMessage(l,p9,i)}writePackedFloat(l,i){i.length&&this.writeMessage(l,d9,i)}writePackedDouble(l,i){i.length&&this.writeMessage(l,h9,i)}writePackedFixed32(l,i){i.length&&this.writeMessage(l,m9,i)}writePackedSFixed32(l,i){i.length&&this.writeMessage(l,f9,i)}writePackedFixed64(l,i){i.length&&this.writeMessage(l,g9,i)}writePackedSFixed64(l,i){i.length&&this.writeMessage(l,y9,i)}writeBytesField(l,i){this.writeTag(l,2),this.writeBytes(i)}writeFixed32Field(l,i){this.writeTag(l,5),this.writeFixed32(i)}writeSFixed32Field(l,i){this.writeTag(l,5),this.writeSFixed32(i)}writeFixed64Field(l,i){this.writeTag(l,1),this.writeFixed64(i)}writeSFixed64Field(l,i){this.writeTag(l,1),this.writeSFixed64(i)}writeVarintField(l,i){this.writeTag(l,0),this.writeVarint(i)}writeSVarintField(l,i){this.writeTag(l,0),this.writeSVarint(i)}writeStringField(l,i){this.writeTag(l,2),this.writeString(i)}writeFloatField(l,i){this.writeTag(l,5),this.writeFloat(i)}writeDoubleField(l,i){this.writeTag(l,1),this.writeDouble(i)}writeBooleanField(l,i){this.writeVarintField(l,+i)}};function Cg(l,i,a){return a?4294967296*i+(l>>>0):4294967296*(i>>>0)+(l>>>0)}function mD(l,i,a){const u=i<=16383?1:i<=2097151?2:i<=268435455?3:Math.floor(Math.log(i)/(7*Math.LN2));a.realloc(u);for(let p=a.pos-1;p>=l;p--)a.buf[p+u]=a.buf[p]}function c9(l,i){for(let a=0;a<l.length;a++)i.writeVarint(l[a])}function u9(l,i){for(let a=0;a<l.length;a++)i.writeSVarint(l[a])}function d9(l,i){for(let a=0;a<l.length;a++)i.writeFloat(l[a])}function h9(l,i){for(let a=0;a<l.length;a++)i.writeDouble(l[a])}function p9(l,i){for(let a=0;a<l.length;a++)i.writeBoolean(l[a])}function m9(l,i){for(let a=0;a<l.length;a++)i.writeFixed32(l[a])}function f9(l,i){for(let a=0;a<l.length;a++)i.writeSFixed32(l[a])}function g9(l,i){for(let a=0;a<l.length;a++)i.writeFixed64(l[a])}function y9(l,i){for(let a=0;a<l.length;a++)i.writeSFixed64(l[a])}function x9(l,i,a){i.glyphs=[],l===1&&a.readMessage(_9,i)}function _9(l,i,a){if(l===3){const{id:u,bitmap:p,width:g,height:y,left:v,top:T,advance:N}=a.readMessage(v9,{});i.glyphs.push({id:u,bitmap:new Ch({width:g+6,height:y+6},p),metrics:{width:g,height:y,left:v,top:T,advance:N}})}else l===4?i.ascender=a.readSVarint():l===5&&(i.descender=a.readSVarint())}function v9(l,i,a){l===1?i.id=a.readVarint():l===2?i.bitmap=a.readBytes():l===3?i.width=a.readVarint():l===4?i.height=a.readVarint():l===5?i.left=a.readSVarint():l===6?i.top=a.readSVarint():l===7&&(i.advance=a.readVarint())}const Xo={horizontal:1,vertical:2,horizontalOnly:3};class V_{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(i,a){const u=new V_;return u.scale=i||1,u.fontStack=a,u}static forImage(i){const a=new V_;return a.image=i,a}}class Eg{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(i,a,u){const p=new Eg;for(let g=0;g<i.sections.length;g++){const y=i.sections[g];y.image?p.addImageSection(y,u):p.addTextSection(y,a)}return p}length(){return this.text.length}getSection(i){return this.sections[this.sectionIndex[i]]}getSections(){return this.sections}getSectionIndex(i){return this.sectionIndex[i]}getCodePoint(i){return this.text.codePointAt(i)}verticalizePunctuation(i){this.text=function(a,u){let p="";for(let g=0;g<a.length;g++){const y=a.charCodeAt(g+1)||null,v=a.charCodeAt(g-1)||null;p+=!u&&(y&&Zx(y)&&!B_[a[g+1]]||v&&Zx(v)&&!B_[a[g-1]])||!B_[a[g]]?a[g]:B_[a[g]]}return p}(this.text,i)}trim(){let i=0;for(let u=0;u<this.text.length&&W1[this.text.charCodeAt(u)];u++)i++;let a=this.text.length;for(let u=this.text.length-1;u>=0&&u>=i&&W1[this.text.charCodeAt(u)];u--)a--;this.text=this.text.substring(i,a),this.sectionIndex=this.sectionIndex.slice(i,a)}substring(i,a){const u=new Eg;return u.text=this.text.substring(i,a),u.sectionIndex=this.sectionIndex.slice(i,a),u.sections=this.sections,u}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((i,a)=>Math.max(i,this.sections[a].scale),0)}addTextSection(i,a){this.text+=i.text,this.sections.push(V_.forText(i.scale,i.fontStack||a));const u=this.sections.length-1;for(let p=0;p<i.text.length;++p)this.sectionIndex.push(u)}addImageSection(i,a){const u=i.image?i.image.getPrimary():null;if(!u)return void Ni("Can't add FormattedSection with an empty image.");u.scaleSelf(a);const p=this.getNextImageSectionCharCode();p?(this.text+=String.fromCodePoint(p),this.sections.push(V_.forImage(u)),this.sectionIndex.push(this.sections.length-1)):Ni("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function hA(l,i,a,u,p,g,y,v,T,N,I,P,j,O,L,U=1){const Z=Eg.fromFeature(l,p,U);P===Xo.vertical&&Z.verticalizePunctuation(j);let G=[];const ee=function(Re,Me,je,Be,Ge,ut){if(!Re)return[];const lt=[],ct=function(yt,st,bt,mt,Tt,_t){let Zt=0;for(let Xt=0;Xt<yt.length();Xt++){const Ft=yt.getSection(Xt);Zt+=fD(yt.getCodePoint(Xt),Ft,mt,Tt,st,_t)}return Zt/Math.max(1,Math.ceil(Zt/bt))}(Re,Me,je,Be,Ge,ut),xt=Re.text.indexOf("")>=0;let gt=0;for(let yt=0;yt<Re.length();yt++){const st=Re.getSection(yt),bt=Re.getCodePoint(yt);if(W1[bt]||(gt+=fD(bt,st,Be,Ge,Me,ut)),yt<Re.length()-1){const mt=Ub(bt);(b9[bt]||mt||st.image)&&lt.push(yD(yt+1,gt,ct,lt,w9(bt,Re.getCodePoint(yt+1),mt&&xt),!1))}}return xD(yD(Re.length(),gt,ct,lt,0,!0))}(Z,N,g,i,u,O),{processBidirectionalText:le,processStyledBidirectionalText:me}=El;if(le&&Z.sections.length===1){const Re=le(Z.toString(),ee);for(const Me of Re){const je=new Eg;je.text=Me,je.sections=Z.sections;for(let Be=0;Be<Me.length;Be++)je.sectionIndex.push(0);G.push(je)}}else if(me){const Re=me(Z.text,Z.sectionIndex,ee);for(const Me of Re){const je=new Eg;je.text=Me[0],je.sectionIndex=Me[1],je.sections=Z.sections,G.push(je)}}else G=function(Re,Me){const je=[],Be=Re.text;let Ge=0;for(const ut of Me)je.push(Re.substring(Ge,ut)),Ge=ut;return Ge<Be.length&&je.push(Re.substring(Ge,Be.length)),je}(Z,ee);const we=[],be={positionedLines:we,text:Z.toString(),top:I[1],bottom:I[1],left:I[0],right:I[0],writingMode:P,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if(function(Re,Me,je,Be,Ge,ut,lt,ct,xt,gt,yt,st){let bt=0,mt=0,Tt=0;const _t=ct==="right"?1:ct==="left"?0:.5;let Zt=!1;for(const ri of Ge){const Gt=ri.getSections();for(const Ri of Gt){if(Ri.image)continue;const tr=Me[Ri.fontStack];if(tr&&(Zt=tr.ascender!==void 0&&tr.descender!==void 0,!Zt))break}if(!Zt)break}let Xt=0;for(const ri of Ge){ri.trim();const Gt=ri.getMaxScale(),Ri=(Gt-1)*Bs,tr={positionedGlyphs:[],lineOffset:0};Re.positionedLines[Xt]=tr;const Cr=tr.positionedGlyphs;let Qi=0;if(!ri.length()){mt+=ut,++Xt;continue}let Ur=0,fr=0;for(let _r=0;_r<ri.length();_r++){const Mr=ri.getSection(_r),ln=ri.getSectionIndex(_r),vn=ri.getCodePoint(_r);let bn=Mr.scale,Vn=null,Js=null,Sa=null,os=Bs,_s=0,Rs=xt;Rs===Xo.vertical&&qb(vn)&&(Rs=Xo.horizontal);const Xi=!(Rs===Xo.horizontal||!yt&&!xu(vn)||yt&&(W1[vn]||ag(vn)));if(Mr.image){const wn=Be.get(Mr.image.toString());if(!wn)continue;Sa=Mr.image,Re.iconsInText=Re.iconsInText||!0,Js=wn.paddedRect;const Mn=wn.displaySize;bn=bn*Bs/st,Vn={width:Mn[0],height:Mn[1],left:0,top:-3,advance:Xi?Mn[1]:Mn[0],localGlyph:!1},_s=Zt?-Vn.height*bn:Gt*Bs-17-Mn[1]*bn,os=Vn.advance;const Yo=(Xi?Mn[0]:Mn[1])*bn-Bs*Gt;Yo>0&&Yo>Qi&&(Qi=Yo)}else{const wn=je[Mr.fontStack];if(!wn)continue;wn[vn]&&(Js=wn[vn]);const Mn=Me[Mr.fontStack];if(!Mn)continue;const Yo=Mn.glyphs[vn];if(!Yo)continue;if(Vn=Yo.metrics,os=vn!==8203?Bs:0,Zt){const $a=Mn.ascender!==void 0?Math.abs(Mn.ascender):0,ea=Mn.descender!==void 0?Math.abs(Mn.descender):0,Ga=($a+ea)*bn;Ur<Ga&&(Ur=Ga,fr=($a-ea)/2*bn),_s=-$a*bn}else _s=(Gt-bn)*Bs-17}Xi?(Re.verticalizable=!0,Cr.push({glyph:vn,image:Sa,x:bt,y:mt+_s,vertical:Xi,scale:bn,localGlyph:Vn.localGlyph,fontStack:Mr.fontStack,sectionIndex:ln,metrics:Vn,rect:Js}),bt+=os*bn+gt):(Cr.push({glyph:vn,image:Sa,x:bt,y:mt+_s,vertical:Xi,scale:bn,localGlyph:Vn.localGlyph,fontStack:Mr.fontStack,sectionIndex:ln,metrics:Vn,rect:Js}),bt+=Vn.advance*bn+gt)}Cr.length!==0&&(Tt=Math.max(bt-gt,Tt),Zt?_D(Cr,_t,Qi,fr,ut*Gt/2):_D(Cr,_t,Qi,0,ut/2)),bt=0;const Bn=ut*Gt+Qi;tr.lineOffset=Math.max(Qi,Ri),mt+=Bn,++Xt}const Ft=mt,{horizontalAlign:Vt,verticalAlign:xi}=pA(lt);(function(ri,Gt,Ri,tr,Cr,Qi){const Ur=(Gt-Ri)*Cr,fr=-Qi*tr;for(const Bn of ri)for(const _r of Bn.positionedGlyphs)_r.x+=Ur,_r.y+=fr})(Re.positionedLines,_t,Vt,xi,Tt,Ft),Re.top+=-xi*Ft,Re.bottom=Re.top+Ft,Re.left+=-Vt*Tt,Re.right=Re.left+Tt,Re.hasBaseline=Zt}(be,i,a,u,G,y,v,T,P,N,j,L),!function(Re){for(const Me of Re)if(Me.positionedGlyphs.length!==0)return!1;return!0}(we))return be}const W1={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},b9={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function fD(l,i,a,u,p,g){if(i.image){const y=u.get(i.image.toString());return y?y.displaySize[0]*i.scale*Bs/g+p:0}{const y=a[i.fontStack],v=y&&y.glyphs[l];return v?v.metrics.advance*i.scale+p:0}}function gD(l,i,a,u){const p=Math.pow(l-i,2);return u?l<i?p/2:2*p:p+Math.abs(a)*a}function w9(l,i,a){let u=0;return l===10&&(u-=1e4),a&&(u+=150),l!==40&&l!==65288||(u+=50),i!==41&&i!==65289||(u+=50),u}function yD(l,i,a,u,p,g){let y=null,v=gD(i,a,p,g);for(const T of u){const N=gD(i-T.x,a,p,g)+T.badness;N<=v&&(y=T,v=N)}return{index:l,x:i,priorBreak:y,badness:v}}function xD(l){return l?xD(l.priorBreak).concat(l.index):[]}function pA(l){let i=.5,a=.5;switch(l){case"right":case"top-right":case"bottom-right":i=1;break;case"left":case"top-left":case"bottom-left":i=0}switch(l){case"bottom":case"bottom-right":case"bottom-left":a=1;break;case"top":case"top-right":case"top-left":a=0}return{horizontalAlign:i,verticalAlign:a}}function _D(l,i,a,u,p){if(!(i||a||u||p))return;const g=l.length-1,y=l[g],v=(y.x+y.metrics.advance*y.scale)*i;for(let T=0;T<=g;T++)l[T].x-=v,l[T].y+=a+u+p}function mA(l){return l.imagePrimary!==void 0&&l.top!==void 0&&l.bottom!==void 0&&l.left!==void 0&&l.right!==void 0}function Z1(l,i,a,u){const{horizontalAlign:p,verticalAlign:g}=pA(u),y=a[0]-l.displaySize[0]*p,v=a[1]-l.displaySize[1]*g;return{imagePrimary:l,imageSecondary:i,top:v,bottom:v+l.displaySize[1],left:y,right:y+l.displaySize[0]}}function fA(l,i,a,u,p,g){const y=l.imagePrimary;let v;if(y.content){const Z=y.content,G=y.pixelRatio||1;v=[Z[0]/G,Z[1]/G,y.displaySize[0]-Z[2]/G,y.displaySize[1]-Z[3]/G]}const T=i.left*g,N=i.right*g;let I,P,j,O;a==="width"||a==="both"?(O=p[0]+T-u[3],P=p[0]+N+u[1]):(O=p[0]+(T+N-y.displaySize[0])/2,P=O+y.displaySize[0]);const L=i.top*g,U=i.bottom*g;return a==="height"||a==="both"?(I=p[1]+L-u[0],j=p[1]+U+u[2]):(I=p[1]+(L+U-y.displaySize[1])/2,j=I+y.displaySize[1]),{imagePrimary:y,imageSecondary:void 0,top:I,right:P,bottom:j,left:O,collisionPadding:v}}function vD(l){return!l.imagePrimary.stretchX}function bD(l){return!l.imagePrimary.stretchY}function wD(l){return{width:l.right-l.left,height:l.bottom-l.top}}const wd=128;function Em(l,i,a,u){const{expression:p}=i;if(p.kind==="constant")return{kind:"constant",layoutSize:p.evaluate(new Vr(l+1,{worldview:a}),void 0,void 0,void 0,u)};if(p.kind==="source")return{kind:"source"};{const{zoomStops:g,interpolationType:y}=p;let v=0;for(;v<g.length&&g[v]<=l;)v++;v=Math.max(0,v-1);let T=v;for(;T<g.length&&g[T]<l+1;)T++;T=Math.min(g.length-1,T);const N=g[v],I=g[T];return p.kind==="composite"?{kind:"composite",minZoom:N,maxZoom:I,interpolationType:y}:{kind:"camera",minZoom:N,maxZoom:I,minSize:p.evaluate(new Vr(N,{worldview:a}),void 0,void 0,void 0,u),maxSize:p.evaluate(new Vr(I,{worldview:a}),void 0,void 0,void 0,u),interpolationType:y}}}function gA(l,{uSize:i,uSizeT:a},{lowerSize:u,upperSize:p}){return l.kind==="source"?u/wd:l.kind==="composite"?Si(u/wd,p/wd,a):i}function Ig(l,i,a=1){let u=0,p=0;if(l.kind==="constant")p=l.layoutSize*a;else if(l.kind!=="source"){const{interpolationType:g,minZoom:y,maxZoom:v}=l,T=g?Ie(Uo.interpolationFactor(g,i,y,v),0,1):0;l.kind==="camera"?p=Si(l.minSize,l.maxSize,T)*a:u=T*a}return{uSizeT:u,uSize:p}}class Sd extends wt{constructor(i,a,u,p,g){super(i,a),this.angle=p,this.z=u,g!==void 0&&(this.segment=g)}clone(){return new Sd(this.x,this.y,this.z,this.angle,this.segment)}}function SD(l,i,a,u,p){if(i.segment===void 0)return!0;let g=i,y=i.segment+1,v=0;for(;v>-a/2;){if(y--,y<0)return!1;v-=l[y].dist(g),g=l[y]}v+=l[y].dist(l[y+1]),y++;const T=[];let N=0;for(;v<a/2;){const I=l[y],P=l[y+1];if(!P)return!1;let j=l[y-1].angleTo(I)-I.angleTo(P);for(j=Math.abs((j+3*Math.PI)%(2*Math.PI)-Math.PI),T.push({distance:v,angleDelta:j}),N+=j;v-T[0].distance>u;)N-=T.shift().angleDelta;if(N>p)return!1;y++,v+=I.dist(P)}return!0}function TD(l){let i=0;for(let a=0;a<l.length-1;a++)i+=l[a].dist(l[a+1]);return i}function ND(l,i,a){return l?.6*i*a:0}function AD(l,i){return Math.max(l?l.right-l.left:0,i?i.right-i.left:0)}function S9(l,i,a,u,p,g){const y=ND(a,p,g),v=AD(a,u)*g;let T=0;const N=TD(l)/2;for(let I=0;I<l.length-1;I++){const P=l[I],j=l[I+1],O=P.dist(j);if(T+O>N){const L=(N-T)/O,U=Si(P.x,j.x,L),Z=Si(P.y,j.y,L),G=new Sd(U,Z,0,j.angleTo(P),I);return!y||SD(l,G,v,y,i)?G:void 0}T+=O}}function T9(l,i,a,u,p,g,y,v,T){const N=ND(u,g,y),I=AD(u,p),P=I*y,j=l[0].x===0||l[0].x===T||l[0].y===0||l[0].y===T;return i-P<i/4&&(i=P+i/4),CD(l,j?i/2*v%i:(I/2+2*g)*y*v%i,i,N,a,P,j,!1,T)}function CD(l,i,a,u,p,g,y,v,T){const N=g/2,I=TD(l);let P=0,j=i-a,O=[];for(let L=0;L<l.length-1;L++){const U=l[L],Z=l[L+1],G=U.dist(Z),ee=Z.angleTo(U);for(;j+a<P+G;){j+=a;const le=(j-P)/G,me=Si(U.x,Z.x,le),we=Si(U.y,Z.y,le);if(me>=0&&me<T&&we>=0&&we<T&&j-N>=0&&j+N<=I){const be=new Sd(me,we,0,ee,L);u&&!SD(l,be,g,u,p)||O.push(be)}}P+=G}return v||O.length||y||(O=CD(l,P/2,a,u,p,g,y,!0,T)),O}function ED(l){let i=0,a=0;for(const y of l)i+=y.w*y.h,a=Math.max(a,y.w);l.sort((y,v)=>v.h-y.h);const u=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(i/.95)),a),h:1/0}];let p=0,g=0;for(const y of l)for(let v=u.length-1;v>=0;v--){const T=u[v];if(!(y.w>T.w||y.h>T.h)){if(y.x=T.x,y.y=T.y,g=Math.max(g,y.y+y.h),p=Math.max(p,y.x+y.w),y.w===T.w&&y.h===T.h){const N=u.pop();N&&v<u.length&&(u[v]=N)}else y.h===T.h?(T.x+=y.w,T.w-=y.w):y.w===T.w?(T.y+=y.h,T.h-=y.h):(u.push({x:T.x+y.w,y:T.y,w:T.w-y.w,h:y.h}),T.y+=y.h,T.h-=y.h);break}}return{w:p,h:g,fill:i/(p*g)||0}}Yt(Sd,"Anchor");class U_{static getImagePositionScale(i,a,u){if(a&&i){const{sx:p,sy:g}=i;return{x:p,y:g}}return{x:u,y:u}}constructor(i,a,u,p){this.paddedRect=i;const{pixelRatio:g,version:y,stretchX:v,stretchY:T,content:N,sdf:I,usvg:P}=a;this.pixelRatio=g,this.stretchX=v,this.stretchY=T,this.content=N,this.version=y,this.padding=u,this.sdf=I,this.usvg=P,this.scale=U_.getImagePositionScale(p,P,g)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}function yA(l,i,a){const u=Er.parse(l),p=function(g,y,v=[1,1]){return{x:0,y:0,w:(g.data?g.data.width:g.width*v[0])+2*y,h:(g.data?g.data.height:g.height*v[1])+2*y}}(i,a,[u.sx,u.sy]);return{bin:p,imagePosition:new U_(p,i,a,u),imageVariant:u}}class ID{constructor(i,a,u){const p=new Map,g=new Map;this.haveRenderCallbacks=[];const y=[];this.addImages(i,p,1,y),this.addImages(a,g,2,y);const{w:v,h:T}=ED(y),N=new wa({width:v||1,height:T||1});for(const[I,P]of i.entries()){const j=p.get(I).paddedRect;wa.copy(P.data,N,{x:0,y:0},{x:j.x+1,y:j.y+1},P.data,null,P.sdf)}for(const[I,P]of a.entries()){const j=g.get(I),O=j.paddedRect;let L=j.padding;const U=O.x+L,Z=O.y+L,G=P.data.width,ee=P.data.height;L=L>1?L-1:L,wa.copy(P.data,N,{x:0,y:0},{x:U,y:Z},P.data,u),wa.copy(P.data,N,{x:0,y:ee-L},{x:U,y:Z-L},{width:G,height:L},u),wa.copy(P.data,N,{x:0,y:0},{x:U,y:Z+ee},{width:G,height:L},u),wa.copy(P.data,N,{x:G-L,y:0},{x:U-L,y:Z},{width:L,height:ee},u),wa.copy(P.data,N,{x:0,y:0},{x:U+G,y:Z},{width:L,height:ee},u),wa.copy(P.data,N,{x:G-L,y:ee-L},{x:U-L,y:Z-L},{width:L,height:L},u),wa.copy(P.data,N,{x:0,y:ee-L},{x:U+G,y:Z-L},{width:L,height:L},u),wa.copy(P.data,N,{x:0,y:0},{x:U+G,y:Z+ee},{width:L,height:L},u),wa.copy(P.data,N,{x:G-L,y:0},{x:U-L,y:Z+ee},{width:L,height:L},u)}this.lut=u,this.image=N,this.iconPositions=p,this.patternPositions=g}addImages(i,a,u,p){for(const[g,y]of i.entries()){const{bin:v,imagePosition:T,imageVariant:N}=yA(g,y,u);a.set(g,T),p.push(v),y.hasRenderCallback&&this.haveRenderCallbacks.push(N.id)}}patchUpdatedImages(i,a,u){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(p=>i.hasImage(p,u)),i.dispatchRenderCallbacks(this.haveRenderCallbacks,u);for(const p of i.getUpdatedImages(u)){for(const g of this.iconPositions.keys()){const y=Er.parse(g);if(Ys.isEqual(y.id,p)){const v=i.getImage(p,u);this.patchUpdatedImage(this.iconPositions.get(g),v,a,null)}}for(const g of this.patternPositions.keys()){const y=Er.parse(g);if(Ys.isEqual(y.id,p)){const v=i.getImage(p,u);this.patchUpdatedImage(this.patternPositions.get(g),v,a,this.lut)}}}}patchUpdatedImage(i,a,u,p=null){if(!i||!a||i.version===a.version)return;i.version=a.version;const[g,y]=i.tl,v=i.sdf;if(this.lut||v){const T={width:a.data.width,height:a.data.height},N=new wa(T);wa.copy(a.data,N,{x:0,y:0},{x:0,y:0},T,p,v),u.update(N,{position:{x:g,y}})}else u.update(a.data,{position:{x:g,y}})}}Yt(U_,"ImagePosition"),Yt(ID,"ImageAtlas");const q_=1e20;function PD(l,i,a,u,p,g,y,v,T){for(let N=i;N<i+u;N++)jD(l,a*g+N,g,p,y,v,T);for(let N=a;N<a+p;N++)jD(l,N*g+i,1,u,y,v,T)}function jD(l,i,a,u,p,g,y){g[0]=0,y[0]=-q_,y[1]=q_,p[0]=l[i];for(let v=1,T=0,N=0;v<u;v++){p[v]=l[i+v*a];const I=v*v;do{const P=g[T];N=(p[v]-p[P]+I-P*P)/(v-P)/2}while(N<=y[T]&&--T>-1);T++,g[T]=v,y[T]=N,y[T+1]=q_}for(let v=0,T=0;v<u;v++){for(;y[T+1]<v;)T++;const N=g[T],I=v-N;l[i+v*a]=p[N]+I*I}}const xA={none:0,ideographs:1,all:2};class Pg{constructor(i,a,u){this.requestManager=i,this.localGlyphMode=a,this.localFontFamily=u,this.url="",this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(i){this.url=i}getGlyphs(i,a){const u=[],p=this.url||ns.GLYPHS_URL;for(const g in i)for(const y of i[g])u.push({stack:g,id:y});He(u,({stack:g,id:y},v)=>{let T=this.entries[g];T||(T=this.entries[g]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let N=T.glyphs[y];if(N!==void 0)return void v(null,{stack:g,id:y,glyph:N});if(N=this._tinySDF(T,g,y),N)return T.glyphs[y]=N,void v(null,{stack:g,id:y,glyph:N});const I=Math.floor(y/256);if(256*I>65535)return Ni("glyphs > 65535 not supported"),void v(null,{stack:g,id:y,glyph:N});if(T.ranges[I])return void v(null,{stack:g,id:y,glyph:N});let P=T.requests[I];P||(P=T.requests[I]=[],Pg.loadGlyphRange(g,I,p,this.requestManager,(j,O)=>{if(O){T.ascender=O.ascender,T.descender=O.descender;for(const L in O.glyphs)this._doesCharSupportLocalGlyph(+L)||(T.glyphs[+L]=O.glyphs[+L]);T.ranges[I]=!0}for(const L of P)L(j,O);delete T.requests[I]})),P.push((j,O)=>{j?v(j):O&&v(null,{stack:g,id:y,glyph:O.glyphs[y]||null})})},(g,y)=>{if(g)a(g);else if(y){const v={};for(const{stack:T,id:N,glyph:I}of y)v[T]===void 0&&(v[T]={}),v[T].glyphs===void 0&&(v[T].glyphs={}),v[T].glyphs[N]=I&&{id:I.id,bitmap:I.bitmap.clone(),metrics:I.metrics},v[T].ascender=this.entries[T].ascender,v[T].descender=this.entries[T].descender;a(null,v)}})}_doesCharSupportLocalGlyph(i){return this.localGlyphMode!==xA.none&&(this.localGlyphMode===xA.all?!!this.localFontFamily:!!this.localFontFamily&&(ng(i)||Fb(i)||mh(i)||am(i)||ph(i)||fh(i)||(a=i)>=131072&&a<=173791||(u=>u>=66736&&u<=66815)(i)));var a}_tinySDF(i,a,u){const p=this.localFontFamily;if(!p||!this._doesCharSupportLocalGlyph(u))return;let g=i.tinySDF;if(!g){let U="400";/bold/i.test(a)?U="900":/medium/i.test(a)?U="500":/light/i.test(a)&&(U="200"),g=i.tinySDF=new Pg.TinySDF({fontFamily:p,fontWeight:U,fontSize:48,buffer:6,radius:16}),g.fontWeight=U}if(this.localGlyphs[g.fontWeight][u])return this.localGlyphs[g.fontWeight][u];const y=String.fromCodePoint(u),{data:v,width:T,height:N,glyphWidth:I,glyphHeight:P,glyphLeft:j,glyphTop:O,glyphAdvance:L}=g.draw(y);return this.localGlyphs[g.fontWeight][u]={id:u,bitmap:new Ch({width:T,height:N},v),metrics:{width:I/2,height:P/2,left:j/2,top:O/2-27,advance:L/2,localGlyph:!0}}}}function RD(l,i){return l+i[1]-i[0]}function _A(l,i,a,u,p=1){const g=[],y=l.imagePrimary,v=y.pixelRatio,T=y.paddedRect.w-2,N=y.paddedRect.h-2,I=(l.right-l.left)*p,P=(l.bottom-l.top)*p,j=y.stretchX||[[0,T]],O=y.stretchY||[[0,N]],L=j.reduce(RD,0),U=O.reduce(RD,0),Z=T-L,G=N-U;let ee=0,le=L,me=0,we=U,be=0,Re=Z,Me=0,je=G;if(y.content&&u){const Ge=y.content;ee=X1(j,0,Ge[0]),me=X1(O,0,Ge[1]),le=X1(j,Ge[0],Ge[2]),we=X1(O,Ge[1],Ge[3]),be=Ge[0]-ee,Me=Ge[1]-me,Re=Ge[2]-Ge[0]-le,je=Ge[3]-Ge[1]-we}const Be=(Ge,ut,lt,ct)=>{const xt=Y1(Ge.stretch-ee,le,I,l.left*p),gt=K1(Ge.fixed-be,Re,Ge.stretch,L),yt=Y1(ut.stretch-me,we,P,l.top*p),st=K1(ut.fixed-Me,je,ut.stretch,U),bt=Y1(lt.stretch-ee,le,I,l.left*p),mt=K1(lt.fixed-be,Re,lt.stretch,L),Tt=Y1(ct.stretch-me,we,P,l.top*p),_t=K1(ct.fixed-Me,je,ct.stretch,U),Zt=new wt(xt,yt),Xt=new wt(bt,yt),Ft=new wt(bt,Tt),Vt=new wt(xt,Tt),xi=new wt(gt/v,st/v),ri=new wt(mt/v,_t/v),Gt=i*Math.PI/180;if(Gt){const fr=Math.sin(Gt),Bn=Math.cos(Gt),_r=[Bn,-fr,fr,Bn];Zt._matMult(_r),Xt._matMult(_r),Vt._matMult(_r),Ft._matMult(_r)}const Ri=Ge.stretch+Ge.fixed,tr=lt.stretch+lt.fixed,Cr=ut.stretch+ut.fixed,Qi=ct.stretch+ct.fixed,Ur=l.imageSecondary;return{tl:Zt,tr:Xt,bl:Vt,br:Ft,texPrimary:{x:y.paddedRect.x+1+Ri,y:y.paddedRect.y+1+Cr,w:tr-Ri,h:Qi-Cr},texSecondary:Ur?{x:Ur.paddedRect.x+1+Ri,y:Ur.paddedRect.y+1+Cr,w:tr-Ri,h:Qi-Cr}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:xi,pixelOffsetBR:ri,minFontScaleX:Re/v/I,minFontScaleY:je/v/P,isSDF:a}};if(y.stretchX||y.stretchY){const Ge=kD(j,Z,L),ut=kD(O,G,U);for(let lt=0;lt<Ge.length-1;lt++){const ct=Ge[lt],xt=Ge[lt+1];for(let gt=0;gt<ut.length-1;gt++)g.push(Be(ct,ut[gt],xt,ut[gt+1]))}}else g.push(Be({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:T+1},{fixed:0,stretch:N+1}));return g}function N9(l,i){const a=l.stretchY||[[0,l.paddedRect.h-2]];return l.stretchX||l.stretchY?DD(l.stretchX||[[0,l.paddedRect.w-2]])*DD(a):1}function X1(l,i,a){let u=0;for(const p of l)u+=Math.max(i,Math.min(a,p[1]))-Math.max(i,Math.min(a,p[0]));return u}function kD(l,i,a){const u=[{fixed:-1,stretch:0}];for(const[p,g]of l){const y=u[u.length-1];u.push({fixed:p-y.stretch,stretch:y.stretch}),u.push({fixed:p-y.stretch,stretch:y.stretch+(g-p)})}return u.push({fixed:i+1,stretch:a}),u}function DD(l){return 2*l.length+1}function Y1(l,i,a,u){return l/i*a+u}function K1(l,i,a,u){return l-i*a/u}function A9(l,i,a,u){const p=i+l.positionedLines[u].lineOffset;return u===0?a+p/2:a+(p+(i+l.positionedLines[u-1].lineOffset))/2}function MD(l,i,a,u,p,g,y,v,T){const N=[];if(i.positionedLines.length===0)return N;const I=(T!==void 0?T:u.layout.get("text-rotate").evaluate(g,{}))*Math.PI/180,P=function(Z){const G=Z[0],ee=Z[1],le=G*ee;return le>0?[G,-ee]:le<0?[-G,ee]:G===0?[ee,G]:[ee,-G]}(a);let j=Math.abs(i.top-i.bottom);for(const Z of i.positionedLines)j-=Z.lineOffset;const O=i.positionedLines.length,L=j/O;let U=i.top-a[1];for(let Z=0;Z<O;++Z){const G=i.positionedLines[Z];U=A9(i,L,U,Z);for(const ee of G.positionedGlyphs){if(!ee.rect)continue;const le=ee.rect||{};let me=4,we=!0,be=1,Re=0;if(ee.image){const Xt=y.get(ee.image.toString());if(!Xt)continue;if(Xt.sdf){Ni("SDF images are not supported in formatted text and will be ignored.");continue}we=!1,be=Xt.pixelRatio,me=1/be}const Me=(p||v)&&ee.vertical,je=ee.metrics.advance*ee.scale/2,Be=ee.metrics,Ge=ee.rect;if(Ge===null)continue;v&&i.verticalizable&&(Re=ee.image?je-ee.metrics.width*ee.scale/2:0);const ut=p?[ee.x+je,ee.y]:[0,0];let lt=[0,0],ct=[0,0],xt=!1;p||(Me?(ct=[ee.x+je+P[0],ee.y+P[1]-Re],xt=!0):lt=[ee.x+je+a[0],ee.y+a[1]-Re]);const gt=Ge.w*ee.scale/(be*(ee.localGlyph?2:1)),yt=Ge.h*ee.scale/(be*(ee.localGlyph?2:1));let st,bt,mt,Tt;if(Me){const Xt=ee.y-U,Ft=new wt(-je,je-Xt),Vt=-Math.PI/2,xi=new wt(...ct);st=new wt(-je+lt[0],lt[1]),st._rotateAround(Vt,Ft)._add(xi),st.x+=-Xt+je,st.y-=(Be.left-me)*ee.scale;const ri=ee.image?Be.advance*ee.scale:Bs*ee.scale,Gt=String.fromCodePoint(ee.glyph);o9(Gt)?st.x+=(1-me)*ee.scale:l9(Gt)?st.x+=ri-Be.height*ee.scale+(-me-1)*ee.scale:st.x+=ee.image||Be.width+2*me===Ge.w&&Be.height+2*me===Ge.h?(ri-yt)/2:(ri-(Be.height+2*me)*ee.scale)/2,bt=new wt(st.x,st.y-gt),mt=new wt(st.x+yt,st.y),Tt=new wt(st.x+yt,st.y-gt)}else{const Xt=(Be.left-me)*ee.scale-je+lt[0],Ft=(-Be.top-me)*ee.scale+lt[1],Vt=Xt+gt,xi=Ft+yt;st=new wt(Xt,Ft),bt=new wt(Vt,Ft),mt=new wt(Xt,xi),Tt=new wt(Vt,xi)}if(I){let Xt;Xt=p?new wt(0,0):xt?new wt(P[0],P[1]):new wt(a[0],a[1]),st._rotateAround(I,Xt),bt._rotateAround(I,Xt),mt._rotateAround(I,Xt),Tt._rotateAround(I,Xt)}const _t=new wt(0,0),Zt=new wt(0,0);N.push({tl:st,tr:bt,bl:mt,br:Tt,texPrimary:le,texSecondary:void 0,writingMode:i.writingMode,glyphOffset:ut,sectionIndex:ee.sectionIndex,isSDF:we,pixelOffsetTL:_t,pixelOffsetBR:Zt,minFontScaleX:0,minFontScaleY:0})}}return N}function C9(l,i=1,a=!1){let u=1/0,p=1/0,g=-1/0,y=-1/0;const v=l[0];for(let O=0;O<v.length;O++){const L=v[O];(!O||L.x<u)&&(u=L.x),(!O||L.y<p)&&(p=L.y),(!O||L.x>g)&&(g=L.x),(!O||L.y>y)&&(y=L.y)}const T=Math.min(g-u,y-p);let N=T/2;const I=new Zp([],E9);if(T===0)return new wt(u,p);for(let O=u;O<g;O+=T)for(let L=p;L<y;L+=T)I.push(new jg(O+N,L+N,N,l));let P=function(O){let L=0,U=0,Z=0;const G=O[0];for(let ee=0,le=G.length,me=le-1;ee<le;me=ee++){const we=G[ee],be=G[me],Re=we.x*be.y-be.x*we.y;U+=(we.x+be.x)*Re,Z+=(we.y+be.y)*Re,L+=3*Re}return new jg(U/L,Z/L,0,O)}(l),j=I.length;for(;I.length;){const O=I.pop();(O.d>P.d||!P.d)&&(P=O,a&&console.log("found best %d after %d probes",Math.round(1e4*O.d)/1e4,j)),O.max-P.d<=i||(N=O.h/2,I.push(new jg(O.p.x-N,O.p.y-N,N,l)),I.push(new jg(O.p.x+N,O.p.y-N,N,l)),I.push(new jg(O.p.x-N,O.p.y+N,N,l)),I.push(new jg(O.p.x+N,O.p.y+N,N,l)),j+=4)}return a&&(console.log(`num probes: ${j}`),console.log(`best distance: ${P.d}`)),P.p}function E9(l,i){return i.max-l.max}Pg.loadGlyphRange=function(l,i,a,u,p){const g=256*i,y=g+255,v=u.transformRequest(u.normalizeGlyphsURL(a).replace("{fontstack}",l).replace("{range}",`${g}-${y}`),Ca.Glyphs);su(v,(T,N)=>{if(T)p(T);else if(N){const I={},P=function(j){return new H1(j).readFields(x9,{})}(N);for(const j of P.glyphs)I[j.id]=j;p(null,{glyphs:I,ascender:P.ascender,descender:P.descender})}})},Pg.TinySDF=class{constructor({fontSize:l=24,buffer:i=3,radius:a=8,cutoff:u=.25,fontFamily:p="sans-serif",fontWeight:g="normal",fontStyle:y="normal",lang:v=null}={}){this.buffer=i,this.cutoff=u,this.radius=a,this.lang=v;const T=this.size=l+4*i,N=this._createCanvas(T),I=this.ctx=N.getContext("2d",{willReadFrequently:!0});I.font=`${y} ${g} ${l}px ${p}`,I.textBaseline="alphabetic",I.textAlign="left",I.fillStyle="black",this.gridOuter=new Float64Array(T*T),this.gridInner=new Float64Array(T*T),this.f=new Float64Array(T),this.z=new Float64Array(T+1),this.v=new Uint16Array(T)}_createCanvas(l){const i=document.createElement("canvas");return i.width=i.height=l,i}draw(l){const{width:i,actualBoundingBoxAscent:a,actualBoundingBoxDescent:u,actualBoundingBoxLeft:p,actualBoundingBoxRight:g}=this.ctx.measureText(l),y=Math.ceil(a),v=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(g-p))),T=Math.min(this.size-this.buffer,y+Math.ceil(u)),N=v+2*this.buffer,I=T+2*this.buffer,P=Math.max(N*I,0),j=new Uint8ClampedArray(P),O={data:j,width:N,height:I,glyphWidth:v,glyphHeight:T,glyphTop:y,glyphLeft:0,glyphAdvance:i};if(v===0||T===0)return O;const{ctx:L,buffer:U,gridInner:Z,gridOuter:G}=this;this.lang&&(L.lang=this.lang),L.clearRect(U,U,v,T),L.fillText(l,U,U+y);const ee=L.getImageData(U,U,v,T);G.fill(q_,0,P),Z.fill(0,0,P);for(let le=0;le<T;le++)for(let me=0;me<v;me++){const we=ee.data[4*(le*v+me)+3]/255;if(we===0)continue;const be=(le+U)*N+me+U;if(we===1)G[be]=0,Z[be]=q_;else{const Re=.5-we;G[be]=Re>0?Re*Re:0,Z[be]=Re<0?Re*Re:0}}PD(G,0,0,N,I,N,this.f,this.v,this.z),PD(Z,U,U,v,T,N,this.f,this.v,this.z);for(let le=0;le<P;le++){const me=Math.sqrt(G[le])-Math.sqrt(Z[le]);j[le]=Math.round(255-255*(me/this.radius+this.cutoff))}return O}};class jg{constructor(i,a,u,p){this.p=new wt(i,a),this.h=u,this.d=function(g,y){let v=!1,T=1/0;for(let N=0;N<y.length;N++){const I=y[N];for(let P=0,j=I.length,O=j-1;P<j;O=P++){const L=I[P],U=I[O];L.y>g.y!=U.y>g.y&&g.x<(U.x-L.x)*(g.y-L.y)/(U.y-L.y)+L.x&&(v=!v),T=Math.min(T,Th(g,L,U))}}return(v?1:-1)*Math.sqrt(T)}(this.p,p),this.max=this.d+this.h*Math.SQRT2}}const I9=Object.keys,vA=Number.POSITIVE_INFINITY,P9=Math.sqrt(2);function jh(l,i,a,u,p){const g=mA(l)&&l.collisionPadding?l.collisionPadding:[0,0,0,0],y={top:l.top-g[1],bottom:l.bottom+g[3],left:l.left-g[0],right:l.right+g[2],scaled:!1};return u!==void 0&&function(v,T){v.top*=T,v.bottom*=T,v.left*=T,v.right*=T,v.scaled=!0}(y,u),a&&function(v,T){if(!T)return;const N=Zi(T),I=new wt(v.left,v.top),P=new wt(v.right,v.top),j=new wt(v.left,v.bottom),O=new wt(v.right,v.bottom),L=new wt(0,0);I._rotateAround(N,L),P._rotateAround(N,L),j._rotateAround(N,L),O._rotateAround(N,L),v.left=Math.min(I.x,P.x,j.x,O.x),v.right=Math.max(I.x,P.x,j.x,O.x),v.top=Math.min(I.y,P.y,j.y,O.y),v.bottom=Math.max(I.y,P.y,j.y,O.y)}(y,a),p&&(y.left+=p[0],y.right+=p[0],y.top+=p[1],y.bottom+=p[1]),i?{top:Math.min(i.top,y.top),bottom:Math.max(i.bottom,y.bottom),left:Math.min(i.left,y.left),right:Math.max(i.right,y.right),scaled:i.scaled||y.scaled}:y}function OD(l,[i,a]){let u=0,p=0;if(a===vA){i<0&&(i=0);const g=i/P9;switch(l){case"top-right":case"top-left":p=g-7;break;case"bottom-right":case"bottom-left":p=7-g;break;case"bottom":p=7-i;break;case"top":p=i-7}switch(l){case"top-right":case"bottom-right":u=-g;break;case"top-left":case"bottom-left":u=g;break;case"left":u=i;break;case"right":u=-i}}else{switch(i=Math.abs(i),a=Math.abs(a),l){case"top-right":case"top-left":case"top":p=a-7;break;case"bottom-right":case"bottom-left":case"bottom":p=7-a}switch(l){case"top-right":case"bottom-right":case"right":u=-i;break;case"top-left":case"bottom-left":case"left":u=i}}return[u,p]}function j9(l,i,a,u,p,g,y,v,T,N,I,P,j,O,L){const U=l.layers[0],Z=U.appearances;if(Z.length===0)return{iconBBox:null,iconVerticalBBox:null,textBBox:null,textVerticalBBox:null};const G={iconBBox:null,iconVerticalBBox:null},ee={textBBox:null,textVerticalBBox:null},{baseIconRotate:le,baseTextRotate:me,iconScaleFactor:we}=function(Re,Me,je){const Be=Re.get("icon-rotate").evaluate(Me,{},je),Ge=Re.get("text-rotate").evaluate(Me,{},je),[ut,lt]=Re.get("icon-size-scale-range");return{baseIconRotate:Be,baseTextRotate:Ge,iconScaleFactor:Ie(1,ut,lt)}}(u,p,g);i&&(G.iconBBox=jh(i,G.iconBBox,le,y),a)&&(G.iconVerticalBBox=jh(a,G.iconVerticalBBox,le+90,y));const be=J1(P.horizontal);be&&(ee.textBBox=jh(be,ee.textBBox,me,1,O)),P.vertical&&(ee.textVerticalBBox=jh(P.vertical,ee.textVerticalBBox,me+90,1,O));for(const Re of Z)Re.hasIconProperties()&&R9(G,l,U,Re,p,g,v,le,y,T,i,N,we,I,L),Re.hasTextProperties()&&k9(ee,U,Re,p,g,O,me,j,be,P.vertical);return{iconBBox:G.iconBBox,iconVerticalBBox:G.iconVerticalBBox,textBBox:ee.textBBox,textVerticalBBox:ee.textVerticalBBox}}function R9(l,i,a,u,p,g,y,v,T,N,I,P,j,O,L){const{appearanceIconOffset:U,appearanceIconRotate:Z,appearanceIconSize:G}=LD(u,a,p,g,y,v,T,N.iconScaleFactor);let ee=null,le=null,me=null;u.hasProperty("icon-image")?me=function(we,be,Re,Me,je,Be,Ge,ut){let lt=null;const ct=be.getAppearanceValueAndResolveTokens(Re,"icon-image",Me,je,ut);if(ct){const xt=we.getResolvedImageFromTokens(ct),gt=Re.getUnevaluatedProperty("icon-size"),yt=$_(xt,Em(we.zoom,gt,we.worldview,ut),gt,je,we.zoom,Me,we.pixelRatio,Ge,we.worldview,ut);lt=Be.get(yt.iconPrimary.toString())}return lt}(i,a,u,p,g,P,j,L):I&&(me=I.imagePrimary),me&&(ee=Z1(me,null,U,O),i.allowVerticalPlacement&&(le=Z1(me,null,U,O))),ee&&(l.iconBBox=jh(ee,l.iconBBox,Z,G)),le&&(l.iconVerticalBBox=jh(le,l.iconVerticalBBox,Z+90,G))}function LD(l,i,a,u,p,g,y,v){const T=l.hasProperty("icon-offset")?i.getAppearanceValueAndResolveTokens(l,"icon-offset",a,u,[]):null,N=T&&Array.isArray(T)?T:p,I=l.hasProperty("icon-rotate")?i.getAppearanceValueAndResolveTokens(l,"icon-rotate",a,u,[]):null,P=typeof I=="number"?I:g,j=l.hasProperty("icon-size")?i.getAppearanceValueAndResolveTokens(l,"icon-size",a,u,[]):null;return{appearanceIconOffset:N,appearanceIconRotate:P,appearanceIconSize:typeof j=="number"?j*v:y}}function k9(l,i,a,u,p,g,y,v,T,N){const{appearanceTextOffset:I,appearanceTextRotate:P,appearanceTextSize:j}=FD(a,i,u,p,g,y,v),O=j/v;T&&(l.textBBox=jh(T,l.textBBox,P,O,I)),N&&(l.textVerticalBBox=jh(N,l.textVerticalBBox,P+90,O,I))}function FD(l,i,a,u,p,g,y){const v=l.hasProperty("text-offset")?i.getAppearanceValueAndResolveTokens(l,"text-offset",a,u,[]):null,T=v&&Array.isArray(v)?[v[0]*Bs,v[1]*Bs]:p,N=l.hasProperty("text-rotate")?i.getAppearanceValueAndResolveTokens(l,"text-rotate",a,u,[]):null,I=typeof N=="number"?N:g,P=l.hasProperty("text-size")?i.getAppearanceValueAndResolveTokens(l,"text-size",a,u,[]):null;return{appearanceTextOffset:T,appearanceTextRotate:I,appearanceTextSize:typeof P=="number"?P:y}}function Q1(l,i,a,u,p,g,y,v,T){if(!i||!i.usvg)return;const N=wD(u),I=wD(p),P=g!=="both"&&g!=="width"||!vD(u)?1:I.width/N.width,j=g!=="both"&&g!=="height"||!bD(u)?1:I.height/N.height;a.scaleSelf(P,j);const O=a.toString();y.set(O,a),v.set(O,i);const{imagePosition:L}=yA(O,i,1);T.set(O,L)}function zD(l,i,a,u,p,g,y,v,T,N){if(!l)return;const I=function(P,j,O,L,U,Z,G){if(P.kind==="camera")return P.maxSize;if(P.kind==="composite"){const ee=j.possiblyEvaluate(new Vr(P.maxZoom,{worldview:Z}),O,G).evaluate(U,{},O,G),le=j.possiblyEvaluate(new Vr(P.minZoom,{worldview:Z}),O,G).evaluate(U,{},O,G);return Math.max(ee,le)}return j.possiblyEvaluate(new Vr(L,{worldview:Z}),O,G).evaluate(U,{},O,G)}(i,a,u,p,g,T,N);return l.scaleSelf(I*v*y)}function $_(l,i,a,u,p,g,y,v,T,N){return{iconPrimary:zD(l.getPrimary(),i,a,u,p,g,y,v,T,N),iconSecondary:zD(l.getSecondary(),i,a,u,p,g,y,v,T,N)}}function D9(l,i,a){if(!i)return;const u=a.get(l.toString()),p=a.get(i.toString());u&&p&&(u.paddedRect.w===p.paddedRect.w&&u.paddedRect.h===p.paddedRect.h||Ni(`Mismatch in icon variant sizes: ${l.toString()} and ${i.toString()}`),u.usvg!==p.usvg&&Ni(`Mismatch in icon variant image types: ${l.id} and ${i.id}`))}function BD(l,i,a,u){if(!l)return;const p=i.get(a.toString());if(l.imagePrimary=p,u){const g=i.get(u.toString());l.imageSecondary=g}}function M9(l,i){for(const a in l.horizontal)VD(l.horizontal[a],i);VD(l.vertical,i)}function VD(l,i){if(l){for(const a of l.positionedLines)for(const u of a.positionedGlyphs)if(u.image!==null){const p=u.image.toString();u.rect=i.get(p).paddedRect}}}function bA(l){switch(l){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function O9(l,i,a,u,p,g,y,v,T){const N=J1(g.horizontal)||g.vertical,I=a.get("icon-text-fit-padding").evaluate(u,{},p);let P,j=i;return i&&T!=="none"&&(l.allowVerticalPlacement&&g.vertical&&(P=fA(i,g.vertical,T,I,v,y)),N&&(j=fA(i,N,T,I,v,y))),{defaultShapedIcon:j,verticallyShapedIcon:P}}function UD(l,i){return l*i/24}function L9(l,i,a,u,p,g,y,v,T,N,I,P,j,O,L,U,Z,G,ee,le,me,we,be,Re){let Me=y.textMaxSize.evaluate(i,{},j);Me===void 0?Me=v*y.textScaleFactor:Me*=y.textScaleFactor;const je=l.layers[0].layout,Be=UD(v,y.textScaleFactor),Ge=J1(a.horizontal)||a.vertical,ut=l.hasAnyAppearanceProperty(["text-size","text-offset","text-rotate"]);if((Z!=="none"||ut)&&l.appearanceFeatureData&&l.featureToAppearanceIndex[i.index]<l.appearanceFeatureData.length){const Ft=l.appearanceFeatureData[l.featureToAppearanceIndex[i.index]];Ft&&(Ft.textShaping=Ge,Ft.iconTextFitPadding=je.get("icon-text-fit-padding").evaluate(i,{},j),Ft.fontScale=Be,Ft.textScaleFactor=y.textScaleFactor)}const lt=O.name==="globe",ct=l.tilePixelRatio*Me/24,xt=(Tt=l.overscaling,l.zoom>18&&Tt>2&&(Tt>>=1),Math.max(Bt/(512*Tt),1)*je.get("symbol-spacing")),gt=je.get("text-padding")*l.tilePixelRatio,yt=je.get("icon-padding")*l.tilePixelRatio,st=Zi(je.get("text-max-angle")),bt=je.get("icon-rotation-alignment")==="map"&&le!=="point",mt=xt/2;var Tt;l.hasAnyIconTextFit===!1&&Z!=="none"&&(l.hasAnyIconTextFit=!0);const _t=i.properties?+i.properties[ur]:null,Zt=_t&&l.elevationFeatureIdToIndex?l.elevationFeatureIdToIndex.get(_t):65535,Xt=(Ft,Vt,xi)=>{if(Vt.x<0||Vt.x>=Bt||Vt.y<0||Vt.y>=Bt)return;let ri=null;if(lt){const{x:Gt,y:Ri,z:tr}=O.projectTilePoint(Vt.x,Vt.y,xi);ri={anchor:new Sd(Gt,Ri,tr,0,void 0),up:O.upVector(xi,Vt.x,Vt.y)}}(function(Gt,Ri,tr,Cr,Qi,Ur,fr,Bn,_r,Mr,ln,vn,bn,Vn,Js,Sa,os,_s,Rs,Xi,wn,Mn,Yo,$a,ea,Ga,Eu,Ea,gw,Fg,so,yw){const Iu=Gt.addToLineVertexArray(Ri,Cr);let Td,Dh,jl,cc,a0,zg,Ji,Vs=0,Un=0,vs=0,Rl=0,To=-1,Ko=-1;const Us={};let o0=La("");const Pu=tr?tr.anchor:Ri,ls=Ea!=="none";let ta=0,bs=0;if(_r._unevaluatedLayout.getValue("text-radial-offset")===void 0){const ia=_r.layout.get("text-offset").evaluate(wn,{},ea);ta=ia[0]*Bs,bs=ia[1]*Bs}else ta=_r.layout.get("text-radial-offset").evaluate(wn,{},ea)*Bs,bs=vA;if(Gt.allowVerticalPlacement&&Qi.vertical){const ia=Qi.vertical;if(Js)zg=TA(ia),Bn&&(Ji=TA(Bn));else{const No=_r.layout.get("text-rotate").evaluate(wn,{},ea)+90;jl=ew(Mr,Pu,Ri,ln,vn,bn,ia,Vn,No,Sa,yw),Bn&&(cc=ew(Mr,Pu,Ri,ln,vn,bn,Bn,_s,No,null,so))}}if(Ur){const ia=_r.layout.get("icon-rotate").evaluate(wn,{},ea),No=_A(Ur,ia,Yo,ls,Mn.iconScaleFactor),uc=Bn?_A(Bn,ia,Yo,ls,Mn.iconScaleFactor):void 0;Dh=ew(Mr,Pu,Ri,ln,vn,bn,Ur,_s,ia,null,Fg);const ju=function(zc,X$,aO,Y$,oO,lO,K$,ple,WA){const cO=zc.layers[0],uO=cO.appearances;let Vg=X$.length;if(aO&&(Vg=Math.max(Vg,aO.length)),uO.length===0)return Vg;const[Q$,J$]=Y$.get("icon-size-scale-range"),e7=Ie(1,Q$,J$);for(const dO of uO){const hO=dO.getUnevaluatedProperties();if(hO._values["icon-image"].value!==void 0){const pO=cO.getAppearanceValueAndResolveTokens(dO,"icon-image",oO,lO,WA);if(pO){const mO=zc.getResolvedImageFromTokens(pO);if(mO){const fO=hO._values["icon-size"],t7=$_(mO,Em(zc.zoom,fO,zc.worldview,WA),fO,lO,zc.zoom,oO,zc.pixelRatio,e7,zc.worldview,WA),i7=K$.get(t7.iconPrimary.toString());Vg=Math.max(Vg,N9(i7))}}}}return Vg}(Gt,No,uc,_r.layout,wn,ea,Gt.iconAtlasPositions,0,$a);Vs=4*ju;const GA=_r.layout.get("icon-size").evaluate(wn,{},ea,$a),HA=Mn.compositeIconSizes?Mn.compositeIconSizes[0].evaluate(wn,{},ea,$a):0,l0=Mn.compositeIconSizes?Mn.compositeIconSizes[1].evaluate(wn,{},ea,$a):0,Bg=SA(Gt.layerIds[0],Gt.iconSizeData,GA,Mn.iconScaleFactor,HA,l0);Gt.addSymbols(Gt.icon,No,Bg,Xi,Rs,wn,void 0,tr,Ri,Iu.lineStartIndex,Iu.lineLength,-1,$a,ea,Ga,Eu,Gt.symbolInstances.length,ju),To=Gt.icon.placedSymbolArray.length-1,uc&&(Un=4*ju,Gt.addSymbols(Gt.icon,uc,Bg,Xi,Rs,wn,Xo.vertical,tr,Ri,Iu.lineStartIndex,Iu.lineLength,-1,$a,ea,Ga,Eu,Gt.symbolInstances.length,ju),Ko=Gt.icon.placedSymbolArray.length-1)}for(const ia in Qi.horizontal){const No=ia,uc=Qi.horizontal[No];Td||(o0=La(uc.text),Js?a0=TA(uc):Td=ew(Mr,Pu,Ri,ln,vn,bn,uc,Vn,_r.layout.get("text-rotate").evaluate(wn,{},ea),Sa,yw));const ju=uc.positionedLines.length===1;if(vs+=qD(Gt,tr,Ri,uc,fr,_r,Js,wn,Sa,Iu,Qi.vertical?Xo.horizontal:Xo.horizontalOnly,ju?I9(Qi.horizontal):[No],Us,To,Mn,$a,ea,Gt.symbolInstances.length,Ga),ju)break}Qi.vertical&&(Rl+=qD(Gt,tr,Ri,Qi.vertical,fr,_r,Js,wn,Sa,Iu,Xo.vertical,["vertical"],Us,Ko,Mn,$a,ea,Gt.symbolInstances.length,Ga));let Ia=-1;const Pa=(ia,No)=>ia?Math.max(ia,No):No;Ia=Pa(a0,Ia),Ia=Pa(zg,Ia),Ia=Pa(Ji,Ia);const Mh=Ia>-1?1:0;Gt.glyphOffsetArray.length>=65535&&Ni("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),wn.sortKey!==void 0&&Gt.addToSortKeyRanges(Gt.symbolInstances.length,wn.sortKey),Gt.symbolInstances.emplaceBack(Ri.x,Ri.y,Pu.x,Pu.y,Pu.z,Us.right>=0?Us.right:-1,Us.center>=0?Us.center:-1,Us.left>=0?Us.left:-1,Us.vertical>=0?Us.vertical:-1,To,Ko,o0,Td!==void 0?Td:Gt.collisionBoxArray.length,Td!==void 0?Td+1:Gt.collisionBoxArray.length,jl!==void 0?jl:Gt.collisionBoxArray.length,jl!==void 0?jl+1:Gt.collisionBoxArray.length,Dh!==void 0?Dh:Gt.collisionBoxArray.length,Dh!==void 0?Dh+1:Gt.collisionBoxArray.length,cc||Gt.collisionBoxArray.length,cc?cc+1:Gt.collisionBoxArray.length,ln,vs,Rl,Vs,Un,Mh,0,ta,bs,Ia,0,ls?1:0,gw)})(l,Vt,ri,Ft,a,u,g,p,l.layers[0],l.collisionBoxArray,i.index,i.sourceLayerIndex,l.index,gt,ee,N,0,yt,bt,G,i,y,I,P,j,L,U,Z,Zt,me,we,be)};if(le==="line")for(const Ft of M1(i.geometry,0,0,Bt,Bt)){const Vt=T9(Ft,xt,st,a.vertical||Ge,u,24,ct,l.overscaling,Bt);for(const xi of Vt)Ge&&F9(l,Ge.text,mt,xi)||Xt(Ft,xi,j)}else if(le==="line-center"){for(const Ft of i.geometry)if(Ft.length>1){const Vt=S9(Ft,st,a.vertical||Ge,u,24,ct);Vt&&Xt(Ft,Vt,j)}}else if(i.type==="Polygon")for(const Ft of N_(i.geometry,0)){const Vt=C9(Ft,16);Xt(Ft[0],new Sd(Vt.x,Vt.y,0,0,void 0),j)}else if(i.type==="LineString")for(const Ft of i.geometry)Xt(Ft,new Sd(Ft[0].x,Ft[0].y,0,0,void 0),j);else if(i.type==="Point")for(const Ft of i.geometry)for(const Vt of Ft)Xt([Vt],new Sd(Vt.x,Vt.y,0,0,void 0),j)}const wA=255,Im=wA*wd;function qD(l,i,a,u,p,g,y,v,T,N,I,P,j,O,L,U,Z,G,ee){const le=MD(0,u,T,g,y,v,p,l.allowVerticalPlacement,void 0),me=g.layout.get("text-size").evaluate(v,{},Z),we=L.compositeTextSizes?L.compositeTextSizes[0].evaluate(v,{},Z):0,be=L.compositeTextSizes?L.compositeTextSizes[1].evaluate(v,{},Z):0,Re=SA(l.layerIds[0],l.textSizeData,me,L.textScaleFactor,we,be);l.addSymbols(l.text,le,Re,T,y,v,I,i,a,N.lineStartIndex,N.lineLength,O,U,Z,ee,!1,G,le.length);for(const Me of P)j[Me]=l.text.placedSymbolArray.length-1;return 4*le.length}function SA(l,i,a,u,p,g){const y=i;let v=null;return y.kind==="source"?(v=[wd*a*u],v[0]>Im&&Ni(`${l}: Value for "text-size" is >= ${wA}. Reduce your "text-size".`)):y.kind==="composite"&&(v=[wd*p*u,wd*g*u],(v[0]>Im||v[1]>Im)&&Ni(`${l}: Value for "text-size" is >= ${wA}. Reduce your "text-size".`)),v}function J1(l){for(const i in l)return l[i];return null}function ew(l,i,a,u,p,g,y,v,T,N,I){let P,j,O,L;if(P=I?I.top:y.top,j=I?I.bottom:y.bottom,O=I?I.left:y.left,L=I?I.right:y.right,mA(y)&&y.collisionPadding){const U=y.collisionPadding;O-=U[0],P-=U[1],L+=U[2],j+=U[3]}if(T){const U=new wt(O,P),Z=new wt(L,P),G=new wt(O,j),ee=new wt(L,j),le=Zi(T);let me=new wt(0,0);N&&(me=new wt(N[0],N[1])),U._rotateAround(le,me),Z._rotateAround(le,me),G._rotateAround(le,me),ee._rotateAround(le,me),O=Math.min(U.x,Z.x,G.x,ee.x),L=Math.max(U.x,Z.x,G.x,ee.x),P=Math.min(U.y,Z.y,G.y,ee.y),j=Math.max(U.y,Z.y,G.y,ee.y)}return l.emplaceBack(i.x,i.y,i.z,a.x,a.y,O,P,L,j,v,u,p,g),l.length-1}function TA(l){mA(l)&&l.collisionPadding&&(l.top-=l.collisionPadding[1],l.bottom+=l.collisionPadding[3]);const i=l.bottom-l.top;return i>0?Math.max(10,i):null}function F9(l,i,a,u){const p=l.compareText;if(i in p){const g=p[i];for(let y=g.length-1;y>=0;y--)if(u.dist(g[y])<a)return!0}else p[i]=[];return p[i].push(u),!1}function $D(l,i){const a=l.fovAboveCenter,u=l.elevation?l.elevation.getMinElevationBelowMSL()*i:0,p=(l._camera.position[2]*l.worldSize-u)/Math.cos(l._pitch),g=Math.sin(a)*p/Math.sin(Math.max(Math.PI/2-l._pitch-a,.01));let y=Math.sin(l._pitch)*g+p;const v=p*(1/l._horizonShift);if(!l.elevation||l.elevation.exaggeration()===0){let T=Math.max(l.zoom-17,0);l.isOrthographic&&(T/=10),y*=1+T}return Math.min(1.01*y,v)}function G_(l,i){if(!i.isReprojectedInTileSpace)return{scale:1<<l.z,x:l.x,y:l.y,x2:l.x+1,y2:l.y+1,projection:i};const a=Math.pow(2,-l.z),u=l.x*a,p=(l.x+1)*a,g=l.y*a,y=(l.y+1)*a,v=ft(u),T=ft(p),N=Nt(g),I=Nt(y),P=i.project(v,N),j=i.project(T,N),O=i.project(T,I),L=i.project(v,I);let U=Math.min(P.x,j.x,O.x,L.x),Z=Math.min(P.y,j.y,O.y,L.y),G=Math.max(P.x,j.x,O.x,L.x),ee=Math.max(P.y,j.y,O.y,L.y);const le=a/16;function me(be,Re,Me,je,Be,Ge){const ut=(Me+Be)/2,lt=(je+Ge)/2,ct=i.project(ft(ut),Nt(lt)),xt=Math.max(0,U-ct.x,Z-ct.y,ct.x-G,ct.y-ee);U=Math.min(U,ct.x),G=Math.max(G,ct.x),Z=Math.min(Z,ct.y),ee=Math.max(ee,ct.y),xt>le&&(me(be,ct,Me,je,ut,lt),me(ct,Re,ut,lt,Be,Ge))}me(P,j,u,g,p,g),me(j,O,p,g,p,y),me(O,L,p,y,u,y),me(L,P,u,y,u,g),U-=le,Z-=le,G+=le,ee+=le;const we=1/Math.max(G-U,ee-Z);return{scale:we,x:U*we,y:Z*we,x2:G*we,y2:ee*we,projection:i}}function GD(l,{x:i,y:a},u=0){return new wt(((i-u)*l.scale-l.x)*Bt,(a*l.scale-l.y)*Bt)}const z9=se(new Float32Array(16));class Rh{constructor(i){this.spec=i,this.name=i.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(i,a){return{x:0,y:0,z:0}}unproject(i,a){return new Se(0,0)}projectTilePoint(i,a,u){return{x:i,y:a,z:0}}locationPoint(i,a,u,p=!0){return i._coordinatePoint(i.locationCoordinate(a,u),p)}pixelsPerMeter(i,a){return nt(1,i)*a}pixelSpaceConversion(i,a,u){return 1}farthestPixelDistance(i){return $D(i,i.pixelsPerMeter)}pointCoordinate(i,a,u,p){const g=i.horizonLineFromTop(!1),y=new wt(a,Math.max(g,u));return i.rayIntersectionCoordinate(i.pointRayIntersection(y,p))}pointCoordinate3D(i,a,u){const p=new wt(a,u);if(i.elevation)return i.elevation.pointCoordinate(p);{const g=this.pointCoordinate(i,p.x,p.y,0);return[g.x,g.y,g.z]}}isPointAboveHorizon(i,a){if(i.elevation&&i.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(i,a.x,a.y);const u=i.horizonLineFromTop();return a.y<u}createInversionMatrix(i,a){return z9}createTileMatrix(i,a,u){let p,g,y;const v=u.canonical,T=se(new Float64Array(16));if(this.isReprojectedInTileSpace){const N=G_(v,this);p=1,g=N.x+u.wrap*N.scale,y=N.y,Ae(T,T,[p/N.scale,p/N.scale,i.pixelsPerMeter/a])}else p=a/i.zoomScale(v.z),g=(v.x+Math.pow(2,v.z)*u.wrap)*p,y=v.y*p;return ge(T,T,[g,y,0]),Ae(T,T,[p/Bt,p/Bt,1]),T}upVector(i,a,u){return[0,0,1]}upVectorScale(i,a,u){return{metersToTile:1}}}class B9 extends Rh{constructor(i){super(i),this.range=[4,7],this.center=i.center||[-96,37.5];const[a,u]=this.parallels=i.parallels||[29.5,45.5],p=Math.sin(Zi(a));this.n=(p+Math.sin(Zi(u)))/2,this.c=1+p*(2*this.n-p),this.r0=Math.sqrt(this.c)/this.n}project(i,a){const{n:u,c:p,r0:g}=this,y=Zi(i-this.center[0]),v=Zi(a),T=Math.sqrt(p-2*u*Math.sin(v))/u;return{x:T*Math.sin(y*u),y:T*Math.cos(y*u)-g,z:0}}unproject(i,a){const{n:u,c:p,r0:g}=this,y=g+a;let v=Math.atan2(i,Math.abs(y))*Math.sign(y);y*u<0&&(v-=Math.PI*Math.sign(i)*Math.sign(y));const T=Zi(this.center[0])*u;v=Je(v,-Math.PI-T,Math.PI-T);const N=Ie(Ze(v/u)+this.center[0],-180,180),I=Math.asin(Ie((p-(i*i+y*y)*u*u)/(2*u),-1,1)),P=Ie(Ze(I),-85.051129,$e);return new Se(N,P)}}const H_=1.340264,W_=-.081106,Z_=893e-6,X_=.003796,tw=Math.sqrt(3)/2;class V9 extends Rh{project(i,a){a=a/180*Math.PI,i=i/180*Math.PI;const u=Math.asin(tw*Math.sin(a)),p=u*u,g=p*p*p;return{x:.5*(i*Math.cos(u)/(tw*(H_+3*W_*p+g*(7*Z_+9*X_*p)))/Math.PI+.5),y:1-.5*(u*(H_+W_*p+g*(Z_+X_*p))/Math.PI+1),z:0}}unproject(i,a){i=(2*i-.5)*Math.PI;let u=a=(2*(1-a)-1)*Math.PI,p=u*u,g=p*p*p;for(let I,P,j,O=0;O<12&&(P=u*(H_+W_*p+g*(Z_+X_*p))-a,j=H_+3*W_*p+g*(7*Z_+9*X_*p),I=P/j,u=Ie(u-I,-Math.PI/3,Math.PI/3),p=u*u,g=p*p*p,!(Math.abs(I)<1e-12));++O);const y=tw*i*(H_+3*W_*p+g*(7*Z_+9*X_*p))/Math.cos(u),v=Math.asin(Math.sin(u)/tw),T=Ie(180*y/Math.PI,-180,180),N=Ie(180*v/Math.PI,-85.051129,$e);return new Se(T,N)}}class U9 extends Rh{constructor(i){super(i),this.wrap=!0,this.supportsWorldCopies=!0}project(i,a){return{x:.5+i/360,y:.5-a/360,z:0}}unproject(i,a){const u=360*(i-.5),p=Ie(360*(.5-a),-85.051129,$e);return new Se(u,p)}}const Rg=Math.PI/2;function iw(l){return Math.tan((Rg+l)/2)}class q9 extends Rh{constructor(i){super(i),this.center=i.center||[0,30];const[a,u]=this.parallels=i.parallels||[30,30];let p=Zi(a),g=Zi(u);this.southernCenter=p+g<0,this.southernCenter&&(p=-p,g=-g);const y=Math.cos(p),v=iw(p);this.n=p===g?Math.sin(p):Math.log(y/Math.cos(g))/Math.log(iw(g)/v),this.f=y*Math.pow(iw(p),this.n)/this.n}project(i,a){a=Zi(a),this.southernCenter&&(a=-a),i=Zi(i-this.center[0]);const u=1e-6,{n:p,f:g}=this;g>0?a<-Rg+u&&(a=-Rg+u):a>Rg-u&&(a=Rg-u);const y=g/Math.pow(iw(a),p);let v=y*Math.sin(p*i),T=g-y*Math.cos(p*i);return v=.5*(v/Math.PI+.5),T=.5*(T/Math.PI+.5),{x:v,y:this.southernCenter?T:1-T,z:0}}unproject(i,a){i=(2*i-.5)*Math.PI,this.southernCenter&&(a=1-a),a=(2*(1-a)-.5)*Math.PI;const{n:u,f:p}=this,g=p-a,y=Math.sign(g),v=Math.sign(u)*Math.sqrt(i*i+g*g);let T=Math.atan2(i,Math.abs(g))*y;g*u<0&&(T-=Math.PI*Math.sign(i)*y);const N=Ie(Ze(T/u)+this.center[0],-180,180),I=Ie(Ze(2*Math.atan(Math.pow(p/v,1/u))-Rg),-85.051129,$e);return new Se(N,this.southernCenter?-I:I)}}class HD extends Rh{constructor(i){super(i),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(i,a){return{x:Qe(i),y:at(a),z:0}}unproject(i,a){const u=ft(i),p=Nt(a);return new Se(u,p)}}const WD=Zi($e);class $9 extends Rh{project(i,a){const u=(a=Zi(a))*a,p=u*u;return{x:.5*((i=Zi(i))*(.8707-.131979*u+p*(p*(.003971*u-.001529*p)-.013791))/Math.PI+.5),y:1-.5*(a*(1.007226+u*(.015085+p*(.028874*u-.044475-.005916*p)))/Math.PI+1),z:0}}unproject(i,a){i=(2*i-.5)*Math.PI;let u=a=(2*(1-a)-1)*Math.PI,p=25,g=0,y=u*u;do{y=u*u;const N=y*y;g=(u*(1.007226+y*(.015085+N*(.028874*y-.044475-.005916*N)))-a)/(1.007226+y*(.045255+N*(.259866*y-.311325-.005916*11*N))),u=Ie(u-g,-WD,WD)}while(Math.abs(g)>1e-6&&--p>0);y=u*u;const v=Ie(Ze(i/(.8707+y*(y*(y*y*y*(.003971-.001529*y)-.013791)-.131979))),-180,180),T=Ze(u);return new Se(v,T)}}const ZD=Zi($e);class G9 extends Rh{project(i,a){a=Zi(a),i=Zi(i);const u=Math.cos(a),p=2/Math.PI,g=Math.acos(u*Math.cos(i/2)),y=Math.sin(g)/g,v=.5*(i*p+2*u*Math.sin(i/2)/y)||0,T=.5*(a+Math.sin(a)/y)||0;return{x:.5*(v/Math.PI+.5),y:1-.5*(T/Math.PI+1),z:0}}unproject(i,a){let u=i=(2*i-.5)*Math.PI,p=a=(2*(1-a)-1)*Math.PI,g=25;const y=1e-6;let v=0,T=0;do{const N=Math.cos(p),I=Math.sin(p),P=2*I*N,j=I*I,O=N*N,L=Math.cos(u/2),U=Math.sin(u/2),Z=2*L*U,G=U*U,ee=1-O*L*L,le=ee?1/ee:0,me=ee?Math.acos(N*L)*Math.sqrt(1/ee):0,we=.5*(2*me*N*U+2*u/Math.PI)-i,be=.5*(me*I+p)-a,Re=.5*le*(O*G+me*N*L*j)+1/Math.PI,Me=le*(Z*P/4-me*I*U),je=.125*le*(P*U-me*I*O*Z),Be=.5*le*(j*L+me*G*N)+.5,Ge=Me*je-Be*Re;v=(be*Me-we*Be)/Ge,T=(we*je-be*Re)/Ge,u=Ie(u-v,-Math.PI,Math.PI),p=Ie(p-T,-ZD,ZD)}while((Math.abs(v)>y||Math.abs(T)>y)&&--g>0);return new Se(Ze(u),Ze(p))}}class XD extends Rh{constructor(i){super(i),this.center=i.center||[0,0],this.parallels=i.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(Zi(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(i,a){const{scale:u,cosPhi:p}=this;return{x:Zi(i)*p*u+.5,y:-Math.sin(Zi(a))/p*u+.5,z:0}}unproject(i,a){const{scale:u,cosPhi:p}=this,g=-(a-.5)/u,y=Ie(Ze((i-.5)/u)/p,-180,180),v=Math.asin(Ie(g*p,-1,1)),T=Ie(Ze(v),-85.051129,$e);return new Se(y,T)}}class H9 extends HD{constructor(i){super(i),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(i,a,u){const p=__(i,a,u);return Bi(p,p,S1(Nu(u))),{x:p[0],y:p[1],z:p[2]}}locationPoint(i,a,u){const p=De(a.lat,a.lng),g=ni([],p),y=u?i._centerAltitude+u:i.elevation?i.elevation.getAtPointOrZero(i.locationCoordinate(a),i._centerAltitude):i._centerAltitude;Et(p,p,g,nt(1,0)*Bt*y);const v=se(new Float64Array(16));return K(v,i.pixelMatrix,i.globeMatrix),Bi(p,p,v),new wt(p[0],p[1])}pixelsPerMeter(i,a){return nt(1,0)*a}pixelSpaceConversion(i,a,u){const p=nt(1,i)*a,g=Si(nt(1,45)*a,p,u);return this.pixelsPerMeter(i,a)/g}createTileMatrix(i,a,u){const p=bN(Nu(u.canonical));return K(new Float64Array(16),i.globeMatrix,p)}createInversionMatrix(i,a){const{center:u}=i,p=S1(Nu(a));return Ce(p,p,Zi(u.lng)),Te(p,p,Zi(u.lat)),Ae(p,p,[i._pixelsPerMercatorPixel,i._pixelsPerMercatorPixel,1]),Float32Array.from(p)}pointCoordinate(i,a,u,p){return cR(i,a,u,!0)||new Ut(0,0)}pointCoordinate3D(i,a,u){const p=this.pointCoordinate(i,a,u,0);return[p.x,p.y,p.z]}isPointAboveHorizon(i,a){return!cR(i,a.x,a.y,!1)}farthestPixelDistance(i){const a=function(p,g){const y=p.cameraToCenterDistance,v=p._centerAltitude*g,T=p._camera,N=p._camera.forward(),I=Pe([],Ot([],N,-y),[0,0,v]),P=p.worldSize/(2*Math.PI),j=[0,0,-P],O=p.width/p.height,L=Math.tan(p.fovAboveCenter),U=Ot([],T.up(),L),Z=Ot([],T.right(),L*O),G=ni([],Pe([],Pe([],N,U),Z)),ee=[];let le;if(new Zr(I,G).closestPointOnSphere(j,P,ee)){const me=Pe([],ee,j),we=Tr([],me,I);le=Math.cos(p.fovAboveCenter)*ve(we)}else{const me=Tr([],I,j),we=Tr([],j,I);ni(we,we);const be=ve(me)-P;le=Math.sqrt(be*(be+2*P));const Re=Math.acos(le/(P+be))-Math.acos(ui(N,we));le*=Math.cos(Re)}return 1.01*le}(i,this.pixelsPerMeter(i.center.lat,i.worldSize)),u=Ah(i.zoom);if(u>0){const p=$D(i,nt(1,i.center.lat)*i.worldSize),g=i.worldSize/(2*Math.PI),y=Math.max(i.width,i.height)/i.worldSize*Math.PI;return Si(a,p+g*(1-Math.cos(y)),Math.pow(u,10))}return a}upVector(i,a,u){return __(a,u,i,1)}upVectorScale(i){return{metersToTile:v1(w1(Nu(i)))}}}function YD(l){const i=l.parallels,a=!!i&&Math.abs(i[0]+i[1])<.01;switch(l.name){case"mercator":return new HD(l);case"equirectangular":return new U9(l);case"naturalEarth":return new $9(l);case"equalEarth":return new V9(l);case"winkelTripel":return new G9(l);case"albers":return a?new XD(l):new B9(l);case"lambertConformalConic":return a?new XD(l):new q9(l);case"globe":return new H9(l)}throw new Error(`Invalid projection name: ${l.name}`)}const W9=lr.types,Z9=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Y_(l,i,a,u,p,g,y,v,T,N,I,P,j){const O=v?Math.min(Im,Math.round(v[0])):0,L=v?Math.min(Im,Math.round(v[1])):0;l.emplaceBack(i,a,Math.round(32*u),Math.round(32*p),g,y,(O<<1)+(T?1:0),0+(L<<1),16*N,16*I,256*P,256*j)}function K_(l,i,a){l.emplaceBack(i,a)}function Q_(l,i,a,u,p,g,y){l.emplaceBack(i,a,u,p,g,y)}const rw=(l,i,a,u)=>{for(let p=0;p<i;p++)l.emplaceBack(a[0],a[1],a[2],u[0],u[1],u[2])};function kg(l,i,a,u,p){l.emplaceBack(i,a,u,p),l.emplaceBack(i,a,u,p),l.emplaceBack(i,a,u,p),l.emplaceBack(i,a,u,p)}function X9(l){for(const i of l.sections)if(_u(i.text))return!0;return!1}class NA{constructor(i){this.layoutVertexArray=new u_,this.indexArray=new ys,this.programConfigurations=i,this.segments=new dn,this.dynamicLayoutVertexArray=new Tu,this.opacityVertexArray=new h_,this.placedSymbolArray=new s1,this.iconTransitioningVertexArray=new qo,this.globeExtVertexArray=new d_,this.zOffsetVertexArray=new Qs,this.orientationVertexArray=new hg,this.symbolInstanceIndices=[]}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}getSymbolVertexData(i,a){const u=[],p=this.layoutVertexArray.uint16;for(let g=0;g<a;++g){const y=12*(i+g);u.push(...p.slice(y,y+12))}return u}updateSymbolVertexData(i,a,u,p,g,y,v,T,N,I,P,j,O){const L=this.layoutVertexArray.uint16,U=12*i;L[U]=a,L[U+1]=u,L[U+2]=p,L[U+3]=g,L[U+4]=y,L[U+5]=v,L[U+6]=T,L[U+7]=N,L[U+8]=I,L[U+9]=P,L[U+10]=j,L[U+11]=O}upload(i,a,u,p,g,y){this.isEmpty()||(u&&(this.layoutVertexBuffer=i.createVertexBuffer(this.layoutVertexArray,K8.members,!!y),this.indexBuffer=i.createIndexBuffer(this.indexArray,a),this.dynamicLayoutVertexBuffer=i.createVertexBuffer(this.dynamicLayoutVertexArray,J8.members,!0),this.opacityVertexBuffer=i.createVertexBuffer(this.opacityVertexArray,Z9,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=i.createVertexBuffer(this.iconTransitioningVertexArray,i9.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=i.createVertexBuffer(this.globeExtVertexArray,Q8.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||g)&&(this.zOffsetVertexBuffer=i.createVertexBuffer(this.zOffsetVertexArray,e9.members,!0)),!this.orientationVertexBuffer&&this.orientationVertexArray&&this.orientationVertexArray.length>0&&(this.orientationVertexBuffer=i.createVertexBuffer(this.orientationVertexArray,t9.members,!0)),this.opacityVertexBuffer.itemSize=1),(u||p)&&this.programConfigurations.upload(i))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.orientationVertexBuffer&&this.orientationVertexBuffer.destroy())}}Yt(NA,"SymbolBuffers");class AA{constructor(i,a,u){this.layoutVertexArray=new i,this.layoutAttributes=a,this.indexArray=new u,this.segments=new dn,this.collisionVertexArray=new dg,this.collisionVertexArrayExt=new Tu}upload(i){this.layoutVertexBuffer=i.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=i.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=i.createVertexBuffer(this.collisionVertexArray,r9.members,!0),this.collisionVertexBufferExt=i.createVertexBuffer(this.collisionVertexArrayExt,n9.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Yt(AA,"CollisionBuffers");class nw{constructor(i){this.collisionBoxArray=i.collisionBoxArray,this.zoom=i.zoom,this.overscaling=i.overscaling,this.layers=i.layers,this.layerIds=this.layers.map(y=>y.fqid),this.index=i.index,this.pixelRatio=i.pixelRatio,this.sourceLayerIndex=i.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=se([]),this.placementViewportMatrix=se([]);const a=this.layers[0]._unevaluatedLayout._values;this.worldview=i.worldview,this.localizable=i.localizable,this.textSizeData=Em(this.zoom,a["text-size"],this.worldview,i.availableImages),this.iconSizeData=Em(this.zoom,a["icon-size"],this.worldview,i.availableImages);const u=this.layers[0].layout,p=u.get("symbol-sort-key"),g=u.get("symbol-z-order");this.lut=i.lut,this.canOverlap=u.get("text-allow-overlap")||u.get("icon-allow-overlap")||u.get("text-ignore-placement")||u.get("icon-ignore-placement"),this.sortFeaturesByKey=g!=="viewport-y"&&p.constantOr(1)!==void 0,this.sortFeaturesByY=(g==="viewport-y"||g==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=u.get("text-writing-mode").map(y=>Xo[y]),this.stateDependentLayerIds=this.layers.filter(y=>y.isStateDependent()).map(y=>y.id),this.sourceID=i.sourceID,this.projection=i.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.hasAnySecondaryIcon=!1,this.hasAppearances=null,this.lastActiveApperance=null,this.featureToAppearanceIndex={}}hasAnyAppearanceProperty(i){const a=this.layers[0].getAppearances();if(!a||a.length===0)return!1;const u=Array.isArray(i)?i:[i];return a.some(p=>u.some(g=>p.getProperty(g)!=null))}createArrays(){this.text=new NA(new M(this.layers,{zoom:this.zoom,lut:this.lut},i=>i.startsWith("text")||i.startsWith("symbol"))),this.icon=new NA(new M(this.layers,{zoom:this.zoom,lut:this.lut},i=>i.startsWith("icon")||i.startsWith("symbol"))),this.glyphOffsetArray=new gm,this.lineVertexArray=new l1,this.symbolInstances=new o1}calculateGlyphDependencies(i,a,u,p,g){for(const y of i){const v=y.codePointAt(0);if(v===void 0)break;if(a[v]=!0,p&&g&&v<=65535){const T=B_[y];T&&(a[T.charCodeAt(0)]=!0)}}}calculateEffectiveAppearanceIconSize(i,a,u,p,g,y,v){if(!i.hasProperty("icon-size"))return v*y;let T=1;const N=i.getUnevaluatedProperties()._values["icon-size"],I=Em(this.zoom,N,this.worldview,g),P=Ig(I,a);if(I.kind!=="constant"&&I.kind!=="camera"||(T=P.uSize),I.kind==="composite"){const{minZoom:j,maxZoom:O}=I,L=N.possiblyEvaluate(new Vr(j,{worldview:this.worldview}),p),U=N.possiblyEvaluate(new Vr(O,{worldview:this.worldview}),p),Z=L.evaluate(u,{},p,g);T=Z+(U.evaluate(u,{},p,g)-Z)*P.uSizeT}return I.kind==="source"&&(T=N.possiblyEvaluate(new Vr(this.zoom,{worldview:this.worldview}),p).evaluate(u,{},p,g)),T*y}updateFootprints(i,a){}updateReplacement(i,a){if(a.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=a.updateTime;const u=a.getReplacementRegionsForTile(i.toUnwrapped(),!0);return!R1(this.activeReplacements,u)&&(this.activeReplacements=u,!0)}getResolvedImageFromTokens(i){return typeof i=="string"?Cn.build(i):i}populate(i,a,u,p){const g=this.layers[0],y=g.layout,v=this.projection.name==="globe",T=y.get("text-font"),N=y.get("text-field"),I=y.get("icon-image"),[P,j]=y.get("icon-size-scale-range"),O=Ie(a.scaleFactor||1,P,j),L=(N.value.kind!=="constant"||N.value.value instanceof an&&!N.value.value.isEmpty()||N.value.value.toString().length>0)&&(T.value.kind!=="constant"||T.value.value.length>0),U=I.value.kind!=="constant"||!!I.value.value||Object.keys(I.parameters).length>0,Z=this.hasAnyAppearanceProperty("icon-image"),G=y.get("symbol-sort-key");if(this.features=[],this.appearanceFeatureData=[],!L&&!U&&!Z)return;const ee=a.iconDependencies,le=a.glyphDependencies,me=a.availableImages,we=new Vr(this.zoom,{worldview:this.worldview,activeFloors:a.activeFloors}),be=Re=>{const Me=Re.id.toString();ee.has(Me)?ee.get(Me).push(Re):ee.set(Me,[Re])};for(const Re of i){const{feature:Me,id:je,index:Be,sourceLayerIndex:Ge}=Re,ut=g._featureFilter.needGeometry,lt=Hi(Me,ut);if(!g._featureFilter.filter(we,lt,u))continue;if(ut||(lt.geometry=Ci(Me,u,p)),v&&Me.type!==1&&u.z<=5){const Tt=lt.geometry,_t=.98078528056,Zt=(Xt,Ft)=>ui(__(Xt.x,Xt.y,u,1),__(Ft.x,Ft.y,u,1))<_t;for(let Xt=0;Xt<Tt.length;Xt++)Tt[Xt]=Qt(Tt[Xt],Zt)}let ct,xt;if(L){const Tt=g.getValueAndResolveTokens("text-field",lt,u,me),_t=an.factory(Tt);X9(_t)&&(this.hasRTLText=!0),(!this.hasRTLText||Kx()==="unavailable"||this.hasRTLText&&El.isParsed())&&(ct=a9(_t,g,lt))}if(U){const Tt=g.getValueAndResolveTokens("icon-image",lt,u,me);xt=this.getResolvedImageFromTokens(Tt)}const gt=this.layers[0];let yt=!1;if(!xt&&Z){const Tt=gt.getAppearances();for(const _t of Tt)if(_t.getProperty("icon-image")){const Zt=gt.getAppearanceValueAndResolveTokens(_t,"icon-image",lt,u,me);if(Zt){xt=this.getResolvedImageFromTokens(Zt),yt=!0;break}}}if(!ct&&!xt)continue;const st=this.sortFeaturesByKey?G.evaluate(lt,{},u):void 0,bt={id:je,text:ct,icon:xt,index:Be,sourceLayerIndex:Ge,geometry:lt.geometry,properties:Me.properties,type:W9[Me.type],sortKey:st};if(this.features.push(bt),this.featureToAppearanceIndex[Be]=this.appearanceFeatureData.length,this.appearanceFeatureData.push({id:je,properties:Me.properties,usesAppearanceIconAsPlaceholder:yt,isUsingAppearanceIconVertexData:!1,isUsingAppearanceTextVertexData:!1,layoutBasedIconVertexData:[],layoutBasedTextVertexData:[],activeAppearance:null}),xt){const Tt=gt._unevaluatedLayout._values,{iconPrimary:_t,iconSecondary:Zt}=$_(xt,this.iconSizeData,Tt["icon-size"],u,this.zoom,bt,this.pixelRatio,O,this.worldview,me);be(_t),Zt&&(this.hasAnySecondaryIcon=!0,be(Zt))}const mt=gt.getAppearances();if(mt.length!==0&&mt.forEach(Tt=>{if(!Tt.getProperty("icon-image"))return;const _t=this.getCombinedIconPrimary(Tt,gt,lt,u,me,bt,O);_t&&be(_t)}),ct){const Tt=T.evaluate(lt,{},u).join(","),_t=y.get("text-rotation-alignment")==="map"&&y.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Xo.vertical)>=0;for(const Zt of ct.sections)if(Zt.image){const Xt=Zt.image.getPrimary().scaleSelf(this.pixelRatio),Ft=Xt.id.toString(),Vt=ee.get(Ft)||[];Vt.push(Xt),ee.set(Ft,Vt)}else{const Xt=Wx(ct.toString()),Ft=Zt.fontStack||Tt,Vt=le[Ft]=le[Ft]||{};this.calculateGlyphDependencies(Zt.text,Vt,_t,this.allowVerticalPlacement,Xt)}}}if(y.get("symbol-placement")==="line"&&(this.features=function(Re){const Me={},je={},Be=[];let Ge=0;function ut(gt){Be.push(Re[gt]),Ge++}function lt(gt,yt,st){const bt=je[gt];return delete je[gt],je[yt]=bt,Be[bt].geometry[0].pop(),Be[bt].geometry[0]=Be[bt].geometry[0].concat(st[0]),bt}function ct(gt,yt,st){const bt=Me[yt];return delete Me[yt],Me[gt]=bt,Be[bt].geometry[0].shift(),Be[bt].geometry[0]=st[0].concat(Be[bt].geometry[0]),bt}function xt(gt,yt,st){const bt=st?yt[0][yt[0].length-1]:yt[0][0];return`${gt}:${bt.x}:${bt.y}`}for(let gt=0;gt<Re.length;gt++){const yt=Re[gt],st=yt.geometry,bt=yt.text?yt.text.toString():null;if(!bt){ut(gt);continue}const mt=xt(bt,st),Tt=xt(bt,st,!0);if(mt in je&&Tt in Me&&je[mt]!==Me[Tt]){const _t=ct(mt,Tt,st),Zt=lt(mt,Tt,Be[_t].geometry);delete Me[mt],delete je[Tt],je[xt(bt,Be[Zt].geometry,!0)]=Zt,Be[_t].geometry=null}else mt in je?lt(mt,Tt,st):Tt in Me?ct(mt,Tt,st):(ut(gt),Me[mt]=Ge-1,je[Tt]=Ge-1)}return Be.filter(gt=>gt.geometry)}(this.features)),y.get("symbol-elevation-reference")==="hd-road-markup"){if(this.elevationType="road",a.elevationFeatures){!this.elevationFeatures&&a.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map);for(const Re of a.elevationFeatures)this.elevationFeatureIdToIndex.set(Re.id,this.elevationFeatures.length),this.elevationFeatures.push(Re)}}else y.get("symbol-z-elevate")&&(this.elevationType="offset");this.elevationType!=="none"&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort((Re,Me)=>Re.sortKey-Me.sortKey)}getCombinedIconPrimary(i,a,u,p,g,y,v){let T,N;const I=i.getUnevaluatedProperties();if(I._values["icon-image"].value!==void 0){const P=a.getAppearanceValueAndResolveTokens(i,"icon-image",u,p,g);T=this.getResolvedImageFromTokens(P)}else{const P=a.getValueAndResolveTokens("icon-image",u,p,g);T=this.getResolvedImageFromTokens(P)}if(T){const P=i.hasProperty("icon-size")?I._values["icon-size"]:a._unevaluatedLayout._values["icon-size"];N=$_(T,Em(this.zoom,P,this.worldview,g),P,p,this.zoom,y,this.pixelRatio,v,this.worldview,g).iconPrimary}return N}updateSymbolInstanceIconVertices(i,a,u,p,g,y,v,T,N,I,P,j,O,L){if(i.placedIconSymbolIndex<0)return{vertexOffsetDelta:0,hasChanges:!1};if(a.activeAppearance===u)return{vertexOffsetDelta:i.numIconVertices,hasChanges:!1};if(u){const U=this.getCombinedIconPrimary(u,N,p,y,v,{sortKey:void 0,text:void 0,icon:null,index:i.featureIndex,sourceLayerIndex:i.featureIndex,geometry:[],properties:a.properties,type:"Point",id:a.id},I);if(!U)return{vertexOffsetDelta:0,hasChanges:!1};const Z=U.toString(),G=this.iconAtlasPositions&&this.iconAtlasPositions.get(Z);if(G){const{appearanceIconOffset:ee,appearanceIconRotate:le}=LD(u,N,p,y,j,L,O,I);let me=Z1(G,void 0,ee,N.layout.get("icon-anchor").evaluate(p,P,y));const we=G.sdf,be=N.layout.get("icon-text-fit").constantOr("none");be!=="none"&&a.textShaping&&a.iconTextFitPadding&&a.fontScale&&(me=fA(me,a.textShaping,be,a.iconTextFitPadding,ee,a.fontScale));const Re=this.calculateEffectiveAppearanceIconSize(u,T.zoom,p,y,v,I,O),Me=0,je=1+(Math.min(Im,Math.round(Re*wd))<<1),Be=_A(me,le,we,be!=="none",I);a.isUsingAppearanceIconVertexData||(a.isUsingAppearanceIconVertexData=!0,a.layoutBasedIconVertexData=this.icon.getSymbolVertexData(g,i.numIconVertices));let Ge=g;for(let lt=0;lt<Be.length;++lt){const ct=Be[lt],xt=a.layoutBasedIconVertexData[0]||i.tileAnchorX,gt=a.layoutBasedIconVertexData[1]||i.tileAnchorY,yt=16*ct.pixelOffsetTL.x,st=16*ct.pixelOffsetTL.y,bt=16*ct.pixelOffsetBR.x,mt=16*ct.pixelOffsetBR.y,Tt=16*ct.minFontScaleX,_t=16*ct.minFontScaleY;this.icon.updateSymbolVertexData(Ge,xt,gt,Math.round(32*ct.tl.x),Math.round(32*ct.tl.y),ct.texPrimary.x,ct.texPrimary.y,Me,je,yt,st,Tt,_t),this.icon.updateSymbolVertexData(Ge+1,xt,gt,Math.round(32*ct.tr.x),Math.round(32*ct.tr.y),ct.texPrimary.x+ct.texPrimary.w,ct.texPrimary.y,Me,je,bt,st,Tt,_t),this.icon.updateSymbolVertexData(Ge+2,xt,gt,Math.round(32*ct.bl.x),Math.round(32*ct.bl.y),ct.texPrimary.x,ct.texPrimary.y+ct.texPrimary.h,Me,je,yt,mt,Tt,_t),this.icon.updateSymbolVertexData(Ge+3,xt,gt,Math.round(32*ct.br.x),Math.round(32*ct.br.y),ct.texPrimary.x+ct.texPrimary.w,ct.texPrimary.y+ct.texPrimary.h,Me,je,bt,mt,Tt,_t),Ge+=4}const ut=i.numIconVertices-4*Be.length;for(let lt=0;lt<ut;++lt)this.icon.updateSymbolVertexData(Ge+lt,0,0,0,0,0,0,0,0,0,0,0,0);return{vertexOffsetDelta:i.numIconVertices,hasChanges:!0}}}else if(a.usesAppearanceIconAsPlaceholder){if(this.layers[0].appearances&&this.layers[0].appearances.length>0)return this.icon.updateSymbolVertexData(g,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateSymbolVertexData(g+1,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateSymbolVertexData(g+2,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateSymbolVertexData(g+3,0,0,0,0,0,0,0,0,0,0,0,0),{vertexOffsetDelta:i.numIconVertices,hasChanges:!0}}else if(a.isUsingAppearanceIconVertexData){const Z=a.layoutBasedIconVertexData.length/12;for(let G=0;G<Z;++G){const ee=G*12;this.icon.updateSymbolVertexData(g+G,a.layoutBasedIconVertexData[ee+0],a.layoutBasedIconVertexData[ee+1],a.layoutBasedIconVertexData[ee+2],a.layoutBasedIconVertexData[ee+3],a.layoutBasedIconVertexData[ee+4],a.layoutBasedIconVertexData[ee+5],a.layoutBasedIconVertexData[ee+6],a.layoutBasedIconVertexData[ee+7],a.layoutBasedIconVertexData[ee+8],a.layoutBasedIconVertexData[ee+9],a.layoutBasedIconVertexData[ee+10],a.layoutBasedIconVertexData[ee+11])}return a.isUsingAppearanceIconVertexData=!1,{vertexOffsetDelta:Z,hasChanges:!0}}return{vertexOffsetDelta:i.numIconVertices,hasChanges:!1}}updateSymbolInstanceTextVertices(i,a,u,p,g,y,v,T,N,I,P,j,O,L,U,Z,G,ee){const le=i.numHorizontalGlyphVertices>0||i.numVerticalGlyphVertices>0;if(!le)return{vertexOffsetDelta:le?i.numHorizontalGlyphVertices+i.numVerticalGlyphVertices:0,hasChanges:!1};if(a.activeAppearance===u)return{vertexOffsetDelta:i.numHorizontalGlyphVertices+i.numVerticalGlyphVertices,hasChanges:!1};if(u&&a.textShaping){const{appearanceTextOffset:me,appearanceTextRotate:we,appearanceTextSize:be}=FD(u,v,p,y,P,O,j);a.fontScale=UD(be,a.textScaleFactor);const Re=u.getUnevaluatedProperty("text-size");let Me=this.textSizeData,je=Z,Be=G;u.hasProperty("text-size")&&(Me=Em(this.zoom,Re,this.worldview,ee),je=this.textSizeData.kind==="composite"?this.textSizeData.minZoom:0,Be=this.textSizeData.kind==="composite"?this.textSizeData.maxZoom:0);const Ge=a.textShaping.bottom-P[1],ut=a.textShaping.left-P[0],lt=a.textShaping.right-P[0];a.textShaping.top=me[1]+(a.textShaping.top-P[1]),a.textShaping.bottom=me[1]+Ge,a.textShaping.left=me[0]+ut,a.textShaping.right=me[0]+lt;const ct=MD(0,a.textShaping,me,v,!1,p,N,this.allowVerticalPlacement,we),xt=be&&Me.kind==="composite"?Re.possiblyEvaluate(new Vr(je,{}),y).evaluate(p,I,y):L,gt=be&&Me.kind==="composite"?Re.possiblyEvaluate(new Vr(Be,{}),y).evaluate(p,I,y):U,yt=SA(u.name,Me,be,T,xt,gt),st=Array.isArray(yt)?yt[1]:be,bt=0,mt=1+(Math.min(Im,Math.round(st*wd))<<1);a.isUsingAppearanceTextVertexData||(a.isUsingAppearanceTextVertexData=!0,a.layoutBasedTextVertexData=this.text.getSymbolVertexData(g,i.numHorizontalGlyphVertices+i.numVerticalGlyphVertices));for(let Tt=0;Tt<ct.length&&Tt<(i.numHorizontalGlyphVertices+i.numVerticalGlyphVertices)/4;++Tt){const _t=ct[Tt],Zt=_t.glyphOffset[1],Xt=i.tileAnchorX,Ft=i.tileAnchorY,Vt=g+4*Tt;this.text.updateSymbolVertexData(Vt,Xt,Ft,Math.round(32*_t.tl.x),Math.round(32*(Zt+_t.tl.y)),_t.texPrimary.x,_t.texPrimary.y,bt,mt,_t.pixelOffsetTL.x,_t.pixelOffsetTL.y,_t.minFontScaleX,_t.minFontScaleY),this.text.updateSymbolVertexData(Vt+1,Xt,Ft,Math.round(32*_t.tr.x),Math.round(32*(Zt+_t.tr.y)),_t.texPrimary.x+_t.texPrimary.w,_t.texPrimary.y,bt,mt,_t.pixelOffsetBR.x,_t.pixelOffsetTL.y,_t.minFontScaleX,_t.minFontScaleY),this.text.updateSymbolVertexData(Vt+2,Xt,Ft,Math.round(32*_t.bl.x),Math.round(32*(Zt+_t.bl.y)),_t.texPrimary.x,_t.texPrimary.y+_t.texPrimary.h,bt,mt,_t.pixelOffsetTL.x,_t.pixelOffsetBR.y,_t.minFontScaleX,_t.minFontScaleY),this.text.updateSymbolVertexData(Vt+3,Xt,Ft,Math.round(32*_t.br.x),Math.round(32*(Zt+_t.br.y)),_t.texPrimary.x+_t.texPrimary.w,_t.texPrimary.y+_t.texPrimary.h,bt,mt,_t.pixelOffsetBR.x,_t.pixelOffsetBR.y,_t.minFontScaleX,_t.minFontScaleY)}return{vertexOffsetDelta:i.numHorizontalGlyphVertices+i.numVerticalGlyphVertices,hasChanges:!0}}if(a.isUsingAppearanceTextVertexData){const we=a.layoutBasedTextVertexData.length/12;for(let be=0;be<we;++be){const Re=be*12;this.text.updateSymbolVertexData(g+be,a.layoutBasedTextVertexData[Re+0],a.layoutBasedTextVertexData[Re+1],a.layoutBasedTextVertexData[Re+2],a.layoutBasedTextVertexData[Re+3],a.layoutBasedTextVertexData[Re+4],a.layoutBasedTextVertexData[Re+5],a.layoutBasedTextVertexData[Re+6],a.layoutBasedTextVertexData[Re+7],a.layoutBasedTextVertexData[Re+8],a.layoutBasedTextVertexData[Re+9],a.layoutBasedTextVertexData[Re+10],a.layoutBasedTextVertexData[Re+11])}return a.isUsingAppearanceTextVertexData=!1,{vertexOffsetDelta:we,hasChanges:!0}}return{vertexOffsetDelta:i.numHorizontalGlyphVertices+i.numVerticalGlyphVertices,hasChanges:!1}}update(i,a,u,p,g,y,v){this.text.programConfigurations.updatePaintArrays(i,a,g,u,p,y,v,this.worldview),this.icon.programConfigurations.updatePaintArrays(i,a,g,u,p,y,v,this.worldview)}updateRoadElevation(i){if(this.elevationType!=="road"||!this.elevationFeatures||this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let a=!1;const u=Rt(i),p=1/u;let g=!1,y=!1;for(let v=0;v<this.symbolInstances.length;v++){const T=this.symbolInstances.get(v),N=Le(1,0,0),I=Le(0,1,0),{numHorizontalGlyphVertices:P,numVerticalGlyphVertices:j,numIconVertices:O,numVerticalIconVertices:L}=T,U=P>0||j>0,Z=O>0,G=this.elevationFeatures[T.elevationFeatureIndex];if(G){const ee=new wt(T.tileAnchorX,T.tileAnchorY),le=.075+G.pointElevation(ee);T.zOffset!==le&&(a=!0,T.zOffset=le),le!==0&&(this.hasAnyZOffset=!0);const me=G.computeSlopeNormal(ee,p),we=or(fi(),Le(0,0,1),me);$r(N,N,we),$r(I,I,we),N[2]*=u,I[2]*=u,N[0]===1&&N[1]===0&&N[2]===0&&I[0]===0&&I[1]===1&&I[2]===0||(g=g||U,y=y||Z)}if(U&&(rw(this.text.orientationVertexArray,P,N,I),rw(this.text.orientationVertexArray,j,N,I)),Z){const{placedIconSymbolIndex:ee,verticalPlacedIconSymbolIndex:le}=T;ee>=0&&rw(this.icon.orientationVertexArray,O,N,I),le>=0&&rw(this.icon.orientationVertexArray,L,N,I)}}g||(this.text.orientationVertexArray=void 0),y||(this.icon.orientationVertexArray=void 0),a&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){const i=(g,y,v)=>{u+=y,u>g.length&&g.resize(u);for(let T=-y;T<0;T++)g.emplace(T+u,v)},a=(g,y,v)=>{p+=y,p>g.length&&g.resize(p);for(let T=-y;T<0;T++)g.emplace(T+p,v)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let u=0,p=0;for(let g=0;g<this.symbolInstances.length;g++){const y=this.symbolInstances.get(g),{numHorizontalGlyphVertices:v,numVerticalGlyphVertices:T,numIconVertices:N}=y,I=y.zOffset,P=N>0;if((v>0||T>0)&&(i(this.text.zOffsetVertexArray,v,I),i(this.text.zOffsetVertexArray,T,I)),P){const{placedIconSymbolIndex:j,verticalPlacedIconSymbolIndex:O}=y;j>=0&&a(this.icon.zOffsetVertexArray,N,I),O>=0&&a(this.icon.zOffsetVertexArray,y.numVerticalIconVertices,I)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(i,a,u,p,g){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(i),this.iconCollisionBox.upload(i)),this.text.upload(i,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload,this.hasAppearances),this.hasAppearances===null&&(this.hasAppearances=this.layers.some(y=>y.appearances&&y.appearances.length>0)),this.icon.upload(i,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload,this.hasAppearances),this.uploaded=!0}updateAppearances(i,a,u,p,g){if(!(i&&a&&u&&this.appearanceFeatureData))return!1;const y=this.icon.layoutVertexArray&&this.icon.layoutVertexArray.length>0&&this.icon.layoutVertexArray.arrayBuffer,v=this.text.layoutVertexArray&&this.text.layoutVertexArray.length>0&&this.text.layoutVertexArray.arrayBuffer;if(!y&&!v)return!1;const T=this.layers[0],N=T.layout;let I=1,P=0,j=!1;if(y){const[G,ee]=N.get("icon-size-scale-range");I=Ie(1,G,ee)}let O=1,L=0,U=!1;if(v){const[G,ee]=N.get("text-size-scale-range");O=Ie(1,G,ee)}const Z=new Map;if(g&&u)for(const G of u){const ee=g.getImage(G,T.scope);if(ee){const le=new Er(G.toString());Z.set(le.toString(),ee)}}for(let G=0;G<this.symbolInstances.length;G++){const ee=this.symbolInstances.get(G),le=this.featureToAppearanceIndex[ee.featureIndex],me=le!==void 0?this.appearanceFeatureData[le]:void 0;if(!me)continue;const we=me.id,be=a&&we!==void 0?a[String(we)]:void 0,Re={type:"Point",id:me.id,properties:me.properties,geometry:[]},Me=T.appearances&&T.appearances.find(je=>je.isActive({globals:p,feature:Re,canonical:i,featureState:be}));if(v){const je=N.get("text-size"),Be=N.get("text-offset").evaluate(Re,be,i),Ge=je.evaluate(Re,be,i),ut=N.get("text-rotate").evaluate(Re,be,i),lt=this.textSizeData.kind==="composite"?this.textSizeData.minZoom:0,ct=this.textSizeData.kind==="composite"?this.textSizeData.maxZoom:0,xt=je.evaluate(Re,{zoom:lt},i),gt=je.evaluate(Re,{zoom:ct},i),yt=this.updateSymbolInstanceTextVertices(ee,me,Me,Re,L,i,T,O,Z,be,Be,Ge,ut,xt,gt,lt,ct,u);L+=yt.vertexOffsetDelta,U=U||yt.hasChanges}if(y){const je=N.get("icon-offset").evaluate(Re,be,i),Be=N.get("icon-size").evaluate(Re,be,i,u),Ge=N.get("icon-rotate").evaluate(Re,be,i),ut=this.updateSymbolInstanceIconVertices(ee,me,Me,Re,P,i,u,p,T,I,be,je,Be,Ge);P+=ut.vertexOffsetDelta,j=j||ut.hasChanges}me.activeAppearance=Me}return j&&this.icon.layoutVertexBuffer&&this.icon.layoutVertexArray.arrayBuffer!==null&&this.icon.layoutVertexArray.length===this.icon.layoutVertexBuffer.length&&this.icon.layoutVertexBuffer.updateData(this.icon.layoutVertexArray),U&&this.text.layoutVertexBuffer&&this.text.layoutVertexArray.arrayBuffer!==null&&this.text.layoutVertexArray.length===this.text.layoutVertexBuffer.length&&this.text.layoutVertexBuffer.updateData(this.text.layoutVertexArray),j||U}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=YD(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(i,a){const u=this.lineVertexArray.length;if(i.segment!==void 0)for(const{x:p,y:g}of a)this.lineVertexArray.emplaceBack(p,g);return{lineStartIndex:u,lineLength:this.lineVertexArray.length-u}}addSymbols(i,a,u,p,g,y,v,T,N,I,P,j,O,L,U,Z,G,ee){const le=i.indexArray,me=i.layoutVertexArray,we=i.globeExtVertexArray,be=i.segments.prepareSegment(4*ee,me,le,this.canOverlap?y.sortKey:void 0),Re=this.glyphOffsetArray.length,Me=be.vertexLength,je=this.allowVerticalPlacement&&v===Xo.vertical?Math.PI/2:0,Be=y.text&&y.text.sections;for(let lt=0;lt<a.length;lt++){const{tl:ct,tr:xt,bl:gt,br:yt,texPrimary:st,texSecondary:bt,pixelOffsetTL:mt,pixelOffsetBR:Tt,minFontScaleX:_t,minFontScaleY:Zt,glyphOffset:Xt,isSDF:Ft,sectionIndex:Vt}=a[lt],xi=be.vertexLength,ri=Xt[1];if(Y_(me,N.x,N.y,ct.x,ri+ct.y,st.x,st.y,u,Ft,mt.x,mt.y,_t,Zt),Y_(me,N.x,N.y,xt.x,ri+xt.y,st.x+st.w,st.y,u,Ft,Tt.x,mt.y,_t,Zt),Y_(me,N.x,N.y,gt.x,ri+gt.y,st.x,st.y+st.h,u,Ft,mt.x,Tt.y,_t,Zt),Y_(me,N.x,N.y,yt.x,ri+yt.y,st.x+st.w,st.y+st.h,u,Ft,Tt.x,Tt.y,_t,Zt),T){const{x:Gt,y:Ri,z:tr}=T.anchor,[Cr,Qi,Ur]=T.up;Q_(we,Gt,Ri,tr,Cr,Qi,Ur),Q_(we,Gt,Ri,tr,Cr,Qi,Ur),Q_(we,Gt,Ri,tr,Cr,Qi,Ur),Q_(we,Gt,Ri,tr,Cr,Qi,Ur),kg(i.dynamicLayoutVertexArray,Gt,Ri,tr,je)}else kg(i.dynamicLayoutVertexArray,N.x,N.y,N.z,je);if(Z){const Gt=bt||st;K_(i.iconTransitioningVertexArray,Gt.x,Gt.y),K_(i.iconTransitioningVertexArray,Gt.x+Gt.w,Gt.y),K_(i.iconTransitioningVertexArray,Gt.x,Gt.y+Gt.h),K_(i.iconTransitioningVertexArray,Gt.x+Gt.w,Gt.y+Gt.h)}le.emplaceBack(xi,xi+1,xi+2),le.emplaceBack(xi+1,xi+2,xi+3),be.vertexLength+=4,be.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(Xt[0]),lt!==a.length-1&&Vt===a[lt+1].sectionIndex||i.programConfigurations.populatePaintArrays(me.length,y,y.index,{},O,L,U,Be&&Be[Vt],this.worldview)}const Ge=ee-a.length;Ge!==0&&this._addNullVertices(Ge,me,u,T,we,i,Z,be,le);const ut=T?T.anchor:N;i.placedSymbolArray.emplaceBack(ut.x,ut.y,ut.z,N.x,N.y,Re,this.glyphOffsetArray.length-Re,Me,I,P,N.segment,u?u[0]:0,u?u[1]:0,p[0],p[1],v,0,0,0,j,0),i.symbolInstanceIndices.push(G)}_addNullVertices(i,a,u,p,g,y,v,T,N){for(let I=0;I<i;I++){for(let j=0;j<4;j++)Y_(a,0,0,0,0,0,0,u,!1,0,0,0,0),p&&Q_(g,0,0,0,0,0,0),kg(y.dynamicLayoutVertexArray,0,0,0,0),v&&K_(y.iconTransitioningVertexArray,0,0);const P=T.vertexLength;N.emplaceBack(P,P+1,P+2),N.emplaceBack(P+1,P+2,P+3),T.vertexLength+=4,T.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(0)}}_commitLayoutVertex(i,a,u,p,g,y,v){i.emplaceBack(a,u,p,g,y,Math.round(v.x),Math.round(v.y))}_addCollisionDebugVertices(i,a,u,p,g,y,v){const T=u.segments.prepareSegment(4,u.layoutVertexArray,u.indexArray),N=T.vertexLength,I=v.tileAnchorX,P=v.tileAnchorY;for(let O=0;O<4;O++)u.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(u.collisionVertexArrayExt,a,i.padding,v.zOffset),this._commitLayoutVertex(u.layoutVertexArray,p,g,y,I,P,new wt(i.x1,i.y1)),this._commitLayoutVertex(u.layoutVertexArray,p,g,y,I,P,new wt(i.x2,i.y1)),this._commitLayoutVertex(u.layoutVertexArray,p,g,y,I,P,new wt(i.x2,i.y2)),this._commitLayoutVertex(u.layoutVertexArray,p,g,y,I,P,new wt(i.x1,i.y2)),T.vertexLength+=4;const j=u.indexArray;j.emplaceBack(N,N+1),j.emplaceBack(N+1,N+2),j.emplaceBack(N+2,N+3),j.emplaceBack(N+3,N),T.primitiveLength+=4}_addTextDebugCollisionBoxes(i,a,u,p,g,y){for(let v=p;v<g;v++){const T=u.get(v),N=this.getSymbolInstanceTextSize(i,y,a,v);this._addCollisionDebugVertices(T,N,this.textCollisionBox,T.projectedAnchorX,T.projectedAnchorY,T.projectedAnchorZ,y)}}_addIconDebugCollisionBoxes(i,a,u,p,g,y){for(let v=p;v<g;v++){const T=u.get(v),N=this.getSymbolInstanceIconSize(i,a,y.placedIconSymbolIndex);this._addCollisionDebugVertices(T,N,this.iconCollisionBox,T.projectedAnchorX,T.projectedAnchorY,T.projectedAnchorZ,y)}}generateCollisionDebugBuffers(i,a,u){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new AA(cg,dD.members,qo),this.iconCollisionBox=new AA(cg,dD.members,qo);const p=Ig(this.iconSizeData,i),g=Ig(this.textSizeData,i,u);for(let y=0;y<this.symbolInstances.length;y++){const v=this.symbolInstances.get(y);this._addTextDebugCollisionBoxes(g,i,a,v.textBoxStartIndex,v.textBoxEndIndex,v),this._addTextDebugCollisionBoxes(g,i,a,v.verticalTextBoxStartIndex,v.verticalTextBoxEndIndex,v),this._addIconDebugCollisionBoxes(p,i,a,v.iconBoxStartIndex,v.iconBoxEndIndex,v),this._addIconDebugCollisionBoxes(p,i,a,v.verticalIconBoxStartIndex,v.verticalIconBoxEndIndex,v)}}getSymbolInstanceTextSize(i,a,u,p){const g=this.text.placedSymbolArray.get(a.rightJustifiedTextSymbolIndex>=0?a.rightJustifiedTextSymbolIndex:a.centerJustifiedTextSymbolIndex>=0?a.centerJustifiedTextSymbolIndex:a.leftJustifiedTextSymbolIndex>=0?a.leftJustifiedTextSymbolIndex:a.verticalPlacedTextSymbolIndex>=0?a.verticalPlacedTextSymbolIndex:p),y=gA(this.textSizeData,i,g)/Bs;return this.tilePixelRatio*y}getSymbolInstanceIconSize(i,a,u){const p=this.icon.placedSymbolArray.get(u),g=gA(this.iconSizeData,i,p);return this.tilePixelRatio*g}_commitDebugCollisionVertexUpdate(i,a,u,p){i.emplaceBack(a,-u,-u,p),i.emplaceBack(a,u,-u,p),i.emplaceBack(a,u,u,p),i.emplaceBack(a,-u,u,p)}_updateTextDebugCollisionBoxes(i,a,u,p,g,y,v){for(let T=p;T<g;T++){const N=u.get(T),I=this.getSymbolInstanceTextSize(i,y,a,T);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,I,N.padding,y.zOffset)}}_updateIconDebugCollisionBoxes(i,a,u,p,g,y,v){for(let T=p;T<g;T++){const N=u.get(T),I=this.getSymbolInstanceIconSize(i,a,y.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,I,N.padding,y.zOffset)}}updateCollisionDebugBuffers(i,a,u,p){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const g=Ig(this.iconSizeData,i,p),y=Ig(this.textSizeData,i,u);for(let v=0;v<this.symbolInstances.length;v++){const T=this.symbolInstances.get(v);this._updateTextDebugCollisionBoxes(y,i,a,T.textBoxStartIndex,T.textBoxEndIndex,T,u),this._updateTextDebugCollisionBoxes(y,i,a,T.verticalTextBoxStartIndex,T.verticalTextBoxEndIndex,T,u),this._updateIconDebugCollisionBoxes(g,i,a,T.iconBoxStartIndex,T.iconBoxEndIndex,T,p),this._updateIconDebugCollisionBoxes(g,i,a,T.verticalIconBoxStartIndex,T.verticalIconBoxEndIndex,T,p)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(i,a,u,p,g,y,v,T,N){const I={};if(a<u){const{x1:P,y1:j,x2:O,y2:L,padding:U,projectedAnchorX:Z,projectedAnchorY:G,projectedAnchorZ:ee,tileAnchorX:le,tileAnchorY:me,featureIndex:we}=i.get(a);I.textBox={x1:P,y1:j,x2:O,y2:L,padding:U,projectedAnchorX:Z,projectedAnchorY:G,projectedAnchorZ:ee,tileAnchorX:le,tileAnchorY:me},I.textFeatureIndex=we}if(p<g){const{x1:P,y1:j,x2:O,y2:L,padding:U,projectedAnchorX:Z,projectedAnchorY:G,projectedAnchorZ:ee,tileAnchorX:le,tileAnchorY:me,featureIndex:we}=i.get(p);I.verticalTextBox={x1:P,y1:j,x2:O,y2:L,padding:U,projectedAnchorX:Z,projectedAnchorY:G,projectedAnchorZ:ee,tileAnchorX:le,tileAnchorY:me},I.verticalTextFeatureIndex=we}if(y<v){const{x1:P,y1:j,x2:O,y2:L,padding:U,projectedAnchorX:Z,projectedAnchorY:G,projectedAnchorZ:ee,tileAnchorX:le,tileAnchorY:me,featureIndex:we}=i.get(y);I.iconBox={x1:P,y1:j,x2:O,y2:L,padding:U,projectedAnchorX:Z,projectedAnchorY:G,projectedAnchorZ:ee,tileAnchorX:le,tileAnchorY:me},I.iconFeatureIndex=we}if(T<N){const{x1:P,y1:j,x2:O,y2:L,padding:U,projectedAnchorX:Z,projectedAnchorY:G,projectedAnchorZ:ee,tileAnchorX:le,tileAnchorY:me,featureIndex:we}=i.get(T);I.verticalIconBox={x1:P,y1:j,x2:O,y2:L,padding:U,projectedAnchorX:Z,projectedAnchorY:G,projectedAnchorZ:ee,tileAnchorX:le,tileAnchorY:me},I.verticalIconFeatureIndex=we}return I}deserializeCollisionBoxes(i){this.collisionArrays=[];for(let a=0;a<this.symbolInstances.length;a++){const u=this.symbolInstances.get(a);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(i,u.textBoxStartIndex,u.textBoxEndIndex,u.verticalTextBoxStartIndex,u.verticalTextBoxEndIndex,u.iconBoxStartIndex,u.iconBoxEndIndex,u.verticalIconBoxStartIndex,u.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(i,a){const u=i.placedSymbolArray.get(a),p=u.vertexStartIndex+4*u.numGlyphs;for(let g=u.vertexStartIndex;g<p;g+=4)i.indexArray.emplaceBack(g,g+1,g+2),i.indexArray.emplaceBack(g+1,g+2,g+3)}getSortedSymbolIndexes(i){if(this.sortedAngle===i&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const a=Math.sin(i),u=Math.cos(i),p=[],g=[],y=[];for(let v=0;v<this.symbolInstances.length;++v){y.push(v);const T=this.symbolInstances.get(v);p.push(0|Math.round(a*T.tileAnchorX+u*T.tileAnchorY)),g.push(T.featureIndex)}return y.sort((v,T)=>p[v]-p[T]||g[T]-g[v]),y}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let i=0;i<this.symbolInstances.length;++i)this.symbolInstanceIndexesSortedZOffset.push(i)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((i,a)=>this.symbolInstances.get(a).zOffset-this.symbolInstances.get(i).zOffset)}addToSortKeyRanges(i,a){const u=this.sortKeyRanges[this.sortKeyRanges.length-1];u&&u.sortKey===a?u.symbolInstanceEnd=i+1:this.sortKeyRanges.push({sortKey:a,symbolInstanceStart:i,symbolInstanceEnd:i+1})}sortFeatures(i){if(this.sortFeaturesByY&&this.sortedAngle!==i&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(i),this.sortedAngle=i,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const a of this.symbolInstanceIndexes){const u=this.symbolInstances.get(a);this.featureSortOrder.push(u.featureIndex);const{rightJustifiedTextSymbolIndex:p,centerJustifiedTextSymbolIndex:g,leftJustifiedTextSymbolIndex:y,verticalPlacedTextSymbolIndex:v,placedIconSymbolIndex:T,verticalPlacedIconSymbolIndex:N}=u;p>=0&&this.addIndicesForPlacedSymbol(this.text,p),g>=0&&g!==p&&this.addIndicesForPlacedSymbol(this.text,g),y>=0&&y!==g&&y!==p&&this.addIndicesForPlacedSymbol(this.text,y),v>=0&&this.addIndicesForPlacedSymbol(this.text,v),T>=0&&this.addIndicesForPlacedSymbol(this.icon,T),N>=0&&this.addIndicesForPlacedSymbol(this.icon,N)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}getElevationFeatureForText(i){const a=this.symbolInstances.get(this.text.symbolInstanceIndices[i]).elevationFeatureIndex;let u;return this.elevationFeatures&&a<this.elevationFeatures.length&&(u=this.elevationFeatures[a]),u}}function KD(l,i){return i.replace(/{([^{}]+)}/g,(a,u)=>u in l?String(l[u]):"")}let QD,JD,CA;Yt(nw,"SymbolBucket",{omit:["layers","collisionBoxArray","compareText","features"]}),nw.addDynamicAttributes=kg;class eM{constructor(i){this.type=i.property.overrides?i.property.overrides.runtimeType:_a,this.defaultValue=i}evaluate(i){if(i.formattedSection){const a=this.defaultValue.property.overrides;if(a&&a.hasOverride(i.formattedSection))return a.getOverride(i.formattedSection)}return i.feature&&i.featureState?this.defaultValue.evaluate(i.feature,i.featureState):this.defaultValue.property.specification.default}eachChild(i){this.defaultValue.isConstant()||i(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Yt(eM,"FormatSectionOverride",{omit:["defaultValue"]});const EA=()=>CA||(CA={layout:QD||(QD=new kn({"symbol-placement":new Dt(et.layout_symbol["symbol-placement"]),"symbol-spacing":new Dt(et.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new Dt(et.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new $t(et.layout_symbol["symbol-sort-key"]),"symbol-z-order":new Dt(et.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new Dt(et.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new Dt(et.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new Dt(et.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new Dt(et.layout_symbol["icon-ignore-placement"]),"icon-optional":new Dt(et.layout_symbol["icon-optional"]),"icon-rotation-alignment":new Dt(et.layout_symbol["icon-rotation-alignment"]),"icon-size":new $t(et.layout_symbol["icon-size"]),"icon-size-scale-range":new Dt(et.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new $t(et.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new $t(et.layout_symbol["icon-text-fit-padding"]),"icon-image":new $t(et.layout_symbol["icon-image"]),"icon-image-use-theme":new Dt({type:"string",default:"default","property-type":"data-constant"}),"icon-rotate":new $t(et.layout_symbol["icon-rotate"]),"icon-padding":new Dt(et.layout_symbol["icon-padding"]),"icon-keep-upright":new Dt(et.layout_symbol["icon-keep-upright"]),"icon-offset":new $t(et.layout_symbol["icon-offset"]),"icon-anchor":new $t(et.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new Dt(et.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new Dt(et.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new Dt(et.layout_symbol["text-rotation-alignment"]),"text-field":new $t(et.layout_symbol["text-field"]),"text-font":new $t(et.layout_symbol["text-font"]),"text-size":new $t(et.layout_symbol["text-size"]),"text-size-scale-range":new Dt(et.layout_symbol["text-size-scale-range"]),"text-max-width":new $t(et.layout_symbol["text-max-width"]),"text-line-height":new $t(et.layout_symbol["text-line-height"]),"text-letter-spacing":new $t(et.layout_symbol["text-letter-spacing"]),"text-justify":new $t(et.layout_symbol["text-justify"]),"text-radial-offset":new $t(et.layout_symbol["text-radial-offset"]),"text-variable-anchor":new Dt(et.layout_symbol["text-variable-anchor"]),"text-anchor":new $t(et.layout_symbol["text-anchor"]),"text-max-angle":new Dt(et.layout_symbol["text-max-angle"]),"text-writing-mode":new Dt(et.layout_symbol["text-writing-mode"]),"text-rotate":new $t(et.layout_symbol["text-rotate"]),"text-padding":new Dt(et.layout_symbol["text-padding"]),"text-keep-upright":new Dt(et.layout_symbol["text-keep-upright"]),"text-transform":new $t(et.layout_symbol["text-transform"]),"text-offset":new $t(et.layout_symbol["text-offset"]),"text-allow-overlap":new Dt(et.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new Dt(et.layout_symbol["text-ignore-placement"]),"text-optional":new Dt(et.layout_symbol["text-optional"]),visibility:new Dt(et.layout_symbol.visibility)})),paint:JD||(JD=new kn({"icon-opacity":new $t(et.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new $t(et.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new $t(et.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new $t(et.paint_symbol["text-emissive-strength"]),"icon-color":new $t(et.paint_symbol["icon-color"]),"icon-halo-color":new $t(et.paint_symbol["icon-halo-color"]),"icon-halo-width":new $t(et.paint_symbol["icon-halo-width"]),"icon-halo-blur":new $t(et.paint_symbol["icon-halo-blur"]),"icon-translate":new Dt(et.paint_symbol["icon-translate"]),"icon-translate-anchor":new Dt(et.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new Dt(et.paint_symbol["icon-image-cross-fade"]),"text-opacity":new $t(et.paint_symbol["text-opacity"]),"text-occlusion-opacity":new $t(et.paint_symbol["text-occlusion-opacity"]),"text-color":new $t(et.paint_symbol["text-color"],{runtimeType:ca,getOverride:l=>l.textColor,hasOverride:l=>!!l.textColor}),"text-halo-color":new $t(et.paint_symbol["text-halo-color"]),"text-halo-width":new $t(et.paint_symbol["text-halo-width"]),"text-halo-blur":new $t(et.paint_symbol["text-halo-blur"]),"text-translate":new Dt(et.paint_symbol["text-translate"]),"text-translate-anchor":new Dt(et.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new Dt(et.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new Dt(et.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new Dt(et.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new Dt(et.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new $t(et.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"})}))},CA);class sw extends Ba{constructor(i,a,u,p){super(i,EA(),a,u,p,i.layout?i.layout["icon-image-use-theme"]:null),this._colorAdjustmentMatrix=se([]),this.hasOcclusionOpacityProperties=i.paint!==void 0&&("icon-occlusion-opacity"in i.paint||"text-occlusion-opacity"in i.paint)}_handleSpecialPaintPropertyUpdate(i){i!=="icon-occlusion-opacity"&&i!=="text-occlusion-opacity"||(this.hasOcclusionOpacityProperties=!0)}recalculate(i,a){super.recalculate(i,a),this.appearances&&this.appearances.forEach(p=>{p.recalculate(i,a,this.iconImageUseTheme)}),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const u=this.layout.get("text-writing-mode");if(u){const p=[];for(const g of u)p.indexOf(g)<0&&p.push(g);this.layout._values["text-writing-mode"]=p}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(i,a,u,p){return this._saturation===i&&this._contrast===a&&this._brightnessMin===u&&this._brightnessMax===p||(this._colorAdjustmentMatrix=function(g,y,v,T){g=Es(g),y=yn(y);const N=X(),I=g/3,P=1-2*I,j=[P,I,I,0,I,P,I,0,I,I,P,0,0,0,0,1],O=.5-.5*y,L=T-v;return K(N,[L,0,0,0,0,L,0,0,0,0,L,0,v,v,v,1],[y,0,0,0,0,y,0,0,0,0,y,0,O,O,O,1]),K(N,N,j),N}(i,a,u,p),this._saturation=i,this._contrast=a,this._brightnessMin=u,this._brightnessMax=p),this._colorAdjustmentMatrix}getValueAndResolveTokens(i,a,u,p){const g=this.layout.get(i).evaluate(a,{},u,p),y=this._unevaluatedLayout._values[i];return y.isDataDriven()||rm(y.value)||!g?g:KD(a.properties,g)}getAppearanceValueAndResolveTokens(i,a,u,p,g){const y=i.getProperty(a);if(!y)return;const v=y.evaluate(u,{},p,g),T=i.getUnevaluatedProperties()._values[a];return T.isDataDriven()||rm(T.value)||!v||typeof v!="string"?v:KD(u.properties,v)}createBucket(i){return new nw(i)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const i of EA().paint.overridableProperties){if(!sw.hasPaintOverride(this.layout,i))continue;const a=this.paint.get(i),u=new eM(a),p=new Qf(u,a.property.specification,this.scope,this.options,this.layout.get("icon-image-use-theme"));let g=null;g=a.value.kind==="constant"||a.value.kind==="source"?new nm("source",p):new hd("composite",p,a.value.zoomStops,a.value.interpolationType),this.paint._values[i]=new md(a.property,g,a.parameters)}}_handleOverridablePaintPropertyUpdate(i,a,u){return!(!this.layout||a.isDataDriven()||u.isDataDriven())&&sw.hasPaintOverride(this.layout,i)}static hasPaintOverride(i,a){const u=i.get("text-field"),p=EA().paint.properties[a];let g=!1;const y=v=>{for(const T of v)if(p.overrides&&p.overrides.hasOverride(T))return void(g=!0)};if(u.value.kind==="constant"&&u.value.value instanceof an)y(u.value.value.sections);else if(u.value.kind==="source"){const v=N=>{g||(N instanceof Bo&&un(N.value)===Ic?y(N.value.sections):N instanceof si?y(N.sections):N.eachChild(v))},T=u.value;T._styleExpression&&v(T._styleExpression.expression)}return g}getProgramIds(){return["symbol"]}getDefaultProgramParams(i,a,u){return{config:new D(this,{zoom:a,lut:u}),overrideFog:!1}}hasElevation(){return this.layout&&this.layout.get("symbol-elevation-reference")==="hd-road-markup"}}let tM,iM,rM,nM;var IA=sr([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function aw(l,i,a,u,p,g,y,v){const T=[l,i,1,a,u,1,p,g,1],N=[y,v,1],I=Y([],T),[P,j,O]=Ki(N,N,I);return H(T,T,[P,0,0,0,j,0,0,0,O])}function sM(l,i,a,u,p,g,y,v){const T=function(N,I,P,j,O,L,U,Z){const G=aw(0,0,1,0,1,1,0,1),ee=aw(N,I,P,j,O,L,U,Z);return H(ee,ee,Y([],G))}(l,i,a,u,p,g,y,v);return[T[2]/T[8]/Bt,T[5]/T[8]/Bt]}function ow(l){return[l[0],Math.min(Math.max(l[1],-85.051129),$e)]}class aM extends zo{constructor(i,a,u,p){super(),this.id=i,this.dispatcher=u,this.coordinates=a.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(p),this.options=a,this._dirty=!1}load(i,a){if(this._loaded=a||!1,this.fire(new ul("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return i&&(this.coordinates=i),this._loaded=!0,void this._finishLoading();this._imageRequest=Yn(this.map._requestManager.transformRequest(this.url,Ca.Image),(u,p)=>{this._imageRequest=null,this._loaded=!0,u?this.fire(new nd(u)):p&&(this.image=p instanceof HTMLImageElement?xa.getImageData(p):p,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,i&&(this.coordinates=i),this._finishLoading())})}loaded(){return this._loaded}updateImage(i){return i.url?(this._imageRequest&&i.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=i.url,this.load(i.coordinates,this._loaded),this):this}setTexture(i){if(!(i.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new L_(this.map.painter.context,i.handle),this.width=i.dimensions[0],this.height=i.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new ul("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(i){this.map=i,this.load()}onRemove(i){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof L_||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(i){if(this.coordinates=i,this._boundsArray=void 0,this._unsupportedCoords=!1,!i.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let a=i[0][1],u=i[0][1];for(const g of i)g[1]>u&&(u=g[1]),g[1]<a&&(a=g[1]);const p=(u+a)/2;if(p>$e?this.onNorthPole=!0:p<-85.051129&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const g=i.map(Ut.fromLngLat);this.tileID=function(y){let v=1/0,T=1/0,N=-1/0,I=-1/0;for(const U of y)v=Math.min(v,U.x),T=Math.min(T,U.y),N=Math.max(N,U.x),I=Math.max(I,U.y);const P=Math.max(N-v,I-T),j=Math.max(0,Math.floor(-Math.log2(P))),O=Math.pow(2,j);let L=Math.floor((v+N)/2*O);return L>1&&(L-=1),new wm(j,L,Math.floor((T+I)/2*O))}(g),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new ul("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){!this.texture||this.texture instanceof L_||(this.texture.destroy(),this._dirty=!0),this.texture=null,this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(i){for(const G in this.tiles){const ee=this.tiles[G];ee.state!=="loaded"&&(ee.state="loaded",ee.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const a=G_(new wm(0,0,0),this.map.transform.projection),u=[a.projection.project(this.coordinates[0][0],this.coordinates[0][1]),a.projection.project(this.coordinates[1][0],this.coordinates[1][1]),a.projection.project(this.coordinates[2][0],this.coordinates[2][1]),a.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(G){const ee=G[1].x-G[0].x,le=G[1].y-G[0].y,me=G[2].x-G[1].x,we=G[2].y-G[1].y,be=G[3].x-G[2].x,Re=G[3].y-G[2].y,Me=G[0].x-G[3].x,je=G[0].y-G[3].y,Be=ee*we-me*le,Ge=me*Re-be*we,ut=be*je-Me*Re,lt=Me*le-ee*je;return Be>0&&Ge>0&&ut>0&&lt>0||Be<0&&Ge<0&&ut<0&&lt<0}(u))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const p=G_(this.tileID,this.map.transform.projection),[g,y,v,T]=this.coordinates.map(G=>{const ee=p.projection.project(G[0],G[1]);return GD(p,ee)._round()});this.perspectiveTransform=sM(g.x,g.y,y.x,y.y,v.x,v.y,T.x,T.y);const N=this._boundsArray=new Dc;N.emplaceBack(g.x,g.y,0,0),N.emplaceBack(y.x,y.y,Bt,0),N.emplaceBack(T.x,T.y,0,Bt),N.emplaceBack(v.x,v.y,Bt,Bt),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=i.createVertexBuffer(N,IA.members),this.boundsSegments=dn.simpleSegment(0,0,4,2);const I=[],P=[ow((j=this.coordinates)[0]),ow(j[1]),ow(j[2]),ow(j[3])];var j;const[O,L,U,Z]=function(G){let ee=G[0][0],le=ee,me=G[0][1],we=me;for(let be=1;be<G.length;be++)G[be][0]<ee?ee=G[be][0]:G[be][0]>le&&(le=G[be][0]),G[be][1]<me?me=G[be][1]:G[be][1]>we&&(we=G[be][1]);return[ee,me,le-ee,we-me]}(P);{const G=new Dc,[ee,le,me,we]=function(yt){let st=yt[0].x,bt=st,mt=yt[0].y,Tt=mt;for(let _t=1;_t<yt.length;_t++)yt[_t].x<st?st=yt[_t].x:yt[_t].x>bt&&(bt=yt[_t].x),yt[_t].y<mt?mt=yt[_t].y:yt[_t].y>Tt&&(Tt=yt[_t].y);return[st,mt,bt-st,Tt-mt]}(u),be=yt=>[(yt.x-ee)/me,(yt.y-le)/we],[Re,Me,je,Be]=u.map(be),Ge=function(yt,st,bt,mt,Tt,_t,Zt,Xt){const Ft=aw(0,0,1,0,1,1,0,1);return H(Ft,Ft,Y([],aw(yt,st,bt,mt,Tt,_t,Zt,Xt)))}(Re[0],Re[1],Me[0],Me[1],je[0],je[1],Be[0],Be[1]);this.elevatedGlobePerspectiveTransform=sM(Re[0],Re[1],Me[0],Me[1],je[0],je[1],Be[0],Be[1]);const ut=(yt,st)=>{I.push(yt.lng);const bt=Math.round((yt.lng-O)/U*Bt),mt=Math.round((yt.lat-L)/Z*Bt),Tt=be(st),_t=Ki([],[Tt[0],Tt[1],1],Ge),Zt=Math.round(_t[0]/_t[2]*Bt),Xt=Math.round(_t[1]/_t[2]*Bt);G.emplaceBack(bt,mt,Zt,Xt)},lt=u[3].x-u[0].x,ct=u[3].y-u[0].y,xt=u[2].x-u[1].x,gt=u[2].y-u[1].y;for(let yt=0;yt<65;yt++){const st=yt/64,bt=[u[0].x+st*lt,u[0].y+st*ct],mt=[u[1].x+st*xt,u[1].y+st*gt],Tt=mt[0]-bt[0],_t=mt[1]-bt[1];for(let Zt=0;Zt<65;Zt++){const Xt=Zt/64,Ft={x:bt[0]+Tt*Xt,y:bt[1]+_t*Xt};ut(a.projection.unproject(Ft.x,Ft.y),Ft)}}this.elevatedGlobeVertexBuffer=i.createVertexBuffer(G,IA.members)}{this.maxLongitudeTriangleSize=0;let G=[],ee=new ys;const le=(me,we,be)=>{ee.emplaceBack(me,we,be);const Re=I[me],Me=I[we],je=I[be],Be=Math.min(Math.min(Re,Me),je),Ge=Math.max(Math.max(Re,Me),je)-Be;Ge>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=Ge),G.push(Be+Ge/2)};for(let me=0;me<64;me++)for(let we=0;we<64;we++){const be=65*me+we,Re=be+1,Me=be+65,je=Me+1;le(be,Me,Re),le(Re,Me,je)}[G,ee]=function(me,we){const be=Array.from({length:me.length},(je,Be)=>Be);be.sort((je,Be)=>me[je]-me[Be]);const Re=[],Me=new ys;for(let je=0;je<be.length;je++){const Be=be[je];Re.push(me[Be]);const Ge=3*Be,ut=Ge+1;Me.emplaceBack(we.uint16[Ge],we.uint16[ut],we.uint16[ut+1])}return[Re,Me]}(G,ee),this.elevatedGlobeTrianglesCenterLongitudes=G,this.elevatedGlobeIndexBuffer=i.createIndexBuffer(ee)}this.elevatedGlobeSegments=dn.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,U/Bt,0,Z/Bt,0,0,L,O,0])}prepare(){const i=Object.keys(this.tiles).length!==0;if(this.tileID&&!i)return;const a=this.map.painter.context,u=a.gl;!this._dirty||this.texture instanceof L_||(this.texture?this.texture.update(this.image):(this.texture=new JN(a,this.image,u.RGBA8),this.texture.bind(u.LINEAR,u.CLAMP_TO_EDGE)),this._dirty=!1),i&&this._prepareData(a)}loadTile(i,a){this.tileID&&this.tileID.equals(i.tileID.canonical)?(this.tiles[String(i.tileID.wrap)]=i,i.buckets={},a(null)):(i.state="errored",a(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(i){const a=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!a)return null;const u=this.elevatedGlobeTrianglesCenterLongitudes;let p=(g=i+180)+360*Math.round((u[0]-g)/360);var g;const y=new dn,v=(P,j)=>{y.segments.push({vertexOffset:0,primitiveOffset:P,vertexLength:a.segments[0].vertexLength,primitiveLength:j,sortKey:void 0,vaos:{}})},T=.51*this.maxLongitudeTriangleSize;if(Math.abs(u[0]-p)<=T){const P=Lr(u,0,u.length,p+T);return P===u.length||v(P,Or(u,P+1,u.length,p+360-T)-P),y}p<u[0]&&(p+=360);const N=Or(u,0,u.length,p-T);if(N===u.length)return v(0,u.length),y;v(0,N-0);const I=Lr(u,N+1,u.length,p+T);return I!==u.length&&v(I,u.length-I),y}}const Y9=(Math.pow(256,2)-1)/16907520;class oM extends Ba{constructor(i,a,u,p){super(i,{layout:rM||(rM=new kn({visibility:new Dt(et.layout_raster.visibility)})),paint:nM||(nM=new kn({"raster-opacity":new Dt(et.paint_raster["raster-opacity"]),"raster-color":new yh(et.paint_raster["raster-color"]),"raster-color-mix":new Dt(et.paint_raster["raster-color-mix"]),"raster-color-range":new Dt(et.paint_raster["raster-color-range"]),"raster-hue-rotate":new Dt(et.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new Dt(et.paint_raster["raster-brightness-min"]),"raster-brightness-max":new Dt(et.paint_raster["raster-brightness-max"]),"raster-saturation":new Dt(et.paint_raster["raster-saturation"]),"raster-contrast":new Dt(et.paint_raster["raster-contrast"]),"raster-resampling":new Dt(et.paint_raster["raster-resampling"]),"raster-fade-duration":new Dt(et.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new Dt(et.paint_raster["raster-emissive-strength"]),"raster-array-band":new Dt(et.paint_raster["raster-array-band"]),"raster-elevation":new Dt(et.paint_raster["raster-elevation"]),"raster-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"})}))},a,u,p),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(i){return!(i&&i._source instanceof aM&&(i._source.onNorthPole||i._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(i){i!=="raster-color"&&i!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}updateColorRamp(i){if(!this.hasColorMap()||!this._curRampRange)return;const a=this._transitionablePaint._values["raster-color"].value.expression,[u,p]=i||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(u)&&isNaN(p)||u===this._curRampRange[0]&&p===this._curRampRange[1]||(this.colorRamp=v_({expression:a,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:u,end:p}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[u,p])}}let lM,cM,uM,dM,hM;class pM extends Ba{constructor(i,a,u,p){super(i,{layout:lM||(lM=new kn({visibility:new Dt(et["layout_raster-particle"].visibility)})),paint:cM||(cM=new kn({"raster-particle-array-band":new Dt(et["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new Dt(et["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new yh(et["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new Dt(et["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new Dt(et["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new Dt(et["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new Dt(et["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new Dt(et["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"})}))},a,u,p),this._updateColorRamp(),this.lastInvalidatedAt=xa.now()}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this.tileFramebuffer&&(this.tileFramebuffer.destroy(),this.tileFramebuffer=null),this.particleFramebuffer&&(this.particleFramebuffer.destroy(),this.particleFramebuffer=null)}onRemove(i){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isDraped(i){return!1}_handleSpecialPaintPropertyUpdate(i){i!=="raster-particle-color"&&i!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),i==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const i=this._transitionablePaint._values["raster-particle-color"].value.expression,a=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=v_({expression:i,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:a}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=xa.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class K9 extends Ba{constructor(i,a){super(i,{},a,null),this.implementation=i,i.slot&&(this.slot=i.slot)}is3D(i){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isDraped(i){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(i){this.implementation.onAdd&&this.implementation.onAdd(i,i.painter.context.gl)}onRemove(i){this.implementation.onRemove&&this.implementation.onRemove(i,i.painter.context.gl)}}function PA(l,i,a){const u=[0,0,1],p=vi([]);return Nr(p,p,a?-Zi(l)+Math.PI:Zi(l)),Pi(p,p,-Zi(i)),$r(u,u,p),ni(u,u)}const mM={None:0,Model:1,Symbol:2,FillExtrusion:4};class lw{constructor(i,a,u,p){this.message=(i?`${i}: `:"")+u,p&&(this.identifier=p),a!=null&&a.__line__&&(this.line=a.__line__)}}function jA(l,i){const a=l.indexOf("://")===-1;try{return new URL(l,a&&i?"http://example.com":void 0),!0}catch{return!1}}class fM{constructor(i,a){this.feature=i,this.instancedDataOffset=a,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class gM{constructor(){this.maxScale=1,this.maxXYTranslationDistance=0,this.instancedDataArray=new f_,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}colorForInstance(i){const a=16*i,u=this.instancedDataArray.float32;let p=Math.floor(u[a+2]);const g=1.05*(u[a+2]-p);return p/=100,[u[a]%1*1.05,u[a+1]%1*1.05,g,p]}tileCoordinatesForInstance(i){const a=16*i,u=this.instancedDataArray.float32;let p=u[a+0];return p=p>Bt?p-Bt:p,new wt(Math.trunc(p),Math.trunc(u[a+1]))}translationForInstance(i){const a=16*i,u=this.instancedDataArray.float32;return[u[a+4],u[a+5],u[a+6]]}rotationScaleForInstance(i){const a=16*i,u=this.instancedDataArray.float32;return[u[a+7],u[a+8],u[a+9],u[a+10],u[a+11],u[a+12],u[a+13],u[a+14],u[a+15]]}transformForInstance(i){const a=16*i,u=this.instancedDataArray.float32;return[u[a+7],u[a+8],u[a+9],u[a+4],u[a+10],u[a+11],u[a+12],u[a+5],u[a+13],u[a+14],u[a+15],u[a+6],0,0,0,1]}}class RA{constructor(i){this.zoom=i.zoom,this.canonical=i.canonical,this.overscaledZ=this.canonical.z+Math.log2(i.overscaling),this.layers=i.layers,this.layerIds=this.layers.map(a=>a.fqid),this.projection=i.projection,this.index=i.index,this.worldview=i.worldview,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(a=>a.isStateDependent()).map(a=>a.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z+1?0:this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.styleDefinedModelURLs=i.styleDefinedModelURLs,this.hasAppearances=null}updateFootprints(i,a){}updateAppearances(i,a,u,p){}populate(i,a,u,p){this.tileToMeter=Rt(u);const g=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:y,id:v,index:T,sourceLayerIndex:N}of i){const I=v??(y.properties&&y.properties.hasOwnProperty("id")?y.properties.id:void 0),P=Hi(y,g);if(!this.layers[0]._featureFilter.filter(new Vr(this.zoom,{worldview:this.worldview,activeFloors:a.activeFloors}),P,u))continue;const j={id:I,sourceLayerIndex:N,index:T,geometry:g?P.geometry:Ci(y,u,p),properties:y.properties,type:y.type,patterns:{}},O=this.addFeature(j,j.geometry,P);O&&a.featureIndex.insert(y,j.geometry,T,N,this.index,this.instancesPerModel[O].instancedDataArray.length,256)}this.lookup=null}evaluateQueryRenderedFeaturePadding(){const i=this.layers[0].modelManager,a=this.layers[0].scope;let u=0;for(const p of this.modelUris){const g=i.getModel(p,a);if(!g)continue;const y=this.instancesPerModel[p];if(y){const v=.5*yi(g.aabb.max,g.aabb.min)*y.maxScale+y.maxXYTranslationDistance,T=Math.min(Bt,Math.max(v/this.tileToMeter,256));u=Math.max(T,u)}}return u}update(i,a,u,p){for(const g in this.instancesPerModel){const y=this.instancesPerModel[g];for(const v in i)y.idToFeaturesIndex.hasOwnProperty(v)&&(this.evaluate(y.features[y.idToFeaturesIndex[v]],i[v],y,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let i=!1;for(const a in this.instancesPerModel){const u=this.instancesPerModel[a];for(const p of u.features){const g=this.layers[0],y=p.feature,v=this.canonical,T=g.paint.get("model-rotation").evaluate(y,{},v),N=g.paint.get("model-scale").evaluate(y,{},v),I=g.paint.get("model-translation").evaluate(y,{},v);Gn(p.rotation,T)&&Gn(p.scale,N)&&Gn(p.translation,I)||(this.evaluate(p,p.featureStates,u,!0),i=!0)}}return i}updateReplacement(i,a,u,p){if(a.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=a.updateTime;const g=a.getReplacementRegionsForTile(i.toUnwrapped(),!0);if(R1(this.activeReplacements,g))return!1;this.activeReplacements=g;let y=!1;for(const v in this.instancesPerModel){const T=this.instancesPerModel[v],N=T.instancedDataArray;for(const I of T.features){const P=I.instancedDataOffset,j=I.instancedDataCount;for(let O=0;O<j;O++){const L=16*(O+P);let U=N.float32[L+0];const Z=U>Bt;U=Z?U-Bt:U;const G=Math.floor(U),ee=Math.floor(N.float32[L+1]);let le=!1;for(const me of this.activeReplacements)if(!XR(me,u,mM.Model,p)&&!(me.min.x>G||G>me.max.x||me.min.y>ee||ee>me.max.y)&&(le=ek(JR(G,ee,i.canonical,me.footprintTileId.canonical),me.footprint),le))break;N.float32[L]=le?U+Bt:U,y=y||le!==Z}}}return y}isEmpty(){for(const i in this.instancesPerModel)if(this.instancesPerModel[i].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(i){if(!this.uploaded)for(const a in this.instancesPerModel){const u=this.instancesPerModel[a];u.instancedDataArray.length<0||u.instancedDataArray.length===0||(u.instancedDataBuffer?u.instancedDataBuffer.updateData(u.instancedDataArray):u.instancedDataBuffer=i.createVertexBuffer(u.instancedDataArray,_8.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(i){for(const u in this.instancesPerModel){const p=this.instancesPerModel[u];p.instancedDataArray.length!==0&&p.instancedDataBuffer&&p.instancedDataBuffer.destroy()}const a=this.layers[0].modelManager;if(i&&a&&this.modelUris&&this.modelsRequested)for(const u of this.modelUris)a.removeModel(u,"",!0)}addFeature(i,a,u){const p=this.layers[0],g=p.layout.get("model-id"),y=p.layout.get("model-allow-density-reduction"),v=g.evaluate(u,{},this.canonical);if(!v)return Ni(`modelId is not evaluated for layer ${p.id} and it is not going to get rendered.`),v;(jA(v,!1)||this.styleDefinedModelURLs[v]!==void 0)&&(this.modelUris.includes(v)||this.modelUris.push(v)),this.instancesPerModel[v]||(this.instancesPerModel[v]=new gM);const T=this.instancesPerModel[v],N=T.instancedDataArray,I=new fM(u,N.length);for(const P of a)for(const j of P){if(j.x<0||j.x>=Bt||j.y<0||j.y>=Bt)continue;if(this.lookupDim!==0&&y){const L=(this.lookupDim-1)/Bt,U=this.lookupDim*(j.y*L|0)+j.x*L|0;if(this.lookup){if(this.lookup[U]!==0)continue;this.lookup[U]=1}}this.instanceCount++;const O=N.length;N.resize(O+1),T.instancesEvaluatedElevation.push(0),N.float32[16*O]=j.x,N.float32[16*O+1]=j.y}return I.instancedDataCount=T.instancedDataArray.length-I.instancedDataOffset,I.instancedDataCount>0&&(i.id&&(T.idToFeaturesIndex[i.id]=T.features.length),T.features.push(I),this.evaluate(I,{},T,!1)),v}getModelUris(){return this.modelUris}evaluate(i,a,u,p){const g=this.layers[0],y=i.feature,v=this.canonical,T=i.rotation=g.paint.get("model-rotation").evaluate(y,a,v),N=i.scale=g.paint.get("model-scale").evaluate(y,a,v),I=i.translation=g.paint.get("model-translation").evaluate(y,a,v),P=Object.assign({},g.paint.get("model-color").evaluate(y,a,v));P.a=g.paint.get("model-color-mix-intensity").evaluate(y,a,v);const j=[];this.maxVerticalOffset<I[2]&&(this.maxVerticalOffset=I[2]);const O=I[0]*I[0]+I[1]*I[1],L=O>0?Math.sqrt(O):0;u.maxScale=Math.max(Math.max(u.maxScale,N[0]),Math.max(N[1],N[2])),u.maxXYTranslationDistance=Math.max(u.maxXYTranslationDistance,L),this.maxScale=Math.max(Math.max(this.maxScale,N[0]),Math.max(N[1],N[2])),$k(j,T,N);const U=Math.round(100*P.a)+P.b/1.05;for(let Z=0;Z<i.instancedDataCount;++Z){const G=i.instancedDataOffset+Z,ee=16*G,le=u.instancedDataArray.float32;let me=0;p&&(me=le[ee+6]-u.instancesEvaluatedElevation[G]);const we=0|le[ee+1];le[ee]=(0|le[ee])+P.r/1.05,le[ee+1]=we+P.g/1.05,le[ee+2]=U,le[ee+3]=1/(v.z>10?this.tileToMeter:Rt(v,we)),le[ee+4]=I[0],le[ee+5]=I[1],le[ee+6]=I[2]+me,le[ee+7]=j[0],le[ee+8]=j[1],le[ee+9]=j[2],le[ee+10]=j[4],le[ee+11]=j[5],le[ee+12]=j[6],le[ee+13]=j[8],le[ee+14]=j[9],le[ee+15]=j[10],u.instancesEvaluatedElevation[G]=I[2]}}}let yM,xM;Yt(RA,"ModelBucket",{omit:["layers"]}),Yt(gM,"PerModelAttributes"),Yt(fM,"ModelFeature");class Dg{constructor(i,a,u){this._demTile=i,this._dem=this._demTile.dem,this._scale=a,this._offset=u}static create(i,a,u){const p=u||i.findDEMTileFor(a);if(!p||!p.dem)return;const g=p.dem,y=p.tileID,v=1<<a.canonical.z-y.canonical.z;return new Dg(p,g.dim/Bt/v,[(a.canonical.x/v-y.canonical.x)*g.dim,(a.canonical.y/v-y.canonical.y)*g.dim])}tileCoordToPixel(i,a){const u=a*this._scale+this._offset[1];return new wt(Math.floor(i*this._scale+this._offset[0]),Math.floor(u))}getElevationAt(i,a,u,p){const g=i*this._scale+this._offset[0],y=a*this._scale+this._offset[1],v=Math.floor(g),T=Math.floor(y),N=this._dem;return p=!!p,u?Si(Si(N.get(v,T,p),N.get(v,T+1,p),y-T),Si(N.get(v+1,T,p),N.get(v+1,T+1,p),y-T),g-v):N.get(v,T,p)}getElevationAtPixel(i,a,u){return this._dem.get(i,a,!!u)}getMeterToDEM(i){return(1<<this._demTile.tileID.canonical.z)*nt(1,i)*this._dem.stride}}const kA=new Float32Array(262144),Pm=new Uint8Array(262144);function _M(l){let i=0;if(l.meshes)for(const a of l.meshes)i=Math.max(i,a.aabb.max[2]);if(l.children)for(const a of l.children)i=Math.max(i,_M(a));return i}function vM(l,i,a){if(l.meshes)for(const u of l.meshes){if(u.aabb.min[0]===1/0)continue;const p=jr.applyTransform(u.aabb,l.globalMatrix);a.insert(i,p.min[0],p.min[1],p.max[0],p.max[1])}if(l.children)for(const u of l.children)vM(u,i,a)}const bM=["","wall","door","roof","window","lamp","logo"];class wM{constructor(i){this.node=i,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedTranslation=[0,0,0],this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:i.id,geometry:[],properties:{height:_M(i)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new jr([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let i=0;const a=new jr([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const u of this.node.meshes)this.node.lightMeshIndex!==i&&(u.transformedAabb=jr.applyTransformFast(u.aabb,this.node.globalMatrix),a.encapsulate(u.transformedAabb)),i++;this.aabb=a}return this.aabb}}class cw{constructor(i,a,u,p,g,y,v,T){this.id=u,this.layers=i,this.layerIds=this.layers.map(N=>N.fqid),this.stateDependentLayerIds=this.layers.filter(N=>N.isStateDependent()).map(N=>N.id),this.modelTraits|=Ag.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,p&&(this.modelTraits|=Ag.HasMapboxMeshFeatures),g&&(this.modelTraits|=Ag.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=y,this.worldview=T,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[];for(const N of a)this.nodesInfo.push(new wM(N)),vM(N,v.featureIndexArray.length,v.grid),v.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,v.bucketLayerIDs.length-1,0);this.states={},this.hasAppearances=null}updateFootprints(i,a){for(const u of this.getNodesInfo()){const p=u.node;p.footprint&&a.push({footprint:p.footprint,id:i})}}updateAppearances(i,a,u,p){}update(i){const a=Object.keys(i).length!==0;if(a&&!this.stateDependentLayers.length)return;const u=a?this.stateDependentLayers:this.layers;if(!Xa(i,this.states))for(const p of u)this.evaluate(p,i);this.states=structuredClone(i)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(i){if(!this.needsUpload)return;const a=this.getNodesInfo();for(const u of a){const p=u.node;this.uploaded?this.updatePbrBuffer(p):iA(p,i,!0)}for(const u of a)$1(u.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(i){let a=!1;if(!i.meshes)return a;for(const u of i.meshes)u.pbrBuffer&&(u.pbrBuffer.updateData(u.featureArray),a=!0);return a}needsReEvaluation(i,a,u){const p=i.transform.projectionOptions,g=i.style.getBrightness(),y=this.brightness!==g;if(!this.uploaded||this.dirty||p.name!==this.projection.name||J_(u.paint.get("model-color").value,y)||J_(u.paint.get("model-color-mix-intensity").value,y)||J_(u.paint.get("model-roughness").value,y)||J_(u.paint.get("model-emissive-strength").value,y)||J_(u.paint.get("model-height-based-emissive-strength-multiplier").value,y)){this.projection=p,this.brightness=g;const v=this.getNodesInfo();for(const T of v)T.state=null;return!0}return!1}evaluateTransform(i,a){if(i.transform.zoom===this.zoom)return;this.zoom=i.transform.zoom;const u=this.getNodesInfo(),p=this.id.canonical;for(const g of u){const y=g.feature;g.evaluatedTranslation=a.paint.get("model-translation").evaluate(y,{},p),g.evaluatedScale=a.paint.get("model-scale").evaluate(y,{},p)}}evaluate(i,a){const u=this.getNodesInfo();for(const p of u){if(!p.node.meshes)continue;const g=p.feature,y=a&&a[g.id];if(Xa(y,p.state))continue;p.state=structuredClone(y);const v=p.node.meshes&&p.node.meshes[0].featureData,T=p.evaluatedColor[2],N=p.evaluatedRMEA[2],I=this.id.canonical;if(p.hasTranslucentParts=!1,v){for(let P=0;P<bM.length;P++){const j=bM[P];j.length&&(g.properties.part=j);const O=i.paint.get("model-color").evaluate(g,y,I).toPremultipliedRenderColor(null),L=i.paint.get("model-color-mix-intensity").evaluate(g,y,I);p.evaluatedColor[P]=[O.r,O.g,O.b,L],p.evaluatedRMEA[P][0]=i.paint.get("model-roughness").evaluate(g,y,I),p.evaluatedRMEA[P][2]=i.paint.get("model-emissive-strength").evaluate(g,y,I),p.evaluatedRMEA[P][3]=O.a,p.emissionHeightBasedParams[P]=i.paint.get("model-height-based-emissive-strength-multiplier").evaluate(g,y,I),!p.hasTranslucentParts&&O.a<1&&(p.hasTranslucentParts=!0)}delete g.properties.part,J9(p,T!==p.evaluatedColor[2]||N!==p.evaluatedRMEA[2],this.modelTraits)}else p.evaluatedRMEA[0][2]=i.paint.get("model-emissive-strength").evaluate(g,y,I);p.evaluatedTranslation=i.paint.get("model-translation").evaluate(g,y,I),p.evaluatedScale=i.paint.get("model-scale").evaluate(g,y,I),this.updatePbrBuffer(p.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(i,a,u,p){const g=i.findDEMTileFor(u);if(g&&(g.tileID.canonical!==this.terrainTile||a!==this.terrainExaggeration)){if(g.dem&&g.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=g.tileID.overscaledZ;const y=Dg.create(i,u,g);if(!y)return;this.modelTraits&Ag.HasMapboxMeshFeatures&&this.updateDEM(i,y,u,p);for(const v of this.getNodesInfo()){const T=v.node;if(!T.footprint||!T.footprint.vertices||!T.footprint.vertices.length)continue;const N=T.footprint.vertices;let I=y.getElevationAt(N[0].x,N[0].y,!0,!0);for(let P=1;P<N.length;P++)I=Math.min(I,y.getElevationAt(N[P].x,N[P].y,!0,!0));T.elevation=I}}this.terrainTile=g.tileID.canonical,this.terrainExaggeration=a}}updateDEM(i,a,u,p){let g=a._dem._modifiedForSources[p];if(g===void 0&&(a._dem._modifiedForSources[p]=[],g=a._dem._modifiedForSources[p]),g.includes(u.canonical))return;const y=a._dem.dim;g.push(u.canonical);let v=!1;for(const T of this.getNodesInfo()){const N=T.node;if(!N.footprint||!N.footprint.grid)continue;const I=N.footprint.grid,P=a.tileCoordToPixel(I.min.x,I.min.y),j=a.tileCoordToPixel(I.max.x,I.max.y),O=Math.min(Math.min(y-j.y,P.x),Math.min(P.y,y-j.x));if(O<0)continue;const L=Ie(O,2,5);let U=Math.max(0,P.x-L),Z=Math.max(0,P.y-L),G=Math.min(j.x+L,y-1),ee=Math.min(j.y+L,y-1);for(let be=Z;be<=ee;++be)for(let Re=U;Re<=G;++Re)Pm[be*y+Re]=255;let le=0,me=0;for(let be=0;be<I.cellsY;++be)for(let Re=0;Re<I.cellsX;++Re){if(!I.cells[be*I.cellsX+Re])continue;const Me=a.tileCoordToPixel(I.min.x+Re/I.xScale,I.min.y+be/I.yScale),je=a.tileCoordToPixel(I.min.x+(Re+1)/I.xScale,I.min.y+(be+1)/I.yScale);for(let Be=Me.y;Be<=Math.min(je.y+1,y-1);++Be)for(let Ge=Me.x;Ge<=Math.min(je.x+1,y-1);++Ge)Pm[Be*y+Ge]===255&&(Pm[Be*y+Ge]=0,le+=a.getElevationAtPixel(Ge,Be),me++)}const we=le/me;U=Math.max(1,P.x-L),Z=Math.max(1,P.y-L),G=Math.min(j.x+L,y-2),ee=Math.min(j.y+L,y-2),v=!0;for(let be=Z;be<=ee;++be)for(let Re=U;Re<=G;++Re)Pm[be*y+Re]===0&&(kA[be*y+Re]=a._dem.set(Re,be,we));for(let be=1;be<L;++be){U=Math.max(1,P.x-be),Z=Math.max(1,P.y-be),G=Math.min(j.x+be,y-2),ee=Math.min(j.y+be,y-2);for(let Re=Z;Re<=ee;++Re)for(let Me=U;Me<=G;++Me){const je=Re*y+Me;if(Pm[je]===255){let Be=0,Ge=0,ut=-1,lt=-1;for(let ct=-1;ct<=1;++ct)for(let xt=-1;xt<=1;++xt){const gt=(Re+ct)*y+Me+xt;if(Pm[gt]>=be)continue;const yt=kA[gt],st=Math.abs(yt);st>Ge&&(Be=yt,Ge=st,ut=xt,lt=ct)}if(Ge>.1){const ct=1-(be+.5*Math.abs(ut*lt))/L;let xt=a._dem.get(Me,Re)+Be*ct;const gt=a._dem.get(Me+ut,Re+lt),yt=a._dem.get(Me-ut,Re-lt,!0);(xt-gt)*(xt-yt)>0&&(xt=(gt+yt)/2),kA[je]=a._dem.set(Me,Re,xt),Pm[je]=be}}}}}v&&(a._demTile.needsDEMTextureUpload=!0,a._dem._timestamp=xa.now())}setFilter(i){this.filter=i?t_(i):null}getNodesInfo(){return this.filter?this.nodesInfo.filter(i=>this.filter.filter(new Vr(this.id.overscaledZ,{worldview:this.worldview}),i.feature,this.id.canonical)):this.nodesInfo}destroy(){const i=this.getNodesInfo();for(const a of i)$1(a.node),rA(a.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(i,a){if(a.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=a.updateTime;const u=a.getReplacementRegionsForTile(i.toUnwrapped());for(const p of this.getNodesInfo()){const g=p.node.footprint;p.hiddenByReplacement=!!g&&!u.find(y=>y.footprint===g)}}getHeightAtTileCoord(i,a){const u=[],p=[0,0,0],g=se([]);for(const y of this.getNodesInfo()){const v=y.node.meshes[0],T=v.transformedAabb;if(i<T.min[0]||a<T.min[1]||i>T.max[0]||a>T.max[1])continue;if(y.node.hidden===!0)return{height:1/0,maxHeight:y.feature.properties.height,hidden:!1,verticalScale:y.evaluatedScale[2]};de(g,y.node.globalMatrix),p[0]=i,p[1]=a,Bi(p,p,g);const N=(p[0]-v.aabb.min[0])/(v.aabb.max[0]-v.aabb.min[0])*Am|0,I=Math.min(63,(p[1]-v.aabb.min[1])/(v.aabb.max[1]-v.aabb.min[1])*Am|0)*Am+Math.min(63,N),P=v.heightmap[I];if(!(P<0&&y.node.footprint))return y.hiddenByReplacement?void 0:{height:P,maxHeight:y.feature.properties.height,hidden:!1,verticalScale:y.evaluatedScale[2]};if(y.node.footprint.grid.query(new wt(i,a),new wt(i,a),u),u.length>0)return{height:void 0,maxHeight:y.feature.properties.height,hidden:y.hiddenByReplacement,verticalScale:y.evaluatedScale[2]}}}}function J_(l,i){return l instanceof nm&&!l.isLightConstant&&i}function Q9(l,i,a,u,p,g,y,v){let T=(61440&i|(61440&i)>>4)>>8,N=(3840&i|(3840&i)>>4)>>4,I=240&i|(240&i)>>4;a[3]>0&&(T=Si(T,255*a[0],a[3]),N=Si(N,255*a[1],a[3]),I=Si(I,255*a[2],a[3]));const P=T<<8|N,j=I<<8|Math.floor(255*u[3]),O=function(be){const Re=Ie(be,0,2);return Math.min(Math.round(.5*Re*255),255)}(u[2])<<8|15*u[0]<<4|15*u[1],L=Ie(p[0],0,1),U=Ie(p[1],0,1),Z=Ie(p[2],0,1),G=Ie(p[3],0,1);let ee,le,me,we;if(L!==U&&y!==g&&U!==L){const be=y-g;le=1/(be*(U-L)),me=-(g+be*L)/(be*(U-L));const Re=Ie(p[4],-1,1);we=Math.pow(10,Re),ee=255*Z<<8|255*G}else ee=65535,le=0,me=1,we=1;if(l.emplaceBack(P,j,O,ee,le,me,we),v){const be=v.length;v.clear();for(let Re=0;Re<be;Re++)v.emplaceBack(P,j,O,ee,le,me,we)}}function J9(l,i,a){const u=l.node;let p=0;const g=a&Ag.HasMeshoptCompression;for(const y of u.meshes){if(u.lights&&u.lightMeshIndex===p||!y.featureData)continue;y.featureArray=new fm,y.featureArray.reserve(y.featureData.length);let v=i;for(const T of y.featureData){const N=g?65535&T:T>>16&65535,I=g?T>>16&65535:65535&T,P=(15&I)<8?15&I:0,j=l.evaluatedRMEA[P],O=l.evaluatedColor[P],L=l.emissionHeightBasedParams[P];let U;if(v&&P===2&&u.lights&&(U=new fm,U.resize(10*u.lights.length)),Q9(y.featureArray,N,O,j,L,y.aabb.min[2],y.aabb.max[2],U),U&&v){v=!1;const Z=u.meshes[u.lightMeshIndex];Z.featureArray=U,Z.featureArray._trim()}}y.featureArray._trim(),p++}}Yt(cw,"Tiled3dModelBucket",{omit:["layers"]}),Yt(wM,"Tiled3dModelFeature");const e$=["id","tile","layer","source","sourceLayer","state"];class jm{constructor(i,a,u,p,g){this.type="Feature",this._vectorTileFeature=i,this._z=a,this._x=u,this._y=p,this.properties=i?i.properties:{},this.id=g}clone(){const i=new jm(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(i.state=Object.assign({},this.state)),this.layer&&(i.layer=Object.assign({},this.layer)),this.source&&(i.source=this.source),this.sourceLayer&&(i.sourceLayer=this.sourceLayer),i}get geometry(){return this._geometry===void 0&&this._vectorTileFeature&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(i){this._geometry=i}toJSON(){const i={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const a of e$)this[a]!==void 0&&(i[a]=this[a]);return i}}class Rm extends zo{constructor(i,a,u,p){super(),this.id=i,this.type="model",this.models=[],this._options=a,this._modelsInfo=new Map}loadGLTFFromURI(i){return Bk(this.map._requestManager.transformRequest(i,Ca.Model).url)}load(){for(const i in this._options.models){const a=this._options.models[i],u=this._modelsInfo.get(i);if(u){u.modelSpec=a;const p=u.model;p&&(p.position=a.position!=null?new Se(a.position[0],a.position[1]):new Se(0,0),p.orientation=a.orientation!=null?a.orientation:[0,0,0],Rm.applyModelSpecification(p,a),p.computeBoundsAndApplyParent(),this.models.push(p))}else this._modelsInfo.set(i,{modelSpec:a,model:null}),this.loadGLTFFromURI(a.uri).then(p=>{if(!p)return;const g=this._modelsInfo.get(i);if(!g)return;const y=sA(p),v=g.modelSpec,T=new Gk(i,v.uri,v.position,v.orientation,y);Rm.applyModelSpecification(T,v),T.computeBoundsAndApplyParent(),this.models.push(T),g.model=T,this.loaded()&&this.fire(new ul("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(p=>{this.fire(new nd(new Error(`Could not load model ${i} from ${a.uri}: ${p.message}`)))})}this.loaded()&&this.fire(new ul("data",{dataType:"source",sourceDataType:"metadata"}))}static applyModelSpecification(i,a){a.nodeOverrides&&Rm.convertNodeOverrides(i,a.nodeOverrides),a.materialOverrides&&Rm.convertMaterialOverrides(i,a.materialOverrides),a.nodeOverrideNames&&(i.nodeOverrideNames=[...a.nodeOverrideNames]),a.materialOverrideNames&&(i.materialOverrideNames=[...a.materialOverrideNames]),a.featureProperties&&(i.featureProperties=a.featureProperties)}static convertNodeOverrides(i,a){if(Array.isArray(a)&&a.every(u=>typeof u=="string")){i.nodeOverrideNames=[];for(const u of a)i.nodeOverrideNames.push(u)}else Object.entries(a).forEach(([u,p])=>{const g={orientation:[0,0,0]};if(p.hasOwnProperty("orientation")){const y=p.orientation;y&&(g.orientation=y)}i.nodeOverrides.set(u,g)})}static convertMaterialOverrides(i,a){if(Array.isArray(a)&&a.every(u=>typeof u=="string")){i.materialOverrideNames=[];for(const u of a)i.materialOverrideNames.push(u)}else Object.entries(a).forEach(([u,p])=>{const g={color:new Ar(1,1,1),colorMix:0,emissionStrength:0,opacity:1},y=p["model-color"];y!==void 0&&(g.color.r=y[0],g.color.g=y[1],g.color.b=y[2]);const v=p["model-color-mix-intensity"];v!==void 0&&(g.colorMix=v);const T=p["model-emissive-strength"];T!==void 0&&(g.emissionStrength=T);const N=p["model-opacity"];N!==void 0&&(g.opacity=N),i.materialOverrides.set(u,g)})}onAdd(i){this.map=i,this.load()}hasTransition(){return!1}loaded(){if(this._modelsInfo.size===0)return!0;for(const i of this._modelsInfo.values())if(i.model==null)return!1;return!0}getModels(){return this.models}loadTile(i,a){}serialize(){return this._options}setProperty(i,a){return!1}reload(){const i=fd(this.id,this.scope);this.map.style.clearSource(i),this.models=[],this._modelsInfo.clear(),this.load()}setModels(i){this.models=[];const a=new Map;for(const u in i){const p=i[u];if(this._modelsInfo.has(u)){const g=this._modelsInfo.get(u);g&&g.modelSpec.uri===p.uri&&a.set(u,g)}}this._modelsInfo=a,this._options.models=i,this.load()}}function DA(l,i,a,u){const p=1<<l.z;i.lat=Nt((u/Bt+l.y)/p),i.lng=ft((a/Bt+l.x)/p)}function t$(l,i,a,u){const p=l.getNodesInfo()[i];if(!p||p.hiddenByReplacement||!p.node.meshes)return;let g=Number.MAX_VALUE;const y=p.node,v=a.tile,T=u.calculatePosMatrix(v.tileID.toUnwrapped(),u.worldSize),N=p.evaluatedScale;let I=0;u.elevation&&y.elevation&&(I=y.elevation*u.elevation.exaggeration()),ge(T,T,[(y.anchor?y.anchor[0]:0)*(N[0]-1),(y.anchor?y.anchor[1]:0)*(N[1]-1),I]),Ae(T,T,N);const P=a.queryGeometry,j=P.isPointQuery()?P.screenBounds:P.screenGeometry,O=function(U){const Z=K([],T,U.globalMatrix);K(Z,u.expandedFarZProjMatrix,Z);for(let G=0;G<U.meshes.length;++G){const ee=U.meshes[G];if(G===U.lightMeshIndex)continue;const le=tA(j,u,Z,ee.aabb);le!=null&&(g=Math.min(le,g))}if(U.children)for(const G of U.children)O(G)};if(O(y),g===Number.MAX_VALUE)return;const L=new Se(0,0);return DA(v.tileID.canonical,L,p.node.anchor[0],p.node.anchor[1]),{intersectionZ:g,position:L,feature:p.feature}}const i$={circle:class extends Ba{constructor(l,i,a,u){super(l,{layout:nR||(nR=new kn({"circle-sort-key":new $t(et.layout_circle["circle-sort-key"]),"circle-elevation-reference":new Dt(et.layout_circle["circle-elevation-reference"]),visibility:new Dt(et.layout_circle.visibility)})),paint:sR||(sR=new kn({"circle-radius":new $t(et.paint_circle["circle-radius"]),"circle-color":new $t(et.paint_circle["circle-color"]),"circle-blur":new $t(et.paint_circle["circle-blur"]),"circle-opacity":new $t(et.paint_circle["circle-opacity"]),"circle-translate":new Dt(et.paint_circle["circle-translate"]),"circle-translate-anchor":new Dt(et.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new Dt(et.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new Dt(et.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new $t(et.paint_circle["circle-stroke-width"]),"circle-stroke-color":new $t(et.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new $t(et.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new Dt(et.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"})}))},i,a,u)}createBucket(l){return new Ua(l)}queryRadius(l){const i=l;return xd("circle-radius",this,i)+xd("circle-stroke-width",this,i)+gg(this.paint.get("circle-translate"))}queryIntersectsFeature(l,i,a,u,p,g,y,v){const T=rR(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),g.angle,l.pixelToTileUnitsFactor),N=this.paint.get("circle-radius").evaluate(i,a)+this.paint.get("circle-stroke-width").evaluate(i,a);return xR(l,u,g,y,v,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",T,N)}getProgramIds(){return["circle"]}getDefaultProgramParams(l,i,a){const u=yR(this);return{config:new D(this,{zoom:i,lut:a}),defines:u,overrideFog:!1}}is3D(l){return!l&&!!this.layout&&this.layout.get("circle-elevation-reference")!=="none"}hasElevation(){return this.layout&&this.layout.get("circle-elevation-reference")!=="none"}},heatmap:class extends Ba{createBucket(l){return new vR(l)}constructor(l,i,a,u){super(l,{layout:bR||(bR=new kn({visibility:new Dt(et.layout_heatmap.visibility)})),paint:wR||(wR=new kn({"heatmap-radius":new $t(et.paint_heatmap["heatmap-radius"]),"heatmap-weight":new $t(et.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new Dt(et.paint_heatmap["heatmap-intensity"]),"heatmap-color":new yh(et.paint_heatmap["heatmap-color"]),"heatmap-opacity":new Dt(et.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"})}))},i,a,u),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(l){l==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=v_({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}_clear(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}queryRadius(l){return xd("heatmap-radius",this,l)}queryIntersectsFeature(l,i,a,u,p,g,y,v){const T=this.paint.get("heatmap-radius").evaluate(i,a);return xR(l,u,g,y,v,!0,!0,new wt(0,0),T)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(l,i,a){return l==="heatmap"?{config:new D(this,{zoom:i,lut:a}),overrideFog:!1}:{}}},hillshade:class extends Ba{constructor(l,i,a,u){super(l,{layout:SR||(SR=new kn({visibility:new Dt(et.layout_hillshade.visibility)})),paint:TR||(TR=new kn({"hillshade-illumination-direction":new Dt(et.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new Dt(et.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new Dt(et.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new Dt(et.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new Dt(et.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new Dt(et.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new Dt(et.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"})}))},i,a,u)}shouldRedrape(){return this.hasOffscreenPass()&&this.paint.get("hillshade-illumination-anchor")==="viewport"}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(l,i,a){return{overrideFog:!1}}},fill:class extends Ba{constructor(l,i,a,u){super(l,{layout:$R||($R=new kn({"fill-sort-key":new $t(et.layout_fill["fill-sort-key"]),visibility:new Dt(et.layout_fill.visibility),"fill-elevation-reference":new Dt(et.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new $t(et.layout_fill["fill-construct-bridge-guard-rail"])})),paint:GR||(GR=new kn({"fill-antialias":new Dt(et.paint_fill["fill-antialias"]),"fill-opacity":new $t(et.paint_fill["fill-opacity"]),"fill-color":new $t(et.paint_fill["fill-color"]),"fill-outline-color":new $t(et.paint_fill["fill-outline-color"]),"fill-translate":new Dt(et.paint_fill["fill-translate"]),"fill-translate-anchor":new Dt(et.paint_fill["fill-translate-anchor"]),"fill-pattern":new $t(et.paint_fill["fill-pattern"]),"fill-pattern-cross-fade":new Dt(et.paint_fill["fill-pattern-cross-fade"]),"fill-emissive-strength":new Dt(et.paint_fill["fill-emissive-strength"]),"fill-z-offset":new $t(et.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new $t(et.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new $t(et.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"})}))},i,a,u)}getProgramIds(){const l=this.paint.get("fill-pattern"),i=l&&l.constantOr(1),a=[i?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&a.push(i&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),a}getDefaultProgramParams(l,i,a){return{config:new D(this,{zoom:i,lut:a}),overrideFog:!1}}recalculate(l,i){super.recalculate(l,i);const a=this.paint._values["fill-outline-color"];a.value.kind==="constant"&&a.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(l){return new FN(l)}queryRadius(){return gg(this.paint.get("fill-translate"))}queryIntersectsFeature(l,i,a,u,p,g){return!l.queryGeometry.isAboveHorizon&&Qr(iR(l.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),g.angle,l.pixelToTileUnitsFactor),u)}isTileClipped(){return this.paint.get("fill-z-offset").constantOr(1)===0}is3D(l){if(this.paint.get("fill-z-offset").constantOr(1)!==0)return!0;const i=this.layout&&this.layout.get("fill-elevation-reference")!=="none";return l!=null?i&&!l:i}hasElevation(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}hasShadowPass(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}},"fill-extrusion":class extends Ba{constructor(l,i,a,u){super(l,{layout:mk||(mk=new kn({visibility:new Dt(et["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new Dt(et["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:fk||(fk=new kn({"fill-extrusion-opacity":new Dt(et["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new $t(et["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new Dt(et["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new Dt(et["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new $t(et["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-pattern-cross-fade":new Dt(et["paint_fill-extrusion"]["fill-extrusion-pattern-cross-fade"]),"fill-extrusion-height":new $t(et["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new $t(et["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new Dt(et["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new Dt(et["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new Dt(et["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new Dt(et["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new Dt(et["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new Dt(et["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new Dt(et["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new Dt(et["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new Dt(et["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new Dt(et["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new $t(et["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new $t(et["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new Dt(et["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new Dt(et["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new Dt(et["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new Dt(et["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new $t(et["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new $t(et["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new Dt(et["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"})}))},i,a,u),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(l){return new D1(l)}queryRadius(){return gg(this.paint.get("fill-extrusion-translate"))}is3D(l){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(l,i,a,u,p,g,y,v,T){const N=rR(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),g.angle,l.pixelToTileUnitsFactor),I=this.paint.get("fill-extrusion-height").evaluate(i,a),P=this.paint.get("fill-extrusion-base").evaluate(i,a),j=[0,0],O=v&&g.elevation,L=g.elevation?g.elevation.exaggeration():1,U=l.tile.getBucket(this);if(O&&U instanceof D1){const me=U.centroidVertexArray,we=T+1;we<me.length&&(j[0]=me.geta_centroid_pos0(we),j[1]=me.geta_centroid_pos1(we))}if(j[0]===0&&j[1]===1)return!1;g.projection.name==="globe"&&(u=pk([u],[new wt(0,0),new wt(Bt,Bt)],l.tileID.canonical).map(me=>me.polygon).flat());const Z=O?v:null,[G,ee]=wk(g,u,P,I,N,y,Z,j,L,g.center.lat,l.tileID.canonical),le=l.queryGeometry;return bk(G,ee,le.isPointQuery()?le.screenBounds:le.screenGeometry)}},building:class extends Ba{constructor(l,i,a,u){super(l,{layout:Qk||(Qk=new kn({visibility:new Dt(et.layout_building.visibility),"building-facade":new $t(et.layout_building["building-facade"]),"building-facade-floors":new $t(et.layout_building["building-facade-floors"]),"building-facade-unit-width":new $t(et.layout_building["building-facade-unit-width"]),"building-facade-window":new $t(et.layout_building["building-facade-window"]),"building-roof-shape":new $t(et.layout_building["building-roof-shape"]),"building-height":new $t(et.layout_building["building-height"]),"building-base":new $t(et.layout_building["building-base"]),"building-flood-light-wall-radius":new $t(et.layout_building["building-flood-light-wall-radius"]),"building-flood-light-ground-radius":new $t(et.layout_building["building-flood-light-ground-radius"]),"building-flip-roof-orientation":new $t(et.layout_building["building-flip-roof-orientation"])})),paint:Jk||(Jk=new kn({"building-opacity":new Dt(et.paint_building["building-opacity"]),"building-ambient-occlusion-intensity":new Dt(et.paint_building["building-ambient-occlusion-intensity"]),"building-ambient-occlusion-ground-intensity":new Dt(et.paint_building["building-ambient-occlusion-ground-intensity"]),"building-ambient-occlusion-ground-radius":new Dt(et.paint_building["building-ambient-occlusion-ground-radius"]),"building-ambient-occlusion-ground-attenuation":new Dt(et.paint_building["building-ambient-occlusion-ground-attenuation"]),"building-vertical-scale":new Dt(et.paint_building["building-vertical-scale"]),"building-cast-shadows":new Dt(et.paint_building["building-cast-shadows"]),"building-color":new $t(et.paint_building["building-color"]),"building-emissive-strength":new $t(et.paint_building["building-emissive-strength"]),"building-facade-emissive-chance":new Dt(et.paint_building["building-facade-emissive-chance"]),"building-cutoff-fade-range":new Dt(et.paint_building["building-cutoff-fade-range"]),"building-flood-light-color":new Dt(et.paint_building["building-flood-light-color"]),"building-flood-light-intensity":new Dt(et.paint_building["building-flood-light-intensity"]),"building-flood-light-ground-attenuation":new Dt(et.paint_building["building-flood-light-ground-attenuation"]),"building-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"}),"building-flood-light-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"})}))},i,a,u),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(l){return new Kk(l)}cutoffRange(){return this.paint.get("building-cutoff-fade-range")}hasShadowPass(){return this.paint.get("building-cast-shadows")}hasLightBeamPass(){return!0}canCastShadows(){return!0}is3D(l){return!0}queryRadius(l){return 0}queryIntersectsFeature(l,i,a,u,p,g,y,v,T,N){let I=this.layout.get("building-height").evaluate(i,a);const P=this.layout.get("building-base").evaluate(i,a),j=l.tile.getBucket(this).getFootprint(i);if(j){if(j.hiddenFlags!==0)return!1;I=j.height}const[O,L]=wk(g,u,P,I,new wt(0,0),y,null,[0,0],1,g.center.lat,l.tileID.canonical),U=l.queryGeometry;return bk(O,L,U.isPointQuery()?U.screenBounds:U.screenGeometry)}},line:class extends Ba{constructor(l,i,a,u){const p=cD();super(l,p,i,a,u),p.layout&&(this.layout=new za(p.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(l){if(l==="line-gradient"){const i=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=i._styleExpression&&i._styleExpression.expression instanceof Kp,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}emissiveStrengthExpression(){return this._transitionablePaint._values["line-emissive-strength"].value.expression}recalculate(l,i){super.recalculate(l,i),this.paint._values["line-floorwidth"]=(()=>{if(z_)return z_;const a=cD();return z_=new Y8(a.paint.properties["line-width"].specification),z_.useIntegerZoom=!0,z_})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,l)}createBucket(l){return new lA(l)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(l,i,a){const u=oD(this);return{config:new D(this,{zoom:i,lut:a}),defines:u,overrideFog:!1}}queryRadius(l){const i=l,a=uD(xd("line-width",this,i),xd("line-gap-width",this,i)),u=xd("line-offset",this,i);return a/2+Math.abs(u)+gg(this.paint.get("line-translate"))}queryIntersectsFeature(l,i,a,u,p,g){if(l.queryGeometry.isAboveHorizon)return!1;const y=iR(l.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),g.angle,l.pixelToTileUnitsFactor),v=l.pixelToTileUnitsFactor/2*uD(this.paint.get("line-width").evaluate(i,a),this.paint.get("line-gap-width").evaluate(i,a)),T=this.paint.get("line-offset").evaluate(i,a);return T&&(u=function(N,I){const P=[],j=new wt(0,0);for(let O=0;O<N.length;O++){const L=N[O],U=[];for(let Z=0;Z<L.length;Z++){const G=L[Z],ee=L[Z+1],le=Z===0?j:G.sub(L[Z-1])._unit()._perp(),me=Z===L.length-1?j:ee.sub(G)._unit()._perp(),we=le._add(me)._unit();we._mult(1/(we.x*me.x+we.y*me.y)),U.push(we._mult(I)._add(G))}P.push(U)}return P}(u,T*l.pixelToTileUnitsFactor)),function(N,I,P){for(let j=0;j<I.length;j++){const O=I[j];if(N.length>=3){for(let L=0;L<O.length;L++)if(wo(N,O[L]))return!0}if(ts(N,O,P))return!0}return!1}(y,u,v)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(l){return!this.hasElevatedBuckets||this.layout&&this.layout.get("line-elevation-reference")==="hd-road-markup"}hasElevation(){return this.layout&&this.layout.get("line-elevation-reference")!=="none"}},symbol:sw,background:class extends Ba{constructor(l,i,a,u){super(l,{layout:tM||(tM=new kn({visibility:new Dt(et.layout_background.visibility)})),paint:iM||(iM=new kn({"background-pitch-alignment":new Dt(et.paint_background["background-pitch-alignment"]),"background-color":new Dt(et.paint_background["background-color"]),"background-pattern":new Dt(et.paint_background["background-pattern"]),"background-opacity":new Dt(et.paint_background["background-opacity"]),"background-emissive-strength":new Dt(et.paint_background["background-emissive-strength"]),"background-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"})}))},i,a,u)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(l,i,a){return{overrideFog:!1}}is3D(l){return this.paint.get("background-pitch-alignment")==="viewport"}},raster:oM,"raster-particle":pM,sky:class extends Ba{constructor(l,i,a,u){super(l,{layout:uM||(uM=new kn({visibility:new Dt(et.layout_sky.visibility)})),paint:dM||(dM=new kn({"sky-type":new Dt(et.paint_sky["sky-type"]),"sky-atmosphere-sun":new Dt(et.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new Dt(et.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new Dt(et.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new Dt(et.paint_sky["sky-gradient-radius"]),"sky-gradient":new yh(et.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new Dt(et.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new Dt(et.paint_sky["sky-atmosphere-color"]),"sky-opacity":new Dt(et.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"})}))},i,a,u),this._updateColorRamp()}_clear(){this.skyboxFbo&&(this.skyboxFbo.destroy(),this.skyboxFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this._skyboxInvalidated=!0}_handleSpecialPaintPropertyUpdate(l){l==="sky-gradient"?this._updateColorRamp():l!=="sky-atmosphere-sun"&&l!=="sky-atmosphere-halo-color"&&l!=="sky-atmosphere-color"&&l!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=v_({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(l){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const i=l.style.light.properties.get("position");return this._lightPosition.azimuthal!==i.azimuthal||this._lightPosition.polar!==i.polar}return!1}getCenter(l,i){if(this.paint.get("sky-type")==="atmosphere"){const u=this.paint.get("sky-atmosphere-sun"),p=!u,g=l.style.light,y=g.properties.get("position");return p&&g.properties.get("anchor")==="viewport"&&Ni("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),p?PA(y.azimuthal,90-y.polar,i):PA(u[0],90-u[1],i)}const a=this.paint.get("sky-gradient-center");return PA(a[0],90-a[1],i)}isSky(){return!0}markSkyboxValid(l){this._skyboxInvalidated=!1,this._lightPosition=l.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const l=this.paint.get("sky-type");return l==="atmosphere"?["skyboxCapture","skybox"]:l==="gradient"?["skyboxGradient"]:null}},slot:class extends Ba{constructor(l,i,a,u){super(l,{paint:hM||(hM=new kn({}))},i,null)}},model:class extends Ba{constructor(l,i,a,u){super(l,{layout:yM||(yM=new kn({visibility:new Dt(et.layout_model.visibility),"model-id":new $t(et.layout_model["model-id"]),"model-allow-density-reduction":new Dt(et.layout_model["model-allow-density-reduction"])})),paint:xM||(xM=new kn({"model-opacity":new $t(et.paint_model["model-opacity"]),"model-rotation":new $t(et.paint_model["model-rotation"]),"model-scale":new $t(et.paint_model["model-scale"]),"model-translation":new $t(et.paint_model["model-translation"]),"model-color":new $t(et.paint_model["model-color"]),"model-color-mix-intensity":new $t(et.paint_model["model-color-mix-intensity"]),"model-type":new Dt(et.paint_model["model-type"]),"model-cast-shadows":new Dt(et.paint_model["model-cast-shadows"]),"model-receive-shadows":new Dt(et.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new Dt(et.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new $t(et.paint_model["model-emissive-strength"]),"model-roughness":new $t(et.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new $t(et.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new Dt(et.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new Dt(et.paint_model["model-front-cutoff"]),"model-elevation-reference":new Dt(et.paint_model["model-elevation-reference"]),"model-color-use-theme":new $t({type:"string",default:"default","property-type":"data-driven"})}))},i,a,u),this.layer=l,this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(l){return new RA(l)}getProgramIds(){return["model"]}is3D(l){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(l){return l instanceof cw?8191:0}queryRenderedFeatures(l,i,a){const u=i.getSource();if(!(u&&u instanceof Rm))return{};const p=u,g={};g[this.id]=[];const y=g[this.id];let v=0;for(const T of p.models){const N=i.getFeatureState(this.sourceLayer,T.id),I={type:"Unknown",id:T.id,properties:T.featureProperties},P=this.paint.get("model-rotation").evaluate(I,N),j=this.paint.get("model-scale").evaluate(I,N),O=this.paint.get("model-translation").evaluate(I,N),L=this.paint.get("model-elevation-reference");let U=[];q1(U,T,a,T.position,P,j,O,L==="ground",L==="ground",!1),a.projection.name==="globe"&&(U=U1(U,a));const Z=K([],a.projMatrix,U),G=tA(l.isPointQuery()?l.screenBounds:l.screenGeometry,a,Z,T.aabb);if(G!=null){const ee=new jm(void 0,0,0,0,T.id);ee.layer=this.layer,ee.properties=structuredClone(T.featureProperties),ee.properties.layer=this.id,ee.properties.uri=T.uri,ee.properties.orientation=T.orientation,ee.sourceLayer=this.sourceLayer,ee.geometry={type:"Point",coordinates:[T.position.lng,T.position.lat]},ee.state=N,ee.source=this.source,y.push({featureIndex:v,feature:ee,intersectionZ:G})}++v}return g}queryIntersectsFeature(l,i,a,u,p,g,y,v,T,N){if(!this.modelManager)return!1;const I=this.modelManager,P=l.tile.getBucket(this);if(!(P&&P instanceof RA))return!1;for(const j in P.instancesPerModel){const O=P.instancesPerModel[j],L=i.id!==void 0?i.id:i.properties&&i.properties.hasOwnProperty("id")?i.properties.id:void 0;if(O.idToFeaturesIndex.hasOwnProperty(L)){const U=O.features[O.idToFeaturesIndex[L]],Z=I.getModel(j,N||this.scope);if(!Z)return!1;let G=[];const ee=new Se(0,0),le=P.canonical;let me=Number.MAX_VALUE;for(let we=0;we<U.instancedDataCount;++we){const be=16*(U.instancedDataOffset+we),Re=O.instancedDataArray.float32,Me=[Re[be+4],Re[be+5],Re[be+6]];DA(le,ee,Math.floor(Re[be]),Math.floor(Re[be+1])),q1(G,Z,g,ee,U.rotation,U.scale,Me,!1,!1,!1),g.projection.name==="globe"&&(G=U1(G,g));const je=K([],g.projMatrix,G),Be=l.queryGeometry,Ge=tA(Be.isPointQuery()?Be.screenBounds:Be.screenGeometry,g,je,Z.aabb);Ge!=null&&(me=Math.min(Ge,me))}return me!==Number.MAX_VALUE&&me}}return!1}_handleOverridablePaintPropertyUpdate(l,i,a){return!(!this.layout||i.isDataDriven()||a.isDataDriven()||l!=="model-color"&&l!=="model-color-mix-intensity"&&l!=="model-rotation"&&l!=="model-scale"&&l!=="model-translation"&&l!=="model-emissive-strength")}_isPropertyZoomDependent(l){const i=this._transitionablePaint._values[l];return i!=null&&i.value!=null&&i.value.expression!=null&&i.value.expression instanceof hd}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends Ba{constructor(l,i,a,u){super(l,{layout:HR||(HR=new kn({"clip-layer-types":new Dt(et.layout_clip["clip-layer-types"]),"clip-layer-scope":new Dt(et.layout_clip["clip-layer-scope"])})),paint:WR||(WR=new kn({}))},i,a,u)}recalculate(l,i){super.recalculate(l,i)}createBucket(l){return new ZR(l)}is3D(l){return!0}}},MA=new Ar(0,0,0);function r$(l,i,a){l===1&&i.icons.push(function(u,p){return function(g){if(g.usvg_tree.height||(g.usvg_tree.height=g.usvg_tree.width),!g.metadata)return g;const{metadata:y}=g;if(y.content_area){const{content_area:v}=y;v.left==null&&(v.left=0),v.top==null&&(v.top=v.left),v.width==null&&(v.width=g.usvg_tree.width),v.height==null&&(v.height=v.width)}if(y.text_placeholder){const{text_placeholder:v}=y;v.top==null&&(v.top=v.left),v.height==null&&(v.height=v.width)}return y.stretch_x&&y.stretch_x.length&&SM(y,"x"),y.stretch_y&&y.stretch_y.length&&SM(y,"y"),g}(u.readFields(n$,{name:void 0},p))}(a,a.readVarint()+a.pos))}function SM(l,i){const a=[],u=l[`stretch_${i}`];let p=null;for(let g=0;g<u.length;g++)p===null?p=a.length===0?u[0]:a[a.length-1][1]+u[g]:(a.push([p,p+u[g]]),p=null);l[`stretch_${i}_areas`]=a}function n$(l,i,a){l===1?i.name=a.readString():l===2?i.metadata=function(u,p){return u.readFields(s$,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},p)}(a,a.readVarint()+a.pos):l===3&&(i.usvg_tree=function(u,p){return u.readFields(l$,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},p)}(a,a.readVarint()+a.pos),i.data="usvg_tree")}function s$(l,i,a){l===1?i.stretch_x=a.readPackedVarint():l===2?i.stretch_y=a.readPackedVarint():l===3?i.content_area=TM(a,a.readVarint()+a.pos):l===4?i.variables.push(function(u,p){return u.readFields(o$,{name:void 0},p)}(a,a.readVarint()+a.pos)):l===5&&(i.text_placeholder=TM(a,a.readVarint()+a.pos))}function TM(l,i){return l.readFields(a$,{},i)}function a$(l,i,a){l===1?i.left=a.readVarint():l===2?i.width=a.readVarint():l===3?i.top=a.readVarint():l===4&&(i.height=a.readVarint())}function o$(l,i,a){l===1?i.name=a.readString():l===2&&(i.rgb_color=hw(a.readVarint()),i.value="rgb_color")}function l$(l,i,a){l===1?i.width=i.height=a.readVarint():l===2?i.height=a.readVarint():l===3?i.children.push(uw(a,a.readVarint()+a.pos)):l===4?i.linear_gradients.push(function(u,p){return u.readFields(f$,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},p)}(a,a.readVarint()+a.pos)):l===5?i.radial_gradients.push(function(u,p){return u.readFields(y$,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},p)}(a,a.readVarint()+a.pos)):l===7?i.clip_paths.push(function(u,p){return u.readFields(x$,{children:[]},p)}(a,a.readVarint()+a.pos)):l===8&&i.masks.push(function(u,p){const g=u.readFields(_$,{left:0,width:20,mask_type:1,children:[]},p);return g.height==null&&(g.height=g.width),g.top==null&&(g.top=g.left),g}(a,a.readVarint()+a.pos))}function uw(l,i){return l.readFields(c$,{},i)}function c$(l,i,a){l===1?(i.group=function(u,p){return u.readFields(u$,{opacity:255,children:[]},p)}(a,a.readVarint()+a.pos),i.node="group"):l===2&&(i.path=function(u,p){return u.readFields(h$,{paint_order:1,commands:[],step:1,diffs:[],rule:1},p)}(a,a.readVarint()+a.pos),i.node="path")}function u$(l,i,a){l===1?i.transform=dw(a,a.readVarint()+a.pos):l===2?i.opacity=a.readVarint():l===5?i.clip_path_idx=a.readVarint():l===6?i.mask_idx=a.readVarint():l===7&&i.children.push(uw(a,a.readVarint()+a.pos))}function dw(l,i){return l.readFields(d$,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},i)}function d$(l,i,a){l===1?i.sx=a.readFloat():l===2?i.ky=a.readFloat():l===3?i.kx=a.readFloat():l===4?i.sy=a.readFloat():l===5?i.tx=a.readFloat():l===6&&(i.ty=a.readFloat())}function h$(l,i,a){l===1?i.fill=function(u,p){return u.readFields(p$,{rgb_color:MA,paint:"rgb_color",opacity:255},p)}(a,a.readVarint()+a.pos):l===2?i.stroke=function(u,p){return u.readFields(m$,{rgb_color:MA,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},p)}(a,a.readVarint()+a.pos):l===3?i.paint_order=a.readVarint():l===5?a.readPackedVarint(i.commands):l===6?i.step=a.readFloat():l===7?a.readPackedSVarint(i.diffs):l===8&&(i.rule=a.readVarint())}function p$(l,i,a){l===1?(i.rgb_color=hw(a.readVarint()),i.paint="rgb_color"):l===2?(i.linear_gradient_idx=a.readVarint(),i.paint="linear_gradient_idx"):l===3?(i.radial_gradient_idx=a.readVarint(),i.paint="radial_gradient_idx"):l===5&&(i.opacity=a.readVarint())}function hw(l){return new Ar((l>>16&255)/255,(l>>8&255)/255,(255&l)/255,1)}function m$(l,i,a){l===1?(i.rgb_color=hw(a.readVarint()),i.paint="rgb_color"):l===2?(i.linear_gradient_idx=a.readVarint(),i.paint="linear_gradient_idx"):l===3?(i.radial_gradient_idx=a.readVarint(),i.paint="radial_gradient_idx"):l===5?a.readPackedFloat(i.dasharray):l===6?i.dashoffset=a.readFloat():l===7?i.miterlimit=a.readFloat():l===8?i.opacity=a.readVarint():l===9?i.width=a.readFloat():l===10?i.linecap=a.readVarint():l===11&&(i.linejoin=a.readVarint())}function f$(l,i,a){l===1?i.transform=dw(a,a.readVarint()+a.pos):l===2?i.spread_method=a.readVarint():l===3?i.stops.push(NM(a,a.readVarint()+a.pos)):l===4?i.x1=a.readFloat():l===5?i.y1=a.readFloat():l===6?i.x2=a.readFloat():l===7&&(i.y2=a.readFloat())}function NM(l,i){return l.readFields(g$,{offset:0,opacity:255,rgb_color:MA},i)}function g$(l,i,a){l===1?i.offset=a.readFloat():l===2?i.opacity=a.readVarint():l===3&&(i.rgb_color=hw(a.readVarint()))}function y$(l,i,a){l===1?i.transform=dw(a,a.readVarint()+a.pos):l===2?i.spread_method=a.readVarint():l===3?i.stops.push(NM(a,a.readVarint()+a.pos)):l===4?i.cx=a.readFloat():l===5?i.cy=a.readFloat():l===6?i.r=a.readFloat():l===7?i.fx=a.readFloat():l===8?i.fy=a.readFloat():l===9&&(i.fr=a.readFloat())}function x$(l,i,a){l===1?i.transform=dw(a,a.readVarint()+a.pos):l===2?i.clip_path_idx=a.readVarint():l===3&&i.children.push(uw(a,a.readVarint()+a.pos))}function _$(l,i,a){l===1?i.left=i.top=a.readFloat():l===2?i.width=i.height=a.readFloat():l===3?i.top=a.readFloat():l===4?i.height=a.readFloat():l===5?i.mask_type=a.readVarint():l===6?i.mask_idx=a.readVarint():l===7&&i.children.push(uw(a,a.readVarint()+a.pos))}class v${static calculate(i={},a=[]){const u=new Map,p=new Map;if(Object.keys(i).length===0)return u;a.forEach(g=>{p.set(g.name,g.rgb_color||new Ar(0,0,0))});for(const[g,y]of Object.entries(i))p.has(g)?u.set(p.get(g).toString(),y):console.warn(`Ignoring unknown image variable "${g}"`);return u}}function Mg(l,i=255,a){const u=i/255,p=l.toString(),g=a.has(p)?a.get(p).clone():l.clone();return g.a*=u,g.toString()}function e0(l,i){if(!xn()){const a=document.createElement("canvas");return a.width=l,a.height=i,a}return new OffscreenCanvas(l,i)}let OA,t0=null;function LA(l,i,a,u,p){for(const g of u.children)AM(l,i,a,g,p)}function AM(l,i,a,u,p){u.group?(l.save(),function(g,y,v,T,N){const I=T.mask_idx!=null?v.masks[T.mask_idx]:null,P=T.clip_path_idx!=null?v.clip_paths[T.clip_path_idx]:null;if(T.transform&&(y=Og(T.transform).preMultiplySelf(y)),!function(L,U,Z){return L.opacity!==255||U||Z}(T,P!=null,I!=null))return void LA(g,y,v,T,N);const j=e0(g.canvas.width,g.canvas.height),O=j.getContext("2d");LA(O,y,v,T,N),P&&kM(O,y,v,P),I&&DM(O,y,v,I,N),g.globalAlpha=T.opacity/255,g.drawImage(j,0,0)}(l,i,a,u.group,p),l.restore()):u.path&&(l.save(),function(g,y,v,T,N){g.setTransform(y),T.paint_order===1?(CM(g,v,T,N),IM(g,v,T,N)):(IM(g,v,T,N),CM(g,v,T,N))}(l,i,a,u.path,p),l.restore())}function CM(l,i,a,u){const p=a.fill;if(!p)return;const g=p.opacity/255;switch(l.save(),l.beginPath(),MM(a,l),p.paint){case"rgb_color":l.fillStyle=Mg(p.rgb_color,p.opacity,u);break;case"linear_gradient_idx":{const y=i.linear_gradients[p.linear_gradient_idx];y.transform&&l.setTransform(Og(y.transform).preMultiplySelf(l.getTransform())),l.fillStyle=PM(l,y,g,u);break}case"radial_gradient_idx":{const y=i.radial_gradients[p.radial_gradient_idx];y.transform&&l.setTransform(Og(y.transform).preMultiplySelf(l.getTransform())),l.fillStyle=jM(l,y,g,u)}}l.fill(EM(a)),l.restore()}function EM(l){return l.rule===1?"nonzero":l.rule===2?"evenodd":void 0}function IM(l,i,a,u){const p=a.stroke;if(!p)return;const g=OM(a);l.lineWidth=p.width,l.miterLimit=p.miterlimit,l.setLineDash(p.dasharray),l.lineDashOffset=p.dashoffset;const y=p.opacity/255;switch(p.paint){case"rgb_color":l.strokeStyle=Mg(p.rgb_color,p.opacity,u);break;case"linear_gradient_idx":l.strokeStyle=PM(l,i.linear_gradients[p.linear_gradient_idx],y,u,!0);break;case"radial_gradient_idx":l.strokeStyle=jM(l,i.radial_gradients[p.radial_gradient_idx],y,u,!0)}switch(p.linejoin){case 2:case 1:l.lineJoin="miter";break;case 3:l.lineJoin="round";break;case 4:l.lineJoin="bevel"}switch(p.linecap){case 1:l.lineCap="butt";break;case 2:l.lineCap="round";break;case 3:l.lineCap="square"}l.stroke(g)}function PM(l,i,a,u,p=!1){if(i.stops.length===1){const j=i.stops[0];return Mg(j.rgb_color,j.opacity*a,u)}const{x1:g,y1:y,x2:v,y2:T}=i;let N=new DOMPoint(g,y),I=new DOMPoint(v,T);if(p){const j=Og(i.transform);N=j.transformPoint(N),I=j.transformPoint(I)}const P=l.createLinearGradient(N.x,N.y,I.x,I.y);for(const j of i.stops)P.addColorStop(j.offset,Mg(j.rgb_color,j.opacity*a,u));return P}function jM(l,i,a,u,p=!1){if(i.stops.length===1){const G=i.stops[0];return Mg(G.rgb_color,G.opacity*a,u)}const g=Og(i.transform),{fx:y,fy:v,fr:T,cx:N,cy:I,r:P}=i;let j=new DOMPoint(y,v),O=new DOMPoint(N,I),L=T,U=P;if(p){j=g.transformPoint(j),O=g.transformPoint(O);const G=(g.a+g.d)/2;L=T*G,U=i.r*G}const Z=l.createRadialGradient(j.x,j.y,L,O.x,O.y,U);for(const G of i.stops)Z.addColorStop(G.offset,Mg(G.rgb_color,G.opacity*a,u));return Z}function RM(l,i,a,u){const p=u.transform?Og(u.transform).preMultiplySelf(i):i,g=e0(l.canvas.width,l.canvas.height),y=g.getContext("2d");for(const T of u.children)if(T.group)RM(y,p,a,T.group);else if(T.path){const N=T.path,I=new Path2D;I.addPath(OM(N),p),y.fill(I,EM(N))}const v=u.clip_path_idx!=null?a.clip_paths[u.clip_path_idx]:null;v&&kM(y,p,a,v),l.globalCompositeOperation="source-over",l.drawImage(g,0,0)}function kM(l,i,a,u){const p=e0(l.canvas.width,l.canvas.height);RM(p.getContext("2d"),i,a,u),l.globalCompositeOperation="destination-in",l.drawImage(p,0,0)}function DM(l,i,a,u,p){if(u.children.length===0)return;const g=u.mask_idx!=null?a.masks[u.mask_idx]:null;g&&DM(l,i,a,g,p);const y=l.canvas.width,v=l.canvas.height,T=e0(y,v),N=T.getContext("2d"),I=u.width,P=u.height,j=u.left,O=u.top,L=new Path2D,U=new Path2D;U.rect(j,O,I,P),L.addPath(U,i),N.clip(L);for(const ee of u.children)AM(N,i,a,ee,p);const Z=N.getImageData(0,0,y,v),G=Z.data;if(u.mask_type===1)for(let ee=0;ee<G.length;ee+=4)G[ee+3]=G[ee+3]/255*(.2126*G[ee]+.7152*G[ee+1]+.0722*G[ee+2]);N.putImageData(Z,0,0),l.globalCompositeOperation="destination-in",l.drawImage(T,0,0)}function Og(l){return l?new DOMMatrix([l.sx,l.ky,l.kx,l.sy,l.tx,l.ty]):new DOMMatrix}function MM(l,i){const a=l.step;let u=l.diffs[0]*a,p=l.diffs[1]*a;i.moveTo(u,p);for(let g=0,y=2;g<l.commands.length;g++)switch(l.commands[g]){case 1:u+=l.diffs[y++]*a,p+=l.diffs[y++]*a,i.moveTo(u,p);break;case 2:u+=l.diffs[y++]*a,p+=l.diffs[y++]*a,i.lineTo(u,p);break;case 3:{const v=u+l.diffs[y++]*a,T=p+l.diffs[y++]*a;u=v+l.diffs[y++]*a,p=T+l.diffs[y++]*a,i.quadraticCurveTo(v,T,u,p);break}case 4:{const v=u+l.diffs[y++]*a,T=p+l.diffs[y++]*a,N=v+l.diffs[y++]*a,I=T+l.diffs[y++]*a;u=N+l.diffs[y++]*a,p=I+l.diffs[y++]*a,i.bezierCurveTo(v,T,N,I,u,p);break}case 5:i.closePath();break}return i}function OM(l){return MM(l,new Path2D)}class pw{constructor(i){this.capacity=i,this.cache=new Map}get(i){if(!this.cache.has(i))return;const a=this.cache.get(i);return this.cache.delete(i),this.cache.set(i,a),a}put(i,a){this.cache.has(i)?this.cache.delete(i):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(i,a)}delete(i){this.cache.delete(i)}}Yt(pw,"LRUCache");class FA{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(i){return new wa(i,i.data)}getFromCache(i,a,u){return this.cacheMap.has(u)||this.cacheMap.set(u,new pw(150)),this.cacheMap.get(u).get(fd(i.toString(),a))}setInCache(i,a,u,p){this.cacheDependenciesMap.has(p)||this.cacheDependenciesMap.set(p,new Map),this.cacheMap.has(p)||this.cacheMap.set(p,new pw(150));const g=this.cacheDependenciesMap.get(p),y=fd(i.id.toString(),u);g.get(y)||g.set(y,new Set);const v=this.cacheMap.get(p),T=i.toString();g.get(y).add(T),v.put(fd(i.toString(),u),a)}removeImagesFromCacheByIds(i,a,u=0){if(!this.cacheMap.has(u)||!this.cacheDependenciesMap.has(u))return;const p=this.cacheMap.get(u),g=this.cacheDependenciesMap.get(u);for(const y of i){const v=fd(y.toString(),a);if(g.has(v)){for(const T of g.get(v))p.delete(T);g.delete(v)}}}rasterize(i,a,u,p){const g=this.getFromCache(i,u,p);if(g)return g.clone();const y=function(T,N){const I=v$.calculate(N.params,T.metadata?T.metadata.variables:[]),P=T.usvg_tree,j=P.width,O=P.height,L=Math.max(1,Math.round(j*N.sx)),U=Math.max(1,Math.round(O*N.sy)),Z=new DOMMatrix([L/j,0,0,U/O,0,0]);return t0===null&&(t0=e0(10,10),OA=t0.getContext("2d",{willReadFrequently:!0})),t0.width=L,t0.height=U,LA(OA,Z,P,P,I),OA.getImageData(0,0,L,U)}(a.icon,i),v=FA._getImage(y);return this.setInCache(i,v,u,p),v.clone()}}class LM{constructor(i){this.size=i,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(i,a){const u=this.toIdx(i,a);return{min:this.minimums[u],max:this.maximums[u]}}isLeaf(i,a){return this.leaves[this.toIdx(i,a)]}toIdx(i,a){return a*this.size+i}}function FM(l,i,a,u){let p=0,g=Number.MAX_VALUE;for(let y=0;y<3;y++)if(Math.abs(u[y])<1e-15){if(a[y]<l[y]||a[y]>i[y])return null}else{const v=1/u[y];let T=(l[y]-a[y])*v,N=(i[y]-a[y])*v;if(T>N){const I=T;T=N,N=I}if(T>p&&(p=T),N<g&&(g=N),p>g)return null}return p}function zM(l,i,a,u,p,g,y,v,T,N,I){const P=u-l,j=p-i,O=g-a,L=y-l,U=v-i,Z=T-a,G=I[1]*Z-I[2]*U,ee=I[2]*L-I[0]*Z,le=I[0]*U-I[1]*L,me=P*G+j*ee+O*le;if(Math.abs(me)<1e-15)return null;const we=1/me,be=N[0]-l,Re=N[1]-i,Me=N[2]-a,je=(be*G+Re*ee+Me*le)*we;if(je<0||je>1)return null;const Be=Re*O-Me*j,Ge=Me*P-be*O,ut=be*j-Re*P,lt=(I[0]*Be+I[1]*Ge+I[2]*ut)*we;return lt<0||je+lt>1?null:(L*Be+U*Ge+Z*ut)*we}function BM(l,i,a){return(l-i)/(a-i)}function VM(l,i,a,u,p,g,y,v,T){const N=1<<a,I=g-u,P=y-p,j=(l+1)/N*I+u,O=(i+0)/N*P+p,L=(i+1)/N*P+p;v[0]=(l+0)/N*I+u,v[1]=O,T[0]=j,T[1]=L}class UM{constructor(i){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=i,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const a=function(g){const y=Math.ceil(Math.log2(g.dim/8)),v=[];let T=Math.ceil(Math.pow(2,y));const N=1/T,I=(O,L,U,Z,G)=>{const ee=Z?1:0,le=(O+1)*U-ee,me=L*U,we=(L+1)*U-ee;G[0]=O*U,G[1]=me,G[2]=le,G[3]=we};let P=new LM(T);const j=[];for(let O=0;O<T*T;O++){I(O%T,Math.floor(O/T),N,!1,j);const L=kh(j[0],j[1],g),U=kh(j[2],j[1],g),Z=kh(j[2],j[3],g),G=kh(j[0],j[3],g);P.minimums.push(Math.min(L,U,Z,G)),P.maximums.push(Math.max(L,U,Z,G)),P.leaves.push(1)}for(v.push(P),T/=2;T>=1;T/=2){const O=v[v.length-1];P=new LM(T);for(let L=0;L<T*T;L++){I(L%T,Math.floor(L/T),2,!0,j);const U=O.getElevation(j[0],j[1]),Z=O.getElevation(j[2],j[1]),G=O.getElevation(j[2],j[3]),ee=O.getElevation(j[0],j[3]),le=O.isLeaf(j[0],j[1]),me=O.isLeaf(j[2],j[1]),we=O.isLeaf(j[2],j[3]),be=O.isLeaf(j[0],j[3]),Re=Math.min(U.min,Z.min,G.min,ee.min),Me=Math.max(U.max,Z.max,G.max,ee.max),je=le&&me&&we&&be;P.maximums.push(Me),P.minimums.push(Re),P.leaves.push(Me-Re<=5&&je?1:0)}v.push(P)}return v}(this.dem),u=a.length-1,p=a[u];this._addNode(p.minimums[0],p.maximums[0],p.leaves[0]),this._construct(a,0,0,u,0)}raycastRoot(i,a,u,p,g,y,v=1){return FM([i,a,-100],[u,p,this.maximums[0]*v],g,y)}raycast(i,a,u,p,g,y,v=1){if(!this.nodeCount)return null;const T=this.raycastRoot(i,a,u,p,g,y,v);if(T==null)return null;const N=[],I=[],P=[],j=[],O=[{idx:0,t:T,nodex:0,nodey:0,depth:0}];for(;O.length>0;){const{idx:L,t:U,nodex:Z,nodey:G,depth:ee}=O.pop();if(this.leaves[L]){VM(Z,G,ee,i,a,u,p,P,j);const me=1<<ee,we=(Z+0)/me,be=(Z+1)/me,Re=(G+0)/me,Me=(G+1)/me,je=kh(we,Re,this.dem)*v,Be=kh(be,Re,this.dem)*v,Ge=kh(be,Me,this.dem)*v,ut=kh(we,Me,this.dem)*v,lt=zM(P[0],P[1],je,j[0],P[1],Be,j[0],j[1],Ge,g,y),ct=zM(j[0],j[1],Ge,P[0],j[1],ut,P[0],P[1],je,g,y),xt=Math.min(lt!==null?lt:Number.MAX_VALUE,ct!==null?ct:Number.MAX_VALUE);if(xt!==Number.MAX_VALUE)return xt;{const gt=Et([],g,y,U);if(qM(je,Be,ut,Ge,BM(gt[0],P[0],j[0]),BM(gt[1],P[1],j[1]))>=gt[2])return U}continue}let le=0;for(let me=0;me<this._siblingOffset.length;me++){VM((Z<<1)+this._siblingOffset[me][0],(G<<1)+this._siblingOffset[me][1],ee+1,i,a,u,p,P,j),P[2]=-100,j[2]=this.maximums[this.childOffsets[L]+me]*v;const we=FM(P,j,g,y);if(we!=null){const be=we;N[me]=be;let Re=!1;for(let Me=0;Me<le&&!Re;Me++)be>=N[I[Me]]&&(I.splice(Me,0,me),Re=!0);Re||(I[le]=me),le++}}for(let me=0;me<le;me++){const we=I[me];O.push({idx:this.childOffsets[L]+we,t:N[we],nodex:(Z<<1)+this._siblingOffset[we][0],nodey:(G<<1)+this._siblingOffset[we][1],depth:ee+1})}}return null}_addNode(i,a,u){return this.minimums.push(i),this.maximums.push(a),this.leaves.push(u),this.childOffsets.push(0),this.nodeCount++}_construct(i,a,u,p,g){if(i[p].isLeaf(a,u)===1)return;this.childOffsets[g]||(this.childOffsets[g]=this.nodeCount);const y=p-1,v=i[y];let T=0,N=0;for(let I=0;I<this._siblingOffset.length;I++){const P=2*a+this._siblingOffset[I][0],j=2*u+this._siblingOffset[I][1],O=v.getElevation(P,j),L=v.isLeaf(P,j),U=this._addNode(O.min,O.max,L);L&&(T|=1<<I),N||(N=U)}for(let I=0;I<this._siblingOffset.length;I++)T&1<<I||this._construct(i,2*a+this._siblingOffset[I][0],2*u+this._siblingOffset[I][1],y,N+I)}}function qM(l,i,a,u,p,g){return Si(Si(l,a,g),Si(i,u,g),p)}function kh(l,i,a){const u=a.dim,p=Ie(l*u-.5,0,u-1),g=Ie(i*u-.5,0,u-1),y=Math.floor(p),v=Math.floor(g),T=Math.min(y+1,u-1),N=Math.min(v+1,u-1);return qM(a.get(y,v),a.get(T,v),a.get(y,N),a.get(T,N),p-y,g-v)}const b$={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function w$(l,i,a){return(256*l*256+256*i+a)/10-1e4}function S$(l,i,a){return 256*l+i+a/256-32768}class mw{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(i,a,u,p=!1){if(this.uid=i,a.height!==a.width)throw new RangeError("DEM tiles must be square");if(u&&u!=="mapbox"&&u!=="terrarium")return void Ni(`"${u}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=a.height;const g=this.dim=a.height-2,y=new Uint32Array(a.data.buffer);if(this.pixels=new Uint8Array(a.data.buffer),this.floatView=new Float32Array(a.data.buffer),this.borderReady=p,this._modifiedForSources={},!p){for(let T=0;T<g;T++)y[this._idx(-1,T)]=y[this._idx(0,T)],y[this._idx(g,T)]=y[this._idx(g-1,T)],y[this._idx(T,-1)]=y[this._idx(T,0)],y[this._idx(T,g)]=y[this._idx(T,g-1)];y[this._idx(-1,-1)]=y[this._idx(0,0)],y[this._idx(g,-1)]=y[this._idx(g-1,0)],y[this._idx(-1,g)]=y[this._idx(0,g-1)],y[this._idx(g,g)]=y[this._idx(g-1,g-1)]}const v=u==="terrarium"?S$:w$;for(let T=0;T<y.length;++T){const N=4*T;this.floatView[T]=v(this.pixels[N],this.pixels[N+1],this.pixels[N+2])}this._timestamp=xa.now()}_buildQuadTree(){this._tree=new UM(this)}get(i,a,u=!1){u&&(i=Ie(i,-1,this.dim),a=Ie(a,-1,this.dim));const p=this._idx(i,a);return this.floatView[p]}set(i,a,u){const p=this._idx(i,a),g=this.floatView[p];return this.floatView[p]=u,u-g}static getUnpackVector(i){return b$[i]}_idx(i,a){if(i<-1||i>=this.dim+1||a<-1||a>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(a+1)*this.stride+(i+1)}static pack(i,a){const u=[0,0,0,0],p=mw.getUnpackVector(a);let g=Math.floor((i+p[3])/p[2]);return u[2]=g%256,g=Math.floor(g/256),u[1]=g%256,g=Math.floor(g/256),u[0]=g,u}getPixels(){return new CR({width:this.stride,height:this.stride},this.pixels)}backfillBorder(i,a,u){if(this.dim!==i.dim)throw new Error("dem dimension mismatch");let p=a*this.dim,g=a*this.dim+this.dim,y=u*this.dim,v=u*this.dim+this.dim;switch(a){case-1:p=g-1;break;case 1:g=p+1}switch(u){case-1:y=v-1;break;case 1:v=y+1}const T=-a*this.dim,N=-u*this.dim;for(let I=y;I<v;I++)for(let P=p;P<g;P++){const j=4*this._idx(P,I),O=4*this._idx(P+T,I+N);this.pixels[j+0]=i.pixels[O+0],this.pixels[j+1]=i.pixels[O+1],this.pixels[j+2]=i.pixels[O+2],this.pixels[j+3]=i.pixels[O+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function T$(l,i,a){l===1?i.headerLength=a.readFixed32():l===2?i.x=a.readVarint():l===3?i.y=a.readVarint():l===4?i.z=a.readVarint():l===5&&i.layers.push(function(u,p){return u.readFields(I$,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},p)}(a,a.readVarint()+a.pos))}function N$(l,i,a){l===1?(i.delta_filter=function(u,p){return u.readFields(A$,{blockSize:0},p)}(a,a.readVarint()+a.pos),i.filter="delta_filter"):l===2?(a.readVarint(),i.filter="zigzag_filter"):l===3?(a.readVarint(),i.filter="bitshuffle_filter"):l===4&&(a.readVarint(),i.filter="byteshuffle_filter")}function A$(l,i,a){l===1&&(i.blockSize=a.readVarint())}function C$(l,i,a){l===1?(a.readVarint(),i.codec="gzip_data"):l===2?(a.readVarint(),i.codec="jpeg_image"):l===3?(a.readVarint(),i.codec="webp_image"):l===4&&(a.readVarint(),i.codec="png_image")}function E$(l,i,a){let u=0,p=0;l===1?i.firstByte=a.readFixed64():l===2?i.lastByte=a.readFixed64():l===3?i.filters.push(function(g,y){return g.readFields(N$,{},y)}(a,a.readVarint()+a.pos)):l===4?i.codec=function(g,y){return g.readFields(C$,{},y)}(a,a.readVarint()+a.pos):l===5?p=a.readFloat():l===6?u=a.readFloat():l===7?i.bands.push(a.readString()):l===8?i.offset=a.readDouble():l===9&&(i.scale=a.readDouble()),i.offset===0&&(i.offset=p),i.scale===0&&(i.scale=u)}function I$(l,i,a){l===1?i.version=a.readVarint():l===2?i.name=a.readString():l===3?i.units=a.readString():l===4?i.tileSize=a.readVarint():l===5?i.buffer=a.readVarint():l===6?i.pixelFormat=a.readVarint():l===7&&i.dataIndex.push(function(u,p){return u.readFields(E$,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},p)}(a,a.readVarint()+a.pos))}function P$(l,i,a){if(l===2)(function(u,p,g){u.readFields(j$,g,p)})(a,a.readVarint()+a.pos,i);else if(l===3)throw new Error("Not implemented")}function j$(l,i,a){if(l===1){let u=0;const p=a.readVarint()+a.pos;for(;a.pos<p;)i[u++]=a.readVarint()}}function R$(l,i){if(i.length!==4)throw new Error(`Expected data of dimension 4 but got ${i.length}.`);let a=i[3];for(let u=2;u>=1;u--){const p=u===1?1:0,g=u===2?1:0;for(let y=0;y<i[0];y++){const v=i[1]*y;for(let T=p;T<i[1];T++){const N=i[2]*(T+v);for(let I=g;I<i[2];I++){const P=i[3]*(I+N);for(let j=0;j<i[3];j++){const O=P+j;l[O]+=l[O-a]}}}}a*=i[u]}return l}function k$(l){for(let i=0,a=l.length;i<a;i++)l[i]=l[i]>>>1^-(1&l[i]);return l}function D$(l,i){switch(i){case"uint32":return l;case"uint16":for(let a=0;a<l.length;a+=2){const u=l[a],p=l[a+1];l[a]=(240&u)>>4|(61440&u)>>8|(240&p)<<4|61440&p,l[a+1]=15&u|(3840&u)>>4|(15&p)<<8|(3840&p)<<4}return l;case"uint8":for(let a=0;a<l.length;a+=4){const u=l[a],p=l[a+1],g=l[a+2],y=l[a+3];l[a+0]=(192&u)>>6|(192&p)>>4|(192&g)>>2|192&y,l[a+1]=(48&u)>>4|(48&p)>>2|48&g|(48&y)<<2,l[a+2]=(12&u)>>2|12&p|(12&g)<<2|(12&y)<<4,l[a+3]=3&u|(3&p)<<2|(3&g)<<4|(3&y)<<6}return l;default:throw new Error(`Invalid pixel format, "${i}"`)}}Yt(mw,"DEMData"),Yt(UM,"DemMinMaxQuadTree",{omit:["dem"]});var Pl=Uint8Array,i0=Uint16Array,M$=Int32Array,$M=new Pl([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),GM=new Pl([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),O$=new Pl([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),HM=function(l,i){for(var a=new i0(31),u=0;u<31;++u)a[u]=i+=1<<l[u-1];var p=new M$(a[30]);for(u=1;u<30;++u)for(var g=a[u];g<a[u+1];++g)p[g]=g-a[u]<<5|u;return{b:a,r:p}},WM=HM($M,2),ZM=WM.b,L$=WM.r;ZM[28]=258,L$[258]=28;for(var F$=HM(GM,0).b,XM=new i0(32768),xs=0;xs<32768;++xs){var Lg=(43690&xs)>>1|(21845&xs)<<1;XM[xs]=((65280&(Lg=(61680&(Lg=(52428&Lg)>>2|(13107&Lg)<<2))>>4|(3855&Lg)<<4))>>8|(255&Lg)<<8)>>1}var r0=function(l,i,a){for(var u=l.length,p=0,g=new i0(i);p<u;++p)l[p]&&++g[l[p]-1];var y,v=new i0(i);for(p=1;p<i;++p)v[p]=v[p-1]+g[p-1]<<1;y=new i0(1<<i);var T=15-i;for(p=0;p<u;++p)if(l[p])for(var N=p<<4|l[p],I=i-l[p],P=v[l[p]-1]++<<I,j=P|(1<<I)-1;P<=j;++P)y[XM[P]>>T]=N;return y},n0=new Pl(288);for(xs=0;xs<144;++xs)n0[xs]=8;for(xs=144;xs<256;++xs)n0[xs]=9;for(xs=256;xs<280;++xs)n0[xs]=7;for(xs=280;xs<288;++xs)n0[xs]=8;var YM=new Pl(32);for(xs=0;xs<32;++xs)YM[xs]=5;var z$=r0(n0,9),B$=r0(YM,5),zA=function(l){for(var i=l[0],a=1;a<l.length;++a)l[a]>i&&(i=l[a]);return i},Lc=function(l,i,a){var u=i/8|0;return(l[u]|l[u+1]<<8)>>(7&i)&a},BA=function(l,i){var a=i/8|0;return(l[a]|l[a+1]<<8|l[a+2]<<16)>>(7&i)},V$=function(l){return(l+7)/8|0},U$=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Fc=function(l,i,a){var u=new Error(i||U$[l]);if(u.code=l,Error.captureStackTrace&&Error.captureStackTrace(u,Fc),!a)throw u;return u},q$=new Pl(0),$$=typeof TextDecoder<"u"&&new TextDecoder;try{$$.decode(q$,{stream:!0})}catch{}const G$={gzip_data:"gzip"};class lc extends Error{constructor(i){super(i),this.name="MRTError"}}const H$={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},KM={uint32:1,uint16:2,uint8:4},W$={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};let VA;class fw{constructor(i=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=i}getLayer(i){const a=this.layers[i];if(!a)throw new lc(`Layer '${i}' not found`);return a}getHeaderLength(i){const a=new Uint8Array(i),u=new DataView(i);if(a[0]!==13)throw new lc("File is not a valid MRT.");return u.getUint32(1,!0)}parseHeader(i){const a=new Uint8Array(i),u=this.getHeaderLength(i);if(a.length<u)throw new lc(`Expected header with length >= ${u} but got buffer of length ${a.length}`);const p=new VA(a.subarray(0,u)).readFields(T$,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0);if(!isNaN(this.x)&&(this.x!==p.x||this.y!==p.y||this.z!==p.z))throw new lc(`Invalid attempt to parse header ${p.z}/${p.x}/${p.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=p.x,this.y=p.y,this.z=p.z;for(const g of p.layers)this.layers[g.name]=new QM(g,{cacheSize:this._cacheSize});return this}createDecodingTask(i){const a=[],u=this.getLayer(i.layerName);for(let p of i.blockIndices){const g=u.dataIndex[p],y=g.firstByte-i.firstByte,v=g.lastByte-i.firstByte;if(u._blocksInProgress.has(p))continue;const T={layerName:u.name,firstByte:y,lastByte:v,pixelFormat:u.pixelFormat,blockIndex:p,blockShape:[g.bands.length].concat(u.bandShape),buffer:u.buffer,codec:g.codec.codec,filters:g.filters.map(N=>N.filter)};u._blocksInProgress.add(p),a.push(T)}return new JM(a,()=>{a.forEach(p=>u._blocksInProgress.delete(p.blockIndex))},(p,g)=>{if(a.forEach(y=>u._blocksInProgress.delete(y.blockIndex)),p)throw p;g.forEach(y=>{this.getLayer(y.layerName).processDecodedData(y)})})}}class QM{constructor({version:i,name:a,units:u,tileSize:p,pixelFormat:g,buffer:y,dataIndex:v},T){if(this.version=i,this.version!==1)throw new lc(`Cannot parse raster layer encoded with MRT version ${i}`);this.name=a,this.units=u,this.tileSize=p,this.buffer=y,this.pixelFormat=H$[g],this.dataIndex=v,this.bandShape=[p+2*y,p+2*y,KM[this.pixelFormat]],this._decodedBlocks=new pw(T?T.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return KM[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map(({bands:i})=>i).flat()}processDecodedData(i){const a=i.blockIndex.toString();this._decodedBlocks.get(a)||this._decodedBlocks.put(a,i.data)}getBlockForBand(i){let a=0;switch(typeof i){case"string":for(const[u,p]of this.dataIndex.entries()){for(const[g,y]of p.bands.entries())if(y===i)return{bandIndex:a+g,blockIndex:u,blockBandIndex:g};a+=p.bands.length}break;case"number":for(const[u,p]of this.dataIndex.entries()){if(i>=a&&i<a+p.bands.length)return{bandIndex:i,blockIndex:u,blockBandIndex:i-a};a+=p.bands.length}break;default:throw new lc(`Invalid band \`${JSON.stringify(i)}\`. Expected string or integer.`)}return{blockIndex:-1,blockBandIndex:-1}}getDataRange(i){let a=1/0,u=-1/0;const p=[],g=new Set;for(const y of i){const{blockIndex:v}=this.getBlockForBand(y);if(v<0)throw new lc(`Invalid band: ${JSON.stringify(y)}`);const T=this.dataIndex[v];p.includes(v)||p.push(v),g.add(v),a=Math.min(a,T.firstByte),u=Math.max(u,T.lastByte)}if(g.size>this.cacheSize)throw new lc(`Number of blocks to decode (${g.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:a,lastByte:u,blockIndices:p}}hasBand(i){const{blockIndex:a}=this.getBlockForBand(i);return a>=0}hasDataForBand(i){const{blockIndex:a}=this.getBlockForBand(i);return a>=0&&!!this._decodedBlocks.get(a.toString())}getBandView(i){const{blockIndex:a,blockBandIndex:u}=this.getBlockForBand(i);if(a<0)throw new lc(`Band not found: ${JSON.stringify(i)}`);const p=this._decodedBlocks.get(a.toString());if(!p)throw new lc(`Data for band ${JSON.stringify(i)} of layer "${this.name}" not decoded.`);const g=this.dataIndex[a],y=this.bandShape.reduce((N,I)=>N*I,1),v=u*y,T=p.subarray(v,v+y);return{data:T,bytes:new Uint8Array(T.buffer).subarray(T.byteOffset,T.byteOffset+T.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:g.offset,scale:g.scale}}}fw.setPbf=function(l){VA=l};class JM{constructor(i,a,u){this.tasks=i,this._onCancel=a,this._onComplete=u,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(i,a){this._finalized||(this._onComplete(i,a),this._finalized=!0)}}fw.performDecoding=function(l,i){const a=new Uint8Array(l);return Promise.all(i.tasks.map(u=>{const{layerName:p,firstByte:g,lastByte:y,pixelFormat:v,blockShape:T,blockIndex:N,filters:I,codec:P}=u,j=a.subarray(g,y+1),O=new Uint32Array(T[0]*T[1]*T[2]);let L;if(P!=="gzip_data")throw new lc(`Unhandled codec: ${P}`);return L=function(U,Z){if(!globalThis.DecompressionStream&&Z==="gzip_data")return Promise.resolve((we=function(Me){Me[0]==31&&Me[1]==139&&Me[2]==8||Fc(6,"invalid gzip data");var je=Me[3],Be=10;4&je&&(Be+=2+(Me[10]|Me[11]<<8));for(var Ge=(je>>3&1)+(je>>4&1);Ge>0;Ge-=!Me[Be++]);return Be+(2&je)}(G=U),we+8>G.length&&Fc(6,"invalid gzip data"),function(Me,je,Be,Ge){var ut=Me.length;if(!ut||je.f&&!je.l)return Be||new Pl(0);var lt=!Be,ct=lt||je.i!=2,xt=je.i;lt&&(Be=new Pl(3*ut));var gt=function(Ga){var Eu=Be.length;if(Ga>Eu){var Ea=new Pl(Math.max(2*Eu,Ga));Ea.set(Be),Be=Ea}},yt=je.f||0,st=je.p||0,bt=je.b||0,mt=je.l,Tt=je.d,_t=je.m,Zt=je.n,Xt=8*ut;do{if(!mt){yt=Lc(Me,st,1);var Ft=Lc(Me,st+1,3);if(st+=3,!Ft){var Vt=Me[(_r=V$(st)+4)-4]|Me[_r-3]<<8,xi=_r+Vt;if(xi>ut){xt&&Fc(0);break}ct&&gt(bt+Vt),Be.set(Me.subarray(_r,xi),bt),je.b=bt+=Vt,je.p=st=8*xi,je.f=yt;continue}if(Ft==1)mt=z$,Tt=B$,_t=9,Zt=5;else if(Ft==2){var ri=Lc(Me,st,31)+257,Gt=Lc(Me,st+10,15)+4,Ri=ri+Lc(Me,st+5,31)+1;st+=14;for(var tr=new Pl(Ri),Cr=new Pl(19),Qi=0;Qi<Gt;++Qi)Cr[O$[Qi]]=Lc(Me,st+3*Qi,7);st+=3*Gt;var Ur=zA(Cr),fr=(1<<Ur)-1,Bn=r0(Cr,Ur);for(Qi=0;Qi<Ri;){var _r,Mr=Bn[Lc(Me,st,fr)];if(st+=15&Mr,(_r=Mr>>4)<16)tr[Qi++]=_r;else{var ln=0,vn=0;for(_r==16?(vn=3+Lc(Me,st,3),st+=2,ln=tr[Qi-1]):_r==17?(vn=3+Lc(Me,st,7),st+=3):_r==18&&(vn=11+Lc(Me,st,127),st+=7);vn--;)tr[Qi++]=ln}}var bn=tr.subarray(0,ri),Vn=tr.subarray(ri);_t=zA(bn),Zt=zA(Vn),mt=r0(bn,_t),Tt=r0(Vn,Zt)}else Fc(1);if(st>Xt){xt&&Fc(0);break}}ct&&gt(bt+131072);for(var Js=(1<<_t)-1,Sa=(1<<Zt)-1,os=st;;os=st){var _s=(ln=mt[BA(Me,st)&Js])>>4;if((st+=15&ln)>Xt){xt&&Fc(0);break}if(ln||Fc(2),_s<256)Be[bt++]=_s;else{if(_s==256){os=st,mt=null;break}var Rs=_s-254;_s>264&&(Rs=Lc(Me,st,(1<<(Mn=$M[Qi=_s-257]))-1)+ZM[Qi],st+=Mn);var Xi=Tt[BA(Me,st)&Sa],wn=Xi>>4;if(Xi||Fc(3),st+=15&Xi,Vn=F$[wn],wn>3){var Mn=GM[wn];Vn+=BA(Me,st)&(1<<Mn)-1,st+=Mn}if(st>Xt){xt&&Fc(0);break}ct&&gt(bt+131072);var Yo=bt+Rs;if(bt<Vn){var $a=0-Vn,ea=Math.min(Vn,Yo);for($a+bt<0&&Fc(3);bt<ea;++bt)Be[bt]=Ge[$a+bt]}for(;bt<Yo;++bt)Be[bt]=Be[bt-Vn]}}je.l=mt,je.p=os,je.b=bt,je.f=yt,mt&&(yt=1,je.m=_t,je.d=Tt,je.n=Zt)}while(!yt);return bt!=Be.length&&lt?function(Ga,Eu,Ea){return(Ea==null||Ea>Ga.length)&&(Ea=Ga.length),new Pl(Ga.subarray(0,Ea))}(Be,0,bt):Be.subarray(0,bt)}(G.subarray(we,-8),{i:2},new Pl(((le=G)[(me=le.length)-4]|le[me-3]<<8|le[me-2]<<16|le[me-1]<<24)>>>0),ee)));var G,ee,le,me,we;const be=G$[Z];if(!be)throw new Error(`Unhandled codec: ${Z}`);const Re=new globalThis.DecompressionStream(be);return new Response(new Blob([U]).stream().pipeThrough(Re)).arrayBuffer().then(Me=>new Uint8Array(Me))}(j,P).then(U=>(function(Z,G){Z.readFields(P$,G)}(new VA(U),O),new W$[v](O.buffer))),L.then(U=>{for(let Z=I.length-1;Z>=0;Z--)switch(I[Z]){case"delta_filter":R$(U,T);break;case"zigzag_filter":k$(U);break;case"bitshuffle_filter":D$(U,v);break;default:throw new lc(`Unhandled filter "${I[Z]}"`)}return{layerName:p,blockIndex:N,data:U}}).catch(U=>{throw U})}))},Yt(JM,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),Yt(fw,"MapboxRasterTile"),Yt(QM,"MapboxRasterLayer",{omit:["_blocksInProgress"]});class eO{constructor(i){this._stringToNumber={},this._numberToString=[];for(let a=0;a<i.length;a++){const u=i[a];this._stringToNumber[u]=a,this._numberToString[a]=u}}encode(i){return this._stringToNumber[i]}decode(i){return this._numberToString[i]}}class tO{constructor(i,a){this.tileID=i,this.x=i.canonical.x,this.y=i.canonical.y,this.z=i.canonical.z,this.grid=new pd(Bt,16,0),this.featureIndexArray=new ym,this.promoteId=a,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(i,a,u,p,g,y=0,v=0){const T=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(u,p,g,y);const N=this.grid;for(let I=0;I<a.length;I++){const P=a[I],j=[1/0,1/0,-1/0,-1/0];for(let O=0;O<P.length;O++){const L=P[O];j[0]=Math.min(j[0],L.x),j[1]=Math.min(j[1],L.y),j[2]=Math.max(j[2],L.x),j[3]=Math.max(j[3],L.y)}v!==0&&(j[0]-=v,j[1]-=v,j[2]+=v,j[3]+=v),j[0]<Bt&&j[1]<Bt&&j[2]>=0&&j[3]>=0&&N.insert(T,j[0],j[1],j[2],j[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new Rr(new H1(this.rawTileData)).layers,this.sourceLayerCoder=new eO(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const i in this.vtLayers)this.vtFeatures[i]=[]}return this.vtLayers}query(i,a){const{tilespaceGeometry:u,transform:p,tileTransform:g,pixelPosMatrix:y,availableImages:v,worldview:T}=a;this.loadVTLayers(),this.serializedLayersCache.clear();const N=a.queryRadius?a.queryRadius:0,I=u.bufferedTilespaceBounds,P=this.grid.query(I.min.x,I.min.y,I.max.x,I.max.y,(U,Z,G,ee)=>ac(u.bufferedTilespaceGeometry,U-N,Z-N,G+N,ee+N));P.sort(Z$);let j=null;p.elevation&&P.length>0&&(j=Dg.create(p.elevation,this.tileID));const O={};let L;for(let U=0;U<P.length;U++){const Z=P[U];if(Z===L)continue;L=Z;const G=this.featureIndexArray.get(Z);let ee=null;this.is3DTile?this.loadMatchingModelFeature(O,G,i,u,p,T):this.loadMatchingFeature(O,G,i,v,T,(le,me,we,be=0)=>(ee||(ee=Ci(le,this.tileID.canonical,g)),me.queryIntersectsFeature(u,le,we,ee,this.z,p,y,j,be,a.scope)))}return O}loadMatchingFeature(i,a,u,p,g,y){const{featureIndex:v,bucketIndex:T,sourceLayerIndex:N,layoutVertexArrayOffset:I}=a,P=this.bucketLayerIDs[T],j=u.layers,O=Object.keys(j);if(O.length&&!$i(O,P))return;const L=u.sourceCache,U=this.sourceLayerCoder.decode(N),Z=this.vtLayers[U].feature(v),G=this.getId(Z,U);for(let ee=0;ee<P.length;ee++){const le=P[ee];if(!j[le])continue;const{styleLayer:me,targets:we}=j[le];let be={};G!==void 0&&(be=L.getFeatureState(me.sourceLayer,G));const Re=!y||y(Z,me,be,I);if(!Re)continue;const Me=new jm(Z,this.z,this.x,this.y,G);Me.tile=this.tileID.canonical,Me.state=be;let je=this.serializedLayersCache.get(le);je||(je=me.serialize(),je.id=le,this.serializedLayersCache.set(le,je)),Me.source=je.source,Me.sourceLayer=je["source-layer"],Me.layer=Object.assign({},je),Me.layer.paint=iO(je.paint,me.paint,Z,be,p),Me.layer.layout=iO(je.layout,me.layout,Z,be,p);let Be=!1;for(const Ge of we){this.updateFeatureProperties(Me,Ge);const{filter:ut}=Ge;if(ut){if(Z.properties=Me.properties,ut.needGeometry){const lt=Hi(Z,!0);if(!ut.filter(new Vr(this.tileID.overscaledZ,{worldview:g}),lt,this.tileID.canonical))continue}else if(!ut.filter(new Vr(this.tileID.overscaledZ,{worldview:g}),Z))continue}Be=!0,Ge.targetId&&this.addFeatureVariant(Me,Ge)}Be&&this.appendToResult(i,le,v,Me,Re)}}loadMatchingModelFeature(i,a,u,p,g,y){const{featureIndex:v,bucketIndex:T}=a,N=this.bucketLayerIDs[T],I=u.layers,P=Object.keys(I);if(!P.length||$i(P,N))for(let j=0;j<N.length;j++){const O=N[j],{styleLayer:L,targets:U}=I[O];if(L.type!=="model")continue;const Z=p.tile,G=Z.getBucket(L);if(!(G&&G instanceof cw))continue;const ee=t$(G,v,p,g);if(!ee)continue;const{z:le,x:me,y:we}=Z.tileID.canonical,{feature:be,intersectionZ:Re,position:Me}=ee;let je={};be.id!==void 0&&(je=u.sourceCache.getFeatureState(L.sourceLayer,be.id));const Be=new jm({},le,me,we,be.id);Be.tile=this.tileID.canonical,Be.state=je,Be.properties=be.properties,Be.geometry={type:"Point",coordinates:[Me.lng,Me.lat]};let Ge=this.serializedLayersCache.get(O);Ge||(Ge=L.serialize(),Ge.id=O,this.serializedLayersCache.set(O,Ge)),Be.source=Ge.source,Be.sourceLayer=Ge["source-layer"],Be.layer=Object.assign({},Ge);let ut=!1;for(const lt of U){this.updateFeatureProperties(Be,lt);const{filter:ct}=lt;if(ct){if(be.properties=Be.properties,ct.needGeometry){if(!ct.filter(new Vr(this.tileID.overscaledZ,{worldview:y}),be,this.tileID.canonical))continue}else if(!ct.filter(new Vr(this.tileID.overscaledZ,{worldview:y}),be))continue}ut=!0,lt.targetId&&this.addFeatureVariant(Be,lt)}ut&&this.appendToResult(i,O,v,Be,Re)}}updateFeatureProperties(i,a,u){if(a.properties){const p={};for(const g in a.properties){const y=a.properties[g].evaluate({zoom:this.z},i._vectorTileFeature,i.state,i.tile,u);y!=null&&(p[g]=y)}i.properties=p}}addFeatureVariant(i,a,u){const p={target:a.target,namespace:a.namespace,uniqueFeatureID:a.uniqueFeatureID};a.properties&&(p.properties=i.properties),i.variants=i.variants||{},i.variants[a.targetId]=i.variants[a.targetId]||[],i.variants[a.targetId].push(p)}appendToResult(i,a,u,p,g){let y=i[a];y===void 0&&(y=i[a]=[]),y.push({featureIndex:u,feature:p,intersectionZ:g})}lookupSymbolFeatures(i,a,u,p,g,y){const v={};this.loadVTLayers();for(const T of i)this.loadMatchingFeature(v,{bucketIndex:a,sourceLayerIndex:u,featureIndex:T,layoutVertexArrayOffset:0},p,g,y);return v}loadFeature(i){const{featureIndex:a,sourceLayerIndex:u}=i;this.loadVTLayers();const p=this.sourceLayerCoder.decode(u),g=this.vtFeatures[p];if(g[a])return g[a];const y=this.vtLayers[p].feature(a);return g[a]=y,y}hasLayer(i){for(const a of this.bucketLayerIDs)for(const u of a)if(i===u)return!0;return!1}getId(i,a){let u=i.id;if(this.promoteId){const p=Array.isArray(this.promoteId)||typeof this.promoteId!="object"?this.promoteId:this.promoteId[a];if(p!=null)if(Array.isArray(p)){if(!this.promoteIdExpression){const g=yu(p);if(g.result!=="success"){const y=g.value.map(v=>`${v.key}: ${v.message}`).join(", ");return void Ni(`Failed to create expression for promoteId: ${y}`)}this.promoteIdExpression=g.value}u=this.promoteIdExpression.evaluate({zoom:0},i)}else u=i.properties[p];typeof u=="boolean"&&(u=Number(u))}return u}}function iO(l,i,a,u,p){return ci(l,(g,y)=>{const v=i instanceof za?i.get(y):null;return v&&v.evaluate?v.evaluate(a,u,void 0,p):v})}function Z$(l,i){return i-l}Yt(tO,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const rO=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class UA{static from(i){if(!(i instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[a,u]=new Uint8Array(i,0,2);if(a!==219)throw new Error("Data does not appear to be in a KDBush format.");const p=u>>4;if(p!==1)throw new Error(`Got v${p} data when expected v1.`);const g=rO[15&u];if(!g)throw new Error("Unrecognized array type.");const[y]=new Uint16Array(i,2,1),[v]=new Uint32Array(i,4,1);return new UA(v,y,g,i)}constructor(i,a=64,u=Float64Array,p){if(isNaN(i)||i<0)throw new Error(`Unpexpected numItems value: ${i}.`);this.numItems=+i,this.nodeSize=Math.min(Math.max(+a,2),65535),this.ArrayType=u,this.IndexArrayType=i<65536?Uint16Array:Uint32Array;const g=rO.indexOf(this.ArrayType),y=2*i*this.ArrayType.BYTES_PER_ELEMENT,v=i*this.IndexArrayType.BYTES_PER_ELEMENT,T=(8-v%8)%8;if(g<0)throw new Error(`Unexpected typed array class: ${u}.`);p&&p instanceof ArrayBuffer?(this.data=p,this.ids=new this.IndexArrayType(this.data,8,i),this.coords=new this.ArrayType(this.data,8+v+T,2*i),this._pos=2*i,this._finished=!0):(this.data=new ArrayBuffer(8+y+v+T),this.ids=new this.IndexArrayType(this.data,8,i),this.coords=new this.ArrayType(this.data,8+v+T,2*i),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+g]),new Uint16Array(this.data,2,1)[0]=a,new Uint32Array(this.data,4,1)[0]=i)}add(i,a){const u=this._pos>>1;return this.ids[u]=u,this.coords[this._pos++]=i,this.coords[this._pos++]=a,u}finish(){const i=this._pos>>1;if(i!==this.numItems)throw new Error(`Added ${i} items when expected ${this.numItems}.`);return qA(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(i,a,u,p){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:g,coords:y,nodeSize:v}=this,T=[0,g.length-1,0],N=[];for(;T.length;){const I=T.pop()||0,P=T.pop()||0,j=T.pop()||0;if(P-j<=v){for(let Z=j;Z<=P;Z++){const G=y[2*Z],ee=y[2*Z+1];G>=i&&G<=u&&ee>=a&&ee<=p&&N.push(g[Z])}continue}const O=j+P>>1,L=y[2*O],U=y[2*O+1];L>=i&&L<=u&&U>=a&&U<=p&&N.push(g[O]),(I===0?i<=L:a<=U)&&(T.push(j),T.push(O-1),T.push(1-I)),(I===0?u>=L:p>=U)&&(T.push(O+1),T.push(P),T.push(1-I))}return N}within(i,a,u){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:p,coords:g,nodeSize:y}=this,v=[0,p.length-1,0],T=[],N=u*u;for(;v.length;){const I=v.pop()||0,P=v.pop()||0,j=v.pop()||0;if(P-j<=y){for(let Z=j;Z<=P;Z++)sO(g[2*Z],g[2*Z+1],i,a)<=N&&T.push(p[Z]);continue}const O=j+P>>1,L=g[2*O],U=g[2*O+1];sO(L,U,i,a)<=N&&T.push(p[O]),(I===0?i-u<=L:a-u<=U)&&(v.push(j),v.push(O-1),v.push(1-I)),(I===0?i+u>=L:a+u>=U)&&(v.push(O+1),v.push(P),v.push(1-I))}return T}}function qA(l,i,a,u,p,g){if(p-u<=a)return;const y=u+p>>1;nO(l,i,y,u,p,g),qA(l,i,a,u,y-1,1-g),qA(l,i,a,y+1,p,1-g)}function nO(l,i,a,u,p,g){for(;p>u;){if(p-u>600){const N=p-u+1,I=a-u+1,P=Math.log(N),j=.5*Math.exp(2*P/3),O=.5*Math.sqrt(P*j*(N-j)/N)*(I-N/2<0?-1:1);nO(l,i,a,Math.max(u,Math.floor(a-I*j/N+O)),Math.min(p,Math.floor(a+(N-I)*j/N+O)),g)}const y=i[2*a+g];let v=u,T=p;for(s0(l,i,u,a),i[2*p+g]>y&&s0(l,i,u,p);v<T;){for(s0(l,i,v,T),v++,T--;i[2*v+g]<y;)v++;for(;i[2*T+g]>y;)T--}i[2*u+g]===y?s0(l,i,u,T):(T++,s0(l,i,T,p)),T<=a&&(u=T+1),a<=T&&(p=T-1)}}function s0(l,i,a,u){$A(l,a,u),$A(i,2*a,2*u),$A(i,2*a+1,2*u+1)}function $A(l,i,a){const u=l[i];l[i]=l[a],l[a]=u}function sO(l,i,a,u){const p=l-a,g=i-u;return p*p+g*g}o.$=ax,o.A=Er,o.B=fd,o.C=2,o.D=wg,o.E=zo,o.F=U_,o.G=ED,o.H=If,o.I=Ys,o.J=Zb,o.K=ji,o.L=Ai,o.M=Ox,o.N=Yf,o.O=Eb,o.P=wt,o.Q=rm,o.R=Ca,o.S=og,o.T=JN,o.U=yu,o.V=lw,o.W=Jf,o.X=ah,o.Y=sh,o.Z=Yp,o._=to,o.a=function(l){return ns.API_CDN_URL_REGEX.test(l)},o.a$=Nt,o.a0=$p,o.a1=Ef,o.a2=e_,o.a3=class extends lw{},o.a4=Kf,o.a5=Mx,o.a6=et,o.a7=function(l){const i=l.value;return i?$p(i)?jA(i,!0)?[]:[new lw(l.key,i,`invalid url "${i}"`)]:[new lw(l.key,i,`string expected, "${ji(i)}" found`)]:[]},o.a8=gh,o.a9=kn,o.aA=Ie,o.aB=K,o.aC=Vi,o.aD=J,o.aE=wo,o.aF=Qe,o.aG=Mt,o.aH=function(l,i){const a={};for(let u=0;u<i.length;u++){const p=i[u];p in l&&(a[p]=l[p])}return a},o.aI=qe,o.aJ=at,o.aK=class{constructor(l){this.entries={},this.scheduler=l}request(l,i,a,u){const p=this.entries[l]=this.entries[l]||{callbacks:[]};if(p.result){const[g,y]=p.result;return this.scheduler?this.scheduler.add(()=>{u(g,y)},i):u(g,y),()=>{}}return p.callbacks.push(u),p.cancel||(p.cancel=a((g,y)=>{p.result=[g,y];for(const v of p.callbacks)this.scheduler?this.scheduler.add(()=>{v(g,y)},i):v(g,y);setTimeout(()=>delete this.entries[l],3e3)})),()=>{p.result||(p.callbacks=p.callbacks.filter(g=>g!==u),p.callbacks.length||(p.cancel(),delete this.entries[l]))}}},o.aL=function(l,i,a){const u=JSON.stringify(l.request);return l.data&&(this.deduped.entries[u]={result:[null,l.data]}),this.deduped.request(u,{type:"parseTile",isSymbolTile:l.isSymbolTile,zoom:l.tileZoom},p=>{const g=su(l.request,(y,v,T)=>{y?p(y):v&&p(null,{rawData:v,vectorTile:a?void 0:new Rr(new H1(v)),responseHeaders:new Map(T.entries())})});return()=>{g.cancel(),p()}},i)},o.aM=function(l){return l?{cacheControl:l.get("Cache-Control"),expires:l.get("Expires")}:{cacheControl:void 0,expires:void 0}},o.aN=id,o.aO=function(l){Fo++,Fo>Bp&&(l.getActor().send("enforceCacheSizeLimit",zp),Fo=0)},o.aP=function(l){return l<=1?1:Math.pow(2,Math.floor(Math.log2(l)))},o.aQ=qa,o.aR=oM,o.aS=pM,o.aT=Se,o.aU=aM,o.aV=function(l,i){const a=document.createElement("video");a.muted=!0,a.onloadstart=function(){i(null,a)};for(let u=0;u<l.length;u++){const p=document.createElement("source");rd(l[u])||(a.crossOrigin="Anonymous"),p.src=l[u],a.appendChild(p)}return{cancel:()=>{}}},o.aW=L_,o.aX=Rm,o.aY=Ht,o.aZ=G_,o.a_=ft,o.aa=Dt,o.ab=class{constructor(l){this.specification=l}possiblyEvaluate(l,i){return gn(l.expression.evaluate(i))}interpolate(l,i,a){return{x:Si(l.x,i.x,a),y:Si(l.y,i.y,a),z:Si(l.z,i.z,a),azimuthal:Si(l.azimuthal,i.azimuthal,a),polar:Si(l.polar,i.polar,a)}}},o.ac=Vr,o.ad=hd,o.ae=Ut,o.af=Bi,o.ag=ve,o.ah=Xe,o.ai=za,o.aj=Ah,o.ak=Si,o.al=Bt,o.am=sd,o.an=Zi,o.ao=Ar,o.ap=class{constructor(l){this.specification=l}possiblyEvaluate(l,i){return function([a,u]){const p=gn([1,a,u]);return{x:p.x,y:p.y,z:p.z}}(l.expression.evaluate(i))}interpolate(l,i,a){return{x:Si(l.x,i.x,a),y:Si(l.y,i.y,a),z:Si(l.z,i.z,a)}}},o.aq=function(l,i,a=0,u=!0){const p=new wt(a,a),g=l.sub(p),y=i.add(p),v=[g,new wt(y.x,g.y),y,new wt(g.x,y.y)];return u&&v.push(g.clone()),v},o.ar=function(l,i){const a=[];for(let u=0;u<l.length;u++){const p=Je(u-1,-1,l.length-1),g=Je(u+1,-1,l.length-1),y=l[u],v=l[g],T=l[p].sub(y).unit(),N=v.sub(y).unit(),I=N.angleWithSep(T.x,T.y),P=T.add(N).unit().mult(-1*i/Math.sin(I/2));a.push(y.add(P))}return a},o.as=GD,o.at=ac,o.au=function(l,i,a=0){return Le(((i.x-a)*l.scale-l.x)*Bt,(i.y*l.scale-l.y)*Bt,rt(i.z,i.y))},o.av=Tr,o.aw=ni,o.ax=Zr,o.ay=rD,o.az=function(l){let i=1/0,a=1/0,u=-1/0,p=-1/0;for(const g of l)i=Math.min(i,g.x),a=Math.min(a,g.y),u=Math.max(u,g.x),p=Math.max(p,g.y);return{min:new wt(i,a),max:new wt(u,p)}},o.b=function(l){return ns.API_FONTS_REGEX.test(l)},o.b$=JR,o.b0=ys,o.b1=Dc,o.b2=At,o.b3=r1,o.b4=nw,o.b5=function(){El.isLoading()||El.isLoaded()||Kx()!=="deferred"||Qx()},o.b6=t_,o.b7=Hi,o.b8=jm,o.b9=Yr,o.bA=se,o.bB=ne,o.bC=X,o.bD=function(l,i){const{x:a,y:u}=l.point,p=mR(a,u,l.worldSize/l._pixelsPerMercatorPixel,0,0);return K(p,p,bN(Nu(i)))},o.bE=F,o.bF=nn,o.bG=yi,o.bH=Et,o.bI=Fi,o.bJ=ui,o.bK=Ig,o.bL=Xo,o.bM=gA,o.bN=function(l,i,a,u,p){const g=5*i+2;l.float32[g+0]=a,l.float32[g+1]=u,l.float32[g+2]=p},o.bO=kg,o.bP=Da,o.bQ=Mi,o.bR=pt,o.bS=Ma,o.bT=Je,o.bU=function(l,i,a,u){var p=new R(4);return p[0]=l,p[1]=i,p[2]=a,p[3]=u,p},o.bV=class{isDataAvailableAtPoint(l){const i=this._source();if(this.isUsingMockSource()||!i||l.y<0||l.y>1)return!1;const a=i.getSource().maxzoom,u=1<<a,p=Math.floor(l.x),g=Math.floor((l.x-p)*u),y=Math.floor(l.y*u),v=this.findDEMTileFor(new qa(a,p,a,g,y));return!(!v||!v.dem)}getAtPointOrZero(l,i=0){return this.getAtPoint(l,i)||0}getAtPoint(l,i,a=!0){if(this.isUsingMockSource())return null;i==null&&(i=null);const u=this._source();if(!u||l.y<0||l.y>1)return i;const p=u.getSource().maxzoom,g=1<<p,y=Math.floor(l.x),v=l.x-y,T=new qa(p,y,p,Math.floor(v*g),Math.floor(l.y*g)),N=this.findDEMTileFor(T);if(!N||!N.dem)return i;const I=N.dem,P=1<<N.tileID.canonical.z,j=(v*P-N.tileID.canonical.x)*I.dim,O=(l.y*P-N.tileID.canonical.y)*I.dim,L=Math.floor(j),U=Math.floor(O);return(a?this.exaggeration():1)*Si(Si(I.get(L,U),I.get(L,U+1),O-U),Si(I.get(L+1,U),I.get(L+1,U+1),O-U),j-L)}static getAtTileOffset(l,i,a,u){const p=1<<l.canonical.z;return u?u.pointElevation(i):a?a.getAtPointOrZero(new Ut(l.wrap+(l.canonical.x+i.x/Bt)/p,(l.canonical.y+i.y/Bt)/p)):0}static getAtTileOffsetFunc(l,i,a,u){return(p,g,y)=>{const v=this.getAtTileOffset(l,p,g,y),T=u.upVector(l.canonical,p.x,p.y);return Ot(T,T,v*u.upVectorScale(l.canonical,i,a).metersToTile),T}}getForTilePoints(l,i,a,u){if(this.isUsingMockSource())return!1;const p=Dg.create(this,l,u);return!!p&&(i.forEach(g=>{g[2]=this.exaggeration()*p.getElevationAt(g[0],g[1],a)}),!0)}getMinMaxForTile(l){if(this.isUsingMockSource())return null;const i=this.findDEMTileFor(l);if(!i||!i.dem)return null;const a=i.dem.tree,u=i.tileID,p=1<<l.canonical.z-u.canonical.z;let g=l.canonical.x/p-u.canonical.x,y=l.canonical.y/p-u.canonical.y,v=0;for(let T=0;T<l.canonical.z-u.canonical.z&&!a.leaves[v];T++){g*=2,y*=2;const N=2*Math.floor(y)+Math.floor(g);v=a.childOffsets[v]+N,g%=1,y%=1}return{min:this.exaggeration()*a.minimums[v],max:this.exaggeration()*a.maximums[v]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(l,i,a){throw new Error("Pure virtual method called.")}pointCoordinate(l){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(l){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const l=this.visibleDemTiles;if(l.length===0)return null;let i=!1,a=Number.MAX_VALUE,u=Number.MIN_VALUE;for(const p of l){const g=this.getMinMaxForTile(p.tileID);g&&(a=Math.min(a,g.min),u=Math.max(u,g.max),i=!0)}return i?{min:a,max:u}:null}},o.bW=M1,o.bX=_n,o.bY=Bs,o.bZ=XR,o.b_=mM,o.ba=lA,o.bb=FN,o.bc=Ci,o.bd=Su,o.be=mm,o.bf=lR,o.bg=dn,o.bh=xg,o.bi=IA,o.bj=function(l,i){const a=Ah(i.zoom);if(a===0)return Nu(l);const u=b1(l),p=vN(u),g=Qe(u.getWest())*i.worldSize,y=Qe(u.getEast())*i.worldSize,v=at(u.getNorth())*i.worldSize,T=at(u.getSouth())*i.worldSize,N=[g,v,0],I=[y,v,0],P=[g,T,0],j=[y,T,0],O=de([],i.globeMatrix);return Bi(N,N,O),Bi(I,I,O),Bi(P,P,O),Bi(j,j,O),p[0]=_d(p[0],P,a),p[1]=_d(p[1],j,a),p[2]=_d(p[2],I,a),p[3]=_d(p[3],N,a),jr.fromPoints(p)},o.bk=S1,o.bl=de,o.bm=__,o.bn=_d,o.bo=kc,o.bp=aq,o.bq=ae,o.br=ge,o.bs=fw,o.bt=H1,o.bu=su,o.bv=function(l,i){const a=[];for(const u in l)u in i||a.push(u);return a},o.bw=He,o.bx=["type","source","source-layer","minzoom","maxzoom","filter","layout"],o.by=Xa,o.bz=he,o.c=Zs,o.c$=function(l,i,a){let u=0;for(let p=0;p<2;++p)l[p]>0&&(u+=(l[p]-0)*(l[p]-0)),i[p]<0&&(u+=(0-i[p])*(0-i[p]));return u},o.c0=ek,o.c1=pA,o.c2=OD,o.c3=bA,o.c4=UA,o.c5=Ot,o.c6=bi,o.c7=vi,o.c8=function(l,i,a){a*=.5;var u=i[0],p=i[1],g=i[2],y=i[3],v=Math.sin(a),T=Math.cos(a);return l[0]=u*T+p*v,l[1]=p*T-u*v,l[2]=g*T+y*v,l[3]=y*T-g*v,l},o.c9=Pi,o.cA=ie,o.cB=Fs,o.cC=Uk,o.cD=wm,o.cE=dR,o.cF=function(l,i,a,u,p,g,y,v,T){if(T.name==="globe")return dR(l,i,new wm(a,u,p),!1);const N=G_({z:a,x:u,y:p},T);return new jr([(g+N.x/N.scale)*i,i*(N.y/N.scale),y],[(g+N.x2/N.scale)*i,i*(N.y2/N.scale),v])},o.cG=function(l,i,a){return l[0]=Math.min(i[0],a[0]),l[1]=Math.min(i[1],a[1]),l[2]=Math.min(i[2],a[2]),l[3]=Math.min(i[3],a[3]),l},o.cH=function(l,i,a){return l[0]=Math.max(i[0],a[0]),l[1]=Math.max(i[1],a[1]),l[2]=Math.max(i[2],a[2]),l[3]=Math.max(i[3],a[3]),l},o.cI=function(l){const i=Math.round((l+45+360)%360/90)%4;return te[i]},o.cJ=$e,o.cK=li,o.cL=6,o.cM=function(l){const i=se(new Float64Array(16));K(i,l.pixelMatrix,l.globeMatrix);const a=[0,xe,0],u=[0,fe,0];return Bi(a,a,i),Bi(u,u,i),[a[0]>0&&a[0]<=l.width&&a[1]>0&&a[1]<=l.height&&!SN(l,new Se(l.center.lat,90)),u[0]>0&&u[0]<=l.width&&u[1]>0&&u[1]<=l.height&&!SN(l,new Se(l.center.lat,-90))]},o.cN=function(l,i){const{scale:a}=l.tileTransform,u=a*Bt/(l.tileSize*Math.pow(2,i.zoom-l.tileID.overscaledZ+l.tileID.canonical.z));return function(p,g,y){var v=g[1],T=g[2],N=g[3],I=y[0],P=y[1];return p[0]=g[0]*I,p[1]=v*I,p[2]=T*P,p[3]=N*P,p}(new Float32Array(4),i.inverseAdjustmentMatrix,[u,u])},o.cO=B1,o.cP=Ve,o.cQ=Vk,o.cR=function(l){const i=Vk(l,!0);return F([],[i[0],i[1],i[4],i[5]])},o.cS=Ae,o.cT=Dn,o.cU=Te,o.cV=function(l){const{x:i,y:a}=l.point,{lng:u,lat:p}=l._center;return mR(i,a,l.worldSize,u,p)},o.cW=tt,o.cX=Ze,o.cY=yg,o.cZ=oc,o.c_=5,o.ca=Jr,o.cb=function(l,i){return l[0]=-i[0],l[1]=-i[1],l[2]=-i[2],l[3]=i[3],l},o.cc=ke,o.cd=function(l,i,a,u,p){var g=1/Math.tan(i/2);if(l[0]=g/a,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=g,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[11]=-1,l[12]=0,l[13]=0,l[15]=0,p!=null&&p!==1/0){var y=1/(u-p);l[10]=(p+u)*y,l[14]=2*p*u*y}else l[10]=-1,l[14]=-2*u;return l},o.ce=function(l,i,a,u,p,g,y){var v=1/(i-a),T=1/(u-p),N=1/(g-y);return l[0]=-2*v,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=-2*T,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[10]=2*N,l[11]=0,l[12]=(i+a)*v,l[13]=(p+u)*T,l[14]=(y+g)*N,l[15]=1,l},o.cf=nt,o.cg=function(l,i,a){l[4*i+0]=a[0],l[4*i+1]=a[1],l[4*i+2]=a[2],l[4*i+3]=a[3]},o.ch=$o,o.ci=vm,o.cj=es,o.ck=Go,o.cl=Sh,o.cm=YD,o.cn=function(){var l=new R(4);return R!=Float32Array&&(l[1]=0,l[2]=0),l[0]=1,l[3]=1,l},o.co=function(l,i,a){var u=i[0],p=i[1],g=i[2],y=i[3],v=Math.sin(a),T=Math.cos(a);return l[0]=u*T+g*v,l[1]=p*T+y*v,l[2]=u*-v+g*T,l[3]=p*-v+y*T,l},o.cp=function(l,i){return l[0]===i[0]&&l[1]===i[1]&&l[2]===i[2]&&l[3]===i[3]},o.cq=Gn,o.cr=function(l){var i=l[0],a=l[1],u=l[2],p=l[3];return Math.sqrt(i*i+a*a+u*u+p*p)},o.cs=di,o.ct=$r,o.cu=oR,o.cv=3,o.cw=2,o.cx=7,o.cy=6,o.cz=Ii,o.d=function(l){return ns.API_TILEJSON_REGEX.test(l)},o.d$=class{constructor(l,i,a,u){this.context=l,this.format=u,this.size=a,this.texture=l.gl.createTexture();const[p,g,y]=this.size,{gl:v}=l;v.bindTexture(v.TEXTURE_3D,this.texture),l.pixelStoreUnpackFlipY.set(!1),l.pixelStoreUnpack.set(1),l.pixelStoreUnpackPremultiplyAlpha.set(!1),"data"in i&&i.data&&v.texImage3D(v.TEXTURE_3D,0,this.format,p,g,y,0,KN(this.format),QN(this.format),i.data)}bind(l,i){const{context:a}=this,{gl:u}=a;u.bindTexture(u.TEXTURE_3D,this.texture),l!==this.minFilter&&(u.texParameteri(u.TEXTURE_3D,u.TEXTURE_MAG_FILTER,l),u.texParameteri(u.TEXTURE_3D,u.TEXTURE_MIN_FILTER,l),this.minFilter=l),i!==this.wrapS&&(u.texParameteri(u.TEXTURE_3D,u.TEXTURE_WRAP_S,i),u.texParameteri(u.TEXTURE_3D,u.TEXTURE_WRAP_T,i),this.wrapS=i)}destroy(){const{gl:l}=this.context;l.deleteTexture(this.texture),this.texture=null}},o.d0=function(l){return l*l*l*l*l},o.d1=Ye,o.d2=45,o.d3=fg,o.d4=function(l,i,a){const u=Math.sqrt(l*l+i*i+a*a),p=u>0?Math.acos(a/u)*Xr:0;let g=l!==0||i!==0?Math.atan2(-i,-l)*Xr+90:0;return g<0&&(g+=360),[u,g,p]},o.d5=Le,o.d6=gn,o.d7=Rt,o.d8=Pe,o.d9=jr,o.dA=function(l){return l({pluginStatus:Fa,pluginURL:bu}),Yx.on("pluginStateChange",l),l},o.dB=x1,o.dC=class extends Il{constructor(l){super(l),this.current=tR}set(l,i,a){if(this.fetchUniformLocation(l,i)){for(let u=0;u<9;u++)if(a[u]!==this.current[u]){this.current=a,this.gl.uniformMatrix3fv(this.location,!1,a);break}}}},o.dD=pe,o.dE=function(l,i,a){const u=Ah(a.zoom),p=l.style.map._antialias,g=l.terrain&&l.terrain.exaggeration()>0;return u===0&&!p&&!g},o.dF=function(l){const i=l.pixelsPerMeter,a=i/nt(1,l.center.lat),u=se(new Float64Array(16));return ge(u,u,[l.point.x,l.point.y,0]),Ae(u,u,[a,a,i]),Float32Array.from(u)},o.dG=b1,o.dH=function(l){const i=80.051129;l=Ie(l,-80.051129,i)/i*90;const a=Math.pow(Math.abs(Math.sin(Zi(l))),3);return Math.round(a*(_e.length-1))},o.dI=function(l,i,a,u){const p=i.getNorth(),g=i.getSouth(),y=i.getWest(),v=i.getEast(),T=1<<l.z,N=v-y,I=p-g,P=N/ce,j=-I/_e[a],O=[0,P,0,j,0,0,p,y,0];if(l.z>0){const L=180/u;H(O,O,[L/N+1,0,0,0,L/I+1,0,-.5*L/P,.5*L/j,1])}return O[2]=T,O[5]=l.x,O[8]=l.y,O},o.dJ=Nu,o.dK=function(l,i,a){const u=se(new Float64Array(16)),p=(i/(1<<l)-.5)*Math.PI*2;return Ce(u,a.globeMatrix,p),Float32Array.from(u)},o.dL=CR,o.dM=v1,o.dN=function(l,i){return[Math.pow(l[0],2.2)*i,Math.pow(l[1],2.2)*i,Math.pow(l[2],2.2)*i]},o.dO=$,o.dP=function(l,i){var a=Math.sin(i),u=Math.cos(i);return l[0]=u,l[1]=a,l[2]=0,l[3]=-a,l[4]=u,l[5]=0,l[6]=0,l[7]=0,l[8]=1,l},o.dQ=Ki,o.dR=pR,o.dS=yn,o.dT=Es,o.dU=256,o.dV=function(l,i){const a=[0,0,0];return Bi(a,a,S1(Nu(i.canonical))),Bi(a,a,l),a},o.dW=l=>({u_matrix:new Sh(l),u_texsize:new Go(l),u_pixels_to_tile_units:new s(l),u_device_pixel_ratio:new es(l),u_width_scale:new es(l),u_floor_width_scale:new es(l),u_image:new $o(l),u_units_to_pixels:new Go(l),u_tile_units_to_pixels:new es(l),u_alpha_discard_threshold:new es(l),u_trim_offset:new Go(l),u_trim_fade_range:new Go(l),u_trim_gradient_mix_range:new Go(l),u_trim_color:new fg(l),u_zbias_factor:new es(l),u_tile_to_meter:new es(l),u_ground_shadow_factor:new vm(l),u_pattern_transition:new es(l)}),o.dX=l=>({u_matrix:new Sh(l),u_pixels_to_tile_units:new s(l),u_device_pixel_ratio:new es(l),u_width_scale:new es(l),u_floor_width_scale:new es(l),u_units_to_pixels:new Go(l),u_dash_image:new $o(l),u_gradient_image:new $o(l),u_image_height:new es(l),u_texsize:new Go(l),u_tile_units_to_pixels:new es(l),u_alpha_discard_threshold:new es(l),u_trim_offset:new Go(l),u_trim_fade_range:new Go(l),u_trim_gradient_mix_range:new Go(l),u_trim_color:new fg(l),u_zbias_factor:new es(l),u_tile_to_meter:new es(l),u_ground_shadow_factor:new vm(l)}),o.dY=l=>({u_camera_to_center_distance:new es(l),u_extrude_scale:new s(l),u_device_pixel_ratio:new es(l),u_matrix:new Sh(l),u_inv_rot_matrix:new Sh(l),u_merc_center:new Go(l),u_tile_id:new vm(l),u_zoom_transition:new es(l),u_up_dir:new vm(l),u_emissive_strength:new es(l)}),o.dZ=ug,o.d_=s9,o.da=It,o.db=function(l){return[Math.pow(l[0],1/2.2),Math.pow(l[1],1/2.2),Math.pow(l[2],1/2.2)]},o.dc=Bk,o.dd=sA,o.de=Gk,o.df=jA,o.dg=function(l,i){return l.readFields(r$,{icons:[]},i)},o.dh=O1,o.di=Pg,o.dj=xA,o.dk=Wl,o.dl=Gb,o.dm=Tl,o.dn=La,o.dp=zi,o.dq=function(l){const i=l.indexOf(um);return i>=0?l.slice(0,i):l},o.dr=function(l){return l.indexOf(um)>=0},o.ds=function(l){const i=l.lastIndexOf(um);return i>=0?l.slice(i+1):""},o.dt=function(l){const i=[],a=l.id;return a===void 0&&i.push({message:`layers.${a}: missing required property "id"`}),l.render===void 0&&i.push({message:`layers.${a}: missing required method "render"`}),l.renderingMode&&l.renderingMode!=="2d"&&l.renderingMode!=="3d"&&i.push({message:`layers.${a}: property "renderingMode" must be either "2d" or "3d"`}),i},o.du=function(l,i,a,u){return l.type==="custom"?new K9(l,i):new i$[l.type](l,i,a,u)},o.dv=wi,o.dw=function(l){const i=l.indexOf(um);return i>=0?l.slice(i+1):""},o.dx=class extends jm{constructor(l,i){super(l._vectorTileFeature,l._z,l._x,l._y,l.id),l.state&&(this.state=Object.assign({},l.state)),this.target=i.target,this.namespace=i.namespace,i.properties&&(this.properties=i.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=l.source,this.sourceLayer=l.sourceLayer,this.layer=l.layer)}toJSON(){const l=super.toJSON();return l.target=this.target,l.namespace=this.namespace,l}},o.dy=Yx,o.dz=xo,o.e=ns,o.e$=Ke,o.e0=yR,o.e1=(l,i,a,u,p,g)=>{const y=l.transform,v=y.projection.name==="globe";let T;if(g.paint.get("circle-pitch-alignment")==="map")if(v){const I=pR(y.zoom,i.canonical)*y._pixelsPerMercatorPixel;T=Float32Array.from([I,0,0,I])}else T=y.calculatePixelsToTileUnitsMatrix(a);else T=new Float32Array([y.pixelsToGLUnits[0],0,0,y.pixelsToGLUnits[1]]);const N={u_camera_to_center_distance:l.transform.getCameraToCenterDistance(y.projection),u_matrix:l.translatePosMatrix(i.projMatrix,a,g.paint.get("circle-translate"),g.paint.get("circle-translate-anchor")),u_device_pixel_ratio:xa.devicePixelRatio,u_extrude_scale:T,u_inv_rot_matrix:dq,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:g.paint.get("circle-emissive-strength")};if(v){N.u_inv_rot_matrix=u,N.u_merc_center=p,N.u_tile_id=[i.canonical.x,i.canonical.y,1<<i.canonical.z],N.u_zoom_transition=Ah(y.zoom);const I=p[0]*Bt,P=p[1]*Bt;N.u_up_dir=y.projection.upVector(new wm(0,0,0),I,P)}return N},o.e2=oD,o.e3=Cn,o.e4=(l,i,a,u,p,g,y,v,T,N)=>{const I=l.transform,P=I.pitch<15?nD(.07,.7,Ie((14-I.zoom)/5,0,1)):.07,j=a.paint.get("line-trim-color-use-theme").constantOr("default")==="none";return{u_matrix:aD(l,i,a,u),u_texsize:i.imageAtlasTexture?i.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:I.calculatePixelsToTileUnitsMatrix(i),u_device_pixel_ratio:p,u_width_scale:g,u_floor_width_scale:y,u_image:0,u_tile_units_to_pixels:sD(i,I),u_units_to_pixels:[1/I.pixelsToGLUnits[0],1/I.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:v,u_trim_fade_range:a.paint.get("line-trim-fade-range"),u_trim_gradient_mix_range:[1,1],u_trim_color:a.paint.get("line-trim-color").toPremultipliedRenderColor(j?null:a.lut).toArray01(),u_zbias_factor:P,u_tile_to_meter:Rt(i.tileID.canonical,0),u_ground_shadow_factor:T,u_pattern_transition:N}},o.e5=(l,i,a,u,p,g,y,v,T,N)=>{const I=l.transform,P=I.calculatePixelsToTileUnitsMatrix(i),j=a.paint.get("line-trim-color-use-theme").constantOr("default")==="none",O=I.pitch<15?nD(.07,.7,Ie((14-I.zoom)/5,0,1)):.07;return{u_matrix:aD(l,i,a,u),u_pixels_to_tile_units:P,u_device_pixel_ratio:g,u_width_scale:y,u_floor_width_scale:v,u_units_to_pixels:[1/I.pixelsToGLUnits[0],1/I.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:p,u_texsize:lD(a)&&i.lineAtlasTexture?i.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:sD(i,l.transform),u_alpha_discard_threshold:0,u_trim_offset:T,u_trim_fade_range:a.paint.get("line-trim-fade-range"),u_trim_gradient_mix_range:[1,1],u_trim_color:a.paint.get("line-trim-color").toPremultipliedRenderColor(j?null:a.lut).toArray01(),u_zbias_factor:O,u_tile_to_meter:Rt(i.tileID.canonical,0),u_ground_shadow_factor:N}},o.e6=St,o.e7=v_,o.e8=rt,o.e9=nq,o.eA=function(l,i){var a=2*Math.acos(i[3]),u=Math.sin(a/2);return u>C?(l[0]=i[0]/u,l[1]=i[1]/u,l[2]=i[2]/u):(l[0]=1,l[1]=0,l[2]=0),a},o.eB=DA,o.eC=q1,o.eD=U1,o.eE=[1,1,1],o.eF=Dg,o.eG=ar,o.eH=function(l,i,a,u){var p=i[0],g=i[1],y=i[2],v=i[3];return l[0]=p+u*(a[0]-p),l[1]=g+u*(a[1]-g),l[2]=y+u*(a[2]-y),l[3]=v+u*(a[3]-v),l},o.eI=Ag,o.eJ=qo,o.eK=yd,o.eL=function(l,i,a,u,p,g,y,v,T,N,I,P,j,O,L,U){var Z=new R(16);return Z[0]=l,Z[1]=i,Z[2]=a,Z[3]=u,Z[4]=p,Z[5]=g,Z[6]=y,Z[7]=v,Z[8]=T,Z[9]=N,Z[10]=I,Z[11]=P,Z[12]=j,Z[13]=O,Z[14]=L,Z[15]=U,Z},o.eM=Oe,o.eN=pm,o.eO=p_,o.eP=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new wt(1/0,1/0),max:new wt(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(l,i=!1){const a=KR(new wt(0,0),new wt(Bt,Bt),l),u=[];if(i&&!zN(a,this._globalClipBounds))return u;for(const p of this._activeRegions){if(p.hiddenByOverlap||!zN(a,p))continue;const g=Wq(p.min,p.max,l);u.push({min:g.min,max:g.max,sourceId:this._sourceIds[p.priority],footprint:p.footprint,footprintTileId:p.tileId,order:p.order,clipMask:p.clipMask,clipScope:p.clipScope})}return u}setSources(l){this._setSources(l.map(i=>({getSourceId:()=>i.cache.id,getFootprints:()=>{const a=[];for(const u of i.cache.getVisibleCoordinates()){const p=i.cache.getTile(u).buckets[i.layer];p&&p.updateFootprints(u.toUnwrapped(),a)}return a},getOrder:()=>i.order,getClipMask:()=>i.clipMask,getClipScope:()=>i.clipScope})))}_addSource(l){const i=l.getFootprints();if(i.length===0)return;const a=l.getOrder(),u=l.getClipMask(),p=l.getClipScope();for(const g of i){if(!g.footprint)continue;const y=KR(g.footprint.min,g.footprint.max,g.id);this._activeRegions.push({min:y.min,max:y.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:g.id,footprint:g.footprint,order:a,clipMask:u,clipScope:p})}this._sourceIds.push(l.getSourceId())}_computeReplacement(){this._activeRegions.sort((i,a)=>i.priority-a.priority||j1(i.min,a.min)||j1(i.max,a.max)||i.order-a.order||i.clipMask-a.clipMask||function(u,p){const g=(y,v)=>y+v;return u.length-p.length||u.reduce(g,"").localeCompare(p.reduce(g,""))}(i.clipScope,a.clipScope));let l=this._activeRegions.length!==this._prevRegions.length;if(!l){let i=0;for(;!l&&i!==this._activeRegions.length;){const a=this._activeRegions[i],u=this._prevRegions[i];l=a.priority!==u.priority||!YR(a,u)||a.order!==u.order||a.clipMask!==u.clipMask||!Xa(a.clipScope,u.clipScope),this._activeRegions[i].hiddenByOverlap=u.hiddenByOverlap,++i}}if(l){++this._updateTime;for(const a of this._activeRegions)a.order!==E_&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,a.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,a.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,a.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,a.max.y));const i=a=>{const u=this._activeRegions;if(a>=u.length)return a;const p=u[a].priority;for(;a<u.length&&u[a].priority===p;)++a;return a};if(this._sourceIds.length>1){let a=0,u=i(a);for(;a!==u;){let p=a;const g=a;for(;p!==u;){const y=this._activeRegions[p];y.hiddenByOverlap=!1;for(let v=0;v<g;v++){const T=this._activeRegions[v];if(!T.hiddenByOverlap&&y.order===E_&&zN(y,T)&&(y.hiddenByOverlap=QR(y.footprint,y.tileId,T.footprint,T.tileId),y.hiddenByOverlap))break}++p}a=u,u=i(a)}}}}_setSources(l){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let i=l.length-1;i>=0;i--)this._addSource(l[i]);this._computeReplacement()}},o.eQ=E_,o.eR=class{constructor(l){this._createGrid(l),this._createPoles(l)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const l of this._poleSegments)l.destroy();for(const l of this._gridSegments)l.withSkirts.destroy(),l.withoutSkirts.destroy()}_fillGridMeshWithLods(l,i){const a=new Su,u=new ys,p=[],g=l+1+2,y=i[0]+1,v=i[0]+1+(1+i.length),T=(N,I,P)=>{let j=N===g-1?N-2:N===0?N:N-1;return j+=P?24575:0,[j,I]};for(let N=0;N<g;++N)a.emplaceBack(...T(N,0,!0));for(let N=0;N<y;++N)for(let I=0;I<g;++I)a.emplaceBack(...T(I,N,(I===0||I===g-1)&&!0));for(let N=0;N<i.length;++N){const I=i[N];for(let P=0;P<g;++P)a.emplaceBack(...T(P,I,!0))}for(let N=0;N<i.length;++N){const I=u.length,P=i[N]+1+2,j=new ys;for(let U=0;U<P-1;U++){const Z=U===P-2,G=Z?g*(v-i.length+N-U):g;for(let ee=0;ee<g-1;ee++){const le=U*g+ee;U===0||Z||ee===0||ee===g-2?(j.emplaceBack(le+1,le,le+G),j.emplaceBack(le+G,le+G+1,le+1)):(u.emplaceBack(le+1,le,le+G),u.emplaceBack(le+G,le+G+1,le+1))}}const O=dn.simpleSegment(0,I,a.length,u.length-I);for(let U=0;U<j.uint16.length;U+=3)u.emplaceBack(j.uint16[U],j.uint16[U+1],j.uint16[U+2]);const L=dn.simpleSegment(0,I,a.length,u.length-I);p.push({withoutSkirts:O,withSkirts:L})}return{vertices:a,indices:u,segments:p}}_createGrid(l){const i=this._fillGridMeshWithLods(ce,_e);this._gridSegments=i.segments,this._gridBuffer=l.createVertexBuffer(i.vertices,lR.members),this._gridIndexBuffer=l.createIndexBuffer(i.indices,!0)}_createPoles(l){const i=new ys;for(let y=0;y<=ce;y++)i.emplaceBack(0,y+1,y+2);this._poleIndexBuffer=l.createIndexBuffer(i,!0);const a=new gd,u=new gd,p=new gd,g=new gd;this._poleSegments=[];for(let y=0,v=0;y<5;y++){const T=360/(1<<y);a.emplaceBack(0,-J,0,.5,0),u.emplaceBack(0,-J,0,.5,1),p.emplaceBack(0,-J,0,.5,.5),g.emplaceBack(0,-J,0,.5,.5);for(let N=0;N<=ce;N++){let I=N/ce,P=0;const j=Si(0,T,I),[O,L,U]=Fe(cq,uq,j,J);a.emplaceBack(O,L,U,I,P),u.emplaceBack(O,L,U,I,1-P);const Z=Zi(j);I=.5+.5*Math.sin(Z),P=.5+.5*Math.cos(Z),p.emplaceBack(O,L,U,I,P),g.emplaceBack(O,L,U,I,1-P)}this._poleSegments.push(dn.simpleSegment(v,0,66,64)),v+=66}this._poleNorthVertexBuffer=l.createVertexBuffer(a,_1,!1),this._poleSouthVertexBuffer=l.createVertexBuffer(u,_1,!1),this._texturedPoleNorthVertexBuffer=l.createVertexBuffer(p,_1,!1),this._texturedPoleSouthVertexBuffer=l.createVertexBuffer(g,_1,!1)}getGridBuffers(l,i){return[this._gridBuffer,this._gridIndexBuffer,i?this._gridSegments[l].withSkirts:this._gridSegments[l].withoutSkirts]}getPoleBuffers(l,i){return[i?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,i?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[l]]}},o.eS=Hq,o.eT=Ne,o.eU=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},o.eV=Ue,o.eW=Ct,o.eX=function(l,i,a){return l[0]=i[0]/a[0],l[1]=i[1]/a[1],l[2]=i[2]/a[2],l},o.eY=jt,o.eZ=De,o.e_=ht,o.ea=D1,o.eb=hk,o.ec=bd,o.ed=450,o.ee=7,o.ef=ot,o.eg=function(l,i){if(l===i){var a=i[1],u=i[2],p=i[3],g=i[6],y=i[7],v=i[11];l[1]=i[4],l[2]=i[8],l[3]=i[12],l[4]=a,l[6]=i[9],l[7]=i[13],l[8]=u,l[9]=g,l[11]=i[14],l[12]=p,l[13]=y,l[14]=v}else l[0]=i[0],l[1]=i[4],l[2]=i[8],l[3]=i[12],l[4]=i[1],l[5]=i[5],l[6]=i[9],l[7]=i[13],l[8]=i[2],l[9]=i[6],l[10]=i[10],l[11]=i[14],l[12]=i[3],l[13]=i[7],l[14]=i[11],l[15]=i[15];return l},o.eh=Y9,o.ei=sr,o.ej=g_,o.ek=256,o.el=bN,o.em=pl,o.en=Ce,o.eo=function(l,i){return l[0]=i[0],l[1]=i[1],l[2]=i[2],l[3]=i[4],l[4]=i[5],l[5]=i[6],l[6]=i[8],l[7]=i[9],l[8]=i[10],l},o.ep=gd,o.eq=Tb,o.er=pg,o.es=function(l,i,a,u,p){return Ie((l-i)/(a-i)*(p-u)+u,u,p)},o.et=Nr,o.eu=function(l,i){var a=i[0],u=i[1],p=i[2],g=i[3],y=i[4],v=i[5],T=i[6],N=i[7],I=i[8],P=I*y-v*N,j=-I*g+v*T,O=N*g-y*T,L=a*P+u*j+p*O;return L?(l[0]=P*(L=1/L),l[1]=(-I*u+p*N)*L,l[2]=(v*u-p*y)*L,l[3]=j*L,l[4]=(I*a-p*T)*L,l[5]=(-v*a+p*g)*L,l[6]=O*L,l[7]=(-N*a+u*T)*L,l[8]=(y*a-u*g)*L,l):null},o.ev=2,o.ew=hi,o.ex=fi,o.ey=oe,o.ez=function(l,i){var a=new R(3);oe(a,i);var u=1/a[0],p=1/a[1],g=1/a[2],y=i[0]*u,v=i[1]*p,T=i[2]*g,N=i[4]*u,I=i[5]*p,P=i[6]*g,j=i[8]*u,O=i[9]*p,L=i[10]*g,U=y+I+L,Z=0;return U>0?(Z=2*Math.sqrt(U+1),l[3]=.25*Z,l[0]=(P-O)/Z,l[1]=(j-T)/Z,l[2]=(v-N)/Z):y>I&&y>L?(Z=2*Math.sqrt(1+y-I-L),l[3]=(P-O)/Z,l[0]=.25*Z,l[1]=(v+N)/Z,l[2]=(j+T)/Z):I>L?(Z=2*Math.sqrt(1+I-y-L),l[3]=(j-T)/Z,l[0]=(v+N)/Z,l[1]=.25*Z,l[2]=(P+O)/Z):(Z=2*Math.sqrt(1+L-y-I),l[3]=(v-N)/Z,l[0]=(j+T)/Z,l[1]=(P+O)/Z,l[2]=.25*Z),l},o.f=function(l){return btoa(encodeURIComponent(l).replace(/%([0-9A-F]{2})/g,(i,a)=>String.fromCharCode(+("0x"+a))))},o.f0=function([l,i,a]){const u=Math.hypot(l,i,a),p=Math.atan2(l,a),g=.5*Math.PI-Math.acos(-i/u);return new Se(Ze(p),Ze(g))},o.f1=ai,o.f2=eA,o.f3=function(l){const i=l.navigator?l.navigator.userAgent:null;return!!function(a){if(cr==null){const u=a.navigator?a.navigator.userAgent:null;cr=!!a.safari||!(!u||!(/\b(iPad|iPhone|iPod)\b/.test(u)||u.match("Safari")&&!u.match("Chrome")))}return cr}(l)&&!(!i||!(i.match("Version/15.4")||i.match("Version/15.5")||i.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/)))},o.f4=function(l,i){zp=l,Bp=i},o.f5=SN,o.f6=fR,o.f7=function(l){const i=[0,0,0],a=se(new Float64Array(16));return K(a,l.pixelMatrix,l.globeMatrix),Bi(i,i,a),new wt(i[0],i[1])},o.f8=function(){const l=D_;l&&(l.isPreloaded()&&l.numActive()===1?(l.release(GN),D_=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},o.f9=function(){O1().acquire(GN)},o.fA=mw,o.fB=lr,o.fC=function(l){let i=0;if(new Uint32Array(l,0,1)[0]!==Mk){const a=new Uint32Array(l,0,7),[,,u,p,g,y]=a;i=a.byteLength+p+g+y+g,(u!==l.byteLength||i>=l.byteLength)&&Ni("Invalid b3dm header information.")}return zk(l,i)},o.fD=function(l,i){const a=sA(l);for(const u of a){for(const p of u.meshes)C8(p);u.lights&&(u.lightMeshIndex=u.meshes.length,u.meshes.push(E8(u.lights,i)))}return a},o.fE=cw,o.fF=Rn,o.fG=Tk,o.fH=El,o.fI=io,o.fJ=function(l){js(),Ps!=null&&Ps.then(i=>{i.keys().then(a=>{for(let u=0;u<a.length-l;u++)i.delete(a[u]).catch(p=>Ni(p.message))}).catch(a=>Ni(a.message))}).catch(i=>Ni(i.message))},o.fa=Kx,o.fb=function(l,i,a=!1){if(Fa===io.deferred||Fa===io.loading||Fa===io.loaded)throw new Error("setRTLTextPlugin cannot be called multiple times.");bu=xa.resolveURL(l),Fa=io.deferred,vu=i,Xx(),a||Qx()},o.fc=function(l){Sg=xa.resolveURL(l),Tg||(Tg=new wg(O1(),new zo)),Tg.broadcast("setMeshoptUrl",Sg)},o.fd=Ck,o.fe=function(l){ZN=xa.resolveURL(l),Tg||(Tg=new wg(O1(),new zo)),Tg.broadcast("setDracoUrl",ZN)},o.ff=Ak,o.fg=k_,o.fh=function(l){const i=Ka();if(!i)return;const a=i.delete(Sf);l&&a.then(()=>l()).catch(l)},o.fi=Nm,o.fj=Yt,o.fk=Ch,o.fl=2,o.fm=eO,o.fn=tO,o.fo=eD,o.fp=ur,o.fq="hd_road_elevation",o.fr=no,o.fs=ci,o.ft=vd,o.fu=yA,o.fv=1,o.fw=function(l,i,a,u,p,g,y,v=1,T,N,I,P){l.createArrays(),l.tilePixelRatio=Bt/(512*l.overscaling),l.compareText={},l.iconsNeedLinear=!1;const j=l.layers[0].layout,O=l.layers[0]._unevaluatedLayout._values,L={};L.scaleFactor=v,L.textSizeScaleRange=j.get("text-size-scale-range"),L.iconSizeScaleRange=j.get("icon-size-scale-range");const[U,Z]=L.textSizeScaleRange,[G,ee]=L.iconSizeScaleRange;L.textScaleFactor=Ie(L.scaleFactor,U,Z),L.iconScaleFactor=Ie(L.scaleFactor,G,ee);const le=O["text-size"],me=O["icon-size"];if(l.textSizeData.kind==="composite"){const{minZoom:Be,maxZoom:Ge}=l.textSizeData;L.compositeTextSizes=[le.possiblyEvaluate(new Vr(Be,{worldview:I}),g),le.possiblyEvaluate(new Vr(Ge,{worldview:I}),g)]}if(l.iconSizeData.kind==="composite"){const{minZoom:Be,maxZoom:Ge}=l.iconSizeData;L.compositeIconSizes=[me.possiblyEvaluate(new Vr(Be,{worldview:I}),g,P),me.possiblyEvaluate(new Vr(Ge,{worldview:I}),g,P)]}L.layoutTextSize=le.possiblyEvaluate(new Vr(y+1,{worldview:I}),g),L.layoutIconSize=me.possiblyEvaluate(new Vr(y+1,{worldview:I}),g,P),L.textMaxSize=le.possiblyEvaluate(new Vr(18,{worldview:I}),g);const we=j.get("symbol-placement"),be=j.get("text-rotation-alignment")==="map"&&we!=="point",Re=j.get("text-size");let Me=!1;const je=[];for(const Be of l.features){const Ge=j.get("text-font").evaluate(Be,{},g).join(","),ut=Re.evaluate(Be,{},g)*L.textScaleFactor,lt=L.layoutTextSize.evaluate(Be,{},g)*L.textScaleFactor,ct=L.layoutIconSize.evaluate(Be,{},g,P)*L.iconScaleFactor,xt={horizontal:{},vertical:void 0},gt=Be.text;let yt,st=[0,0];if(gt){const fr=gt.toString(),Bn=j.get("text-letter-spacing").evaluate(Be,{},g)*Bs,_r=j.get("text-line-height").evaluate(Be,{},g)*Bs,Mr=uN(fr)?Bn:0,ln=j.get("text-anchor").evaluate(Be,{},g),vn=j.get("text-variable-anchor");if(!vn){const os=j.get("text-radial-offset").evaluate(Be,{},g);if(os)st=OD(ln,[os*Bs,vA]);else{const _s=j.get("text-offset").evaluate(Be,{},g);st=[_s[0]*Bs,_s[1]*Bs]}}let bn=be?"center":j.get("text-justify").evaluate(Be,{},g);const Vn=we==="point",Js=Vn?j.get("text-max-width").evaluate(Be,{},g)*Bs:1/0,Sa=os=>{l.allowVerticalPlacement&&Wx(fr)&&(xt.vertical=hA(gt,i,a,p,Ge,Js,_r,ln,os,Mr,st,Xo.vertical,!0,lt,ut,T))};if(!be&&vn){const os=bn==="auto"?vn.map(Rs=>bA(Rs)):[bn];let _s=!1;for(let Rs=0;Rs<os.length;Rs++){const Xi=os[Rs];if(!xt.horizontal[Xi])if(_s)xt.horizontal[Xi]=xt.horizontal[0];else{const wn=hA(gt,i,a,p,Ge,Js,_r,"center",Xi,Mr,st,Xo.horizontal,!1,lt,ut,T);wn&&(xt.horizontal[Xi]=wn,_s=wn.positionedLines.length===1)}}Sa("left")}else{if(bn==="auto"&&(bn=bA(ln)),Vn||j.get("text-writing-mode").indexOf("horizontal")>=0||!Wx(fr)){const os=hA(gt,i,a,p,Ge,Js,_r,ln,bn,Mr,st,Xo.horizontal,!1,lt,ut,T);os&&(xt.horizontal[bn]=os)}Sa(Vn?"left":bn)}}let bt,mt,Tt,_t,Zt,Xt,Ft=!1;const Vt=j.get("icon-text-fit").evaluate(Be,{},g);if(Be.icon&&Be.icon.hasPrimary()){const fr=$_(Be.icon,l.iconSizeData,O["icon-size"],g,l.zoom,Be,T,L.iconScaleFactor,I,P);bt=fr.iconPrimary,Tt=fr.iconSecondary;const Bn=bt.toString();if(mt=u.get(Bn),mt&&(Zt=j.get("icon-offset").evaluate(Be,{},g),Xt=j.get("icon-anchor").evaluate(Be,{},g),yt=Z1(p.get(Bn),Tt?p.get(Tt.toString()):void 0,Zt,Xt),Ft=mt.sdf,l.sdfIcons===void 0?l.sdfIcons=mt.sdf:l.sdfIcons!==mt.sdf&&Ni("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(mt.pixelRatio!==l.pixelRatio||j.get("icon-rotate").constantOr(1)!==0)&&(l.iconsNeedLinear=!0)),Tt){const _r=Tt.toString();_t=u.get(_r)}}Me=Me||!(!Be.icon||!Be.icon.hasSecondary());const xi=J1(xt.horizontal)||xt.vertical;l.iconsInText||(l.iconsInText=!!xi&&xi.iconsInText);const ri=lt*L.textScaleFactor/Bs,{defaultShapedIcon:Gt,verticallyShapedIcon:Ri}=O9(l,yt,j,Be,g,xt,ri,Zt,Vt);Vt!=="none"&&yt&&(vD(yt)||bD(yt))&&(Q1(0,mt,bt,yt,Gt,Vt,N,u,p),Q1(0,_t,Tt,yt,Gt,Vt,N,u,p),Ri&&(Q1(0,mt,bt,yt,Ri,Vt,N,u,p),Q1(0,_t,Tt,yt,Ri,Vt,N,u,p))),yt=Gt;const{iconBBox:tr,iconVerticalBBox:Cr,textBBox:Qi,textVerticalBBox:Ur}=j9(l,yt,Ri,j,Be,g,ct,Zt,L,p,Xt,xt,lt,st,P);je.push({feature:Be,shapedTextOrientations:xt,shapedText:xi,shapedIcon:yt,iconPrimary:bt,iconSecondary:Tt,iconOffset:Zt,iconAnchor:Xt,verticallyShapedIcon:Ri,layoutTextSize:lt,layoutIconSize:ct,textOffset:st,isSDFIcon:Ft,iconTextFit:Vt,iconCollisionBounds:tr,iconVerticalCollisionBounds:Cr,textCollisionBounds:Qi,textVerticalCollisionBounds:Ur})}return{featureData:je,sizes:L,hasAnySecondaryIcon:Me,textAlongLine:be,symbolPlacement:we}},o.fx=ID,o.fy=function(l,i,a,u,p,g,y,v,T,N){l.iconAtlasPositions=N.iconPositions;const{featureData:I,hasAnySecondaryIcon:P,sizes:j,textAlongLine:O,symbolPlacement:L}=i;for(const U of I){const{shapedIcon:Z,verticallyShapedIcon:G,feature:ee,shapedTextOrientations:le,shapedText:me,layoutTextSize:we,textOffset:be,isSDFIcon:Re,iconPrimary:Me,iconSecondary:je,iconTextFit:Be,iconOffset:Ge,iconCollisionBounds:ut,iconVerticalCollisionBounds:lt,textCollisionBounds:ct}=U;BD(Z,N.iconPositions,Me,je),BD(G,N.iconPositions,Me,je),M9(le,N.iconPositions),D9(Me,je,N.iconPositions),(me||Z)&&L9(l,ee,le,Z,G,T,j,we,0,be,Re,u,p,y,v,P,Be,Ge,O,L,ut,lt,ct)}a&&l.generateCollisionDebugBuffers(g,l.collisionBoxArray,j.textScaleFactor)},o.fz=Rr,o.g=function(l,i){return xo(Object.assign(l,{method:"GET"}),i)},o.h=function(l){return l.indexOf("mapbox:")===0},o.i=function(l){return ns.API_STYLE_REGEX.test(l)&&!Zs(l)},o.j=wl,o.k=wc,o.l=function(l){return decodeURIComponent(atob(l).split("").map(i=>"%"+("00"+i.charCodeAt(0).toString(16)).slice(-2)).join(""))},o.m=function(l,i){return xo(Object.assign(l,{type:"json"}),i)},o.n=Yn,o.o=xa,o.p=function(l,i){return xo(Object.assign(l,{method:"POST"}),i)},o.q=wa,o.r=xn,o.s=function(l){try{const i=self[l];return i.setItem("_mapbox_test_",1),i.removeItem("_mapbox_test_"),!0}catch{return!1}},o.t=function(){return HN||(HN=new Nm("ImageRasterizer")),HN},o.u=function(){return function l(i){return i?(i^Math.random()*(16>>i/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,l)}()},o.v=function(l){return!!l&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(l)},o.w=Ni,o.x=FA,o.y=nd,o.z=ul}),x(["./shared"],function(o){function C(Ze){const te=Ze?Ze.url.toString():void 0;return te?performance.getEntriesByName(te):[]}function R(Ze){if(typeof Ze=="number"||typeof Ze=="boolean"||typeof Ze=="string"||Ze==null)return JSON.stringify(Ze);if(Array.isArray(Ze)){let pe="[";for(const Ne of Ze)pe+=`${R(Ne)},`;return`${pe}]`}let te="{";for(const pe of Object.keys(Ze).sort())te+=`${pe}:${R(Ze[pe])},`;return`${te}}`}function F(Ze){let te="";for(const pe of o.bx)te+=`/${R(Ze[pe])}`;return te}function $(Ze,te){return function pe(Ne){return typeof Ne=="string"&&Ne===te||(Array.isArray(Ne)?Ne.some(pe):!(!Ne||typeof Ne!="object")&&Object.values(Ne).some(pe))}(Ze)}class Y{constructor(te){this.keyCache={},this._layers={},this._layerConfigs={},te&&this.replace(te)}replace(te,pe){this._layerConfigs={},this._layers={},this.update(te,[],pe)}update(te,pe,Ne){this._options=Ne;for(const Ie of te)this._layerConfigs[Ie.id]=Ie,(this._layers[Ie.id]=o.du(Ie,this.scope,null,this._options)).compileFilter(Ne),this.keyCache[Ie.id]&&delete this.keyCache[Ie.id];for(const Ie of pe)delete this.keyCache[Ie],delete this._layerConfigs[Ie],delete this._layers[Ie];this.familiesBySource={};const Ue=function(Ie,Xe){const Je={};for(let it=0;it<Ie.length;it++){const At=Ie[it];let St=Xe&&Xe[At.id];St||(At.type==="symbol"?St=At.id:(St=F(At),At.type==="line"&&At.paint&&$(At.paint["line-width"],"line-progress")&&(St+=`/${R(At.paint["line-width"])}`))),Xe&&(Xe[At.id]=St);let Ht=Je[St];Ht||(Ht=Je[St]=[]),Ht.push(At)}const He=[];for(const it in Je)He.push(Je[it]);return He}(Object.values(this._layerConfigs),this.keyCache);for(const Ie of Ue){const Xe=Ie.map(Ht=>this._layers[Ht.id]),Je=Xe[0];if(Je.visibility==="none")continue;const He=Je.source||"";let it=this.familiesBySource[He];it||(it=this.familiesBySource[He]={});const At=Je.sourceLayer||"_geojsonTileLayer";let St=it[At];St||(St=it[At]=[]),St.push(Xe)}}}const H=1*o.fl;class X{constructor(te){const pe={},Ne=[];for(const Je in te){const He=te[Je],it=pe[Je]={};for(const At in He.glyphs){const St=He.glyphs[+At];if(!St||St.bitmap.width===0||St.bitmap.height===0)continue;const Ht=St.metrics.localGlyph?H:1,ci={x:0,y:0,w:St.bitmap.width+2*Ht,h:St.bitmap.height+2*Ht};Ne.push(ci),it[At]=ci}}const{w:Ue,h:Ie}=o.G(Ne),Xe=new o.fk({width:Ue||1,height:Ie||1});for(const Je in te){const He=te[Je];for(const it in He.glyphs){const At=He.glyphs[+it];if(!At||At.bitmap.width===0||At.bitmap.height===0)continue;const St=pe[Je][it],Ht=At.metrics.localGlyph?H:1;o.fk.copy(At.bitmap,Xe,{x:0,y:0},{x:St.x+Ht,y:St.y+Ht},At.bitmap)}}this.image=Xe,this.positions=pe}}function he(Ze,te,pe){Ze[te]?pe&&(Ze[te].center=pe):Ze[te]={floorIds:new Set,center:pe||[0,0],floors:{}}}function se(Ze,te,pe,Ne){for(const Ue of te)he(Ze,Ue),Ze[Ue].floors[pe]=Ne,Ze[Ue].floorIds.add(pe)}function de(Ze){return{id:Ze.properties.id.toString(),center:Ze.properties.center.toString().split(";").map(Number)}}function K(Ze){return{id:Ze.properties.id.toString(),isDefault:!!Ze.properties.is_default&&Ze.properties.is_default,connections:Ze.properties.connected_floor_ids?new Set(Ze.properties.connected_floor_ids.toString().split(";")):new Set,conflicts:Ze.properties.conflicted_floor_ids?new Set(Ze.properties.conflicted_floor_ids.toString().split(";")):new Set,buildings:Ze.properties.building_ids?new Set(Ze.properties.building_ids.toString().split(";")):new Set,name:Ze.properties.name.toString(),zIndex:Ze.properties.z_index}}function ge(Ze,te){return te.every(pe=>Ze.properties&&Ze.properties[pe]!=null)}function Ae(Ze){return ge(Ze,["type","id","name"])&&Ze.properties.type==="building"}function Te(Ze){return ge(Ze,["type","id","name","z_index"])&&Ze.properties.type==="floor"}o.fj(X,"GlyphAtlas");class Ce{constructor(te){this.tileID=new o.aQ(te.tileID.overscaledZ,te.tileID.wrap,te.tileID.canonical.z,te.tileID.canonical.x,te.tileID.canonical.y),this.tileZoom=te.tileZoom,this.uid=te.uid,this.zoom=te.zoom,this.lut=te.lut,this.canonical=te.tileID.canonical,this.pixelRatio=te.pixelRatio,this.tileSize=te.tileSize,this.source=te.source,this.scope=te.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=te.showCollisionBoxes,this.collectResourceTiming=!!te.request&&te.request.collectResourceTiming,this.promoteId=te.promoteId,this.isSymbolTile=te.isSymbolTile,this.tileTransform=o.aZ(te.tileID.canonical,te.projection),this.projection=te.projection,this.worldview=te.worldview,this.localizableLayerIds=te.localizableLayerIds,this.brightness=te.brightness,this.extraShadowCaster=!!te.extraShadowCaster,this.tessellationStep=te.tessellationStep,this.scaleFactor=te.scaleFactor,this.worldview=te.worldview,this.indoor=te.indoor}parse(te,pe,Ne,Ue,Ie,Xe){this.status="parsing",this.data=te,this.collisionBoxArray=new o.b3;const Je=new o.fm(Object.keys(te.layers).sort()),He=new o.fn(this.tileID,this.promoteId);He.bucketLayerIDs=[];const it={},At=new o.fo(256,256),St={featureIndex:He,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:At,availableImages:Ne,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0,activeFloors:void 0};if(this.indoor){const zi=this.indoor.indoorState.activeFloorsVisible,$i=function(Ei,Ni,Br){const Nn=function(Yr,cr){if(!Yr)return o.w("No source layers defined in indoor specification"),cr;if(Yr.size===0)return cr;const Jr=Yr.difference(cr);for(const Or of Jr)o.w(`Missing source layer required in indoor specification: ${Or}`);return cr.intersection(cr)}(Ni.sourceLayers,new Set(Object.keys(Ei.layers))),gn=Ni.indoorState,Rn=function(Yr,cr,Jr,Or){const Lr=new Set,yn=new Set,Es=new Set,Is=new Map,ns={},wl=Zs=>{const Oa=Is.get(Zs)||new Set;for(const Xs of Lr)if((Is.get(Xs)||new Set).has(Zs)||Oa.has(Xs))return!0;return!1};for(const Zs of cr){const Oa=Yr.layers[Zs];if(Oa)for(let Xs=0;Xs<Oa.length;Xs++){const Ms=Oa.feature(Xs);if(Ae(Ms)){const{id:la,center:Os}=de(Ms);he(ns,la,Os),Lr.add(la);continue}if(Te(Ms)){const{id:la,isDefault:Os,connections:cl,conflicts:xn,buildings:xa,name:Sl,zIndex:Tl}=K(Ms);se(ns,xa,la,{name:Sl,zIndex:Tl}),Is.set(la,xn),(la===Or||cl.has(Or))&&Lr.add(la),yn.add(la),Os&&Es.add(la)}}else o.w(`indoor source layer not found: ${Zs}`)}if(Jr)for(const Zs of Jr)yn.has(Zs)&&(wl(Zs)||Lr.add(Zs));for(const Zs of Es)Lr.has(Zs)||wl(Zs)||Lr.add(Zs);return{buildings:ns,activeFloors:Lr}}(Ei,Nn,gn.lastActiveFloors,gn.selectedFloorId);return Br.send("setIndoorData",Rn),Rn}(te,this.indoor,Ie);St.activeFloors=zi?$i.activeFloors:void 0}const Ht=[],ci=pe.familiesBySource[this.source];for(const zi in ci){const $i=te.layers[zi];if(!$i)continue;let Ei=!1,Ni=!1,Br=!1;for(const cr of ci[zi])cr[0].type==="symbol"?Ei=!0:Ni=!0,cr[0].is3D()&&cr[0].type!=="model"&&(Br=!0);if(this.extraShadowCaster&&!Br||this.isSymbolTile===!0&&!Ei||this.isSymbolTile===!1&&!Ni)continue;$i.version===1&&o.w(`Vector tile source "${this.source}" layer "${zi}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const Nn=Je.encode(zi),gn=[],Rn=this.localizableLayerIds&&this.localizableLayerIds.has(zi);let Yr=!1;for(let cr=0,Jr=0;cr<$i.length;cr++){const Or=$i.feature(cr),Lr=He.getId(Or,zi),yn=Or.properties?Or.properties.worldview:null;if(Rn&&this.worldview&&typeof yn=="string")if(yn==="all")Or.properties.$localized=!0;else{if(!yn.split(",").includes(this.worldview))continue;Or.properties.$localized=!0,Or.properties.worldview=this.worldview}!Yr&&Or.properties&&Or.properties.hasOwnProperty(o.fp)&&(Yr=!0),gn.push({feature:Or,id:Lr,index:Jr,sourceLayerIndex:Nn}),Jr++}Yr&&!St.elevationFeatures&&te.layers.hasOwnProperty(o.fq)&&(St.elevationFeatures=o.fr.parseFrom(te.layers[o.fq],this.canonical));for(const cr of ci[zi]){const Jr=cr[0];if(this.extraShadowCaster&&(!Jr.is3D()||Jr.type==="model")||this.isSymbolTile!==void 0&&Jr.type==="symbol"!==this.isSymbolTile||Jr.minzoom&&this.zoom<Math.floor(Jr.minzoom)||Jr.maxzoom&&this.zoom>=Jr.maxzoom||Jr.visibility==="none")continue;ne(cr,this.zoom,St.brightness,Ne,this.worldview);const Or=it[Jr.id]=Jr.createBucket({index:He.bucketLayerIDs.length,layers:cr,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Nn,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep,styleDefinedModelURLs:Ue,worldview:this.worldview,localizable:Rn,availableImages:Ne});He.bucketLayerIDs.push(cr.map(yn=>o.B(yn.id,yn.scope)));let Lr=Or.prepare?Or.prepare():null;Lr!=null?(Lr=Lr.then(()=>Or.populate(gn,St,this.tileID.canonical,this.tileTransform)),Ht.push(Lr)):Or.populate(gn,St,this.tileID.canonical,this.tileTransform)}}const wi=()=>{let zi,$i,Ei,Ni,Br,Nn;At.trim();const gn={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},Rn=()=>{if(zi)return this.status="done",Xe(zi);if(this.extraShadowCaster)this.status="done",Xe(null,{buckets:Object.values(it).filter(cr=>!cr.isEmpty()),featureIndex:He,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:St.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if($i&&Ei&&Ni){const cr=new X($i),Jr=new Map;for(const[yn,Es]of Ei.entries()){const{imagePosition:Is}=o.fu(yn,Es,o.fv);Jr.set(yn,Is)}const Or={};for(const yn in it){const Es=it[yn];Es instanceof o.b4&&(ne(Es.layers,this.zoom,St.brightness,Ne,this.worldview),Or[yn]=o.fw(Es,$i,cr.positions,Ei,Jr,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio,Br,this.worldview,Ne))}const Lr={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(Ie,Ei,Br,()=>{Lr.iconsPending=!1,Yr(Or,cr,Lr)}),this.rasterizeIfNeeded(Ie,Ni,Nn,()=>{Lr.patternsPending=!1,Yr(Or,cr,Lr)})}},Yr=(cr,Jr,Or,Lr)=>{if(Or.iconsPending||Or.patternsPending)return;const yn=new o.fx(Ei,Ni,this.lut);for(const Es in it){const Is=it[Es];if(Es in cr)o.fy(Is,cr[Es],this.showCollisionBoxes,Ne,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,Ei,yn);else if(Is.hasPattern&&(Is instanceof o.ba||Is instanceof o.bb||Is instanceof o.ea)){ne(Is.layers,this.zoom,St.brightness,Ne,this.worldview);const ns=Object.fromEntries(yn.patternPositions);Is.addFeatures(St,this.tileID.canonical,ns,Ne,this.tileTransform,this.brightness)}}this.status="done",Xe(null,{buckets:Object.values(it).filter(Es=>!Es.isEmpty()),featureIndex:He,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Jr.image,lineAtlas:At,imageAtlas:yn,brightness:St.brightness})};if(!this.extraShadowCaster){const cr=o.fs(St.glyphDependencies,Lr=>Object.keys(Lr).map(Number));Object.keys(cr).length?Ie.send("getGlyphs",{uid:this.uid,stacks:cr},(Lr,yn)=>{zi||(zi=Lr,$i=yn,Rn())},void 0,!1,gn):$i={};const Jr=Array.from(St.iconDependencies.keys()).map(Lr=>o.I.parse(Lr));Jr.length?Ie.send("getImages",{images:Jr,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(Lr,yn)=>{zi||(zi=Lr,Ei=new Map,Br=this.updateImageMapAndGetImageTaskQueue(Ei,yn,St.iconDependencies),Rn())},void 0,!1,gn):(Ei=new Map,Br=new Map);const Or=Array.from(St.patternDependencies.keys()).map(Lr=>o.I.parse(Lr));Or.length?Ie.send("getImages",{images:Or,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(Lr,yn)=>{zi||(zi=Lr,Ni=new Map,Nn=this.updateImageMapAndGetImageTaskQueue(Ni,yn,St.patternDependencies),Rn())},void 0,!1,gn):(Ni=new Map,Nn=new Map)}if(St.elevationFeatures&&St.elevationFeatures.length>0){const cr=[];for(const Or of Object.values(it))if(Or instanceof o.bb){const Lr=Or.getUnevaluatedPortalGraph();Lr&&cr.push(Lr)}const Jr=o.ft.evaluate(cr);for(const Or of Object.values(it))if(Or instanceof o.bb){const Lr=te.layers[Je.decode(Or.sourceLayerIndex)];Or.setEvaluatedPortalGraph(Jr,Lr,this.tileID.canonical,St.availableImages,St.brightness)}}Rn()};Ht.length>0?Promise.allSettled(Ht).then(wi).catch(Xe):wi()}updateParameters(te){this.scaleFactor=te.scaleFactor,this.showCollisionBoxes=te.showCollisionBoxes,this.projection=te.projection,this.brightness=te.brightness,this.tileTransform=o.aZ(te.tileID.canonical,te.projection),this.extraShadowCaster=te.extraShadowCaster,this.lut=te.lut,this.worldview=te.worldview,this.indoor=te.indoor}rasterizeIfNeeded(te,pe,Ne,Ue){Array.from(pe.values()).some(Ie=>Ie.usvg)?this.rasterize(te,pe,Ne,Ue):Ue()}updateImageMapAndGetImageTaskQueue(te,pe,Ne){const Ue=new Map;for(const Ie of pe.keys()){const Xe=Ne.get(Ie)||[];for(const Je of Xe){const He=Je.toString(),it=pe.get(Je.id.toString());it.usvg?Ue.has(He)||(Ue.set(He,Je),te.set(He,Object.assign({},it))):te.set(He,it)}}return Ue}rasterize(te,pe,Ne,Ue){this.rasterizeTask=te.send("rasterizeImages",{scope:this.scope,tasks:Ne},(Ie,Xe)=>{if(!Ie)for(const[Je,He]of Xe.entries()){const it=Object.assign(pe.get(Je),{data:He});pe.set(Je,it)}Ue()})}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function ne(Ze,te,pe,Ne,Ue){const Ie=new o.ac(te,{brightness:pe,worldview:Ue});for(const Xe of Ze)Xe.recalculate(Ie,Ne)}class ae extends o.E{constructor(te,pe,Ne,Ue,Ie,Xe,Je){super(),this.actor=te,this.layerIndex=pe,this.availableImages=Ne,this.availableModels=Ue,this.loadVectorData=Xe||o.aL,this.loading={},this.loaded={},this.deduped=new o.aK(te.scheduler),this.isSpriteLoaded=Ie,this.scheduler=te.scheduler,this.brightness=Je}loadTile(te,pe){const Ne=te.uid,Ue=te&&te.request,Ie=Ue&&Ue.collectResourceTiming,Xe=this.loading[Ne]=new Ce(te);Xe.abort=this.loadVectorData(te,(Je,He)=>{const it=!this.loading[Ne];if(delete this.loading[Ne],Xe.cancelRasterize(),it||Je||!He)return Xe.status="done",it||(this.loaded[Ne]=Xe),pe(Je);const At=He.rawData,St={},Ht=o.aM(He.responseHeaders);Ht&&Ht.expires&&(St.expires=Ht.expires),Ht&&Ht.cacheControl&&(St.cacheControl=Ht.cacheControl),Xe.vectorTile=He.vectorTile||new o.fz(new o.bt(At));const ci=()=>{Xe.parse(Xe.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,(wi,zi)=>{if(wi||!zi)return pe(wi);const $i={};if(Ie){const Ei=C(Ue);Ei.length>0&&($i.resourceTiming=JSON.parse(JSON.stringify(Ei)))}pe(null,Object.assign({rawTileData:At.slice(0),responseHeaders:He.responseHeaders},zi,St,$i))})};this.isSpriteLoaded?ci():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(ci,{type:"parseTile",isSymbolTile:te.isSymbolTile,zoom:te.tileZoom}):ci()}),this.loaded=this.loaded||{},this.loaded[Ne]=Xe})}reloadTile(te,pe){const Ne=this.loaded,Ue=te.uid;if(Ne&&Ne[Ue]){const Ie=Ne[Ue];Ie.updateParameters(te);const Xe=(Je,He)=>{const it=Ie.reloadCallback;it&&(delete Ie.reloadCallback,Ie.parse(Ie.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,it)),pe(Je,He)};Ie.status==="parsing"?Ie.reloadCallback=Xe:Ie.status==="done"&&(Ie.vectorTile?Ie.parse(Ie.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,Xe):Xe())}else pe(null,void 0)}abortTile(te,pe){const Ne=te.uid,Ue=this.loading[Ne];Ue&&(Ue.abort&&Ue.abort(),delete this.loading[Ne]),pe()}removeTile(te,pe){const Ne=this.loaded,Ue=te.uid;Ne&&Ne[Ue]&&delete Ne[Ue],pe()}}class q{loadTile(te,pe){const{uid:Ne,encoding:Ue,rawImageData:Ie,padding:Xe}=te,Je=ImageBitmap&&Ie instanceof ImageBitmap?this.getImageData(Ie,Xe):Ie;pe(null,new o.fA(Ne,Je,Ue,Xe<1))}reloadTile(te,pe){pe(null,null)}abortTile(te,pe){pe()}removeTile(te,pe){pe()}getImageData(te,pe){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(te.width,te.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=te.width,this.offscreenCanvas.height=te.height,this.offscreenCanvasContext.drawImage(te,0,0,te.width,te.height);const Ne=this.offscreenCanvasContext.getImageData(-pe,-pe,te.width+2*pe,te.height+2*pe);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),Ne}}o.bs.setPbf(o.bt);class oe{constructor(te){this._mrt=new o.bs(te.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=te.uid,this.tileID=te.tileID,this.source=te.source}parse(te,pe){const Ne=this._mrt;this.status="parsing",this._entireBuffer=te;try{Ne.parseHeader(te),this._isHeaderLoaded=!0;const Ue=[];for(const Ie in Ne.layers){const Xe=Ne.getLayer(Ie),Je=Xe.getDataRange(Xe.getBandList()),He=Ne.createDecodingTask(Je),it=te.slice(Je.firstByte,Je.lastByte+1),At=o.bs.performDecoding(it,He).then(St=>He.complete(null,St)).catch(St=>He.complete(St,null));Ue.push(At)}Promise.allSettled(Ue).then(()=>pe(null,Ne)).catch(Ie=>pe(Ie))}catch(Ue){pe(Ue)}}}class ke{constructor(te){this.actor=te,this.loading={},this.loaded={}}loadTile(te,pe){const Ne=te.uid,Ue=te.request,Ie=this.loading[Ne]=new oe(te),{cancel:Xe}=o.bu(Ue,(Je,He,it)=>{const At=!this.loading[Ne];if(delete this.loading[Ne],At||Je||!He)return Ie.status="done",At||(this.loaded[Ne]=Ie),pe(Je);Ie.parse(He,(St,Ht)=>{if(St||!Ht)return pe(St);pe(null,Ht,it)}),this.loaded[Ne]=Ie});Ie.abort=Xe}reloadTile(te,pe){pe(null,void 0)}abortTile(te,pe){const Ne=te.uid,Ue=this.loading[Ne];Ue&&(Ue.abort&&Ue.abort(),delete this.loading[Ne]),pe()}removeTile(te,pe){const Ne=te.uid;this.loaded[Ne]&&delete this.loaded[Ne],pe()}decodeRasterArray(te,pe){o.bs.performDecoding(te.buffer,te.task).then(Ne=>pe(null,Ne)).catch(Ne=>pe(Ne))}}const Ve=o.fB.prototype.toGeoJSON;class ie{constructor(te){this._feature=te,this.extent=o.al,this.type=te.type,this.properties=te.tags,"id"in te&&!isNaN(te.id)&&(this.id=parseInt(te.id,10))}loadGeometry(){if(this._feature.type===1){const te=[];for(const pe of this._feature.geometry)te.push([new o.P(pe[0],pe[1])]);return te}{const te=[];for(const pe of this._feature.geometry){const Ne=[];for(const Ue of pe)Ne.push(new o.P(Ue[0],Ue[1]));te.push(Ne)}return te}}toGeoJSON(te,pe,Ne){return Ve.call(this,te,pe,Ne)}}class ze{constructor(te,pe){this.name=te,this.extent=o.al,this.length=pe.length,this._jsonFeatures=pe}feature(te){return new ie(this._jsonFeatures[te])}}class ve{constructor(te){this.layers={},this.extent=o.al;for(const pe of Object.keys(te))this.layers[pe]=new ze(pe,te[pe])}}const Le=64/4096;class Ke{constructor(){this.features=new Map}clear(){this.features.clear()}load(te=[],pe){for(const Ne of te){const Ue=Ne.id;if(Ue==null)continue;let Ie=this.features.get(Ue);Ie&&this.updateCache(Ie,pe),Ne.geometry?(Ie=It(Ne),this.updateCache(Ie,pe),this.features.set(Ue,Ie)):this.features.delete(Ue),this.updateCache(Ie,pe)}}updateCache(te,pe){for(const{canonical:Ne,uid:Ue}of Object.values(pe)){const{z:Ie,x:Xe,y:Je}=Ne;Pe(te,Math.pow(2,Ie),Xe,Je)&&delete pe[Ue]}}getTile(te,pe,Ne){const Ue=Math.pow(2,te),Ie=[];for(const Xe of this.features.values())Pe(Xe,Ue,pe,Ne)&&Ie.push(Ot(Xe,Ue,pe,Ne));return{features:Ie}}getFeatures(){return[...this.features.values()]}}function Pe({minX:Ze,minY:te,maxX:pe,maxY:Ne},Ue,Ie,Xe){return Ze<(Ie+1+Le)/Ue&&te<(Xe+1+Le)/Ue&&pe>(Ie-Le)/Ue&&Ne>(Xe-Le)/Ue}function It(Ze){const{id:te,geometry:pe,properties:Ne}=Ze;if(!pe)return;if(pe.type==="GeometryCollection")throw new Error("GeometryCollection not supported in dynamic mode.");const{type:Ue,coordinates:Ie}=pe,Xe={id:te,type:1,geometry:[],tags:Ne,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},Je=Xe.geometry;if(Ue==="Point")tt(Ie,Je,Xe);else if(Ue==="MultiPoint")for(const He of Ie)tt(He,Je,Xe);else if(Ue==="LineString")Xe.type=2,zt(Ie,Je,Xe);else if(Ue==="MultiLineString")Xe.type=2,vt(Ie,Je,Xe);else if(Ue==="Polygon")Xe.type=3,vt(Ie,Je,Xe,!0);else{if(Ue!=="MultiPolygon")throw new Error("Input data is not a valid GeoJSON object.");Xe.type=3;for(const He of Ie)vt(He,Je,Xe,!0)}return Xe}function tt([Ze,te],pe,Ne){const Ue=o.aF(Ze);let Ie=o.aJ(te);Ie=Ie<0?0:Ie>1?1:Ie,pe.push(Ue,Ie),Ne.minX=Math.min(Ne.minX,Ue),Ne.minY=Math.min(Ne.minY,Ie),Ne.maxX=Math.max(Ne.maxX,Ue),Ne.maxY=Math.max(Ne.maxY,Ie)}function zt(Ze,te,pe,Ne=!1,Ue=!1){const Ie=[];for(const Xe of Ze)tt(Xe,Ie,pe);te.push(Ie),Ne&&function(Xe,Je){let He=0;for(let it=0,At=Xe.length,St=At-2;it<At;St=it,it+=2)He+=(Xe[it]-Xe[St])*(Xe[it+1]+Xe[St+1]);if(He>0===Je)for(let it=0,At=Xe.length;it<At/2;it+=2){const St=Xe[it],Ht=Xe[it+1];Xe[it]=Xe[At-2-it],Xe[it+1]=Xe[At-1-it],Xe[At-2-it]=St,Xe[At-1-it]=Ht}}(Ie,Ue)}function vt(Ze,te,pe,Ne=!1){for(let Ue=0;Ue<Ze.length;Ue++)zt(Ze[Ue],te,pe,Ne,Ue===0)}function Ot(Ze,te,pe,Ne){const{id:Ue,type:Ie,geometry:Xe,tags:Je}=Ze,He=[];if(Ie===1)(function(it,At,St,Ht,ci){for(let wi=0;wi<it.length;wi+=2){const zi=Math.round(o.al*(it[wi+0]*At-St)),$i=Math.round(o.al*(it[wi+1]*At-Ht));ci.push([zi,$i])}})(Xe,te,pe,Ne,He);else if(Ie===2)for(const it of Xe)Et(it,te,pe,Ne,He);else if(Ie===3)for(const it of Xe)yi(it,te,pe,Ne,He);return{id:Ue,type:Ie,geometry:He,tags:Je}}function Et(Ze,te,pe,Ne,Ue){const Xe=o.al+128;let Je;for(let He=0;He<Ze.length-2;He+=2){let it=Math.round(o.al*(Ze[He+0]*te-pe)),At=Math.round(o.al*(Ze[He+1]*te-Ne)),St=Math.round(o.al*(Ze[He+2]*te-pe)),Ht=Math.round(o.al*(Ze[He+3]*te-Ne));const ci=St-it,wi=Ht-At;it<-128&&St<-128||(it<-128?(At+=Math.round(wi*((-128-it)/ci)),it=-128):St<-128&&(Ht=At+Math.round(wi*((-128-it)/ci)),St=-128),At<-128&&Ht<-128||(At<-128?(it+=Math.round(ci*((-128-At)/wi)),At=-128):Ht<-128&&(St=it+Math.round(ci*((-128-At)/wi)),Ht=-128),it>=Xe&&St>=Xe||(it>=Xe?(At+=Math.round(wi*((Xe-it)/ci)),it=Xe):St>=Xe&&(Ht=At+Math.round(wi*((Xe-it)/ci)),St=Xe),At>=Xe&&Ht>=Xe||(At>=Xe?(it+=Math.round(ci*((Xe-At)/wi)),At=Xe):Ht>=Xe&&(St=it+Math.round(ci*((Xe-At)/wi)),Ht=Xe),Je&&it===Je[Je.length-1][0]&&At===Je[Je.length-1][1]||(Je=[[it,At]],Ue.push(Je)),Je.push([St,Ht])))))}}function yi(Ze,te,pe,Ne,Ue){const Ie=(pe-Le)/te,Xe=(Ne-Le)/te,Je=(pe+1+Le)/te,He=(Ne+1+Le)/te;function it(Ht,ci){let wi=0;return Ht<Ie?wi|=1:Ht>Je&&(wi|=2),ci<Xe?wi|=4:ci>He&&(wi|=8),wi}let At=[];for(let Ht=1;Ht<=8;Ht*=2){let ci=Ze[Ze.length-2],wi=Ze[Ze.length-1],zi=!(it(ci,wi)&Ht);for(let $i=0;$i<Ze.length;$i+=2){const Ei=Ze[$i],Ni=Ze[$i+1],Br=!(it(Ei,Ni)&Ht);Br!==zi&&(8&Ht?At.push(ci+(Ei-ci)*(He-wi)/(Ni-wi),He):4&Ht?At.push(ci+(Ei-ci)*(Xe-wi)/(Ni-wi),Xe):2&Ht?At.push(Je,wi+(Ni-wi)*(Je-ci)/(Ei-ci)):1&Ht&&At.push(Ie,wi+(Ni-wi)*(Ie-ci)/(Ei-ci))),Br&&At.push(Ei,Ni),ci=Ei,wi=Ni,zi=Br}if(!(Ze=At).length||Ht===8)break;At=[]}const St=[];for(let Ht=0;Ht<At.length;Ht+=2)St.push([Math.round(o.al*(At[Ht]*te-pe)),Math.round(o.al*(At[Ht+1]*te-Ne))]);St.length&&Ue.push(St)}function mi({name:Ze,features:te},pe){pe.writeStringField(1,Ze),pe.writeVarintField(5,o.al);const Ne=new Map,Ue=new Map,Ie={keys:Ne,values:Ue,feature:null};for(const Xe of te)Ie.feature=Xe,pe.writeMessage(2,ht,Ie);for(const Xe of Ne.keys())pe.writeStringField(3,Xe);for(const Xe of Ue.keys())pe.writeMessage(4,Ii,Xe)}function ht(Ze,te){const pe=Ze.feature;pe.id!==void 0&&Number.isSafeInteger(+pe.id)&&te.writeVarintField(1,+pe.id),pe.tags&&te.writeMessage(2,hi,Ze),te.writeVarintField(3,pe.type),te.writeMessage(4,Fi,pe)}function hi({keys:Ze,values:te,feature:pe},Ne){for(const Ue of Object.keys(pe.tags)){let Ie=pe.tags[Ue];if(Ie===null)continue;let Xe=Ze.get(Ue);Xe===void 0&&(Xe=Ze.size,Ze.set(Ue,Xe)),Ne.writeVarint(Xe);const Je=typeof Ie;Je!=="string"&&Je!=="boolean"&&Je!=="number"&&(Ie=JSON.stringify(Ie));let He=te.get(Ie);He===void 0&&(He=te.size,te.set(Ie,He)),Ne.writeVarint(He)}}function ni(Ze,te){return(te<<3)+(7&Ze)}function ui(Ze){return Ze<<1^Ze>>31}function Fi(Ze,te){const{geometry:pe,type:Ne}=Ze;let Ue=0,Ie=0;if(Ne===1){te.writeVarint(ni(1,pe.length));for(const Xe of pe){const Je=Xe[0]-Ue,He=Xe[1]-Ie;te.writeVarint(ui(Je)),te.writeVarint(ui(He)),Ue+=Je,Ie+=He}}else for(const Xe of pe){if(Xe.length===0)continue;te.writeVarint(ni(1,1));const Je=Xe.length-(Ne===3?1:0);for(let He=0;He<Je;He++){He===1&&te.writeVarint(ni(2,Je-1));const it=Xe[He][0]-Ue,At=Xe[He][1]-Ie;te.writeVarint(ui(it)),te.writeVarint(ui(At)),Ue+=it,Ie+=At}Ne===3&&te.writeVarint(ni(7,1))}}function Ii(Ze,te){const pe=typeof Ze;pe==="string"?te.writeStringField(1,Ze):pe==="boolean"?te.writeBooleanField(7,Ze):pe==="number"&&(Ze%1!=0?te.writeDoubleField(3,Ze):Ze<0?te.writeSVarintField(6,Ze):te.writeVarintField(5,Ze))}const Bi={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:Ze=>Ze},Ki=Math.fround||($r=new Float32Array(1),Ze=>($r[0]=+Ze,$r[0]));var $r;class nn{constructor(te){this.options=Object.assign(Object.create(Bi),te),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(te){const{log:pe,minZoom:Ne,maxZoom:Ue}=this.options;pe&&console.time("total time");const Ie=`prepare ${te.length} points`;pe&&console.time(Ie),this.points=te;const Xe=[];for(let He=0;He<te.length;He++){const it=te[He];if(!it.geometry)continue;const[At,St]=it.geometry.coordinates,Ht=Ki(jt(At)),ci=Ki(bi(St));Xe.push(Ht,ci,1/0,He,-1,1),this.options.reduce&&Xe.push(0)}let Je=this.trees[Ue+1]=this._createTree(Xe);pe&&console.timeEnd(Ie);for(let He=Ue;He>=Ne;He--){const it=+Date.now();Je=this.trees[He]=this._createTree(this._cluster(Je,He)),pe&&console.log("z%d: %d clusters in %dms",He,Je.numItems,+Date.now()-it)}return pe&&console.timeEnd("total time"),this}getClusters(te,pe){let Ne=((te[0]+180)%360+360)%360-180;const Ue=Math.max(-90,Math.min(90,te[1]));let Ie=te[2]===180?180:((te[2]+180)%360+360)%360-180;const Xe=Math.max(-90,Math.min(90,te[3]));if(te[2]-te[0]>=360)Ne=-180,Ie=180;else if(Ne>Ie){const St=this.getClusters([Ne,Ue,180,Xe],pe),Ht=this.getClusters([-180,Ue,Ie,Xe],pe);return St.concat(Ht)}const Je=this.trees[this._limitZoom(pe)],He=Je.range(jt(Ne),bi(Xe),jt(Ie),bi(Ue)),it=Je.data,At=[];for(const St of He){const Ht=this.stride*St;At.push(it[Ht+5]>1?Gn(it,Ht,this.clusterProps):this.points[it[Ht+3]])}return At}getChildren(te){const pe=this._getOriginId(te),Ne=this._getOriginZoom(te),Ue="No cluster with the specified id.",Ie=this.trees[Ne];if(!Ie)throw new Error(Ue);const Xe=Ie.data;if(pe*this.stride>=Xe.length)throw new Error(Ue);const Je=this.options.radius/(this.options.extent*Math.pow(2,Ne-1)),He=Ie.within(Xe[pe*this.stride],Xe[pe*this.stride+1],Je),it=[];for(const At of He){const St=At*this.stride;Xe[St+4]===te&&it.push(Xe[St+5]>1?Gn(Xe,St,this.clusterProps):this.points[Xe[St+3]])}if(it.length===0)throw new Error(Ue);return it}getLeaves(te,pe,Ne){const Ue=[];return this._appendLeaves(Ue,te,pe=pe||10,Ne=Ne||0,0),Ue}getTile(te,pe,Ne){const Ue=this.trees[this._limitZoom(te)],Ie=Math.pow(2,te),{extent:Xe,radius:Je}=this.options,He=Je/Xe,it=(Ne-He)/Ie,At=(Ne+1+He)/Ie,St={features:[]};return this._addTileFeatures(Ue.range((pe-He)/Ie,it,(pe+1+He)/Ie,At),Ue.data,pe,Ne,Ie,St),pe===0&&this._addTileFeatures(Ue.range(1-He/Ie,it,1,At),Ue.data,Ie,Ne,Ie,St),pe===Ie-1&&this._addTileFeatures(Ue.range(0,it,He/Ie,At),Ue.data,-1,Ne,Ie,St),St.features.length?St:null}getClusterExpansionZoom(te){let pe=this._getOriginZoom(te)-1;for(;pe<=this.options.maxZoom;){const Ne=this.getChildren(te);if(pe++,Ne.length!==1)break;te=Ne[0].properties.cluster_id}return pe}_appendLeaves(te,pe,Ne,Ue,Ie){const Xe=this.getChildren(pe);for(const Je of Xe){const He=Je.properties;if(He&&He.cluster?Ie+He.point_count<=Ue?Ie+=He.point_count:Ie=this._appendLeaves(te,He.cluster_id,Ne,Ue,Ie):Ie<Ue?Ie++:te.push(Je),te.length===Ne)break}return Ie}_createTree(te){const pe=new o.c4(te.length/this.stride|0,this.options.nodeSize,Float32Array);for(let Ne=0;Ne<te.length;Ne+=this.stride)pe.add(te[Ne],te[Ne+1]);return pe.finish(),pe.data=te,pe}_addTileFeatures(te,pe,Ne,Ue,Ie,Xe){for(const Je of te){const He=Je*this.stride,it=pe[He+5]>1;let At,St,Ht;if(it)At=Tr(pe,He,this.clusterProps),St=pe[He],Ht=pe[He+1];else{const zi=this.points[pe[He+3]];At=zi.properties;const[$i,Ei]=zi.geometry.coordinates;St=jt($i),Ht=bi(Ei)}const ci={type:1,geometry:[[Math.round(this.options.extent*(St*Ie-Ne)),Math.round(this.options.extent*(Ht*Ie-Ue))]],tags:At};let wi;wi=it||this.options.generateId?pe[He+3]:this.points[pe[He+3]].id,wi!==void 0&&(ci.id=wi),Xe.features.push(ci)}}_limitZoom(te){return Math.max(this.options.minZoom,Math.min(Math.floor(+te),this.options.maxZoom+1))}_cluster(te,pe){const{radius:Ne,extent:Ue,reduce:Ie,minPoints:Xe}=this.options,Je=Ne/(Ue*Math.pow(2,pe)),He=te.data,it=[],At=this.stride;for(let St=0;St<He.length;St+=At){if(He[St+2]<=pe)continue;He[St+2]=pe;const Ht=He[St],ci=He[St+1],wi=te.within(He[St],He[St+1],Je),zi=He[St+5];let $i=zi;for(const Ei of wi){const Ni=Ei*At;He[Ni+2]>pe&&($i+=He[Ni+5])}if($i>zi&&$i>=Xe){let Ei,Ni=Ht*zi,Br=ci*zi,Nn=-1;const gn=(St/At<<5)+(pe+1)+this.points.length;for(const Rn of wi){const Yr=Rn*At;if(He[Yr+2]<=pe)continue;He[Yr+2]=pe;const cr=He[Yr+5];Ni+=He[Yr]*cr,Br+=He[Yr+1]*cr,He[Yr+4]=gn,Ie&&(Ei||(Ei=this._map(He,St,!0),Nn=this.clusterProps.length,this.clusterProps.push(Ei)),Ie(Ei,this._map(He,Yr)))}He[St+4]=gn,it.push(Ni/$i,Br/$i,1/0,gn,-1,$i),Ie&&it.push(Nn)}else{for(let Ei=0;Ei<At;Ei++)it.push(He[St+Ei]);if($i>1)for(const Ei of wi){const Ni=Ei*At;if(!(He[Ni+2]<=pe)){He[Ni+2]=pe;for(let Br=0;Br<At;Br++)it.push(He[Ni+Br])}}}}return it}_getOriginId(te){return te-this.points.length>>5}_getOriginZoom(te){return(te-this.points.length)%32}_map(te,pe,Ne){if(te[pe+5]>1){const Xe=this.clusterProps[te[pe+6]];return Ne?Object.assign({},Xe):Xe}const Ue=this.points[te[pe+3]].properties,Ie=this.options.map(Ue);return Ne&&Ie===Ue?Object.assign({},Ie):Ie}}function Gn(Ze,te,pe){return{type:"Feature",id:Ze[te+3],properties:Tr(Ze,te,pe),geometry:{type:"Point",coordinates:[(Ne=Ze[te],360*(Ne-.5)),ar(Ze[te+1])]}};var Ne}function Tr(Ze,te,pe){const Ne=Ze[te+5],Ue=Ne>=1e4?`${Math.round(Ne/1e3)}k`:Ne>=1e3?Math.round(Ne/100)/10+"k":Ne,Ie=Ze[te+6],Xe=Ie===-1?{}:Object.assign({},pe[Ie]);return Object.assign(Xe,{cluster:!0,cluster_id:Ze[te+3],point_count:Ne,point_count_abbreviated:Ue})}function jt(Ze){return Ze/360+.5}function bi(Ze){const te=Math.sin(Ze*Math.PI/180),pe=.5-.25*Math.log((1+te)/(1-te))/Math.PI;return pe<0?0:pe>1?1:pe}function ar(Ze){const te=(180-360*Ze)*Math.PI/180;return 360*Math.atan(Math.exp(te))/Math.PI-90}function li(Ze,te,pe,Ne){let Ue=Ne;const Ie=te+(pe-te>>1);let Xe,Je=pe-te;const He=Ze[te],it=Ze[te+1],At=Ze[pe],St=Ze[pe+1];for(let Ht=te+3;Ht<pe;Ht+=3){const ci=ai(Ze[Ht],Ze[Ht+1],He,it,At,St);if(ci>Ue)Xe=Ht,Ue=ci;else if(ci===Ue){const wi=Math.abs(Ht-Ie);wi<Je&&(Xe=Ht,Je=wi)}}Ue>Ne&&(Xe-te>3&&li(Ze,te,Xe,Ne),Ze[Xe+2]=Ue,pe-Xe>3&&li(Ze,Xe,pe,Ne))}function ai(Ze,te,pe,Ne,Ue,Ie){let Xe=Ue-pe,Je=Ie-Ne;if(Xe!==0||Je!==0){const He=((Ze-pe)*Xe+(te-Ne)*Je)/(Xe*Xe+Je*Je);He>1?(pe=Ue,Ne=Ie):He>0&&(pe+=Xe*He,Ne+=Je*He)}return Xe=Ze-pe,Je=te-Ne,Xe*Xe+Je*Je}function Jt(Ze,te,pe,Ne){const Ue={id:Ze??null,type:te,geometry:pe,tags:Ne,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(te==="Point"||te==="MultiPoint"||te==="LineString")Vi(Ue,pe);else if(te==="Polygon")Vi(Ue,pe[0]);else if(te==="MultiLineString")for(const Ie of pe)Vi(Ue,Ie);else if(te==="MultiPolygon")for(const Ie of pe)Vi(Ue,Ie[0]);return Ue}function Vi(Ze,te){for(let pe=0;pe<te.length;pe+=3)Ze.minX=Math.min(Ze.minX,te[pe]),Ze.minY=Math.min(Ze.minY,te[pe+1]),Ze.maxX=Math.max(Ze.maxX,te[pe]),Ze.maxY=Math.max(Ze.maxY,te[pe+1])}function fi(Ze,te,pe,Ne){if(!te.geometry)return;const Ue=te.geometry.coordinates;if(Ue&&Ue.length===0)return;const Ie=te.geometry.type,Xe=Math.pow(pe.tolerance/((1<<pe.maxZoom)*pe.extent),2);let Je=[],He=te.id;if(pe.promoteId?He=te.properties[pe.promoteId]:pe.generateId&&(He=Ne||0),Ie==="Point")vi(Ue,Je);else if(Ie==="MultiPoint")for(const it of Ue)vi(it,Je);else if(Ie==="LineString")Pi(Ue,Je,Xe,!1);else if(Ie==="MultiLineString"){if(pe.lineMetrics){for(const it of Ue)Je=[],Pi(it,Je,Xe,!1),Ze.push(Jt(He,"LineString",Je,te.properties));return}Nr(Ue,Je,Xe,!1)}else if(Ie==="Polygon")Nr(Ue,Je,Xe,!0);else{if(Ie!=="MultiPolygon"){if(Ie==="GeometryCollection"){for(const it of te.geometry.geometries)fi(Ze,{id:He,geometry:it,properties:te.properties},pe,Ne);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const it of Ue){const At=[];Nr(it,At,Xe,!0),Je.push(At)}}Ze.push(Jt(He,Ie,Je,te.properties))}function vi(Ze,te){te.push(er(Ze[0]),Wr(Ze[1]),0)}function Pi(Ze,te,pe,Ne){let Ue,Ie,Xe=0;for(let He=0;He<Ze.length;He++){const it=er(Ze[He][0]),At=Wr(Ze[He][1]);te.push(it,At,0),He>0&&(Xe+=Ne?(Ue*At-it*Ie)/2:Math.sqrt(Math.pow(it-Ue,2)+Math.pow(At-Ie,2))),Ue=it,Ie=At}const Je=te.length-3;te[2]=1,li(te,0,Je,pe),te[Je+2]=1,te.size=Math.abs(Xe),te.start=0,te.end=te.size}function Nr(Ze,te,pe,Ne){for(let Ue=0;Ue<Ze.length;Ue++){const Ie=[];Pi(Ze[Ue],Ie,pe,Ne),te.push(Ie)}}function er(Ze){return Ze/360+.5}function Wr(Ze){const te=Math.sin(Ze*Math.PI/180),pe=.5-.25*Math.log((1+te)/(1-te))/Math.PI;return pe<0?0:pe>1?1:pe}function kr(Ze,te,pe,Ne,Ue,Ie,Xe,Je){if(Ne/=te,Ie>=(pe/=te)&&Xe<Ne)return Ze;if(Xe<pe||Ie>=Ne)return null;const He=[];for(const it of Ze){const At=it.geometry;let St=it.type;const Ht=Ue===0?it.minX:it.minY,ci=Ue===0?it.maxX:it.maxY;if(Ht>=pe&&ci<Ne){He.push(it);continue}if(ci<pe||Ht>=Ne)continue;let wi=[];if(St==="Point"||St==="MultiPoint")di(At,wi,pe,Ne,Ue);else if(St==="LineString")or(At,wi,pe,Ne,Ue,!1,Je.lineMetrics);else if(St==="MultiLineString")Da(At,wi,pe,Ne,Ue,!1);else if(St==="Polygon")Da(At,wi,pe,Ne,Ue,!0);else if(St==="MultiPolygon")for(const zi of At){const $i=[];Da(zi,$i,pe,Ne,Ue,!0),$i.length&&wi.push($i)}if(wi.length){if(Je.lineMetrics&&St==="LineString"){for(const zi of wi)He.push(Jt(it.id,St,zi,it.tags));continue}St!=="LineString"&&St!=="MultiLineString"||(wi.length===1?(St="LineString",wi=wi[0]):St="MultiLineString"),St!=="Point"&&St!=="MultiPoint"||(St=wi.length===3?"Point":"MultiPoint"),He.push(Jt(it.id,St,wi,it.tags))}}return He.length?He:null}function di(Ze,te,pe,Ne,Ue){for(let Ie=0;Ie<Ze.length;Ie+=3){const Xe=Ze[Ie+Ue];Xe>=pe&&Xe<=Ne&&ms(te,Ze[Ie],Ze[Ie+1],Ze[Ie+2])}}function or(Ze,te,pe,Ne,Ue,Ie,Xe){let Je=jn(Ze);const He=Ue===0?pt:oi;let it,At,St=Ze.start;for(let $i=0;$i<Ze.length-3;$i+=3){const Ei=Ze[$i],Ni=Ze[$i+1],Br=Ze[$i+2],Nn=Ze[$i+3],gn=Ze[$i+4],Rn=Ue===0?Ei:Ni,Yr=Ue===0?Nn:gn;let cr=!1;Xe&&(it=Math.sqrt(Math.pow(Ei-Nn,2)+Math.pow(Ni-gn,2))),Rn<pe?Yr>pe&&(At=He(Je,Ei,Ni,Nn,gn,pe),Xe&&(Je.start=St+it*At)):Rn>Ne?Yr<Ne&&(At=He(Je,Ei,Ni,Nn,gn,Ne),Xe&&(Je.start=St+it*At)):ms(Je,Ei,Ni,Br),Yr<pe&&Rn>=pe&&(At=He(Je,Ei,Ni,Nn,gn,pe),cr=!0),Yr>Ne&&Rn<=Ne&&(At=He(Je,Ei,Ni,Nn,gn,Ne),cr=!0),!Ie&&cr&&(Xe&&(Je.end=St+it*At),te.push(Je),Je=jn(Ze)),Xe&&(St+=it)}let Ht=Ze.length-3;const ci=Ze[Ht],wi=Ze[Ht+1],zi=Ue===0?ci:wi;zi>=pe&&zi<=Ne&&ms(Je,ci,wi,Ze[Ht+2]),Ht=Je.length-3,Ie&&Ht>=3&&(Je[Ht]!==Je[0]||Je[Ht+1]!==Je[1])&&ms(Je,Je[0],Je[1],Je[2]),Je.length&&te.push(Je)}function jn(Ze){const te=[];return te.size=Ze.size,te.start=Ze.start,te.end=Ze.end,te}function Da(Ze,te,pe,Ne,Ue,Ie){for(const Xe of Ze)or(Xe,te,pe,Ne,Ue,Ie,!1)}function ms(Ze,te,pe,Ne){Ze.push(te,pe,Ne)}function pt(Ze,te,pe,Ne,Ue,Ie){const Xe=(Ie-te)/(Ne-te);return ms(Ze,Ie,pe+(Ue-pe)*Xe,1),Xe}function oi(Ze,te,pe,Ne,Ue,Ie){const Xe=(Ie-pe)/(Ue-pe);return ms(Ze,te+(Ne-te)*Xe,Ie,1),Xe}function Mi(Ze,te){const pe=[];for(let Ne=0;Ne<Ze.length;Ne++){const Ue=Ze[Ne],Ie=Ue.type;let Xe;if(Ie==="Point"||Ie==="MultiPoint"||Ie==="LineString")Xe=qi(Ue.geometry,te);else if(Ie==="MultiLineString"||Ie==="Polygon"){Xe=[];for(const Je of Ue.geometry)Xe.push(qi(Je,te))}else if(Ie==="MultiPolygon"){Xe=[];for(const Je of Ue.geometry){const He=[];for(const it of Je)He.push(qi(it,te));Xe.push(He)}}pe.push(Jt(Ue.id,Ie,Xe,Ue.tags))}return pe}function qi(Ze,te){const pe=[];pe.size=Ze.size,Ze.start!==void 0&&(pe.start=Ze.start,pe.end=Ze.end);for(let Ne=0;Ne<Ze.length;Ne+=3)pe.push(Ze[Ne]+te,Ze[Ne+1],Ze[Ne+2]);return pe}function Xn(Ze,te){if(Ze.transformed)return Ze;const pe=1<<Ze.z,Ne=Ze.x,Ue=Ze.y;for(const Ie of Ze.features){const Xe=Ie.geometry,Je=Ie.type;if(Ie.geometry=[],Je===1)for(let He=0;He<Xe.length;He+=2)Ie.geometry.push(mr(Xe[He],Xe[He+1],te,pe,Ne,Ue));else for(let He=0;He<Xe.length;He++){const it=[];for(let At=0;At<Xe[He].length;At+=2)it.push(mr(Xe[He][At],Xe[He][At+1],te,pe,Ne,Ue));Ie.geometry.push(it)}}return Ze.transformed=!0,Ze}function mr(Ze,te,pe,Ne,Ue,Ie){return[Math.round(pe*(Ze*Ne-Ue)),Math.round(pe*(te*Ne-Ie))]}function sn(Ze,te,pe,Ne,Ue){const Ie=te===Ue.maxZoom?0:Ue.tolerance/((1<<te)*Ue.extent),Xe={features:[],numPoints:0,numSimplified:0,numFeatures:Ze.length,source:null,x:pe,y:Ne,z:te,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const Je of Ze)al(Xe,Je,Ie,Ue);return Xe}function al(Ze,te,pe,Ne){const Ue=te.geometry,Ie=te.type,Xe=[];if(Ze.minX=Math.min(Ze.minX,te.minX),Ze.minY=Math.min(Ze.minY,te.minY),Ze.maxX=Math.max(Ze.maxX,te.maxX),Ze.maxY=Math.max(Ze.maxY,te.maxY),Ie==="Point"||Ie==="MultiPoint")for(let Je=0;Je<Ue.length;Je+=3)Xe.push(Ue[Je],Ue[Je+1]),Ze.numPoints++,Ze.numSimplified++;else if(Ie==="LineString")Ma(Xe,Ue,Ze,pe,!1,!1);else if(Ie==="MultiLineString"||Ie==="Polygon")for(let Je=0;Je<Ue.length;Je++)Ma(Xe,Ue[Je],Ze,pe,Ie==="Polygon",Je===0);else if(Ie==="MultiPolygon")for(let Je=0;Je<Ue.length;Je++){const He=Ue[Je];for(let it=0;it<He.length;it++)Ma(Xe,He[it],Ze,pe,!0,it===0)}if(Xe.length){let Je=te.tags||null;if(Ie==="LineString"&&Ne.lineMetrics){Je={};for(const it in te.tags)Je[it]=te.tags[it];Je.mapbox_clip_start=Ue.start/Ue.size,Je.mapbox_clip_end=Ue.end/Ue.size}const He={geometry:Xe,type:Ie==="Polygon"||Ie==="MultiPolygon"?3:Ie==="LineString"||Ie==="MultiLineString"?2:1,tags:Je};te.id!==null&&(He.id=te.id),Ze.features.push(He)}}function Ma(Ze,te,pe,Ne,Ue,Ie){const Xe=Ne*Ne;if(Ne>0&&te.size<(Ue?Xe:Ne))return void(pe.numPoints+=te.length/3);const Je=[];for(let He=0;He<te.length;He+=3)(Ne===0||te[He+2]>Xe)&&(pe.numSimplified++,Je.push(te[He],te[He+1])),pe.numPoints++;Ue&&function(He,it){let At=0;for(let St=0,Ht=He.length,ci=Ht-2;St<Ht;ci=St,St+=2)At+=(He[St]-He[ci])*(He[St+1]+He[ci+1]);if(At>0===it)for(let St=0,Ht=He.length;St<Ht/2;St+=2){const ci=He[St],wi=He[St+1];He[St]=He[Ht-2-St],He[St+1]=He[Ht-1-St],He[Ht-2-St]=ci,He[Ht-1-St]=wi}}(Je,Ie),Ze.push(Je)}const fs={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class ol{constructor(te,pe){const Ne=(pe=this.options=function(Ie,Xe){for(const Je in Xe)Ie[Je]=Xe[Je];return Ie}(Object.create(fs),pe)).debug;if(Ne&&console.time("preprocess data"),pe.maxZoom<0||pe.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(pe.promoteId&&pe.generateId)throw new Error("promoteId and generateId cannot be used together.");let Ue=function(Ie,Xe){const Je=[];if(Ie.type==="FeatureCollection")for(let He=0;He<Ie.features.length;He++)fi(Je,Ie.features[He],Xe,He);else fi(Je,Ie.type==="Feature"?Ie:{geometry:Ie},Xe);return Je}(te,pe);this.tiles={},this.tileCoords=[],Ne&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",pe.indexMaxZoom,pe.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),Ue=function(Ie,Xe){const Je=Xe.buffer/Xe.extent;let He=Ie;const it=kr(Ie,1,-1-Je,Je,0,-1,2,Xe),At=kr(Ie,1,1-Je,2+Je,0,-1,2,Xe);return(it||At)&&(He=kr(Ie,1,-Je,1+Je,0,-1,2,Xe)||[],it&&(He=Mi(it,1).concat(He)),At&&(He=He.concat(Mi(At,-1)))),He}(Ue,pe),Ue.length&&this.splitTile(Ue,0,0,0),Ne&&(Ue.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(te,pe,Ne,Ue,Ie,Xe,Je){const He=[te,pe,Ne,Ue],it=this.options,At=it.debug;for(;He.length;){Ue=He.pop(),Ne=He.pop(),pe=He.pop(),te=He.pop();const St=1<<pe,Ht=ll(pe,Ne,Ue);let ci=this.tiles[Ht];if(!ci&&(At>1&&console.time("creation"),ci=this.tiles[Ht]=sn(te,pe,Ne,Ue,it),this.tileCoords.push({z:pe,x:Ne,y:Ue}),At)){At>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",pe,Ne,Ue,ci.numFeatures,ci.numPoints,ci.numSimplified),console.timeEnd("creation"));const cr=`z${pe}`;this.stats[cr]=(this.stats[cr]||0)+1,this.total++}if(ci.source=te,Ie==null){if(pe===it.indexMaxZoom||ci.numPoints<=it.indexMaxPoints)continue}else{if(pe===it.maxZoom||pe===Ie)continue;if(Ie!=null){const cr=Ie-pe;if(Ne!==Xe>>cr||Ue!==Je>>cr)continue}}if(ci.source=null,te.length===0)continue;At>1&&console.time("clipping");const wi=.5*it.buffer/it.extent,zi=.5-wi,$i=.5+wi,Ei=1+wi;let Ni=null,Br=null,Nn=null,gn=null,Rn=kr(te,St,Ne-wi,Ne+$i,0,ci.minX,ci.maxX,it),Yr=kr(te,St,Ne+zi,Ne+Ei,0,ci.minX,ci.maxX,it);te=null,Rn&&(Ni=kr(Rn,St,Ue-wi,Ue+$i,1,ci.minY,ci.maxY,it),Br=kr(Rn,St,Ue+zi,Ue+Ei,1,ci.minY,ci.maxY,it),Rn=null),Yr&&(Nn=kr(Yr,St,Ue-wi,Ue+$i,1,ci.minY,ci.maxY,it),gn=kr(Yr,St,Ue+zi,Ue+Ei,1,ci.minY,ci.maxY,it),Yr=null),At>1&&console.timeEnd("clipping"),He.push(Ni||[],pe+1,2*Ne,2*Ue),He.push(Br||[],pe+1,2*Ne,2*Ue+1),He.push(Nn||[],pe+1,2*Ne+1,2*Ue),He.push(gn||[],pe+1,2*Ne+1,2*Ue+1)}}getTile(te,pe,Ne){te=+te,pe=+pe,Ne=+Ne;const Ue=this.options,{extent:Ie,debug:Xe}=Ue;if(te<0||te>24)return null;const Je=1<<te,He=ll(te,pe=pe+Je&Je-1,Ne);if(this.tiles[He])return Xn(this.tiles[He],Ie);Xe>1&&console.log("drilling down to z%d-%d-%d",te,pe,Ne);let it,At=te,St=pe,Ht=Ne;for(;!it&&At>0;)At--,St>>=1,Ht>>=1,it=this.tiles[ll(At,St,Ht)];return it&&it.source?(Xe>1&&(console.log("found parent tile z%d-%d-%d",At,St,Ht),console.time("drilling down")),this.splitTile(it.source,At,St,Ht,te,pe,Ne),Xe>1&&console.timeEnd("drilling down"),this.tiles[He]?Xn(this.tiles[He],Ie):null):null}}function ll(Ze,te,pe){return 32*((1<<Ze)*pe+te)+Ze}function wt(Ze,te){const pe=Ze.tileID.canonical;if(!this._geoJSONIndex)return void te(null,null);const Ne=this._geoJSONIndex.getTile(pe.z,pe.x,pe.y);if(!Ne)return void te(null,null);const Ue=it=>it.tags&&"3d_elevation_id"in it.tags&&"source"in it.tags&&it.tags.source==="elevation",Ie=Ne.features.filter(it=>Ue(it));let Xe={_geojsonTileLayer:Ne.features};Ie.length>0&&(Xe={_geojsonTileLayer:Ne.features.filter(it=>!Ue(it)),hd_road_elevation:Ie});const Je=new ve(Xe),He=function(it){const At=new o.bt;for(const St of Object.keys(it))At.writeMessage(3,mi,{name:St,features:it[St]});return At.finish()}(Xe).buffer;te(null,{vectorTile:Je,rawData:He})}class Xa extends ae{constructor(te,pe,Ne,Ue,Ie,Xe,Je){super(te,pe,Ne,Ue,Ie,wt,Je),Xe&&(this.loadGeoJSON=Xe),this._dynamicIndex=new Ke}loadData(te,pe){const Ne=te&&te.request,Ue=Ne&&Ne.collectResourceTiming;this._geoJSONIndex=null,this.loadGeoJSON(te,(Ie,Xe)=>{if(Ie||!Xe)return pe(Ie);if(typeof Xe!="object")return pe(new Error(`Input data given to '${te.source}' is not a valid GeoJSON object.`));{try{if(te.filter){const He=o.U(te.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(He.result==="error")throw new Error(He.value.map(it=>`${it.key}: ${it.message}`).join(", "));Xe.features=Xe.features.filter(it=>He.value.evaluate({zoom:0},it))}te.dynamic?(Xe.type==="Feature"&&(Xe={type:"FeatureCollection",features:[Xe]}),te.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(Xe.features,this.loaded),te.cluster&&(Xe.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=te.cluster?new nn(function({superclusterOptions:He,clusterProperties:it}){if(!it||!He)return He;const At={},St={},Ht={accumulated:null,zoom:0},ci={properties:null},wi=Object.keys(it);for(const zi of wi){const[$i,Ei]=it[zi],Ni=o.U(Ei),Br=o.U(typeof $i=="string"?[$i,["accumulated"],["get",zi]]:$i);At[zi]=Ni.value,St[zi]=Br.value}return He.map=zi=>{ci.properties=zi;const $i={};for(const Ei of wi)$i[Ei]=At[Ei].evaluate(Ht,ci);return $i},He.reduce=(zi,$i)=>{ci.properties=$i;for(const Ei of wi)Ht.accumulated=zi[Ei],zi[Ei]=St[Ei].evaluate(Ht,ci)},He}(te)).load(Xe.features):te.dynamic?this._dynamicIndex:function(He,it){return new ol(He,it)}(Xe,te.geojsonVtOptions)}catch(He){return pe(He)}const Je={};if(Ue){const He=C(Ne);He&&(Je.resourceTiming={},Je.resourceTiming[te.source]=JSON.parse(JSON.stringify(He)))}pe(null,Je)}})}reloadTile(te,pe){const Ne=this.loaded;return Ne&&Ne[te.uid]?te.partial?pe(null,void 0):super.reloadTile(te,pe):this.loadTile(te,pe)}loadGeoJSON(te,pe){if(te.request)o.m(te.request,pe);else{if(typeof te.data!="string")return pe(new Error(`Input data given to '${te.source}' is not a valid GeoJSON object.`));setTimeout(()=>{try{return pe(null,JSON.parse(te.data))}catch{return pe(new Error(`Input data given to '${te.source}' is not a valid GeoJSON object.`))}},0)}}getClusterExpansionZoom(te,pe){try{pe(null,this._geoJSONIndex.getClusterExpansionZoom(te.clusterId))}catch(Ne){pe(Ne)}}getClusterChildren(te,pe){try{pe(null,this._geoJSONIndex.getChildren(te.clusterId))}catch(Ne){pe(Ne)}}getClusterLeaves(te,pe){try{pe(null,this._geoJSONIndex.getLeaves(te.clusterId,te.limit,te.offset))}catch(Ne){pe(Ne)}}}class Oi{constructor(te,pe,Ne){this.tileID=new o.aQ(te.tileID.overscaledZ,te.tileID.wrap,te.tileID.canonical.z,te.tileID.canonical.x,te.tileID.canonical.y),this.tileZoom=te.tileZoom,this.uid=te.uid,this.zoom=te.zoom,this.canonical=te.tileID.canonical,this.pixelRatio=te.pixelRatio,this.tileSize=te.tileSize,this.source=te.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=te.projection,this.brightness=pe,this.worldview=Ne}parse(te,pe,Ne,Ue){this.status="parsing";const Ie=new o.aQ(Ne.tileID.overscaledZ,Ne.tileID.wrap,Ne.tileID.canonical.z,Ne.tileID.canonical.x,Ne.tileID.canonical.y),Xe=[],Je=pe.familiesBySource[Ne.source],He=new o.fn(Ie,Ne.promoteId);He.bucketLayerIDs=[],He.is3DTile=!0,o.fC(te).then(it=>{if(!it)return Ue(new Error("Could not parse tile"));const At=it.json.extensionsUsed&&it.json.extensionsUsed.includes("MAPBOX_mesh_features")||it.json.asset.extras&&it.json.asset.extras.MAPBOX_mesh_features,St=it.json.extensionsUsed&&it.json.extensionsUsed.includes("EXT_meshopt_compression"),Ht=new o.ac(this.zoom,{brightness:this.brightness,worldview:this.worldview});for(const ci in Je)for(const wi of Je[ci]){const zi=wi[0];He.bucketLayerIDs.push(wi.map(Ni=>o.B(Ni.id,Ni.scope))),zi.recalculate(Ht,[]);const $i=o.fD(it,1/o.d7(Ne.tileID.canonical)),Ei=new o.fE(wi,$i,Ie,At,St,this.brightness,He,this.worldview);At||(Ei.needsUpload=!0),Xe.push(Ei),Ei.evaluate(zi)}this.status="done",Ue(null,{buckets:Xe,featureIndex:He,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})}).catch(it=>Ue(new Error(it.message)))}}class Xr{constructor(te,pe,Ne,Ue,Ie,Xe,Je,He){this.actor=te,this.layerIndex=pe,this.availableImages=Ne,this.availableModels=Ue,this.brightness=Je,this.loading={},this.loaded={},this.worldview=He}loadTile(te,pe){const Ne=te.uid,Ue=this.loading[Ne]=new Oi(te,this.brightness,this.worldview);o.bu(te.request,(Ie,Xe)=>{const Je=!this.loading[Ne];return delete this.loading[Ne],Je||Ie?(Ue.status="done",Je||(this.loaded[Ne]=Ue),pe(Ie)):Xe&&Xe.byteLength!==0?void Ue.parse(Xe,this.layerIndex,te,(He,it)=>{Ue.status="done",this.loaded=this.loaded||{},this.loaded[Ne]=Ue,He||!it?pe(He):pe(null,it)}):(Ue.status="done",this.loaded[Ne]=Ue,pe())})}reloadTile(te,pe){const Ne=this.loaded,Ue=te.uid;if(Ne&&Ne[Ue]){const Ie=Ne[Ue];Ie.projection=te.projection,Ie.brightness=te.brightness;const Xe=(Je,He)=>{Ie.reloadCallback&&(delete Ie.reloadCallback,this.loadTile(te,pe)),pe(Je,He)};Ie.status==="parsing"?Ie.reloadCallback=Xe:Ie.status==="done"&&this.loadTile(te,pe)}}abortTile(te,pe){const Ne=te.uid;this.loading[Ne]&&delete this.loading[Ne],pe()}removeTile(te,pe){const Ne=this.loaded,Ue=te.uid;Ne&&Ne[Ue]&&delete Ne[Ue],pe()}}class Zi{constructor(te){this.self=te,this.actor=new o.fG(te,this),this.layerIndexes={},this.availableImages={},this.availableModels={},this.isSpriteLoaded={},this.imageRasterizer=new o.x,this.rtlPluginParsingListeners=[],this.projections={},this.defaultProjection=o.cm({name:"mercator"}),this.workerSourceTypes={vector:ae,geojson:Xa,"raster-dem":q,"raster-array":ke,"batched-model":Xr},this.workerSources={},this.self.registerWorkerSource=(pe,Ne)=>{if(this.workerSourceTypes[pe])throw new Error(`Worker source with name "${pe}" already registered.`);this.workerSourceTypes[pe]=Ne},this.self.registerRTLTextPlugin=pe=>{if(o.fH.isParsed())throw new Error("RTL text plugin already registered.");o.fH.setState({pluginStatus:o.fI.parsed,pluginURL:o.fH.getPluginURL()}),o.fH.applyArabicShaping=pe.applyArabicShaping,o.fH.processBidirectionalText=pe.processBidirectionalText,o.fH.processStyledBidirectionalText=pe.processStyledBidirectionalText;for(const Ne of this.rtlPluginParsingListeners)Ne(null,!0);this.rtlPluginParsingListeners=[]}}clearCaches(te,pe,Ne){delete this.layerIndexes[te],delete this.availableImages[te],delete this.availableModels[te],delete this.workerSources[te],Ne()}checkIfReady(te,pe,Ne){Ne()}setReferrer(te,pe){this.referrer=pe}spriteLoaded(te,pe){this.isSpriteLoaded[te]||(this.isSpriteLoaded[te]={});const{scope:Ne,isLoaded:Ue}=pe;if(this.isSpriteLoaded[te][Ne]=Ue,this.workerSources[te]&&this.workerSources[te][Ne])for(const Ie in this.workerSources[te][Ne]){const Xe=this.workerSources[te][Ne][Ie];for(const Je in Xe){const He=Xe[Je];He instanceof ae&&(He.isSpriteLoaded=Ue,He.fire(new o.z("isSpriteLoaded")))}}}setImages(te,pe,Ne){this.availableImages[te]||(this.availableImages[te]={});const{scope:Ue,images:Ie}=pe;if(this.availableImages[te][Ue]=Ie,this.workerSources[te]&&this.workerSources[te][Ue]){for(const Xe in this.workerSources[te][Ue]){const Je=this.workerSources[te][Ue][Xe];for(const He in Je)Je[He].availableImages=Ie}Ne()}else Ne()}setModels(te,{scope:pe,models:Ne},Ue){if(this.availableModels[te]||(this.availableModels[te]={}),this.availableModels[te][pe]=Ne,this.workerSources[te]&&this.workerSources[te][pe]){for(const Ie in this.workerSources[te][pe]){const Xe=this.workerSources[te][pe][Ie];for(const Je in Xe)Xe[Je].availableModels=Ne}Ue()}else Ue()}setProjection(te,pe){this.projections[te]=o.cm(pe)}setBrightness(te,pe,Ne){this.brightness=pe,Ne()}setWorldview(te,pe,Ne){this.worldview=pe,Ne()}setLayers(te,pe,Ne){this.getLayerIndex(te,pe.scope).replace(pe.layers,pe.options),Ne()}updateLayers(te,pe,Ne){this.getLayerIndex(te,pe.scope).update(pe.layers,pe.removedIds,pe.options),Ne()}loadTile(te,pe,Ne){pe.projection=this.projections[te]||this.defaultProjection,this.getWorkerSource(te,pe.type,pe.source,pe.scope).loadTile(pe,Ne)}decodeRasterArray(te,pe,Ne){this.getWorkerSource(te,pe.type,pe.source,pe.scope).decodeRasterArray(pe,Ne)}reloadTile(te,pe,Ne){pe.projection=this.projections[te]||this.defaultProjection,this.getWorkerSource(te,pe.type,pe.source,pe.scope).reloadTile(pe,Ne)}abortTile(te,pe,Ne){this.getWorkerSource(te,pe.type,pe.source,pe.scope).abortTile(pe,Ne)}removeTile(te,pe,Ne){this.getWorkerSource(te,pe.type,pe.source,pe.scope).removeTile(pe,Ne)}removeSource(te,pe,Ne){if(!(this.workerSources[te]&&this.workerSources[te][pe.scope]&&this.workerSources[te][pe.scope][pe.type]&&this.workerSources[te][pe.scope][pe.type][pe.source]))return;const Ue=this.workerSources[te][pe.scope][pe.type][pe.source];delete this.workerSources[te][pe.scope][pe.type][pe.source],Ue.removeSource!==void 0?Ue.removeSource(pe,Ne):Ne()}loadWorkerSource(te,pe,Ne){try{this.self.importScripts(pe.url),Ne()}catch(Ue){Ne(Ue)}}syncRTLPluginState(te,pe,Ne){if(o.fH.isParsed())Ne(null,!0);else if(o.fH.isParsing())this.rtlPluginParsingListeners.push(Ne);else try{o.fH.setState(pe);const Ue=o.fH.getPluginURL();!o.fH.isLoaded()||o.fH.isParsed()||o.fH.isParsing()||Ue==null||(o.fH.setState({pluginStatus:o.fI.parsing,pluginURL:o.fH.getPluginURL()}),this.self.importScripts(Ue),o.fH.isParsed()?Ne(null,!0):this.rtlPluginParsingListeners.push(Ne))}catch(Ue){Ne(Ue)}}setDracoUrl(te,pe){this.dracoUrl=pe}getAvailableImages(te,pe){this.availableImages[te]||(this.availableImages[te]={});let Ne=this.availableImages[te][pe];return Ne||(Ne=[]),Ne}getAvailableModels(te,pe){this.availableModels[te]||(this.availableModels[te]={});let Ne=this.availableModels[te][pe];return Ne||(Ne={}),Ne}getLayerIndex(te,pe){this.layerIndexes[te]||(this.layerIndexes[te]={});let Ne=this.layerIndexes[te][pe];return Ne||(Ne=this.layerIndexes[te][pe]=new Y,Ne.scope=pe),Ne}getWorkerSource(te,pe,Ne,Ue){const Ie=this.workerSources;return Ie[te]||(Ie[te]={}),Ie[te][Ue]||(Ie[te][Ue]={}),Ie[te][Ue][pe]||(Ie[te][Ue][pe]={}),this.isSpriteLoaded[te]||(this.isSpriteLoaded[te]={}),Ie[te][Ue][pe][Ne]||(Ie[te][Ue][pe][Ne]=new this.workerSourceTypes[pe]({send:(Xe,Je,He,it,At,St)=>this.actor.send(Xe,Je,He,te,At,St),scheduler:this.actor.scheduler},this.getLayerIndex(te,Ue),this.getAvailableImages(te,Ue),this.getAvailableModels(te,Ue),this.isSpriteLoaded[te][Ue],void 0,this.brightness,this.worldview)),Ie[te][Ue][pe][Ne]}rasterizeImagesWorker(te,pe,Ne){const Ue=new Map;for(const[Ie,{image:Xe,imageVariant:Je}]of pe.tasks.entries()){const He=this.imageRasterizer.rasterize(Je,Xe,pe.scope,te);Ue.set(Ie,He)}Ne(void 0,Ue)}removeRasterizedImages(te,pe,Ne){this.imageRasterizer.removeImagesFromCacheByIds(pe.imageIds,pe.scope,te),Ne()}enforceCacheSizeLimit(te,pe){o.fJ(pe)}getWorkerPerformanceMetrics(te,pe,Ne){Ne(void 0,void 0)}}return o.fF(self)&&(self.worker=new Zi(self)),Zi}),x(["./shared"],function(o){var C="3.18.0";const R={create:"create",load:"load",fullLoad:"fullLoad"},F={mark(m){performance.mark(m)},measure(m,s,d){performance.measure(m,s,d)}};function $(m){const s=m.name.split("?")[0];return o.a(s)&&s.includes("mapbox-gl.js")?"javascript":o.a(s)&&s.includes("mapbox-gl.css")?"css":o.b(s)?"fontRange":o.c(s)?"sprite":o.i(s)?"style":o.d(s)?"tilejson":"other"}var Y,H={},X=function(){if(Y)return H;function m(f){return!s(f)}function s(f){return typeof window>"u"||typeof document>"u"?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var b,S,A=new Blob([""],{type:"text/javascript"}),E=URL.createObjectURL(A);try{S=new Worker(E),b=!0}catch{b=!1}return S&&S.terminate(),URL.revokeObjectURL(E),b}()?function(){var b=document.createElement("canvas");b.width=b.height=1;var S=b.getContext("2d");if(!S)return!1;var A=S.getImageData(0,0,1,1);return A&&A.width===b.width}()?(d[_=f&&f.failIfMajorPerformanceCaveat]===void 0&&(d[_]=function(b){var S,A=function(E){var D=document.createElement("canvas"),M=Object.create(m.webGLContextAttributes);return M.failIfMajorPerformanceCaveat=E,D.getContext("webgl2",M)}(b);if(!A)return!1;try{S=A.createShader(A.VERTEX_SHADER)}catch{return!1}return!(!S||A.isContextLost())&&(A.shaderSource(S,"void main() {}"),A.compileShader(S),A.getShaderParameter(S,A.COMPILE_STATUS)===!0)}(_)),d[_]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var _}Y=1,H.supported=m,H.notSupportedReason=s;var d={};return m.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},H}();function he(m,s,d){const f=document.createElement(m);return s!=null&&(f.className=s),d&&d.appendChild(f),f}function se(m,s,d){const f=document.createElementNS("http://www.w3.org/2000/svg",m);for(const _ of Object.keys(s))f.setAttributeNS(null,_,String(s[_]));return d&&d.appendChild(f),f}const de=typeof document<"u"?document.documentElement&&document.documentElement.style:null,K=de&&de.userSelect!==void 0?"userSelect":"WebkitUserSelect";let ge;function Ae(){de&&K&&(ge=de[K],de[K]="none")}function Te(){de&&K&&(de[K]=ge)}function Ce(m){m.preventDefault(),m.stopPropagation(),window.removeEventListener("click",Ce,!0)}function ne(){window.addEventListener("click",Ce,!0),window.setTimeout(()=>{window.removeEventListener("click",Ce,!0)},0)}function ae(m,s){const d=m.getBoundingClientRect();return ke(m,d,s)}function q(m,s){const d=m.getBoundingClientRect(),f=[];for(let _=0;_<s.length;_++)f.push(ke(m,d,s[_]));return f}function oe(m){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&m.button===2&&m.ctrlKey?0:m.button}function ke(m,s,d){const f=m.offsetWidth===s.width?1:m.offsetWidth/s.width;return new o.P((d.clientX-s.left)*f,(d.clientY-s.top)*f)}const Ve="01",ie="NO_ACCESS_TOKEN";class ze{constructor(s,d,f){this._transformRequestFn=s,this._customAccessToken=d,this._silenceAuthErrors=!!f,this._createSkuToken()}_createSkuToken(){const s=function(){let d="";for(let f=0;f<10;f++)d+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",Ve,d].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=s.token,this._skuTokenExpiresAt=s.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(s,d){return this._transformRequestFn&&this._transformRequestFn(s,d)||{url:s}}normalizeStyleURL(s,d){if(!o.h(s))return s;const f=Le(s);return f.params.push(`sdk=js-${C}`),f.path=`/styles/v1${f.path}`,this._makeAPIURL(f,this._customAccessToken||d)}normalizeGlyphsURL(s,d){if(!o.h(s))return s;const f=Le(s);return f.path=`/fonts/v1${f.path}`,this._makeAPIURL(f,this._customAccessToken||d)}normalizeModelURL(s,d){if(!o.h(s))return s;const f=Le(s);return f.path=`/models/v1${f.path}`,this._makeAPIURL(f,this._customAccessToken||d)}normalizeSourceURL(s,d,f,_){if(!o.h(s))return s;const b=Le(s);return b.path=`/v4/${b.authority}.json`,b.params.push("secure"),f&&b.params.push(`language=${f}`),_&&b.params.push(`worldview=${_}`),this._makeAPIURL(b,this._customAccessToken||d)}normalizeIconsetURL(s,d){const f=Le(s);return o.h(s)?(f.path=`/styles/v1${f.path}/iconset.pbf`,this._makeAPIURL(f,this._customAccessToken||d)):Ke(f)}normalizeSpriteURL(s,d,f,_){const b=Le(s);return o.h(s)?(b.path=`/styles/v1${b.path}/sprite${d}${f}`,this._makeAPIURL(b,this._customAccessToken||_)):(b.path+=`${d}${f}`,Ke(b))}normalizeTileURL(s,d,f){if(this._isSkuTokenExpired()&&this._createSkuToken(),s&&!o.h(s))return s;const _=Le(s);_.path=_.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${d||f&&_.authority!=="raster"&&f===512?"@2x":""}${o.k.supported?".webp":"$1"}`),_.authority==="raster"?_.path=`/${o.e.RASTER_URL_PREFIX}${_.path}`:_.authority==="rasterarrays"?_.path=`/${o.e.RASTERARRAYS_URL_PREFIX}${_.path}`:_.authority==="3dtiles"?_.path=`/${o.e.TILES3D_URL_PREFIX}${_.path}`:(_.path=_.path.replace(/^.+\/v4\//,"/"),_.path=`/${o.e.TILE_URL_VERSION}${_.path}`);const b=this._customAccessToken||function(S){for(const A of S){const E=A.match(/^access_token=(.*)$/);if(E)return E[1]}return null}(_.params)||o.e.ACCESS_TOKEN;return o.e.REQUIRE_ACCESS_TOKEN&&b&&this._skuToken&&_.params.push(`sku=${this._skuToken}`),this._makeAPIURL(_,b)}canonicalizeTileURL(s,d){const f=Le(s);if(!f.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!f.path.match(/\.[\w]+$/))return s;let _="mapbox://";f.path.match(/^\/raster\/v1\//)?_+=`raster/${f.path.replace(`/${o.e.RASTER_URL_PREFIX}/`,"")}`:f.path.match(/^\/rasterarrays\/v1\//)?_+=`rasterarrays/${f.path.replace(`/${o.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:_+=`tiles/${f.path.replace(`/${o.e.TILE_URL_VERSION}/`,"")}`;let b=f.params;return d&&(b=b.filter(S=>!S.match(/^access_token=/))),b.length&&(_+=`?${b.join("&")}`),_}canonicalizeTileset(s,d){const f=!!d&&o.h(d),_=[];for(const b of s.tiles||[])o.j(b)?_.push(this.canonicalizeTileURL(b,f)):_.push(b);return _}_makeAPIURL(s,d){const f="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",_=Le(o.e.API_URL);if(s.protocol=_.protocol,s.authority=_.authority,s.protocol==="http"){const b=s.params.indexOf("secure");b>=0&&s.params.splice(b,1)}if(_.path!=="/"&&(s.path=`${_.path}${s.path}`),!o.e.REQUIRE_ACCESS_TOKEN)return Ke(s);if(d=d||o.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!d)throw new Error(`An API access token is required to use Mapbox GL. ${f}`);if(d[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${f}`)}return s.params=s.params.filter(b=>b.indexOf("access_token")===-1),s.params.push(`access_token=${d||""}`),Ke(s)}}const ve=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function Le(m){const s=m.match(ve);if(!s)throw new Error("Unable to parse URL object");return{protocol:s[1],authority:s[2],path:s[3]||"/",params:s[4]?s[4].split("&"):[]}}function Ke(m){const s=m.params.length?`?${m.params.join("&")}`:"";return`${m.protocol}://${m.authority}${m.path}${s}`}const Pe="mapbox.eventData";function It(m){if(!m)return null;const s=m.split(".");if(!s||s.length!==3)return null;try{return JSON.parse(o.l(s[1]))}catch{return null}}class tt{constructor(s){this.type=s,this.anonId=null,this.anonIdTimestamp=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(s){const d=It(o.e.ACCESS_TOKEN);let f="";return f=d&&d.u?o.f(d.u):o.e.ACCESS_TOKEN||"",s?`${Pe}.${s}:${f}`:`${Pe}:${f}`}fetchEventData(){const s=o.s("localStorage"),d=this.getStorageKey(),f=this.getStorageKey("uuid"),_=this.getStorageKey("uuidTimestamp");if(s)try{const b=localStorage.getItem(d);b&&(this.eventData=JSON.parse(b));const S=localStorage.getItem(f);S&&(this.anonId=S);const A=localStorage.getItem(_);A&&(this.anonIdTimestamp=Number(A));const E=Date.now()-864e5;(!this.anonIdTimestamp||this.anonIdTimestamp<E)&&this.refreshUUID()}catch{o.w("Unable to read from LocalStorage")}}refreshUUID(){this.anonId=o.u(),this.anonIdTimestamp=Date.now()}saveEventData(){const s=o.s("localStorage"),d=this.getStorageKey(),f=this.getStorageKey("uuid"),_=this.getStorageKey("uuidTimestamp"),b=this.anonId,S=this.anonIdTimestamp;if(s&&b)try{localStorage.setItem(f,b),Object.keys(this.eventData).length>=1&&localStorage.setItem(d,JSON.stringify(this.eventData)),S&&localStorage.setItem(_,S.toString())}catch{o.w("Unable to write to LocalStorage")}}processRequests(s){}postEvent(s,d,f,_){if(!o.e.EVENTS_URL)return;const b=Le(o.e.EVENTS_URL);b.params.push(`access_token=${_||o.e.ACCESS_TOKEN||""}`);const S={event:this.type,created:new Date(s).toISOString()},A=d?Object.assign(S,d):S,E={url:Ke(b),headers:{"Content-Type":"text/plain"},body:JSON.stringify([A])};this.pendingRequest=o.p(E,D=>{this.pendingRequest=null,f(D),this.saveEventData(),this.processRequests(_)})}queueRequest(s,d){this.queue.push(s),this.processRequests(d)}}class zt extends tt{constructor(s){super("metrics"),s&&(this.data=s)}postMetricsEvent(s){if(!o.e.EVENTS_URL||!s&&!o.e.ACCESS_TOKEN)return;this.anonId||this.fetchEventData(),o.v(this.anonId)||this.refreshUUID();const d=Object.assign({},this.data,{sessionId:this.anonId});this.queueRequest({timestamp:Date.now(),payload:d},s)}processRequests(s){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:d,payload:f}=this.queue.shift();this.postEvent(d,f,()=>{},s)}}const vt=new class extends tt{constructor(m){super("appUserTurnstile"),this._customAccessToken=m}postTurnstileEvent(m,s){o.e.EVENTS_URL&&o.e.ACCESS_TOKEN&&Array.isArray(m)&&m.some(d=>o.h(d)||o.j(d))&&this.queueRequest(Date.now(),s)}processRequests(m){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.anonIdTimestamp&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const s=It(o.e.ACCESS_TOKEN),d=s?s.u:o.e.ACCESS_TOKEN;let f=d!==this.eventData.tokenU;o.v(this.anonId)||(this.refreshUUID(),f=!0);const _=this.queue.shift();if(this.eventData.lastSuccess){const b=new Date(this.eventData.lastSuccess),S=new Date(_),A=(_-this.eventData.lastSuccess)/864e5;f=f||A>=1||A<-1||b.getDate()!==S.getDate()}else f=!0;f?this.postEvent(_,{sdkIdentifier:"mapbox-gl-js",sdkVersion:C,skuId:Ve,"enabled.telemetry":!1,userId:this.anonId},b=>{b||(this.eventData.lastSuccess=_,this.eventData.tokenU=d)},m):this.processRequests()}},Ot=vt.postTurnstileEvent.bind(vt),Et=new class extends tt{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(m,s,d,f){this.skuToken=s,this.errorCb=f,o.e.EVENTS_URL&&(d||o.e.ACCESS_TOKEN?this.queueRequest({id:m,timestamp:Date.now()},d):this.errorCb(new Error(ie)))}processRequests(m){if(this.pendingRequest||this.queue.length===0)return;const{id:s,timestamp:d}=this.queue.shift();s&&this.success[s]||(this.anonId&&this.anonIdTimestamp||this.fetchEventData(),o.v(this.anonId)||this.refreshUUID(),this.postEvent(d,{sdkIdentifier:"mapbox-gl-js",sdkVersion:C,skuId:Ve,skuToken:this.skuToken,userId:this.anonId},f=>{f?this.errorCb(f):s&&(this.success[s]=!0)},m))}remove(){this.errorCb=null}},yi=Et.postMapLoadEvent.bind(Et),mi=new class extends tt{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(m){let s=this.mapInstanceIdMap.get(m);return s||(s=o.u(),this.mapInstanceIdMap.set(m,s)),s}getEventId(m){const s=this.eventIdPerMapInstanceMap.get(m)||0;return this.eventIdPerMapInstanceMap.set(m,s+1),s}postStyleLoadEvent(m,s){const{map:d,style:f,importedStyles:_}=s;if(!o.e.EVENTS_URL||!m&&!o.e.ACCESS_TOKEN)return;const b=this.getMapInstanceId(d),S={mapInstanceId:b,eventId:this.getEventId(b),style:f};_.length&&(S.importedStyles=_),this.queueRequest({timestamp:Date.now(),payload:S},m)}processRequests(m){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:s,payload:d}=this.queue.shift();this.postEvent(s,d,()=>{},m)}},ht=mi.postStyleLoadEvent.bind(mi),hi=new zt({attributes:[{name:"maps/js/layer-animations/style-with-appearances"}]}),ni=hi.postMetricsEvent.bind(hi),ui=new zt({attributes:[{name:"maps/js/layer-animations/runtime-appearances"}]}),Fi=ui.postMetricsEvent.bind(ui),Ii=new class extends tt{constructor(){super("gljs.performance")}postPerformanceEvent(m,s){o.e.EVENTS_URL&&(m||o.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:s},m)}processRequests(m){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:s,performanceData:d}=this.queue.shift(),f=function(_){const b=performance.getEntriesByType("resource"),S=performance.getEntriesByType("mark"),A=function(V){const Q={};if(V){for(const W in V)if(W!=="other")for(const J of V[W]){const ce=`${W}ResolveRangeMin`,_e=`${W}ResolveRangeMax`,xe=`${W}RequestCount`,fe=`${W}RequestCachedCount`;Q[ce]=Math.min(Q[ce]||1/0,J.startTime),Q[_e]=Math.max(Q[_e]||-1/0,J.responseEnd);const Fe=De=>{Q[De]===void 0&&(Q[De]=0),++Q[De]};J.transferSize!==void 0&&J.transferSize===0&&Fe(fe),Fe(xe)}}return Q}(function(V,Q){const W={};if(V)for(const J of V){const ce=Q(J);W[ce]===void 0&&(W[ce]=[]),W[ce].push(J)}return W}(b,$)),E=window.devicePixelRatio,D=navigator.connection||navigator.mozConnection||navigator.webkitConnection,M=D?D.effectiveType:void 0,B={counters:[],metadata:[],attributes:[]},z=(V,Q,W)=>{W!=null&&V.push({name:Q,value:W.toString()})};for(const V in A)z(B.counters,V,A[V]);if(_.interactionRange[0]!==1/0&&_.interactionRange[1]!==-1/0&&(z(B.counters,"interactionRangeMin",_.interactionRange[0]),z(B.counters,"interactionRangeMax",_.interactionRange[1])),S)for(const V of Object.values(R)){const Q=S.find(W=>W.name===V);Q&&z(B.counters,V,Q.startTime)}return z(B.counters,"visibilityHidden",_.visibilityHidden),z(B.attributes,"style",function(V){if(V)for(const Q of V){const W=Q.name.split("?")[0];if(o.i(W)){const J=W.split("/").slice(-2);if(J.length===2)return`mapbox://styles/${J[0]}/${J[1]}`}}}(b)),z(B.attributes,"terrainEnabled",_.terrainEnabled?"true":"false"),z(B.attributes,"fogEnabled",_.fogEnabled?"true":"false"),z(B.attributes,"projection",_.projection),z(B.attributes,"zoom",_.zoom),z(B.metadata,"devicePixelRatio",E),z(B.metadata,"connectionEffectiveType",M),z(B.metadata,"navigatorUserAgent",navigator.userAgent),z(B.metadata,"screenWidth",window.screen.width),z(B.metadata,"screenHeight",window.screen.height),z(B.metadata,"windowWidth",window.innerWidth),z(B.metadata,"windowHeight",window.innerHeight),z(B.metadata,"mapWidth",_.width/E),z(B.metadata,"mapHeight",_.height/E),z(B.metadata,"webglRenderer",_.renderer),z(B.metadata,"webglVendor",_.vendor),z(B.metadata,"sdkVersion",C),z(B.metadata,"sdkIdentifier","mapbox-gl-js"),B}(d);for(const _ of f.metadata);for(const _ of f.counters);for(const _ of f.attributes);this.postEvent(s,f,()=>{},m)}},Bi=Ii.postPerformanceEvent.bind(Ii),Ki=new class extends tt{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(m,s,d,f){if(!o.e.API_URL||!o.e.SESSION_PATH)return;const _=Le(o.e.API_URL+o.e.SESSION_PATH);_.params.push(`sku=${s||""}`),_.params.push(`access_token=${f||o.e.ACCESS_TOKEN||""}`);const b={url:Ke(_),headers:{"Content-Type":"text/plain"}};this.pendingRequest=o.g(b,S=>{this.pendingRequest=null,d(S),this.saveEventData(),this.processRequests(f)})}getSessionAPI(m,s,d,f){this.skuToken=s,this.errorCb=f,o.e.SESSION_PATH&&o.e.API_URL&&(d||o.e.ACCESS_TOKEN?this.queueRequest({id:m,timestamp:Date.now()},d):this.errorCb(new Error(ie)))}processRequests(m){if(this.pendingRequest||this.queue.length===0)return;const{id:s,timestamp:d}=this.queue.shift();s&&this.success[s]||this.getSession(d,this.skuToken,f=>{f?this.errorCb(f):s&&(this.success[s]=!0)},m)}remove(){this.errorCb=null}},$r=Ki.getSessionAPI.bind(Ki),nn=new Set;function Gn(m,s){s?nn.add(m):nn.delete(m)}class Tr{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages={}}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(s,d){this._updatedSourceCaches[s]=d,this.setDirty()}discardSourceCacheUpdate(s){delete this._updatedSourceCaches[s]}updateLayer(s){const d=s.scope;this._updatedLayers[d]=this._updatedLayers[d]||new Set,this._updatedLayers[d].add(s.id),this.setDirty()}removeLayer(s){const d=s.scope;this._removedLayers[d]=this._removedLayers[d]||{},this._updatedLayers[d]=this._updatedLayers[d]||new Set,this._removedLayers[d][s.id]=s,this._updatedLayers[d].delete(s.id),this._updatedPaintProps.delete(s.fqid),this.setDirty()}getRemovedLayer(s){return this._removedLayers[s.scope]?this._removedLayers[s.scope][s.id]:null}discardLayerRemoval(s){this._removedLayers[s.scope]&&delete this._removedLayers[s.scope][s.id]}getLayerUpdatesByScope(){const s={};for(const d in this._updatedLayers)s[d]=s[d]||{},s[d].updatedIds=Array.from(this._updatedLayers[d].values());for(const d in this._removedLayers)s[d]=s[d]||{},s[d].removedIds=Object.keys(this._removedLayers[d]);return s}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(s){this._updatedPaintProps.add(s.fqid),this.setDirty()}getUpdatedImages(s){return this._updatedImages[s]?Array.from(this._updatedImages[s].values()):[]}updateImage(s,d){this._updatedImages[d]=this._updatedImages[d]||new Set,this._updatedImages[d].add(o.I.toString(s)),this.setDirty()}resetUpdatedImages(s){this._updatedImages[s]&&this._updatedImages[s].clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages={}}}function jt(m){const{userImage:s}=m;return!!(s&&s.render&&s.render())&&(m.data.replace(new Uint8Array(s.data.buffer)),!0)}class bi extends o.E{constructor(s){super(),this.imageProviders=new Map,this.images=new Map,this.updatedImages=new Map,this.callbackDispatchedThisFrame=new Map,this.loaded=new Map,this.requestors=[],this.patterns=new Map,this.patternsInFlight=new Set,this.atlasImage=new Map,this.atlasTexture=new Map,this.dirty=!0,this.spriteFormat=s,s!=="raster"&&o.r()&&(this.imageRasterizerDispatcher=new o.D(o.t(),this,"Image Rasterizer Worker",1))}addScope(s){this.loaded.set(s,!1),this.imageProviders.set(s,new Map),this.images.set(s,new Map),this.updatedImages.set(s,new Set),this.callbackDispatchedThisFrame.set(s,new Set),this.patterns.set(s,new Map),this.atlasImage.set(s,new o.q({width:1,height:1}))}removeScope(s){this.loaded.delete(s),this.imageProviders.delete(s),this.images.delete(s),this.updatedImages.delete(s),this.callbackDispatchedThisFrame.delete(s),this.patterns.delete(s),this.atlasImage.delete(s);const d=this.atlasTexture.get(s);d&&(d.destroy(),this.atlasTexture.delete(s))}addImageProvider(s,d){this.imageProviders.has(d)||this.imageProviders.set(d,new Map),this.imageProviders.get(d).set(s.id,s)}removeImageProvider(s,d){this.imageProviders.has(d)&&this.imageProviders.get(d).delete(s)}getPendingImageProviders(){const s=[];for(const d of this.imageProviders.values())for(const f of d.values())f.hasPendingRequests()&&s.push(f);return s}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new o.x),this._imageRasterizer}isLoaded(){for(const s of this.loaded.keys())if(!this.loaded.get(s))return!1;return!0}setLoaded(s,d){if(this.loaded.get(d)!==s&&(this.loaded.set(d,s),s)){for(const{ids:f,callback:_}of this.requestors)this._notify(f,d,_);this.requestors=[]}}hasImage(s,d){return!!this.getImage(s,d)}getImage(s,d){return this.images.get(d).get(s.toString())}addImage(s,d,f){this._validate(s,f)&&this.images.get(d).set(s.toString(),f)}_validate(s,d){let f=!0;return this._validateStretch(d.stretchX,d.data&&d.data.width)||(this.fire(new o.y(new Error(`Image "${s.name}" has invalid "stretchX" value`))),f=!1),this._validateStretch(d.stretchY,d.data&&d.data.height)||(this.fire(new o.y(new Error(`Image "${s.name}" has invalid "stretchY" value`))),f=!1),this._validateContent(d.content,d)||(this.fire(new o.y(new Error(`Image "${s.name}" has invalid "content" value`))),f=!1),f}_validateStretch(s,d){if(!s)return!0;let f=0;for(const _ of s){if(_[0]<f||_[1]<_[0]||d<_[1])return!1;f=_[1]}return!0}_validateContent(s,d){return s?s.length!==4||!d.usvg&&(s[0]<0||d.data.width<s[0]||s[1]<0||d.data.height<s[1]||s[2]<0||d.data.width<s[2]||s[3]<0||d.data.height<s[3])?!1:!(s[2]<s[0]||s[3]<s[1]):!0}updateImage(s,d,f){const _=this.images.get(d).get(s.toString());f.version=_.version+1,this.images.get(d).set(s.toString(),f),this.updatedImages.get(d).add(s),this.removeFromImageRasterizerCache(s,d)}clearUpdatedImages(s){this.updatedImages.get(s).clear()}removeFromImageRasterizerCache(s,d){this.spriteFormat!=="raster"&&(o.r()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[s],scope:d}):this.imageRasterizer.removeImagesFromCacheByIds([s],d))}removeImage(s,d){const f=this.images.get(d),_=f.get(s.toString());f.delete(s.toString()),this.patterns.get(d).delete(s.toString()),this.removeFromImageRasterizerCache(s,d),_.userImage&&_.userImage.onRemove&&_.userImage.onRemove()}listImages(s){return Array.from(this.images.get(s).keys()).map(d=>o.I.from(d))}getImages(s,d,f){const _=[],b=[],S=this.imageProviders.get(d);for(const M of s){if(!M.iconsetId){_.push(M);continue}const B=S.get(M.iconsetId);B&&(this.getImage(M,d)?b.push(M):B.addPendingRequest(M))}if(_.length===0)return void this._notify(b,d,f);let A=!0;const E=!!this.loaded.get(d),D=this.images.get(d);if(!E)for(const M of _)D.has(M.toString())||(A=!1);E||A?this._notify(_,d,f):this.requestors.push({ids:_,scope:d,callback:f})}rasterizeImages(s,d){const f=new Map,{tasks:_,scope:b}=s;for(const[S,A]of _.entries()){const E=this.getImage(A.id,b);E&&f.set(S,{image:E,imageVariant:A})}this._rasterizeImages(b,f,d)}_rasterizeImages(s,d,f){if(o.r())this.imageRasterizerDispatcher.getActor().send("rasterizeImagesWorker",{tasks:d,scope:s},f);else{const _=new Map;for(const[b,{image:S,imageVariant:A}]of d.entries())_.set(b,this.imageRasterizer.rasterize(A,S,s,0));f(void 0,_)}}getUpdatedImages(s){return this.updatedImages.get(s)||new Set}_notify(s,d,f){const _=this.images.get(d),b=new Map;for(const S of s){if(!_.get(S.toString())){if(S.iconsetId)continue;this.fire(new o.z("styleimagemissing",{id:S.name}))}const A=_.get(S.toString());if(!A){o.w(`Image "${S.name}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`);continue}const E={data:A.usvg?null:A.data.clone(),pixelRatio:A.pixelRatio,sdf:A.sdf,usvg:A.usvg,version:A.version,stretchX:A.stretchX,stretchY:A.stretchY,content:A.content,hasRenderCallback:!!(A.userImage&&A.userImage.render)};A.usvg&&Object.assign(E,{width:A.icon.usvg_tree.width,height:A.icon.usvg_tree.height}),b.set(o.I.toString(S),E)}f(null,b)}getPixelSize(s){const{width:d,height:f}=this.atlasImage.get(s);return{width:d,height:f}}getPattern(s,d,f){const _=s.toString(),b=this.patterns.get(d),S=b.get(_),A=this.getImage(s,d);if(!A)return null;if(S){if(S.position.version===A.version)return S.position;S.position.version=A.version}else{if(A.usvg&&!A.data){const E=this.getPatternInFlightId(_,d);if(this.patternsInFlight.has(E))return null;this.patternsInFlight.add(E);const D=new o.A(s).scaleSelf(o.o.devicePixelRatio),M=new Map([[D.toString(),{image:A,imageVariant:D}]]);return this._rasterizeImages(d,M,(B,z)=>this.storePatternImage(D,d,A,f,z)),null}this.storePattern(s,d,A)}return this._updatePatternAtlas(d,f),b.get(_).position}getPatternInFlightId(s,d){return o.B(s,d)}hasPatternsInFlight(){return this.patternsInFlight.size!==0}storePatternImage(s,d,f,_,b){const S=s.toString(),A=b?b.get(S):void 0;A&&(f.data=A,this.storePattern(s.id,d,f),this._updatePatternAtlas(d,_),this.patternsInFlight.delete(this.getPatternInFlightId(s.id.toString(),d)))}storePattern(s,d,f){const _={w:f.data.width+2*o.C,h:f.data.height+2*o.C,x:0,y:0},b=new o.F(_,f,o.C);this.patterns.get(d).set(s.toString(),{bin:_,position:b})}destroyAtlasTextures(){for(const s of this.atlasTexture.values())s&&s.destroy();this.atlasTexture.clear()}bind(s,d){const f=s.gl;let _=this.atlasTexture.get(d);_?this.dirty&&(_.update(this.atlasImage.get(d)),this.dirty=!1):(_=new o.T(s,this.atlasImage.get(d),f.RGBA8),this.atlasTexture.set(d,_)),_.bind(f.LINEAR,f.CLAMP_TO_EDGE)}_updatePatternAtlas(s,d){const f=this.patterns.get(s),_=Array.from(f.values()).map(({bin:D})=>D),{w:b,h:S}=o.G(_),A=this.atlasImage.get(s);A.resize({width:b||1,height:S||1});const E=this.images.get(s);for(const[D,{bin:M,position:B}]of f.entries()){let z=B.padding;const V=M.x+z,Q=M.y+z,W=E.get(D).data,J=W.width,ce=W.height;z=z>1?z-1:z,o.q.copy(W,A,{x:0,y:0},{x:V,y:Q},{width:J,height:ce},d),o.q.copy(W,A,{x:0,y:ce-z},{x:V,y:Q-z},{width:J,height:z},d),o.q.copy(W,A,{x:0,y:0},{x:V,y:Q+ce},{width:J,height:z},d),o.q.copy(W,A,{x:J-z,y:0},{x:V-z,y:Q},{width:z,height:ce},d),o.q.copy(W,A,{x:0,y:0},{x:V+J,y:Q},{width:z,height:ce},d),o.q.copy(W,A,{x:J-z,y:ce-z},{x:V-z,y:Q-z},{width:z,height:z},d),o.q.copy(W,A,{x:0,y:ce-z},{x:V+J,y:Q-z},{width:z,height:z},d),o.q.copy(W,A,{x:0,y:0},{x:V+J,y:Q+ce},{width:z,height:z},d),o.q.copy(W,A,{x:J-z,y:0},{x:V-z,y:Q+ce},{width:z,height:z},d)}this.dirty=!0}beginFrame(){for(const s of this.images.keys())this.callbackDispatchedThisFrame.set(s,new Set)}dispatchRenderCallbacks(s,d){const f=this.images.get(d);for(const _ of s){if(this.callbackDispatchedThisFrame.get(d).has(_.toString()))continue;this.callbackDispatchedThisFrame.get(d).add(_.toString());const b=f.get(_.toString());jt(b)&&this.updateImage(_,d,b)}}destroy(){this.imageRasterizerDispatcher&&this.imageRasterizerDispatcher.remove()}}function ar(m){const s=m.value,d=m.valueSpec,f=m.style,_=m.styleSpec,b=m.key,S=m.arrayElementValidator||mr;if(!Array.isArray(s))return[new o.V(b,s,`array expected, ${o.K(s)} found`)];if(d.length&&s.length!==d.length)return[new o.V(b,s,`array length ${d.length} expected, length ${s.length} found`)];if(d["min-length"]&&s.length<d["min-length"])return[new o.V(b,s,`array length at least ${d["min-length"]} expected, length ${s.length} found`)];let A={type:d.value,values:d.values,minimum:d.minimum,maximum:d.maximum,function:void 0};_.$version<7&&(A.function=d.function),o.H(d.value)&&(A=d.value);let E=[];for(let D=0;D<s.length;D++)E=E.concat(S({array:s,arrayIndex:D,value:s[D],valueSpec:A,style:f,styleSpec:_,key:`${b}[${D}]`},!0));return E}function li(m){const s=m.key,d=m.value,f=m.valueSpec;if(!o.L(d))return[new o.V(s,d,`number expected, ${o.K(d)} found`)];if(d!=d)return[new o.V(s,d,"number expected, NaN found")];if("minimum"in f){let _=f.minimum;if(Array.isArray(f.minimum)&&(_=f.minimum[m.arrayIndex]),d<_)return[new o.V(s,d,`${d} is less than the minimum value ${_}`)]}if("maximum"in f){let _=f.maximum;if(Array.isArray(f.maximum)&&(_=f.maximum[m.arrayIndex]),d>_)return[new o.V(s,d,`${d} is greater than the maximum value ${_}`)]}return[]}function ai(m){const s=m.key,d=m.value;if(!o.H(d))return[new o.V(s,d,`object expected, ${o.K(d)} found`)];const f=m.valueSpec,_=o.J(d.type);let b,S,A,E={};const D=_!=="categorical"&&d.property===void 0,M=!D,B=function(W){const J=W.stops;return Array.isArray(J)&&Array.isArray(J[0])&&o.H(J[0][0])}(d),z=sn({key:m.key,value:m.value,valueSpec:m.styleSpec.function,style:m.style,styleSpec:m.styleSpec,objectElementValidators:{stops:function(W){if(_==="identity")return[new o.V(W.key,W.value,'identity function may not have a "stops" property')];let J=[];const ce=W.value;return J=J.concat(ar({key:W.key,value:ce,valueSpec:W.valueSpec,style:W.style,styleSpec:W.styleSpec,arrayElementValidator:V})),Array.isArray(ce)&&ce.length===0&&J.push(new o.V(W.key,ce,"array must have at least one stop")),J},default:function(W){return mr({key:W.key,value:W.value,valueSpec:f,style:W.style,styleSpec:W.styleSpec})}}});return _==="identity"&&D&&z.push(new o.V(m.key,m.value,'missing required property "property"')),_==="identity"||d.stops||z.push(new o.V(m.key,m.value,'missing required property "stops"')),_==="exponential"&&f.expression&&!o.M(f)&&z.push(new o.V(m.key,m.value,"exponential functions not supported")),m.styleSpec.$version>=8&&(M&&!o.N(f)?z.push(new o.V(m.key,m.value,"property functions not supported")):D&&!o.O(f)&&z.push(new o.V(m.key,m.value,"zoom functions not supported"))),_!=="categorical"&&!B||d.property!==void 0||z.push(new o.V(m.key,m.value,'"property" property is required')),z;function V(W){let J=[];const ce=W.value,_e=W.key;if(!Array.isArray(ce))return[new o.V(_e,ce,`array expected, ${o.K(ce)} found`)];if(ce.length!==2)return[new o.V(_e,ce,`array length 2 expected, length ${ce.length} found`)];if(B){if(!o.H(ce[0]))return[new o.V(_e,ce,`object expected, ${o.K(ce[0])} found`)];const xe=ce[0];if(xe.zoom===void 0)return[new o.V(_e,ce,"object stop key must have zoom")];if(xe.value===void 0)return[new o.V(_e,ce,"object stop key must have value")];const fe=o.J(xe.zoom);if(typeof fe!="number")return[new o.V(_e,xe.zoom,"stop zoom values must be numbers")];if(A&&A>fe)return[new o.V(_e,xe.zoom,"stop zoom values must appear in ascending order")];fe!==A&&(A=fe,S=void 0,E={}),J=J.concat(sn({key:`${_e}[0]`,value:ce[0],valueSpec:{zoom:{}},style:W.style,styleSpec:W.styleSpec,objectElementValidators:{zoom:li,value:Q}}))}else J=J.concat(Q({key:`${_e}[0]`,value:ce[0],style:W.style,styleSpec:W.styleSpec},ce));return o.Q(o.S(ce[1]))?J.concat([new o.V(`${_e}[1]`,ce[1],"expressions are not allowed in function stops.")]):J.concat(mr({key:`${_e}[1]`,value:ce[1],valueSpec:f,style:W.style,styleSpec:W.styleSpec}))}function Q(W,J){const ce=o.K(W.value),_e=o.J(W.value),xe=W.value!==null?W.value:J;if(b){if(ce!==b)return[new o.V(W.key,xe,`${ce} stop domain type must match previous stop domain type ${b}`)]}else b=ce;if(ce!=="number"&&ce!=="string"&&ce!=="boolean"&&typeof _e!="number"&&typeof _e!="string"&&typeof _e!="boolean")return[new o.V(W.key,xe,"stop domain value must be a number, string, or boolean")];if(ce!=="number"&&_!=="categorical"){let fe=`number expected, ${ce} found`;return o.N(f)&&_===void 0&&(fe+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new o.V(W.key,xe,fe)]}return _!=="categorical"||ce!=="number"||typeof _e=="number"&&isFinite(_e)&&Math.floor(_e)===_e?_!=="categorical"&&ce==="number"&&typeof _e=="number"&&typeof S=="number"&&S!==void 0&&_e<S?[new o.V(W.key,xe,"stop domain values must appear in ascending order")]:(S=_e,_==="categorical"&&_e in E?[new o.V(W.key,xe,"stop domain values must be unique")]:(E[_e]=!0,[])):[new o.V(W.key,xe,`integer expected, found ${String(_e)}`)]}}function Jt(m){const s=(m.expressionContext==="property"?o.W:o.U)(o.S(m.value),m.valueSpec);if(s.result==="error")return s.value.map(f=>new o.V(`${m.key}${f.key}`,m.value,f.message));const d=s.value.expression||s.value._styleExpression.expression;if(m.expressionContext==="property"&&m.propertyKey==="text-font"&&!d.outputDefined())return[new o.V(m.key,m.value,`Invalid data expression for "${m.propertyKey}". Output values must be contained as literals within the expression.`)];if(m.expressionContext==="property"&&m.propertyType==="layout"&&!o.Z(d))return[new o.V(m.key,m.value,'"feature-state" data expressions are not supported with layout properties.')];if(m.expressionContext==="filter")return Vi(d,m);if(m.expressionContext==="appearance")return fi(d,m);if(m.expressionContext&&m.expressionContext.indexOf("cluster")===0){if(!o.X(d,["zoom","feature-state"]))return[new o.V(m.key,m.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(m.expressionContext==="cluster-initial"&&!o.Y(d))return[new o.V(m.key,m.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function Vi(m,s){const d=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(s.valueSpec&&s.valueSpec.expression)for(const _ of s.valueSpec.expression.parameters)d.delete(_);if(d.size===0)return[];const f=[];return m instanceof o._&&d.has(m.name)?[new o.V(s.key,s.value,`["${m.name}"] expression is not supported in a filter for a ${s.object.type} layer with id: ${s.object.id}`)]:(m.eachChild(_=>{f.push(...Vi(_,s))}),f)}function fi(m,s){const d=new Set;if(s.valueSpec&&s.valueSpec.expression)for(const _ of s.valueSpec.expression.parameters)d.add(_);if(d.size===0)return[];const f=[];return m instanceof o._&&!d.has(m.name)?[new o.V(s.key,s.value,`["${m.name}"] is not an allowed parameter`)]:(m.eachChild(_=>{f.push(...fi(_,s))}),f)}function vi(m){const s=m.key,d=m.value,f=m.valueSpec,_=[];return Array.isArray(f.values)?f.values.indexOf(o.J(d))===-1&&_.push(new o.V(s,d,`expected one of [${f.values.join(", ")}], ${JSON.stringify(d)} found`)):Object.keys(f.values).indexOf(o.J(d))===-1&&_.push(new o.V(s,d,`expected one of [${Object.keys(f.values).join(", ")}], ${JSON.stringify(d)} found`)),_}function Pi(m){return o.a2(o.S(m.value))?Jt(Object.assign({},m,{expressionContext:"filter",valueSpec:m.styleSpec[`filter_${m.layerType||"fill"}`]})):Nr(m)}function Nr(m){const s=m.value,d=m.key;if(!Array.isArray(s))return[new o.V(d,s,`array expected, ${o.K(s)} found`)];if(s.length<1)return[new o.V(d,s,"filter array must have at least 1 element")];const f=m.styleSpec;let _=vi({key:`${d}[0]`,value:s[0],valueSpec:f.filter_operator});const b=()=>{s.length>=2&&(o.a0(s[1])||_.push(new o.V(`${d}[1]`,s[1],`string expected, ${o.K(s[1])} found`)));for(let S=2;S<s.length;S++)o.J(s[1])==="$type"?_=_.concat(vi({key:`${d}[${S}]`,value:s[S],valueSpec:f.geometry_type})):o.a0(s[S])||o.L(s[S])||o.$(s[S])||_.push(new o.V(`${d}[${S}]`,s[S],`string, number, or boolean expected, ${o.K(s[S])} found.`))};switch(o.J(s[0])){case"<":case"<=":case">":case">=":s.length>=2&&o.J(s[1])==="$type"&&_.push(new o.V(d,s,`"$type" cannot be use with operator "${s[0]}"`)),s.length!==3&&_.push(new o.V(d,s,`filter array for operator "${s[0]}" must have 3 elements`)),b();break;case"==":case"!=":s.length!==3&&_.push(new o.V(d,s,`filter array for operator "${s[0]}" must have 3 elements`)),b();break;case"in":case"!in":b();break;case"any":case"all":case"none":for(let S=1;S<s.length;S++)_=_.concat(Nr({key:`${d}[${S}]`,value:s[S],style:m.style,styleSpec:m.styleSpec}));break;case"has":case"!has":s.length!==2?_.push(new o.V(d,s,`filter array for "${s[0]}" operator must have 2 elements`)):o.a0(s[1])||_.push(new o.V(`${d}[1]`,s[1],`string expected, ${o.K(s[1])} found`))}return _}function er(m,s){const d=m.key,f=m.style,_=m.layer,b=m.styleSpec,S=m.value,A=m.objectKey,E=b[`${s}_${m.layerType}`];if(!E)return[];const D=A.match(/^(.*)-use-theme$/);if(D&&E[D[1]])return o.Q(o.S(S))?[].concat(mr({key:d,value:S,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:f,styleSpec:b,expressionContext:"property",propertyType:s,propertyKey:A})):mr({key:d,value:S,valueSpec:{type:"string"},style:f,styleSpec:b});const M=A.match(/^(.*)-transition$/);if(s==="paint"&&M&&E[M[1]]&&E[M[1]].transition)return mr({key:d,value:S,valueSpec:b.transition,style:f,styleSpec:b});const B=m.valueSpec||E[A];if(!B)return[new o.a3(d,S,`unknown property "${A}"`)];let z;if(o.a0(S)&&o.N(B)&&!B.tokens&&(z=/^{([^}]+)}$/.exec(S))){const Q=`\`{ "type": "identity", "property": ${z?JSON.stringify(z[1]):'"_"'} }\``;return[new o.V(d,S,`"${A}" does not support interpolation syntax
Use an identity property function instead: ${Q}.`)]}const V=[];if(m.layerType==="symbol")A!=="text-field"||!f||f.glyphs||f.imports||V.push(new o.V(d,S,'use of "text-field" requires a style "glyphs" property')),A==="text-font"&&o.a4(o.S(S))&&o.J(S.type)==="identity"&&V.push(new o.V(d,S,'"text-font" does not support identity functions'));else if(m.layerType==="model"&&s==="paint"&&_&&_.layout&&_.layout.hasOwnProperty("model-id")&&o.N(B)&&(o.a5(B)||o.O(B))){const Q=o.W(o.S(S),B).value,W="expression"in Q&&Q.expression||"_styleExpression"in Q&&Q._styleExpression&&Q._styleExpression.expression;W&&!o.X(W,["measure-light"])&&(A==="model-emissive-strength"&&o.Y(W)&&o.Z(W)||V.push(new o.V(d,S,`${A} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return V.concat(mr({key:m.key,value:S,valueSpec:B,style:f,styleSpec:b,expressionContext:"property",propertyType:s,propertyKey:A}))}function Wr(m){return er(m,"paint")}function kr(m){return er(m,"layout")}function di(m){let s=[];const d=m.value,f=m.key,_=m.style,b=m.styleSpec;if(!o.H(d))return[new o.V(f,d,"object expected")];d.type||d.ref||s.push(new o.V(f,d,'either "type" or "ref" is required'));let S=o.J(d.type);const A=o.J(d.ref);if(d.id){const E=o.J(d.id);for(let D=0;D<m.arrayIndex;D++){const M=_.layers[D];o.J(M.id)===E&&s.push(new o.V(f,d.id,`duplicate layer id "${E}", previously used at line ${M.id.__line__}`))}}if("ref"in d){let E;["type","source","source-layer","filter","layout"].forEach(D=>{D in d&&s.push(new o.V(f,d[D],`"${D}" is prohibited for ref layers`))}),_.layers.forEach(D=>{o.J(D.id)===A&&(E=D)}),E?E.ref?s.push(new o.V(f,d.ref,"ref cannot reference another ref layer")):S=o.J(E.type):typeof A=="string"&&s.push(new o.V(f,d.ref,`ref layer "${A}" not found`))}else if(S!=="background"&&S!=="sky"&&S!=="slot")if(d.source)if(o.a0(d.source)){const E=_.sources&&_.sources[d.source],D=E&&o.J(E.type);E?D==="vector"&&S==="raster"?s.push(new o.V(f,d.source,`layer "${d.id}" requires a raster source`)):D==="raster"&&S!=="raster"?s.push(new o.V(f,d.source,`layer "${d.id}" requires a vector source`)):D!=="vector"||d["source-layer"]?D==="raster-dem"&&S!=="hillshade"?s.push(new o.V(f,d.source,"raster-dem source can only be used with layer type 'hillshade'.")):D!=="raster-array"||["raster","raster-particle"].includes(S)?S==="line"&&d.paint&&(d.paint["line-gradient"]||d.paint["line-trim-offset"])&&D==="geojson"&&!E.lineMetrics?s.push(new o.V(f,d,`layer "${d.id}" specifies a line-gradient, which requires the GeoJSON source to have \`lineMetrics\` enabled.`)):S==="raster-particle"&&D!=="raster-array"&&s.push(new o.V(f,d.source,`layer "${d.id}" requires a 'raster-array' source.`)):s.push(new o.V(f,d.source,"raster-array source can only be used with layer type 'raster'.")):s.push(new o.V(f,d,`layer "${d.id}" must specify a "source-layer"`)):s.push(new o.V(f,d.source,`source "${d.source}" not found`))}else s.push(new o.V(`${f}.source`,d.source,'"source" must be a string'));else s.push(new o.V(f,d,'missing required property "source"'));return s=s.concat(sn({key:f,value:d,valueSpec:b.layer,style:m.style,styleSpec:m.styleSpec,objectElementValidators:{"*":()=>[],type:()=>mr({key:`${f}.type`,value:d.type,valueSpec:b.layer.type,style:m.style,styleSpec:m.styleSpec,object:d,objectKey:"type"}),filter:E=>Pi(Object.assign({layerType:S},E)),layout:E=>sn({layer:d,key:E.key,value:E.value,valueSpec:{},style:E.style,styleSpec:E.styleSpec,objectElementValidators:{"*":D=>kr(Object.assign({layerType:S},D))}}),paint:E=>sn({layer:d,key:E.key,value:E.value,valueSpec:{},style:E.style,styleSpec:E.styleSpec,objectElementValidators:{"*":D=>Wr(Object.assign({layerType:S,layer:d},D))}}),appearances(E){const D=ar({key:E.key,value:E.value,valueSpec:E.valueSpec,style:E.style,styleSpec:E.styleSpec,arrayElementValidator:z=>function(V){const{key:Q,layer:W,layerType:J}=V,ce=o.J(V.value),_e=o.J(ce.name),xe=o.J(ce.condition),fe=sn({key:Q,value:ce,valueSpec:V.styleSpec.appearance,style:V.style,styleSpec:V.styleSpec,objectElementValidators:{condition:Fe=>function(De){const Oe=[];return Oe.push(...Jt({key:De.key,value:De.object.condition,valueSpec:o.a6.appearance.condition,expressionContext:"appearance"})),Oe}(Object.assign({layer:W,layerType:J},Fe)),properties:Fe=>function(De){const Oe=[],{styleSpec:Ee,layer:Se,layerType:qe}=De,Ye=Ee[`paint_${qe}`],Qe=Ee[`layout_${qe}`],at=De.object[De.objectKey];for(const nt in at){const ft=nt in Ye?"paint":nt in Qe?"layout":void 0;if(!ft){Oe.push(new o.V(De.key,nt,`unknown property "${nt}" for layer type "${qe}"`));continue}const Nt=Object.assign({},De,{key:`${De.key}.${nt}`,object:at,objectKey:nt,layer:Se,layerType:qe,value:at[nt],valueSpec:ft==="paint"?Ye[nt]:Qe[nt]});Oe.push(...er(Nt,ft))}return Oe}(Object.assign({layer:W,layerType:J},Fe))}});return _e!=="hidden"&&xe===void 0&&fe.push(new o.V(V.key,"name",'Appearance with name different than "hidden" must have a condition')),fe}(Object.assign({layerType:S,layer:d},z))}),M=Array.isArray(E.value)?E.value:[],B=new Set;return M.forEach((z,V)=>{const Q=o.J(z.name);if(Q)if(B.has(Q)){const W=o.J(d.id);D.push(new o.V(E.key,Q,`Duplicated appearance name "${Q}" for layer "${W}"`))}else B.add(Q)}),D}}})),s}function or({key:m,value:s}){return o.a0(s)?[]:[new o.V(m,s,`string expected, ${o.K(s)} found`)]}const jn={promoteId:function m({key:s,value:d}){if(o.a0(d))return or({key:s,value:d});if(Array.isArray(d)){const _=[],b=o.S(d),S=o.U(b);return S.result==="error"&&S.value.forEach(A=>{_.push(new o.V(`${s}${A.key}`,null,`${A.message}`))}),o.X(S.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||_.push(new o.V(`${s}`,null,"promoteId expression should be only feature dependent")),_}if(!o.H(d))return[new o.V(s,d,`string, expression or object expected, "${o.K(d)}" found`)];const f=[];for(const _ in d)f.push(...m({key:`${s}.${_}`,value:d[_]}));return f}};function Da(m){const s=m.value,d=m.key,f=m.styleSpec,_=m.style;if(!o.H(s))return[new o.V(d,s,`object expected, ${o.K(s)} found`)];if(!("type"in s))return[new o.V(d,s,'"type" is required')];const b=o.J(s.type);let S=[];switch(["vector","raster","raster-dem","raster-array"].includes(b)&&("url"in s||"tiles"in s||S.push(new o.a3(d,s,'Either "url" or "tiles" is required.'))),b){case"vector":case"raster":case"raster-dem":case"raster-array":return S=S.concat(sn({key:d,value:s,valueSpec:f[`source_${b.replace("-","_")}`],style:m.style,styleSpec:f,objectElementValidators:jn})),S;case"geojson":if(S=sn({key:d,value:s,valueSpec:f.source_geojson,style:_,styleSpec:f,objectElementValidators:jn}),"cluster"in s&&"clusterProperties"in s){if(!o.H(s.clusterProperties))return[new o.V(`${d}.clusterProperties`,s,`object expected, ${o.K(s)} found`)];for(const A in s.clusterProperties){const E=s.clusterProperties[A];if(!Array.isArray(E))return[new o.V(`${d}.clusterProperties.${A}`,E,"array expected")];const[D,M]=E,B=typeof D=="string"?[D,["accumulated"],["get",A]]:D;S.push(...Jt({key:`${d}.${A}.map`,value:M,expressionContext:"cluster-map"})),S.push(...Jt({key:`${d}.${A}.reduce`,value:B,expressionContext:"cluster-reduce"}))}}return S;case"video":return sn({key:d,value:s,valueSpec:f.source_video,style:_,styleSpec:f});case"image":return sn({key:d,value:s,valueSpec:f.source_image,style:_,styleSpec:f});case"canvas":return[new o.V(d,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return vi({key:`${d}.type`,value:s.type,valueSpec:{values:ms(f)}})}}function ms(m){return m.source.reduce((s,d)=>{const f=m[d];return f.type.type==="enum"&&(s=s.concat(Object.keys(f.type.values||{}))),s},[])}function pt(m){const s=m.value,d=m.styleSpec,f=d.light,_=m.style;if(s===void 0)return[];if(!o.H(s))return[new o.V("light",s,`object expected, ${o.K(s)} found`)];let b=[];for(const S in s){const A=S.match(/^(.*)-transition$/),E=S.match(/^(.*)-use-theme$/);b=b.concat(E&&f[E[1]]?mr({key:S,value:s[S],valueSpec:{type:"string"},style:_,styleSpec:d}):A&&f[A[1]]&&f[A[1]].transition?mr({key:S,value:s[S],valueSpec:d.transition,style:_,styleSpec:d}):f[S]?mr({key:S,value:s[S],valueSpec:f[S],style:_,styleSpec:d}):[new o.V(S,s[S],`unknown property "${S}"`)])}return b}function oi(m){const s=m.value;if(!s)return[];const d=m.key;if(!o.H(s))return[new o.V(d,s,`object expected, ${o.K(s)} found`)];let f=[];const _=m.styleSpec,b=_["light-3d"],S=m.style,A=m.style.lights;for(const M of["type","id"])if(!(M in s))return f=f.concat([new o.V(d,s,`missing property "${M}"`)]),f;if(!o.a0(s.type))return f=f.concat([new o.V(`${d}.type`,s.type,"string expected")]),f;if(A)for(let M=0;M<m.arrayIndex;M++){const B=o.J(s.type),z=A[M];o.J(z.type)===B&&f.push(new o.V(d,s.id,`duplicate light type "${s.type}", previously defined at line ${z.id.__line__}`))}const E=`properties_light_${s.type}`;if(!(E in _))return f=f.concat([new o.V(`${d}.type`,s,`Invalid light type ${s.type}`)]),f;const D=_[E];for(const M in s)if(M==="properties"){const B=s[M];if(!o.H(B))return f=f.concat([new o.V("properties",B,`object expected, ${o.K(B)} found`)]),f;for(const z in B){const V=z.match(/^(.*)-transition$/),Q=z.match(/^(.*)-use-theme$/);f=f.concat(Q&&D[Q[1]]?mr({key:M,value:B[z],valueSpec:{type:"string"},style:S,styleSpec:_}):V&&D[V[1]]&&D[V[1]].transition?mr({key:M,value:s[M],valueSpec:_.transition,style:S,styleSpec:_}):D[z]?mr({key:z,value:B[z],valueSpec:D[z],style:S,styleSpec:_}):[new o.a3(m.key,B[z],`unknown property "${z}"`)])}}else f=f.concat(b[M]?mr({key:M,value:s[M],valueSpec:b[M],style:S,styleSpec:_}):[new o.a3(M,s[M],`unknown property "${M}"`)]);return f}function Mi(m){const s=m.value,d=m.key,f=m.style,_=m.styleSpec,b=_.terrain;if(s==null)return[];if(!o.H(s))return[new o.V("terrain",s,`object expected, ${o.K(s)} found`)];let S=[];for(const A in s){const E=A.match(/^(.*)-transition$/),D=A.match(/^(.*)-use-theme$/);S=S.concat(D&&b[D[1]]?mr({key:A,value:s[A],valueSpec:{type:"string"},style:f,styleSpec:_}):E&&b[E[1]]&&b[E[1]].transition?mr({key:A,value:s[A],valueSpec:_.transition,style:f,styleSpec:_}):b[A]?mr({key:A,value:s[A],valueSpec:b[A],style:f,styleSpec:_}):[new o.a3(A,s[A],`unknown property "${A}"`)])}if(s.source)if(o.a0(s.source)){const A=f.sources&&f.sources[s.source],E=A&&o.J(A.type);A?E!=="raster-dem"&&S.push(new o.V(`${d}.source`,s.source,`terrain cannot be used with a source of type ${E}, it only be used with a "raster-dem" source type`)):S.push(new o.V(`${d}.source`,s.source,`source "${s.source}" not found`))}else S.push(new o.V(`${d}.source`,s.source,"source must be a string"));else S.push(new o.V(d,s,'terrain is missing required property "source"'));return S}function qi(m){const s=m.value,d=m.style,f=m.styleSpec,_=f.fog;if(s===void 0)return[];if(!o.H(s))return[new o.V("fog",s,`object expected, ${o.K(s)} found`)];let b=[];for(const S in s){const A=S.match(/^(.*)-transition$/),E=S.match(/^(.*)-use-theme$/);b=b.concat(E&&_[E[1]]?mr({key:S,value:s[S],valueSpec:{type:"string"},style:d,styleSpec:f}):A&&_[A[1]]&&_[A[1]].transition?mr({key:S,value:s[S],valueSpec:f.transition,style:d,styleSpec:f}):_[S]?mr({key:S,value:s[S],valueSpec:_[S],style:d,styleSpec:f}):[new o.a3(S,s[S],`unknown property "${S}"`)])}return b}const Xn={"*":()=>[],array:ar,boolean:function(m){const s=m.value,d=m.key;return o.$(s)?[]:[new o.V(d,s,`boolean expected, ${o.K(s)} found`)]},number:li,color:function({key:m,value:s}){return o.a0(s)?o.a1.parseCSSColor(s)===null?[new o.V(m,s,`color expected, "${s}" found`)]:[]:[new o.V(m,s,`color expected, ${o.K(s)} found`)]},enum:vi,filter:Pi,function:ai,layer:di,object:sn,source:Da,model:o.a7,light:pt,"light-3d":oi,terrain:Mi,fog:qi,string:or,formatted:function(m){return or(m).length===0?[]:Jt(m)},resolvedImage:function(m){return or(m).length===0?[]:Jt(m)},projection:function(m){const s=m.value,d=m.styleSpec,f=d.projection,_=m.style;if(o.H(s)){let b=[];for(const S in s)b=b.concat(mr({key:S,value:s[S],valueSpec:f[S],style:_,styleSpec:d}));return b}return o.a0(s)?[]:[new o.V("projection",s,`object or string expected, ${o.K(s)} found`)]},import:function(m){const s=m.key,{value:d,styleSpec:f}=m;if(!o.H(d))return[new o.V(s,d,"import must be an object")];const{data:_,...b}=d;Object.defineProperty(b,"__line__",{value:d.__line__,enumerable:!1});let S=sn(Object.assign({},m,{value:b,valueSpec:f.import}));return o.J(b.id)===""&&S.push(new o.V(`${m.key}.id`,b,"import id can't be an empty string")),_&&(S=S.concat(Ma(_,f,{key:`${m.key}.data`}))),S},iconset:function(m){const s=m.value,d=m.key,f=m.styleSpec,_=m.style;if(!o.H(s))return[new o.V(d,s,"object expected")];if(!s.type)return[new o.V(d,s,'"type" is required')];const b=o.J(s.type);let S=[];if(S=S.concat(sn({key:d,value:s,valueSpec:f[`iconset_${b}`],style:_,styleSpec:f})),function(A,E){return!(A!=="source"||!E.source)}(b,s)){const A=_.sources&&_.sources[s.source],E=A&&o.J(A.type);A?E!=="raster-array"&&S.push(new o.V(d,s.source,`iconset cannot be used with a source of type ${String(E)}, it only be used with a "raster-array" source type`)):S.push(new o.V(d,s.source,`source "${s.source}" not found`))}return S}};function mr(m,s=!1){const d=m.value,f=m.valueSpec,_=m.styleSpec;if(f.expression){if(o.a4(o.J(d)))return ai(m);if(o.Q(o.S(d)))return Jt(m)}if(f.type&&Xn[f.type]){const b=Xn[f.type](m);return s===!0&&b.length>0&&Array.isArray(m.value)?Jt(m):b}return sn(Object.assign({},m,{valueSpec:f.type?_[f.type]:f}))}function sn(m){const s=m.key,d=m.value,f=m.valueSpec||{},_=m.objectElementValidators||{},b=m.style,S=m.styleSpec;if(!o.H(d))return[new o.V(s,d,`object expected, ${o.K(d)} found`)];let A=[];for(const E in d){const D=E.split(".")[0];let M;_[D]?M=_[D]:f[D]?M=mr:_["*"]?M=_["*"]:f["*"]&&(M=mr),M?A=A.concat(M({key:(s&&`${s}.`)+E,value:d[E],valueSpec:f[D]||f["*"],style:b,styleSpec:S,object:d,objectKey:E},d)):A.push(new o.a3(s,d[E],`unknown property "${E}"`))}for(const E in f){if(_[E])continue;const D=f[E];D.required&&D.default===void 0&&d[E]===void 0&&A.push(new o.V(s,d,`missing required property "${E}"`))}return A}function al({key:m,value:s}){const d=or({key:m,value:s});if(d.length)return d;const f=s;return f.indexOf("{fontstack}")===-1&&d.push(new o.V(m,s,'"glyphs" url must include a "{fontstack}" token')),f.indexOf("{range}")===-1&&d.push(new o.V(m,s,'"glyphs" url must include a "{range}" token')),d}function Ma(m,s=o.a6,d={}){return sn({key:d.key||"",value:m,valueSpec:Object.assign(s.$root,{"*":{type:"*"}}),styleSpec:s,style:m,objectElementValidators:{glyphs:al}})}function fs(m,s=o.a6){return Ie(Ma(m,s))}const ol=m=>Ie(Da(m)),ll=m=>Ie(pt(m)),wt=m=>Ie(oi(m)),Xa=m=>Ie(Mi(m)),Oi=m=>Ie(qi(m)),Xr=m=>Ie(function(s){const d=s.value,f=s.style,_=s.styleSpec,b=_.snow;if(d===void 0)return[];if(!o.H(d))return[new o.V("snow",d,`object expected, ${o.K(d)} found`)];let S=[];for(const A in d){const E=A.match(/^(.*)-transition$/);S=S.concat(E&&b[E[1]]&&b[E[1]].transition?mr({key:A,value:d[A],valueSpec:_.transition,style:f,styleSpec:_}):b[A]?mr({key:A,value:d[A],valueSpec:b[A],style:f,styleSpec:_}):[new o.a3(A,d[A],`unknown property "${A}"`)])}return S}(m)),Zi=m=>Ie(function(s){const d=s.value,f=s.style,_=s.styleSpec,b=_.rain;if(d===void 0)return[];if(!o.H(d))return[new o.V("rain",d,`object expected, ${o.K(d)} found`)];let S=[];for(const A in d){const E=A.match(/^(.*)-transition$/);S=S.concat(E&&b[E[1]]&&b[E[1]].transition?mr({key:A,value:d[A],valueSpec:_.transition,style:f,styleSpec:_}):b[A]?mr({key:A,value:d[A],valueSpec:b[A],style:f,styleSpec:_}):[new o.a3(A,d[A],`unknown property "${A}"`)])}return S}(m)),Ze=m=>Ie(di(m)),te=m=>Ie(Pi(m)),pe=m=>Ie(Wr(m)),Ne=m=>Ie(kr(m)),Ue=m=>Ie(o.a7(m));function Ie(m){return m.slice().sort((s,d)=>s.line&&d.line?s.line-d.line:0)}function Xe(m,s){let d=!1;if(s&&s.length)for(const f of s)f instanceof o.a3?o.w(f.message):(m.fire(new o.y(new Error(f.message))),d=!0);return d}const Je=o.a6.light;let He;class it extends o.E{constructor(s,d="flat"){super(),this._transitionable=new o.a8(He||(He=new o.a9({anchor:new o.aa(Je.anchor),position:new o.ab(Je.position),color:new o.aa(Je.color),intensity:new o.aa(Je.intensity)}))),this.setLight(s,d),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(s,d,f={}){this._validate(ll,s,f)||(this._transitionable.setTransitionOrValue(s),this.id=d)}updateTransitions(s){this._transitioning=this._transitionable.transitioned(s,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(s){this.properties=this._transitioning.possiblyEvaluate(s)}_validate(s,d,f){return(!f||f.validate!==!1)&&Xe(this,s.call(fs,Object.assign({value:d,style:{glyphs:!0,sprite:!0},styleSpec:o.a6})))}}const At=o.a6.terrain;let St=class extends o.E{constructor(m,s,d,f,_){super(),this.scope=d,this._transitionable=new o.a8(new o.a9({source:new o.aa(At.source),exaggeration:new o.aa(At.exaggeration)}),d,f),this._transitionable.setTransitionOrValue(m,f),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=s,this.worldview=_}get(){return this._transitionable.serialize()}set(m,s){this._transitionable.setTransitionOrValue(m,s)}updateTransitions(m){this._transitioning=this._transitionable.transitioned(m,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(m){this.properties=this._transitioning.possiblyEvaluate(m)}getExaggeration(m){return this._transitioning.possiblyEvaluate(new o.ac(m,{worldview:this.worldview})).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;const m=this._transitionable._values.exaggeration;if(!m)return null;const s=m.value.expression;if(!s)return null;let d=-1,f=-1,_=1;for(const b of s.zoomStops)_=s.evaluate(new o.ac(b,{worldview:this.worldview})),_>.01?(d=b,f=-1):f=b;return _<.01&&d>0&&f>d?[d,f]:null}isZoomDependent(){const m=this._transitionable._values.exaggeration;return m!=null&&m.value!=null&&m.value.expression!=null&&m.value.expression instanceof o.ad}};const Ht=.05;function ci(m,s,d,f){const _=o.ah(45,65,d),[b,S]=wi(m,f);let A=1-Math.min(1,Math.exp((s-b)/(S-b)*-6));return A*=A*A,A=Math.min(1,1.00747*A),A*_*m.alpha}function wi(m,s){const d=.5/Math.tan(.5*s);return[m.range[0]+d,m.range[1]+d]}function zi(m,s,d,f,_){const b=o.af([],[s,d,f],_.mercatorFogMatrix);return ci(m,o.ag(b),_.pitch,_._fov)}function $i(m,s,d,f,_,b,S){const A=[[d,f,0],[_,f,0],[_,b,0],[d,b,0]];let E=Number.MAX_VALUE,D=-Number.MAX_VALUE;for(const M of A){const B=o.af([],M,s),z=o.ag(B);E=Math.min(E,z),D=Math.max(D,z)}return[ci(m,E,S.pitch,S._fov),ci(m,D,S.pitch,S._fov)]}const Ei=o.a6.fog;class Ni extends o.E{constructor(s,d,f,_){super();const b=new o.a9({range:new o.aa(Ei.range),color:new o.aa(Ei.color),"color-use-theme":new o.aa({type:"string","property-type":"data-constant",default:"default"}),"high-color":new o.aa(Ei["high-color"]),"high-color-use-theme":new o.aa({type:"string","property-type":"data-constant",default:"default"}),"space-color":new o.aa(Ei["space-color"]),"space-color-use-theme":new o.aa({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new o.aa(Ei["horizon-blend"]),"star-intensity":new o.aa(Ei["star-intensity"]),"vertical-range":new o.aa(Ei["vertical-range"])});this._transitionable=new o.a8(b,f,new Map(_)),this.set(s,_),this._transitioning=this._transitionable.untransitioned(),this._transform=d,this.properties=new o.ai(b),this.scope=f}get state(){const s=this._transform,d=s.projection.name==="globe",f=o.aj(s.zoom),_=this.properties.get("range"),b=[.5,3];return{range:d?[o.ak(b[0],_[0],f),o.ak(b[1],_[1],f)]:_,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(s,d,f={}){if(this._validate(Oi,s,f))return;const _=Object.assign({},s);for(const b of Object.keys(Ei))_[b]===void 0&&(_[b]=Ei[b].default);this._options=_,this._transitionable.setTransitionOrValue(this._options,d)}getOpacity(s){if(!this._transform.projection.supportsFog)return 0;const d=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:o.ah(45,65,s))*d.a}getOpacityAtLatLng(s,d){return this._transform.projection.supportsFog?function(f,_,b){const S=o.ae.fromLngLat(_),A=b.elevation?b.elevation.getAtPointOrZero(S):0;return zi(f,S.x,S.y,A,b)}(this.state,s,d):0}getOpacityForTile(s){if(!this._transform.projection.supportsFog)return[1,1];const d=this._transform.calculateFogTileMatrix(s.toUnwrapped());return $i(this.state,d,0,0,o.al,o.al,this._transform)}getOpacityForBounds(s,d,f,_,b){return this._transform.projection.supportsFog?$i(this.state,s,d,f,_,b,this._transform):[1,1]}getFovAdjustedRange(s){return this._transform.projection.supportsFog?wi(this.state,s):[0,1]}isVisibleOnFrustum(s){if(!this._transform.projection.supportsFog)return!1;const d=[4,5,6,7];for(const f of d){const _=s.points[f];let b;if(_[2]>=0)b=_;else{const S=s.points[f-4];b=o.am(S,_,S[2]/(S[2]-_[2]))}if(zi(this.state,b[0],b[1],0,this._transform)>=Ht)return!0}return!1}updateConfig(s){this._transitionable.setTransitionOrValue(this._options,new Map(s))}updateTransitions(s){this._transitioning=this._transitionable.transitioned(s,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(s){this.properties=this._transitioning.possiblyEvaluate(s)}_validate(s,d,f){return(!f||f.validate!==!1)&&Xe(this,s.call(fs,Object.assign({value:d,style:{glyphs:!0,sprite:!0},styleSpec:o.a6})))}}let Br,Nn,gn,Rn=class extends o.E{constructor(m,s,d,f){super();const _=Br||(Br=new o.a9({density:new o.aa(o.a6.snow.density),intensity:new o.aa(o.a6.snow.intensity),color:new o.aa(o.a6.snow.color),opacity:new o.aa(o.a6.snow.opacity),vignette:new o.aa(o.a6.snow.vignette),"vignette-color":new o.aa(o.a6.snow["vignette-color"]),"center-thinning":new o.aa(o.a6.snow["center-thinning"]),direction:new o.aa(o.a6.snow.direction),"flake-size":new o.aa(o.a6.snow["flake-size"])}));this._transitionable=new o.a8(_,d,new Map(f)),this.set(m,f),this._transitioning=this._transitionable.untransitioned(),this.properties=new o.ai(_),this.scope=d}get state(){const m=this.properties.get("opacity"),s=this.properties.get("color"),d=this.properties.get("direction"),f=o.an(d[0]),_=-Math.max(o.an(d[1]),.01),b=[Math.cos(f)*Math.cos(_),Math.sin(f)*Math.cos(_),Math.sin(_)],S=this.properties.get("vignette"),A=this.properties.get("vignette-color");return A.a=S,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new o.ao(s.r,s.g,s.b,s.a*m),direction:b,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:A}}get(){return this._transitionable.serialize()}set(m,s,d={}){if(this._validate(Xr,m,d))return;const f=Object.assign({},m),_=o.a6.snow;for(const b of Object.keys(_))f[b]===void 0&&(f[b]=_[b].default);this._options=f,this._transitionable.setTransitionOrValue(this._options,s)}updateConfig(m){this._transitionable.setTransitionOrValue(this._options,new Map(m))}updateTransitions(m){this._transitioning=this._transitionable.transitioned(m,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(m){this.properties=this._transitioning.possiblyEvaluate(m)}_validate(m,s,d){return(!d||d.validate!==!1)&&Xe(this,m.call(fs,Object.assign({value:s,style:{glyphs:!0,sprite:!0},styleSpec:o.a6})))}},Yr=class extends o.E{constructor(m,s,d,f){super();const _=Nn||(Nn=new o.a9({density:new o.aa(o.a6.rain.density),intensity:new o.aa(o.a6.rain.intensity),color:new o.aa(o.a6.rain.color),opacity:new o.aa(o.a6.rain.opacity),vignette:new o.aa(o.a6.rain.vignette),"vignette-color":new o.aa(o.a6.rain["vignette-color"]),"center-thinning":new o.aa(o.a6.rain["center-thinning"]),direction:new o.aa(o.a6.rain.direction),"droplet-size":new o.aa(o.a6.rain["droplet-size"]),"distortion-strength":new o.aa(o.a6.rain["distortion-strength"])}));this._transitionable=new o.a8(_,d,new Map(f)),this.set(m,f),this._transitioning=this._transitionable.untransitioned(),this.properties=new o.ai(_),this.scope=d}get state(){const m=this.properties.get("opacity"),s=this.properties.get("color"),d=this.properties.get("direction"),f=o.an(d[0]),_=-Math.max(o.an(d[1]),.01),b=[Math.cos(f)*Math.cos(_),Math.sin(f)*Math.cos(_),Math.sin(_)],S=this.properties.get("vignette-color");return S.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new o.ao(s.r,s.g,s.b,s.a*m),direction:b,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:S}}get(){return this._transitionable.serialize()}set(m,s,d={}){if(this._validate(Zi,m,d))return;const f=Object.assign({},m),_=o.a6.rain;for(const b of Object.keys(_))f[b]===void 0&&(f[b]=_[b].default);this._options=f,this._transitionable.setTransitionOrValue(this._options,s)}updateConfig(m){this._transitionable.setTransitionOrValue(this._options,new Map(m))}updateTransitions(m){this._transitioning=this._transitionable.transitioned(m,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(m){this.properties=this._transitioning.possiblyEvaluate(m)}_validate(m,s,d){return(!d||d.validate!==!1)&&Xe(this,m.call(fs,Object.assign({value:s,style:{glyphs:!0,sprite:!0},styleSpec:o.a6})))}};class cr extends o.E{constructor(s,d,f,_){super(),this.scope=f,this._options=s,this.properties=new o.ai(d),this._transitionable=new o.a8(d,f,new Map(_)),this._transitionable.setTransitionOrValue(s.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(s){this._transitionable.setTransitionOrValue(this._options.properties,new Map(s))}updateTransitions(s){this._transitioning=this._transitionable.transitioned(s,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(s){this.properties=this._transitioning.possiblyEvaluate(s)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(s,d){this._options=s,this._transitionable.setTransitionOrValue(s.properties,d)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}const Jr=()=>gn||(gn=new o.a9({color:new o.aa(o.a6.properties_light_ambient.color),"color-use-theme":new o.aa({type:"string",default:"default","property-type":"data-constant"}),intensity:new o.aa(o.a6.properties_light_ambient.intensity)}));let Or;const Lr=()=>Or||(Or=new o.a9({direction:new o.ap(o.a6.properties_light_directional.direction),color:new o.aa(o.a6.properties_light_directional.color),"color-use-theme":new o.aa({type:"string",default:"default","property-type":"data-constant"}),intensity:new o.aa(o.a6.properties_light_directional.intensity),"cast-shadows":new o.aa(o.a6.properties_light_directional["cast-shadows"]),"shadow-quality":new o.aa(o.a6.properties_light_directional["shadow-quality"]),"shadow-intensity":new o.aa(o.a6.properties_light_directional["shadow-intensity"]),"shadow-draw-before-layer":new o.aa(o.a6.properties_light_directional["shadow-draw-before-layer"])}));class yn{constructor(s,d,f){this.screenBounds=s,this.cameraPoint=f.getCameraPoint(),this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=d,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,f)}static createFromScreenPoints(s,d){let f,_;if(s instanceof o.P||typeof s[0]=="number"){const b=o.P.convert(s);f=[b],_=d.isPointAboveHorizon(b)}else{const b=o.P.convert(s[0]),S=o.P.convert(s[1]),A=b.add(S)._div(2);f=[b,S],_=o.aq(b,S).every(E=>d.isPointAboveHorizon(E))&&d.isPointAboveHorizon(A)}return new yn(f,_,d)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(s){return o.aq(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],s)}bufferedCameraGeometry(s){const d=this.screenBounds[0],f=this.screenBounds.length===1?this.screenBounds[0].add(new o.P(1,1)):this.screenBounds[1],_=o.aq(d,f,0,!1);return this.cameraPoint.y>f.y&&(this.cameraPoint.x>d.x&&this.cameraPoint.x<f.x?_.splice(3,0,this.cameraPoint):this.cameraPoint.x>=f.x?_[2]=this.cameraPoint:this.cameraPoint.x<=d.x&&(_[3]=this.cameraPoint)),o.ar(_,s)}bufferedCameraGeometryGlobe(s){const d=this.screenBounds[0],f=this.screenBounds.length===1?this.screenBounds[0].add(new o.P(1,1)):this.screenBounds[1],_=o.aq(d,f,s),b=this.cameraPoint.clone();switch(3*((b.y>d.y)+(b.y>f.y))+((b.x>d.x)+(b.x>f.x))){case 0:_[0]=b,_[4]=b.clone();break;case 1:_.splice(1,0,b);break;case 2:_[1]=b;break;case 3:_.splice(4,0,b);break;case 5:_.splice(2,0,b);break;case 6:_[3]=b;break;case 7:_.splice(3,0,b);break;case 8:_[2]=b}return _}containsTile(s,d,f,_=0){const b=Math.max(s.queryPadding,s.evaluateQueryRenderedFeaturePadding())/d._pixelsPerMercatorPixel+1,S=f?this._bufferedCameraMercator(b,d):this._bufferedScreenMercator(b,d);let A=s.tileID.wrap+(S.unwrapped?_:0);const E=S.polygon.map(J=>o.as(s.tileTransform,J,A));if(!o.at(E,0,0,o.al,o.al))return;A=s.tileID.wrap+(this.screenGeometryMercator.unwrapped?_:0);const D=this.screenGeometryMercator.polygon.map(J=>o.au(s.tileTransform,J,A)),M=D.map(J=>new o.P(J[0],J[1])),B=d.getFreeCameraOptions().position||new o.ae(0,0,0),z=o.au(s.tileTransform,B,A),V=D.map(J=>{const ce=o.av(J,J,z);return o.aw(ce,ce),new o.ax(z,ce)}),Q=o.ay(s,1,d.zoom)*d._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:M,tilespaceRays:V,bufferedTilespaceGeometry:E,bufferedTilespaceBounds:(W=o.az(E),W.min.x=o.aA(W.min.x,0,o.al),W.min.y=o.aA(W.min.y,0,o.al),W.max.x=o.aA(W.max.x,0,o.al),W.max.y=o.aA(W.max.y,0,o.al),W),tile:s,tileID:s.tileID,pixelToTileUnitsFactor:Q};var W}_bufferedScreenMercator(s,d){const f=ns(s);if(this._screenRaycastCache[f])return this._screenRaycastCache[f];{let _;return _=d.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(s),d):{polygon:this.bufferedScreenGeometry(s).map(b=>d.pointCoordinate3D(b)),unwrapped:!0},this._screenRaycastCache[f]=_,_}}_bufferedCameraMercator(s,d){const f=ns(s);if(this._cameraRaycastCache[f])return this._cameraRaycastCache[f];{let _;return _=d.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(s),d):{polygon:this.bufferedCameraGeometry(s).map(b=>d.pointCoordinate3D(b)),unwrapped:!0},this._cameraRaycastCache[f]=_,_}}_projectAndResample(s,d){const f=function(b,S){const A=o.aB([],S.pixelMatrix,S.globeMatrix),E=[0,-o.aD,0,1],D=[0,o.aD,0,1],M=[0,0,0,1];o.aC(E,E,A),o.aC(D,D,A),o.aC(M,M,A);const B=new o.P(E[0]/E[3],E[1]/E[3]),z=new o.P(D[0]/D[3],D[1]/D[3]),V=o.aE(b,B)&&E[3]<M[3],Q=o.aE(b,z)&&D[3]<M[3];if(!V&&!Q)return null;const W=function(Oe,Ee,Se){for(let qe=1;qe<Oe.length;qe++){const Ye=Is(Ee.pointCoordinate3D(Oe[qe-1]).x),Qe=Is(Ee.pointCoordinate3D(Oe[qe]).x);if(Se<0){if(Ye<Qe)return{idx:qe,t:-Ye/(Qe-1-Ye)}}else if(Qe<Ye)return{idx:qe,t:(1-Ye)/(Qe+1-Ye)}}return null}(b,S,V?-1:1);if(!W)return null;const{idx:J,t:ce}=W;let _e=J>1?Es(b.slice(0,J),S):[],xe=J<b.length?Es(b.slice(J),S):[];_e=_e.map(Oe=>new o.P(Is(Oe.x),Oe.y)),xe=xe.map(Oe=>new o.P(Is(Oe.x),Oe.y));const fe=[..._e];fe.length===0&&fe.push(xe[xe.length-1]);const Fe=o.ak(fe[fe.length-1].y,(xe.length===0?_e[0]:xe[0]).y,ce);let De;return De=V?[new o.P(0,Fe),new o.P(0,0),new o.P(1,0),new o.P(1,Fe)]:[new o.P(1,Fe),new o.P(1,1),new o.P(0,1),new o.P(0,Fe)],fe.push(...De),xe.length===0?fe.push(_e[0]):fe.push(...xe),{polygon:fe.map(Oe=>new o.ae(Oe.x,Oe.y)),unwrapped:!1}}(s,d);if(f)return f;const _=function(b,S){let A=!1,E=-1/0,D=0;for(let B=0;B<b.length-1;B++)b[B].x>E&&(E=b[B].x,D=B);for(let B=0;B<b.length-1;B++){const z=(D+B)%(b.length-1),V=b[z],Q=b[z+1];Math.abs(V.x-Q.x)>.5&&(V.x<Q.x?(V.x+=1,z===0&&(b[b.length-1].x+=1)):(Q.x+=1,z+1===b.length-1&&(b[0].x+=1)),A=!0)}const M=o.aF(S.center.lng);return A&&M<Math.abs(M-1)&&b.forEach(B=>{B.x-=1}),{polygon:b,unwrapped:A}}(Es(s,d).map(b=>new o.P(Is(b.x),b.y)),d);return{polygon:_.polygon.map(b=>new o.ae(b.x,b.y)),unwrapped:_.unwrapped}}}function Es(m,s){return o.aG(m,d=>{const f=s.pointCoordinate3D(d);d.x=f.x,d.y=f.y},1/256)}function Is(m){return m<0?1+m%1:m%1}function ns(m){return 100*m|0}function wl(m,s,d,f,_){const b=function(A,E){if(A)return _(A);if(E){if(m.url&&E.tiles&&m.tiles&&delete m.tiles,E.variants){if(!Array.isArray(E.variants))return _(new Error("variants must be an array"));for(const M of E.variants){if(M==null||typeof M!="object"||M.constructor!==Object)return _(new Error("variant must be an object"));if(!Array.isArray(M.capabilities))return _(new Error("capabilities must be an array"));if(M.capabilities.length===1&&M.capabilities[0]==="meshopt"){E=Object.assign(E,M);break}}}const D=o.aH(Object.assign({},E,m),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","extra_bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);D.tiles=s.canonicalizeTileset(D,m.url),_(null,D)}},S=function(A,E,D){if(!A)return null;if(!E&&!D)return A;D=D||A.worldview_default;const M=Object.values(A.language||{});if(M.length===0)return null;const B=Object.values(A.worldview||{});if(B.length===0)return null;const z=M.every(Q=>Q===E),V=B.every(Q=>Q===D);return z&&V?A:E in(A.language_options||{})||D in(A.worldview_options||{})?null:A.language_options&&A.worldview_options?A:null}(m.data,d,f);return S?o.o.frame(()=>b(null,S)):m.url?o.m(s.transformRequest(s.normalizeSourceURL(m.url,null,d,f),o.R.Source),b):o.o.frame(()=>{const{data:A,...E}=m;b(null,E)})}function Zs(m,s){const d=Math.pow(2,s.z),f=Math.floor(o.aF(m.getWest())*d),_=Math.floor(o.aJ(m.getNorth())*d),b=Math.ceil(o.aF(m.getEast())*d),S=Math.ceil(o.aJ(m.getSouth())*d);return s.x>=f&&s.x<b&&s.y>=_&&s.y<S}class Oa{constructor(s,d,f){this.bounds=s?o.aI.convert(this.validateBounds(s)):null,this.minzoom=d||0,this.maxzoom=f||24}validateBounds(s){return Array.isArray(s)&&s.length===4?[Math.max(-180,s[0]),Math.max(-90,s[1]),Math.min(180,s[2]),Math.min(90,s[3])]:[-180,-90,180,90]}addExtraBounds(s){if(s){this.extraBounds||(this.extraBounds=[]);for(const d of s)this.extraBounds.push(o.aI.convert(this.validateBounds(d)))}}contains(s){if(s.z>this.maxzoom||s.z<this.minzoom||this.bounds&&!Zs(this.bounds,s))return!1;if(!this.extraBounds)return!0;for(const d of this.extraBounds)if(Zs(d,s))return!0;return!1}static fromTileJSON(s){if(!s.bounds&&!s.extra_bounds)return null;const d=new Oa(s.bounds,s.minzoom,s.maxzoom);return d.addExtraBounds(s.extra_bounds),d}}class Xs extends o.E{constructor(s,d,f,_){if(super(),this.id=s,this.dispatcher=f,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,Object.assign(this,o.aH(d,["url","scheme","tileSize","promoteId"])),this._options=Object.assign({type:"vector"},d),this._collectResourceTiming=!!d.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(_),this._tileWorkers={},this._deduped=new o.aK}load(s){this._loaded=!1,this.fire(new o.z("dataloading",{dataType:"source"}));const d=Array.isArray(this.map._language)?this.map._language.join():this.map._language,f=this.map.getWorldview();this._tileJSONRequest=wl(this._options,this.map._requestManager,d,f,(_,b)=>{if(this._tileJSONRequest=null,this._loaded=!0,_)d&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${d}`),f&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${f}`),this.fire(new o.y(_));else if(b){if(Object.assign(this,b),this.hasWorldviews=!!b.worldview_options,b.worldview_default&&(this.worldviewDefault=b.worldview_default),b.vector_layers){this.vectorLayers=b.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(const S of b.vector_layers)this.vectorLayerIds.push(S.id),b.worldview&&b.worldview[S.source]&&this.localizableLayerIds.add(S.id)}this.tileBounds=Oa.fromTileJSON(b),Ot(b.tiles,this.map._requestManager._customAccessToken),this.fire(new o.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.z("data",{dataType:"source",sourceDataType:"content"}))}s&&s(_)})}loaded(){return this._loaded}hasTile(s){return!this.tileBounds||this.tileBounds.contains(s.canonical)}onAdd(s){this.map=s,this.load()}reload(){this.cancelTileJSONRequest();const s=o.B(this.id,this.scope);this.load(()=>this.map.style.clearSource(s))}setTiles(s){return this._options.tiles=s,this.reload(),this}setUrl(s){return this.url=s,this._options.url=s,this.reload(),this}onRemove(s){this.cancelTileJSONRequest()}serialize(){return Object.assign({},this._options)}loadTile(s,d){const f=s.tileID.canonical.url(this.tiles,this.scheme),_=this.map._requestManager.normalizeTileURL(f),b=this.map._requestManager.transformRequest(_,o.R.Tile),S=this.map.style?this.map.style.getLut(this.scope):null,A=S?{image:S.image.clone()}:null,E={request:b,data:void 0,uid:s.uid,tileID:s.tileID,tileZoom:s.tileZoom,zoom:s.tileID.overscaledZ,maxZoom:this.maxzoom,lut:A,tileSize:this.tileSize*s.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:o.o.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:s.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:s.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor(),worldview:this.map.getWorldview()||this.worldviewDefault,indoor:this.map.getIndoorTileOptions(this.id,this.scope)};if(this.hasWorldviews&&o.h(f)&&(E.localizableLayerIds=this.localizableLayerIds),E.request.collectResourceTiming=this._collectResourceTiming,s.actor&&s.state!=="expired")s.state==="loading"?s.reloadCallback=d:s.request=s.actor.send("reloadTile",E,D.bind(this));else if(s.actor=this._tileWorkers[_]=this._tileWorkers[_]||this.dispatcher.getActor(),this.dispatcher.ready)s.request=s.actor.send("loadTile",E,D.bind(this),void 0,!0);else{const M=o.aL.call({deduped:this._deduped},E,(B,z)=>{if(B||!z)D.call(this,B);else{const V=o.aM(z.responseHeaders);E.data={rawData:z.rawData.slice(0),expires:V.expires,cacheControl:V.cacheControl},s.actor&&s.actor.send("loadTile",E,D.bind(this),void 0,!0)}},!0);s.request={cancel:M}}function D(M,B){return delete s.request,s.aborted?d(null):M&&M instanceof o.aN&&M.status!==404?d(M):(B&&B.resourceTiming&&(s.resourceTiming=B.resourceTiming),this.map._refreshExpiredTiles&&B&&s.setExpiryData(B),s.loadVectorData(B,this.map.painter),o.aO(this.dispatcher),d(null,B),void(s.reloadCallback&&(this.loadTile(s,s.reloadCallback),s.reloadCallback=null)))}}abortTile(s){s.request&&(s.request.cancel(),delete s.request),s.actor&&s.actor.send("abortTile",{uid:s.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(s,d){s.actor&&s.actor.send("removeTile",{uid:s.uid,type:this.type,source:this.id,scope:this.scope}),s.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class Ms extends o.E{constructor(s,d,f,_){super(),this.id=s,this.dispatcher=f,this.setEventedParent(_),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=Object.assign({type:"raster"},d),Object.assign(this,o.aH(d,["url","scheme","tileSize"]))}load(s){this._loaded=!1,this.fire(new o.z("dataloading",{dataType:"source"}));const d=this.map.getWorldview();this._tileJSONRequest=wl(this._options,this.map._requestManager,null,d,(f,_)=>{this._tileJSONRequest=null,this._loaded=!0,f?this.fire(new o.y(f)):_&&(Object.assign(this,_),_.raster_layers&&(this.rasterLayers=_.raster_layers,this.rasterLayerIds=this.rasterLayers.map(b=>b.id)),this.tileBounds=Oa.fromTileJSON(_),Ot(_.tiles),this.fire(new o.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.z("data",{dataType:"source",sourceDataType:"content"}))),s&&s(f)})}loaded(){return this._loaded}onAdd(s){this.map=s,this.load()}reload(){this.cancelTileJSONRequest();const s=o.B(this.id,this.scope);this.load(()=>this.map.style.clearSource(s))}setTiles(s){return this._options.tiles=s,this.reload(),this}setUrl(s){return this.url=s,this._options.url=s,this.reload(),this}onRemove(s){this.cancelTileJSONRequest()}serialize(){return Object.assign({},this._options)}hasTile(s){return!this.tileBounds||this.tileBounds.contains(s.canonical)}loadTile(s,d){const f=o.o.devicePixelRatio>=2,_=this.map._requestManager.normalizeTileURL(s.tileID.canonical.url(this.tiles,this.scheme),f,this.tileSize);s.request=o.n(this.map._requestManager.transformRequest(_,o.R.Tile),(b,S,A)=>{if(delete s.request,s.aborted)return s.state="unloaded",d(null);if(b)return s.state="errored",d(b);if(!S)return d(null);const E=o.aM(A);this.map._refreshExpiredTiles&&s.setExpiryData(E),s.setTexture(S,this.map.painter),s.state="loaded",o.aO(this.dispatcher),d(null)})}abortTile(s,d){s.request&&(s.request.cancel(),delete s.request),d&&d()}unloadTile(s,d){s.texture&&s.texture instanceof o.T?(s.destroy(!1),s.texture&&s.texture instanceof o.T&&this.map.painter.saveTileTexture(s.texture)):s.destroy(),d&&d()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}function la([m,s],d,f,{scaled:_=!0}={}){const{tileSize:b,buffer:S}=f,{x:A,y:E,z:D}=d;if(!isFinite(A)||!isFinite(E)||!isFinite(D))throw new Error("Invalid MRT header");const M=2**D,B=M*o.aF(m),z=M*o.aJ(s);return function([V,Q],W,{scaled:J=!0}={}){if(!W)throw new Error("bandView is undefined");const{data:ce,tileSize:_e,buffer:xe,offset:fe,scale:Fe,dimension:De}=W;if(V<-xe||V>_e+xe||Q<-xe||Q>_e+xe)throw new Error(`Point (${V}, ${Q}) out of bounds for tileSize=${_e}, buffer=${xe}`);const Oe=(Q+xe)*(_e+2*xe)+(V+xe);if(new Uint32Array(ce.buffer)[Oe]===4294967295)return null;let Ee=[];Ee=J?[]:new W.data.constructor(De);for(let Se=0;Se<De;Se++)Ee[Se]=Math.round(1e12*(ce[De*Oe+Se]*Fe+fe))/1e12;return Ee}([Math.min(Math.max(-S,Math.floor((B-A)*b)),b-1+S),Math.min(Math.max(-S,Math.floor((z-E)*b)),b-1+S)],f,{scaled:_})}class Os extends Ms{constructor(s,d,f,_){super(s,d,f,_),this.type="raster-array",this.maxzoom=22,this.partial=!0,this._loadTilePending={},this._loadTileLoaded={},this._options=Object.assign({type:"raster-array"},d)}triggerRepaint(s){const d=this.map.painter._terrain,f=this.map.style.getSourceCache(this.id);d&&d.enabled&&f&&d._clearRenderCacheForTile(f.id,s.tileID),this.map.triggerRepaint()}loadTile(s,d){const f=this.map._requestManager.normalizeTileURL(s.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),_=this.map._requestManager.transformRequest(f,o.R.Tile),b={request:_,uid:s.uid,tileID:s.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};s.source=this.id,s.scope=this.scope,s.requestParams=_,s.actor||(s.actor=this.dispatcher.getActor());const S=(A,E,D)=>{if(delete s.request,s.aborted)return s.state="unloaded",d(null);if(A)return A.name==="AbortError"?void 0:(s.state="errored",d(A));if(this.map._refreshExpiredTiles&&E){const M=o.aM(D);s.setExpiryData(M)}if(this.partial&&s.state!=="expired")s.state="empty";else if(!this.partial){if(!E)return d(null);s.state="loaded",s._isHeaderLoaded=!0,s._mrt=E}d(null)};s.request=this.partial?s.fetchHeader(void 0,S.bind(this)):s.actor.send("loadTile",b,S.bind(this),void 0,!0)}abortTile(s){s.request&&(s.request.cancel(),delete s.request),s.actor&&s.actor.send("abortTile",{uid:s.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(s,d){const f=s.texturePerLayer;if(s.flushAllQueues(),f.size){s.destroy(!1);for(const _ of f.values())this.map.painter.saveTileTexture(_)}else s.destroy()}prepareTile(s,d,f,_){s._isHeaderLoaded&&(s.state!=="empty"&&(s.state="reloading"),s.fetchBandForRender(d,f,_,(b,S)=>{if(b)return s.state="errored",this.fire(new o.y(b)),void this.triggerRepaint(s);S&&(s._isHeaderLoaded=!0,s.setTexturePerLayer(f,S,this.map.painter),s.state="loaded",this.triggerRepaint(s))}))}getInitialBand(s){if(!this.rasterLayers)return 0;const d=this.rasterLayers.find(({id:b})=>b===s),f=d&&d.fields,_=f&&f.bands&&f.bands;return _?_[0]:0}getTextureDescriptor(s,d,f){if(!s)return;const _=d.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!_)return;let b=null;d instanceof o.aR?b=d.paint.get("raster-array-band"):d instanceof o.aS&&(b=d.paint.get("raster-particle-array-band"));const S=b||this.getInitialBand(_);if(S==null)return;if(!s.textureDescriptorPerLayer.get(d.id))return void this.prepareTile(s,_,d.id,S);if(s.updateNeeded(d.id,S)&&!f)return;const A=s.textureDescriptorPerLayer.get(d.id);return Object.assign({},A,{texture:s.texturePerLayer.get(d.id)})}getImages(s,d){const f=new Map;for(const _ of s)for(const b of d){const[S,A]=b.split("/"),E=_.getLayer(S);if(!E||!E.hasBand(A)||!E.hasDataForBand(A))continue;const{bytes:D,tileSize:M,buffer:B}=E.getBandView(A),z=M+2*B,V={data:new o.q({width:z,height:z},D),pixelRatio:2,sdf:!1,usvg:!1,version:0};f.set(b,V)}return f}queryRasterArrayValueByBandId(s,d,f){const _=d._mrt;return new Promise(b=>{const S={},A=new Set;for(const[E,D]of Object.entries(_.layers)){if(f.layerName&&E!==f.layerName)continue;const M={};S[E]=M;for(const{bands:B}of D.dataIndex)for(const z of B)f.bands&&!f.bands.includes(z)||(A.add(o.B(E,z)),d.fetchBand(E,null,z,V=>{o.o.frame(()=>{M[z]=V?null:la([s.lng,s.lat],_,D.getBandView(z)),A.delete(o.B(E,z)),A.size===0&&b(S)})},!1))}A.size===0&&b(S)})}_loadTileForQuery(s,d){if(this._loadTileLoaded[s.uid])return void d(null,s._mrt);if(this._loadTilePending[s.uid])return void this._loadTilePending[s.uid].push(d);this._loadTilePending[s.uid]=[d];const f=this.map._requestManager.normalizeTileURL(s.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),_=this.map._requestManager.transformRequest(f,o.R.Tile);s.actor.send("loadTile",{request:_,uid:s.uid,tileID:s.tileID,type:this.type,source:this.id,scope:this.scope,partial:!1},(b,S,A)=>{if(b)return this._loadTilePending[s.uid].forEach(E=>E(b,null)),void delete this._loadTilePending[s.uid];if(!S)return this._loadTilePending[s.uid].forEach(E=>E(null,null)),void delete this._loadTilePending[s.uid];if(this.map._refreshExpiredTiles&&S){const E=o.aM(A);s.setExpiryData(E)}s._mrt=S,s._isHeaderLoaded=!0,s.state="loaded",this._loadTilePending[s.uid].forEach(E=>E(null,S)),this._loadTileLoaded[s.uid]=!0,delete this._loadTilePending[s.uid]},void 0,!0)}queryRasterArrayValueByAllBands(s,d,f){return new Promise((_,b)=>{this._loadTileForQuery(d,(S,A)=>{S?b(S):_(A?this.queryRasterArrayValueByBandId(s,d,f):null)})})}queryRasterArrayValue(s,d){const f=o.aT.convert(s),_=this.findLoadedParent(f);return _&&_._mrt?d.bands||!this.partial?this.queryRasterArrayValueByBandId(f,_,d):this.queryRasterArrayValueByAllBands(f,_,d):Promise.resolve(null)}findLoadedParent(s){const d=o.ae.fromLngLat(s,this.map.transform.tileSize),f=this.maxzoom+1,_=1<<f,b=Math.floor(d.x),S=Math.floor((d.x-b)*_),A=Math.floor(d.y*_),E=this.map.style.getSourceCache(this.id),D=new o.aQ(f,b,f,S,A);return E.findLoadedParent(D,this.minzoom)}}const cl={vector:Xs,raster:Ms,"raster-dem":class extends Ms{constructor(m,s,d,f){super(m,s,d,f),this.type="raster-dem",this.maxzoom=22,this._options=Object.assign({type:"raster-dem"},s),this.encoding=s.encoding||"mapbox"}loadTile(m,s){const d=this.map._requestManager.normalizeTileURL(m.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function f(_,b){_&&(m.state="errored",s(_)),b&&(m.dem=b,m.dem.onDeserialize(),m.needsHillshadePrepare=!0,m.needsDEMTextureUpload=!0,m.state="loaded",s(null))}m.request=o.n(this.map._requestManager.transformRequest(d,o.R.Tile),(function(_,b,S){if(delete m.request,m.aborted)m.state="unloaded",s(null);else if(_)m.state="errored",s(_);else if(b){const A=o.aM(S);this.map._refreshExpiredTiles&&m.setExpiryData(A);const E=ImageBitmap&&b instanceof ImageBitmap&&o.r(),D=1-(b.width-o.aP(b.width))/2;D<1||m.neighboringTiles||(m.neighboringTiles=this._getNeighboringTiles(m.tileID));const M=E?b:o.o.getImageData(b,D),B={uid:m.uid,tileID:m.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:M,encoding:this.encoding,padding:D};m.actor&&m.state!=="expired"||(m.actor=this.dispatcher.getActor(),m.actor.send("loadTile",B,f.bind(this),void 0,!0))}}).bind(this))}_getNeighboringTiles(m){const s=m.canonical,d=Math.pow(2,s.z),f=(s.x-1+d)%d,_=s.x===0?m.wrap-1:m.wrap,b=(s.x+1+d)%d,S=s.x+1===d?m.wrap+1:m.wrap,A={};return A[new o.aQ(m.overscaledZ,_,s.z,f,s.y).key]={backfilled:!1},A[new o.aQ(m.overscaledZ,S,s.z,b,s.y).key]={backfilled:!1},s.y>0&&(A[new o.aQ(m.overscaledZ,_,s.z,f,s.y-1).key]={backfilled:!1},A[new o.aQ(m.overscaledZ,m.wrap,s.z,s.x,s.y-1).key]={backfilled:!1},A[new o.aQ(m.overscaledZ,S,s.z,b,s.y-1).key]={backfilled:!1}),s.y+1<d&&(A[new o.aQ(m.overscaledZ,_,s.z,f,s.y+1).key]={backfilled:!1},A[new o.aQ(m.overscaledZ,m.wrap,s.z,s.x,s.y+1).key]={backfilled:!1},A[new o.aQ(m.overscaledZ,S,s.z,b,s.y+1).key]={backfilled:!1}),A}},"raster-array":Os,geojson:class extends o.E{constructor(m,s,d,f){super(),this.id=m,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=d.getActor(),this.setEventedParent(f),this._data=s.data,this._options=Object.assign({},s),this._collectResourceTiming=s.collectResourceTiming,s.maxzoom!==void 0&&(this.maxzoom=s.maxzoom),s.minzoom!==void 0&&(this.minzoom=s.minzoom),s.type&&(this.type=s.type),s.attribution&&(this.attribution=s.attribution),this.promoteId=s.promoteId;const _=o.al/this.tileSize;this.workerOptions=Object.assign({source:this.id,scope:this.scope,cluster:s.cluster||!1,geojsonVtOptions:{buffer:(s.buffer!==void 0?s.buffer:128)*_,tolerance:(s.tolerance!==void 0?s.tolerance:.375)*_,extent:o.al,maxZoom:this.maxzoom,lineMetrics:s.lineMetrics||!1,generateId:s.generateId||!1},superclusterOptions:{maxZoom:s.clusterMaxZoom!==void 0?s.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,s.clusterMinPoints||2),extent:o.al,radius:(s.clusterRadius!==void 0?s.clusterRadius:50)*_,log:!1,generateId:s.generateId||!1},clusterProperties:s.clusterProperties,filter:s.filter,dynamic:s.dynamic},s.workerOptions)}onAdd(m){this.map=m,this.setData(this._data)}setData(m){return this._data=m,this._updateWorkerData(),this}updateData(m){if(!this._options.dynamic)return this.fire(new o.y(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if(typeof m!="string"&&(m.type==="Feature"&&(m={type:"FeatureCollection",features:[m]}),m.type!=="FeatureCollection"))return this.fire(new o.y(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&typeof m!="string"&&typeof this._data!="string"&&this._data.type==="FeatureCollection"){const s=new Map;for(const d of this._data.features)s.set(d.id,d);for(const d of m.features)s.set(d.id,d);this._data.features=[...s.values()]}else this._data=m;return this._updateWorkerData(!0),this}getClusterExpansionZoom(m,s){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:m,source:this.id,scope:this.scope},s),this}getClusterChildren(m,s){return this.actor.send("geojson.getClusterChildren",{clusterId:m,source:this.id,scope:this.scope},s),this}getClusterLeaves(m,s,d,f){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:m,limit:s,offset:d},f),this}_updateWorkerData(m=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new o.z("dataloading",{dataType:"source"})),this._loaded=!1;const s=Object.assign({append:m},this.workerOptions);s.scope=this.scope;const d=this._data;typeof d=="string"?(s.request=this.map._requestManager.transformRequest(o.o.resolveURL(d),o.R.Source),s.request.collectResourceTiming=this._collectResourceTiming):s.data=JSON.stringify(d),this._pendingLoad=this.actor.send(`${this.type}.loadData`,s,(f,_)=>{if(this._loaded=!0,this._pendingLoad=null,f)this.fire(new o.y(f));else{const b={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&_&&_.resourceTiming&&_.resourceTiming[this.id]&&(b.resourceTiming=_.resourceTiming[this.id]),m&&(this._partialReload=!0),this.fire(new o.z("data",b)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(m),this._coalesce=!1)})}loaded(){return this._loaded}reload(){const m=o.B(this.id,this.scope);this.map.style.clearSource(m),this._updateWorkerData()}loadTile(m,s){const d=m.actor?"reloadTile":"loadTile";m.actor=this.actor;const f=this.map.style?this.map.style.getLut(this.scope):null,_=f?{image:f.image.clone()}:null,b=this._partialReload,S={type:this.type,uid:m.uid,tileID:m.tileID,tileZoom:m.tileZoom,zoom:m.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:_,scope:this.scope,pixelRatio:o.o.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:m.isExtraShadowCaster,scaleFactor:this.map.getScaleFactor(),partial:b,worldview:this.map.getWorldview(),indoor:this.map.getIndoorTileOptions(this.id,this.scope)};m.request=this.actor.send(d,S,(A,E)=>b&&!E?(m.state="loaded",s(null)):(delete m.request,m.destroy(!1),m.aborted?s(null):A?s(A):(m.loadVectorData(E,this.map.painter,d==="reloadTile"),s(null))),void 0,d==="loadTile")}abortTile(m){m.request&&(m.request.cancel(),delete m.request),m.aborted=!0}unloadTile(m,s){this.actor.send("removeTile",{uid:m.uid,type:this.type,source:this.id,scope:this.scope}),m.destroy()}onRemove(m){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return Object.assign({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends o.aU{constructor(m,s,d,f){super(m,s,d,f),this.roundZoom=!0,this.type="video",this.options=s}load(){this._loaded=!1;const m=this.options;this.urls=[];for(const s of m.urls)this.urls.push(this.map._requestManager.transformRequest(s,o.R.Source).url);o.aV(this.urls,(s,d)=>{this._loaded=!0,s?this.fire(new o.y(s)):d&&(this.video=d,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(m){if(this.video){const s=this.video.seekable;m<s.start(0)||m>s.end(0)?this.fire(new o.y(new o.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${s.start(0)} and ${s.end(0)}-second mark.`))):this.video.currentTime=m}}getVideo(){return this.video}onAdd(m){this.map||(this.map=m,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const m=this.map.painter.context,s=m.gl;this.texture?this.video.paused||(this.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE),s.texSubImage2D(s.TEXTURE_2D,0,0,0,s.RGBA,s.UNSIGNED_BYTE,this.video)):(this.texture=new o.T(m,this.video,s.RGBA8),this.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(m)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:o.aU,model:o.aX,"batched-model":class extends o.E{constructor(m,s,d,f){super(),this.type="batched-model",this.id=m,this.tileSize=512,this._options=s,this.tiles=this._options.tiles,this.maxzoom=s.maxzoom||19,this.minzoom=s.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=d,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(f)}onAdd(m){this.map=m,this.load()}reload(){this.cancelTileJSONRequest();const m=o.B(this.id,this.scope);this.load(()=>this.map.style.clearSource(m))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(m){this._loaded=!1,this.fire(new o.z("dataloading",{dataType:"source"}));const s=Array.isArray(this.map._language)?this.map._language.join():this.map._language,d=this.map.getWorldview();this._tileJSONRequest=wl(this._options,this.map._requestManager,s,d,(f,_)=>{this._tileJSONRequest=null,this._loaded=!0,f?(s&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${s}`),d&&d.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${d}`),this.fire(new o.y(f))):_&&(Object.assign(this,_),_.bounds&&(this.tileBounds=new Oa(_.bounds,this.minzoom,this.maxzoom)),Ot(_.tiles,this.map._requestManager._customAccessToken),this.fire(new o.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.z("data",{dataType:"source",sourceDataType:"content"}))),m&&m(f)})}hasTransition(){return!1}hasTile(m){return!this.tileBounds||this.tileBounds.contains(m.canonical)}loaded(){return this._loaded}loadTile(m,s){const d=this.map._requestManager.normalizeTileURL(m.tileID.canonical.url(this.tiles,this.scheme)),f={request:this.map._requestManager.transformRequest(d,o.R.Tile),data:void 0,uid:m.uid,tileID:m.tileID,tileZoom:m.tileZoom,zoom:m.tileID.overscaledZ,tileSize:this.tileSize*m.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:m.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:o.o.devicePixelRatio,promoteId:this.promoteId};if(m.actor&&m.state!=="expired")if(m.state==="loading")m.reloadCallback=s;else{if(m.buckets){const b=Object.values(m.buckets);for(const S of b)S.dirty=!0;return void(m.state="loaded")}m.request=m.actor.send("reloadTile",f,_.bind(this))}else m.actor=this.dispatcher.getActor(),m.request=m.actor.send("loadTile",f,_.bind(this),void 0,!0);function _(b,S){return m.aborted?s(null):b&&b.status!==404?s(b):(this.map._refreshExpiredTiles&&S&&m.setExpiryData(S),m.loadModelData(S,this.map.painter),m.state="loaded",void s(null))}}serialize(){return Object.assign({},this._options)}},canvas:class extends o.aU{constructor(m,s,d,f){super(m,s,d,f),s.coordinates?Array.isArray(s.coordinates)&&s.coordinates.length===4&&!s.coordinates.some(_=>!Array.isArray(_)||_.length!==2||_.some(b=>typeof b!="number"))||this.fire(new o.y(new o.V(`sources.${m}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new o.y(new o.V(`sources.${m}`,null,'missing required property "coordinates"'))),s.animate&&typeof s.animate!="boolean"&&this.fire(new o.y(new o.V(`sources.${m}`,null,'optional "animate" property must be a boolean value'))),s.canvas?typeof s.canvas=="string"||s.canvas instanceof HTMLCanvasElement||this.fire(new o.y(new o.V(`sources.${m}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new o.y(new o.V(`sources.${m}`,null,'missing required property "canvas"'))),this.options=s,this.animate=s.animate===void 0||s.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new o.y(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(m){this.map=m,this.load(),this.canvas&&this.animate&&this.play()}onRemove(m){this.pause()}prepare(){let m=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,m=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,m=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const s=this.map.painter.context;this.texture?!m&&!this._playing||this.texture instanceof o.aW||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new o.T(s,this.canvas,s.gl.RGBA8,{premultiply:!0}),this._prepareData(s)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const m of[this.canvas.width,this.canvas.height])if(isNaN(m)||m<=0)return!0;return!1}},custom:class extends o.E{constructor(m,s,d,f){super(),this.id=m,this.type="custom",this._dataType="raster",this._dispatcher=d,this._implementation=s,this.setEventedParent(f),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new o.y(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new o.y(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new Oa(this._implementation.bounds,this.minzoom,this.maxzoom)),s.update=this._update.bind(this),s.clearTiles=this._clearTiles.bind(this),s.coveringTiles=this._coveringTiles.bind(this),Object.assign(this,o.aH(s,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return o.aH(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new o.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.z("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(m){this.map=m,this._loaded=!1,this.fire(new o.z("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(m),this.load()}onRemove(m){this._implementation.onRemove&&this._implementation.onRemove(m)}hasTile(m){if(this._implementation.hasTile){const{x:s,y:d,z:f}=m.canonical;return this._implementation.hasTile({x:s,y:d,z:f})}return!this.tileBounds||this.tileBounds.contains(m.canonical)}loadTile(m,s){const{x:d,y:f,z:_}=m.tileID.canonical,b=new AbortController;m.request=Promise.resolve(this._implementation.loadTile({x:d,y:f,z:_},{signal:b.signal})).then((function(S){return delete m.request,m.aborted?(m.state="unloaded",s(null)):S===void 0?(m.state="errored",s(null)):S===null?(this.loadTileData(m,{width:this.tileSize,height:this.tileSize,data:null}),m.state="loaded",s(null)):function(A){return A instanceof ImageData||A instanceof HTMLCanvasElement||A instanceof ImageBitmap||A instanceof HTMLImageElement}(S)?(this.loadTileData(m,S),m.state="loaded",void s(null)):(m.state="errored",s(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}).bind(this)).catch(S=>{S.name!=="AbortError"&&(m.state="errored",s(S))}),m.request.cancel=()=>b.abort()}loadTileData(m,s){m.setTexture(s,this.map.painter)}unloadTile(m,s){if(m.texture&&m.texture instanceof o.T?(m.destroy(!1),m.texture&&m.texture instanceof o.T&&this.map.painter.saveTileTexture(m.texture)):m.destroy(),this._implementation.unloadTile){const{x:d,y:f,z:_}=m.tileID.canonical;this._implementation.unloadTile({x:d,y:f,z:_})}s&&s()}abortTile(m,s){m.request&&m.request.cancel&&(m.request.cancel(),delete m.request),s&&s()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(m=>({x:m.canonical.x,y:m.canonical.y,z:m.canonical.z}))}_clearTiles(){const m=o.B(this.id,this.scope);this.map.style.clearSource(m)}_update(){this.fire(new o.z("data",{dataType:"source",sourceDataType:"content"}))}}},xn=function(m,s,d,f){const _=new cl[s.type](m,s,d,f);if(_.id!==m)throw new Error(`Expected Source id to be ${m} instead of ${_.id}`);return o.aY(["load","abort","unload","serialize","prepare"],_),_};function xa(m,s,d=""){return`${d}:${s.id||""}:${s.layer.id}:${function(f){if("layerId"in f)return`layer:${f.layerId}`;{const{featuresetId:_,importId:b}=f;return`featureset:${_}${b?`:import:${b}`:""}`}}(m.target)}`}function Sl(m,s,d,f=""){if(m.uniqueFeatureID){const _=xa(m,s,f);if(d.has(_))return!0;d.add(_)}return!1}function Tl(m,s,d,f,_=!1,b=void 0){const S=s.sourceCache.transform,A=s.sourceCache.tilesIn(m,s.has3DLayers,_);A.sort(Bp);const E=[];for(const D of A){const M=D.tile.queryRenderedFeatures(s,D,d,f,S,_,b);Object.keys(M).length&&E.push({wrappedTileID:D.tile.tileID.wrapped().key,queryResults:M})}for(const D in s.layers){const M=s.layers[D];if(M.styleLayer){const B=M.styleLayer.queryRenderedFeatures(m,s.sourceCache,f);Object.keys(B).length&&E.push({wrappedTileID:0,queryResults:B})}}return E.length===0?{}:function(D){const M={},B={};for(const z of D){const V=z.queryResults,Q=z.wrappedTileID,W=B[Q]=B[Q]||{};for(const J in V){const ce=V[J],_e=W[J]=W[J]||{},xe=M[J]=M[J]||[];for(const fe of ce)_e[fe.featureIndex]||(_e[fe.featureIndex]=!0,xe.push(fe))}}return M}(E)}function Sf(m,s,d,f,_,b){const S={},A=f.queryRenderedSymbols(m),E=[];for(const D of Object.keys(A).map(Number))E.push(_[D]);E.sort(Bp);for(const D of E){const M=D.featureIndex.lookupSymbolFeatures(A[D.bucketInstanceId],D.bucketIndex,D.sourceLayerIndex,s,d,b);for(const B in M){const z=S[B]=S[B]||[],V=M[B];V.sort((Q,W)=>{const J=D.featureSortOrder;if(J){const ce=J.indexOf(Q.featureIndex);return J.indexOf(W.featureIndex)-ce}return W.featureIndex-Q.featureIndex});for(const Q of V)z.push(Q)}}return S}function zp(m,s){const d=m.getRenderableIds().map(b=>m.getTileByID(b)),f=[],_={};for(let b=0;b<d.length;b++){const S=d[b],A=S.tileID.canonical.key;_[A]||(_[A]=!0,S.querySourceFeatures(f,s))}return f}function Bp(m,s){const d=m.tileID,f=s.tileID;return d.overscaledZ-f.overscaledZ||d.canonical.y-f.canonical.y||d.wrap-f.wrap||d.canonical.x-f.canonical.x}function Vp(m,s){const d={};if(!s)return d;for(const f of m){const _=f.layerIds.map(b=>s.getLayer(b)).filter(Boolean);if(_.length!==0){f.layers=_,f.stateDependentLayerIds&&(f.stateDependentLayers=f.stateDependentLayerIds.map(b=>_.filter(S=>S.id===b)[0]));for(const b of _)d[b.fqid]=f}}return d}const Ps=32,Ya=33,Ka=new Uint16Array(8184);for(let m=0;m<2046;m++){let s=m+2,d=0,f=0,_=0,b=0,S=0,A=0;for(1&s?_=b=S=Ps:d=f=A=Ps;(s>>=1)>1;){const D=d+_>>1,M=f+b>>1;1&s?(_=d,b=f,d=S,f=A):(d=_,f=b,_=S,b=A),S=D,A=M}const E=4*m;Ka[E+0]=d,Ka[E+1]=f,Ka[E+2]=_,Ka[E+3]=b}const js=new Uint16Array(2178),Fo=new Uint8Array(1089),wc=new Uint16Array(1089);function Sc(m){return m===0?-.03125:m===32?.03125:0}const yo={type:2,extent:o.al,loadGeometry:()=>[[new o.P(0,0),new o.P(o.al+1,0),new o.P(o.al+1,o.al+1),new o.P(0,o.al+1),new o.P(0,0)]]};class Hl{constructor(s,d,f,_,b,S){this.tileID=s,this.uid=o.b2(),this.uses=0,this.tileSize=d,this.tileZoom=f,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=b,_&&_.style&&(this._lastUpdatedBrightness=_.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",_&&_.transform&&(this.projection=_.transform.projection),this.worldview=S,this._hasAppearances=null}registerFadeDuration(s){const d=s+this.timeAdded;d<o.o.now()||this.fadeEndTime&&d<this.fadeEndTime||(this.fadeEndTime=d)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=o.aZ(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(s,d,f){if(this.unloadVectorData(),this.state="loaded",s){s.featureIndex&&(this.latestFeatureIndex=s.featureIndex,s.rawTileData?(this.latestRawTileData=s.rawTileData,this.latestFeatureIndex.rawTileData=s.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=s.collisionBoxArray,this.buckets=Vp(s.buckets,d.style),this.hasSymbolBuckets=!1;for(const _ in this.buckets){const b=this.buckets[_];if(b instanceof o.b4){if(this.hasSymbolBuckets=!0,!f)break;b.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const _ in this.buckets){const b=this.buckets[_];if(b instanceof o.b4&&b.hasRTLText){this.hasRTLText=!0,o.b5();break}}this.queryPadding=0;for(const _ in this.buckets){const b=this.buckets[_],S=d.style.getOwnLayer(_);if(!S)continue;const A=S.queryRadius(b);this.queryPadding=Math.max(this.queryPadding,A)}s.imageAtlas&&(this.imageAtlas=s.imageAtlas),s.glyphAtlasImage&&(this.glyphAtlasImage=s.glyphAtlasImage),s.lineAtlas&&(this.lineAtlas=s.lineAtlas),this._lastUpdatedBrightness=s.brightness}else this.collisionBoxArray=new o.b3}unloadVectorData(){if(this.hasData()){for(const s in this.buckets)this.buckets[s].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(s,d,f){s&&(s.resourceTiming&&(this.resourceTiming=s.resourceTiming),this.buckets=Object.assign({},this.buckets,Vp(s.buckets,d.style)),s.featureIndex&&(this.latestFeatureIndex=s.featureIndex))}getBucket(s){return this.buckets[s.fqid]}upload(s,d){for(const b in this.buckets){const S=this.buckets[b];if(S.uploadPending()){let A={},E=[],D={zoom:0,pitch:0,brightness:0,worldview:""};if(d){if(d.style){E=d.style.listImages();const M=S.layers[0],B=M.sourceLayer||"_geojsonTileLayer",z=d.style.getLayerSourceCache(M);z&&(A=z._state.getState(B,void 0))}D={zoom:d.transform.zoom||0,pitch:d.transform.pitch||0,brightness:d.style.getBrightness()||0,worldview:d.worldview||""}}S.upload(s,this.tileID.canonical,A,E,D)}}const f=s.gl,_=this.imageAtlas;_&&!_.uploaded&&(this.imageAtlasTexture=new o.T(s,_.image,f.RGBA8,{useMipmap:!!_.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new o.T(s,this.glyphAtlasImage,f.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new o.T(s,this.lineAtlas.image,f.R8),this.lineAtlas.uploaded=!0)}prepare(s,d,f){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(s,this.imageAtlasTexture,f),!d||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const _=d.style.getBrightness();this._hasAppearances===null&&(this._hasAppearances=this.hasAppearances(d)),(this._lastUpdatedBrightness||_||this._hasAppearances)&&(!this._hasAppearances&&this._lastUpdatedBrightness&&_&&Math.abs(this._lastUpdatedBrightness-_)<.001||(this.updateBuckets(d,this._lastUpdatedBrightness!==_),this._lastUpdatedBrightness=_))}evaluateQueryRenderedFeaturePadding(){let s=0;for(const d in this.buckets){const f=this.buckets[d];f.evaluateQueryRenderedFeaturePadding&&(s=Math.max(s,f.evaluateQueryRenderedFeaturePadding()))}return s}queryRenderedFeatures(s,d,f,_,b,S,A){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};const E=this.evaluateQueryRenderedFeaturePadding(),D=function(M,B){const z=o.bq([],[.5*M.width,.5*-M.height,1]);return o.br(z,z,[1,-1,0]),o.aB(z,z,M.calculateProjMatrix(B.toUnwrapped())),Float32Array.from(z)}(b,this.tileID);return this.latestFeatureIndex.query(s,{tilespaceGeometry:d,pixelPosMatrix:D,transform:_,availableImages:f,tileTransform:this.tileTransform,worldview:this.worldview,queryRadius:E,scope:A})}querySourceFeatures(s,d){const f=this.latestFeatureIndex;if(!f||!f.rawTileData)return;const _=f.loadVTLayers(),b=d?d.sourceLayer:"",S=_._geojsonTileLayer||_[b];if(!S)return;const A=o.b6(d&&d.filter),{z:E,x:D,y:M}=this.tileID.canonical,B={z:E,x:D,y:M};for(let z=0;z<S.length;z++){const V=S.feature(z);if(A.needGeometry){const J=o.b7(V,!0);if(!A.filter(new o.ac(this.tileID.overscaledZ,{worldview:this.worldview}),J,this.tileID.canonical))continue}else if(!A.filter(new o.ac(this.tileID.overscaledZ,{worldview:this.worldview}),V))continue;const Q=f.getId(V,b),W=new o.b8(V,E,D,M,Q);W.tile=B,s.push(W)}}loaded(){return this.state==="loaded"||this.state==="errored"}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(s){const d=this.expirationTime;if(s.cacheControl){const f=o.b9(s.cacheControl);f["max-age"]&&(this.expirationTime=Date.now()+1e3*f["max-age"])}else s.expires&&(this.expirationTime=new Date(s.expires).getTime());if(this.expirationTime){const f=Date.now();let _=!1;if(this.expirationTime>f)_=!1;else if(d)if(this.expirationTime<d)_=!0;else{const b=this.expirationTime-d;b?this.expirationTime=f+Math.max(b,3e4):_=!0}else _=!0;_?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}refreshFeatureState(s){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&s&&this.updateBuckets(s)}hasAppearances(s){for(const d in this.buckets)if(s.style.hasLayer(d)&&this.buckets[d].layers.some(f=>f.appearances&&f.appearances.length>0))return!0;return!1}updateBuckets(s,d){if(!this.latestFeatureIndex||!s.style)return;const f=s.style.listImages(),_=s.style.getBrightness();for(const b in this.buckets){if(!s.style.hasLayer(b))continue;const S=this.buckets[b],A=S.layers[0],E=A.sourceLayer||"_geojsonTileLayer",D=s.style.getLayerSourceCache(A);let M={};D&&(M=D._state.getState(E,void 0));const B=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},z=Object.keys(M).length>0&&!d;S.hasAppearances=S.layers.some(W=>W.appearances&&W.appearances.length>0);const V=z?S.stateDependentLayers:S.layers;if(z&&S.stateDependentLayers.length!==0||d){const W=this.latestFeatureIndex.loadVTLayers();S.update(M,W[E],f,B,V,d,_)}if(z&&S.stateDependentLayers.length!==0||d||S.hasAppearances){const W={zoom:s.transform.zoom,pitch:s.transform.pitch,brightness:s.style.getBrightness()||0,worldview:s.worldview};S.updateAppearances(this.tileID.canonical,M,f,W,s.imageManager)}(S instanceof o.ba||S instanceof o.bb)&&s._terrain&&s._terrain.enabled&&D&&S.uploadPending()&&s._terrain._clearRenderCacheForTile(D.id,this.tileID);const Q=s&&s.style&&s.style.getOwnLayer(b);Q&&(this.queryPadding=Math.max(this.queryPadding,Q.queryRadius(S)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<o.o.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(s){this.symbolFadeHoldUntil=o.o.now()+s}setTexture(s,d){const f=d.context,_=f.gl;this.texture=this.texture||d.getTileTexture(s.width),this.texture&&this.texture instanceof o.T?this.texture.update(s):(this.texture=new o.T(f,s,_.RGBA8,{useMipmap:!0}),this.texture.bind(_.LINEAR,_.CLAMP_TO_EDGE))}setDependencies(s,d){const f={};for(const _ of d)f[_]=!0;this.dependencies[s]=f}hasDependency(s,d){for(const f of s){const _=this.dependencies[f];if(_){for(const b of d)if(_[b])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(s,d){if(!d||d.name==="mercator"||this._tileDebugBuffer)return;const f=o.bc(yo,this.tileID.canonical,this.tileTransform)[0],_=new o.bd,b=new o.be;for(let S=0;S<f.length;S++){const{x:A,y:E}=f[S];_.emplaceBack(A,E),b.emplaceBack(S)}b.emplaceBack(0),this._tileDebugIndexBuffer=s.createIndexBuffer(b),this._tileDebugBuffer=s.createVertexBuffer(_,o.bf.members),this._tileDebugSegments=o.bg.simpleSegment(0,0,_.length,b.length)}_makeTileBoundsBuffers(s,d){if(this._tileBoundsBuffer||!d||d.name==="mercator")return;const f=o.bc(yo,this.tileID.canonical,this.tileTransform)[0];let _,b;if(this.isRaster){const S=function(A,E){const D=o.aZ(A,E),M=Math.pow(2,A.z);for(let J=0;J<Ya;J++)for(let ce=0;ce<Ya;ce++){const _e=o.a_((A.x+(ce+Sc(ce))/Ps)/M),xe=o.a$((A.y+(J+Sc(J))/Ps)/M),fe=E.project(_e,xe),Fe=J*Ya+ce;js[2*Fe+0]=Math.round((fe.x*D.scale-D.x)*o.al),js[2*Fe+1]=Math.round((fe.y*D.scale-D.y)*o.al)}Fo.fill(0),wc.fill(0);for(let J=2045;J>=0;J--){const ce=4*J,_e=Ka[ce+0],xe=Ka[ce+1],fe=Ka[ce+2],Fe=Ka[ce+3],De=_e+fe>>1,Oe=xe+Fe>>1,Ee=De+Oe-xe,Se=Oe+_e-De,qe=xe*Ya+_e,Ye=Fe*Ya+fe,Qe=Oe*Ya+De,at=Math.hypot((js[2*qe+0]+js[2*Ye+0])/2-js[2*Qe+0],(js[2*qe+1]+js[2*Ye+1])/2-js[2*Qe+1])>=16;Fo[Qe]=Fo[Qe]||(at?1:0),J<1022&&(Fo[Qe]=Fo[Qe]||Fo[(xe+Se>>1)*Ya+(_e+Ee>>1)]||Fo[(Fe+Se>>1)*Ya+(fe+Ee>>1)])}const B=new o.b1,z=new o.b0;let V=0;function Q(J,ce){const _e=ce*Ya+J;return wc[_e]===0&&(B.emplaceBack(js[2*_e+0],js[2*_e+1],J*o.al/Ps,ce*o.al/Ps),wc[_e]=++V),wc[_e]-1}function W(J,ce,_e,xe,fe,Fe){const De=J+_e>>1,Oe=ce+xe>>1;if(Math.abs(J-fe)+Math.abs(ce-Fe)>1&&Fo[Oe*Ya+De])W(fe,Fe,J,ce,De,Oe),W(_e,xe,fe,Fe,De,Oe);else{const Ee=Q(J,ce),Se=Q(_e,xe),qe=Q(fe,Fe);z.emplaceBack(Ee,Se,qe)}}return W(0,0,Ps,Ps,Ps,0),W(Ps,Ps,0,0,0,Ps),{vertices:B,indices:z}}(this.tileID.canonical,d);_=S.vertices,b=S.indices}else{_=new o.b1,b=new o.b0;for(const{x:A,y:E}of f)_.emplaceBack(A,E,0,0);const S=o.bh(_.int16.subarray(0,4*_.length),void 0,4);for(let A=0;A<S.length;A+=3)b.emplaceBack(S[A],S[A+1],S[A+2])}this._tileBoundsBuffer=s.createVertexBuffer(_,o.bi.members),this._tileBoundsIndexBuffer=s.createIndexBuffer(b),this._tileBoundsSegments=o.bg.simpleSegment(0,0,_.length,b.length)}_makeGlobeTileDebugBuffers(s,d){const f=d.projection;if(!f||f.name!=="globe"||d.freezeTileCoverage)return;const _=this.tileID.canonical,b=o.bj(_,d),S=o.bk(b),A=o.aj(d.zoom);let E;A>0&&(E=o.bl(new Float64Array(16),d.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(s,_,d,S,E,A),this._makeGlobeTileDebugTextBuffer(s,_,d,S,E,A)}_globePoint(s,d,f,_,b,S,A){let E=o.bm(s,d,f);if(S){const D=1<<f.z,M=o.aF(_.center.lng),B=o.aJ(_.center.lat),z=(f.x+.5)/D-M;let V=0;z>.5?V=-1:z<-.5&&(V=1);let Q=(s/o.al+f.x)/D+V,W=(d/o.al+f.y)/D;Q=(Q-M)*_._pixelsPerMercatorPixel+M,W=(W-B)*_._pixelsPerMercatorPixel+B;const J=[Q*_.worldSize,W*_.worldSize,0];o.af(J,J,S),E=o.bn(E,J,A)}return o.af(E,E,b)}_makeGlobeTileDebugBorderBuffer(s,d,f,_,b,S){const A=new o.bd,E=new o.be,D=new o.bo,M=(z,V,Q,W,J)=>{const ce=(Q-z)/(J-1),_e=(W-V)/(J-1),xe=A.length;for(let fe=0;fe<J;fe++){const Fe=z+fe*ce,De=V+fe*_e;A.emplaceBack(Fe,De);const Oe=this._globePoint(Fe,De,d,f,_,b,S);D.emplaceBack(Oe[0],Oe[1],Oe[2]),E.emplaceBack(xe+fe)}},B=o.al;M(0,0,B,0,16),M(B,0,B,B,16),M(B,B,0,B,16),M(0,B,0,0,16),this._tileDebugIndexBuffer=s.createIndexBuffer(E),this._tileDebugBuffer=s.createVertexBuffer(A,o.bf.members),this._globeTileDebugBorderBuffer=s.createVertexBuffer(D,o.bp.members),this._tileDebugSegments=o.bg.simpleSegment(0,0,A.length,E.length)}_makeGlobeTileDebugTextBuffer(s,d,f,_,b,S){const A=o.al/4,E=new o.bd,D=new o.b0,M=new o.bo,B=25;D.reserve(32),E.reserve(B),M.reserve(B);const z=(V,Q)=>B*V+Q;for(let V=0;V<B;V++){const Q=V*A;for(let W=0;W<B;W++){const J=W*A;E.emplaceBack(J,Q);const ce=this._globePoint(J,Q,d,f,_,b,S);M.emplaceBack(ce[0],ce[1],ce[2])}}for(let V=0;V<4;V++)for(let Q=0;Q<4;Q++){const W=z(V,Q),J=z(V,Q+1),ce=z(V+1,Q),_e=z(V+1,Q+1);D.emplaceBack(W,J,ce),D.emplaceBack(ce,J,_e)}this._tileDebugTextIndexBuffer=s.createIndexBuffer(D),this._tileDebugTextBuffer=s.createVertexBuffer(E,o.bf.members),this._globeTileDebugTextBuffer=s.createVertexBuffer(M,o.bp.members),this._tileDebugTextSegments=o.bg.simpleSegment(0,0,B,32)}destroy(s=!0){for(const d in this.buckets)this.buckets[d].destroy(s);this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),s&&this.texture&&this.texture instanceof o.T&&(this.texture.destroy(),delete this.texture),this.emissiveTexture&&this.emissiveTexture instanceof o.T&&(this.emissiveTexture.destroy(),delete this.emissiveTexture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}o.bs.setPbf(o.bt);class eh extends Hl{constructor(s,d,f,_,b){super(s,d,f,_,b),this._workQueuePerLayer=new Map,this._fetchQueuePerLayer=new Map,this._taskQueue=new Map,this._isHeaderLoaded=!1,this.textureDescriptorPerLayer=new Map,this.texturePerLayer=new Map}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(s){return this._mrt&&this._mrt.getLayer(s)}setTexturePerLayer(s,d,f){const _=f.context,b=_.gl;let S=this.texturePerLayer.get(s)||f.getTileTexture(d.width);S&&S instanceof o.T?S.update(d,{premultiply:!1}):S=new o.T(_,d,b.RGBA8,{premultiply:!1}),this.texturePerLayer.has(s)||this.texturePerLayer.set(s,S)}flushQueues(s){const d=this._workQueuePerLayer.get(s)||[],f=this._fetchQueuePerLayer.get(s)||[];for(;d.length;)d.pop()();for(;f.length;)f.pop()()}flushAllQueues(){for(const s of this._workQueuePerLayer.keys()){const d=this._workQueuePerLayer.get(s)||[];for(;d.length;)d.pop()()}for(const s of this._fetchQueuePerLayer.keys()){const d=this._fetchQueuePerLayer.get(s)||[];for(;d.length;)d.pop()()}}fetchHeader(s=16384,d){const f=this._mrt=new o.bs(30),_=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(s-1)}});return this.entireBuffer=null,this.request=o.bu(_,(b,S,A)=>{if(b)d(b);else try{const E=f.getHeaderLength(S);if(E>s)return void(this.request=this.fetchHeader(E,d));f.parseHeader(S),this._isHeaderLoaded=!0;let D=0;for(const M of Object.values(f.layers))D=Math.max(D,M.dataIndex[M.dataIndex.length-1].lastByte);S.byteLength>=D&&(this.entireBuffer=S),d(null,this.entireBuffer||S,A)}catch(E){d(E)}}),this.request}fetchBandForRender(s,d,f,_){this.fetchBand(s,d,f,b=>{if(b)return void _(b);this.updateTextureDescriptor(s,d,f);const S=this.textureDescriptorPerLayer.get(d);_(null,S?S.img:null)})}fetchBand(s,d,f,_,b=!0){const S=this._mrt;if(!this._isHeaderLoaded||!S)return void _(new Error("Tile header is not ready"));const A=this.actor;if(!A)return void _(new Error("Can't fetch tile band without an actor"));let E;const D=o.B(String(f),o.B(this.tileID.key,s));let M=this._taskQueue.get(D);M?M.add(_):(M=new Set,M.add(_),this._taskQueue.set(D,M));const B=(W,J)=>{E.complete(W,J),W?_(W):(M.forEach(ce=>ce(null,J)),this._taskQueue.delete(D))},z=(W,J)=>{if(W)return _(W);const ce=A.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:J,task:E},B,void 0,!0);if(d!==null){const _e=this._workQueuePerLayer.get(d)||[];_e.push(()=>{ce&&ce.cancel(),E.cancel()}),this._workQueuePerLayer.has(d)||this._workQueuePerLayer.set(d,_e)}};let V;try{V=S.getLayer(s)}catch(W){if(this.state==="reloading")return;throw W}if(!V)return void _(new Error(`Unknown sourceLayer "${s}"`));if(V.hasDataForBand(f))return M.forEach(W=>W(null,null)),void this._taskQueue.delete(D);const Q=V.getDataRange([f]);if(E=S.createDecodingTask(Q),!E||E.tasks.length)if(d!==null&&this.flushQueues(d),this.entireBuffer)z(null,this.entireBuffer.slice(Q.firstByte,Q.lastByte+1));else{const W=Object.assign({},this.requestParams,{headers:{Range:`bytes=${Q.firstByte}-${Q.lastByte}`}}),J=o.bu(W,z);if(d!==null){const ce=this._fetchQueuePerLayer.get(d)||[];ce.push(()=>{J.cancel(),E.cancel()}),this._fetchQueuePerLayer.has(d)||this._fetchQueuePerLayer.set(d,ce)}}}updateNeeded(s,d){return(!this.textureDescriptorPerLayer.get(s)||this.textureDescriptorPerLayer.get(s).band!==d||this.refreshedUponExpiration)&&this.state!=="errored"}updateTextureDescriptor(s,d,f){if(!this._mrt)return;const _=this._mrt.getLayer(s);if(!_||!_.hasBand(f)||!_.hasDataForBand(f))return;const{bytes:b,tileSize:S,buffer:A,offset:E,scale:D}=_.getBandView(f),M=S+2*A,B=new o.q({width:M,height:M},b),z=this.texturePerLayer.get(d);z&&z instanceof o.T&&z.update(B,{premultiply:!1}),this.textureDescriptorPerLayer.set(d,{layer:s,band:f,img:B,buffer:A,offset:E,tileSize:S,format:_.pixelFormat,mix:[D,256*D,65536*D,16777216*D]})}destroy(s=!1){if(super.destroy(s),delete this._mrt,!s)for(const d of this.texturePerLayer.values())d&&d instanceof o.T&&d.destroy();this.texturePerLayer.clear(),this.textureDescriptorPerLayer.clear(),this.fbo&&(this.fbo.destroy(),delete this.fbo),delete this.request,delete this.requestParams,this._isHeaderLoaded=!1}}class Tf{constructor(s,d){this.max=s,this.onRemove=d,this.reset()}reset(){for(const s in this.data)for(const d of this.data[s])d.timeout&&clearTimeout(d.timeout),this.onRemove(d.value);return this.data={},this.order=[],this}add(s,d,f){const _=s.wrapped().key;this.data[_]===void 0&&(this.data[_]=[]);const b={value:d,timeout:void 0};if(f!==void 0&&(b.timeout=setTimeout(()=>{this.remove(s,b)},f)),this.data[_].push(b),this.order.push(_),this.order.length>this.max){const S=this._getAndRemoveByKey(this.order[0]);S&&this.onRemove(S)}return this}has(s){return s.wrapped().key in this.data}getAndRemove(s){return this.has(s)?this._getAndRemoveByKey(s.wrapped().key):null}_getAndRemoveByKey(s){const d=this.data[s].shift();return d.timeout&&clearTimeout(d.timeout),this.data[s].length===0&&delete this.data[s],this.order.splice(this.order.indexOf(s),1),d.value}getByKey(s){const d=this.data[s];return d?d[0].value:null}get(s){return this.has(s)?this.data[s.wrapped().key][0].value:null}remove(s,d){if(!this.has(s))return this;const f=s.wrapped().key,_=d===void 0?0:this.data[f].indexOf(d),b=this.data[f][_];return this.data[f].splice(_,1),b.timeout&&clearTimeout(b.timeout),this.data[f].length===0&&delete this.data[f],this.onRemove(b.value),this.order.splice(this.order.indexOf(f),1),this}setMaxSize(s){for(this.max=s;this.order.length>this.max;){const d=this._getAndRemoveByKey(this.order[0]);d&&this.onRemove(d)}return this}filter(s){const d=[];for(const f in this.data)for(const _ of this.data[f])s(_.value)||d.push(_);for(const f of d)this.remove(f.value.tileID,f)}}class Nl{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(s,d,f){const _=String(d);if(this.stateChanges[s]=this.stateChanges[s]||{},this.stateChanges[s][_]=this.stateChanges[s][_]||{},Object.assign(this.stateChanges[s][_],f),this.deletedStates[s]===null){this.deletedStates[s]={};for(const b in this.state[s])b!==_&&(this.deletedStates[s][b]=null)}else if(this.deletedStates[s]&&this.deletedStates[s][_]===null){this.deletedStates[s][_]={};for(const b in this.state[s][_])f[b]||(this.deletedStates[s][_][b]=null)}else for(const b in f)this.deletedStates[s]&&this.deletedStates[s][_]&&this.deletedStates[s][_][b]===null&&delete this.deletedStates[s][_][b]}removeFeatureState(s,d,f){if(this.deletedStates[s]===null)return;const _=String(d);if(this.deletedStates[s]=this.deletedStates[s]||{},f&&d!==void 0)this.deletedStates[s][_]!==null&&(this.deletedStates[s][_]=this.deletedStates[s][_]||{},this.deletedStates[s][_][f]=null);else if(d!==void 0)if(this.stateChanges[s]&&this.stateChanges[s][_])for(f in this.deletedStates[s][_]={},this.stateChanges[s][_])this.deletedStates[s][_][f]=null;else this.deletedStates[s][_]=null;else this.deletedStates[s]=null}getState(s,d){const f=this.state[s]||{},_=this.stateChanges[s]||{},b=this.deletedStates[s];if(b===null)return{};if(d!==void 0){const A=String(d),E=Object.assign({},f[A],_[A]);if(b){const D=b[d];if(D===null)return{};for(const M in D)delete E[M]}return E}const S=Object.assign({},f,_);if(b)for(const A in b)delete S[A];return S}initializeTileState(s,d){s.refreshFeatureState(d)}coalesceChanges(s,d){const f={};for(const _ in this.stateChanges){this.state[_]=this.state[_]||{};const b={};for(const S in this.stateChanges[_])this.state[_][S]||(this.state[_][S]={}),Object.assign(this.state[_][S],this.stateChanges[_][S]),b[S]=this.state[_][S];f[_]=b}for(const _ in this.deletedStates){this.state[_]=this.state[_]||{};const b={};if(this.deletedStates[_]===null)for(const S in this.state[_])b[S]={},this.state[_][S]={};else for(const S in this.deletedStates[_]){if(this.deletedStates[_][S]===null)this.state[_][S]={};else if(this.state[_][S])for(const A of Object.keys(this.deletedStates[_][S]))delete this.state[_][S][A];b[S]=this.state[_][S]}f[_]=f[_]||{},Object.assign(f[_],b)}if(this.stateChanges={},this.deletedStates={},Object.keys(f).length!==0)for(const _ in s)s[_].refreshFeatureState(d)}}class Ca extends o.E{constructor(s,d,f){super(),this.id=s,this._onlySymbols=f,d.on("data",_=>{_.dataType==="source"&&_.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&_.dataType==="source"&&_.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),d.on("error",()=>{this._sourceErrored=!0}),this._source=d,this._tiles={},this._cache=new Tf(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=d.minTileCacheSize,this._maxTileCacheSize=d.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Nl,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(s){this.map=s,this._minTileCacheSize=this._minTileCacheSize===void 0&&s?s._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&s?s._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const s in this._tiles)if(!this._tiles[s].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const s=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,s&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(s,d){return s.isSymbolTile=this._onlySymbols,s.isExtraShadowCaster=this._shadowCasterTiles[s.tileID.key],this._source.loadTile(s,d)}_unloadTile(s){if(this._source.unloadTile)return this._source.unloadTile(s)}_abortTile(s){if(this._source.abortTile)return this._source.abortTile(s)}serialize(){return this._source.serialize()}prepare(s){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const d in this._tiles){const f=this._tiles[d];f.upload(s,this.map?this.map.painter:void 0),f.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map(s=>s.tileID).sort(id).map(s=>s.key)}getRenderableIds(s,d){const f=[];for(const _ in this._tiles)this._isIdRenderable(+_,s,d)&&f.push(this._tiles[_]);return s?f.sort((_,b)=>{const S=_.tileID,A=b.tileID,E=new o.P(S.canonical.x,S.canonical.y)._rotate(this.transform.angle),D=new o.P(A.canonical.x,A.canonical.y)._rotate(this.transform.angle);return S.overscaledZ-A.overscaledZ||D.y-E.y||D.x-E.x}).map(_=>_.tileID.key):f.map(_=>_.tileID).sort(id).map(_=>_.key)}hasRenderableParent(s){const d=this.findLoadedParent(s,0);return!!d&&this._isIdRenderable(d.tileID.key)}_isIdRenderable(s,d,f){return this._tiles[s]&&this._tiles[s].hasData()&&!this._coveredTiles[s]&&(d||!this._tiles[s].holdingForFade())&&(f||!this._shadowCasterTiles[s])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const s in this._tiles)this._tiles[s].state!=="errored"&&this._reloadTile(+s,"reloading")}}_reloadTile(s,d){const f=this._tiles[s];f&&(f.state!=="loading"&&(f.state=d),this._loadTile(f,this._tileLoaded.bind(this,f,s,d)))}_tileLoaded(s,d,f,_,b){if(_){if(s.state="errored",_.status!==404)this._source.fire(new o.y(_,{tile:s}));else{if(this._source.fire(new o.z("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:s})),!(s.tileID.key in this._loadedParentTiles))return;if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const A=this.map.painter.terrain;this.update(this.transform,A.getScaledDemTileSize(),!0),A.resetTileLookupCache(this.id)}else this.update(this.transform)}return}s.timeAdded=o.o.now(),f==="expired"&&(s.refreshedUponExpiration=!0),this._setTileReloadTimer(d,s),this._source.type==="raster-dem"&&s.dem&&this._backfillDEM(s),this._state.initializeTileState(s,this.map?this.map.painter:null);let S=new Map;b&&b.responseHeaders&&(S=b.responseHeaders),this._source.fire(new o.z("data",{dataType:"source",tile:s,coord:s.tileID,sourceCacheId:this.id,responseHeaders:S}))}_backfillDEM(s){const d=this.getRenderableIds();for(let _=0;_<d.length;_++){const b=d[_];if(s.neighboringTiles&&s.neighboringTiles[b]){const S=this.getTileByID(b);f(s,S),f(S,s)}}function f(_,b){if(!_.dem||_.dem.borderReady)return;_.needsHillshadePrepare=!0,_.needsDEMTextureUpload=!0;let S=b.tileID.canonical.x-_.tileID.canonical.x;const A=b.tileID.canonical.y-_.tileID.canonical.y,E=Math.pow(2,_.tileID.canonical.z),D=b.tileID.key;S===0&&A===0||Math.abs(A)>1||(Math.abs(S)>1&&(Math.abs(S+E)===1?S+=E:Math.abs(S-E)===1&&(S-=E)),b.dem&&_.dem&&(_.dem.backfillBorder(b.dem,S,A),_.neighboringTiles&&_.neighboringTiles[D]&&(_.neighboringTiles[D].backfilled=!0)))}}getTile(s){return this.getTileByID(s.key)}getTileByID(s){return this._tiles[s]}_retainLoadedChildren(s,d,f,_){for(const b in this._tiles){let S=this._tiles[b];if(_[b]||!S.hasData()||S.tileID.overscaledZ<=d||S.tileID.overscaledZ>f)continue;let A=S.tileID;for(;S&&S.tileID.overscaledZ>d+1;){const D=S.tileID.scaledTo(S.tileID.overscaledZ-1);S=this._tiles[D.key],S&&S.hasData()&&(A=D)}let E=A;for(;E.overscaledZ>d;)if(E=E.scaledTo(E.overscaledZ-1),s[E.key]){_[A.key]=A;break}}}findLoadedParent(s,d){if(s.key in this._loadedParentTiles){const f=this._loadedParentTiles[s.key];return f&&f.tileID.overscaledZ>=d?f:null}for(let f=s.overscaledZ-1;f>=d;f--){const _=s.scaledTo(f),b=this._getLoadedTile(_);if(b)return b}}_getLoadedTile(s){const d=this._tiles[s.key];return d&&d.hasData()?d:this._cache.getByKey(this._source.reparseOverscaled?s.wrapped().key:s.canonical.key)}updateCacheSize(s,d){d=d||this._source.tileSize;const f=Math.ceil(s.width/d)+1,_=Math.ceil(s.height/d)+1,b=Math.floor(f*_*5),S=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,b):b,A=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,S):S;this._cache.setMaxSize(A)}handleWrapJump(s){const d=Math.round((s-(this._prevLng===void 0?s:this._prevLng))/360);if(this._prevLng=s,d){const f={};for(const _ in this._tiles){const b=this._tiles[_];b.tileID=b.tileID.unwrapTo(b.tileID.wrap+d),f[b.tileID.key]=b}this._tiles=f;for(const _ in this._timers)clearTimeout(this._timers[_]),delete this._timers[_];for(const _ in this._tiles)this._setTileReloadTimer(+_,this._tiles[_])}}update(s,d,f,_,b){if(this.transform=s,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!f)return;this.updateCacheSize(s,d),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};const S=this._source.type==="batched-model";let A,E=this._source.maxzoom;const D=this.map&&this.map.painter?this.map.painter._terrain:null;if(D&&D.sourceCache===this&&D.attenuationRange()){const z=D.attenuationRange()[0],V=Math.floor(z)-Math.log2(D.getDemUpscale());E>V&&(E=V)}if(this.used||this.usedForTerrain){if(this._source.tileID)A=s.getVisibleUnwrappedCoordinates(this._source.tileID).map(z=>new o.aQ(z.canonical.z,z.wrap,z.canonical.z,z.canonical.x,z.canonical.y));else if(this.tileCoverLift!==0){const z=s.clone();z.tileCoverLift=this.tileCoverLift,A=z.coveringTiles({tileSize:d||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:E,roundZoom:this._source.roundZoom&&!f,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:S}),this._source.minzoom<=1&&s.projection.name==="globe"&&(A.push(new o.aQ(1,0,1,0,0)),A.push(new o.aQ(1,0,1,1,0)),A.push(new o.aQ(1,0,1,0,1)),A.push(new o.aQ(1,0,1,1,1)))}else if(A=s.coveringTiles({tileSize:d||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:E,roundZoom:this._source.roundZoom&&!f,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:S}),this._source.hasTile){const z=this._source.hasTile.bind(this._source);A=A.filter(V=>z(V))}}else A=[];if(A.length>0&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!Wl(this._source.type)){const z=s.coveringZoomLevel({tileSize:d||this._source.tileSize,roundZoom:this._source.roundZoom&&!f}),V=Math.min(z,this._source.maxzoom);if(S){const Q=s.extendTileCover(A,V);for(const W of Q)A.push(W)}else if(b){const Q=s.extendTileCoverToNearPlane(A,this.transform.getFrustum(V),V);for(const W of Q)A.push(W)}else if(this.castsShadows&&_){const Q=s.extendTileCover(A,V,_,16);for(const W of Q)this._shadowCasterTiles[W.key]=!0,A.push(W)}}const M=this._updateRetainedTiles(A);if(Wl(this._source.type)&&A.length!==0){const z={},V={},Q=Object.keys(M);for(const J of Q){const ce=M[J],_e=this._tiles[J];if(!_e||_e.fadeEndTime&&_e.fadeEndTime<=o.o.now())continue;const xe=this.findLoadedParent(ce,Math.max(ce.overscaledZ-Ca.maxOverzooming,this._source.minzoom));xe&&(this._addTile(xe.tileID),z[xe.tileID.key]=xe.tileID),V[J]=ce}const W=A[A.length-1].overscaledZ;for(const J in this._tiles){const ce=this._tiles[J];if(M[J]||!ce.hasData())continue;let _e=ce.tileID;for(;_e.overscaledZ>W;){_e=_e.scaledTo(_e.overscaledZ-1);const xe=this._tiles[_e.key];if(xe&&xe.hasData()&&V[_e.key]){M[J]=ce.tileID;break}}}for(const J in z)M[J]||(this._coveredTiles[J]=!0,M[J]=z[J])}for(const z in M)this._tiles[z].clearFadeHold();const B=o.bv(this._tiles,M);for(const z of B){const V=this._tiles[z];V.hasSymbolBuckets&&!V.holdingForFade()?V.setHoldDuration(this.map._fadeDuration):V.hasSymbolBuckets&&!V.symbolFadeFinished()||this._removeTile(+z)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const s in this._tiles)this._tiles[s].holdingForFade()&&this._removeTile(+s)}_updateRetainedTiles(s){const d={};if(s.length===0)return d;const f={},_=s.reduce((D,M)=>Math.min(D,M.overscaledZ),1/0),b=s[0].overscaledZ,S=Math.max(b-Ca.maxOverzooming,this._source.minzoom),A=Math.max(b+Ca.maxUnderzooming,this._source.minzoom),E={};for(const D of s){const M=this._addTile(D);d[D.key]=D,M.hasData()||_<this._source.maxzoom&&(E[D.key]=D)}this._retainLoadedChildren(E,_,A,d);for(const D of s){let M=this._tiles[D.key];if(M.hasData())continue;if(D.canonical.z>=this._source.maxzoom){const z=D.children(this._source.maxzoom)[0],V=this.getTile(z);if(V&&V.hasData()){d[z.key]=z;continue}}else{const z=D.children(this._source.maxzoom);if(d[z[0].key]&&d[z[1].key]&&d[z[2].key]&&d[z[3].key])continue}let B=M.wasRequested();for(let z=D.overscaledZ-1;z>=S;--z){const V=D.scaledTo(z);if(f[V.key]||(f[V.key]=!0,M=this.getTile(V),!M&&B&&(M=this._addTile(V)),M&&(d[V.key]=V,B=M.wasRequested(),M.hasData())))break}}return d}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const s in this._tiles){const d=[];let f,_=this._tiles[s].tileID;for(;_.overscaledZ>0;){if(_.key in this._loadedParentTiles){f=this._loadedParentTiles[_.key];break}d.push(_.key);const b=_.scaledTo(_.overscaledZ-1);if(f=this._getLoadedTile(b),f)break;_=b}for(const b of d)this._loadedParentTiles[b]=f}}_addTile(s){let d=this._tiles[s.key];if(d)return d.isExtraShadowCaster!==!0||this._shadowCasterTiles[s.key]||this._reloadTile(s.key,"reloading"),d;d=this._cache.getAndRemove(s),d&&(this._setTileReloadTimer(s.key,d),d.tileID=s,this._state.initializeTileState(d,this.map?this.map.painter:null),this._cacheTimers[s.key]&&(clearTimeout(this._cacheTimers[s.key]),delete this._cacheTimers[s.key],this._setTileReloadTimer(s.key,d)));const f=!!d;if(!f){const _=this.map?this.map.painter:null,b=this._source.tileSize*s.overscaleFactor();d=this._source.type==="raster-array"?new eh(s,b,this.transform.tileZoom,_,this._isRaster):new Hl(s,b,this.transform.tileZoom,_,this._isRaster,this._source.worldview),this._loadTile(d,this._tileLoaded.bind(this,d,s.key,d.state))}return d.uses++,this._tiles[s.key]=d,f||this._source.fire(new o.z("dataloading",{tile:d,coord:d.tileID,dataType:"source"})),d}_setTileReloadTimer(s,d){s in this._timers&&(clearTimeout(this._timers[s]),delete this._timers[s]);const f=d.getExpiryTimeout();f&&(this._timers[s]=setTimeout(()=>{this._reloadTile(s,"expired"),delete this._timers[s]},f))}_removeTile(s){const d=this._tiles[s];d&&(d.uses--,delete this._tiles[s],this._timers[s]&&(clearTimeout(this._timers[s]),delete this._timers[s]),d.uses>0||(d.hasData()&&d.state!=="reloading"||d.state==="empty"?this._cache.add(d.tileID,d,d.getExpiryTimeout()):(d.aborted=!0,this._abortTile(d),this._unloadTile(d))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const s in this._tiles)this._removeTile(+s);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(s,d,f){const _=[],b=this.transform;if(!b)return _;const S=b.projection.name==="globe",A=o.aF(b.center.lng);for(const E in this._tiles){const D=this._tiles[E];if(f&&D.clearQueryDebugViz(),D.holdingForFade())continue;let M;if(S){const B=D.tileID.canonical;if(B.z===0){const z=[Math.abs(o.aA(A,...xo(B,-1))-A),Math.abs(o.aA(A,...xo(B,1))-A)];M=[0,2*z.indexOf(Math.min(...z))-1]}else{const z=[Math.abs(o.aA(A,...xo(B,-1))-A),Math.abs(o.aA(A,...xo(B,0))-A),Math.abs(o.aA(A,...xo(B,1))-A)];M=[z.indexOf(Math.min(...z))-1]}}else M=[0];for(const B of M){const z=s.containsTile(D,b,d,B);z&&_.push(z)}}return _}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(s){return this._getRenderableCoordinates(s)}_getRenderableCoordinates(s,d){const f=this.getRenderableIds(s,d).map(b=>this._tiles[b].tileID),_=this.transform.projection.name==="globe";for(const b of f)b.projMatrix=this.transform.calculateProjMatrix(b.toUnwrapped()),b.expandedProjMatrix=_?this.transform.calculateProjMatrix(b.toUnwrapped(),!1,!0):b.projMatrix;return f}sortCoordinatesByDistance(s){const d=s.slice(),f=this.transform._camera.position,_=this.transform._camera.forward(),b={};for(const S of d){const A=1/(1<<S.canonical.z);b[S.key]=((S.canonical.x+.5)*A+S.wrap-f[0])*_[0]+((S.canonical.y+.5)*A-f[1])*_[1]-f[2]*_[2]}return d.sort((S,A)=>b[S.key]-b[A.key]),d}hasTransition(){if(this._source.hasTransition())return!0;if(Wl(this._source.type))for(const s in this._tiles){const d=this._tiles[s];if(d.fadeEndTime!==void 0&&d.fadeEndTime>=o.o.now())return!0}return!1}setFeatureState(s,d,f){this._state.updateState(s=s||"_geojsonTileLayer",d,f)}removeFeatureState(s,d,f){this._state.removeFeatureState(s=s||"_geojsonTileLayer",d,f)}getFeatureState(s,d){return this._state.getState(s=s||"_geojsonTileLayer",d)}setDependencies(s,d,f){const _=this._tiles[s];_&&_.setDependencies(d,f)}reloadTilesForDependencies(s,d){for(const f in this._tiles)this._tiles[f].hasDependency(s,d)&&this._reloadTile(+f,"reloading");this._cache.filter(f=>!f.hasDependency(s,d))}_preloadTiles(s,d){if(!this._sourceLoaded){const E=()=>{this._sourceLoaded&&(this._source.off("data",E),this._preloadTiles(s,d))};return void this._source.on("data",E)}const f=new Map,_=Array.isArray(s)?s:[s],b=this.map.painter.terrain,S=this.usedForTerrain&&b?b.getScaledDemTileSize():this._source.tileSize;for(const E of _){const D=E.coveringTiles({tileSize:S,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const M of D)f.set(M.key,M);this.usedForTerrain&&E.updateElevation(!1)}const A=Array.from(f.values());o.bw(A,(E,D)=>{const M=new Hl(E,this._source.tileSize*E.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster,this._source.worldview);this._loadTile(M,B=>{this._source.type==="raster-dem"&&M.dem&&this._backfillDEM(M),D(B,M)})},d)}}function id(m,s){const d=Math.abs(2*m.wrap)-+(m.wrap<0),f=Math.abs(2*s.wrap)-+(s.wrap<0);return m.overscaledZ-s.overscaledZ||f-d||s.canonical.y-m.canonical.y||s.canonical.x-m.canonical.x}function Wl(m){return m==="raster"||m==="image"||m==="video"||m==="custom"}function xo(m,s){const d=1<<m.z;return[m.x/d+s,(m.x+1)/d+s]}Ca.maxOverzooming=10,Ca.maxUnderzooming=3;class su{constructor(s){this.style=s,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const s=!1,d=!1;for(const f in this.style._mergedLayers){const _=this.style._mergedLayers[f];if(_.type==="fill-extrusion"||_.type==="building")this.layers.push({layer:_,visible:s,visibilityChanged:d});else if(_.type==="model"){const b=this.style.getLayerSource(_);b&&b.type==="batched-model"&&this.layers.push({layer:_,visible:s,visibilityChanged:d})}}}onNewFrame(s){this.layersGotHidden=!1;for(const d of this.layers){const f=d.layer;let _=!1;f.type==="fill-extrusion"?_=!f.isHidden(s)&&f.paint.get("fill-extrusion-opacity")>0:f.type==="building"?_=!f.isHidden(s)&&f.paint.get("building-opacity")>0:f.type==="model"&&(_=!f.isHidden(s)&&f.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!_&&d.visible,d.visible=_}}updateZOffset(s,d){this.currentBuildingBuckets=[];for(const _ of this.layers){const b=_.layer,S=this.style.getLayerSourceCache(b);let A=1;b.type==="fill-extrusion"?A=_.visible?b.paint.get("fill-extrusion-vertical-scale"):0:b.type==="building"&&(A=_.visible?b.paint.get("building-vertical-scale"):0);let E=S?S.getTile(d):null;if(!E&&S)for(const D in S._tiles){const M=S._tiles[D];if(d.canonical.isChildOf(M.tileID.canonical)){E=M;break}}this.currentBuildingBuckets.push({bucket:E?E.getBucket(b):null,tileID:E?E.tileID:d,verticalScale:A})}s.hasAnyZOffset=!1;let f=!1;for(let _=0;_<s.symbolInstances.length;_++){const b=s.symbolInstances.get(_),S=b.zOffset,A=this._getHeightAtTileOffset(d,b.tileAnchorX,b.tileAnchorY);b.zOffset=A!==Number.NEGATIVE_INFINITY?A:S,f||S===b.zOffset||(f=!0),s.hasAnyZOffset||b.zOffset===0||(s.hasAnyZOffset=!0)}f&&(s.zOffsetBuffersNeedUpload=!0,s.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(s,d,f,_){let b=d,S=f;if(s.canonical.z!==_.canonical.z){const A=_.canonical,E=1/(1<<s.canonical.z-A.z);b=(d+s.canonical.x*o.al)*E-A.x*o.al|0,S=(f+s.canonical.y*o.al)*E-A.y*o.al|0}return{tileX:b,tileY:S}}_getHeightAtTileOffset(s,d,f){let _,b;for(let S=0;S<this.layers.length;++S){const A=this.layers[S].layer;if(A.type!=="fill-extrusion"&&A.type!=="building")continue;const{bucket:E,tileID:D,verticalScale:M}=this.currentBuildingBuckets[S];if(!E)continue;const{tileX:B,tileY:z}=this._mapCoordToOverlappingTile(s,d,f,D),V=E.getHeightAtTileCoord(B,z);V&&V.height!==void 0&&(V.hidden?_=V.height:b=Math.max(V.height*M,b||0))}if(b!==void 0)return b;for(let S=0;S<this.layers.length;++S){const A=this.layers[S];if(A.layer.type!=="model"||!A.visible)continue;const{bucket:E,tileID:D}=this.currentBuildingBuckets[S];if(!E)continue;const{tileX:M,tileY:B}=this._mapCoordToOverlappingTile(s,d,f,D),z=E.getHeightAtTileCoord(M,B);if(z&&!z.hidden)return z.height===void 0&&_!==void 0?Math.min(z.maxHeight,_)*z.verticalScale:z.height?z.height*z.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function rd(m,s){const d={};for(const f in m)f!=="ref"&&(d[f]=m[f]);return o.bx.forEach(f=>{f in s&&(d[f]=s[f])}),d}function Tc(m){m=m.slice();const s=Object.create(null);for(let d=0;d<m.length;d++)s[m[d].id]=m[d];for(let d=0;d<m.length;d++)"ref"in m[d]&&(m[d]=rd(m[d],s[m[d].ref]));return m}const hr={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport",addIconset:"addIconset",removeIconset:"removeIconset"};function Zl(m,s,d){d.push({command:hr.addSource,args:[m,s[m]]})}function Yn(m,s,d){s.push({command:hr.removeSource,args:[m]}),d[m]=!0}function Nf(m,s,d,f){Yn(m,d,f),Zl(m,s,d)}function Af(m,s,d){let f;for(f in m[d])if(m[d].hasOwnProperty(f)&&f!=="data"&&!o.by(m[d][f],s[d][f]))return!1;for(f in s[d])if(s[d].hasOwnProperty(f)&&f!=="data"&&!o.by(m[d][f],s[d][f]))return!1;return!0}function au(m,s,d,f,_,b){let S;for(S in s=s||{},m=m||{})m.hasOwnProperty(S)&&(o.by(m[S],s[S])||d.push({command:b,args:[f,S,s[S],_]}));for(S in s)s.hasOwnProperty(S)&&!m.hasOwnProperty(S)&&(o.by(m[S],s[S])||d.push({command:b,args:[f,S,s[S],_]}))}function Al(m){return m.id}function ou(m,s){return m[s.id]=s,m}function Nc(m,s,d){const f=s.createTileMatrix(m,m.worldSize,d.toUnwrapped());return o.aB(new Float32Array(16),m.projMatrix,f)}function Cf(m,s,d){if(s.projection.name===d.projection.name)return m.projMatrix;const f=d.clone();return f.setProjection(s.projection),Nc(f,s.getProjection(),m)}function La(m,s,d){return s.name===d.projection.name?m.projMatrix:Nc(d,s,m)}class ul{constructor(s,d){this.reset(s,d)}reset(s,d){this.points=s||[],this._distances=[0];for(let f=1;f<this.points.length;f++)this._distances[f]=this._distances[f-1]+this.points[f].dist(this.points[f-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(d||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(s){if(this.points.length===1)return this.points[0];s=o.aA(s,0,1);let d=1,f=this._distances[d];const _=s*this.paddedLength+this.padding;for(;f<_&&d<this._distances.length;)f=this._distances[++d];const b=d-1,S=this._distances[b],A=f-S,E=A>0?(_-S)/A:0;return this.points[b].mult(1-E).add(this.points[d].mult(E))}}class nd{constructor(s,d,f){const _=this.boxCells=[],b=this.circleCells=[];this.xCellCount=Math.ceil(s/f),this.yCellCount=Math.ceil(d/f);for(let S=0;S<this.xCellCount*this.yCellCount;S++)_.push([]),b.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=s,this.height=d,this.xScale=this.xCellCount/s,this.yScale=this.yCellCount/d,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(s,d,f,_,b){this._forEachCell(d,f,_,b,this._insertBoxCell,this.boxUid++),this.boxKeys.push(s),this.bboxes.push(d),this.bboxes.push(f),this.bboxes.push(_),this.bboxes.push(b)}insertCircle(s,d,f,_){this._forEachCell(d-_,f-_,d+_,f+_,this._insertCircleCell,this.circleUid++),this.circleKeys.push(s),this.circles.push(d),this.circles.push(f),this.circles.push(_)}_insertBoxCell(s,d,f,_,b,S){this.boxCells[b].push(S)}_insertCircleCell(s,d,f,_,b,S){this.circleCells[b].push(S)}_query(s,d,f,_,b,S){if(f<0||s>this.width||_<0||d>this.height)return!b&&[];const A=[];if(s<=0&&d<=0&&this.width<=f&&this.height<=_){if(b)return!0;for(let E=0;E<this.boxKeys.length;E++)A.push({key:this.boxKeys[E],x1:this.bboxes[4*E],y1:this.bboxes[4*E+1],x2:this.bboxes[4*E+2],y2:this.bboxes[4*E+3]});for(let E=0;E<this.circleKeys.length;E++){const D=this.circles[3*E],M=this.circles[3*E+1],B=this.circles[3*E+2];A.push({key:this.circleKeys[E],x1:D-B,y1:M-B,x2:D+B,y2:M+B})}return S?A.filter(S):A}return this._forEachCell(s,d,f,_,this._queryCell,A,{hitTest:b,seenUids:{box:{},circle:{}}},S),b?A.length>0:A}_queryCircle(s,d,f,_,b){const S=s-f,A=s+f,E=d-f,D=d+f;if(A<0||S>this.width||D<0||E>this.height)return!_&&[];const M=[];return this._forEachCell(S,E,A,D,this._queryCellCircle,M,{hitTest:_,circle:{x:s,y:d,radius:f},seenUids:{box:{},circle:{}}},b),_?M.length>0:M}query(s,d,f,_,b){return this._query(s,d,f,_,!1,b)}hitTest(s,d,f,_,b){return this._query(s,d,f,_,!0,b)}hitTestCircle(s,d,f,_){return this._queryCircle(s,d,f,!0,_)}_queryCell(s,d,f,_,b,S,A,E){const D=A.seenUids,M=this.boxCells[b];if(M!==null){const z=this.bboxes;for(const V of M)if(!D.box[V]){D.box[V]=!0;const Q=4*V;if(s<=z[Q+2]&&d<=z[Q+3]&&f>=z[Q+0]&&_>=z[Q+1]&&(!E||E(this.boxKeys[V]))){if(A.hitTest)return S.push(!0),!0;S.push({key:this.boxKeys[V],x1:z[Q],y1:z[Q+1],x2:z[Q+2],y2:z[Q+3]})}}}const B=this.circleCells[b];if(B!==null){const z=this.circles;for(const V of B)if(!D.circle[V]){D.circle[V]=!0;const Q=3*V;if(this._circleAndRectCollide(z[Q],z[Q+1],z[Q+2],s,d,f,_)&&(!E||E(this.circleKeys[V]))){if(A.hitTest)return S.push(!0),!0;{const W=z[Q],J=z[Q+1],ce=z[Q+2];S.push({key:this.circleKeys[V],x1:W-ce,y1:J-ce,x2:W+ce,y2:J+ce})}}}}}_queryCellCircle(s,d,f,_,b,S,A,E){const D=A.circle,M=A.seenUids,B=this.boxCells[b];if(B!==null){const V=this.bboxes;for(const Q of B)if(!M.box[Q]){M.box[Q]=!0;const W=4*Q;if(this._circleAndRectCollide(D.x,D.y,D.radius,V[W+0],V[W+1],V[W+2],V[W+3])&&(!E||E(this.boxKeys[Q])))return S.push(!0),!0}}const z=this.circleCells[b];if(z!==null){const V=this.circles;for(const Q of z)if(!M.circle[Q]){M.circle[Q]=!0;const W=3*Q;if(this._circlesCollide(V[W],V[W+1],V[W+2],D.x,D.y,D.radius)&&(!E||E(this.circleKeys[Q])))return S.push(!0),!0}}}_forEachCell(s,d,f,_,b,S,A,E){const D=this._convertToXCellCoord(s),M=this._convertToYCellCoord(d),B=this._convertToXCellCoord(f),z=this._convertToYCellCoord(_);for(let V=D;V<=B;V++)for(let Q=M;Q<=z;Q++)if(b.call(this,s,d,f,_,this.xCellCount*Q+V,S,A,E))return}_convertToXCellCoord(s){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(s*this.xScale)))}_convertToYCellCoord(s){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(s*this.yScale)))}_circlesCollide(s,d,f,_,b,S){const A=_-s,E=b-d,D=f+S;return D*D>A*A+E*E}_circleAndRectCollide(s,d,f,_,b,S,A){const E=(S-_)/2,D=Math.abs(s-(_+E));if(D>E+f)return!1;const M=(A-b)/2,B=Math.abs(d-(b+M));if(B>M+f)return!1;if(D<=E||B<=M)return!0;const z=D-E,V=B-M;return z*z+V*V<=f*f}}const lu=Math.tan(85*Math.PI/180);function Xl(m,s,d,f,_,b,S){const A=o.bC();if(d)if(b.name==="globe"){const E=o.bD(_,s);o.aB(A,A,E)}else{const E=o.bE([],S);A[0]=E[0],A[1]=E[1],A[4]=E[2],A[5]=E[3],f||o.bB(A,A,_.angle)}else o.aB(A,_.labelPlaneMatrix,m);return A}function zo(m,s,d,f,_,b,S){const A=Xl(m,s,d,f,_,b,S);return b.name==="globe"&&d||(A[2]=A[6]=A[10]=A[14]=0),A}function Ys(m,s,d,f,_,b,S){if(d){if(b.name==="globe"){const A=Xl(m,s,d,f,_,b,S);return o.bl(A,A),o.aB(A,m,A),A}{const A=o.bz(m),E=o.bA([]);return E[0]=S[0],E[1]=S[1],E[4]=S[2],E[5]=S[3],o.aB(A,A,E),f||o.bB(A,A,-_.angle),A}}return _.glCoordMatrix}function Qa(m,s,d,f){const _=[m,s,d,1];d?o.aC(_,_,f):ad(_,_,f);const b=_[3];return _[0]/=b,_[1]/=b,_[2]/=b,_}function Ac(m,s){return Math.min(.5+m/s*.5,1.5)}function Ef(m,s){const d=m[0]/m[3],f=m[1]/m[3];return d>=-s[0]&&d<=s[0]&&f>=-s[1]&&f<=s[1]}function Ar(m,s,d,f,_,b,S,A,E,D,M=1){const B=d.transform,z=f?m.textSizeData:m.iconSizeData,V=o.bK(z,d.transform.zoom,M),Q=B.projection.name==="globe",W=[256/d.width*2+1,256/d.height*2+1],J=f?m.text.dynamicLayoutVertexArray:m.icon.dynamicLayoutVertexArray;J.clear();let ce=null;Q&&(ce=f?m.text.globeExtVertexArray:m.icon.globeExtVertexArray);const _e=m.lineVertexArray,xe=f?m.text.placedSymbolArray:m.icon.placedSymbolArray,fe=d.transform.width/d.transform.height;let Fe,De=!1;for(let Oe=0;Oe<xe.length;Oe++){const Ee=xe.get(Oe),{numGlyphs:Se,writingMode:qe}=Ee;if(qe!==o.bL.vertical||De||Fe===o.bL.horizontal||(De=!0),Fe=qe,(Ee.hidden||qe===o.bL.vertical)&&!De){Ls(Se,J);continue}De=!1;const Ye=new o.P(Ee.tileAnchorX,Ee.tileAnchorY),Qe=m.elevationType==="road",at=!!B.elevation||Qe;let{x:nt,y:ft,z:Nt}=B.projection.projectTilePoint(Ye.x,Ye.y,D.canonical),rt=null;if(at){const Kt=Qe?m.getElevationFeatureForText(Oe):null;rt={getElevation:E,elevation:B.elevation,elevationFeature:Kt};const[gi,Ci,Hi]=E(Ye,B.elevation,Kt);nt+=gi,ft+=Ci,Nt+=Hi}const $e=[nt,ft,Nt,1];if(o.aC($e,$e,s),!Ef($e,W)){Ls(Se,J);continue}const dt=$e[3],ot=Ac(d.transform.getCameraToCenterDistance(B.projection),dt),Ct=o.bM(z,V,Ee),Rt=S?Ct/ot:Ct*ot,Ut=Qa(nt,ft,Nt,_);if(Ut[3]<=0){Ls(Se,J);continue}let kt={};const Mt=o.an(m.layers[0].layout.get("text-max-angle")),ei=Math.cos(Mt),Qt=S?null:rt,Wt=qp(Ee,Rt,!1,A,s,_,b,m.glyphOffsetArray,_e,J,ce,Ut,Ye,kt,fe,Qt,B.projection,D,S,ei);De=Wt.useVertical,Qt&&Wt.needsFlipping&&(kt={}),(Wt.notEnoughRoom||De||Wt.needsFlipping&&qp(Ee,Rt,!0,A,s,_,b,m.glyphOffsetArray,_e,J,ce,Ut,Ye,kt,fe,Qt,B.projection,D,S,ei).notEnoughRoom)&&Ls(Se,J)}f?(m.text.dynamicLayoutVertexBuffer.updateData(J),ce&&m.text.globeExtVertexBuffer&&m.text.globeExtVertexBuffer.updateData(ce)):(m.icon.dynamicLayoutVertexBuffer.updateData(J),ce&&m.icon.globeExtVertexBuffer&&m.icon.globeExtVertexBuffer.updateData(ce))}function Cc(m,s,d,f,_,b,S,A,E,D,M,B,z,V,Q,W,J){const{lineStartIndex:ce,glyphStartIndex:_e,segment:xe}=A,fe=_e+A.numGlyphs,Fe=ce+A.lineLength,De=s.getoffsetX(_e),Oe=s.getoffsetX(fe-1),Ee=Yl(m*De,d,f,_,b,S,xe,ce,Fe,E,D,M,B,z,!0,V,Q,W,J);if(!Ee)return null;const Se=Yl(m*Oe,d,f,_,b,S,xe,ce,Fe,E,D,M,B,z,!0,V,Q,W,J);return Se?{first:Ee,last:Se}:null}function Up(m,s,d,f){return m===o.bL.horizontal&&Math.abs(f)>Math.abs(d)?{useVertical:!0}:m===o.bL.vertical?f>0?{needsFlipping:!0}:null:s!==0&&function(_,b){return _===0||Math.abs(b/_)>lu}(d,f)?s===1?{needsFlipping:!0}:null:d<0?{needsFlipping:!0}:null}function qp(m,s,d,f,_,b,S,A,E,D,M,B,z,V,Q,W,J,ce,_e,xe){const fe=s/24,Fe=m.lineOffsetX*fe,De=m.lineOffsetY*fe,{lineStartIndex:Oe,glyphStartIndex:Ee,numGlyphs:Se,segment:qe,writingMode:Ye,flipState:Qe}=m,at=Oe+m.lineLength,nt=ft=>{if(M){const[dt,ot,Ct]=ft.up,Rt=D.length;o.bN(M,Rt+0,dt,ot,Ct),o.bN(M,Rt+1,dt,ot,Ct),o.bN(M,Rt+2,dt,ot,Ct),o.bN(M,Rt+3,dt,ot,Ct)}const[Nt,rt,$e]=ft.point;o.bO(D,Nt,rt,$e,ft.angle)};if(Se>1){const ft=Cc(fe,A,Fe,De,d,B,z,m,E,b,V,W,!1,J,ce,_e,xe);if(!ft)return{notEnoughRoom:!0};if(f&&!d){let[Nt,rt,$e]=ft.first.point,[dt,ot,Ct]=ft.last.point;[Nt,rt]=Qa(Nt,rt,$e,S),[dt,ot]=Qa(dt,ot,Ct,S);const Rt=Up(Ye,Qe,(dt-Nt)*Q,ot-rt);if(m.flipState=Rt&&Rt.needsFlipping?1:2,Rt)return Rt}nt(ft.first);for(let Nt=Ee+1;Nt<Ee+Se-1;Nt++){const rt=Yl(fe*A.getoffsetX(Nt),Fe,De,d,B,z,qe,Oe,at,E,b,V,W,!1,!1,J,ce,_e,xe);if(!rt)return D.length-=4*(Nt-Ee),{notEnoughRoom:!0};nt(rt)}nt(ft.last)}else{if(f&&!d){const Nt=Qa(z.x,z.y,0,_),rt=Oe+qe+1,$e=new o.P(E.getx(rt),E.gety(rt)),dt=Qa($e.x,$e.y,0,_),ot=dt[3]>0?dt:sd(z,$e,Nt,1,_,void 0,J,ce.canonical),Ct=Up(Ye,Qe,(ot[0]-Nt[0])*Q,ot[1]-Nt[1]);if(m.flipState=Ct&&Ct.needsFlipping?1:2,Ct)return Ct}const ft=Yl(fe*A.getoffsetX(Ee),Fe,De,d,B,z,qe,Oe,at,E,b,V,W,!1,!1,J,ce,_e,xe);if(!ft)return{notEnoughRoom:!0};nt(ft)}return{}}function Si(m,s,d,f,_){const{x:b,y:S,z:A}=f.projectTilePoint(m.x,m.y,s);if(!_)return Qa(b,S,A,d);const[E,D,M]=_.getElevation(m,_.elevation,_.elevationFeature);return Qa(b+E,S+D,A+M,d)}function sd(m,s,d,f,_,b,S,A){const E=Si(m.sub(s)._unit()._add(m),A,_,S,b);return o.av(E,d,E),o.aw(E,E),o.bH(E,d,E,f)}function Yl(m,s,d,f,_,b,S,A,E,D,M,B,z,V,Q,W,J,ce,_e){const xe=f?m-s:m+s;let fe=xe>0?1:-1,Fe=0;f&&(fe*=-1,Fe=Math.PI),fe<0&&(Fe+=Math.PI);let De=A+S+(fe>0?0:1)|0,Oe=_,Ee=_,Se=0,qe=0;const Ye=Math.abs(xe),Qe=[],at=[];let nt=b,ft=nt,Nt=o.bF([]);const rt=()=>sd(ft,nt,Ee,Ye-Se+1,M,z,W,J.canonical);for(;Se+qe<=Ye;){if(De+=fe,De<A||De>=E)return null;if(Ee=Oe,ft=nt,Qe.push(Ee),V&&at.push(ft),nt=new o.P(D.getx(De),D.gety(De)),Oe=B[De],!Oe){const Qt=Si(nt,J.canonical,M,W,z);Oe=Qt[3]>0?B[De]=Qt:rt()}Se+=qe;const Mt=o.av([],Oe,Ee),ei=o.bG(Ee,Oe);if(d&&ei>0&&qe>0&&o.bJ(Nt,Mt)/(qe*ei)<_e)return null;qe=ei,Nt=Mt}Q&&z&&(B[De]&&(Oe=rt(),qe=o.bG(Ee,Oe),Nt=o.av([],Oe,Ee)),B[De]=Oe);const $e=(Ye-Se)/qe,dt=nt.sub(ft)._mult($e)._add(ft),ot=o.bH([],Ee,Nt,$e);let Ct=[0,0,1],Rt=Nt[0],Ut=Nt[1];if(ce&&(Ct=W.upVector(J.canonical,dt.x,dt.y),Ct[0]!==0||Ct[1]!==0||Ct[2]!==1)){const Mt=[Ct[2],0,-Ct[0]],ei=o.bI([],Ct,Mt);o.aw(Mt,Mt),o.aw(ei,ei),Rt=o.bJ(Nt,Mt),Ut=o.bJ(Nt,ei)}if(d){const Mt=o.bI([],Ct,Nt);o.aw(Mt,Mt),o.bH(ot,ot,Mt,d*fe)}const kt=Fe+Math.atan2(Ut,Rt);return Qe.push(ot),V&&at.push(dt),{point:ot,angle:kt,path:Qe,tilePath:at,up:Ct}}function Ls(m,s){const d=s.length,f=d+4*m;s.resize(f),s.float32.fill(-1/0,4*d,4*f)}function ad(m,s,d){const f=s[0],_=s[1];return m[0]=d[0]*f+d[4]*_+d[12],m[1]=d[1]*f+d[5]*_+d[13],m[3]=d[3]*f+d[7]*_+d[15],m}const _a=100;class ii{constructor(s,d,f=new nd(s.width+200,s.height+200,25),_=new nd(s.width+200,s.height+200,25)){this.transform=s,this.grid=f,this.ignoredGrid=_,this.pitchfactor=Math.cos(s._pitch)*s.cameraToCenterDistance,this.screenRightBoundary=s.width+_a,this.screenBottomBoundary=s.height+_a,this.gridRightBoundary=s.width+200,this.gridBottomBoundary=s.height+200,this.fogState=d}placeCollisionBox(s,d,f,_,b,S,A,E,D,M,B){let z=f.projectedAnchorX,V=f.projectedAnchorY,Q=f.projectedAnchorZ;const W=f.tileAnchorX,J=f.tileAnchorY,ce=f.elevation,_e=f.tileID,xe=s.getProjection();if(ce&&_e){const[at,nt,ft]=xe.upVector(_e.canonical,f.tileAnchorX,f.tileAnchorY),Nt=xe.upVectorScale(_e.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;z+=at*ce*Nt,V+=nt*ce*Nt,Q+=ft*ce*Nt}const fe=s.projection.name==="globe",Fe=s.projection.name==="globe"?o.aj(this.transform.zoom):0;if(_e&&fe&&Fe<1&&!S){const at=1<<_e.canonical.z,nt=o.bP(W,J);o.bQ(nt,nt,1/o.al),o.bR(nt,nt,o.bP(_e.canonical.x,_e.canonical.y)),o.bQ(nt,nt,1/at),o.bS(nt,nt,o.bP(_[0],_[1])),nt[0]=o.bT(nt[0],-.5,.5),o.bQ(nt,nt,o.al);const ft=o.bU(nt[0],nt[1],o.al/(2*Math.PI),1);o.aC(ft,ft,b),z=o.ak(z,ft[0],Fe),V=o.ak(V,ft[1],Fe),Q=o.ak(Q,ft[2],Fe)}const De=this.projectAndGetPerspectiveRatio(M,z,V,Q,f.tileID,xe.name==="globe"||!!ce||this.transform.pitch>0,xe),Oe=D*De.perspectiveRatio,Ee=(f.x1*d+A.x-f.padding)*Oe+De.point.x,Se=(f.y1*d+A.y-f.padding)*Oe+De.point.y,qe=(f.x2*d+A.x+f.padding)*Oe+De.point.x,Ye=(f.y2*d+A.y+f.padding)*Oe+De.point.y,Qe=De.perspectiveRatio<=.55||De.occluded;return!this.isInsideGrid(Ee,Se,qe,Ye)||!E&&this.grid.hitTest(Ee,Se,qe,Ye,B)||Qe?{box:[],offscreen:!1,occluded:De.occluded}:{box:[Ee,Se,qe,Ye],offscreen:this.isOffscreen(Ee,Se,qe,Ye),occluded:!1}}placeCollisionCircles(s,d,f,_,b,S,A,E,D,M,B,z,V,Q,W,J){const ce=[],_e=this.transform.elevation,xe=s.getProjection(),fe=s.elevationType==="road",Fe=!!_e||fe,De=o.bV.getAtTileOffsetFunc(J,this.transform.center.lat,this.transform.worldSize,xe),Oe=new o.P(f.tileAnchorX,f.tileAnchorY),Ee=new o.P(f.tileAnchorX,f.tileAnchorY);let{x:Se,y:qe,z:Ye}=xe.projectTilePoint(Ee.x,Ee.y,J.canonical),Qe=null;if(Fe){const ei=fe?s.getElevationFeatureForText(_):null;Qe={getElevation:De,elevation:_e,elevationFeature:ei};const[Qt,Wt,Kt]=De(Oe,_e,ei);Se+=Qt,qe+=Wt,Ye+=Kt}const at=xe.name==="globe",nt=this.projectAndGetPerspectiveRatio(E,Se,qe,Ye,J,at||!!_e||this.transform.pitch>0,xe),{perspectiveRatio:ft}=nt,Nt=(z?A/ft:A*ft)/o.bY,rt=Qa(Se,qe,Ye,D),$e=f.lineOffsetX*Nt,dt=f.lineOffsetY*Nt,ot=o.an(s.layers[0].layout.get("text-max-angle")),Ct=Math.cos(ot),Rt=nt.signedDistanceFromCamera>0?Cc(Nt,S,$e,dt,fe&&f.flipState===1,rt,Ee,f,b,D,{},Fe&&!z?Qe:null,z&&Fe,xe,J,z,Ct):null;let Ut=!1,kt=!1,Mt=!0;if(Rt&&!nt.occluded){const ei=.5*Q*ft+W,Qt=new o.P(-100,-100),Wt=new o.P(this.screenRightBoundary,this.screenBottomBoundary),Kt=new ul,{first:gi,last:Ci}=Rt,Hi=gi.path.length;let lr=[];for(let Li=Hi-1;Li>=1;Li--)lr.push(gi.path[Li]);for(let Li=1;Li<Ci.path.length;Li++)lr.push(Ci.path[Li]);const ki=2.5*ei;M&&(lr=lr.map(([Li,Dr,Rr],Fr)=>(Fe&&!at&&(Rr=De(Fr<Hi-1?gi.tilePath[Hi-1-Fr]:Ci.tilePath[Fr-Hi+2],_e,Qe.elevationFeature)[2]),Qa(Li,Dr,Rr,M))),lr.some(Li=>Li[3]<=0)&&(lr=[]));let yr=[];if(lr.length>0){let Li=1/0,Dr=-1/0,Rr=1/0,Fr=-1/0;for(const ur of lr)Li=Math.min(Li,ur[0]),Rr=Math.min(Rr,ur[1]),Dr=Math.max(Dr,ur[0]),Fr=Math.max(Fr,ur[1]);Dr>=Qt.x&&Li<=Wt.x&&Fr>=Qt.y&&Rr<=Wt.y&&(yr=[lr.map(ur=>new o.P(ur[0],ur[1]))],(Li<Qt.x||Dr>Wt.x||Rr<Qt.y||Fr>Wt.y)&&(yr=o.bW(yr,Qt.x,Qt.y,Wt.x,Wt.y)))}for(const Li of yr){Kt.reset(Li,.25*ei);let Dr=0;Dr=Kt.length<=.5*ei?1:Math.ceil(Kt.paddedLength/ki)+1;for(let Rr=0;Rr<Dr;Rr++){const Fr=Rr/Math.max(Dr-1,1),ur=Kt.lerp(Fr),Ui=ur.x+_a,Ir=ur.y+_a;ce.push(Ui,Ir,ei,0);const hn=Ui-ei,pn=Ir-ei,Pr=Ui+ei,rr=Ir+ei;if(Mt=Mt&&this.isOffscreen(hn,pn,Pr,rr),kt=kt||this.isInsideGrid(hn,pn,Pr,rr),!d&&this.grid.hitTestCircle(Ui,Ir,ei,V)&&(Ut=!0,!B))return{circles:[],offscreen:!1,collisionDetected:Ut,occluded:!1}}}}return{circles:!B&&Ut||!kt?[]:ce,offscreen:Mt,collisionDetected:Ut,occluded:nt.occluded}}queryRenderedSymbols(s){if(s.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const d=[];let f=1/0,_=1/0,b=-1/0,S=-1/0;for(const M of s){const B=new o.P(M.x+_a,M.y+_a);f=Math.min(f,B.x),_=Math.min(_,B.y),b=Math.max(b,B.x),S=Math.max(S,B.y),d.push(B)}const A=this.grid.query(f,_,b,S).concat(this.ignoredGrid.query(f,_,b,S)),E={},D={};for(const M of A){const B=M.key;if(E[B.bucketInstanceId]===void 0&&(E[B.bucketInstanceId]={}),E[B.bucketInstanceId][B.featureIndex])continue;const z=[new o.P(M.x1,M.y1),new o.P(M.x2,M.y1),new o.P(M.x2,M.y2),new o.P(M.x1,M.y2)];o.bX(d,z)&&(E[B.bucketInstanceId][B.featureIndex]=!0,D[B.bucketInstanceId]===void 0&&(D[B.bucketInstanceId]=[]),D[B.bucketInstanceId].push(B.featureIndex))}return D}insertCollisionBox(s,d,f,_,b){(d?this.ignoredGrid:this.grid).insert({bucketInstanceId:f,featureIndex:_,collisionGroupID:b},s[0],s[1],s[2],s[3])}insertCollisionCircles(s,d,f,_,b){const S=d?this.ignoredGrid:this.grid,A={bucketInstanceId:f,featureIndex:_,collisionGroupID:b};for(let E=0;E<s.length;E+=4)S.insertCircle(A,s[E],s[E+1],s[E+2])}projectAndGetPerspectiveRatio(s,d,f,_,b,S,A){const E=[d,f,_,1];let D=!1;_||this.transform.pitch>0?(o.aC(E,E,s),this.fogState&&b&&A.name!=="globe"&&(D=function(z,V,Q,W,J,ce){const _e=ce.calculateFogTileMatrix(J),xe=[V,Q,W];return o.af(xe,xe,_e),ci(z,o.ag(xe),ce.pitch,ce._fov)}(this.fogState,d,f,_,b.toUnwrapped(),this.transform)>.9)):ad(E,E,s);const M=E[3];return{point:new o.P((E[0]/M+1)/2*this.transform.width+_a,(-E[1]/M+1)/2*this.transform.height+_a),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(A)/M*.5,1.5),signedDistanceFromCamera:M,occluded:S&&E[2]>M||D}}isOffscreen(s,d,f,_){return f<_a||s>=this.screenRightBoundary||_<_a||d>this.screenBottomBoundary}isInsideGrid(s,d,f,_){return f>=0&&s<this.gridRightBoundary&&_>=0&&d<this.gridBottomBoundary}getViewportMatrix(){const s=o.bA([]);return o.br(s,s,[-100,-100,0]),s}}class br{constructor(s,d,f,_){this.opacity=s?Math.max(0,Math.min(1,s.opacity+(s.placed?d:-d))):_&&f?1:0,this.placed=f}isHidden(){return this.opacity===0&&!this.placed}}class gr{constructor(s,d,f,_,b,S=!1){this.text=new br(s?s.text:null,d,f,b),this.icon=new br(s?s.icon:null,d,_,b),this.clipped=S}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class ca{constructor(s,d,f,_=!1){this.text=s,this.icon=d,this.skipFade=f,this.clipped=_}}class Ec{constructor(){this.invProjMatrix=o.bC(),this.viewportMatrix=o.bC(),this.circles=[]}}class wr{constructor(s,d,f,_,b){this.bucketInstanceId=s,this.featureIndex=d,this.sourceLayerIndex=f,this.bucketIndex=_,this.tileID=b}}class va{constructor(s){this.crossSourceCollisions=s,this.maxGroupID=0,this.collisionGroups={}}get(s){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[s]){const d=++this.maxGroupID;this.collisionGroups[s]={ID:d,predicate:f=>f.collisionGroupID===d}}return this.collisionGroups[s]}}function Ic(m,s,d,f,_){const{horizontalAlign:b,verticalAlign:S}=o.c1(m),A=-(b-.5)*s,E=-(S-.5)*d,D=o.c2(m,f);return new o.P(A+D[0]*_,E+D[1]*_)}function Kl(m,s,d,f,_){const b=new o.P(m,s);return d&&b._rotate(f?_:-_),b}class as{constructor(s,d,f,_,b,S){this.transform=s.clone(),this.projection=s.projection.name,this.collisionIndex=new ii(this.transform,b),this.buildingIndex=S,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=d,this.retainedQueryData={},this.collisionGroups=new va(f),this.collisionCircleArrays={},this.prevPlacement=_,_&&(_.prevPlacement=void 0),this.placedOrientations={},this.lastReplacementSourceUpdateTime=0}getBucketParts(s,d,f,_,b=1){const S=f.getBucket(d),A=f.latestFeatureIndex;if(!S||!A||d.fqid!==S.layerIds[0])return;const E=S.layers[0].layout,D=S.layers[0].paint,M=f.collisionBoxArray,B=Math.pow(2,this.transform.zoom-f.tileID.overscaledZ),z=f.tileSize/o.al,V=f.tileID.toUnwrapped();this.transform.setProjection(S.projection);const Q=(W=f.tileID,J=S.getProjection(),ce=this.transform,J.name===this.projection?ce.calculateProjMatrix(W.toUnwrapped()):Nc(ce,J,W));var W,J,ce;const _e=E.get("text-pitch-alignment")==="map",xe=E.get("text-rotation-alignment")==="map";d.compileFilter(d.options);const fe=d.dynamicFilter(),Fe=d.dynamicFilterNeedsFeature(),De=this.transform.calculatePixelsToTileUnitsMatrix(f),Oe=zo(Q,f.tileID.canonical,_e,xe,this.transform,S.getProjection(),De);let Ee=null;const Se=S.getProjection().createInversionMatrix(this.transform,f.tileID.canonical);if(_e){const $e=Ys(Q,f.tileID.canonical,_e,xe,this.transform,S.getProjection(),De);Ee=o.aB([],this.transform.labelPlaneMatrix,$e)}let qe=null;fe&&f.latestFeatureIndex&&(qe={unwrappedTileID:V,dynamicFilter:fe,dynamicFilterNeedsFeature:Fe}),this.retainedQueryData[S.bucketInstanceId]=new wr(S.bucketInstanceId,A,S.sourceLayerIndex,S.index,f.tileID);const[Ye,Qe]=S.layers[0].layout.get("text-size-scale-range"),at=o.aA(b,Ye,Qe),[nt,ft]=E.get("icon-size-scale-range"),Nt=o.aA(b,nt,ft),rt={bucket:S,layout:E,paint:D,posMatrix:Q,invMatrix:Se,mercatorCenter:[o.aF(this.transform.center.lng),o.aJ(this.transform.center.lat)],textLabelPlaneMatrix:Oe,labelToScreenMatrix:Ee,clippingData:qe,scale:B,textPixelRatio:z,holdingForFade:f.holdingForFade(),collisionBoxArray:M,partiallyEvaluatedTextSize:o.bK(S.textSizeData,this.transform.zoom,at),partiallyEvaluatedIconSize:o.bK(S.iconSizeData,this.transform.zoom,Nt),collisionGroup:this.collisionGroups.get(S.sourceID),latestFeatureIndex:f.latestFeatureIndex};if(_)for(const $e of S.sortKeyRanges){const{sortKey:dt,symbolInstanceStart:ot,symbolInstanceEnd:Ct}=$e;s.push({sortKey:dt,symbolInstanceStart:ot,symbolInstanceEnd:Ct,parameters:rt})}else s.push({symbolInstanceStart:0,symbolInstanceEnd:S.symbolInstances.length,parameters:rt})}attemptAnchorPlacement(s,d,f,_,b,S,A,E,D,M,B,z,V,Q,W,J,ce,_e,xe,fe,Fe){const{textOffset0:De,textOffset1:Oe,crossTileID:Ee}=W,Se=[De,Oe],qe=Ic(s,S,A,Se,E),Ye=this.collisionIndex.placeCollisionBox(ce,E,d,f,_,b,Kl(qe.x,qe.y,D,M,this.transform.angle),Q,B,z,V.predicate);if(xe){const Qe=ce.getSymbolInstanceIconSize(Fe,this.transform.zoom,W.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(ce,Qe,xe,f,_,b,Kl(qe.x,qe.y,D,M,this.transform.angle),Q,B,z,V.predicate).box.length===0)return}if(Ye.box.length>0){let Qe;return this.prevPlacement&&this.prevPlacement.variableOffsets[Ee]&&this.prevPlacement.placements[Ee]&&this.prevPlacement.placements[Ee].text&&(Qe=this.prevPlacement.variableOffsets[Ee].anchor),this.variableOffsets[Ee]={textOffset:Se,width:S,height:A,anchor:s,textScale:E,prevAnchor:Qe},this.markUsedJustification(ce,s,W,_e),ce.allowVerticalPlacement&&(this.markUsedOrientation(ce,_e,W),this.placedOrientations[Ee]=_e),{shift:qe,placedGlyphBoxes:Ye}}}placeLayerBucketPart(s,d,f,_,b=1){const{bucket:S,layout:A,paint:E,posMatrix:D,textLabelPlaneMatrix:M,labelToScreenMatrix:B,clippingData:z,textPixelRatio:V,mercatorCenter:Q,invMatrix:W,holdingForFade:J,collisionBoxArray:ce,partiallyEvaluatedTextSize:_e,partiallyEvaluatedIconSize:xe,collisionGroup:fe,latestFeatureIndex:Fe}=s.parameters,De=A.get("text-optional"),Oe=A.get("icon-optional"),Ee=A.get("text-allow-overlap"),Se=A.get("icon-allow-overlap"),qe=A.get("text-rotation-alignment")==="map",Ye=A.get("icon-rotation-alignment")==="map",Qe=A.get("text-pitch-alignment")==="map",at=E.get("symbol-z-offset"),nt=A.get("symbol-elevation-reference")==="sea",ft=A.get("symbol-placement"),[Nt,rt]=A.get("text-size-scale-range"),[$e,dt]=A.get("icon-size-scale-range"),ot=o.aA(b,Nt,rt),Ct=o.aA(b,$e,dt),Rt=A.get("text-variable-anchor"),Ut=qe&&ft!=="point",kt=Ye&&ft!=="point",Mt=Rt&&S.hasTextData(),ei=S.hasIconTextFit()&&Mt&&S.hasIconData();this.transform.setProjection(S.projection);const Qt=Mt||Ut,Wt=kt||ei;let Kt=Ee&&(Se||!S.hasIconData()||Oe),gi=Se&&(Ee||!S.hasTextData()||De);const Ci=!at.isConstant();!S.collisionArrays&&ce&&S.deserializeCollisionBoxes(ce),f&&_&&S.updateCollisionDebugBuffers(this.transform.zoom,ce,ot,Ct);const Hi=(ki,yr,Li)=>{const{crossTileID:Dr,numVerticalGlyphVertices:Rr}=ki;let Fr=null;if(z&&z.dynamicFilterNeedsFeature||Ci){const _n=this.retainedQueryData[S.bucketInstanceId];Fr=Fe.loadFeature({featureIndex:ki.featureIndex,bucketIndex:_n.bucketIndex,sourceLayerIndex:_n.sourceLayerIndex,layoutVertexArrayOffset:0});const Hn=Fr.properties?Fr.properties.worldview:null;if(S.localizable&&S.worldview&&typeof Hn=="string")if(Hn==="all")Fr.properties.$localized=!0;else{if(!Hn.split(",").includes(S.worldview))return;Fr.properties.$localized=!0,Fr.properties.worldview=S.worldview}}if(z&&!(0,z.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch,worldview:S.worldview},Fr,this.retainedQueryData[S.bucketInstanceId].tileID.canonical,new o.P(ki.tileAnchorX,ki.tileAnchorY),this.transform.calculateDistanceTileData(z.unwrappedTileID)))return this.placements[Dr]=new ca(!1,!1,!1,!0),void d.add(Dr);const ur=at.evaluate(Fr,{});if(d.has(Dr))return;if(J)return void(this.placements[Dr]=new ca(!1,!1,!1));let Ui=!1,Ir=!1,hn=!0,pn=!1,Pr=!1,rr=null,Gi={box:null,offscreen:null,occluded:null},Zr={box:null},Dn=null,Kr=null,tn=null,Va=0,ro=0,Fs=0;Li.textFeatureIndex?Va=Li.textFeatureIndex:ki.useRuntimeCollisionCircles&&(Va=ki.featureIndex),Li.verticalTextFeatureIndex&&(ro=Li.verticalTextFeatureIndex);const jr=S.elevationFeatures?S.elevationFeatures[ki.elevationFeatureIndex]:void 0,vo=_n=>{_n.tileID=this.retainedQueryData[S.bucketInstanceId].tileID;const Hn=this.transform.elevation;_n.elevation=nt?ur:ur+o.bV.getAtTileOffset(_n.tileID,new o.P(_n.tileAnchorX,_n.tileAnchorY),Hn,jr),_n.elevation+=ki.zOffset},ua=Li.textBox;if(ua){vo(ua);const _n=Qr=>{let ts=o.bL.horizontal;if(S.allowVerticalPlacement&&!Qr&&this.prevPlacement){const ba=this.prevPlacement.placedOrientations[Dr];ba&&(this.placedOrientations[Dr]=ba,ts=ba,this.markUsedOrientation(S,ts,ki))}return ts},Hn=(Qr,ts)=>{if(S.allowVerticalPlacement&&Rr>0&&Li.verticalTextBox){for(const ba of S.writingModes)if(ba===o.bL.vertical?(Gi=ts(),Zr=Gi):Gi=Qr(),Gi&&Gi.box&&Gi.box.length)break}else Gi=Qr()};if(Rt){let Qr=Rt;if(this.prevPlacement&&this.prevPlacement.variableOffsets[Dr]){const zn=this.prevPlacement.variableOffsets[Dr];Qr.indexOf(zn.anchor)>0&&(Qr=Qr.filter(bo=>bo!==zn.anchor),Qr.unshift(zn.anchor))}const ts=(zn,bo,bm)=>{const sc=S.getSymbolInstanceTextSize(_e,ki,this.transform.zoom,yr),Th=(zn.x2-zn.x1)*sc+2*zn.padding,Nh=(zn.y2-zn.y1)*sc+2*zn.padding,wo=ki.hasIconTextFit&&!Se?bo:null;wo&&vo(wo);let ac={box:[],offscreen:!1,occluded:!1};const oc=Ee?2*Qr.length:Qr.length;for(let Ho=0;Ho<oc;++Ho){const Mc=this.attemptAnchorPlacement(Qr[Ho%Qr.length],zn,Q,W,Qt,Th,Nh,sc,qe,Qe,V,D,fe,Ho>=Qr.length,ki,yr,S,bm,wo,_e,xe);if(Mc&&(ac=Mc.placedGlyphBoxes,ac&&ac.box&&ac.box.length)){Ui=!0,rr=Mc.shift;break}}return ac};Hn(()=>ts(ua,Li.iconBox,o.bL.horizontal),()=>{const zn=Li.verticalTextBox;return zn&&vo(zn),S.allowVerticalPlacement&&!(Gi&&Gi.box&&Gi.box.length)&&Rr>0&&zn?ts(zn,Li.verticalIconBox,o.bL.vertical):{box:null,offscreen:null,occluded:null}}),Gi&&(Ui=Gi.box,hn=Gi.offscreen,pn=Gi.occluded);const ba=_n(!(!Gi||!Gi.box));if(!Ui&&this.prevPlacement){const zn=this.prevPlacement.variableOffsets[Dr];zn&&(this.variableOffsets[Dr]=zn,this.markUsedJustification(S,zn.anchor,ki,ba))}}else{const Qr=(ts,ba)=>{const zn=S.getSymbolInstanceTextSize(_e,ki,this.transform.zoom,yr),bo=this.collisionIndex.placeCollisionBox(S,zn,ts,Q,W,Qt,new o.P(0,0),Ee,V,D,fe.predicate);return bo&&bo.box&&bo.box.length&&(this.markUsedOrientation(S,ba,ki),this.placedOrientations[Dr]=ba),bo};Hn(()=>Qr(ua,o.bL.horizontal),()=>{const ts=Li.verticalTextBox;return S.allowVerticalPlacement&&Rr>0&&ts?(vo(ts),Qr(ts,o.bL.vertical)):{box:null,offscreen:null,occluded:null}}),_n(!!(Gi&&Gi.box&&Gi.box.length))}}if(Dn=Gi,Ui=Dn&&Dn.box&&Dn.box.length>0,hn=Dn&&Dn.offscreen,pn=Dn&&Dn.occluded,ki.useRuntimeCollisionCircles){const _n=ki.centerJustifiedTextSymbolIndex>=0?ki.centerJustifiedTextSymbolIndex:ki.verticalPlacedTextSymbolIndex,Hn=S.text.placedSymbolArray.get(_n),Qr=o.bM(S.textSizeData,_e,Hn),ts=A.get("text-padding");Kr=this.collisionIndex.placeCollisionCircles(S,Ee,Hn,_n,S.lineVertexArray,S.glyphOffsetArray,Qr,D,M,B,f,Qe,fe.predicate,ki.collisionCircleDiameter*Qr/o.bY,ts,this.retainedQueryData[S.bucketInstanceId].tileID),Ui=Ee||Kr.circles.length>0&&!Kr.collisionDetected,hn=hn&&Kr.offscreen,pn=Kr.occluded}if(Li.iconFeatureIndex&&(Fs=Li.iconFeatureIndex),Li.iconBox){const _n=Hn=>{vo(Hn);const Qr=ki.hasIconTextFit&&rr?Kl(rr.x,rr.y,qe,Qe,this.transform.angle):new o.P(0,0),ts=S.getSymbolInstanceIconSize(xe,this.transform.zoom,ki.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(S,ts,Hn,Q,W,Wt,Qr,Se,V,D,fe.predicate)};Zr&&Zr.box&&Zr.box.length&&Li.verticalIconBox?(tn=_n(Li.verticalIconBox),Ir=tn.box.length>0):(tn=_n(Li.iconBox),Ir=tn.box.length>0),hn=hn&&tn.offscreen,Pr=tn.occluded}const no=De||ki.numHorizontalGlyphVertices===0&&Rr===0,ml=Oe||ki.numIconVertices===0;if(no||ml?ml?no||(Ir=Ir&&Ui):Ui=Ir&&Ui:Ir=Ui=Ir&&Ui,Ui&&Dn&&Dn.box&&this.collisionIndex.insertCollisionBox(Dn.box,A.get("text-ignore-placement"),S.bucketInstanceId,Zr&&Zr.box&&ro?ro:Va,fe.ID),Ir&&tn&&this.collisionIndex.insertCollisionBox(tn.box,A.get("icon-ignore-placement"),S.bucketInstanceId,Fs,fe.ID),Kr&&(Ui&&this.collisionIndex.insertCollisionCircles(Kr.circles,A.get("text-ignore-placement"),S.bucketInstanceId,Va,fe.ID),f)){const _n=S.bucketInstanceId;let Hn=this.collisionCircleArrays[_n];Hn===void 0&&(Hn=this.collisionCircleArrays[_n]=new Ec);for(let Qr=0;Qr<Kr.circles.length;Qr+=4)Hn.circles.push(Kr.circles[Qr+0]),Hn.circles.push(Kr.circles[Qr+1]),Hn.circles.push(Kr.circles[Qr+2]),Hn.circles.push(Kr.collisionDetected?1:0)}const Ua=S.projection.name!=="globe";Kt=Kt&&(Ua||!pn),gi=gi&&(Ua||!Pr),this.placements[Dr]=new ca(Ui||Kt,Ir||gi,hn||S.justReloaded),d.add(Dr)},lr=this.retainedQueryData[S.bucketInstanceId].tileID;if(S.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(S,lr),S.elevationType==="road"&&S.updateRoadElevation(lr.canonical),S.updateZOffset(),S.sortFeaturesByY){const ki=S.getSortedSymbolIndexes(this.transform.angle);for(let yr=ki.length-1;yr>=0;--yr){const Li=ki[yr];Hi(S.symbolInstances.get(Li),Li,S.collisionArrays[Li])}S.hasAnyZOffset&&o.w(`${S.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(S.hasAnyZOffset){const ki=S.getSortedIndexesByZOffset();for(let yr=0;yr<ki.length;++yr){const Li=ki[yr];Hi(S.symbolInstances.get(Li),Li,S.collisionArrays[Li])}}else for(let ki=s.symbolInstanceStart;ki<s.symbolInstanceEnd;ki++)Hi(S.symbolInstances.get(ki),ki,S.collisionArrays[ki]);if(f&&S.bucketInstanceId in this.collisionCircleArrays){const ki=this.collisionCircleArrays[S.bucketInstanceId];o.bl(ki.invProjMatrix,D),ki.viewportMatrix=this.collisionIndex.getViewportMatrix()}S.justReloaded=!1}markUsedJustification(s,d,f,_){const{leftJustifiedTextSymbolIndex:b,centerJustifiedTextSymbolIndex:S,rightJustifiedTextSymbolIndex:A,verticalPlacedTextSymbolIndex:E,crossTileID:D}=f,M=o.c3(d),B=_===o.bL.vertical?E:M==="left"?b:M==="center"?S:M==="right"?A:-1;b>=0&&(s.text.placedSymbolArray.get(b).crossTileID=B>=0&&b!==B?0:D),S>=0&&(s.text.placedSymbolArray.get(S).crossTileID=B>=0&&S!==B?0:D),A>=0&&(s.text.placedSymbolArray.get(A).crossTileID=B>=0&&A!==B?0:D),E>=0&&(s.text.placedSymbolArray.get(E).crossTileID=B>=0&&E!==B?0:D)}markUsedOrientation(s,d,f){const _=d===o.bL.horizontal||d===o.bL.horizontalOnly?d:0,b=d===o.bL.vertical?d:0,{leftJustifiedTextSymbolIndex:S,centerJustifiedTextSymbolIndex:A,rightJustifiedTextSymbolIndex:E,verticalPlacedTextSymbolIndex:D}=f,M=s.text.placedSymbolArray;S>=0&&(M.get(S).placedOrientation=_),A>=0&&(M.get(A).placedOrientation=_),E>=0&&(M.get(E).placedOrientation=_),D>=0&&(M.get(D).placedOrientation=b)}commit(s){this.commitTime=s,this.zoomAtLastRecencyCheck=this.transform.zoom;const d=this.prevPlacement;let f=!1;this.prevZoomAdjustment=d?d.zoomAdjustment(this.transform.zoom):0;const _=d?d.symbolFadeChange(s):1,b=d?d.opacities:{},S=d?d.variableOffsets:{},A=d?d.placedOrientations:{};for(const E in this.placements){const D=this.placements[E],M=b[E];M?(this.opacities[E]=new gr(M,_,D.text,D.icon,null,D.clipped),f=f||D.text!==M.text.placed||D.icon!==M.icon.placed):(this.opacities[E]=new gr(null,_,D.text,D.icon,D.skipFade,D.clipped),f=f||D.text||D.icon)}for(const E in b){const D=b[E];if(!this.opacities[E]){const M=new gr(D,_,!1,!1);M.isHidden()||(this.opacities[E]=M,f=f||D.text.placed||D.icon.placed)}}for(const E in S)this.variableOffsets[E]||!this.opacities[E]||this.opacities[E].isHidden()||(this.variableOffsets[E]=S[E]);for(const E in A)this.placedOrientations[E]||!this.opacities[E]||this.opacities[E].isHidden()||(this.placedOrientations[E]=A[E]);f?this.lastPlacementChangeTime=s:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=d?d.lastPlacementChangeTime:s)}updateLayerOpacities(s,d,f,_){_&&(this.lastReplacementSourceUpdateTime=_.updateTime);const b=new Set;for(const S of d){const A=S.getBucket(s);A&&S.latestFeatureIndex&&s.fqid===A.layerIds[0]&&(this.updateBucketOpacities(A,b,S,S.collisionBoxArray,f,_,S.tileID,s.scope),A.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(A,S.tileID),A.elevationType==="road"&&A.updateRoadElevation(S.tileID.canonical),A.updateZOffset())}}updateBucketOpacities(s,d,f,_,b,S,A,E){s.hasTextData()&&s.text.opacityVertexArray.clear(),s.hasIconData()&&s.icon.opacityVertexArray.clear(),s.hasIconCollisionBoxData()&&s.iconCollisionBox.collisionVertexArray.clear(),s.hasTextCollisionBoxData()&&s.textCollisionBox.collisionVertexArray.clear();const D=s.layers[0].layout,M=s.layers[0].paint,B=!!s.layers[0].dynamicFilter(),z=new gr(null,0,!1,!1,!0),V=D.get("text-allow-overlap"),Q=D.get("icon-allow-overlap"),W=D.get("text-variable-anchor"),J=D.get("text-rotation-alignment")==="map",ce=D.get("text-pitch-alignment")==="map",_e=M.get("symbol-z-offset"),xe=D.get("symbol-elevation-reference")==="sea",fe=!_e.isConstant(),Fe=new gr(null,0,V&&(Q||!s.hasIconData()||D.get("icon-optional")),Q&&(V||!s.hasTextData()||D.get("text-optional")),!0);!s.collisionArrays&&_&&(s.hasIconCollisionBoxData()||s.hasTextCollisionBoxData())&&s.deserializeCollisionBoxes(_);const De=(Ee,Se,qe)=>{for(let Ye=0;Ye<Se/4;Ye++)Ee.opacityVertexArray.emplaceBack(qe)};let Oe=0;S&&s.updateReplacement(A,S);for(let Ee=0;Ee<s.symbolInstances.length;Ee++){const Se=s.symbolInstances.get(Ee),{numHorizontalGlyphVertices:qe,numVerticalGlyphVertices:Ye,crossTileID:Qe,numIconVertices:at,tileAnchorX:nt,tileAnchorY:ft}=Se;let Nt=null;const rt=this.retainedQueryData[s.bucketInstanceId];fe&&Se&&rt&&(Nt=f.latestFeatureIndex.loadFeature({featureIndex:Se.featureIndex,bucketIndex:rt.bucketIndex,sourceLayerIndex:rt.sourceLayerIndex,layoutVertexArrayOffset:0}));const $e=_e.evaluate(Nt,{}),dt=d.has(Qe);let ot=this.opacities[Qe];dt?ot=z:ot||(ot=Fe,this.opacities[Qe]=ot),d.add(Qe);const Ct=qe>0||Ye>0,Rt=at>0,Ut=this.placedOrientations[Qe],kt=Ut===o.bL.vertical,Mt=Ut===o.bL.horizontal||Ut===o.bL.horizontalOnly;!Ct&&!Rt||ot.isHidden()||Oe++;let ei=!1;if((Ct||Rt)&&S)for(const Qt of s.activeReplacements){if(o.bZ(Qt,b,o.b_.Symbol,E)||Qt.min.x>nt||nt>Qt.max.x||Qt.min.y>ft||ft>Qt.max.y)continue;const Wt=o.b$(nt,ft,A.canonical,Qt.footprintTileId.canonical);if(ei=o.c0(Wt,Qt.footprint),ei)break}if(Ct){const Qt=ei?Er:an(ot.text);De(s.text,qe,kt?Er:Qt),De(s.text,Ye,Mt?Er:Qt);const Wt=ot.text.isHidden(),{leftJustifiedTextSymbolIndex:Kt,centerJustifiedTextSymbolIndex:gi,rightJustifiedTextSymbolIndex:Ci,verticalPlacedTextSymbolIndex:Hi}=Se,lr=s.text.placedSymbolArray,ki=Wt||kt?1:0;Kt>=0&&(lr.get(Kt).hidden=ki),gi>=0&&(lr.get(gi).hidden=ki),Ci>=0&&(lr.get(Ci).hidden=ki),Hi>=0&&(lr.get(Hi).hidden=Wt||Mt?1:0);const yr=this.variableOffsets[Qe];yr&&this.markUsedJustification(s,yr.anchor,Se,Ut);const Li=this.placedOrientations[Qe];Li&&(this.markUsedJustification(s,"left",Se,Li),this.markUsedOrientation(s,Li,Se))}if(Rt){const Qt=ei?Er:an(ot.icon),{placedIconSymbolIndex:Wt,verticalPlacedIconSymbolIndex:Kt}=Se,gi=s.icon.placedSymbolArray,Ci=ot.icon.isHidden()?1:0;Wt>=0&&(De(s.icon,at,kt?Er:Qt),gi.get(Wt).hidden=Ci),Kt>=0&&(De(s.icon,Se.numVerticalIconVertices,Mt?Er:Qt),gi.get(Kt).hidden=Ci)}if(s.hasIconCollisionBoxData()||s.hasTextCollisionBoxData()){const Qt=s.collisionArrays[Ee];if(Qt){let Wt=new o.P(0,0),Kt=!0;if(Qt.textBox||Qt.verticalTextBox){if(W){const Ci=this.variableOffsets[Qe];Ci?(Wt=Ic(Ci.anchor,Ci.width,Ci.height,Ci.textOffset,Ci.textScale),J&&Wt._rotate(ce?this.transform.angle:-this.transform.angle)):Kt=!1}B&&(Kt=!ot.clipped),Qt.textBox&&k(s.textCollisionBox.collisionVertexArray,ot.text.placed,!Kt||kt,$e,xe,Wt.x,Wt.y),Qt.verticalTextBox&&k(s.textCollisionBox.collisionVertexArray,ot.text.placed,!Kt||Mt,$e,xe,Wt.x,Wt.y)}const gi=Kt&&!!(!Mt&&Qt.verticalIconBox);Qt.iconBox&&k(s.iconCollisionBox.collisionVertexArray,ot.icon.placed,gi,$e,xe,Se.hasIconTextFit?Wt.x:0,Se.hasIconTextFit?Wt.y:0),Qt.verticalIconBox&&k(s.iconCollisionBox.collisionVertexArray,ot.icon.placed,!gi,$e,xe,Se.hasIconTextFit?Wt.x:0,Se.hasIconTextFit?Wt.y:0)}}}if(s.fullyClipped=Oe===0,s.sortFeatures(this.transform.angle),this.retainedQueryData[s.bucketInstanceId]&&(this.retainedQueryData[s.bucketInstanceId].featureSortOrder=s.featureSortOrder),s.hasTextData()&&s.text.opacityVertexBuffer&&s.text.opacityVertexBuffer.updateData(s.text.opacityVertexArray),s.hasIconData()&&s.icon.opacityVertexBuffer&&s.icon.opacityVertexBuffer.updateData(s.icon.opacityVertexArray),s.hasIconCollisionBoxData()&&s.iconCollisionBox.collisionVertexBuffer&&s.iconCollisionBox.collisionVertexBuffer.updateData(s.iconCollisionBox.collisionVertexArray),s.hasTextCollisionBoxData()&&s.textCollisionBox.collisionVertexBuffer&&s.textCollisionBox.collisionVertexBuffer.updateData(s.textCollisionBox.collisionVertexArray),s.bucketInstanceId in this.collisionCircleArrays){const Ee=this.collisionCircleArrays[s.bucketInstanceId];s.placementInvProjMatrix=Ee.invProjMatrix,s.placementViewportMatrix=Ee.viewportMatrix,s.collisionCircleArray=Ee.circles,delete this.collisionCircleArrays[s.bucketInstanceId]}}symbolFadeChange(s){return this.fadeDuration===0?1:(s-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(s){return Math.max(0,(this.transform.zoom-s)/1.5)}hasTransitions(s){return s-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(s,d){const f=this.zoomAtLastRecencyCheck===d?1-this.zoomAdjustment(d):1;return this.zoomAtLastRecencyCheck=d,this.commitTime+this.fadeDuration*f>s}isStale(){return this.stale}setStale(){this.stale=!0}}function k(m,s,d,f,_,b,S){m.emplaceBack(s?1:0,d?1:0,b||0,S||0,f,_?1:0),m.emplaceBack(s?1:0,d?1:0,b||0,S||0,f,_?1:0),m.emplaceBack(s?1:0,d?1:0,b||0,S||0,f,_?1:0),m.emplaceBack(s?1:0,d?1:0,b||0,S||0,f,_?1:0)}const re=Math.pow(2,25),ye=Math.pow(2,24),We=Math.pow(2,17),Pt=Math.pow(2,16),qt=Math.pow(2,9),Ti=Math.pow(2,8),An=Math.pow(2,1);function an(m){if(m.opacity===0&&!m.placed)return 0;if(m.opacity===1&&m.placed)return 4294967295;const s=m.placed?1:0,d=Math.floor(127*m.opacity);return d*re+s*ye+d*We+s*Pt+d*qt+s*Ti+d*An+s}const Er=0;class Cn{constructor(s){this._sortAcrossTiles=s.layout.get("symbol-z-order")!=="viewport-y"&&s.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(s,d,f,_,b,S){const A=this._bucketParts;for(;this._currentTileIndex<s.length;)if(d.getBucketParts(A,_,s[this._currentTileIndex],this._sortAcrossTiles,S),this._currentTileIndex++,b())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,A.sort((E,D)=>E.sortKey-D.sortKey));this._currentPartIndex<A.length;){const E=A[this._currentPartIndex];if(d.placeLayerBucketPart(E,this._seenCrossTileIDs,f,E.symbolInstanceStart===0,S),this._currentPartIndex++,b())return!0}return!1}}class Ks{startNewPlacement(s,d,f,_,b,S,A,E){return this.placement=new as(s,_,b,S,A,E),this._currentPlacementIndex=d.length-1,this._forceFullPlacement=!1,this._showCollisionBoxes=f,this._fadeDuration=_,this._done=!1,this._inProgressLayer=null,this}requestFullPlacement(){this._forceFullPlacement=!0}isFullPlacementRequested(){return this._forceFullPlacement}setStale(){this.placement&&(this.placement.stale=!0)}isStale(){return!!this.placement&&this.placement.stale}isDone(){return this._done}continuePlacement(s,d,f,_,b){const S=o.o.now(),A=()=>{const E=o.o.now()-S;return!this.isFullPlacementRequested()&&this._fadeDuration!==0&&E>2};for(;this._currentPlacementIndex>=0;){const E=d[s[this._currentPlacementIndex]],D=this.placement.collisionIndex.transform.zoom;if(E.type==="symbol"&&E.visibility!=="none"&&(!E.minzoom||E.minzoom<=D)&&(!E.maxzoom||E.maxzoom>D)){const M=E,B=M.layout.get("symbol-z-elevate"),z=M.layout.get("symbol-sort-key").constantOr(1)!==void 0,V=M.layout.get("symbol-z-order"),Q=V==="viewport-y"||V==="auto"&&!(V!=="viewport-y"&&z),W=M.layout.get("text-allow-overlap")||M.layout.get("icon-allow-overlap")||M.layout.get("text-ignore-placement")||M.layout.get("icon-ignore-placement"),J=Q&&W,ce=this._inProgressLayer=this._inProgressLayer||new Cn(M),_e=o.B(E.source,E.scope);if(ce.continuePlacement(B||J?_[_e]:f[_e],this.placement,this._showCollisionBoxes,E,A,b))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._forceFullPlacement=!1,this._done=!0}commit(s){return this.placement.commit(s),this.placement}}const Ja=512/o.al/2;class un{constructor(s,d,f){this.tileID=s,this.bucketInstanceId=f,this.index=new o.c4(d.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const _=s.canonical.x*o.al,b=s.canonical.y*o.al;for(let S=0;S<d.length;S++){const{key:A,crossTileID:E,tileAnchorX:D,tileAnchorY:M}=d.get(S),B=Math.floor((_+D)*Ja),z=Math.floor((b+M)*Ja);this.index.add(B,z),this.keys.push(A),this.crossTileIDs.push(E)}this.index.finish()}findMatches(s,d,f){const _=this.tileID.canonical.z<d.canonical.z?1:Math.pow(2,this.tileID.canonical.z-d.canonical.z),b=Ja/Math.pow(2,d.canonical.z-this.tileID.canonical.z),S=d.canonical.x*o.al,A=d.canonical.y*o.al;for(let E=0;E<s.length;E++){const D=s.get(E);if(D.crossTileID)continue;const{key:M,tileAnchorX:B,tileAnchorY:z}=D,V=Math.floor((S+B)*b),Q=Math.floor((A+z)*b),W=this.index.range(V-_,Q-_,V+_,Q+_).sort((J,ce)=>J-ce);for(const J of W){const ce=this.crossTileIDs[J];if(this.keys[J]===M&&!f.has(ce)){f.add(ce),D.crossTileID=ce;break}}}}}class eo{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class Bo{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(s){const d=Math.round((s-this.lng)/360);if(d!==0)for(const f in this.indexes){const _=this.indexes[f],b={};for(const S in _){const A=_[S];A.tileID=A.tileID.unwrapTo(A.tileID.wrap+d),b[A.tileID.key]=A}this.indexes[f]=b}this.lng=s}addBucket(s,d,f){if(this.indexes[s.overscaledZ]&&this.indexes[s.overscaledZ][s.key]){if(this.indexes[s.overscaledZ][s.key].bucketInstanceId===d.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(s.overscaledZ,this.indexes[s.overscaledZ][s.key])}for(let b=0;b<d.symbolInstances.length;b++)d.symbolInstances.get(b).crossTileID=0;this.usedCrossTileIDs[s.overscaledZ]||(this.usedCrossTileIDs[s.overscaledZ]=new Set);const _=this.usedCrossTileIDs[s.overscaledZ];for(const b in this.indexes){const S=this.indexes[b];if(Number(b)>s.overscaledZ)for(const A in S){const E=S[A];E.tileID.isChildOf(s)&&E.findMatches(d.symbolInstances,s,_)}else{const A=S[s.scaledTo(Number(b)).key];A&&A.findMatches(d.symbolInstances,s,_)}}for(let b=0;b<d.symbolInstances.length;b++){const S=d.symbolInstances.get(b);S.crossTileID||(S.crossTileID=f.generate(),_.add(S.crossTileID))}return this.indexes[s.overscaledZ]===void 0&&(this.indexes[s.overscaledZ]={}),this.indexes[s.overscaledZ][s.key]=new un(s,d.symbolInstances,d.bucketInstanceId),!0}removeBucketCrossTileIDs(s,d){for(const f of d.crossTileIDs)this.usedCrossTileIDs[s].delete(f)}removeStaleBuckets(s){let d=!1;for(const f in this.indexes){const _=this.indexes[f];for(const b in _)s[_[b].bucketInstanceId]||(this.removeBucketCrossTileIDs(f,_[b]),delete _[b],d=!0)}return d}}class gs{constructor(){this.layerIndexes={},this.crossTileIDs=new eo,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(s,d,f,_){let b=this.layerIndexes[s.fqid];b===void 0&&(b=this.layerIndexes[s.fqid]=new Bo);let S=!1;const A={};_.name!=="globe"&&b.handleWrapJump(f);for(const E of d){const D=E.getBucket(s);D&&s.fqid===D.layerIds[0]&&(D.bucketInstanceId||(D.bucketInstanceId=++this.maxBucketInstanceId),b.addBucket(E.tileID,D,this.crossTileIDs)&&(S=!0),A[D.bucketInstanceId]=!0)}return b.removeStaleBuckets(A)&&(S=!0),S}pruneUnusedLayers(s){const d={};s.forEach(f=>{d[f]=!0});for(const f in this.layerIndexes)d[f]||delete this.layerIndexes[f]}}const cu=771;class Di{constructor(s,d,f,_){this.blendFunction=s,this.blendColor=d.toNonPremultipliedRenderColor(null),this.mask=f,this.blendEquation=_}}Di.Replace=[1,0,1,0],Di.disabled=new Di(Di.Replace,o.ao.transparent,[!1,!1,!1,!1]),Di.unblended=new Di(Di.Replace,o.ao.transparent,[!0,!0,!0,!0]),Di.alphaBlended=new Di([1,cu,1,cu],o.ao.transparent,[!0,!0,!0,!0]),Di.alphaBlendedNonPremultiplied=new Di([770,cu,770,cu],o.ao.transparent,[!0,!0,!0,!0]),Di.multiply=new Di([774,0,774,0],o.ao.transparent,[!0,!0,!0,!0]),Di.additive=new Di([1,1,1,1],o.ao.transparent,[!0,!0,!0,!0]);class si{constructor(s,d,f){this.func=s,this.mask=d,this.range=f}}si.ReadOnly=!1,si.ReadWrite=!0,si.disabled=new si(519,si.ReadOnly,[0,1]);const th=7680;class ji{constructor(s,d,f,_,b,S){this.test=s,this.ref=d,this.mask=f,this.fail=_,this.depthFail=b,this.pass=S}}ji.disabled=new ji({func:519,mask:0},0,0,th,th,th);const If=1029,$p=2305;class Ai{constructor(s,d,f){this.enable=s,this.mode=d,this.frontFace=f}}function ax(m,s){const d=o.ca(m,3);o.cc(m,s),o.cg(m,3,d)}function ox(m,s){const d=o.c7([]);return o.c8(d,d,-s),o.c9(d,d,-m),d}function Ql(m,s){const d=[m[0],m[1],0],f=[s[0],s[1],0];if(o.ag(d)>=1e-15){const S=o.aw([],d);o.c5(f,S,o.bJ(f,S)),s[0]=f[0],s[1]=f[1]}const _=o.bI([],s,m);if(o.c6(_)<1e-15)return null;const b=Math.atan2(-_[1],_[0]);return ox(Math.atan2(Math.sqrt(m[0]*m[0]+m[1]*m[1]),-m[2]),b)}Ai.disabled=new Ai(!1,If,$p),Ai.backCCW=new Ai(!0,If,$p),Ai.backCW=new Ai(!0,If,2304),Ai.frontCW=new Ai(!0,1028,2304),Ai.frontCCW=new Ai(!0,1028,$p);class sb{constructor(s,d){this.position=s,this.orientation=d}get position(){return this._position}set position(s){if(s){const d=s instanceof o.ae?s:new o.ae(s[0],s[1],s[2]);this._renderWorldCopies&&(d.x=o.bT(d.x,0,1)),this._position=d}else this._position=null}lookAtPoint(s,d,f){if(this.orientation=null,!this.position)return;const _=this.position,b=f||(this._elevation?this._elevation.getAtPointOrZero(o.ae.fromLngLat(s)):0),S=o.ae.fromLngLat(s,b),A=[S.x-_.x,S.y-_.y,S.z-_.z];d||(d=[0,0,1]),d[2]=Math.abs(d[2]),this.orientation=Ql(A,d)}setPitchBearing(s,d){this.orientation=ox(o.an(s),o.an(-d))}}class ih{constructor(s,d){this._transform=o.bA([]),this.orientation=d,this.position=s}get mercatorPosition(){const s=this.position;return new o.ae(s[0],s[1],s[2])}get position(){const s=o.ca(this._transform,3);return[s[0],s[1],s[2]]}set position(s){var d;s&&o.cg(this._transform,3,[(d=s)[0],d[1],d[2],1])}get orientation(){return this._orientation}set orientation(s){this._orientation=s||o.c7([]),s&&ax(this._transform,this._orientation)}getPitchBearing(){const s=this.forward(),d=this.right();return{bearing:Math.atan2(-d[1],d[0]),pitch:Math.atan2(Math.sqrt(s[0]*s[0]+s[1]*s[1]),-s[2])}}setPitchBearing(s,d){this._orientation=ox(s,d),ax(this._transform,this._orientation)}forward(){const s=o.ca(this._transform,2);return[-s[0],-s[1],-s[2]]}up(){const s=o.ca(this._transform,1);return[-s[0],-s[1],-s[2]]}right(){const s=o.ca(this._transform,0);return[s[0],s[1],s[2]]}getCameraToWorld(s,d){const f=new Float64Array(16);return o.bl(f,this.getWorldToCamera(s,d)),f}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(s,d,f){const _=this.position;o.c5(_,_,-s);const b=new Float64Array(16);return o.bq(b,[f,f,f]),o.br(b,b,_),b[10]*=d,b}getWorldToCamera(s,d){const f=new Float64Array(16),_=new Float64Array(4),b=this.position;return o.cb(_,this._orientation),o.c5(b,b,-s),o.cc(f,_),o.br(f,f,b),f[1]*=-1,f[5]*=-1,f[9]*=-1,f[13]*=-1,f[8]*=d,f[9]*=d,f[10]*=d,f[11]*=d,f}getCameraToClipPerspective(s,d,f,_){const b=new Float64Array(16);return o.cd(b,s,d,f,_),b}getCameraToClipOrthographic(s,d,f,_,b,S){const A=new Float64Array(16);return o.ce(A,s,d,f,_,b,S),A}getDistanceToElevation(s,d=!1){const f=s===0?0:o.cf(s,d?o.a$(this.position[1]):this.position[1]),_=this.forward();return(f-this.position[2])/_[2]}clone(){return new ih([...this.position],[...this.orientation])}}const to=(m,s)=>({u_matrix:m,u_ground_shadow_factor:s});class lx{constructor(s=0,d=0,f=0,_=0){if(isNaN(s)||s<0||isNaN(d)||d<0||isNaN(f)||f<0||isNaN(_)||_<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=s,this.bottom=d,this.left=f,this.right=_}interpolate(s,d,f){return d.top!=null&&s.top!=null&&(this.top=o.ak(s.top,d.top,f)),d.bottom!=null&&s.bottom!=null&&(this.bottom=o.ak(s.bottom,d.bottom,f)),d.left!=null&&s.left!=null&&(this.left=o.ak(s.left,d.left,f)),d.right!=null&&s.right!=null&&(this.right=o.ak(s.right,d.right,f)),this}getCenter(s,d){const f=o.aA((this.left+s-this.right)/2,0,s),_=o.aA((this.top+d-this.bottom)/2,0,d);return new o.P(f,_)}equals(s){return this.top===s.top&&this.bottom===s.bottom&&this.left===s.left&&this.right===s.right}clone(){return new lx(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const Jl=15;class Pf{constructor(s,d,f,_,b,S,A){this.tileSize=512,this._renderWorldCopies=b===void 0||b,this._minZoom=s||0,this._maxZoom=d||22,this._minPitch=f??0,this._maxPitch=_??60,this.setProjection(S),this.setMaxBounds(A),this.width=0,this.height=0,this._center=new o.aT(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new lx,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new ih,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){const s=new Pf(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return s._elevation=this._elevation,s._centerAltitude=this._centerAltitude,s._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,s.tileSize=this.tileSize,s.mercatorFromTransition=this.mercatorFromTransition,s.width=this.width,s.height=this.height,s.cameraElevationReference=this.cameraElevationReference,s._center=this._center,s._setZoom(this.zoom),s._seaLevelZoom=this._seaLevelZoom,s.angle=this.angle,s._fov=this._fov,s._pitch=this._pitch,s._nearZ=this._nearZ,s._farZ=this._farZ,s._averageElevation=this._averageElevation,s._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,s._unmodified=this._unmodified,s._edgeInsets=this._edgeInsets.clone(),s._camera=this._camera.clone(),s._calcMatrices(),s.freezeTileCoverage=this.freezeTileCoverage,s.frustumCorners=this.frustumCorners,s._allowWorldUnderZoom=this._allowWorldUnderZoom,s}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<Jl}get elevation(){return this._elevation}set elevation(s){this._elevation!==s&&(this._elevation=s,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(s,d=!1){const f=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||f)&&this._updateCameraOnTerrain(),(s||f)&&this._constrainCamera(d),this._calcMatrices()}getProjection(){return o.aH(this.projection,["name","center","parallels"])}setProjection(s){this.projectionOptions=s||{name:"mercator"};const d=this.projection?this.getProjection():void 0;this.projection=o.cm(this.projectionOptions);const f=this.getProjection(),_=!o.by(d,f);return _&&this._calcMatrices(),this.mercatorFromTransition=!1,_}setOrthographicProjectionAtLowPitch(s){return this._orthographicProjectionAtLowPitch!==s&&(this._orthographicProjectionAtLowPitch=s,this._calcMatrices(),!0)}setMercatorFromTransition(){const s=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=o.cm({name:"mercator"});const d=s!==this.projection.name;return d&&this._calcMatrices(),d}get minZoom(){return this._minZoom}set minZoom(s){this._minZoom!==s&&(this._minZoom=s,this.zoom=Math.max(this.zoom,s))}get maxZoom(){return this._maxZoom}set maxZoom(s){this._maxZoom!==s&&(this._maxZoom=s,this.zoom=Math.min(this.zoom,s))}get minPitch(){return this._minPitch}set minPitch(s){this._minPitch!==s&&(this._minPitch=s,this.pitch=Math.max(this.pitch,s))}get maxPitch(){return this._maxPitch}set maxPitch(s){this._maxPitch!==s&&(this._maxPitch=s,this.pitch=Math.min(this.pitch,s))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(s){s===void 0?s=!0:s===null&&(s=!1),this._renderWorldCopies=s}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const s=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(s))}get cameraWorldSize(){const s=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(s))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return o.cf(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new o.P(this.width,this.height)}get bearing(){return o.bT(this.rotation,-180,180)}set bearing(s){this.rotation=s}get rotation(){return-this.angle/Math.PI*180}set rotation(s){const d=-s*Math.PI/180;this.angle!==d&&(this._unmodified=!1,this.angle=d,this._calcMatrices(),this.rotationMatrix=o.cn(),o.co(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(s){const d=o.aA(s,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==d&&(this._unmodified=!1,this._pitch=d,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(s){s=Math.max(.01,Math.min(60,s)),this._fov!==s&&(this._unmodified=!1,this._fov=o.an(s),this._calcMatrices())}get fovX(){return this._fov}get fovY(){const s=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/s)}get averageElevation(){return this._averageElevation}set averageElevation(s){this._averageElevation=s,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(s){const d=Math.min(Math.max(s,this.minZoom),this.maxZoom);this._zoom!==d&&(this._unmodified=!1,this._setZoom(d),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(s){this._zoom=s,this.scale=this.zoomScale(s),this.tileZoom=Math.floor(s),this.zoomFraction=s-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(s){this._tileCoverLift!==s&&(this._tileCoverLift=s)}_updateCameraOnTerrain(){const s=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,d=this.elevation&&s===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||s===Number.NEGATIVE_INFINITY&&(!d||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const f=this._elevation;d||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&f.exaggeration()&&this._centerAltitudeValidForExaggeration!==f.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*f.exaggeration(),this._centerAltitudeValidForExaggeration=f.exaggeration()):(this._centerAltitude=s||0,this._centerAltitudeValidForExaggeration=f.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){if(this._centerAltitudeValidForExaggeration===void 0)return;const s=Math.max(0,(this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize);this._seaLevelZoom=this._zoomFromMercatorZ(s)}sampleAverageElevation(){if(!this._elevation)return 0;const s=this._elevation,d=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],f=this.horizonLineFromTop();let _=0,b=0;for(let S=0;S<d.length;S++){const A=new o.P(d[S][0]*this.width,f+d[S][1]*(this.height-f)),E=s.pointCoordinate(A);if(!E)continue;const D=1/Math.hypot(E[0]-this._camera.position[0],E[1]-this._camera.position[1]);_+=E[3]*D,b+=D}return b===0?NaN:_/b}get center(){return this._center}set center(s){s.lat===this._center.lat&&s.lng===this._center.lng||(this._unmodified=!1,this._center=s,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;const s=this._seaLevelZoom,d=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),f=this.pixelsPerMeter/this.worldSize*d,_=this._mercatorZfromZoom(s),b=this._mercatorZfromZoom(this._maxZoom),S=Math.max(_-f,b);this._setZoom(this._zoomFromMercatorZ(S))}get padding(){return this._edgeInsets.toJSON()}set padding(s){this._edgeInsets.equals(s)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,s,1),this._calcMatrices())}equals(s){const d=this.elevation,f=s.elevation,_=d!=null!=(f!=null)||d&&f&&d.exaggeration()!==f.exaggeration();return this.width===s.width&&this.height===s.height&&this.center.lng===s.center.lng&&this.center.lat===s.center.lat&&this.zoom===s.zoom&&this.bearing===s.bearing&&this.pitch===s.pitch&&this.fov===s.fov&&this.projection.name===s.projection.name&&this._edgeInsets.equals(s.padding)&&!_}computeZoomRelativeTo(s){const d=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,s.toAltitude()));let f;f=s.z<this._camera.position[2]?[d.x,d.y,d.z]:[s.x,s.y,s.z];const _=o.ag(o.av([],this._camera.position,f));return o.aA(this._zoomFromMercatorZ(_),this._minZoom,this._maxZoom)}setFreeCameraOptions(s){if(!this.height||!s.position&&!s.orientation)return;this._updateCameraState();let d=!1;if(s.orientation&&!o.cp(s.orientation,this._camera.orientation)&&(d=this._setCameraOrientation(s.orientation)),s.position){const f=[s.position.x,s.position.y,s.position.z];o.cq(f,this._camera.position)||(this._setCameraPosition(f),d=!0)}d&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const s=this._camera.position,d=new sb;return d.position=new o.ae(s[0],s[1],s[2]),d.orientation=this._camera.orientation,d._elevation=this.elevation,d._renderWorldCopies=this.renderWorldCopies,d}_setCameraOrientation(s){if(!o.cr(s))return!1;o.cs(s,s);const d=o.ct([],[0,0,-1],s),f=o.ct([],[0,-1,0],s);if(f[2]<0)return!1;const _=Ql(d,f);return!!_&&(this._camera.orientation=_,!0)}_setCameraPosition(s){const d=this.zoomScale(this.minZoom)*this.tileSize,f=this.zoomScale(this.maxZoom)*this.tileSize,_=this.cameraToCenterDistance;s[2]=o.aA(s[2],_/f,_/d),this._camera.position=s}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(s){return this._edgeInsets.equals(s)}interpolatePadding(s,d,f){this._unmodified=!1,this._edgeInsets.interpolate(s,d,f),this._constrain(),this._calcMatrices()}coveringZoomLevel(s){const d=(s.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/s.tileSize));return Math.max(0,d)}getVisibleUnwrappedCoordinates(s){const d=[new o.cu(0,s)];if(this.renderWorldCopies){const f=this.pointCoordinate(new o.P(0,0)),_=this.pointCoordinate(new o.P(this.width,0)),b=this.pointCoordinate(new o.P(this.width,this.height)),S=this.pointCoordinate(new o.P(0,this.height)),A=Math.floor(Math.min(f.x,_.x,b.x,S.x)),E=Math.floor(Math.max(f.x,_.x,b.x,S.x)),D=1;for(let M=A-D;M<=E+D;M++)M!==0&&d.push(new o.cu(M,s))}return d}isLODDisabled(s){return(!s||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(s,d,f,_){let b=[];const S=f!=null,A=!S;if(A&&this.zoom<d||S&&f[0]===0&&f[1]===0)return b;const E=new Set,D=(B,z,V,Q,W)=>{const J=o.cY(z,B,V,Q,W);E.has(J)||(b.push(new o.aQ(B,z,V,Q,W)),E.add(J))};for(let B=0;B<s.length;B++){const z=s[B];if(A&&z.canonical.z!==d||S&&_!==void 0&&_>z.canonical.z)continue;const V=z.canonical,Q=z.overscaledZ,W=z.wrap,J=1<<V.z,ce=V.x+1<J,_e=V.x>0,xe=V.y+1<J,fe=V.y>0,Fe=z.wrap-(_e?0:1),De=z.wrap+(ce?0:1),Oe=_e?V.x-1:J-1,Ee=ce?V.x+1:0;if(S)f[0]<0?(D(Q,De,V.z,Ee,V.y),f[1]<0&&xe&&(D(Q,W,V.z,V.x,V.y+1),D(Q,De,V.z,Ee,V.y+1)),f[1]>0&&fe&&(D(Q,W,V.z,V.x,V.y-1),D(Q,De,V.z,Ee,V.y-1))):f[0]>0?(D(Q,Fe,V.z,Oe,V.y),f[1]<0&&xe&&(D(Q,W,V.z,V.x,V.y+1),D(Q,Fe,V.z,Oe,V.y+1)),f[1]>0&&fe&&(D(Q,W,V.z,V.x,V.y-1),D(Q,Fe,V.z,Oe,V.y-1))):f[1]<0&&xe?D(Q,W,V.z,V.x,V.y+1):fe&&D(Q,W,V.z,V.x,V.y-1);else{const Se=z.visibleQuadrants;1&Se&&(D(Q,Fe,V.z,Oe,V.y),fe&&(D(Q,W,V.z,V.x,V.y-1),D(Q,Fe,V.z,Oe,V.y-1))),2&Se&&(D(Q,De,V.z,Ee,V.y),fe&&(D(Q,W,V.z,V.x,V.y-1),D(Q,De,V.z,Ee,V.y-1))),4&Se&&(D(Q,Fe,V.z,Oe,V.y),xe&&(D(Q,W,V.z,V.x,V.y+1),D(Q,Fe,V.z,Oe,V.y+1))),8&Se&&(D(Q,De,V.z,Ee,V.y),xe&&(D(Q,W,V.z,V.x,V.y+1),D(Q,De,V.z,Ee,V.y+1)))}}const M=[];for(const B of b)b.some(z=>B.isChildOf(z))||M.push(B);if(b=M.filter(B=>!s.some(z=>!!(B.overscaledZ<d&&z.isChildOf(B))||B.equals(z)||B.isChildOf(z))),A){const B=1<<d,z=this.projection.name==="globe"?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),V=[B*z.x,B*z.y],Q=4,W=Q*Q;b=b.filter(J=>{const ce=J.canonical.x+.5-V[0],_e=J.canonical.y+.5-V[1];return ce*ce+_e*_e<W})}return b}extendTileCoverToNearPlane(s,d,f){const _=[],b=new Set;for(const _e of s)b.add(_e.key);const S=(_e,xe,fe,Fe,De)=>{const Oe=o.cY(xe,_e,fe,Fe,De);b.has(Oe)||(_.push(new o.aQ(_e,xe,fe,Fe,De)),b.add(Oe))},A=s.reduce((_e,xe)=>Math.max(_e,xe.overscaledZ),f),E=1<<f,D=[new o.P(0,0),new o.P(o.al,0),new o.P(o.al,o.al),new o.P(0,o.al)],M=new o.P(0,0),B=new o.P(0,0),z=(_e,xe)=>{const fe=Math.floor(_e[0]),Fe=Math.floor(_e[1]),De=(_e[0]-fe)*o.al,Oe=(_e[1]-Fe)*o.al,Ee=Math.floor(xe[0]),Se=Math.floor(xe[1]),qe=(xe[0]-Ee)*o.al,Ye=(xe[1]-Se)*o.al;for(let Qe=-1;Qe<=1;Qe++){const at=fe+Qe;if(!(at<0||at>=E)){M.x=De-Qe*o.al,B.x=qe-(at-Ee)*o.al;for(let nt=-1;nt<=1;nt++){const ft=Fe+nt;M.y=Oe-nt*o.al,B.y=Ye-(ft-Se)*o.al,o.cZ(M,B,D)&&S(A,0,f,at,ft)}}}},V=d.points,Q=V[o.cv],W=V[o.cw],J=this._projectToGround(Q,V[o.cx]),ce=this._projectToGround(W,V[o.cy]);return z(Q,J),z(W,ce),_}_projectToGround(s,d){return o.cz(o.cA(),s,d,s[2]/(s[2]-d[2]))}coveringTiles(s){let d=this.coveringZoomLevel(s);const f=d,_=this.elevation&&this.elevation.exaggeration(),b=_&&!s.isTerrainDEM,S=this.projection.name==="mercator";if(s.minzoom!==void 0&&d<s.minzoom)return[];s.maxzoom!==void 0&&d>s.maxzoom&&(d=s.maxzoom);const A=this.locationCoordinate(this.center),E=this.center.lat,D=1<<d,M=[D*A.x,D*A.y,0],B=this.projection.name==="globe",z=!B,V=o.cB.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,d,z),Q=B?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),W=D*o.cf(1,this.center.lat),J=this._camera.position[2]/o.cf(1,this.center.lat),ce=[D*Q.x,D*Q.y,J*(z?1:W)],_e=B||_,xe=this.cameraToCenterDistance/s.tileSize*(s.roundZoom?1:.502),fe=this.isLODDisabled(!0)?d:0;let Fe;if(this._elevation&&s.isTerrainDEM)Fe=1e4*this._elevation.exaggeration();else if(this._elevation){const $e=this._elevation.getMinMaxForVisibleTiles();Fe=$e?$e.max:this._centerAltitude}else Fe=this._centerAltitude;const De=s.isTerrainDEM?-Fe:this._elevation?this._elevation.getMinElevationBelowMSL():0,Oe=this.projection.isReprojectedInTileSpace?o.cC(this):1,Ee=$e=>{const ot=new o.ae($e.x+25e-6,$e.y,$e.z),Ct=new o.ae($e.x,$e.y+25e-6,$e.z),Rt=$e.toLngLat(),Ut=ot.toLngLat(),kt=Ct.toLngLat(),Mt=this.locationCoordinate(Rt),ei=this.locationCoordinate(Ut),Qt=this.locationCoordinate(kt),Wt=Math.hypot(ei.x-Mt.x,ei.y-Mt.y),Kt=Math.hypot(Qt.x-Mt.x,Qt.y-Mt.y);return Math.sqrt(Wt*Kt)*Oe/25e-6},Se=$e=>{const dt=Fe,ot=De;return{aabb:o.cF(this,D,0,0,0,$e,ot,dt,this.projection),zoom:0,x:0,y:0,minZ:ot,maxZ:dt,wrap:$e,fullyVisible:!1}},qe=[];let Ye=[];const Qe=d,at=s.reparseOverscaled?f:d,nt=(J-this._centerAltitude)*W,ft=$e=>{if(!this._elevation||!$e.tileID||!S)return;const dt=this._elevation.getMinMaxForTile($e.tileID),ot=$e.aabb;dt?(ot.min[2]=dt.min,ot.max[2]=dt.max,ot.center[2]=(ot.min[2]+ot.max[2])/2):($e.shouldSplit=rt($e),$e.shouldSplit||(ot.min[2]=ot.max[2]=ot.center[2]=this._centerAltitude))},Nt=($e,dt)=>{if(.707*dt<$e)return 1;const ot=dt/$e;return ot/(1.4144271570014144+(Math.pow(1.1,ot-1.4144271570014144+1)-1)/(1.1-1)-1)},rt=$e=>{if($e.zoom<fe)return!0;if($e.zoom===Qe)return!1;if($e.shouldSplit!=null)return $e.shouldSplit;const dt=$e.aabb.distanceX(ce),ot=$e.aabb.distanceY(ce);let Ct=nt,Rt=1;if(B){Ct=$e.aabb.distanceZ(ce);const Kt=Math.pow(2,$e.zoom),gi=o.a$(($e.y+1)/Kt),Ci=o.a$($e.y/Kt),Hi=Math.min(Math.max(E,gi),Ci),lr=o.d1(Hi)/o.d1(E);if(Rt=Hi===E?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,lr/this._mercatorScaleRatio),this.zoom<=o.c_&&$e.zoom===Qe-1&&lr>=.9)return!0}else if(b&&(Ct=$e.aabb.distanceZ(ce)*W),this.projection.isReprojectedInTileSpace&&f<=5){const Kt=Math.pow(2,$e.zoom),gi=Ee(new o.ae(($e.x+.5)/Kt,($e.y+.5)/Kt));Rt=gi>.85?1:gi}if(!S&&!B){const Kt=Math.sqrt(dt*dt+ot*ot+Ct*Ct);let gi=(1<<Qe-$e.zoom)*xe*Rt;return gi*=Nt(Math.max(Ct,nt),Kt),Kt<gi}let Ut=Number.MAX_VALUE,kt=0;const Mt=$e.aabb.getCorners(),ei=[];for(const Kt of Mt){o.av(ei,Kt,ce),B||(b?ei[2]*=W:ei[2]=nt);const gi=o.bJ(ei,this._camera.forward());gi<Ut&&(Ut=gi,kt=Math.abs(ei[2]))}let Qt=(1<<Qe-$e.zoom)*xe*Rt;if(Qt*=Nt(Math.max(kt,nt),Ut),Ut<Qt)return!0;const Wt=$e.aabb.closestPoint(M);return Wt[0]===M[0]&&Wt[1]===M[1]};if(this.renderWorldCopies)for(let $e=1;$e<=3;$e++)qe.push(Se(-$e)),qe.push(Se($e));for(qe.push(Se(0));qe.length>0;){const $e=qe.pop(),dt=$e.x,ot=$e.y;let Ct=$e.fullyVisible;const Rt=()=>this.projection.name==="globe"&&($e.y===0||$e.y===(1<<$e.zoom)-1);if(!Ct){let Ut=_e?$e.aabb.intersects(V):$e.aabb.intersectsFlat(V);if(Ut===0&&Rt()){const kt=new o.cD($e.zoom,dt,ot);Ut=o.cE(this,D,kt,!0).intersects(V)}if(Ut===0)continue;Ct=Ut===2}if($e.zoom===Qe||!rt($e)){const Ut=$e.zoom===Qe?at:$e.zoom;if(s.minzoom&&s.minzoom>Ut)continue;let kt=0;if(!Ct){let Wt=_e?$e.aabb.intersectsPrecise(V):$e.aabb.intersectsPreciseFlat(V);if(Wt===0&&Rt()){const Kt=new o.cD($e.zoom,dt,ot);Wt=o.cE(this,D,Kt,!0).intersectsPrecise(V)}if(Wt===0)continue;if(s.calculateQuadrantVisibility)if(V.containsPoint($e.aabb.center))kt=15;else for(let Kt=0;Kt<4;Kt++)$e.aabb.quadrant(Kt).intersects(V)!==0&&(kt|=1<<Kt)}const Mt=M[0]-(.5+dt+($e.wrap<<$e.zoom))*(1<<d-$e.zoom),ei=M[1]-.5-ot,Qt=$e.tileID?$e.tileID:new o.aQ(Ut,$e.wrap,$e.zoom,dt,ot);s.calculateQuadrantVisibility&&(Qt.visibleQuadrants=kt),Ye.push({tileID:Qt,distanceSq:Mt*Mt+ei*ei});continue}for(let Ut=0;Ut<4;Ut++){const kt=(dt<<1)+Ut%2,Mt=(ot<<1)+(Ut>>1),ei={aabb:S?$e.aabb.quadrant(Ut):o.cF(this,D,$e.zoom+1,kt,Mt,$e.wrap,$e.minZ,$e.maxZ,this.projection),zoom:$e.zoom+1,x:kt,y:Mt,wrap:$e.wrap,fullyVisible:Ct,tileID:void 0,shouldSplit:void 0,minZ:$e.minZ,maxZ:$e.maxZ};b&&!B&&(ei.tileID=new o.aQ($e.zoom+1===Qe?at:$e.zoom+1,$e.wrap,$e.zoom+1,kt,Mt),ft(ei)),qe.push(ei)}}if(this.fogCullDistSq){const $e=this.fogCullDistSq,dt=this.horizonLineFromTop();Ye=Ye.filter(ot=>{const Ct=[0,0,0,1],Rt=[o.al,o.al,0,1],Ut=this.calculateFogTileMatrix(ot.tileID.toUnwrapped());o.aC(Ct,Ct,Ut),o.aC(Rt,Rt,Ut);const kt=o.cG([],Ct,Rt),Mt=o.cH([],Ct,Rt),ei=o.c$(kt,Mt);if(ei===0)return!0;let Qt=!1;const Wt=this._elevation;if(Wt&&ei>$e&&dt!==0){const Kt=this.calculateProjMatrix(ot.tileID.toUnwrapped());let gi;s.isTerrainDEM||(gi=Wt.getMinMaxForTile(ot.tileID)),gi||(gi={min:De,max:Fe});const Ci=o.cI(this.rotation),Hi=[Ci[0]*o.al,Ci[1]*o.al,gi.max];o.af(Hi,Hi,Kt),Qt=(1-Hi[1])*this.height*.5<dt}return ei<$e||Qt})}return Ye.sort(($e,dt)=>$e.distanceSq-dt.distanceSq).map($e=>$e.tileID)}resize(s,d){this.width=s,this.height=d,this.pixelsToGLUnits=[2/s,-2/d],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(s){return Math.pow(2,s)}scaleZoom(s){return Math.log2(s)}project(s){const d=o.aA(s.lat,-o.cJ,o.cJ),f=this.projection.project(s.lng,d);return new o.P(f.x*this.worldSize,f.y*this.worldSize)}unproject(s){return this.projection.unproject(s.x/this.worldSize,s.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/o.cf(1,this.center.lat)/this.worldSize}setLocationAtPoint(s,d){let f,_;const b=this.centerPoint;if(this.projection.name==="globe"){const A=this.worldSize;f=(d.x-b.x)/A,_=(d.y-b.y)/A}else{const A=this.pointCoordinate(d),E=this.pointCoordinate(b);f=A.x-E.x,_=A.y-E.y}const S=this.locationCoordinate(s);this.setLocation(new o.ae(S.x-f,S.y-_))}setLocation(s){this.center=this.coordinateLocation(s),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(s,d){return this.projection.locationPoint(this,s,d)}locationPoint3D(s,d){return this.projection.locationPoint(this,s,d,!0)}pointLocation(s){return this.coordinateLocation(this.pointCoordinate(s))}pointLocation3D(s,d){return this.coordinateLocation(this.pointCoordinate3D(s,d))}locationCoordinate(s,d){const f=d?o.cf(d,s.lat):void 0,_=this.projection.project(s.lng,s.lat);return new o.ae(_.x,_.y,f)}coordinateLocation(s){return this.projection.unproject(s.x,s.y)}pointRayIntersection(s,d){const f=d??this._centerAltitude,_=[s.x,s.y,0,1],b=[s.x,s.y,1,1];o.aC(_,_,this.pixelMatrixInverse),o.aC(b,b,this.pixelMatrixInverse);const S=b[3];o.cK(_,_,1/_[3]),o.cK(b,b,1/S);const A=_[2],E=b[2];return{p0:_,p1:b,t:A===E?0:(f-A)/(E-A)}}screenPointToMercatorRay(s){const d=[s.x,s.y,0,1],f=[s.x,s.y,1,1];return o.aC(d,d,this.pixelMatrixInverse),o.aC(f,f,this.pixelMatrixInverse),o.cK(d,d,1/d[3]),o.cK(f,f,1/f[3]),d[2]=o.cf(d[2],this._center.lat)*this.worldSize,f[2]=o.cf(f[2],this._center.lat)*this.worldSize,o.cK(d,d,1/this.worldSize),o.cK(f,f,1/this.worldSize),new o.ax([d[0],d[1],d[2]],o.aw([],o.av([],f,d)))}rayIntersectionCoordinate(s){const{p0:d,p1:f,t:_}=s,b=o.cf(d[2],this._center.lat),S=o.cf(f[2],this._center.lat);return new o.ae(o.ak(d[0],f[0],_)/this.worldSize,o.ak(d[1],f[1],_)/this.worldSize,o.ak(b,S,_))}pointCoordinate(s,d=this._centerAltitude){return this.projection.pointCoordinate(this,s.x,s.y,d)}pointCoordinate3D(s,d){if(!this.elevation)return this.pointCoordinate(s,d);let f=this.projection.pointCoordinate3D(this,s.x,s.y);if(f)return new o.ae(f[0],f[1],f[2]);let _=0,b=this.horizonLineFromTop();if(s.y>b)return this.pointCoordinate(s,d);const S=.02*b,A=s.clone();for(let E=0;E<10&&b-_>S;E++){A.y=o.ak(_,b,.66);const D=this.projection.pointCoordinate3D(this,A.x,A.y);D?(b=A.y,f=D):_=A.y}return f?new o.ae(f[0],f[1],f[2]):this.pointCoordinate(s)}isPointAboveHorizon(s){return this.projection.isPointAboveHorizon(this,s)}isPointOnSurface(s){if(s.y<0||s.y>this.height||s.x<0||s.x>this.width)return!1;if(this.elevation||this.zoom>=o.cL)return!this.isPointAboveHorizon(s);const d=this.pointCoordinate(s);return d.y>=0&&d.y<=1}_coordinatePoint(s,d){const f=d&&this.elevation?this.elevation.getAtPointOrZero(s,this._centerAltitude):this._centerAltitude,_=[s.x*this.worldSize,s.y*this.worldSize,f+s.toAltitude(),1];return o.aC(_,_,this.pixelMatrix),_[3]>0?new o.P(_[0]/_[3],_[1]/_[3]):new o.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:s,left:d}=this._edgeInsets,f=this.height-this._edgeInsets.bottom,_=this.width-this._edgeInsets.right,b=this.pointLocation3D(new o.P(d,s)),S=this.pointLocation3D(new o.P(_,s)),A=this.pointLocation3D(new o.P(_,f)),E=this.pointLocation3D(new o.P(d,f));let D=Math.min(b.lng,S.lng,A.lng,E.lng),M=Math.max(b.lng,S.lng,A.lng,E.lng),B=Math.min(b.lat,S.lat,A.lat,E.lat),z=Math.max(b.lat,S.lat,A.lat,E.lat);const V=Math.pow(2,-this.zoom)/16*270,Q=this.projection.name==="globe"?1:4,W=(J,ce,_e,xe,fe)=>{const Fe=(J+_e)/2,De=(ce+xe)/2,Oe=new o.P(Fe,De),{lng:Ee,lat:Se}=this.pointLocation3D(Oe),qe=Math.max(0,D-Ee,B-Se,Ee-M,Se-z);D=Math.min(D,Ee),M=Math.max(M,Ee),B=Math.min(B,Se),z=Math.max(z,Se),(fe<Q||qe>V)&&(W(J,ce,Fe,De,fe+1),W(Fe,De,_e,xe,fe+1))};if(W(d,s,_,s,1),W(_,s,_,f,1),W(_,f,d,f,1),W(d,f,d,s,1),this.projection.name==="globe"){const[J,ce]=o.cM(this);J?(z=90,M=180,D=-180):ce&&(B=-90,M=180,D=-180)}return new o.aI(new o.aT(D,B),new o.aT(M,z))}_getBoundsRectangular(s,d){const{top:f,left:_}=this._edgeInsets,b=this.height-this._edgeInsets.bottom,S=this.width-this._edgeInsets.right,A=new o.P(_,f),E=new o.P(S,f),D=new o.P(S,b),M=new o.P(_,b);let B=this.pointCoordinate(A,s),z=this.pointCoordinate(E,s);const V=this.pointCoordinate(D,d),Q=this.pointCoordinate(M,d),W=(J,ce)=>(ce.y-J.y)/(ce.x-J.x);return B.y>1&&z.y>=0?B=new o.ae((1-Q.y)/W(Q,B)+Q.x,1):B.y<0&&z.y<=1&&(B=new o.ae(-Q.y/W(Q,B)+Q.x,0)),z.y>1&&B.y>=0?z=new o.ae((1-V.y)/W(V,z)+V.x,1):z.y<0&&B.y<=1&&(z=new o.ae(-V.y/W(V,z)+V.x,0)),new o.aI().extend(this.coordinateLocation(B)).extend(this.coordinateLocation(z)).extend(this.coordinateLocation(Q)).extend(this.coordinateLocation(V))}_getBoundsRectangularTerrain(){const s=this.elevation;if(!s.visibleDemTiles.length||s.isUsingMockSource())return this._getBoundsRectangular(0,0);const d=s.visibleDemTiles.reduce((f,_)=>{if(_.dem){const b=_.dem.tree;f.min=Math.min(f.min,b.minimums[0]),f.max=Math.max(f.max,b.maximums[0])}return f},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(d.min*s.exaggeration(),d.max*s.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(s=!0){const d=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,f=this.height/2-d*(1-this._horizonShift);return s?Math.max(0,f):f}getMaxBounds(){return this.maxBounds}setMaxBounds(s){this.maxBounds=s,this.minLat=-o.cJ,this.maxLat=o.cJ,this.minLng=-180,this.maxLng=180,s&&(this.minLat=s.getSouth(),this.maxLat=s.getNorth(),this.minLng=s.getWest(),this.maxLng=s.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=o.aF(this.minLng)*this.tileSize,this.worldMaxX=o.aF(this.maxLng)*this.tileSize,this.worldMinY=o.aJ(this.maxLat)*this.tileSize,this.worldMaxY=o.aJ(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(s,d){return this.projection.createTileMatrix(this,d,s)}calculateDistanceTileData(s){const d=s.key,f=this._distanceTileDataCache;if(f[d])return f[d];const _=s.canonical,b=1/this.height,S=this.cameraWorldSize,A=S/this.zoomScale(_.z),E=(_.x+Math.pow(2,_.z)*s.wrap)*A,D=_.y*A,M=this.point;M.x*=S/this.worldSize,M.y*=S/this.worldSize;const B=this.angle,z=Math.sin(-B),V=-Math.cos(-B);return f[d]={bearing:[z,V],center:[(M.x-E)*b,(M.y-D)*b],scale:A/o.al*b},f[d]}calculateFogTileMatrix(s){const d=s.key,f=this._fogTileMatrixCache;if(f[d])return f[d];const _=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,s);return o.aB(_,this.worldToFogMatrix,_),f[d]=new Float32Array(_),f[d]}calculateProjMatrix(s,d=!1,f=!1){const _=s.key;let b;if(b=f?this._expandedProjMatrixCache:d?this._alignedProjMatrixCache:this._projMatrixCache,b[_])return b[_];const S=this.calculatePosMatrix(s,this.worldSize);let A;return A=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:f?this.expandedFarZProjMatrix:d?this.alignedProjMatrix:this.projMatrix,o.aB(S,A,S),b[_]=new Float32Array(S),b[_]}calculatePixelsToTileUnitsMatrix(s){const d=s.tileID.key,f=this._pixelsToTileUnitsCache;if(f[d])return f[d];const _=o.cN(s,this);return f[d]=_,f[d]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){const s=1/this.worldSize,d=o.bq([],[s,s,s]);return o.aB(d,d,this.globeMatrix),d}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;const s=this._elevation;this._updateCameraState();const d=o.cf(1,this._center.lat)*this.worldSize,f=this._computeCameraPosition(d),_=this._camera.forward(),b=o.cf(1,this._center.lat);f[2]/=b,_[2]/=b,o.aw(_,_);const S=s.raycast(f,_,s.exaggeration());if(S){const A=o.bH([],f,_,S),E=new o.ae(A[0],A[1],o.cf(A[2],o.a$(A[1]))),D=(E.z+o.ag([E.x-f[0],E.y-f[1],E.z-f[2]*b]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(D),this._centerAltitude=E.toAltitude(),this._center=this.coordinateLocation(E),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(s=!1){if(!this._elevation)return;const d=this._elevation,f=o.cf(1,this._center.lat)*this.worldSize,_=this._computeCameraPosition(f),b=d.getAtPointOrZero(new o.ae(..._)),S=this.pixelsPerMeter/this.worldSize*b,A=this._minimumHeightOverTerrain(),E=_[2]-S;if(E<=A)if(E<0||s){const D=this.locationCoordinate(this._center,this._centerAltitude),M=[_[0],_[1],D.z-_[2]],B=o.ag(M);M[2]-=(A-E)/this._pixelsPerMercatorPixel;const z=o.ag(M);if(z===0)return;o.c5(M,M,B/z*this._pixelsPerMercatorPixel),this._camera.position=[_[0],_[1],D.z*this._pixelsPerMercatorPixel-M[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const s=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||s){const z=this.center;return z.lat=o.aA(z.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!s)&&(z.lng=o.aA(z.lng,this.minLng,this.maxLng)),this.center=z,void(this._constraining=!1)}const d=this._unmodified,{x:f,y:_}=this.point;let b=0,S=f,A=_;const E=this.width/2,D=this.height/2,M=this.worldMinY*this.scale,B=this.worldMaxY*this.scale;if(_-D<M&&(A=M+D),_+D>B&&(A=B-D),B-M<this.height&&(b=Math.max(b,this.height/(B-M)),A=(B+M)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const z=this.worldMinX*this.scale,V=this.worldMaxX*this.scale,Q=this.worldSize/2-(z+V)/2;S=(f+Q+this.worldSize)%this.worldSize-Q,S-E<z&&(S=z+E),S+E>V&&(S=V-E),V-z<this.width&&(b=Math.max(b,this.width/(V-z)),S=(V+z)/2)}S===f&&A===_||this._allowWorldUnderZoom||(this.center=this.unproject(new o.P(S,A))),b&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(b)),this._constrainCamera(),this._unmodified=d,this._constraining=!1}_minZoomForBounds(){let s=Math.max(0,this.scaleZoom(Math.max(0,this.height)/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(s=Math.max(s,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),s}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const s=this.centerOffset,d=this.projection.name==="globe",f=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=o.cf(1,this.center.lat)/o.cf(1,o.d2));const _=o.cO(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,_),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const b=this.projection.zAxisUnit==="meters"?f:1,S=this._camera.getWorldToCamera(this.worldSize,b);let A;const E=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(E[8]=2*-s.x/this.width,E[9]=2*s.y/this.height,this.isOrthographic){let Se=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),qe=Se*this.aspect,Ye=-qe,Qe=-Se;qe-=s.x,Ye-=s.x,Se+=s.y,Qe+=s.y,A=this._camera.getCameraToClipOrthographic(Ye,qe,Qe,Se,this._nearZ,this._farZ),((at,nt,ft,Nt)=>{for(let rt=0;rt<16;rt++)at[rt]=o.ak(nt[rt],ft[rt],Nt)})(A,A,E,o.d0(this.pitch>=Jl?1:this.pitch/Jl))}else A=E;const D=o.cP([],E,S);let M=o.cP([],A,S);if(this.projection.isReprojectedInTileSpace){const Se=this.locationCoordinate(this.center),qe=o.bA([]);o.br(qe,qe,[Se.x*this.worldSize,Se.y*this.worldSize,0]),o.aB(qe,qe,o.cQ(this)),o.br(qe,qe,[-Se.x*this.worldSize,-Se.y*this.worldSize,0]),o.aB(M,M,qe),o.aB(D,D,qe),this.inverseAdjustmentMatrix=o.cR(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=o.cS([],M,[this.worldSize,this.worldSize,this.worldSize/b,1]),this.projMatrix=M,this.invProjMatrix=o.bl(new Float64Array(16),this.projMatrix),d){const Se=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);Se[8]=2*-s.x/this.width,Se[9]=2*s.y/this.height,this.expandedFarZProjMatrix=o.cP([],Se,S)}else this.expandedFarZProjMatrix=this.projMatrix;const B=o.bl([],A);this.frustumCorners=o.cT.fromInvProjectionMatrix(B,this.horizonLineFromTop(),this.height),this.cameraFrustum=o.cB.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!d);const z=new Float32Array(16);o.bA(z),o.cS(z,z,[1,-1,1]),o.cU(z,z,this._pitch),o.bB(z,z,this.angle);const V=o.cd(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=o.bz(V);const Q=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;V[8]=2*-s.x/this.width,V[9]=2*(s.y+Q)/this.height,this.skyboxMatrix=o.aB(z,V,z);const W=this.point,J=W.x,ce=W.y,_e=this.width%2/2,xe=this.height%2/2,fe=Math.cos(this.angle),Fe=Math.sin(this.angle),De=J-Math.round(J)+fe*_e+Fe*xe,Oe=ce-Math.round(ce)+fe*xe+Fe*_e,Ee=new Float64Array(M);if(o.br(Ee,Ee,[De>.5?De-1:De,Oe>.5?Oe-1:Oe,0]),this.alignedProjMatrix=Ee,M=o.bC(),o.cS(M,M,[this.width/2,-this.height/2,1]),o.br(M,M,[1,-1,0]),this.labelPlaneMatrix=M,M=o.bC(),o.cS(M,M,[1,-1,1]),o.br(M,M,[-1,-1,0]),o.cS(M,M,[2/this.width,2/this.height,1]),this.glCoordMatrix=M,this.pixelMatrix=o.aB(new Float64Array(16),this.labelPlaneMatrix,D),this._calcFogMatrices(),this._distanceTileDataCache={},M=o.bl(new Float64Array(16),this.pixelMatrix),!M)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=M,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=o.cV(this);const Se=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=o.af(Se,Se,S),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=M;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const s=this.cameraWorldSizeForFog,d=this.cameraPixelsPerMeter,f=this._camera.position,_=1/this.height/this._pixelsPerMercatorPixel,b=[s,s,d];o.c5(b,b,_),o.c5(f,f,-1),o.cW(f,f,b);const S=o.bC();o.br(S,S,f),o.cS(S,S,b),this.mercatorFogMatrix=S,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(s,d,_)}_computeCameraPosition(s){const d=(s=s||this.pixelsPerMeter)/this.pixelsPerMeter,f=this._camera.forward(),_=this.point,b=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*d-s/this.worldSize*this._centerAltitude;return[_.x/this.worldSize-f[0]*b,_.y/this.worldSize-f[1]*b,s/this.worldSize*this._centerAltitude-f[2]*b]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(s){const d=this._maxCameraBoundsDistance()*Math.cos(this._pitch),f=this._camera.position[2],_=s[2];let b=1;this.projection.wrap&&(this.center=this.center.wrap()),_>0&&(b=Math.min((d-f)/_,1)),this._camera.position=o.bH([],this._camera.position,s,b),this._updateStateFromCamera()}_updateStateFromCamera(){const s=this._camera.position,d=this._camera.forward(),{pitch:f,bearing:_}=this._camera.getPitchBearing(),b=o.cf(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,S=this._mercatorZfromZoom(this._maxZoom)*Math.cos(o.an(this._maxPitch)),A=Math.max((s[2]-b)/Math.cos(f),S),E=this._zoomFromMercatorZ(A);o.bH(s,s,d,A),this._pitch=o.aA(f,o.an(this.minPitch),o.an(this.maxPitch)),this.angle=o.bT(_,-Math.PI,Math.PI),this._setZoom(o.aA(E,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new o.ae(s[0],s[1],s[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(s){return Math.pow(2,s)*this.tileSize}_mercatorZfromZoom(s){return this.cameraToCenterDistance/this._worldSizeFromZoom(s)}_minimumHeightOverTerrain(){const s=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(s)}_zoomFromMercatorZ(s){return this.scaleZoom(this.cameraToCenterDistance/(Math.max(0,s)*this.tileSize))}zoomFromMercatorZAdjusted(s){let d=0,f=o.cL,_=0,b=1/0;for(;f-d>1e-6&&f>d;){const S=d+.5*(f-d),A=this.tileSize*Math.pow(2,S),E=this.getCameraToCenterDistance(this.projection,S,A),D=this.scaleZoom(E/(Math.max(0,s)*this.tileSize)),M=Math.abs(S-D);M<b&&(b=M,_=S),S<D?d=S:f=S}return _}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(o.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(s,d){const f=Math.min(s.x,d.x),_=Math.max(s.x,d.x),b=Math.min(s.y,d.y),S=Math.max(s.y,d.y);if(b<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const A=[new o.P(f,b),new o.P(_,S),new o.P(f,S),new o.P(_,b)],E=this.renderWorldCopies?-3:0,D=this.renderWorldCopies?4:1;for(const M of A){const B=this.pointRayIntersection(M);if(B.t<0)return!0;const z=this.rayIntersectionCoordinate(B);if(z.x<E||z.y<0||z.x>D||z.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+o.cX(this.fovAboveCenter)>88||this.anyCornerOffEdge(new o.P(0,0),new o.P(this.width,this.height))}zoomDeltaToMovement(s,d){const f=o.ag(o.av([],this._camera.position,s)),_=this._zoomFromMercatorZ(f)+d;return f-this._mercatorZfromZoom(_)}getCameraPoint(){if(this.projection.name==="globe"){const s=function([d,f,_],b){const S=[d,f,_,1];o.aC(S,S,b);const A=S[3]=Math.max(S[3],1e-6);return S[0]/=A,S[1]/=A,S[2]/=A,S}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new o.P(s[0],s[1])}{const s=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new o.P(0,s))}}getCameraToCenterDistance(s,d=this.zoom,f=this.worldSize){const _=o.cO(s,d,this.width,this.height,1024),b=s.pixelSpaceConversion(this.center.lat,f,_);let S=.5/Math.tan(.5*this._fov)*this.height*b;return this.isOrthographic&&(S=o.ak(1,S,o.d0(this.pitch>=Jl?1:this.pitch/Jl))),S}getWorldToCameraMatrix(){const s=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&o.aB(s,s,this.globeMatrix),s}getFrustum(s){return o.cB.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,s,this.projection.zAxisUnit==="meters")}}const dl=(m,s)=>{if(s>0&&m.terrain&&o.w("Cutoff is currently disabled on terrain"),s<=0||m.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const d=m.transform,f=Math.max(Math.abs(d._zoom-(m.minCutoffZoom-1)),1),_=d.isLODDisabled(!1)?o.ah(60,45,d.pitch):o.ah(30,15,d.pitch),b=d._farZ-d._nearZ,S=s*d.height,A=((1-(E=_))*d.cameraToCenterDistance+E*(d._farZ+S))*f;var E;return{shouldRenderCutoff:_<1,uniformValues:{u_cutoff_params:[d._nearZ,d._farZ,(A-d._nearZ)/b,(A-S-d._nearZ)/b]}}},uu=2048;class GT{constructor(s,d){this.aabb=s,this.lastCascade=d}}class Gp{add(s,d){const f=this.receivers[s.key];f!==void 0?(f.aabb.min[0]=Math.min(f.aabb.min[0],d.min[0]),f.aabb.min[1]=Math.min(f.aabb.min[1],d.min[1]),f.aabb.min[2]=Math.min(f.aabb.min[2],d.min[2]),f.aabb.max[0]=Math.max(f.aabb.max[0],d.max[0]),f.aabb.max[1]=Math.max(f.aabb.max[1],d.max[1]),f.aabb.max[2]=Math.max(f.aabb.max[2],d.max[2])):this.receivers[s.key]=new GT(d,null)}clear(){this.receivers={}}get(s){return this.receivers[s.key]}computeRequiredCascades(s,d,f){const _=o.d9.fromPoints(s.points);let b=0;for(const S in this.receivers){const A=this.receivers[S];if(!A||!_.intersectsAabb(A.aabb))continue;A.aabb.min=_.closestPoint(A.aabb.min),A.aabb.max=_.closestPoint(A.aabb.max);const E=A.aabb.getCorners();for(let D=0;D<f.length;D++){let M=!0;for(const B of E){const z=[B[0]*d,B[1]*d,B[2]];if(o.af(z,z,f[D].matrix),z[0]<-1||z[0]>1||z[1]<-1||z[1]>1){M=!1;break}}if(A.lastCascade=D,b=Math.max(b,D),M)break}}return b+1}}class Hp{constructor(s){this.painter=s,this._enabled=!1,this._drawShadowAfterLayer=-1,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new Gp,this._depthMode=new si(s.context.gl.LEQUAL,si.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1}destroy(){for(const s of this._cascades)s.texture.destroy(),s.framebuffer.destroy();this._cascades=[]}updateShadowParameters(s,d){const f=this.painter;if(this._enabled=!1,this._drawShadowAfterLayer=-1,this._receivers.clear(),!d||!d.properties)return;const _=d.properties.get("shadow-intensity"),b=d.properties.get("shadow-draw-before-layer");if(!d.shadowsEnabled()||_<=0)return;let S=-1,A=0;for(const ce of f.style.order){const _e=f.style._mergedLayers[ce];_e.hasShadowPass()&&!_e.isHidden(s.zoom)&&(S=A),b&&b===ce&&(this._drawShadowAfterLayer=A>0?A-1:0),A+=1}if(this._enabled=S>=0,!this.enabled)return;this._drawShadowAfterLayer<0&&(this._drawShadowAfterLayer=S);const E=f.context,D=uu,M=uu;if(this._cascades.length===0||uu!==this._cascades[0].texture.size[0]){this._cascades=[];for(let ce=0;ce<2;++ce){const _e=f._shadowMapDebug,xe=E.gl,fe=E.createFramebuffer(D,M,_e?1:0,"texture"),Fe=new o.T(E,{width:D,height:M,data:null},xe.DEPTH_COMPONENT16);if(fe.depthAttachment.set(Fe.texture),_e){const De=new o.T(E,{width:D,height:M,data:null},xe.RGBA8);fe.colorAttachment0.set(De.texture)}this._cascades.push({framebuffer:fe,texture:Fe,matrix:[],far:0,boundingSphereRadius:0,frustum:new o.cB,scale:0})}}this.shadowDirection=ab(d);let B=0;if(s.elevation){const ce=s.elevation,_e=[1e4,-1e4];ce.visibleDemTiles.filter(xe=>xe.dem).forEach(xe=>{const fe=xe.dem.tree;_e[0]=Math.min(_e[0],fe.minimums[0]),_e[1]=Math.max(_e[1],fe.maximums[0])}),_e[0]!==1e4&&(B=(_e[1]-_e[0])*ce.exaggeration())}const z=1.5*s.cameraToCenterDistance,V=3*z,Q=new Float64Array(16);for(let ce=0;ce<this._cascades.length;++ce){const _e=this._cascades[ce];let xe=s.height/50,fe=1;ce===0?fe=z:(xe=z,fe=V);const[Fe,De]=ob(s,this.shadowDirection,xe,fe,uu,B);_e.scale=s.scale,_e.matrix=Fe,_e.boundingSphereRadius=De,o.bl(Q,_e.matrix),_e.frustum=o.cB.fromInvProjectionMatrix(Q,1,0,!0),_e.far=fe}const W=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[W].far,this._cascades[W].far],this._uniformValues.u_shadow_intensity=_,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=.00048828125,this._uniformValues.u_shadow_map_resolution=uu,this._uniformValues.u_shadowmap_0=11,this._uniformValues.u_shadowmap_1=12,this._groundShadowTiles=f.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const J=f.transform.elevation;for(const ce of this._groundShadowTiles){let _e={min:0,max:0};if(J){const xe=J.getMinMaxForTile(ce);xe&&(_e=xe)}this.addShadowReceiver(ce.toUnwrapped(),_e.min,_e.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(s){this._enabled=s}drawShadowPass(s,d){if(!this.enabled)return;const f=this.painter,_=f.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(f.transform.getFrustum(0),f.transform.worldSize,this._cascades),_.viewport.set([0,0,uu,uu]);for(let b=0;b<this._numCascadesToRender;++b){f.currentShadowCascade=b,_.bindFramebuffer.set(this._cascades[b].framebuffer.framebuffer),_.clear({color:o.ao.white,depth:1});for(const S of s.order){const A=s._mergedLayers[S];if(!A.hasShadowPass()||A.isHidden(f.transform.zoom))continue;const E=s.getLayerSourceCache(A),D=E?d[E.id]:void 0;(A.type==="model"||D&&D.length)&&f.renderLayer(f,E,A,D)}}f.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const s=this.painter,d=s.style,f=s.context,_=f.gl,b=d.directionalLight,S=d.ambientLight;if(!b||!S)return;const A=[],E=dl(s,s.longestCutoffRange);E.shouldRenderCutoff&&A.push("RENDER_CUTOFF"),A.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&A.push("NORMAL_OFFSET");const D=hl(d,b,S),M=new si(_.LEQUAL,si.ReadOnly,s.depthRangeFor3D),B=new ji({func:_.EQUAL,mask:255},0,255,_.KEEP,_.KEEP,_.KEEP);for(const z of this._groundShadowTiles){const V=z.toUnwrapped(),Q=s.isTileAffectedByFog(z),W=s.getOrCreateProgram("groundShadow",{defines:A,overrideFog:Q});this.setupShadows(V,W),s.uploadCommonUniforms(f,W,V,null,E);const J=to(s.transform.calculateProjMatrix(V),D);W.draw(s,_.TRIANGLES,M,B,Di.multiply,Ai.disabled,J,"ground_shadow",s.tileExtentBuffer,s.quadTriangleIndexBuffer,s.tileExtentSegments,null,s.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?Di.unblended:Di.disabled}getShadowPassDepthMode(){return this._depthMode}getGroundShadowLayerIndex(){return this._drawShadowAfterLayer}calculateShadowPassMatrixFromTile(s){const d=this.painter.transform,f=d.calculatePosMatrix(s,d.worldSize);return o.aB(f,this._cascades[this.painter.currentShadowCascade].matrix,f),Float32Array.from(f)}calculateShadowPassMatrixFromMatrix(s){const d=o.bz(s);return o.aB(d,this._cascades[this.painter.currentShadowCascade].matrix,s),d}setupShadows(s,d,f){if(!this.enabled)return;const _=this.painter.transform,b=this.painter.context,S=b.gl,A=this._uniformValues,E=new Float64Array(16),D=_.calculatePosMatrix(s,_.worldSize);for(let M=0;M<this._cascades.length;M++)o.aB(E,this._cascades[M].matrix,D),A[M===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(E),b.activeTexture.set(S.TEXTURE0+11+M),this._cascades[M].texture.bindExtraParam(S.LINEAR,S.LINEAR,S.CLAMP_TO_EDGE,S.CLAMP_TO_EDGE,S.GREATER);if(this.useNormalOffset=!!f,this.useNormalOffset){const M=o.d7(s.canonical),B=2/_.tileSize*o.al/uu,z=B*this._cascades[0].boundingSphereRadius,V=B*this._cascades[this._cascades.length-1].boundingSphereRadius,Q=(f==="vector-tile"?1:3)*function(W){const J=o.aA((W-22)/-22,0,1);return .125*(1-J)+4*J}(_.zoom);A.u_shadow_normal_offset=[M,z*Q,V*Q],A.u_shadow_bias=[1e-4,.0012,.012]}else A.u_shadow_bias=[36e-5,.0012,.012];d.setShadowUniformValues(b,A)}setupShadowsFromMatrix(s,d,f=!1){if(!this.enabled)return;const _=this.painter.context,b=_.gl,S=this._uniformValues,A=new Float64Array(16);for(let E=0;E<2;E++)o.aB(A,this._cascades[E].matrix,s),S[E===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(A),_.activeTexture.set(b.TEXTURE0+11+E),this._cascades[E].texture.bindExtraParam(b.LINEAR,b.LINEAR,b.CLAMP_TO_EDGE,b.CLAMP_TO_EDGE,b.GREATER);this.useNormalOffset=f,f?(S.u_shadow_normal_offset=[1,3,3],S.u_shadow_bias=[6e-5,.0012,.012]):S.u_shadow_bias=[36e-5,.0012,.012],d.setShadowUniformValues(_,S)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(s,d,f,_){if(_[2]>=0)return{};const b=function(E,D,M){const B=M/(1<<E.canonical.z);return new o.d9([E.canonical.x*B+E.wrap*M,E.canonical.y*B+E.wrap*M,0],[(E.canonical.x+1)*B+E.wrap*M,(E.canonical.y+1)*B+E.wrap*M,D])}(s,d,f).getCorners(),S=d/-_[2];_[0]<0?(o.d8(b[0],b[0],[_[0]*S,0,0]),o.d8(b[3],b[3],[_[0]*S,0,0])):_[0]>0&&(o.d8(b[1],b[1],[_[0]*S,0,0]),o.d8(b[2],b[2],[_[0]*S,0,0])),_[1]<0?(o.d8(b[0],b[0],[0,_[1]*S,0]),o.d8(b[1],b[1],[0,_[1]*S,0])):_[1]>0&&(o.d8(b[2],b[2],[0,_[1]*S,0]),o.d8(b[3],b[3],[0,_[1]*S,0]));const A={};return A.vertices=b,A.planes=[jf(b[1],b[0],b[4]),jf(b[2],b[1],b[5]),jf(b[3],b[2],b[6]),jf(b[0],b[3],b[7])],A}addShadowReceiver(s,d,f){this._receivers.add(s,o.d9.fromTileIdAndHeight(s,d,f))}getMaxCascadeForTile(s){const d=this._receivers.get(s);return d&&d.lastCascade?d.lastCascade:0}}function jf(m,s,d){const f=o.av([],d,s),_=o.av([],m,s),b=o.bI([],f,_),S=o.ag(b);return S===0?[0,0,1,0]:(o.c5(b,b,1/S),[b[0],b[1],b[2],-o.bJ(b,s)])}function ab(m){const s=m.properties.get("direction"),d=o.d4(s.x,s.y,s.z);d[2]=o.aA(d[2],0,75);const f=o.d6([d[0],d[1],d[2]]);return o.d5(f.x,f.y,f.z)}function hl(m,s,d){const f=s.properties.get("color-use-theme")==="none",_=s.properties.get("color"),b=s.properties.get("intensity"),S=s.properties.get("direction"),A=[S.x,S.y,S.z],E=d.properties.get("color-use-theme")==="none",D=d.properties.get("color"),M=d.properties.get("intensity"),B=Math.max(o.bJ([0,0,1],A),0),z=[0,0,0];o.c5(z,D.toPremultipliedRenderColor(E?null:m.getLut(s.scope)).toArray01Linear().slice(0,3),M);const V=[0,0,0];return o.c5(V,_.toPremultipliedRenderColor(f?null:m.getLut(d.scope)).toArray01Linear().slice(0,3),B*b),o.db([z[0]>0?z[0]/(z[0]+V[0]):0,z[1]>0?z[1]/(z[1]+V[1]):0,z[2]>0?z[2]/(z[2]+V[2]):0])}function ob(m,s,d,f,_,b){const S=m.zoom,A=m.scale,E=m.worldSize,D=1/E,M=m.aspect,B=Math.sqrt(1+M*M)*Math.tan(.5*m.fovX),z=B*B,V=f-d,Q=f+d;let W,J;z>V/Q?(W=f,J=f*B):(W=.5*Q*(1+z),J=.5*Math.sqrt(V*V+2*(f*f+d*d)*z+Q*Q*z*z));const ce=m.projection.pixelsPerMeter(m.center.lat,E),_e=m._camera.getCameraToWorldMercator(),xe=[0,0,-W*D];o.af(xe,xe,_e);let fe=J*D;const Fe=function(Ct){return Ct[0]/=A,Ct[1]/=A,Ct[2]=o.cf(Ct[2],m._center.lat),Ct},De=m._edgeInsets;if(!(De.left===0&&De.top===0&&De.right===0&&De.bottom===0||De.left===De.right&&De.top===De.bottom)){const Ct=m._camera.getWorldToCamera(m.worldSize,m.projection.zAxisUnit==="meters"?ce:1),Rt=m._camera.getCameraToClipPerspective(m._fov,m.width/m.height,d,f);Rt[8]=2*-m.centerOffset.x/m.width,Rt[9]=2*m.centerOffset.y/m.height;const Ut=new Float64Array(16);o.cP(Ut,Rt,Ct);const kt=new Float64Array(16);o.bl(kt,Ut);const Mt=o.cB.fromInvProjectionMatrix(kt,E,S,!0);for(const ei of Mt.points){const Qt=Fe(ei);fe=Math.max(fe,o.c6(o.da([],xe,Qt)))}}fe*=_/(_-1);const Oe=Math.acos(s[2]),Ee=Math.atan2(-s[0],-s[1]),Se=new ih;Se.position=xe,Se.setPitchBearing(Oe,Ee);const qe=Se.getWorldToCamera(E,ce),Ye=fe*E,Qe=Math.min(m._mercatorZfromZoom(17)*E*-2,-2*Ye),at=Se.getCameraToClipOrthographic(-Ye,Ye,-Ye,Ye,Qe,(Ye+b*ce)/s[2]),nt=new Float64Array(16);o.aB(nt,at,qe);const ft=o.d5(Math.floor(1e6*xe[0])/1e6*E,Math.floor(1e6*xe[1])/1e6*E,0),Nt=.5*_,rt=[0,0,0];o.af(rt,ft,nt),o.c5(rt,rt,Nt);const $e=[Math.floor(rt[0]),Math.floor(rt[1]),Math.floor(rt[2])],dt=[0,0,0];o.av(dt,rt,$e),o.c5(dt,dt,-1/Nt);const ot=new Float64Array(16);return o.bA(ot),o.br(ot,ot,dt),o.aB(nt,ot,nt),[nt,Ye]}class Rf extends o.E{constructor(s){super(),this.requestManager=s,this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}loadModel(s,d){return o.dc(this.requestManager.transformRequest(d,o.R.Model).url).then(f=>{if(!f)return;const _=o.dd(f),b=new o.de(s,d,void 0,void 0,_);return b.computeBoundsAndApplyParent(),b}).catch(f=>{if(f&&f.status===404)return null;this.fire(new o.y(new Error(`Could not load model ${s} from ${d}: ${f.message}`)))})}load(s,d,f={forceReload:!1}){this.models[d]||(this.models[d]={});const _=Object.keys(s),b=[],S=[];for(const A of _){const E=s[A];this.hasURLBeenRequested(E)&&!f.forceReload||(this.modelByURL[E]={modelId:A,scope:d},b.push(this.loadModel(A,E)),S.push(A)),this.models[d][A]||(this.models[d][A]={model:null,numReferences:1})}this.numModelsLoading[d]=(this.numModelsLoading[d]||0)+S.length,Promise.allSettled(b).then(A=>{for(let E=0;E<A.length;E++){const{status:D}=A[E];if(D==="rejected")continue;const{value:M}=A[E];this.models[d][S[E]]||(this.models[d][S[E]]={model:null,numReferences:1}),this.models[d][S[E]].model=M}this.numModelsLoading[d]-=S.length,this.fire(new o.z("data",{dataType:"style"}))}).catch(A=>{this.fire(new o.y(new Error(`Could not load models: ${A.message}`)))})}isLoaded(){for(const s in this.numModelsLoading)if(this.numModelsLoading[s]>0)return!1;return!0}hasModel(s,d,f={exactIdMatch:!1}){return!!(f.exactIdMatch?this.getModel(s,d):this.getModelByURL(this.modelUris[d][s]))}getModel(s,d){return this.models[d]||(this.models[d]={}),this.models[d][s]?this.models[d][s].model:void 0}getModelByURL(s){if(!s)return null;const d=this.modelByURL[s];return d?this.models[d.scope][d.modelId].model:null}hasModelBeenAdded(s,d){return this.models[d]&&this.models[d][s]!==void 0}getModelURIs(s){return this.modelUris[s]||{}}addModel(s,d,f){this.models[f]||(this.models[f]={}),this.modelUris[f]||(this.modelUris[f]={});const _=this.requestManager.normalizeModelURL(d);if((this.hasModel(s,f,{exactIdMatch:!0})||this.hasModelBeenAdded(s,f))&&this.modelUris[f][s]===_)this.models[f][s].numReferences++;else if(this.hasURLBeenRequested(_)){const{scope:b,modelId:S}=this.modelByURL[_];this.models[b][S].numReferences++}else this.modelUris[f][s]=_,this.load({[s]:this.modelUris[f][s]},f)}addModelURLs(s,d){this.models[d]||(this.models[d]={}),this.modelUris[d]||(this.modelUris[d]={});const f=this.modelUris[d];for(const _ in s)f[_]=this.requestManager.normalizeModelURL(s[_])}reloadModels(s){this.load(this.modelUris[s],s,{forceReload:!0})}addModelsFromBucket(s,d){this.models[d]||(this.models[d]={}),this.modelUris[d]||(this.modelUris[d]={});const f={};for(const _ of s)this.hasModel(_,d,{exactIdMatch:!0})||this.hasURLBeenRequested(_)?this.models[d][_].numReferences++:this.modelUris[d][_]&&!this.hasURLBeenRequested(_)?f[_]=this.modelUris[d][_]:!this.hasURLBeenRequested(_)&&o.df(_,!1)&&(this.modelUris[d][_]=this.requestManager.normalizeModelURL(_),f[_]=this.modelUris[d][_]);this.load(f,d)}hasURLBeenRequested(s){return this.modelByURL[s]!==void 0}removeModel(s,d,f=!1,_=!1){if(this.models[d]&&this.models[d][s]&&(this.models[d][s].numReferences--,this.models[d][s].numReferences===0||_)){const b=this.modelUris[d][s];f||delete this.modelUris[d][s],delete this.modelByURL[b];const S=this.models[d][s].model;if(!S)return;delete this.models[d][s],S.destroy()}}destroy(){for(const s of Object.keys(this.models))for(const d of Object.keys(this.models[s])){const f=this.models[s][d].model;delete this.models[s][d],f&&f.destroy()}this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}listModels(s){return this.models[s]||(this.models[s]={}),Object.keys(this.models[s])}upload(s,d){this.models[d]||(this.models[d]={});for(const f in this.models[d])this.models[d][f].model&&this.models[d][f].model.upload(s.context)}}const Wp=o.a6.colorTheme,du=new o.a9({data:new o.aa(Wp.data)});function HT(m){if(!m.metadata||!m.metadata.content_area)return;const s=o.o.devicePixelRatio,{left:d,top:f,width:_,height:b}=m.metadata.content_area,S=d*s,A=f*s;return[S,A,S+_*s,A+b*s]}function lb(m){if(m)return m.map(([s,d])=>[s*o.o.devicePixelRatio,d*o.o.devicePixelRatio])}class WT{constructor(s,d,f){this.id=s,this.scope=d,this.sourceCache=f,this.pendingRequests=new Set,this.missingRequests=new Set}addPendingRequest(s){this.missingRequests.has(s.name)||this.pendingRequests.has(s.name)||this.pendingRequests.add(s.name)}hasPendingRequests(){return this.pendingRequests.size>0}resolvePendingRequests(){const s=new Map;if(!this.sourceCache.loaded())return s;const d=this.sourceCache.getVisibleCoordinates();if(d.length===0)return s;const f=this.sourceCache.getSource();if(!(f instanceof Os))return s;const _=d.map(S=>this.sourceCache.getTile(S)),b=f.getImages(_,Array.from(this.pendingRequests));for(const[S,A]of b)s.set(o.I.from({name:S,iconsetId:this.id}),A),this.pendingRequests.delete(S);for(const S of this.pendingRequests)this.missingRequests.add(S);return this.pendingRequests.clear(),s}}class cx{constructor(){o.aY(["_onIndoorUpdate"],this)}onAdd(s){return this._map=s,this._container=he("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._map.style&&this._map.style.indoorManager.on("selector-update",d=>this._onIndoorUpdate(d)),this._container}_createButton(s,d){const f=he("button",s,this._container);return f.type="button",f.addEventListener("click",d),f}_createSeparator(){return he("div","mapboxgl-ctrl-separator",this._container)}_setButtonTitle(s,d){this._map&&(s.setAttribute("aria-label",d),s.textContent=d)}onRemove(){this._container&&this._container.remove(),this._map&&this._map.style&&(this._map.style.indoorManager.off("selector-update",this._onIndoorUpdate),this._map=null)}getDefaultPosition(){return"right"}_onIndoorUpdate(s){if(!s||!s.floors)return this._model=s,void(this._container.style.display="none");const d=this._model;this._model=s,this._container.style.display="inline-block",this._container.style.borderRadius="8px",d&&Array.from(this._container.children).forEach(f=>f.remove()),s.floors.length>0&&(this.addBuildingsToggleButton(),this.addCurrentFloors(s.floors,s.activeFloorsVisible),this._updateBuildingsButtonState())}addBuildingsToggleButton(){const s=this._createButton("mapboxgl-ctrl-buildings-toggle",()=>{const d=this._map;this._model&&d&&d._setIndoorActiveFloorsVisibility(!this._model.activeFloorsVisible)});he("span","mapboxgl-ctrl-icon",s).setAttribute("aria-hidden","true"),s.classList.add("mapboxgl-ctrl-level-button","mapboxgl-ctrl-buildings-toggle"),this._model&&!this._model.activeFloorsVisible&&s.classList.add("mapboxgl-ctrl-level-button-selected"),this._container.append(s),this._createSeparator()}_updateBuildingsButtonState(){const s=this._container.querySelector(".mapboxgl-ctrl-buildings-toggle");s&&this._model&&(this._model.activeFloorsVisible?s.classList.remove("mapboxgl-ctrl-level-button-selected"):s.classList.add("mapboxgl-ctrl-level-button-selected"))}addCurrentFloors(s,d){for(let f=0;f<s.length;f++){const _=s[f],b=this._createButton("mapboxgl-ctrl-level-button",()=>{this._map._selectIndoorFloor(_.id)});this._setButtonTitle(b,_.zIndex.toString()),this._model&&_.id===this._model.selectedFloorId&&d&&b.classList.add("mapboxgl-ctrl-level-button-selected"),this._container.append(b),f<s.length-1&&this._createSeparator()}}}class ZT extends o.E{constructor(s){super(),this._style=s,this._buildings={},this._indoorControl=null,this._activeFloors=new Set,this._activeFloorsVisible=!0,this._indoorState={selectedFloorId:null,lastActiveFloors:null,activeFloorsVisible:!0},o.aY(["_updateUI"],this),this._style.on("style.load",()=>{this._style.isIndoorEnabled()&&(this._style.map.on("load",this._updateUI),this._style.map.on("move",this._updateUI),this._style.map.on("idle",this._updateUI),this._updateUI())})}destroy(){this._buildings={},this._activeFloors=new Set,this._indoorState=null,this._removeIndoorControl()}selectFloor(s){s===this._selectedFloorId&&this._activeFloorsVisible||(this._selectedFloorId=s,this._activeFloorsVisible=!0,this._updateActiveFloors())}setActiveFloorsVisibility(s){this._activeFloorsVisible=s,this._updateActiveFloors(),this._updateIndoorSelector()}setIndoorData(s){for(const[d,f]of Object.entries(s.buildings))if(this._buildings[d])for(const _ of f.floorIds)this._buildings[d].floors[_]||(this._buildings[d].floors[_]=f.floors[_]);else this._buildings[d]=f;for(const d of s.activeFloors)this._activeFloors.add(d);this._updateIndoorSelector()}getIndoorTileOptions(s,d){const f=this._style.getIndoorSourceLayers(s,d);return f&&this._indoorState?{sourceLayers:f,indoorState:this._indoorState}:null}_addIndoorControl(){this._indoorControl||(this._indoorControl=new cx,this._style.map.addControl(this._indoorControl,"right"))}_removeIndoorControl(){this._indoorControl&&(this._indoorControl.onRemove(),this._indoorControl=null)}_updateUI(){const s=this._style.map.transform,d=function(f,_,b,S){let A=null,E=Number.MAX_SAFE_INTEGER;if(S<16)return null;for(const[D,M]of Object.entries(f)){const B=M.center;if(B){const z=_.distanceTo(o.aT.convert(B));z<E&&b.contains(B)&&(E=z,A=D)}}return A}(this._buildings,s.center,s.getBounds(),s.zoom);d!==this._closestBuildingId&&(this._closestBuildingId=d,this._updateIndoorSelector())}_updateIndoorSelector(){const s=this._buildings,d=this._closestBuildingId,f=d&&s?s[d]:void 0;if(!f)return this._removeIndoorControl(),void this.fire(new o.z("selector-update",{selectedFloorId:null,activeFloorsVisible:this._activeFloorsVisible,floors:[]}));this._addIndoorControl();let _=null;for(const S of f.floorIds)if(this._activeFloors&&this._activeFloors.has(S)){_=S;break}const b=Array.from(f.floorIds).map(S=>({id:S,name:f.floors[S].name,zIndex:f.floors[S].zIndex})).sort((S,A)=>A.zIndex-S.zIndex);this.fire(new o.z("selector-update",{selectedFloorId:_,activeFloorsVisible:this._activeFloorsVisible,floors:b}))}_updateActiveFloors(){const s=this._activeFloors;this._activeFloors=new Set,this._indoorState={selectedFloorId:this._selectedFloorId,lastActiveFloors:s,activeFloorsVisible:this._activeFloorsVisible},this._style.updateIndoorDependentLayers()}}const Pc=(m,s)=>Xe(m,s&&s.filter(d=>d.identifier!=="source.canvas")),cb=o.aH(hr,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setLayerProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport","addIconset","removeIconset"]),ub=o.aH(hr,["setCenter","setZoom","setBearing","setPitch"]),kf=new Set(["background","sky","slot","custom"]),ux={version:8,layers:[],sources:{}},hu={duration:300,delay:0};class _o extends o.E{constructor(s,d={}){super(),this.map=s,this.scope=d.scope||"",this.globalId=null,this.fragments=[],this.importDepth=d.importDepth||0,this.importsCache=d.importsCache||new Map,this.resolvedImports=d.resolvedImports||new Set,this.transition=Object.assign({},hu),this._buildingIndex=new su(this),this.crossTileSymbolIndex=new gs,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedIndoor={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._hasAppearances=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._importedAsBasemap=!1,this._changes=d.styleChanges||new Tr,this._hasDataDrivenEmissive=!1,this.indoorManager=new ZT(this),this.dispatcher=d.dispatcher?d.dispatcher:new o.D(o.dh(),this),d.imageManager?this.imageManager=d.imageManager:(this.imageManager=new bi(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.addScope(this.scope),this.glyphManager=d.glyphManager?d.glyphManager:new o.di(s._requestManager,d.localFontFamily?o.dj.all:d.localIdeographFontFamily?o.dj.ideographs:o.dj.none,d.localFontFamily||d.localIdeographFontFamily),d.modelManager?this.modelManager=d.modelManager:(this.modelManager=new Rf(s._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._availableModels={},this._order=[],this._markersNeedUpdate=!1,this.options=d.configOptions?d.configOptions:new Map,this._configDependentLayers=d.configDependentLayers?d.configDependentLayers:new Set,this._indoorDependentLayers=d.indoorDependentLayers?d.indoorDependentLayers:new Set,this._config=d.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:d.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=d.initialConfig,this.dispatcher.broadcast("setReferrer",o.dk());const f=this;this._rtlTextPluginCallback=_o.registerForPluginStateChange(_=>{f.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:_.pluginStatus,pluginURL:_.pluginURL},(b,S)=>{if(o.dl(b),S&&S.every(A=>A))for(const A in f._sourceCaches){const E=f._sourceCaches[A],D=E.getSource().type;D!=="vector"&&D!=="geojson"||E.reload()}})}),this.on("data",_=>{if(_.dataType!=="source"||_.sourceDataType!=="metadata")return;const b=this.getOwnSource(_.sourceId);if(b&&b.vectorLayerIds)for(const S in this._layers){const A=this._layers[S];A.source===b.id&&this._validateLayer(A)}})}load(s){return s?(typeof s=="string"?this.loadURL(s):this.loadJSON(s),this):this}_getGlobalId(s){if(!s)return null;if(typeof s=="string"){if(o.h(s))return s;const d=o.dm(s);if(!d.startsWith("http"))try{return new URL(d,location.href).toString()}catch{return d}return d}return`json://${o.dn(JSON.stringify(s))}`}_diffStyle(s,d,f){this.globalId=this._getGlobalId(s);const _=(b,S)=>{try{S(null,this.setState(b,f))}catch(A){S(A,!1)}};if(typeof s=="string"){const b=this.map._requestManager.normalizeStyleURL(s),S=this.map._requestManager.transformRequest(b,o.R.Style);o.m(S,(A,E)=>{A?this.fire(new o.y(A)):E&&_(E,d)})}else typeof s=="object"&&_(s,d)}loadURL(s,d={}){this.fire(new o.z("dataloading",{dataType:"style"}));const f=typeof d.validate=="boolean"?d.validate:!o.h(s);this.globalId=this._getGlobalId(s),s=this.map._requestManager.normalizeStyleURL(s,d.accessToken),this.resolvedImports.add(s);const _=this.importsCache.get(s);if(_)return this._load(_,f);const b=this.map._requestManager.transformRequest(s,o.R.Style);this._request=o.m(b,(S,A)=>{if(this._request=null,S)this.fire(new o.y(S));else if(A)return this.importsCache.set(s,A),this._load(A,f)})}loadJSON(s,d={}){this.fire(new o.z("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(s),this._request=o.o.frame(()=>{this._request=null,this._load(s,d.validate!==!1)})}loadEmpty(){this.fire(new o.z("dataloading",{dataType:"style"})),this._load(ux,!1)}_loadImports(s,d,f){if(this.importDepth>=4)return o.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const _=[];for(const b of s){const S=this._createFragmentStyle(b),A=new Promise(M=>{S.once("style.import.load",M),S.once("error",M)}).then(()=>this.mergeAll());if(_.push(A),this.resolvedImports.has(b.url)){S.loadEmpty();continue}const E=b.data||this.importsCache.get(b.url);E?(S.loadJSON(E,{validate:d}),this._isInternalStyle(E)&&(S.globalId=null)):b.url?S.loadURL(b.url,{validate:d}):S.loadEmpty();const D={style:S,id:b.id,config:b.config};if(f){const M=this.fragments.findIndex(({id:B})=>B===f);this.fragments=this.fragments.slice(0,M).concat(D).concat(this.fragments.slice(M))}else this.fragments.push(D)}return Promise.allSettled(_)}getImportGlobalIds(s=this,d=new Set){for(const f of s.fragments)f.style.globalId&&d.add(f.style.globalId),this.getImportGlobalIds(f.style,d);return[...d.values()]}_createFragmentStyle(s){const d=this.scope?o.B(s.id,this.scope):s.id;let f;const _=this._initialConfig&&this._initialConfig[d];(s.config||_)&&(f=Object.assign({},s.config,_));const b=new _o(this.map,{scope:d,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:f,configOptions:this.options,colorThemeOverride:s["color-theme"],configDependentLayers:this._configDependentLayers,indoorDependentLayers:this._indoorDependentLayers});return b.setEventedParent(this.map,{style:b}),b}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this._updateLayers(this._indoorDependentLayers),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(s){return this.isRootStyle()&&(s.fragment||!!s.schema&&s.fragment!==!1)}_load(s,d){if(this._isInternalStyle(s)){const b=Object.assign({},ux,{imports:[{id:"basemap",data:s,url:""}]},s.center?{center:s.center}:{},s.bearing?{bearing:s.bearing}:{},s.pitch?{pitch:s.pitch}:{},s.zoom?{zoom:s.zoom}:{},s.light?{light:s.light}:{});return this._importedAsBasemap=!0,void this._load(b,d)}if(this.updateConfig(this._config,s.schema),d&&Pc(this,fs(s)))return;this._loaded=!0,this.stylesheet=o.dp(s);const f=()=>{for(const E in s.sources)this.addSource(E,s.sources[E],{validate:!1,isInitialLoad:!0});if(s.iconsets)for(const E in s.iconsets)this.addIconset(E,s.iconsets[E]);s.sprite?this._loadIconset(s.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),!this.glyphManager.url&&s.glyphs&&this.glyphManager.setURL(s.glyphs);const b=Tc(this.stylesheet.layers);if(this._order=b.map(E=>E.id),this.stylesheet.light&&o.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){const E=this.stylesheet.lights[0];this.light=new it(E.properties,E.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new it(this.stylesheet.light)),this._layers={};for(const E of b){const D=o.du(E,this.scope,this._styleColorTheme.lut,this.options);D.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(D.fqid),D.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(D.fqid),this._hasAppearances=this._hasAppearances||D.getAppearances().length!==0,D.setEventedParent(this,{layer:{id:D.id}}),this._layers[D.id]=D;const M=this.getOwnLayerSourceCache(D),B=!!this.directionalLight&&this.directionalLight.shadowsEnabled();M&&D.canCastShadows()&&B&&(M.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.addModelURLs(this.stylesheet.models);const S=this.stylesheet.terrain;S&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(S,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new o.z("data",{dataType:"style"}));const A=this.isRootStyle();s.imports?this._loadImports(s.imports,d).then(()=>{this._reloadImports(),this.fire(new o.z(A?"style.load":"style.import.load"))}).catch(E=>{this.fire(new o.y(new Error("Failed to load imports",E))),this.fire(new o.z(A?"style.load":"style.import.load"))}):(this._reloadImports(),this.fire(new o.z(A?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];const _=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(_){const b=this._evaluateColorThemeData(_);this._loadColorTheme(b).then(()=>{f()}).catch(S=>{o.w(`Couldn't load color theme from the stylesheet: ${S}`),f()})}else this._styleColorTheme.lut=null,f()}isRootStyle(){return this.importDepth===0}hasAppearances(){return this._hasAppearances||this.fragments.some(s=>s.style.hasAppearances())}mergeAll(){let s,d,f,_,b,S,A,E,D,M;const B={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(z=>{if(z.stylesheet){if(z.light!=null&&(s=z.light),z.stylesheet.lights)for(const V of z.stylesheet.lights)V.type==="ambient"&&z.ambientLight!=null&&(d=z.ambientLight),V.type==="directional"&&z.directionalLight!=null&&(f=z.directionalLight);_=this._prioritizeTerrain(_,z.terrain,z.stylesheet.terrain),z.stylesheet.fog&&z.fog!=null&&(b=z.fog),z.stylesheet.snow&&z.snow!=null&&(S=z.snow),z.stylesheet.rain&&z.rain!=null&&(A=z.rain),z.stylesheet.camera!=null&&(M=z.stylesheet.camera),z.stylesheet.projection!=null&&(E=z.stylesheet.projection),z.stylesheet.transition!=null&&(D=z.stylesheet.transition),B[z.scope]=z._styleColorTheme}}),this.light=s,this.ambientLight=d,this.directionalLight=f,this.fog=b,this.snow=S,this.rain=A,this._styleColorThemeForScope=B,_===null?delete this.terrain:this.terrain=_,this.camera=M||{"camera-projection":"perspective"},this.projection=E||{name:"mercator"},this.transition=Object.assign({},hu,D),this.mergeSources(),this.mergeLayers(),this.mergeIndoor()}forEachFragmentStyle(s){const d=f=>{for(const _ of f.fragments)d(_.style);s(f)};d(this)}_prioritizeTerrain(s,d,f){const _=s&&s.drapeRenderMode===0;return f===null?d&&d.drapeRenderMode===0?d:_?s:null:d!=null&&(!s||_||d&&d.drapeRenderMode===1)?d:s}mergeTerrain(){let s;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(d=>{s=this._prioritizeTerrain(s,d.terrain,d.stylesheet.terrain)}),s===null?delete this.terrain:this.terrain=s}mergeProjection(){let s;this.forEachFragmentStyle(d=>{d.stylesheet.projection!=null&&(s=d.stylesheet.projection)}),this.projection=s||{name:"mercator"}}mergeSources(){const s={},d={},f={};this.forEachFragmentStyle(_=>{for(const b in _._sourceCaches){const S=o.B(b,_.scope);s[S]=_._sourceCaches[b]}for(const b in _._otherSourceCaches){const S=o.B(b,_.scope);d[S]=_._otherSourceCaches[b]}for(const b in _._symbolSourceCaches){const S=o.B(b,_.scope);f[S]=_._symbolSourceCaches[b]}}),this._mergedSourceCaches=s,this._mergedOtherSourceCaches=d,this._mergedSymbolSourceCaches=f}mergeIndoor(){this.forEachFragmentStyle(s=>{if(s.stylesheet&&s.stylesheet.indoor)for(const d of Object.values(s.stylesheet.indoor)){const f=d,_=o.B(f.sourceId,s.scope);this._mergedIndoor[_]=new Set(f.sourceLayers||[])}})}mergeLayers(){const s={},d=[],f={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(S=>{for(const A of S._order){const E=S._layers[A];if(E.type==="slot"){const D=o.dq(A);if(s[D])continue;s[D]=[]}E.slot&&s[E.slot]?s[E.slot].push(E):d.push(E)}}),this._mergedOrder=[];let _=-1;const b=(S=[])=>{for(const A of S)if(A.type==="slot"){const E=o.dq(A.id);s[E]&&b(s[E]),this._mergedSlots.push(E)}else{const E=o.B(A.id,A.scope);this._mergedOrder.push(E),f[E]=A,A.is3D(!!this.terrain)&&(this._has3DLayers=!0,_=this._mergedOrder.length-1),A.type==="circle"&&(this._hasCircleLayers=!0),A.type==="symbol"&&(this._hasSymbolLayers=!0),A.type==="clip"&&(this._clipLayerPresent=!0)}};if(b(d),this._has3DLayers){const S={};for(let A=0;A<this._mergedOrder.length;++A){const E=this._mergedOrder[A];S[E]=A===_?1:A<_?f[E].hasOcclusionOpacityProperties?2:0:4}this._mergedOrder.sort((A,E)=>S[A]-S[E])}this._mergedLayers=f,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged(),this._updateDataDrivenEmissiveStrength()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(s){return this.stylesheet.camera=Object.assign({},this.stylesheet.camera,s),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(s){return s.data?function(d,f,_){const b=Object.assign({},f);for(const A of Object.keys(Wp))b[A]===void 0&&(b[A]=Wp[A].default);const S=new o.a8(du,d,new Map(_));return S.setTransitionOrValue(b,_),S.untransitioned().possiblyEvaluate(new o.ac(0,{worldview:void 0}))}(this.scope,s,this.options).get("data"):null}_loadColorTheme(s){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;const d=this._styleColorTheme.lutLoadingCorrelationID;return new Promise((f,_)=>{const b="data:image/png;base64,";if(!s||s.length===0)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void f();let S=s;S.startsWith(b)||(S=b+S);const A=o.I.from("mapbox-reserved-lut"),E=new Image;E.src=S,E.onerror=()=>{this._styleColorTheme.lutLoading=!1,_(new Error("Failed to load image data"))},E.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==d)return void f();this._styleColorTheme.lutLoading=!1;const{width:D,height:M,data:B}=o.o.getImageData(E);if(M>32)return void _(new Error("The height of the image must be less than or equal to 32 pixels."));if(D!==M*M)return void _(new Error("The width of the image must be equal to the height squared."));this.getImage(A)&&this.removeImage(A),this.addImage(A,{data:new o.q({width:D,height:M},B),pixelRatio:1,sdf:!1,usvg:!1,version:0});const z=this.imageManager.getImage(A,this.scope);z?(this._styleColorTheme.lut={image:z.data,data:s},f()):_(new Error("Missing LUT image."))}})}getLut(s){const d=this._styleColorThemeForScope[s];return d?d.lut:null}setProjection(s){s?this.stylesheet.projection=s:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(s){this._spriteRequest=function(d,f,_){let b,S,A;const E=o.o.devicePixelRatio>1?"@2x":"";let D=o.m(f.transformRequest(f.normalizeSpriteURL(d,E,".json"),o.R.SpriteJSON),(z,V)=>{D=null,A||(A=z,b=V,B())}),M=o.n(f.transformRequest(f.normalizeSpriteURL(d,E,".png"),o.R.SpriteImage),(z,V)=>{M=null,A||(A=z,S=V,B())});function B(){if(A)_(A);else if(b&&S){const z=o.o.getImageData(S),V={};for(const Q in b){const{width:W,height:J,x:ce,y:_e,sdf:xe,pixelRatio:fe,stretchX:Fe,stretchY:De,content:Oe}=b[Q],Ee=new o.q({width:W,height:J});o.q.copy(z,Ee,{x:ce,y:_e},{x:0,y:0},{width:W,height:J},null),V[Q]={data:Ee,pixelRatio:fe!==void 0?fe:1,sdf:xe!==void 0&&xe,stretchX:Fe,stretchY:De,content:Oe,usvg:!1,version:0}}_(null,V)}}return{cancel(){D&&(D.cancel(),D=null),M&&(M.cancel(),M=null)}}}(s,this.map._requestManager,(d,f)=>{if(this._spriteRequest=null,d)this.fire(new o.y(d));else if(f){const _=new Map;for(const b in f)_.set(o.I.from(b),f[b]);this.addImages(_)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new o.z("data",{dataType:"style"}))})}addIconset(s,d){if(d.type==="sprite")return void this._loadSprite(d.url);const f=this.getOwnSourceCache(d.source);if(!f)return void this.fire(new o.y(new Error(`Source "${d.source}" as specified by iconset "${s}" does not exist and cannot be used as an iconset source`)));const _=f.getSource();if(_.type!=="raster-array")return void this.fire(new o.y(new Error(`Source "${d.source}" as specified by iconset "${s}" is not a "raster-array" source and cannot be used as an iconset source`)));_.partial=!1;const b=new WT(s,this.scope,f);this.imageManager.addImageProvider(b,this.scope)}removeIconset(s){this.imageManager.removeImageProvider(s,this.scope)}_loadIconset(s){if(!o.h(s)&&this.map._spriteFormat!=="icon_set"||this.map._spriteFormat==="raster")return void this._loadSprite(s);const d=this.map._spriteFormat==="auto";var f,_;this._spriteRequest=(_=(b,S)=>{if(this._spriteRequest=null,b)d?this._loadSprite(s):this.fire(new o.y(b));else if(S){const A=new Map;for(const E in S)A.set(o.I.from(E),S[E]);this.addImages(A)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new o.z("data",{dataType:"style"}))},o.bu((f=this.map._requestManager).transformRequest(f.normalizeIconsetURL(s),o.R.Iconset),(b,S)=>{if(b)return void _(b);const A={},E=o.dg(new o.bt(S));for(const D of E.icons){const M={version:1,pixelRatio:o.o.devicePixelRatio,content:HT(D),stretchX:D.metadata?lb(D.metadata.stretch_x_areas):void 0,stretchY:D.metadata?lb(D.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:D};A[D.name]=M}_(null,A)}))}_validateLayer(s){const d=this.getOwnSource(s.source);if(!d)return;const f=s.sourceLayer;f&&(d.type==="geojson"||d.vectorLayerIds&&d.vectorLayerIds.indexOf(f)===-1)&&this.fire(new o.y(new Error(`Source layer "${f}" does not exist on source "${d.id}" as specified by style layer "${s.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const s in this._sourceCaches)if(!this._sourceCaches[s].loaded())return!1;if(!this.imageManager.isLoaded()||this.imageManager.hasPatternsInFlight()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(const{style:s}of this.fragments)if(!s.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((s,d)=>{const f=this.fragments[d];return f&&f.style&&(s.data=f.style.serialize()),s})}_serializeSources(){const s={};for(const d in this._sourceCaches){const f=this._sourceCaches[d].getSource();s[f.id]||(s[f.id]=f.serialize())}return s}_serializeLayers(s){const d=[];for(const f of s){const _=this._layers[f];_&&_.type!=="custom"&&d.push(_.serialize())}return d}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition()||this.hasSnowTransition()||this.hasRainTransition())return!0;for(const s in this._sourceCaches)if(this._sourceCaches[s].hasTransition())return!0;for(const s in this._layers)if(this._layers[s].hasTransition())return!0;return!1}_updateDataDrivenEmissiveStrength(){for(const s in this._mergedLayers){const d=this._mergedLayers[s];if(d._transitionablePaint&&d._transitionablePaint._values){const f=d._transitionablePaint._values["line-emissive-strength"];if(f&&f.value&&f.value.isDataDriven())return void(this._hasDataDrivenEmissive=!0)}}this._hasDataDrivenEmissive=!1}hasDataDrivenEmissiveStrength(){return this._hasDataDrivenEmissive}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(s){return s?this.order:this._mergedOrder}isLayerDraped(s){return!!this.terrain&&s.isDraped(this.getLayerSourceCache(s))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(s){const d=this.getOwnLayer(s);if(d)return d;this.fire(new o.y(new Error(`The layer '${s}' does not exist in the map's style.`)))}_checkSource(s){const d=this.getOwnSource(s);if(d)return d;this.fire(new o.y(new Error(`The source '${s}' does not exist in the map's style.`)))}precompilePrograms(s,d){const f=this.map.painter;if(f)for(let _=s.minzoom||0;_<(s.maxzoom||25.5);_++){const b=s.getProgramIds();if(b)for(const S of b){const A=s.getDefaultProgramParams(S,d.zoom,this._styleColorTheme.lut);A&&(f.style=this,this.fog&&(f._fogVisible=!0,A.overrideFog=!0,f.getOrCreateProgram(S,A)),f._fogVisible=!1,A.overrideFog=!1,f.getOrCreateProgram(S,A),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(A.overrideRtt=!0,f.getOrCreateProgram(S,A)))}}}update(s){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(s),this.directionalLight&&this.directionalLight.recalculate(s);const d=this.calculateLightsBrightness();s.brightness=d||0,d!==this._brightness&&(this._brightness=d,this.dispatcher.broadcast("setBrightness",d)),s.worldview!==this._worldview&&(this._worldview=s.worldview,this.dispatcher.broadcast("setWorldview",this._worldview));const f=this._changes.isDirty();let _=!1;if(this._changes.isDirty()){const A=this._changes.getLayerUpdatesByScope();for(const E in A){const{updatedIds:D,removedIds:M}=A[E];(D||M)&&(this._updateWorkerLayers(E,D,M),_=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(s),this.light&&this.light.updateTransitions(s),this.ambientLight&&this.ambientLight.updateTransitions(s),this.directionalLight&&this.directionalLight.updateTransitions(s),this.fog&&this.fog.updateTransitions(s),this.snow&&this.snow.updateTransitions(s),this.rain&&this.rain.updateTransitions(s),this._changes.reset()}const b={};for(const A in this._mergedSourceCaches){const E=this._mergedSourceCaches[A];b[A]=E.used,E.used=!1,E.tileCoverLift=0}for(const A of this._mergedOrder){const E=this._mergedLayers[A];if(E.visibility!=="none"&&E.recalculate(s,this._availableImages),!E.isHidden(s.zoom)){const D=this.getLayerSourceCache(E);D&&(D.used=!0,D.tileCoverLift=Math.max(D.tileCoverLift,E.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.precompilePrograms(E,s)}):this.precompilePrograms(E,s))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&_&&this.mergeLayers();const S=this.imageManager.getPendingImageProviders();for(const A of S)A.sourceCache.used=!0;for(const A in b){const E=this._mergedSourceCaches[A];b[A]!==E.used&&E.getSource().fire(new o.z("data",{sourceDataType:"visibility",dataType:"source",sourceId:E.getSource().id}))}this.light&&this.light.recalculate(s),this.terrain&&this.terrain.recalculate(s),this.fog&&this.fog.recalculate(s),this.snow&&this.snow.recalculate(s),this.rain&&this.rain.recalculate(s),this.z=s.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),f&&this.fire(new o.z("data",{dataType:"style"}))}updateImageProviders(){const s=this.imageManager.getPendingImageProviders();for(const d of s){const f=d.resolvePendingRequests(),_=this.getFragmentStyle(d.scope);_&&_.addImages(f)}}_updateTilesForChangedImages(){const s={};for(const d in this._mergedSourceCaches){const f=this._mergedSourceCaches[d].getSource().scope;s[f]=s[f]||this._changes.getUpdatedImages(f),s[f].length!==0&&this._mergedSourceCaches[d].reloadTilesForDependencies(["icons","patterns"],s[f])}for(const d in s)this._changes.resetUpdatedImages(d)}_updateWorkerLayers(s,d,f){const _=this.getFragmentStyle(s);_&&this.dispatcher.broadcast("updateLayers",{layers:d?_._serializeLayers(d):[],scope:s,removedIds:f||[],options:_.options})}setState(s,d){if(this._checkLoaded(),Pc(this,fs(s)))return!1;(s=o.dp(s)).layers=Tc(s.layers);const f=function(S,A){if(!S)return[{command:hr.setStyle,args:[A]}];let E=[];try{if(!o.by(S.version,A.version))return[{command:hr.setStyle,args:[A]}];if(o.by(S.center,A.center)||E.push({command:hr.setCenter,args:[A.center]}),o.by(S.zoom,A.zoom)||E.push({command:hr.setZoom,args:[A.zoom]}),o.by(S.bearing,A.bearing)||E.push({command:hr.setBearing,args:[A.bearing]}),o.by(S.pitch,A.pitch)||E.push({command:hr.setPitch,args:[A.pitch]}),o.by(S.sprite,A.sprite)||E.push({command:hr.setSprite,args:[A.sprite]}),o.by(S.glyphs,A.glyphs)||E.push({command:hr.setGlyphs,args:[A.glyphs]}),o.by(S.imports,A.imports)||function(V=[],Q=[],W){Q=Q||[];const J=(V=V||[]).map(Al),ce=Q.map(Al),_e=V.reduce(ou,{}),xe=Q.reduce(ou,{}),fe=J.slice();let Fe,De,Oe,Ee;for(Fe=0,De=0;Fe<J.length;Fe++)Oe=J[Fe],xe.hasOwnProperty(Oe)?De++:(W.push({command:hr.removeImport,args:[Oe]}),fe.splice(fe.indexOf(Oe,De),1));for(Fe=0,De=0;Fe<ce.length;Fe++)Oe=ce[ce.length-1-Fe],fe[fe.length-1-Fe]!==Oe&&(_e.hasOwnProperty(Oe)?(W.push({command:hr.removeImport,args:[Oe]}),fe.splice(fe.lastIndexOf(Oe,fe.length-De),1)):De++,Ee=fe[fe.length-Fe],W.push({command:hr.addImport,args:[xe[Oe],Ee]}),fe.splice(fe.length-Fe,0,Oe));for(const Se of Q){const qe=_e[Se.id];qe&&(delete qe.data,o.by(qe,Se)||W.push({command:hr.updateImport,args:[Se.id,Se]}))}}(S.imports,A.imports,E),o.by(S.transition,A.transition)||E.push({command:hr.setTransition,args:[A.transition]}),o.by(S.light,A.light)||E.push({command:hr.setLight,args:[A.light]}),o.by(S.fog,A.fog)||E.push({command:hr.setFog,args:[A.fog]}),o.by(S.snow,A.snow)||E.push({command:hr.setSnow,args:[A.snow]}),o.by(S.rain,A.rain)||E.push({command:hr.setRain,args:[A.rain]}),o.by(S.projection,A.projection)||E.push({command:hr.setProjection,args:[A.projection]}),o.by(S.lights,A.lights)||E.push({command:hr.setLights,args:[A.lights]}),o.by(S.camera,A.camera)||E.push({command:hr.setCamera,args:[A.camera]}),o.by(S.iconsets,A.iconsets)||function(V,Q,W){let J;for(J in Q=Q||{},V=V||{})V.hasOwnProperty(J)&&(Q.hasOwnProperty(J)||W.push({command:hr.removeIconset,args:[J]}));for(J in Q){if(!Q.hasOwnProperty(J))continue;const ce=Q[J];V.hasOwnProperty(J)?o.by(V[J],ce)||(W.push({command:hr.removeIconset,args:[J]}),W.push({command:hr.addIconset,args:[J,ce]})):W.push({command:hr.addIconset,args:[J,ce]})}}(S.iconsets,A.iconsets,E),!o.by(S["color-theme"],A["color-theme"]))return[{command:hr.setStyle,args:[A]}];const D={},M=[];(function(V,Q,W,J){let ce;for(ce in Q=Q||{},V=V||{})V.hasOwnProperty(ce)&&(Q.hasOwnProperty(ce)||Yn(ce,W,J));for(ce in Q){if(!Q.hasOwnProperty(ce))continue;const _e=Q[ce];V.hasOwnProperty(ce)?o.by(V[ce],_e)||(V[ce].type==="geojson"&&_e.type==="geojson"&&Af(V,Q,ce)?W.push({command:hr.setGeoJSONSourceData,args:[ce,_e.data]}):Nf(ce,Q,W,J)):Zl(ce,Q,W)}})(S.sources,A.sources,M,D);const B=[];S.layers&&S.layers.forEach(V=>{V.source&&D[V.source]?E.push({command:hr.removeLayer,args:[V.id]}):B.push(V)});let z=S.terrain;z&&D[z.source]&&(E.push({command:hr.setTerrain,args:[void 0]}),z=void 0),E=E.concat(M),o.by(z,A.terrain)||E.push({command:hr.setTerrain,args:[A.terrain]}),function(V,Q,W){Q=Q||[];const J=(V=V||[]).map(Al),ce=Q.map(Al),_e=V.reduce(ou,{}),xe=Q.reduce(ou,{}),fe=J.slice(),Fe=Object.create(null);let De,Oe,Ee,Se,qe,Ye,Qe;for(De=0,Oe=0;De<J.length;De++)Ee=J[De],xe.hasOwnProperty(Ee)?Oe++:(W.push({command:hr.removeLayer,args:[Ee]}),fe.splice(fe.indexOf(Ee,Oe),1));for(De=0,Oe=0;De<ce.length;De++)Ee=ce[ce.length-1-De],fe[fe.length-1-De]!==Ee&&(_e.hasOwnProperty(Ee)?(W.push({command:hr.removeLayer,args:[Ee]}),fe.splice(fe.lastIndexOf(Ee,fe.length-Oe),1)):Oe++,Ye=fe[fe.length-De],W.push({command:hr.addLayer,args:[xe[Ee],Ye]}),fe.splice(fe.length-De,0,Ee),Fe[Ee]=!0);for(De=0;De<ce.length;De++)if(Ee=ce[De],Se=_e[Ee],qe=xe[Ee],!Fe[Ee]&&!o.by(Se,qe))if(o.by(Se.source,qe.source)&&o.by(Se["source-layer"],qe["source-layer"])&&o.by(Se.type,qe.type)){for(Qe in au(Se.layout,qe.layout,W,Ee,null,hr.setLayoutProperty),au(Se.paint,qe.paint,W,Ee,null,hr.setPaintProperty),o.by(Se.slot,qe.slot)||W.push({command:hr.setSlot,args:[Ee,qe.slot]}),o.by(Se.filter,qe.filter)||W.push({command:hr.setFilter,args:[Ee,qe.filter]}),o.by(Se.minzoom,qe.minzoom)&&o.by(Se.maxzoom,qe.maxzoom)||W.push({command:hr.setLayerZoomRange,args:[Ee,qe.minzoom,qe.maxzoom]}),Se)Se.hasOwnProperty(Qe)&&Qe!=="layout"&&Qe!=="paint"&&Qe!=="filter"&&Qe!=="metadata"&&Qe!=="minzoom"&&Qe!=="maxzoom"&&Qe!=="slot"&&(Qe.indexOf("paint.")===0?au(Se[Qe],qe[Qe],W,Ee,Qe.slice(6),hr.setPaintProperty):o.by(Se[Qe],qe[Qe])||W.push({command:hr.setLayerProperty,args:[Ee,Qe,qe[Qe]]}));for(Qe in qe)qe.hasOwnProperty(Qe)&&!Se.hasOwnProperty(Qe)&&Qe!=="layout"&&Qe!=="paint"&&Qe!=="filter"&&Qe!=="metadata"&&Qe!=="minzoom"&&Qe!=="maxzoom"&&Qe!=="slot"&&(Qe.indexOf("paint.")===0?au(Se[Qe],qe[Qe],W,Ee,Qe.slice(6),hr.setPaintProperty):o.by(Se[Qe],qe[Qe])||W.push({command:hr.setLayerProperty,args:[Ee,Qe,qe[Qe]]}))}else W.push({command:hr.removeLayer,args:[Ee]}),Ye=fe[fe.lastIndexOf(Ee)+1],W.push({command:hr.addLayer,args:[qe,Ye]})}(B,A.layers,E)}catch(D){console.warn("Unable to compute style diff:",D),E=[{command:hr.setStyle,args:[A]}]}return E}(this.serialize(),s).filter(S=>!(S.command in ub));if(f.length===0)return!1;const _=f.filter(S=>!(S.command in cb));if(_.length>0)throw new Error(`Unimplemented: ${_.map(S=>S.command).join(", ")}.`);const b=[];return f.forEach(S=>{b.push(this[S.command](...S.args))}),d&&Promise.all(b).then(d).catch(d),this.stylesheet=s,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(){this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages})}_updateWorkerModels(){this._availableModels=this.modelManager.getModelURIs(this.scope),this.dispatcher.broadcast("setModels",{scope:this.scope,models:this._availableModels})}addImages(s){if(s.size===0)return this;for(const[d,f]of s.entries()){if(this.getImage(d))return this.fire(new o.y(new Error(`An image with the name "${d.name}" already exists.`)));this.imageManager.addImage(d,this.scope,f),this._changes.updateImage(d,this.scope)}return this._updateWorkerImages(),this.fire(new o.z("data",{dataType:"style"})),this}addImage(s,d){return this.getImage(s)?this.fire(new o.y(new Error(`An image with the name "${s.name}" already exists.`))):(this.imageManager.addImage(s,this.scope,d),this._changes.updateImage(s,this.scope),this._updateWorkerImages(),this.fire(new o.z("data",{dataType:"style"})),this)}updateImage(s,d,f=!1){this.imageManager.updateImage(s,this.scope,d),f&&(this._changes.updateImage(s,this.scope),this._updateWorkerImages(),this.fire(new o.z("data",{dataType:"style"})))}getImage(s){return this.imageManager.getImage(s,this.scope)}removeImage(s){return this.getImage(s)?(this.imageManager.removeImage(s,this.scope),this._changes.updateImage(s,this.scope),this._updateWorkerImages(),this.fire(new o.z("data",{dataType:"style"})),this):this.fire(new o.y(new Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}getActualScope(){return this._importedAsBasemap?"basemap":this.scope}addModelURLs(s){return this.modelManager.addModelURLs(s,this.getActualScope()),this._updateWorkerModels(),this.fire(new o.z("data",{dataType:"style"})),this}addModel(s,d,f={}){return this._checkLoaded(),this._validate(Ue,`models.${s}`,d,null,f)||(this.modelManager.addModel(s,d,this.getActualScope()),this.fire(new o.z("data",{dataType:"style"}))),this}hasModel(s){return this.modelManager.hasModel(s,this.getActualScope())}removeModel(s){return this.hasModel(s)?(this.modelManager.removeModel(s,this.getActualScope(),!1,!0),this.fire(new o.z("data",{dataType:"style"})),this):this.fire(new o.y(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.getActualScope())}addSource(s,d,f={}){if(this._checkLoaded(),this.getOwnSource(s)!==void 0)throw new Error(`There is already a source with ID "${s}".`);if(!d.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(d).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(d.type)>=0&&this._validate(ol,`sources.${s}`,d,null,f))return;this.map&&this.map._collectResourceTiming&&(d.collectResourceTiming=!0);const _=xn(s,d,this.dispatcher,this);_.scope=this.scope,_.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(_.id),source:_.serialize(),sourceId:_.id}));const b=S=>{const A=(S?"symbol:":"other:")+_.id,E=o.B(A,this.scope),D=this._sourceCaches[A]=new Ca(E,_,S);(S?this._symbolSourceCaches:this._otherSourceCaches)[_.id]=D,D.onAdd(this.map)};b(!1),d.type!=="vector"&&d.type!=="geojson"||b(!0),_.onAdd&&_.onAdd(this.map),f.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(s){this._checkLoaded();const d=this.getOwnSource(s);if(!d)throw new Error("There is no source with this ID");for(const _ in this._layers)if(this._layers[_].source===s)return this.fire(new o.y(new Error(`Source "${s}" cannot be removed while layer "${_}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===s)return this.fire(new o.y(new Error(`Source "${s}" cannot be removed while terrain is using it.`)));if(this.stylesheet.iconsets){const _=Object.entries(this.stylesheet.iconsets).find(([b,S])=>S.type==="source"&&S.source===s);if(_)return this.fire(new o.y(new Error(`Source "${s}" cannot be removed while iconset "${_[0]}" is using it.`)))}const f=this.getOwnSourceCaches(s);for(const _ of f){const b=o.dq(_.id);delete this._sourceCaches[b],this._changes.discardSourceCacheUpdate(_.id),_.fire(new o.z("data",{sourceDataType:"metadata",dataType:"source",sourceId:_.getSource().id})),_.setEventedParent(null),_.clearTiles()}return delete this._otherSourceCaches[s],delete this._symbolSourceCaches[s],this.mergeSources(),d.setEventedParent(null),d.onRemove&&d.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(s,d){this._checkLoaded(),this.getOwnSource(s).setData(d),this._changes.setDirty()}getOwnSource(s){const d=this.getOwnSourceCache(s);return d&&d.getSource()}getOwnSources(){const s=[];for(const d in this._otherSourceCaches){const f=this.getOwnSourceCache(d);f&&s.push(f.getSource())}return s}areTilesLoaded(){const s=this._mergedSourceCaches;for(const d in s){const f=s[d]._tiles;for(const _ in f){const b=f[_];if(b.state!=="loaded"&&b.state!=="errored")return!1}}return!0}setLights(s){if(this._checkLoaded(),!s)return delete this.ambientLight,void delete this.directionalLight;const d=this._getTransitionParameters();for(const b of s){if(this._validate(wt,"lights",b))return;switch(b.type){case"ambient":if(this.ambientLight){const S=this.ambientLight;S.set(b),S.updateTransitions(d)}else this.ambientLight=new cr(b,Jr(),this.scope,this.options);break;case"directional":if(this.directionalLight){const S=this.directionalLight;S.set(b),S.updateTransitions(d)}else this.directionalLight=new cr(b,Lr(),this.scope,this.options)}}const f=Object.assign(d,{worldview:this.map.getWorldview()}),_=new o.ac(this.z||0,f);this.ambientLight&&this.ambientLight.recalculate(_),this.directionalLight&&this.directionalLight.recalculate(_),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const s=this.directionalLight,d=this.ambientLight;if(!s||!d)return;const f=z=>.2126*(z[0]<=.03928?z[0]/12.92:Math.pow((z[0]+.055)/1.055,2.4))+.7152*(z[1]<=.03928?z[1]/12.92:Math.pow((z[1]+.055)/1.055,2.4))+.0722*(z[2]<=.03928?z[2]/12.92:Math.pow((z[2]+.055)/1.055,2.4)),_=s.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),b=s.properties.get("intensity"),S=s.properties.get("direction"),A=1-o.d4(S.x,S.y,S.z)[2]/90,E=f(_)*b*A,D=d.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),M=d.properties.get("intensity"),B=f(D)*M;return Number(((E+B)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const s=[];return this.directionalLight&&s.push(this.directionalLight.get()),this.ambientLight&&s.push(this.ambientLight.get()),s}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(s){if(s==null||s===""&&this.isRootStyle())return this;if(o.dr(s)){const d=o.ds(s),f=this.fragments.find(({id:b})=>b===d);if(!f)return;const _=o.dq(s);return f.style.getFragmentStyle(_)}{const d=this.fragments.find(({id:f})=>f===s);return d?d.style:void 0}}setFeaturesetSelectors(s){if(!s)return;const d={},f=(_,b="")=>`${_}::${b}`;this._featuresetSelectors={};for(const _ in s){const b=this._featuresetSelectors[_]=[];for(const S of s[_].selectors){if(S.featureNamespace){const E=this.getOwnLayer(S.layer);if(!E){o.w(`Layer is undefined for selector: ${S.layer}`);continue}const D=f(E.source,E.sourceLayer);if(D in d&&d[D]!==S.featureNamespace){o.w(`"featureNamespace ${S.featureNamespace} of featureset ${_}'s selector is not associated to the same source, skip this selector`);continue}d[D]=S.featureNamespace}let A;if(S.properties)for(const E in S.properties){const D=o.U(S.properties[E]);D.result==="success"&&(A=A||{},A[E]=D.value)}b.push({layerId:S.layer,namespace:S.featureNamespace,properties:A,uniqueFeatureID:S._uniqueFeatureID})}}}getFeaturesetDescriptors(s){const d=this.getFragmentStyle(s);if(!d||!d.stylesheet.featuresets)return[];const f=[];for(const _ in d.stylesheet.featuresets)f.push({featuresetId:_,importId:d.scope?d.scope:void 0});return f}getFeaturesetLayers(s,d){const f=this.getFragmentStyle(d),_=f.stylesheet.featuresets;if(!_||!_[s])return this.fire(new o.y(new Error(`The featureset '${s}' does not exist in the map's style and cannot be queried.`))),[];const b=[];for(const S of _[s].selectors){const A=f.getOwnLayer(S.layer);A&&b.push(A)}return b}getConfigProperty(s,d){const f=this.getFragmentStyle(s);if(!f)return null;const _=o.B(d,f.scope),b=f.options.get(_),S=b?b.value||b.default:null;return S?S.serialize():null}isIndoorEnabled(){return Object.keys(this._mergedIndoor).length>0}getIndoorSourceLayers(s,d){const f=o.B(s,d);return this._mergedIndoor[f]}setIndoorData(s,d){this.indoorManager.setIndoorData(d)}updateIndoorDependentLayers(){this._updateLayers(this._indoorDependentLayers),this.map._styleDirty=!0,this.map.triggerRepaint()}setConfigProperty(s,d,f){const _=this.getFragmentStyle(s);if(!_)return;const b=_.stylesheet.schema;if(!b||!b[d])return;const S=o.U(f);if(S.result!=="success")return void Pc(this,S.value);const A=S.value.expression,E=o.B(d,_.scope),D=_.options.get(E);if(!D)return;let M;const{minValue:B,maxValue:z,stepValue:V,type:Q,values:W}=b[d],J=o.U(b[d].default);J.result==="success"&&(M=J.value.expression),M?(this.options.set(E,Object.assign({},D,{value:A,default:M,minValue:B,maxValue:z,stepValue:V,type:Q,values:W})),this.updateConfigDependencies(d)):this.fire(new o.y(new Error(`No schema defined for the config option "${d}" in the "${s}" fragment.`)))}getConfig(s){const d=this.getFragmentStyle(s);if(!d)return null;const f=d.stylesheet.schema;if(!f)return null;const _={};for(const b in f){const S=o.B(b,d.scope),A=d.options.get(S),E=A?A.value||A.default:null;_[b]=E?E.serialize():null}return _}setConfig(s,d){const f=this.getFragmentStyle(s);f&&(f.updateConfig(d,f.stylesheet.schema),this.updateConfigDependencies())}getSchema(s){const d=this.getFragmentStyle(s);return d?d.stylesheet.schema:null}setSchema(s,d){const f=this.getFragmentStyle(s);f&&(f.stylesheet.schema=d,f.updateConfig(f._config,d),this.updateConfigDependencies())}updateConfig(s,d){if(this._config=s,s||d)if(d)for(const f in d){let _,b;const S=o.U(d[f].default);if(S.result==="success"&&(_=S.value.expression),s&&s[f]!==void 0){const z=o.U(s[f]);z.result==="success"&&(b=z.value.expression)}const{minValue:A,maxValue:E,stepValue:D,type:M,values:B}=d[f];if(_){const z=o.B(f,this.scope);this.options.set(z,{default:_,value:b,minValue:A,maxValue:E,stepValue:D,type:M,values:B})}else this.fire(new o.y(new Error(`No schema defined for config option "${f}".`)))}else this.fire(new o.y(new Error("Attempting to set config for a style without schema.")))}_updateLayers(s,d=()=>!0){for(const f of s){const _=this.getLayer(f);_&&d(_)&&(_.possiblyEvaluateVisibility(),this._updateLayer(_),this._changes.setDirty())}}updateConfigDependencies(s){this._updateLayers(this._configDependentLayers,d=>!s||d.expressionDependencies.configDependencies.has(s)),this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle(d=>{const f=d._styleColorTheme.colorThemeOverride?d._styleColorTheme.colorThemeOverride:d._styleColorTheme.colorTheme;if(f){const _=d._evaluateColorThemeData(f);(!d._styleColorTheme.lut&&_!==""||d._styleColorTheme.lut&&_!==d._styleColorTheme.lut.data)&&d.setColorTheme(f)}}),this._changes.setDirty()}addLayer(s,d,f={}){this._checkLoaded();const _=s.id;if(this._layers[_])return void this.fire(new o.y(new Error(`Layer with id "${_}" already exists on this map`)));let b;if(s.type==="custom"){if(Pc(this,o.dt(s)))return;b=o.du(s,this.scope,this._styleColorTheme.lut,this.options)}else{if(typeof s.source=="object"&&(this.addSource(_,s.source),s=o.dp(s),s=Object.assign(s,{source:_})),this._validate(Ze,`layers.${_}`,s,{arrayIndex:-1},f))return;b=o.du(s,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(b),b.setEventedParent(this,{layer:{id:_}})}const S=o.B(b.source,b.scope);b.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(S),b.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(S);let A=this._order.length;if(d){const B=this._order.indexOf(d);if(B===-1)return void this.fire(new o.y(new Error(`Layer with id "${d}" does not exist on this map.`)));b.slot&&b.slot!==this._layers[d].slot?o.w(`Layer with id "${d}" has a different slot. Layers can only be rearranged within the same slot.`):A=B}this._order.splice(A,0,_),this._handleLayerOrderChange(),this._layers[_]=b;const E=this.getOwnLayerSourceCache(b),D=!!this.directionalLight&&this.directionalLight.shadowsEnabled();E&&b.canCastShadows()&&D&&(E.castsShadows=!0);const M=this._changes.getRemovedLayer(b);if(M&&b.source&&E&&b.type!=="custom"){this._changes.discardLayerRemoval(b);const B=o.B(b.source,b.scope);M.type!==b.type?this._changes.updateSourceCache(B,"clear"):(this._changes.updateSourceCache(B,"reload"),E.pause())}this._updateLayer(b),b.onAdd&&b.onAdd(this.map),b.scope=this.scope,this.mergeLayers()}moveLayer(s,d){this._checkLoaded();const f=this._checkLayer(s);if(!f||s===d)return;const _=this._order.indexOf(s);this._order.splice(_,1);let b=this._order.length;if(d){const S=this._order.indexOf(d);if(S===-1)return void this.fire(new o.y(new Error(`Layer with id "${d}" does not exist on this map.`)));f.slot&&f.slot!==this._layers[d].slot?o.w(`Layer with id "${d}" has a different slot. Layers can only be rearranged within the same slot.`):b=S}this._order.splice(b,0,s),this._changes.setDirty(),this._handleLayerOrderChange(),this.mergeLayers()}removeLayer(s){this._checkLoaded();const d=this._checkLayer(s);if(!d)return;d.setEventedParent(null);const f=this._order.indexOf(s);this._order.splice(f,1),delete this._layers[s],this._changes.setDirty(),this._handleLayerOrderChange(),this._configDependentLayers.delete(d.fqid),this._indoorDependentLayers.delete(d.fqid),this._changes.removeLayer(d);const _=this.getOwnLayerSourceCache(d);if(_&&_.castsShadows){let b=!1;for(const S in this._layers)if(this._layers[S].source===d.source&&this._layers[S].canCastShadows()){b=!0;break}_.castsShadows=b}d.onRemove&&d.onRemove(this.map),this.mergeLayers()}getOwnLayer(s){return this._layers[s]}hasLayer(s){return s in this._mergedLayers}hasLayerType(s){for(const d in this._layers)if(this._layers[d].type===s)return!0;return!1}setLayerZoomRange(s,d,f){this._checkLoaded();const _=this._checkLayer(s);_&&(_.minzoom===d&&_.maxzoom===f||(d!=null&&(_.minzoom=d),f!=null&&(_.maxzoom=f),this._updateLayer(_)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(s,d){this._checkLoaded();const f=this._checkLayer(s);f&&f.slot!==d&&(f.slot=d,this._updateLayer(f))}setFilter(s,d,f={}){this._checkLoaded();const _=this._checkLayer(s);if(_&&!o.by(_.filter,d))return d==null?(_.filter=void 0,void this._updateLayer(_)):void(this._validate(te,`layers.${_.id}.filter`,d,{layerType:_.type},f)||(_.filter=o.dp(d),this._updateLayer(_)))}getFilter(s){const d=this._checkLayer(s);if(d)return o.dp(d.filter)}setLayoutProperty(s,d,f,_={}){this._checkLoaded();const b=this._checkLayer(s);if(b&&!o.by(b.getLayoutProperty(d),f)){if(f!=null&&(!_||_.validate!==!1)&&Pc(b,Ne.call(fs,{key:`layers.${s}.layout.${d}`,layerType:b.type,objectKey:d,value:f,styleSpec:o.a6,style:{glyphs:!0,sprite:!0}})))return;b.setLayoutProperty(d,f),b.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(b.fqid),b.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(b.fqid),this._updateLayer(b)}}setLayerProperty(s,d,f,_={}){this._checkLoaded();const b=this._checkLayer(s);b&&(d==="appearances"?(b.setAppearances(f),this._changes.setDirty()):b.isPaintProperty(d)?this.setPaintProperty(s,d,f,_):this.setLayoutProperty(s,d,f,_))}getLayoutProperty(s,d){const f=this._checkLayer(s);if(f)return f.getLayoutProperty(d)}setPaintProperty(s,d,f,_={}){this._checkLoaded();const b=this._checkLayer(s);if(!b||o.by(b.getPaintProperty(d),f)||f!=null&&(!_||_.validate!==!1)&&Pc(b,pe.call(fs,{key:`layers.${s}.paint.${d}`,layerType:b.type,objectKey:d,value:f,styleSpec:o.a6})))return;const S=b.setPaintProperty(d,f);b.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(b.fqid),b.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(b.fqid),S&&this._updateLayer(b),this._changes.updatePaintProperties(b)}getPaintProperty(s,d){const f=this._checkLayer(s);if(f)return f.getPaintProperty(d)}setFeatureState(s,d){if(this._checkLoaded(),"target"in s){if("featuresetId"in s.target){const{featuresetId:E,importId:D}=s.target,M=this.getFragmentStyle(D),B=M.getFeaturesetLayers(E);for(const{source:z,sourceLayer:V}of B)M.setFeatureState({id:s.id,source:z,sourceLayer:V},d)}else if("layerId"in s.target){const{layerId:E}=s.target,D=this.getLayer(E);this.setFeatureState({id:s.id,source:D.source,sourceLayer:D.sourceLayer},d)}return}const f=s.source,_=s.sourceLayer,b=this._checkSource(f);if(!b)return;const S=b.type;if(S==="geojson"&&_)return void this.fire(new o.y(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(S==="vector"&&!_)return void this.fire(new o.y(new Error("The sourceLayer parameter must be provided for vector source types.")));s.id===void 0&&this.fire(new o.y(new Error("The feature id parameter must be provided.")));const A=this.getOwnSourceCaches(f);for(const E of A)E.setFeatureState(_,s.id,d)}removeFeatureState(s,d){if(this._checkLoaded(),"target"in s){if("featuresetId"in s.target){const{featuresetId:E,importId:D}=s.target,M=this.getFragmentStyle(D),B=M.getFeaturesetLayers(E);for(const{source:z,sourceLayer:V}of B)M.removeFeatureState({id:s.id,source:z,sourceLayer:V},d)}else if("layerId"in s.target){const{layerId:E}=s.target,D=this.getLayer(E);this.removeFeatureState({id:s.id,source:D.source,sourceLayer:D.sourceLayer},d)}return}const f=s.source,_=this._checkSource(f);if(!_)return;const b=_.type,S=b==="vector"?s.sourceLayer:void 0;if(b==="vector"&&!S)return void this.fire(new o.y(new Error("The sourceLayer parameter must be provided for vector source types.")));if(d&&typeof s.id!="string"&&typeof s.id!="number")return void this.fire(new o.y(new Error("A feature id is required to remove its specific state property.")));const A=this.getOwnSourceCaches(f);for(const E of A)E.removeFeatureState(S,s.id,d)}getFeatureState(s){if(this._checkLoaded(),"target"in s){let b;if("featuresetId"in s.target){const{featuresetId:S,importId:A}=s.target,E=this.getFragmentStyle(A),D=E.getFeaturesetLayers(S);for(const{source:M,sourceLayer:B}of D){const z=E.getFeatureState({id:s.id,source:M,sourceLayer:B});if(z&&!b)b=z;else if(!o.by(b,z))return void this.fire(new o.y(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in s.target){const{layerId:S}=s.target,A=this.getLayer(S);b=this.getFeatureState({id:s.id,source:A.source,sourceLayer:A.sourceLayer})}return b}const d=s.source,f=s.sourceLayer,_=this._checkSource(d);if(_){if(_.type!=="vector"||f)return s.id===void 0&&this.fire(new o.y(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(d)[0].getFeatureState(f,s.id);this.fire(new o.y(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(s){return this.stylesheet.transition=Object.assign({},this.stylesheet.transition,s),this.transition=this.stylesheet.transition,this}getTransition(){return Object.assign({},this.stylesheet.transition)}serialize(){this._checkLoaded();const s=this.getTerrain(),d=s&&this.terrain&&this.terrain.scope===this.scope?s:this.stylesheet.terrain;return o.dv({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,featuresets:this.stylesheet.featuresets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:d,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,indoor:this.stylesheet.indoor,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},f=>f!==void 0)}_updateFilteredLayers(s){for(const d of Object.values(this._mergedLayers))s(d)&&this._updateLayer(d)}_updateLayer(s){this._changes.updateLayer(s);const d=this.getLayerSourceCache(s),f=o.B(s.source,s.scope),_=this._changes.getUpdatedSourceCaches();s.source&&!_[f]&&d&&d.getSource().type!=="raster"&&(this._changes.updateSourceCache(f,"reload"),d.pause()),s.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(s){const d=A=>this._mergedLayers[A].is3D(!!this.terrain),f=this.order,_={},b=[];for(let A=f.length-1;A>=0;A--){const E=f[A];if(d(E)){_[E]=A;for(const D of s){const M=D[E];if(M)for(const B of M)b.push(B)}}}b.sort((A,E)=>E.intersectionZ-A.intersectionZ);const S=[];for(let A=f.length-1;A>=0;A--){const E=f[A];if(d(E))for(let D=b.length-1;D>=0;D--){const M=b[D].feature;if(M.layer&&_[M.layer.id]<A)break;S.push(M),b.pop()}else for(const D of s){const M=D[E];if(M)for(const B of M)S.push(B.feature)}}return S}queryRasterValue(s,d,f){const _=this.getOwnSource(s);return _?_.type!=="raster-array"?(this.fire(new o.y(new Error('queryRasterValue support only "raster-array" sources.'))),Promise.resolve(null)):_.queryRasterArrayValue(d,f):(this.fire(new o.y(new Error(`Source with id "${s}" does not exist in the style.`))),Promise.resolve(null))}queryRenderedFeatures(s,d,f){let _;d&&!Array.isArray(d)&&d.filter&&(this._validate(te,"queryRenderedFeatures.filter",d.filter,null,d),_=o.b6(d.filter));const b={},S=M=>{if(kf.has(M.type))return;const B=this.getOwnLayerSourceCache(M),z=b[B.id]=b[B.id]||{sourceCache:B,layers:{},has3DLayers:!1};M.is3D(!!this.terrain)&&(z.has3DLayers=!0),z.layers[M.fqid]=z.layers[M.fqid]||{styleLayer:M,targets:[]},z.layers[M.fqid].targets.push({filter:_})};if(d&&d.layers){if(!Array.isArray(d.layers))return this.fire(new o.y(new Error("parameters.layers must be an Array."))),[];for(const M of d.layers){const B=this._layers[M];if(!B)return this.fire(new o.y(new Error(`The layer '${M}' does not exist in the map's style and cannot be queried for features.`))),[];S(B)}}else for(const M in this._layers)S(this._layers[M]);const A=this._queryRenderedFeatures(s,b,f),E=this._flattenAndSortRenderedFeatures(A),D=[];for(const M of E)o.dw(M.layer.id)===this.scope&&D.push(M);return D}queryRenderedFeatureset(s,d,f){let _;d&&!Array.isArray(d)&&d.filter&&(this._validate(te,"queryRenderedFeatures.filter",d.filter,null,d),_=o.b6(d.filter));const b="mock",S=[];if(d&&d.target)S.push(Object.assign({},d,{targetId:b,filter:_}));else{const M=this.getFeaturesetDescriptors();for(const B of M)S.push({targetId:b,filter:_,target:B});for(const{style:B}of this.fragments){const z=B.getFeaturesetDescriptors();for(const V of z)S.push({targetId:b,filter:_,target:V})}}const A=this.queryRenderedTargets(s,S,f),E=[],D=new Set;for(const M of A)for(const B of M.variants[b])Sl(B,M,D)||E.push(new o.dx(M,B));return E}queryRenderedTargets(s,d,f){const _={},b=(A,E,D,M)=>{const B=_[E.id]=_[E.id]||{sourceCache:E,layers:{},has3DLayers:!1};if(B.layers[A.fqid]=B.layers[A.fqid]||{styleLayer:A,targets:[]},A.is3D(!!this.terrain)&&(B.has3DLayers=!0),!M)return D.uniqueFeatureID=!1,void B.layers[A.fqid].targets.push(D);B.layers[A.fqid].targets.push(Object.assign({},D,{namespace:M.namespace,properties:M.properties,uniqueFeatureID:M.uniqueFeatureID}))};for(const A of d)if("featuresetId"in A.target){const{featuresetId:E,importId:D}=A.target,M=this.getFragmentStyle(D);if(!M||!M._featuresetSelectors)continue;const B=M._featuresetSelectors[E];if(!B){this.fire(new o.y(new Error(`The featureset '${E}' does not exist in the map's style and cannot be queried for features.`)));continue}for(const z of B){const V=M.getOwnLayer(z.layerId);V&&!kf.has(V.type)&&b(V,M.getOwnLayerSourceCache(V),A,z)}}else if("layerId"in A.target){const{layerId:E}=A.target,D=this.getLayer(E);if(!D||kf.has(D.type))continue;b(D,this.getLayerSourceCache(D),A)}const S=this._queryRenderedFeatures(s,_,f);return this._flattenAndSortRenderedFeatures(S)}_queryRenderedFeatures(s,d,f){const _=[],b=!!this.map._showQueryGeometry,S=yn.createFromScreenPoints(s,f);for(const A in d){const E=Tl(S,d[A],this._availableImages,f,b,this.getActualScope());Object.keys(E).length&&_.push(E)}if(this.placement)for(const A in d){if(!d[A].sourceCache._onlySymbols)continue;const E=Sf(S.screenGeometry,d[A],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData,this.map.getWorldview());Object.keys(E).length&&_.push(E)}return _}querySourceFeatures(s,d){const f=d&&d.filter;f&&this._validate(te,"querySourceFeatures.filter",f,null,d);let _=[];const b=this.getOwnSourceCaches(s);for(const S of b)_=_.concat(zp(S,d));return _}addSourceType(s,d,f){return _o.getSourceType(s)?f(new Error(`A source type called "${s}" already exists.`)):(_o.setSourceType(s,d),d.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:s,url:d.workerSourceURL},f):f(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(s,d,f={}){this._checkLoaded();const _=this.light.getLight();let b=!1;for(const A in s)if(!o.by(s[A],_[A])){b=!0;break}if(!b)return;const S=this._getTransitionParameters();this.light.setLight(s,d,f),this.light.updateTransitions(S)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=o.o.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&o.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(s,d=1){if(this._checkLoaded(),!s)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),d===0&&delete this.terrain,s===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let f=s;const _=!("source"in s)||s.source==null;if(d===1){if(this.disableElevatedTerrain)return;if("source"in f&&typeof f.source=="object"){const A="terrain-dem-src";this.addSource(A,f.source),f=o.dp(f),f=Object.assign(f,{source:A})}const b=Object.assign({},f),S={};if(this.terrain&&_){b.source=this.terrain.get().source;const A=this.terrain?this.getFragmentStyle(this.terrain.scope):null;A&&(S.style=A.serialize())}if(this._validate(Xa,"terrain",b,S))return}if(!this.terrain||this.terrain.scope!==this.scope&&!_||this.terrain&&d!==this.terrain.drapeRenderMode){if(!f)return;this._createTerrain(f,d),this.fire(new o.z("data",{dataType:"style"}))}else{const b=this.terrain,S=b.get();for(const A of Object.keys(o.a6.terrain))!f.hasOwnProperty(A)&&o.a6.terrain[A].default&&(f[A]=o.a6.terrain[A].default);for(const A in s)if(!o.by(s[A],S[A])){b.set(s,this.options),this.stylesheet.terrain=s;const E=this._getTransitionParameters({duration:0});b.updateTransitions(E),this.fire(new o.z("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(s){const d=this.fog=new Ni(s,this.map.transform,this.scope,this.options);this.stylesheet.fog=d.get();const f=this._getTransitionParameters({duration:0});d.updateTransitions(f)}_createSnow(s){const d=this.snow=new Rn(s,this.map.transform,this.scope,this.options);this.stylesheet.snow=d.get();const f=this._getTransitionParameters({duration:0});d.updateTransitions(f)}_createRain(s){const d=this.rain=new Yr(s,this.map.transform,this.scope,this.options);this.stylesheet.rain=d.get();const f=this._getTransitionParameters({duration:0});d.updateTransitions(f)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(const s of this.map._markers)s._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(s){if(this._checkLoaded(),!s)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const d=this.fog;if(!o.by(d.get(),s)){d.set(s,this.options),this.stylesheet.fog=d.get();const f=this._getTransitionParameters({duration:0});d.updateTransitions(f)}}else this._createFog(s);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(s){if(this._checkLoaded(),!s)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){const d=this.snow;if(!o.by(d.get(),s)){d.set(s,this.options),this.stylesheet.snow=d.get();const f=this._getTransitionParameters({duration:0});d.updateTransitions(f)}}else this._createSnow(s);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(s){if(this._checkLoaded(),!s)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){const d=this.rain;if(!o.by(d.get(),s)){d.set(s,this.options),this.stylesheet.rain=d.get();const f=this._getTransitionParameters({duration:0});d.updateTransitions(f)}}else this._createRain(s);this._markersNeedUpdate=!0}_reloadColorTheme(){const s=()=>{for(const _ in this._layers)this._layers[_].lut=this._styleColorTheme.lut;for(const _ in this._sourceCaches)this._sourceCaches[_].clearTiles()},d=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!d)return this._styleColorTheme.lut=null,void s();const f=this._evaluateColorThemeData(d);this._loadColorTheme(f).then(()=>{this.fire(new o.z("colorthemeset")),s()}).catch(_=>{o.w(`Couldn't set color theme: ${_}`)})}setColorTheme(s){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&o.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=s,this._reloadColorTheme()}setImportColorTheme(s,d){const f=this.getFragmentStyle(s);f&&(f._styleColorTheme.colorThemeOverride=d,f._reloadColorTheme())}_getTransitionParameters(s){return{now:o.o.now(),transition:Object.assign(this.transition,s)}}updateDrapeFirstLayers(){if(!this.terrain)return;const s=[],d=[];for(const f of this._mergedOrder)this.isLayerDraped(this._mergedLayers[f])?s.push(f):d.push(f);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...s),this._drapedFirstOrder.push(...d)}_createTerrain(s,d){const f=this.terrain=new St(s,d,this.scope,this.options,this.map.getWorldview());d===1&&(this.stylesheet.terrain=s),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const _=this._getTransitionParameters({duration:0});f.updateTransitions(_)}_force3DLayerUpdate(){for(const s in this._layers){const d=this._layers[s];d.type==="fill-extrusion"&&this._updateLayer(d)}}_forceSymbolLayerUpdate(){for(const s in this._layers){const d=this._layers[s];d.type==="symbol"&&this._updateLayer(d)}}_validate(s,d,f,_,b={}){if(b&&b.validate===!1)return!1;const S=Object.assign({},this.serialize());return Pc(this,s.call(fs,Object.assign({key:d,style:S,value:f,styleSpec:o.a6},_)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),o.dy.off("pluginStateChange",this._rtlTextPluginCallback);for(const s in this._mergedLayers)this._mergedLayers[s].setEventedParent(null);for(const s in this._mergedSourceCaches)this._mergedSourceCaches[s].clearTiles(),this._mergedSourceCaches[s].setEventedParent(null);this.imageManager.removeScope(this.scope),this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.indoorManager.destroy(),this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.imageManager.destroy(),this.modelManager.setEventedParent(null),this.modelManager.destroy(),this.dispatcher.remove())}clearSource(s){const d=this.getSourceCaches(s);for(const f of d)f.clearTiles()}clearSources(){for(const s in this._mergedSourceCaches)this._mergedSourceCaches[s].clearTiles()}clearLayers(){for(const s in this._mergedLayers){const d=this._mergedLayers[s];d._clear&&d._clear()}}reloadSource(s){const d=this.getSourceCaches(s);for(const f of d)f.resume(),f.reload()}reloadSources(){for(const s of this.getSources())s.reload&&s.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle(s=>{s.modelManager.reloadModels(s.scope)})}updateSources(s){let d;this.directionalLight&&(d=ab(this.directionalLight));const f=new Set,_=new Set;for(const b in this._mergedLayers){const S=this._mergedLayers[b];S.type==="building"&&f.add(S.source),S.hasElevation()&&!_.has(S.source)&&_.add(S.source)}for(const b in this._mergedSourceCaches){const S=this._mergedSourceCaches[b],A=_.has(S._source.id);f.has(S._source.id)&&(S._source.reparseOverscaled=!1),S.update(s,void 0,void 0,d,A)}}_generateCollisionBoxes(){for(const s in this._sourceCaches){const d=this._sourceCaches[s];d.resume(),d.reload()}}_handleLayerOrderChange(){this._requestFullLabelPlacement(),this.fire(new o.z("neworder"))}_requestFullLabelPlacement(){this.pauseablePlacement||(this.pauseablePlacement=new Ks),this.pauseablePlacement.requestFullPlacement()}_setLabelPlacementStale(){this.placement&&this.placement.setStale()}_updatePlacement(s,d,f,_,b){this.pauseablePlacement||(this.pauseablePlacement=new Ks);let S=!1,A=!1;const E={},D={};for(const W of this._mergedOrder){const J=this._mergedLayers[W];if(J.type!=="symbol")continue;const ce=o.B(J.source,J.scope);let _e=E[ce];if(!_e){const fe=this.getLayerSourceCache(J);if(!fe)continue;const Fe=fe.getRenderableIds(!0).map(De=>fe.getTileByID(De));D[ce]=Fe.slice(),_e=E[ce]=Fe.sort((De,Oe)=>Oe.tileID.overscaledZ-De.tileID.overscaledZ||(De.tileID.isLessThan(Oe.tileID)?-1:1))}const xe=this.crossTileSymbolIndex.addLayer(J,_e,s.center.lng,s.projection);S=S||xe}this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder);const M=!!(this.placement&&!s.equals(this.placement.transform)),B=!!(this.placement&&(this.placement.lastReplacementSourceUpdateTime!==0&&!b||this.placement.lastReplacementSourceUpdateTime!==b.updateTime)),z=M||B||S,V=(z||this.pauseablePlacement.isStale())&&f===0,Q=this.pauseablePlacement.isDone()&&!this.placement.stillRecent(o.o.now(),s.zoom)&&f!==0;if((this.pauseablePlacement.isFullPlacementRequested()||!this.pauseablePlacement.placement||V||Q)&&(this.pauseablePlacement=this.pauseablePlacement.startNewPlacement(s,this._mergedOrder,d,f,_,this.placement,this.fog&&s.projection.supportsFog?this.fog.state:null,this._buildingIndex)),this.pauseablePlacement.isDone()?z&&f!==0&&this.pauseablePlacement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,E,D,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(o.o.now()),A=!0),S&&this.pauseablePlacement.setStale()),A||S){this._buildingIndex.onNewFrame(s.zoom);for(let W=0;W<this._mergedOrder.length;W++){const J=this._mergedLayers[this._mergedOrder[W]];if(J.type!=="symbol"||J.visibility==="none")continue;const ce=this.isLayerClipped(J);this.placement.updateLayerOpacities(J,E[o.B(J.source,J.scope)],W,ce?b:null)}}return!this.pauseablePlacement.isDone()||this.placement.isStale()||this.placement.hasTransitions(o.o.now())}_releaseSymbolFadeTiles(){for(const s in this._sourceCaches)this._sourceCaches[s].releaseSymbolFadeTiles()}addImport(s,d){this._checkLoaded();const f=this.stylesheet.imports=this.stylesheet.imports||[];if(f.findIndex(({id:b})=>b===s.id)!==-1)return void this.fire(new o.y(new Error(`Import with id '${s.id}' already exists in the map's style.`)));if(!d)return f.push(s),this._loadImports([s],!0);const _=f.findIndex(({id:b})=>b===d);return _===-1&&this.fire(new o.y(new Error(`Import with id "${d}" does not exist on this map.`))),this.stylesheet.imports=f.slice(0,_).concat(s).concat(f.slice(_)),this._loadImports([s],!0,d)}updateImport(s,d){this._checkLoaded();const f=this.stylesheet.imports||[],_=this.getImportIndex(s);return _===-1?this:typeof d=="string"?(this.setImportUrl(s,d),this):(d.url&&d.url!==f[_].url&&this.setImportUrl(s,d.url),o.by(d.config,f[_].config)||this.setImportConfig(s,d.config,d.data.schema),o.by(d.data,f[_].data)||this.setImportData(s,d.data),this)}moveImport(s,d){this._checkLoaded();let f=this.stylesheet.imports||[];const _=this.getImportIndex(s);if(_===-1)return this;const b=this.getImportIndex(d);if(b===-1)return this;const S=f[_],A=this.fragments[_];return f=f.filter(({id:E})=>E!==s),this.fragments=this.fragments.filter(({id:E})=>E!==s),this.stylesheet.imports=f.slice(0,b).concat(S).concat(f.slice(b)),this.fragments=this.fragments.slice(0,b).concat(A).concat(this.fragments.slice(b)),this.mergeLayers(),this}setImportUrl(s,d){this._checkLoaded();const f=this.stylesheet.imports||[],_=this.getImportIndex(s);if(_===-1)return this;f[_].url=d;const b=this.fragments[_];return b.style=this._createFragmentStyle(f[_]),b.style.on("style.import.load",()=>this.mergeAll()),b.style.loadURL(d),this}setImportData(s,d){this._checkLoaded();const f=this.getImportIndex(s),_=this.stylesheet.imports||[];return f===-1?this:d?(this.fragments[f].style.setState(d),this._reloadImports(),this):(delete _[f].data,this.setImportUrl(s,_[f].url))}setImportConfig(s,d,f){this._checkLoaded();const _=this.getImportIndex(s),b=this.stylesheet.imports||[];if(_===-1)return this;d?b[_].config=d:delete b[_].config;const S=this.fragments[_];f&&S.style.stylesheet&&(S.style.stylesheet.schema=f);const A=S.style.stylesheet&&S.style.stylesheet.schema;return S.config=d,S.style.updateConfig(d,A),this.updateConfigDependencies(),this}removeImport(s){this._checkLoaded();const d=this.stylesheet.imports||[],f=this.getImportIndex(s);f!==-1&&(d.splice(f,1),this.fragments[f].style._remove(),this.fragments.splice(f,1),this._reloadImports())}getImportIndex(s){const d=(this.stylesheet.imports||[]).findIndex(f=>f.id===s);return d===-1&&this.fire(new o.y(new Error(`Import '${s}' does not exist in the map's style and cannot be updated.`))),d}getLayer(s){return this._mergedLayers[s]}getSources(){const s=[];for(const d in this._mergedOtherSourceCaches){const f=this._mergedOtherSourceCaches[d];f&&s.push(f.getSource())}return s}getSource(s,d){const f=this.getSourceCache(s,d);return f&&f.getSource()}getLayerSource(s){const d=this.getLayerSourceCache(s);return d&&d.getSource()}getSourceCache(s,d){const f=o.B(s,d);return this._mergedOtherSourceCaches[f]}getLayerSourceCache(s){const d=o.B(s.source,s.scope);return s.type==="symbol"?this._mergedSymbolSourceCaches[d]:this._mergedOtherSourceCaches[d]}getSourceCaches(s){if(s==null)return Object.values(this._mergedSourceCaches);const d=[];return this._mergedOtherSourceCaches[s]&&d.push(this._mergedOtherSourceCaches[s]),this._mergedSymbolSourceCaches[s]&&d.push(this._mergedSymbolSourceCaches[s]),d}updateSourceCaches(){const s=this._changes.getUpdatedSourceCaches();for(const d in s){const f=s[d];f==="reload"?this.reloadSource(d):f==="clear"&&this.clearSource(d)}}updateLayers(s){const d=this._changes.getUpdatedPaintProperties();for(const f of d){const _=this.getLayer(f);_&&_.updateTransitions(s)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(s){this.stylesheet.glyphs=s,this.glyphManager.setURL(s)}getImages(s,d,f){this.imageManager.getImages(d.images,d.scope,f),this._updateTilesForChangedImages();const _=S=>{if(S){const A=d.images.map(E=>o.I.toString(E));S.setDependencies(d.tileID.key,d.type,A)}},b=o.B(d.source,d.scope);_(this._mergedOtherSourceCaches[b]),_(this._mergedSymbolSourceCaches[b]),d.images.some(S=>S.iconsetId)&&this.fire(new o.z("data",{dataType:"style"}))}rasterizeImages(s,d,f){this.imageManager.rasterizeImages(d,f)}getGlyphs(s,d,f){this.glyphManager.getGlyphs(d.stacks,f)}getResource(s,d,f){return o.dz(d,f)}getOwnSourceCache(s){return this._otherSourceCaches[s]}getOwnLayerSourceCache(s){return s.type==="symbol"?this._symbolSourceCaches[s.source]:this._otherSourceCaches[s.source]}getOwnSourceCaches(s){const d=[];return this._otherSourceCaches[s]&&d.push(this._otherSourceCaches[s]),this._symbolSourceCaches[s]&&d.push(this._symbolSourceCaches[s]),d}_isSourceCacheLoaded(s){const d=this.getOwnSourceCaches(s);return d.length===0?(this.fire(new o.y(new Error(`There is no source with ID '${s}'`))),!1):d.every(f=>f.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(s,d){if(!this._clipLayerPresent&&s.type!=="fill-extrusion"&&s.type!=="building")return!1;const f=s.type==="fill-extrusion"&&(s.sourceLayer==="building"||s.sourceLayer==="procedural_buildings"),_=s.type==="building";if(s.is3D(!!this.terrain)){if(f||_||d&&d.type==="batched-model"||s.type==="model")return!0}else if(s.type==="symbol")return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(s=>{s.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}_o.getSourceType=function(m){return cl[m]},_o.setSourceType=function(m,s){cl[m]=s},_o.registerForPluginStateChange=o.dA;var dx=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#ifdef RENDER_CUTOFF
float cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}
#endif`,hx=`
#ifdef DUAL_SOURCE_BLENDING
layout(location=0,index=0) out vec4 glFragColor;layout(location=0,index=1) out vec4 glFragColorSrc1;
#else
layout(location=0) out vec4 glFragColor;
#endif
#ifdef USE_MRT1
layout(location=1) out vec4 out_Target1;
#endif
highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#ifdef INDICATOR_CUTOUT
uniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;
#endif
vec4 applyCutout(vec4 color,float height) {
#ifdef INDICATOR_CUTOUT
float verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);
#else
return color;
#endif
}
#ifdef DEBUG_WIREFRAME
#define HANDLE_WIREFRAME_DEBUG \\
glFragColor=vec4(0.7,0.0,0.0,0.7); \\
gl_FragDepth=gl_FragCoord.z-0.0001;
#else
#define HANDLE_WIREFRAME_DEBUG
#endif
#ifdef RENDER_CUTOFF
uniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;
#endif
vec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb*col.a,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}`,rh=`
#define EXTENT 8192.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}
#ifdef RENDER_CUTOFF
uniform vec4 u_cutoff_params;out float v_cutoff_opacity;
#endif
const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}
#ifndef HAS_SHADER_STORAGE_BLOCK_material_buffer
#define GET_ATTRIBUTE_float(attrib,matInfo,attrib_id) attrib
#define GET_ATTRIBUTE_vec4(attrib,matInfo,attrib_id) attrib
#define GET_ATTRIBUTE_vec2(attrib,matInfo,attrib_id) attrib
#define DECLARE_MATERIAL_TABLE_INFO
#endif`,nh="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",px=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }
#endif
#ifdef DEPTH_OCCLUSION
uniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;
#ifdef DEPTH_D24
float unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}
#else
highp float unpack_depth_rgba(vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;
#ifdef CLIP_ZERO_TO_ONE
coord.z=-1.0+2.0*coord.z; 
#endif
#ifdef DEPTH_D24
float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);
#else
float depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));
#endif
return coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;
#ifdef DEPTH_D24
highp vec4 depth=vec4(
texture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r
);depth=unpack_depth4(depth);
#else
highp vec4 depth=vec4(
unpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))
);
#endif
return depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;
#ifdef CLIP_ZERO_TO_ONE
coord.z=-1.0+2.0*coord.z; 
#endif
int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));
#endif
res+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;
#ifdef CLIP_ZERO_TO_ONE
coord.z=-1.0+2.0*coord.z; 
#endif
highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}
#else
bool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }
#endif`,Df=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,Vo=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;
#ifdef FLIP_Y
uv.y=1.0-uv.y;
#endif
highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,Zp=`#ifdef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)
);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)
);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}
#endif`,Bt=`#ifdef RASTER_ARRAY
uniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}
#endif
uniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}`,mx=`#ifdef RENDER_SHADOWS
uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}
#endif`,fx=`#ifdef RENDER_SHADOWS
precision highp sampler2DShadow;uniform sampler2DShadow u_shadowmap_0;uniform sampler2DShadow u_shadowmap_1;uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;float shadow_sample(sampler2DShadow shadowmap,highp vec3 pos,highp float bias) {
#ifdef CLIP_ZERO_TO_ONE
highp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z-bias);
#else
highp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z*0.5+0.5-bias);
#endif
return texture(shadowmap,coord);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {light_view_pos0.xyz/=light_view_pos0.w;
#ifdef SHADOWS_SINGLE_CASCADE
vec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);
#else
light_view_pos1.xyz/=light_view_pos1.w;vec4 abs_bounds=abs(vec4(light_view_pos0.xy,light_view_pos1.xy));if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}float occlusion1=shadow_sample(u_shadowmap_1,light_view_pos1.xyz,bias);return clamp(mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth)),0.0,1.0);
#endif
}highp float calculate_shadow_bias(float NDotL) {
#ifdef NORMAL_OFFSET
return 0.5*u_shadow_bias.x;
#else
return 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));
#endif
}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)
{highp vec2 biasUV=vec2(
pos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}
#endif`;const Xp=/#include\s+"([^"]+)"/g,ec=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g,gx=/\b[A-Za-z_][A-Za-z0-9_]*\b/g,od=new Set(["ifdef","ifndef","elif","if","defined"]),ld=new Set;mu(dx,ld),mu(rh,ld),mu(hx,ld);const pu={"_prelude_fog.vertex.glsl":Df,"_prelude_terrain.vertex.glsl":px,"_prelude_shadow.vertex.glsl":mx,"_prelude_material_table.vertex.glsl":`#ifdef HAS_SHADER_STORAGE_BLOCK_material_buffer
#define MATERIAL_TABLE_DEBUG 0
uniform int u_material_offset;uniform int u_vertex_offset;layout(std140,binding=0)readonly buffer material_buffer{uvec4 material_data[];};struct MaterialInfo{uint dataOffset;
#if MATERIAL_TABLE_DEBUG
vec4 colorDebug;
#endif
};uint read_buf_no_offset(uint iDword) {return material_data[iDword/4u][iDword % 4u];}uint read_buf(uint iDword) {iDword+=uint(u_material_offset/4);return read_buf_no_offset(iDword);}float read_buf_float(uint iDword){return uintBitsToFloat(read_buf(iDword));}uint read_buf_uint8(uint iDword,uint iUint8){uint dwordOffset=iDword+(iUint8/4u);uint byteOffset=iUint8 & 3u;uint bitOffset=8u*byteOffset;uint mask=0xffu << bitOffset;uint dwordVal=read_buf(dwordOffset);return (dwordVal & mask) >> bitOffset;}uint read_buf_uint16(uint iDword,uint iUint16){uint dwordOffset=iDword+(iUint16 >> 1u);uint bitOffset=(iUint16 & 1u)*16u;uint mask=0xffffu << bitOffset;uint dwordVal=read_buf(dwordOffset);return (dwordVal & mask) >> bitOffset;}uint nrDwordsForVertexIdEntries(uint nrMaterialLookupEntries) {return nrMaterialLookupEntries;}uint nrDwordsForMaterialIdEntries(uint nrMaterialLookupEntries) {return (nrMaterialLookupEntries*2u+3u)/4u;}uint findRangeBinarySearch(uint vertexId,uint numRanges,uint dwordOffset) {uint left=0u;uint right=numRanges-1u;for (uint i=0u; i < 16u; i++) { 
if (left > right) {break;}uint mid=(left+right)/2u;uint start=read_buf(dwordOffset+mid);uint nextStart=(mid+1u < numRanges) ? read_buf(dwordOffset+mid+1u) : 0xffffffffu;if (vertexId >=start && vertexId < nextStart) {return mid;} else if (vertexId < start) {if (mid==0u) {break;}right=mid-1u;} else {left=mid+1u;}}return 0u; 
}uint readVertexId(uint dwordOffset,uint iMaterialLookupEntry) {return read_buf(dwordOffset+iMaterialLookupEntry);}uint findRange(uint vertexId,uint numRanges,uint dwordOffset) {uint iRange;if(numRanges <=64u){uint vertexBegin;for(iRange=0u; iRange < numRanges;++iRange) {vertexBegin=readVertexId(dwordOffset,iRange);if(vertexBegin > vertexId) {break;}}iRange=iRange==0u? 0u : iRange-1u;} else { 
iRange=findRangeBinarySearch(vertexId,numRanges,dwordOffset);}return iRange;}MaterialInfo read_material_info(uint vertex_id) {MaterialInfo info;
#if MATERIAL_TABLE_DEBUG
const vec4 red=vec4(1.0,0.0,0.0,1.0);const vec4 orange=vec4(1.0,0.5,0.0,1.0);const vec4 yellow=vec4(1.0,1.0,0.0,1.0);const vec4 green=vec4(0.0,1.0,0.0,1.0);const vec4 indigo=vec4(0.294,0.0,0.510,1.0);const vec4 blue=vec4(0.0,0.0,1.0,1.0);const vec4 purple=vec4(0.5,0.0,0.5,1.0);const vec4 pink=vec4(1.0,0.0,1.0,1.0);info.colorDebug=green;
#endif
uint offset=0u;
#if MATERIAL_TABLE_DEBUG
bool keepFinding=true;uint magic=read_buf(offset);if(magic !=0xCAFEBABEu) {info.colorDebug=red;keepFinding=false;return info;}
#endif
offset++;
#if MATERIAL_TABLE_DEBUG
uint nrMaterials=read_buf(offset);uint nrVertices=read_buf(offset+1u);if(keepFinding && vertex_id >=nrVertices) {info.colorDebug=red;keepFinding=false;}
#endif
offset+=2u;uint nrMaterialLookupEntries=read_buf(offset++);uint perMaterialEntrySizeDwords=read_buf(offset++);
#if MATERIAL_TABLE_DEBUG
if(keepFinding && perMaterialEntrySizeDwords !=1u) {info.colorDebug=red;keepFinding=false;}
#endif
uint iMaterialLookup=findRange(vertex_id,nrMaterialLookupEntries,offset);
#if MATERIAL_TABLE_DEBUG
if(keepFinding)
{uint vertexBeginCheck=readVertexId(offset,iMaterialLookup);if(vertexBeginCheck > vertex_id) {info.colorDebug=red;keepFinding=false;}if(iMaterialLookup < nrMaterialLookupEntries-1u) {uint vertexEndCheck=readVertexId(offset,iMaterialLookup+1u);if(vertexEndCheck <=vertex_id) {info.colorDebug=red;keepFinding=false;}}}
#endif
offset+=nrDwordsForVertexIdEntries(nrMaterialLookupEntries);uint materialId=iMaterialLookup;
#if MATERIAL_TABLE_DEBUG
if(keepFinding) {if(materialId >=nrMaterialLookupEntries) {info.colorDebug=red;}}
#endif
info.dataOffset=offset+materialId*perMaterialEntrySizeDwords;return info;}uint get_data_location(const MaterialInfo matInfo,uint attribOffsetBytes)
{uint attribFieldOffsetDwords=attribOffsetBytes/4u;return matInfo.dataOffset+attribFieldOffsetDwords;}vec4 read_material_vec4(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return vec4(read_buf_float(loc),read_buf_float(loc+1u),read_buf_float(loc+2u),read_buf_float(loc+3u));}vec2 read_material_vec2(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return vec2(read_buf_float(loc),read_buf_float(loc+1u));}float read_material_float(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return read_buf_float(loc);}
#define GET_ATTRIBUTE_float(attrib,matInfo,attrib_offset) read_material_float(matInfo,attrib_offset)
#define GET_ATTRIBUTE_vec4(attrib,matInfo,attrib_offset) read_material_vec4(matInfo,attrib_offset)
#define GET_ATTRIBUTE_vec2(attrib,matInfo,attrib_offset) read_material_vec2(matInfo,attrib_offset)
#define DECLARE_MATERIAL_TABLE_INFO MaterialInfo materialInfo=read_material_info(uint(gl_VertexID));
#define DECLARE_MATERIAL_TABLE_INFO_DEBUG(dbgColor) MaterialInfo materialInfo=read_material_info(uint(gl_VertexID)); dbgColor=materialInfo.colorDebug;
#endif`,"_prelude_fog.fragment.glsl":Vo,"_prelude_shadow.fragment.glsl":fx,"_prelude_lighting.glsl":`
#ifdef LIGHTING_3D_MODE
uniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}
#endif`,"_prelude_raster_array.glsl":Zp,"_prelude_raster_particle.glsl":Bt},Mf={};pr("",px),pr(Vo,Df),pr(fx,mx),pr(Zp,""),pr(Bt,"");const db=pr(hx,rh),Of=dx,XT=[`
#if defined(GL_EXT_blend_func_extended) && defined(DUAL_SOURCE_BLENDING)
#extension GL_EXT_blend_func_extended : require
#endif`,"precision mediump float;",Of,db.fragmentSource].join(`
`),hb=["precision highp float;",Of,db.vertexSource].join(`
`);var yx={background:pr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec4 u_color;uniform float u_opacity;uniform mediump float u_emissive_strength;
#ifdef LIGHTING_3D_MODE
in vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef USE_MRT1
out_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_lighting.glsl"
in vec2 a_pos;uniform mat4 u_matrix;uniform mediump float u_emissive_strength;
#ifdef LIGHTING_3D_MODE
uniform mediump vec4 u_color;out vec4 v_color;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:pr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef USE_MRT1
out_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),building:pr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
const float window_depth=0.5;const float ao_radius=0.2;in vec4 v_color;in highp vec3 v_normal;in highp vec3 v_pos;
#ifdef BUILDING_FAUX_FACADE
in lowp float v_faux_facade;in highp float v_faux_facade_ed;in highp vec2 v_faux_facade_window;in highp vec2 v_faux_facade_floor;in highp vec2 v_faux_facade_range;in highp float v_aspect;in highp vec3 v_tbn_0;in highp vec3 v_tbn_1;in highp vec3 v_tbn_2;in highp vec4 v_faux_color_emissive;uniform float u_faux_facade_ao_intensity;
#endif
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
#ifdef FLOOD_LIGHT
in highp float v_flood_radius;in float v_has_flood_light;
#endif
uniform lowp float u_opacity;uniform vec3 u_camera_pos;uniform highp float u_tile_to_meter;uniform float u_facade_emissive_chance;uniform vec3 u_flood_light_color;uniform float u_flood_light_intensity;vec3 linearTosRGB(in vec3 color) {return pow(color,vec3(1./2.2));}
#ifdef BUILDING_FAUX_FACADE
float hash12(in vec2 p) {vec3 p3 =fract(vec3(p.xyx)*0.1031);p3+=dot(p3,p3.yzx+33.33);return fract((p3.x+p3.y)*p3.z);}float min3(in vec3 v) {return min(min(v.x,v.y),v.z);}vec2 get_uv_mask_id(in vec2 q,out float mask,out vec2 id) {vec2 p=q;mask=step(v_faux_facade_range.x,p.y)*step(p.y,v_faux_facade_range.y);p.y=p.y-v_faux_facade_range.x;vec2 uv=modf(p/v_faux_facade_floor,id);vec4 d=(v_faux_facade_floor.xyxy+vec4(-v_faux_facade_window,v_faux_facade_window))*0.5;vec4 edge=d/v_faux_facade_floor.xyxy;vec2 m=step(edge.xy,uv)*step(uv,edge.zw);mask*=m.x*m.y;uv-=vec2(0.5);uv*=vec2(0.5)/(vec2(0.5)-edge.xy);uv+=vec2(0.5);return uv;}float ray_unit_box(in vec3 ray_o,in vec3 ray_d,in vec3 bmin,in vec3 bmax) {vec3 planes=mix(bmin,bmax,step(0.0,ray_d));vec3 t=(planes-ray_o)/ray_d;return min3(t);}float get_emissive(in vec2 id) {if (u_facade_emissive_chance > 0.0) {return (step(hash12(id),u_facade_emissive_chance)+0.05)*v_faux_color_emissive.a;}return 0.0;}vec3 get_shade_info(in vec3 v,in vec3 v_normalized,in vec3 color,in vec2 id,in mat3 tbn,inout vec3 out_normal,inout float out_emissive) {vec3 out_color=color;vec3 abs_v=abs(v_normalized);bool x_major=abs_v.x >=abs_v.y && abs_v.x >=abs_v.z;bool y_major=abs_v.y >=abs_v.x && abs_v.y >=abs_v.z;bool z_major=abs_v.z >=abs_v.x && abs_v.z >=abs_v.y;
#if 0
if (x_major) {out_color=v.x > 0.0 ? vec3(1.0,0.0,0.0) : vec3(0.0,1.0,1.0);} else if (y_major) {out_color=v.y > 0.0 ? vec3(0.0,1.0,0.0) : vec3(1.0,0.0,1.0);} else if (z_major) {out_color=v.z > 0.0 ? vec3(0.0,0.0,1.0) : vec3(1.0,1.0,0.0);}out_emissive=1.0;
#else
if (x_major) {out_normal=sign(v.x)*tbn[0];} else if (y_major) {out_normal=vec3(0.0,0.0,-sign(v.y));} else if (z_major) {out_color=v_faux_color_emissive.rgb;out_emissive=v.z <=0.0 ? get_emissive(id) : out_emissive;}float ao=1.0;if (u_faux_facade_ao_intensity > 0.0) {vec4 ao_range=v_faux_facade_window.xxyy*0.5-vec4(0,ao_radius,0,ao_radius);vec2 ao_range_z=vec2(window_depth*0.5)-vec2(0.0,ao_radius);if (x_major || y_major) {ao*=smoothstep(-ao_range_z.x,-ao_range_z.y,v.z);} else if (z_major) {ao*=smoothstep(-ao_range.x,-ao_range.y,v.x)*(1.0-smoothstep(ao_range.y,ao_range.x,v.x));ao*=smoothstep(-ao_range.z,-ao_range.w,v.y)*(1.0-smoothstep(ao_range.w,ao_range.z,v.y));}ao=mix(1.0,min(1.0,ao+0.25),u_faux_facade_ao_intensity);}out_color*=ao;
#endif
return out_color;}
#endif
vec3 apply_lighting_linear(in vec3 color,in vec3 normal,in float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return color*(ambient_contrib+directional_contrib);}void main() {vec3 normal=normalize(v_normal);vec3 base_color=v_color.rgb;float emissive=v_color.a;
#ifdef BUILDING_FAUX_FACADE
if (v_faux_facade > 0.0) {mat3 tbn=mat3(v_tbn_0,v_tbn_1,v_tbn_2);vec3 v=vec3(v_pos.xy,v_pos.z/u_tile_to_meter)-u_camera_pos;vec3 view_tangent=transpose(tbn)*v;vec2 q=vec2(v_faux_facade_ed,v_pos.z);float mask=0.0;vec2 id=vec2(0.0);vec2 uv=get_uv_mask_id(q,mask,id);uv*=v_faux_facade_window;vec3 bmin=vec3(0.0,0.0,-window_depth);vec3 bmax=bmin+vec3(v_faux_facade_window,window_depth);vec3 ray_o=vec3(uv,0.0);vec3 ray_d=normalize(view_tangent);float t_min=ray_unit_box(ray_o,ray_d,bmin,bmax);vec3 hit=ray_o+t_min*ray_d;vec3 r=vec3(v_faux_facade_window,-window_depth);hit-=r*0.5;vec3 normalized=hit/r;vec3 out_normal=normal;float out_emissive=emissive;vec3 room_color=get_shade_info(hit,normalized,base_color,id,tbn,out_normal,out_emissive);base_color=mix(base_color,room_color,mask);normal=mix(normal,out_normal,mask);emissive=mix(emissive,out_emissive,mask);}
#endif
vec4 color=vec4(base_color,1.0);vec3 xy_flipped_normal=vec3(-normal.xy,normal.z);float shadowed_lighting_factor=0.0;
#ifdef RENDER_SHADOWS
#ifdef RENDER_CUTOFF
shadowed_lighting_factor=shadowed_light_factor_normal_opacity(xy_flipped_normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}
#else
shadowed_lighting_factor=shadowed_light_factor_normal(xy_flipped_normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);
#endif
#else
shadowed_lighting_factor=dot(xy_flipped_normal,u_lighting_directional_dir);
#endif
color.rgb=apply_lighting_linear(color.rgb,xy_flipped_normal,shadowed_lighting_factor);color.rgb=linearTosRGB(color.rgb);
#ifdef FLOOD_LIGHT
float flood_radiance=(1.0-min(v_pos.z/v_flood_radius,1.0))*u_flood_light_intensity*v_has_flood_light;color.rgb=mix(color.rgb,u_flood_light_color,flood_radiance);
#endif
color.rgb=mix(color.rgb,linearTosRGB(base_color.rgb),emissive);
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,v_pos.z));
#endif
color*=u_opacity;
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_pos.z);
#endif
#ifdef FEATURE_CUTOUT
color=apply_feature_cutout(color,gl_FragCoord);
#endif
glFragColor=color; 
#ifdef DEBUG_SHOW_NORMALS
color.rgb=xy_flipped_normal*0.5+vec3(0.5,0.5,0.5);color.a=1.0;glFragColor=color;
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;in vec3 a_normal_3;in vec3 a_centroid_3;in float a_flood_light_wall_radius_1i16;in vec4 a_faux_facade_data;in vec2 a_faux_facade_vertical_range;uniform mat4 u_matrix;uniform mat4 u_normal_matrix;uniform highp float u_tile_to_meter;out vec4 v_color;out vec3 v_normal;out highp vec3 v_pos;
#ifdef BUILDING_FAUX_FACADE
out lowp float v_faux_facade;out highp float v_faux_facade_ed;out highp vec2 v_faux_facade_window;out highp vec2 v_faux_facade_floor;out highp vec2 v_faux_facade_range;out highp float v_aspect;out highp vec3 v_tbn_0;out highp vec3 v_tbn_1;out highp vec3 v_tbn_2;out highp vec4 v_faux_color_emissive;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;
#endif
#ifdef FLOOD_LIGHT
out highp float v_flood_radius;out float v_has_flood_light;
#endif
const float MAX_UINT_16=65535.0;const float MAX_INT_16=32767.0;const float MAX_UINT_8=255.0;const float TWO_POW_8=256.0;const float FLOOD_LIGHT_MAX_RADIUS_METER=2048.0;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#ifdef BUILDING_FAUX_FACADE
mat3 get_tbn(in vec3 normal) {const vec3 bitangent=vec3(0.0,0.0,1.0);vec3 tangent=normalize(vec3(normal.y,-normal.x,0.0));return mat3(tangent,bitangent,normal);}
#endif
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 faux_facade_color_emissive
void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
#pragma mapbox: initialize-attribute-custom highp vec2 faux_facade_color_emissive
#ifdef FLOOD_LIGHT
v_flood_radius=(a_flood_light_wall_radius_1i16/MAX_INT_16*FLOOD_LIGHT_MAX_RADIUS_METER);v_has_flood_light=step(0.0,v_flood_radius);
#endif
vec4 color_emissive=decode_color(part_color_emissive);v_color=vec4(sRGBToLinear(color_emissive.rgb),color_emissive.a);vec3 a_normal_3f=a_normal_3/MAX_INT_16;v_normal=vec3(u_normal_matrix*vec4(a_normal_3f,0.0));float hidden=0.0;float depth_offset=0.0;
#ifdef BUILDING_FAUX_FACADE
v_faux_facade=a_faux_facade_data.x;if (v_faux_facade > 0.0) {v_faux_facade_ed=a_faux_facade_data.x *u_tile_to_meter;float window_x_perc=floor(a_faux_facade_data.y/TWO_POW_8);float window_y_perc=a_faux_facade_data.y-TWO_POW_8*window_x_perc;vec2 window_perc=vec2(window_x_perc,window_y_perc)/MAX_UINT_8;v_faux_facade_floor=(a_faux_facade_data.zw/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_faux_facade_window=window_perc*v_faux_facade_floor;v_faux_facade_range=(a_faux_facade_vertical_range/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_aspect=v_faux_facade_window.x/v_faux_facade_window.y;mat3 tbn=get_tbn(normalize(v_normal));v_tbn_0=tbn[0];v_tbn_1=tbn[1];v_tbn_2=tbn[2];v_faux_color_emissive=decode_color(faux_facade_color_emissive);v_faux_color_emissive.rgb=sRGBToLinear(v_faux_color_emissive.rgb);float height=a_centroid_3.z;depth_offset=min(1000.0,height)*0.0000002;}
#endif
v_pos=a_pos_3f;
#ifdef RENDER_CUTOFF
vec4 ground=u_matrix*vec4(a_centroid_3,1.0);v_cutoff_opacity=cutoff_opacity(u_cutoff_params,ground.z);hidden=float(v_cutoff_opacity==0.0);v_pos.z*=v_cutoff_opacity;
#endif
#ifdef RENDER_SHADOWS
vec3 shadow_pos=v_pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset_model(v_normal);shadow_pos+=offset*shadow_normal_offset_multiplier0();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1.0);
#endif
#ifdef FOG
v_fog_pos=fog_position(v_pos);
#endif
gl_Position=mix(u_matrix*vec4(v_pos,1),AWAY,hidden);gl_Position.z-=depth_offset*gl_Position.w;}`),buildingBloom:pr(`in vec4 v_color_emissive;
#pragma mapbox: define-attribute highp vec4 bloom_attenuation
#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation
float saturate(float val) {return clamp(val,0.0,1.0);}void main() {float emission=v_color_emissive.a;float opacity=1.0;
#ifdef HAS_ATTRIBUTE_a_bloom_attenuation
float distance=length(vec2(1.3*max(0.0,abs(bloom_attenuation.x)-bloom_attenuation.z),bloom_attenuation.y));distance+= mix(0.5,0.0,clamp(emission-1.0,0.0,1.0));opacity*=saturate(1.0-distance*distance);
#endif
#ifdef RENDER_CUTOFF
opacity*=v_cutoff_opacity;
#endif
glFragColor=vec4(v_color_emissive.rgb,1.0)*opacity;}`,`in vec3 a_pos_3f;
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
#pragma mapbox: define-attribute highp vec4 bloom_attenuation
out vec4 v_color_emissive;uniform mat4 u_matrix;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation
#ifdef HAS_ATTRIBUTE_a_part_color_emissive
vec4 color_emissive=decode_color(part_color_emissive);float part_emissive=color_emissive.a*5.0;v_color_emissive=vec4(sRGBToLinear(color_emissive.rgb),part_emissive);
#else
v_color_emissive=vec4(1.0);
#endif
gl_Position=u_matrix*vec4(a_pos_3f,1.0);
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),buildingDepth:pr(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,"in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;void main() {gl_Position=u_matrix*vec4(a_pos_3f,1.0);v_depth=gl_Position.z/gl_Position.w;}"),circle:pr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? 
smoothstep(0.0,-antialiased_blur,1.0-extrude_length) : 
smoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
glFragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
#ifdef ELEVATED_ROADS
in float a_circle_z_offset;
#endif
out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
#ifdef ELEVATED_ROADS
world_center.z+=a_circle_z_offset+ELEVATION_BIAS;
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:pr("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:pr(`#include "_prelude_fog.fragment.glsl"
uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:pr(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(0.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,"in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:pr("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`#include "_prelude_terrain.vertex.glsl"
in vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform float u_zoom_transition;
#endif
out float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec3 proj_pos=a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation);
#ifdef PROJECTION_GLOBE_VIEW
#ifndef PROJECTED_POS_ON_VIEWPORT
vec3 globe_pos=proj_pos;vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,a_anchor_pos,u_tile_id,u_merc_center);proj_pos=mix_globe_mercator(globe_pos,mercator_pos,u_zoom_transition);
#endif
#endif
vec4 projectedPoint=u_matrix*vec4(proj_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:pr("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}",`in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:pr("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",`#include "_prelude_terrain.vertex.glsl"
in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;
#endif
out vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),elevatedStructuresDepth:pr(`void main() {
#ifndef DEPTH_TEXTURE
glFragColor=vec4(0.);
#endif
}`,"in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform float u_depth_bias;void main() {gl_Position=u_matrix*vec4(a_pos,a_height,1);gl_Position.z=gl_Position.z+u_depth_bias;}"),elevatedStructuresDepthReconstruct:pr(`#ifdef DEPTH_RECONSTRUCTION
in float v_height;
#endif
void main() {
#ifdef DEPTH_RECONSTRUCTION
if (v_height >=0.0)
discard;
#else
#ifdef FEATURE_CUTOUT
apply_feature_cutout(vec4(0.0,0.0,0.0,1.0),gl_FragCoord);
#endif
#endif
glFragColor=vec4(1.0,0.0,0.0,1.0);}`,`in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform vec3 u_camera_pos;uniform highp float u_depth_bias;uniform lowp float u_height_scale;uniform lowp float u_reset_depth;
#ifdef DEPTH_RECONSTRUCTION
out float v_height;
#endif
void main() {vec3 vpos=vec3(a_pos,a_height*u_height_scale);
#ifdef DEPTH_RECONSTRUCTION
if (u_camera_pos.z > vpos.z) {vpos-=(u_camera_pos-vpos)*(vpos.z/(u_camera_pos.z-vpos.z));}v_height=a_height;
#endif
gl_Position=u_matrix*vec4(vpos,1);gl_Position.z=u_reset_depth==1.0 ? gl_Position.w : gl_Position.z+u_depth_bias;}`),elevatedStructures:pr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in vec3 v_normal;in float v_height;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;
#endif
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}vec3 compute_view_dependent_emissive_color(float ndotl,float emissive_strength,vec3 color)
{color=sRGBToLinear(color);color=color*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);color=linearTosRGB(color.rgb);return color;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
vec3 color=structure_color.xyz;
#ifdef LIGHTING_3D_MODE
vec3 normal=normalize(v_normal);vec3 transformed_normal=vec3(-normal.xy,normal.z);float ndotl=calculate_NdotL(transformed_normal);float emissive_strength=u_emissive_strength;emissive_strength=0.0;vec3 emissive_color=compute_view_dependent_emissive_color(ndotl,emissive_strength,color.xyz);
#ifdef RENDER_SHADOWS
float shadowed_lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,transformed_normal,shadowed_lighting_factor);
#else
color=apply_lighting(color,transformed_normal);
#endif
color=mix(color,emissive_color,emissive_strength);if (v_height < 0.0) {float penetration=max(v_height+7.5,0.0);float occlusion=1.0-1.0/PI*acos(1.0-penetration/4.0);color=color*(1.0-pow(occlusion,2.0)*0.3);}
#endif
#ifdef FOG
color=fog_apply(color,v_fog_pos);
#endif
vec4 out_color=vec4(color,1.0);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_height);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;in float a_height;in vec3 a_pos_normal_3;uniform mat4 u_matrix;out vec3 v_normal;out float v_height;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;
#endif
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
v_normal=a_pos_normal_3/16384.0;v_height=a_height;vec3 pos=vec3(a_pos,a_height);gl_Position=u_matrix*vec4(pos,1);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(-v_normal.xy,v_normal.z));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fill:pr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=opacity;
#ifdef INDICATOR_CUTOUT
if (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef USE_MRT1
out_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=z_offset;
#endif
}`),fillOutline:pr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef USE_MRT1
out_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef FLIP_Y
v_pos=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;
#else
v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#endif
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:pr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
uniform float u_emissive_strength;
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
in highp vec2 v_pos;in highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef USE_MRT1
out_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;out highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef FLIP_Y
v_pos_world=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;
#else
v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#endif
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:pr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef USE_MRT1
out_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:pr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in vec4 v_flat;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
uniform lowp float u_opacity;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec2 v_ao;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
in vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
in highp vec3 v_normal;
#endif
uniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
in float v_flood_radius;in float v_has_floodlight;
#endif
in float v_height;
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float emissive_strength
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
vec3 normal=normalize(v_normal);
#endif
float z;vec4 color=v_color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);
#ifdef LIGHTING_3D_MODE
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#else
color=mix(v_color,v_roof_color,z);
#endif
#endif
float h=max(0.0,v_height);float ao_shade=1.0;
#ifdef FAUX_AO
float intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
color.rgb*=mix(ao_shade,1.0,v_has_floodlight);
#else
color.rgb*=ao_shade;
#endif
#else
color.rgb*=ao_shade;
#endif
#endif
#ifdef LIGHTING_3D_MODE
float flood_radiance=0.0;
#ifdef FLOOD_LIGHT
flood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;
#endif
#ifdef RENDER_SHADOWS
#ifdef FLOOD_LIGHT
float ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);
#else
float shadowed_lighting_factor;
#ifdef RENDER_CUTOFF
shadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}
#else
shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);
#endif
color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#endif
#else
color.rgb=apply_lighting(color.rgb,normal);
#ifdef FLOOD_LIGHT
color.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);
#endif
#endif
color.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,h);
#endif
#ifdef FEATURE_CUTOUT
color=apply_feature_cutout(color,gl_FragCoord);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_material_table.vertex.glsl"
uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
uniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
out vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
out highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec2 v_ao;
#endif
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
out float v_flood_radius;out float v_has_floodlight;
#endif
out float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define highp float flood_light_wall_radius
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp float emissive_strength
void main() {DECLARE_MATERIAL_TABLE_INFO
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize highp float flood_light_wall_radius
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp float emissive_strength
base*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
v_normal=normal;
#endif
base=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float cutoff=1.0;vec3 scaled_pos=pos;
#ifdef RENDER_CUTOFF
vec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);
#ifdef CLIP_ZERO_TO_ONE
cutoff=cutoff_opacity(u_cutoff_params,ground.z*2.0-ground.w);
#else
cutoff=cutoff_opacity(u_cutoff_params,ground.z);
#endif
if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifndef LIGHTING_3D_MODE
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#endif
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
float is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;
#endif
v_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);
#else
v_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionDepth:pr(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_material_table.vertex.glsl"
uniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp vec4 color
out highp float v_depth;void main() {DECLARE_MATERIAL_TABLE_INFO
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp vec4 color
base*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}`),fillExtrusionPattern:pr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
in vec3 v_normal;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
in highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,height);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_material_table.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
out highp vec2 v_pos;out vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
out vec3 v_normal;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
#pragma mapbox: define highp float line_width
void main() {DECLARE_MATERIAL_TABLE_INFO
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
#pragma mapbox: initialize highp float line_width
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_normal=normal;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),groundShadow:pr(`#include "_prelude_shadow.fragment.glsl"
precision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#ifdef FOG
in float v_fog_opacity;
#endif
void main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);
#ifdef RENDER_CUTOFF
shadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));
#endif
#ifdef FOG
shadow=mix(shadow,vec3(1.0),v_fog_opacity);
#endif
#ifdef INDICATOR_CUTOUT
shadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);
#endif
glFragColor=vec4(shadow,1.0);}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#ifdef FOG
out float v_fog_opacity;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);
#ifdef FOG
v_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);
#endif
}`),fillExtrusionGroundEffect:pr(`uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;
#ifdef SDF_SUBPASS
in highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}
#ifdef FOG
in highp float v_fog;
#endif
#endif
void main() {
#ifdef CLEAR_SUBPASS
vec4 color=vec4(1.0);
#ifdef CLEAR_FROM_TEXTURE
color=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));
#endif
glFragColor=color;
#else
#ifdef SDF_SUBPASS
highp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;
#ifdef FOG
fog=v_fog;
#endif
#ifdef RENDER_CUTOFF
fog*=v_cutoff_opacity;
#endif
glFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));
#else
#ifdef USE_MRT1
out_Target1=vec4(1.0-texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size)).a,0.0,0.0,0.0);
#else
vec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);
#ifdef OVERDRAW_INSPECTOR
color=vec4(1.0);
#endif
glFragColor=color;
#endif
#endif
HANDLE_WIREFRAME_DEBUG;
#endif
}`,`#include "_prelude_fog.vertex.glsl"
in highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;
#ifdef SDF_SUBPASS
out highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;
#ifdef FOG
out highp float v_fog;
#endif
#endif
uniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;
#pragma mapbox: define highp float flood_light_ground_radius
const float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {
#pragma mapbox: initialize highp float flood_light_ground_radius
vec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;
#ifdef SDF_SUBPASS
v_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);
#ifdef FOG
v_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);
#endif
#endif
float hidden_by_landmark=0.0;
#ifdef HAS_CENTROID
hidden_by_landmark=a_hidden_by_landmark;
#endif
float isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),hillshadePrepare:pr(`precision highp float;uniform highp sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:pr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
glFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);
#endif
#ifdef FOG
glFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));
#endif
#ifdef USE_MRT1
out_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:pr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform highp vec2 u_trim_gradient_mix_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef VARIABLE_LINE_WIDTH
in float stub_side;
#endif
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;in vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float side_z_offset
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
#pragma mapbox: define lowp float emissive_strength
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float side_z_offset
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
#pragma mapbox: initialize lowp float emissive_strength
float dist=length(v_normal)*v_width2.s;
#ifdef VARIABLE_LINE_WIDTH
blur=mix(blur,0.0,stub_side);
#endif
float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef VARIABLE_LINE_WIDTH
alpha=mix(alpha,1.0,stub_side);
#endif
alpha=side_z_offset > 0.0 ? 1.0-alpha : alpha;
#ifdef RENDER_LINE_DASH
float sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture(u_gradient_image,v_uv.xy);
#else
out_color=color;
#endif
float trim_alpha=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);highp float gradient_trim_color_mix_factor=0.0;
#ifdef RENDER_LINE_GRADIENT
gradient_trim_color_mix_factor=smoothstep(u_trim_gradient_mix_range.x,u_trim_gradient_mix_range.y,line_progress);
#endif
highp vec4 trim_color=mix(u_trim_color,out_color,gradient_trim_color_mix_factor);out_color=mix(u_trim_gradient_mix_range.x < 1.0 ? color : out_color,trim_color,transition_factor);trim_alpha=1.0-transition_factor;}
#endif
if (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}
#ifdef RENDER_LINE_BORDER
#ifndef VARIABLE_LINE_WIDTH
float edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}
#endif
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef DUAL_SOURCE_BLENDING
glFragColorSrc1=vec4(vec3(0.0),emissive_strength);
#else
#ifdef USE_MRT1
out_Target1=vec4(emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define EXTRUDE_SCALE 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)
in vec3 a_z_offset_width;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
in highp vec3 a_packed;
#endif
#ifdef RENDER_LINE_DASH
in float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef VARIABLE_LINE_WIDTH
out float stub_side;
#endif
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define mediump float side_z_offset
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize mediump float side_z_offset
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
#pragma mapbox: initialize lowp float emissive_strength
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;offset=-1.0*offset*u_width_scale;gapwidth=gapwidth/2.0;float halfwidth;
#ifdef VARIABLE_LINE_WIDTH
bool left=normal.y==1.0;float left_width=a_z_offset_width.y;float right_width=a_z_offset_width.z;halfwidth=(u_width_scale*(left ? left_width : right_width))/2.0;a_z_offset+=left ? side_z_offset : 0.0;v_normal=side_z_offset > 0.0 && left ? vec2(0.0) : v_normal;offset=border_width > 0.0 ? (left_width+right_width)*u_width_scale*0.5 : offset;halfwidth=border_width > 0.0 ? border_width*u_width_scale*0.5 : halfwidth;bool zero_right_width=border_width==0.0 && right_width==0.0;stub_side=zero_right_width ?-normal.y : 0.0;v_normal=!left && zero_right_width ? vec2(0.0) : v_normal;ANTIALIASING=!left && zero_right_width ? 0.0 : ANTIALIASING;
#else
halfwidth=(u_width_scale*width)/2.0;
#endif
float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float epsilon=0.0001;float extrude_length_without_perspective=max(length(dist),epsilon);float extrude_length_with_perspective=max(length(projected_extrude_xy/gl_Position.w*u_units_to_pixels),epsilon);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
highp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);
#else
v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),linePattern:pr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef LINE_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef LINE_JOIN_NONE
in vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
#pragma mapbox: initialize lowp float emissive_strength
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
#ifdef LINE_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl*texel_size-texel_size,pattern_b_br*texel_size+texel_size,vec2(x,y));vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);color=color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}
#endif
#ifdef LINE_JOIN_NONE
highp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}
#endif
#ifdef LIGHTING_3D_MODE
color=apply_lighting_with_emission_ground(color,emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_z_offset);
#endif
glFragColor=color;
#ifdef DUAL_SOURCE_BLENDING
glFragColorSrc1=vec4(vec3(0.0),emissive_strength);
#else
#ifdef USE_MRT1
out_Target1=vec4(emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
in vec3 a_z_offset_width;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 a_packed;
#endif
in highp float a_linesofar;
#ifdef LINE_JOIN_NONE
in highp vec3 a_pattern_data;out vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
out highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
#pragma mapbox: define mediump float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define mediump float floorwidth
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
#pragma mapbox: initialize mediump float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize mediump float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
#pragma mapbox: initialize lowp float emissive_strength
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);
#ifdef LINE_JOIN_NONE
v_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),raster:pr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_raster_array.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
in float v_split_fade;
#endif
uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;
#ifndef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;
#endif
#ifdef RASTER_COLOR
uniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;
#endif
void main() {vec4 color0,color1,color;vec2 value;
#ifdef RASTER_COLOR
#ifdef RASTER_ARRAY
#ifdef RASTER_ARRAY_LINEAR
value=mix(
raTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#else
value=mix(
raTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#endif
if (value.y > 0.0) value.x/=value.y;
#else
color=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);
#endif
color=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;
#else
color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);
#endif
color.a*=u_opacity;
#ifdef GLOBE_POLES
color.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);
#endif
vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef PROJECTION_GLOBE_VIEW
glFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));
#endif
#ifdef RENDER_CUTOFF
glFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
#ifdef USE_MRT1
out_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;in vec2 a_texture_pos;
#endif
out vec2 v_pos0;out vec2 v_pos1;out float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
out float v_split_fade;
#endif
void main() {vec2 uv;
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);
#endif
#else
float w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    
v_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;
#ifdef RENDER_CUTOFF
v_depth=gl_Position.z;
#endif
}`),rasterParticle:pr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),1.0).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
uv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),rasterParticleDraw:pr("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",`#include "_prelude_raster_particle.glsl"
in float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(
mod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}`),rasterParticleTexture:pr("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:pr(`#include "_prelude_raster_particle.glsl"
uniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(
linearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)
);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}`,"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:pr(`#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;
#ifdef ICON_TRANSITION
uniform float u_icon_transition;
#endif
#ifdef COLOR_ADJUSTMENT
uniform mat4 u_color_adj_mat;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#else
#ifdef RENDER_SHADOWS
in highp float v_z_offset;
#endif
#endif
in vec2 v_tex_a;
#ifdef ICON_TRANSITION
in vec2 v_tex_b;
#endif
in float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
in float is_sdf;in vec2 v_tex_a_icon;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];
#ifdef RENDER_TEXT_AND_SYMBOL
if (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
return;}
#endif
#ifdef RENDER_SDF
float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;
#else
#ifdef ICON_TRANSITION
vec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);
#else
out_color=texture(u_texture,v_tex_a);
#endif
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef COLOR_ADJUSTMENT
out_color=u_color_adj_mat*out_color;
#endif
#endif
out_color*=opacity*fade_opacity;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef TERRAIN
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#else
out_color.rgb*=mix(v_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#endif
#endif
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#define USING_APPEARANCE 1.0
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_auto_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
#ifdef ICON_TRANSITION
in vec2 a_texb;
#endif
#ifdef OCCLUSION_QUERIES
in float a_occlusion_query_opacity;
#endif
#ifdef ELEVATED_ROADS
in vec3 a_x_axis;in vec3 a_y_axis;uniform float u_normal_scale;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#else
#ifdef RENDER_SHADOWS
out highp float v_z_offset;
#endif
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out vec2 v_tex_a;
#ifdef ICON_TRANSITION
out vec2 v_tex_b;
#endif
out float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
out float is_sdf;out vec2 v_tex_a_icon;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
#pragma mapbox: define lowp float occlusion_opacity
#pragma mapbox: define lowp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
#pragma mapbox: initialize lowp float occlusion_opacity
#pragma mapbox: initialize lowp float z_offset
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float a_size_max= floor(a_size[1]*0.5);float a_apperance=a_size[1]-2.0*a_size_max;vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (a_apperance==USING_APPEARANCE) {size=a_size_max/128.0;} else if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size_max,u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_auto_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;
#endif
vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
#ifdef PROJECTED_POS_ON_VIEWPORT
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);
#else
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    
#endif
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
#ifdef Z_OFFSET
z+=u_pitch_with_map ? a_auto_z_offset+z_offset : 0.0;
#else
z+=u_pitch_with_map ? z_offset : 0.0;
#endif
float occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));
#ifdef DEPTH_OCCLUSION
float depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;
#endif
#ifdef OCCLUSION_QUERIES
float occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;
#endif
#ifdef Z_TEST_OCCLUSION
out_fade_opacity*=occlusion_opacity;
#endif
float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
#ifdef ELEVATED_ROADS
vec3 xAxis=vec3(a_x_axis.xy,a_x_axis.z*u_normal_scale);vec3 yAxis=vec3(a_y_axis.xy,a_y_axis.z*u_normal_scale);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
pos=vec3(projected_pos.xy/projected_pos.w+offset,z);
#endif
#endif
gl_Position=mix(u_coord_matrix*vec4(pos,1.0),AWAY,hidden);float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;
#ifdef RENDER_TEXT_AND_SYMBOL
is_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;
#endif
#ifdef ICON_TRANSITION
v_tex_b=a_texb/u_texsize;
#endif
#ifdef RENDER_SHADOWS
vec4 shd_pos=u_inv_matrix*vec4(pos,1.0);vec3 shd_pos0=shd_pos.xyz;vec3 shd_pos1=shd_pos.xyz;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=e;
#else
#ifdef RENDER_SHADOWS
v_z_offset=e;
#endif
#endif
}`),terrainRaster:pr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
uniform sampler2D u_image1;uniform float u_emissive_texture_available;
#endif
in vec2 v_pos0;
#ifdef FOG
in float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#endif
uniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;
#ifdef LIGHTING_3D_MODE
const vec3 normal=vec3(0.0,0.0,1.0);
#ifdef RENDER_SHADOWS
float cutoffOpacity=1.0;
#ifdef RENDER_CUTOFF
cutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);
#endif
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
float emissive_strength=u_emissive_texture_available > 0.5 ? texture(u_image1,v_pos0).r : image_color.a;vec3 unlit_base=image_color.rgb*(1.0-emissive_strength);vec3 emissive_base=image_color.rgb*emissive_strength;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;
#else
float lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));
#endif
#else
float lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
float emissive_strength=u_emissive_texture_available > 0.5 ? texture(u_image1,v_pos0).r : image_color.a;color.rgb=mix(color.rgb,image_color.rgb,emissive_strength);color.a=1.0;
#endif
#endif
#else
color=image_color;
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;
#ifdef FOG
out float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#endif
void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);
#endif
}`),terrainDepth:pr("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}`),skybox:pr(`#include "_prelude_fog.fragment.glsl"
in lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,nh),skyboxGradient:pr(`#include "_prelude_fog.fragment.glsl"
in highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,nh),skyboxCapture:pr(`
in highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}`,"in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:pr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
uniform sampler2D u_image1;uniform float u_emissive_texture_available;
#endif
uniform float u_far_z_cutoff;in vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
highp vec2 uv=gl_FragCoord.xy/u_viewport;
#ifdef FLIP_Y
uv.y=1.0-uv.y;
#endif
highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
float emissive_strength=u_emissive_texture_available > 0.5 ? texture(u_image1,v_pos0).r : raster.a;raster=apply_lighting_with_emission_ground(raster,emissive_strength);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);
#else
raster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
float emissive_strength=u_emissive_texture_available > 0.5 ? texture(u_image1,v_pos0).r : color.a;color=apply_lighting_with_emission_ground(color,emissive_strength);color.a=1.0;
#else
color=apply_lighting_ground(color);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;
#endif
out vec2 v_pos0;void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:pr(`#include "_prelude_fog.fragment.glsl"
uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_atmosphere_fog_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {
#ifdef ALPHA_PASS
glFragColor=vec4(0,0,0,0);return;
#else
#ifdef NATIVE
glFragColor=vec4(1,1,1,1);
#else
glFragColor=vec4(0,0,0,1);
#endif
return;
#endif
}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_atmosphere_fog_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_atmosphere_fog_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;
#ifdef ALPHA_PASS
float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);
#else
vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);
#endif
}`,`in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`),model:pr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_opacity;
#ifdef DITHERED_DISCARD
uniform float u_dithered_discard_threshold;
#endif
uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef OCCLUSION_TEXTURE_TRANSFORM
uniform vec4 u_occlusionTextureTransform;
#endif
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#ifdef HAS_ATTRIBUTE_a_pbr
in lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;
#endif
#ifdef HAS_TEXTURE_u_baseColorTexture
uniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;
#endif
#ifdef HAS_TEXTURE_u_metallicRoughnessTexture
uniform sampler2D u_metallicRoughnessTexture;
#endif
#ifdef HAS_TEXTURE_u_occlusionTexture
uniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;
#endif
#ifdef HAS_TEXTURE_u_normalTexture
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_TEXTURE_u_emissionTexture
uniform sampler2D u_emissionTexture;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
in highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;
#ifdef DEPTH_D24
highp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}
#else
highp float unpack_depth_rgba(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;
#ifdef FLIP_Y
coord.y=1.0-coord.y;
#endif
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depthTexture,coord).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));
#endif
return v_depth > depth+0.0005;}
#endif
#define saturate(_x) clamp(_x,0.,1.)
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)
{
#ifdef LIGHTING_3D_MODE
vec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));
#endif
return apply_lighting(albedo,transformed_normal,lighting_factor);
#else
vec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;
#endif
}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;
#ifdef HAS_ATTRIBUTE_a_color_3f
albedo*=vec4(color_3f,1.0);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#else
#ifdef HAS_ATTRIBUTE_a_color_4f
albedo*=color_4f;
#endif
#endif
#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)
vec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}
#ifdef UNPREMULT_TEXTURE_IN_SHADER
if(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;
#endif
if(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}
#endif
vec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
return color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {
#ifdef HAS_TEXTURE_u_normalTexture
highp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;
#ifdef FLIP_Y
T=-T;B=-B;
#endif
highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;
#else
return mat3(1.0);
#endif
}highp vec3 getNormal(){highp vec3 n;
#ifdef HAS_ATTRIBUTE_a_normal_3f
n=normalize(normal_3f);
#else
highp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));
#ifdef FLIP_Y
n=normalize(cross(fdx,fdy));
#else
n=normalize(cross(fdx,fdy))*-1.0;
#endif
#endif
#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
vec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);
#endif
return n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;
#ifdef HAS_ATTRIBUTE_a_pbr
mat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;
#endif
#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) 
vec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;
#endif
const float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)
{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)
{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)
{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)
{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)
{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)
{
#ifdef LIGHTING_3D_MODE
return mat.diffuseColor;
#else
return mat.diffuseColor/PI;
#endif
}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)
{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)
{vec3 env_light=vec3(0.65,0.65,0.65);
#ifdef LIGHTING_3D_MODE
float ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;
#endif
vec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)
{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=NdotL;
#endif
vec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;
#if !defined(LIGHTING_3D_MODE)
const vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);
#endif
color*=intensityFactor;return color;}void main() {
#ifdef TERRAIN_FRAGMENT_OCCLUSION
if (isOccluded()) {discard;}
#endif
vec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;
#ifdef LIGHTING_3D_MODE
lightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;
#endif
vec4 finalColor;
#ifdef DIFFUSE_SHADED
vec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);
#ifdef HAS_TEXTURE_u_occlusionTexture
float ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;
#endif
finalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;
#else
Material mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;
#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
#ifdef OCCLUSION_TEXTURE_TRANSFORM
vec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;
#else
vec2 uv=uv_2f;
#endif
ao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;
#endif
vec4 emissive=u_emissiveFactor;
#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
emissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);
#endif
#ifdef APPLY_LUT_ON_GPU
float emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;
#endif
color+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;
#ifdef HAS_ATTRIBUTE_a_pbr
float resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;
#ifdef APPLY_LUT_ON_GPU
color_mix=applyLUT(u_lutTexture,color_mix);
#endif
color=mix(color,color_mix,min(1.0,resEmission));
#ifdef HAS_ATTRIBUTE_a_color_4f
float distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);
#endif
#endif
vec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);
#endif
#ifdef DITHERED_DISCARD
if (abs(u_dithered_discard_threshold) < 1.0) {float ditherValue=fract(52.9829189*fract(0.06711056*gl_FragCoord.x+0.00583715*gl_FragCoord.y));float compareValue=mix(1.0-ditherValue,ditherValue,step(0.0,u_dithered_discard_threshold));if (abs(u_dithered_discard_threshold) < compareValue) {discard;}}
#endif
#ifdef FOG
finalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));
#endif
#ifdef RENDER_CUTOFF
finalColor*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
finalColor=applyCutout(finalColor,v_position_height.w);
#endif
#ifdef FEATURE_CUTOUT
finalColor=apply_feature_cutout(finalColor,gl_FragCoord);
#endif
glFragColor=finalColor;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr
#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength
uniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_normal_matrix;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
out vec4 v_position_height;out lowp vec4 v_color_mix;
#ifdef TERRAIN_FRAGMENT_OCCLUSION
out highp float v_depth;
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
out lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute-custom highp vec4 pbr
#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength
highp mat4 normal_matrix;
#ifdef INSTANCED_ARRAYS
normal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
normal_matrix=u_normal_matrix;
#endif
vec3 local_pos;mat3 rs;
#ifdef MODEL_POSITION_ON_GPU
vec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;
#else
local_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);
#endif
v_position_height.w=a_pos_3f.z;
#ifdef HAS_ATTRIBUTE_a_pbr
vec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;
#endif
#ifdef FOG
v_fog_pos=fog_position(local_pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
v_depth=gl_Position.z/gl_Position.w;
#ifdef CLIP_ZERO_TO_ONE
v_depth=-1.0+2.0*v_depth; 
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
float x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);
#else
normal_3f=vec3(normal_matrix*vec4(normal_3f,0));
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#ifdef HAS_ATTRIBUTE_a_color_4f
v_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);
#endif
#endif
#ifdef RENDER_SHADOWS
vec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);
#ifdef NORMAL_OFFSET
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
vec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#else
vec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#endif
#endif
#endif
v_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;
#endif
}`),modelDepth:pr(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;
#ifdef MODEL_POSITION_ON_GPU
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_instance;
#endif
uniform highp mat4 u_node_matrix;
#endif
void main() {
#ifdef MODEL_POSITION_ON_GPU
highp mat4 instance;
#ifdef INSTANCED_ARRAYS
instance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
instance=u_instance;
#endif
vec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);
#else
gl_Position=u_matrix*vec4(a_pos_3f,1);
#endif
v_depth=gl_Position.z/gl_Position.w;}`),stars:pr(`in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)
{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}`,`
in vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}`),snowParticle:pr("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; 
uniform float u_horizontalOscillationRate; 
uniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}`),rainParticle:pr("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity; 
uniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; 
pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}`),vignette:pr("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:pr("uniform vec4 u_color;void main() {glFragColor=u_color;}",`#include "_prelude_terrain.vertex.glsl"
in highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;
#ifdef TERRAIN
float e=elevation(world_pos.xy);world_pos.z+=e;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}`)};function mu(m,s){const d=m.split(`
`);for(let f of d){if(f=f.trimStart(),f[0]!=="#"||!f.includes("if")||f.startsWith("#endif"))continue;const _=f.match(gx);if(_)for(const b of _)od.has(b)||s.add(b)}}function pr(m,s){const d=new Set,f=[],_=[];m=m.replace(Xp,(S,A)=>(_.push(A),"")),s=s.replace(Xp,(S,A)=>(f.push(A),""));let b=new Set(ld);mu(m,b),mu(s,b);for(const S of[...f,..._])Mf[S]||(Mf[S]=new Set,mu(pu[S],Mf[S])),b=new Set([...b,...Mf[S]]);return{fragmentSource:m=m.replace(ec,(S,A,E,D,M)=>(d.add(M),A==="define"?`
#ifndef HAS_UNIFORM_u_${M}
in ${E} ${D} ${M};
#else
uniform ${E} ${D} u_${M};
#endif
`:A==="initialize"?`
#ifdef HAS_UNIFORM_u_${M}
    ${E} ${D} ${M} = u_${M};
#endif
`:A==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${M}
    in ${E} ${D} ${M};
#endif
`:A==="initialize-attribute"?"":void 0)),vertexSource:s=s.replace(ec,(S,A,E,D,M)=>{const B=`MATERIAL_ATTRIBUTE_OFFSET_${M}`,z=D==="float"?"vec2":D,V=`GET_ATTRIBUTE_${z}(a_${M}, materialInfo, ${B})`,Q=M.match(/color/)?"color":z;return A==="define-attribute-vertex-shader-only"?`
#ifdef HAS_ATTRIBUTE_a_${M}
in ${E} ${D} a_${M};
#endif
`:d.has(M)?A==="define"?`
#ifndef HAS_UNIFORM_u_${M}
uniform lowp float u_${M}_t;
    #if !defined(${B})
        in ${E} ${z} a_${M};
    #endif
out ${E} ${D} ${M};
#else
uniform ${E} ${D} u_${M};
#endif
`:A==="initialize"?Q==="vec4"?`
#ifndef HAS_UNIFORM_u_${M}
    ${M} = a_${M};
#else
    ${E} ${D} ${M} = u_${M};
#endif
`:`
#if !defined(HAS_UNIFORM_u_${M})
    #ifdef ${B}
        ${M} = unpack_mix_${Q}(${V}, u_${M}_t);
    #else
        ${M} = unpack_mix_${Q}(a_${M}, u_${M}_t);
    #endif
#else
    ${E} ${D} ${M} = u_${M};
#endif
`:A==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${M}
    in ${E} ${D} a_${M};
    out ${E} ${D} ${M};
#endif
`:A==="initialize-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${M}
    ${M} = a_${M};
#endif
`:void 0:A==="define"?`
#ifndef HAS_UNIFORM_u_${M}
uniform lowp float u_${M}_t;
    #if !defined(${B})
        in ${E} ${z} a_${M};
    #endif
#else
uniform ${E} ${D} u_${M};
#endif
`:A==="define-instanced"?Q==="mat4"?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${M}0;
in vec4 a_${M}1;
in vec4 a_${M}2;
in vec4 a_${M}3;
#else
uniform ${E} ${D} u_${M};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${E} ${z} a_${M};
#else
uniform ${E} ${D} u_${M};
#endif
`:A==="initialize-attribute-custom"?`
#ifdef HAS_ATTRIBUTE_a_${M}
    ${E} ${D} ${M} = a_${M};
#endif
`:Q==="vec4"?`
#ifndef HAS_UNIFORM_u_${M}
    #ifdef ${B}
        ${E} ${D} ${M} = ${V};
    #else
        ${E} ${D} ${M} = a_${M};
    #endif
#else
    ${E} ${D} ${M} = u_${M};
#endif
`:`
#ifndef HAS_UNIFORM_u_${M}
    #ifdef ${B}
        ${E} ${D} ${M} = unpack_mix_${Q}(${V}, u_${M}_t);
    #else
        ${E} ${D} ${M} = unpack_mix_${Q}(a_${M}, u_${M}_t);
    #endif
#else
    ${E} ${D} ${M} = u_${M};
#endif
`}),usedDefines:b,vertexIncludes:f,fragmentIncludes:_}}class YT{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(s,d,f,_,b,S,A,E){this.context=s;let D=this.boundPaintVertexBuffers.length!==_.length;for(let B=0;!D&&B<_.length;B++)this.boundPaintVertexBuffers[B]!==_[B]&&(D=!0);let M=this.boundDynamicVertexBuffers.length!==A.length;for(let B=0;!M&&B<A.length;B++)this.boundDynamicVertexBuffers[B]!==A[B]&&(M=!0);if(!this.vao||this.boundProgram!==d||this.boundLayoutVertexBuffer!==f||D||M||this.boundIndexBuffer!==b||this.boundVertexOffset!==S)this.freshBind(d,f,_,b,S,A,E);else{s.bindVertexArrayOES.set(this.vao);for(const B of A)B&&(B.bind(),E&&B.instanceCount&&B.setVertexAttribDivisor(s.gl,d,E));b&&b.dynamicDraw&&b.bind()}}freshBind(s,d,f,_,b,S,A){const E=this.context,D=E.gl;this.vao&&this.destroy(),this.vao=E.gl.createVertexArray(),E.bindVertexArrayOES.set(this.vao),this.boundProgram=s,this.boundLayoutVertexBuffer=d,this.boundPaintVertexBuffers=f,this.boundIndexBuffer=_,this.boundVertexOffset=b,this.boundDynamicVertexBuffers=S,d.enableAttributes(D,s),d.bind(),d.setVertexAttribPointers(D,s,b);for(const M of f)M.enableAttributes(D,s),M.bind(),M.setVertexAttribPointers(D,s,b);for(const M of S)M&&(M.enableAttributes(D,s),M.bind(),M.setVertexAttribPointers(D,s,b),A&&M.instanceCount&&M.setVertexAttribDivisor(D,s,A));_&&_.bind()}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function KT(m,s){const d=Math.pow(2,s.canonical.z),f=s.canonical.y;return[new o.ae(0,f/d).toLngLat().lat,new o.ae(0,(f+1)/d).toLngLat().lat]}function QT(m,s,d,f,_,b,S){const A=m.context,E=A.gl,D=d.hillshadeFBO;if(!D)return;m.prepareDrawTile();const M=m.isTileAffectedByFog(s),B=[];m.terrain&&m.terrain.renderingToTexture&&m.emissiveMode==="mrt-fallback"&&B.push("USE_MRT1");const z=m.getOrCreateProgram("hillshade",{overrideFog:M,defines:B});A.activeTexture.set(E.TEXTURE0),E.bindTexture(E.TEXTURE_2D,D.colorAttachment0.get());const V=((ce,_e,xe,fe)=>{const Fe=xe.paint.get("hillshade-shadow-color"),De=xe.paint.get("hillshade-shadow-color-use-theme").constantOr("default")==="none",Oe=xe.paint.get("hillshade-highlight-color"),Ee=xe.paint.get("hillshade-highlight-color-use-theme").constantOr("default")==="none",Se=xe.paint.get("hillshade-accent-color"),qe=xe.paint.get("hillshade-accent-color-use-theme").constantOr("default")==="none",Ye=xe.paint.get("hillshade-emissive-strength");let Qe=o.an(xe.paint.get("hillshade-illumination-direction"));if(xe.paint.get("hillshade-illumination-anchor")==="viewport")Qe-=ce.transform.angle;else if(ce.style&&ce.style.enable3dLights()&&ce.style.directionalLight){const nt=ce.style.directionalLight.properties.get("direction"),ft=o.d4(nt.x,nt.y,nt.z);Qe=o.an(ft[1])}const at=!ce.options.moving;return{u_matrix:fe||ce.transform.calculateProjMatrix(_e.tileID.toUnwrapped(),at),u_image:0,u_latrange:KT(0,_e.tileID),u_light:[xe.paint.get("hillshade-exaggeration"),Qe],u_shadow:Fe.toPremultipliedRenderColor(De?null:xe.lut),u_highlight:Oe.toPremultipliedRenderColor(Ee?null:xe.lut),u_emissive_strength:Ye,u_accent:Se.toPremultipliedRenderColor(qe?null:xe.lut)}})(m,d,f,m.terrain?s.projMatrix:null);m.uploadCommonUniforms(A,z,s.toUnwrapped());const{tileBoundsBuffer:Q,tileBoundsIndexBuffer:W,tileBoundsSegments:J}=m.getTileBoundsBuffers(d);z.draw(m,E.TRIANGLES,_,b,S,Ai.disabled,V,f.id,Q,W,J)}function xx(m,s,d){if(!s.needsDEMTextureUpload)return;const f=m.context,_=f.gl;f.pixelStoreUnpackPremultiplyAlpha.set(!1),s.demTexture=s.demTexture||m.getTileTexture(d.stride);const b=d.getPixels();s.demTexture?s.demTexture.update(b,{premultiply:!1}):s.demTexture=new o.T(f,b,_.R32F,{premultiply:!1}),s.needsDEMTextureUpload=!1}function JT(m,s,d){const f=m.context,_=f.gl;if(!s.dem)return;const b=s.dem;if(f.activeTexture.set(_.TEXTURE1),xx(m,s,b),!s.demTexture)return;s.demTexture.bind(_.NEAREST,_.CLAMP_TO_EDGE);const S=b.dim;f.activeTexture.set(_.TEXTURE0);let A=s.hillshadeFBO;if(!A){const z=new o.T(f,{width:S,height:S,data:null},_.RGBA8);z.bind(_.LINEAR,_.CLAMP_TO_EDGE),A=s.hillshadeFBO=f.createFramebuffer(S,S,1,"renderbuffer"),A.colorAttachment0.set(z.texture)}f.bindFramebuffer.set(A.framebuffer),f.viewport.set([0,0,S,S]);const{tileBoundsBuffer:E,tileBoundsIndexBuffer:D,tileBoundsSegments:M}=m.getMercatorTileBoundsBuffers(),B=[];m.linearFloatFilteringSupported()&&B.push("TERRAIN_DEM_FLOAT_FORMAT"),m.terrain&&m.terrain.renderingToTexture&&m.emissiveMode==="mrt-fallback"&&B.push("USE_MRT1"),m.getOrCreateProgram("hillshadePrepare",{defines:B}).draw(m,_.TRIANGLES,si.disabled,ji.disabled,Di.unblended,Ai.disabled,((z,V)=>{const Q=V.stride,W=o.bC();return o.ce(W,0,o.al,-o.al,0,0,1),o.br(W,W,[0,-o.al,0]),{u_matrix:W,u_image:1,u_dimension:[Q,Q],u_zoom:z.overscaledZ}})(s.tileID,b),d.id,E,D,M),s.needsHillshadePrepare=!1}class on{constructor(s){this.gl=s.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(s){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class eN extends on{getDefault(){return o.ao.transparent.toNonPremultipliedRenderColor(null)}set(s){const d=this.current;(s.r!==d.r||s.g!==d.g||s.b!==d.b||s.a!==d.a||this.dirty)&&(this.gl.clearColor(s.r,s.g,s.b,s.a),this.current=s,this.dirty=!1)}}class pb extends on{getDefault(){return 1}set(s){(s!==this.current||this.dirty)&&(this.gl.clearDepth(s),this.current=s,this.dirty=!1)}}class _x extends on{getDefault(){return 0}set(s){(s!==this.current||this.dirty)&&(this.gl.clearStencil(s),this.current=s,this.dirty=!1)}}class Lf extends on{getDefault(){return[!0,!0,!0,!0]}set(s){const d=this.current;(s[0]!==d[0]||s[1]!==d[1]||s[2]!==d[2]||s[3]!==d[3]||this.dirty)&&(this.gl.colorMask(s[0],s[1],s[2],s[3]),this.current=s,this.dirty=!1)}}class vx extends on{getDefault(){return!0}set(s){(s!==this.current||this.dirty)&&(this.gl.depthMask(s),this.current=s,this.dirty=!1)}}class cd extends on{getDefault(){return 255}set(s){(s!==this.current||this.dirty)&&(this.gl.stencilMask(s),this.current=s,this.dirty=!1)}}class sh extends on{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(s){const d=this.current;(s.func!==d.func||s.ref!==d.ref||s.mask!==d.mask||this.dirty)&&(this.gl.stencilFunc(s.func,s.ref,s.mask),this.current=s,this.dirty=!1)}}class Yp extends on{getDefault(){const s=this.gl;return[s.KEEP,s.KEEP,s.KEEP]}set(s){const d=this.current;(s[0]!==d[0]||s[1]!==d[1]||s[2]!==d[2]||this.dirty)&&(this.gl.stencilOp(s[0],s[1],s[2]),this.current=s,this.dirty=!1)}}class ah extends on{getDefault(){return!1}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;s?d.enable(d.STENCIL_TEST):d.disable(d.STENCIL_TEST),this.current=s,this.dirty=!1}}class mb extends on{getDefault(){return[0,1]}set(s){const d=this.current;(s[0]!==d[0]||s[1]!==d[1]||this.dirty)&&(this.gl.depthRange(s[0],s[1]),this.current=s,this.dirty=!1)}}class bx extends on{getDefault(){return!1}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;s?d.enable(d.DEPTH_TEST):d.disable(d.DEPTH_TEST),this.current=s,this.dirty=!1}}class fb extends on{getDefault(){return this.gl.LESS}set(s){(s!==this.current||this.dirty)&&(this.gl.depthFunc(s),this.current=s,this.dirty=!1)}}class oh extends on{getDefault(){return!1}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;s?d.enable(d.BLEND):d.disable(d.BLEND),this.current=s,this.dirty=!1}}class Ff extends on{getDefault(){const s=this.gl;return[s.ONE,s.ZERO,s.ONE,s.ZERO]}set(s){const d=this.current;(s[0]!==d[0]||s[1]!==d[1]||s[2]!==d[2]||s[3]!==d[3]||this.dirty)&&(this.gl.blendFuncSeparate(s[0],s[1],s[2],s[3]),this.current=s,this.dirty=!1)}}class zf extends on{getDefault(){return o.ao.transparent.toNonPremultipliedRenderColor(null)}set(s){const d=this.current;(s.r!==d.r||s.g!==d.g||s.b!==d.b||s.a!==d.a||this.dirty)&&(this.gl.blendColor(s.r,s.g,s.b,s.a),this.current=s,this.dirty=!1)}}class wx extends on{getDefault(){return this.gl.FUNC_ADD}set(s){(s!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(s,s),this.current=s,this.dirty=!1)}}class Bf extends on{getDefault(){return!1}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;s?d.enable(d.CULL_FACE):d.disable(d.CULL_FACE),this.current=s,this.dirty=!1}}class Kp extends on{getDefault(){return this.gl.BACK}set(s){(s!==this.current||this.dirty)&&(this.gl.cullFace(s),this.current=s,this.dirty=!1)}}class gb extends on{getDefault(){return this.gl.CCW}set(s){(s!==this.current||this.dirty)&&(this.gl.frontFace(s),this.current=s,this.dirty=!1)}}let yb=class extends on{getDefault(){return null}set(m){(m!==this.current||this.dirty)&&(this.gl.useProgram(m),this.current=m,this.dirty=!1)}};class xb extends on{getDefault(){return this.gl.TEXTURE0}set(s){(s!==this.current||this.dirty)&&(this.gl.activeTexture(s),this.current=s,this.dirty=!1)}}class lh extends on{getDefault(){const s=this.gl;return[0,0,s.drawingBufferWidth,s.drawingBufferHeight]}set(s){const d=this.current;(s[0]!==d[0]||s[1]!==d[1]||s[2]!==d[2]||s[3]!==d[3]||this.dirty)&&(this.gl.viewport(s[0],s[1],s[2],s[3]),this.current=s,this.dirty=!1)}}class _b extends on{getDefault(){return null}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;d.bindFramebuffer(d.FRAMEBUFFER,s),this.current=s,this.dirty=!1}}class tN extends on{getDefault(){return null}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;d.bindRenderbuffer(d.RENDERBUFFER,s),this.current=s,this.dirty=!1}}class iN extends on{getDefault(){return null}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;d.bindTexture(d.TEXTURE_2D,s),this.current=s,this.dirty=!1}}class rN extends on{getDefault(){return null}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;d.bindBuffer(d.ARRAY_BUFFER,s),this.current=s,this.dirty=!1}}class Sx extends on{getDefault(){return null}set(s){const d=this.gl;d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,s),this.current=s,this.dirty=!1}}class Tx extends on{getDefault(){return null}set(s){this.gl&&(s!==this.current||this.dirty)&&(this.gl.bindVertexArray(s),this.current=s,this.dirty=!1)}}class Nx extends on{getDefault(){return 4}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;d.pixelStorei(d.UNPACK_ALIGNMENT,s),this.current=s,this.dirty=!1}}class Ax extends on{getDefault(){return!1}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,s),this.current=s,this.dirty=!1}}class vb extends on{getDefault(){return!1}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,s),this.current=s,this.dirty=!1}}class Vf extends on{constructor(s,d){super(s),this.context=s,this.parent=d}getDefault(){return null}}class Uf extends Vf{constructor(s,d,f=0){super(s,d),this.attachmentPoint=s.gl.COLOR_ATTACHMENT0+f}setDirty(){this.dirty=!0}set(s){if(s===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const d=this.gl;d.framebufferTexture2D(d.FRAMEBUFFER,this.attachmentPoint,d.TEXTURE_2D,s,0),this.current=s,this.dirty=!1}}class ch extends Vf{attachment(){return this.gl.DEPTH_ATTACHMENT}set(s){if(s===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const d=this.gl;d.framebufferRenderbuffer(d.FRAMEBUFFER,this.attachment(),d.RENDERBUFFER,s),this.current=s,this.dirty=!1}}class Qp extends Vf{attachment(){return this.gl.DEPTH_ATTACHMENT}set(s){if(s===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const d=this.gl;d.framebufferTexture2D(d.FRAMEBUFFER,this.attachment(),d.TEXTURE_2D,s,0),this.current=s,this.dirty=!1}}class bb extends ch{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}const Uo=(m,s,d,f)=>({u_matrix:m,u_image0:0,u_image1:1,u_skirt_height:s,u_ground_shadow_factor:d,u_emissive_texture_available:f}),qf=(m,s,d,f,_,b,S,A,E,D,M,B,z,V,Q,W,J)=>({u_proj_matrix:Float32Array.from(m),u_globe_matrix:s,u_normalize_matrix:Float32Array.from(f),u_merc_matrix:d,u_zoom_transition:_,u_merc_center:b,u_image0:0,u_image1:1,u_frustum_tl:S,u_frustum_tr:A,u_frustum_br:E,u_frustum_bl:D,u_globe_pos:M,u_globe_radius:B,u_viewport:z,u_grid_matrix:J?Float32Array.from(J):new Float32Array(9),u_skirt_height:V,u_far_z_cutoff:Q,u_emissive_texture_available:W});function Jp(m,s){return m!=null&&s!=null&&!(!m.hasData()||!s.hasData())&&m.demTexture!=null&&s.demTexture!=null&&m.tileID.key!==s.tileID.key}const jc=new class{constructor(){this.operations={}}newMorphing(m,s,d,f,_){if(m in this.operations){const b=this.operations[m];b.to.tileID.key!==d.tileID.key&&(b.queued=d)}else this.operations[m]={startTime:f,phase:0,duration:_,from:s,to:d,queued:null}}getMorphValuesForProxy(m){if(!(m in this.operations))return null;const s=this.operations[m];return{from:s.from,to:s.to,phase:s.phase}}update(m){for(const s in this.operations){const d=this.operations[s];for(d.phase=(m-d.startTime)/d.duration;d.phase>=1||!this._validOp(d);)if(!this._nextOp(d,m)){delete this.operations[s];break}}}_nextOp(m,s){return!!m.queued&&(m.from=m.to,m.to=m.queued,m.queued=null,m.phase=0,m.startTime=s,!0)}_validOp(m){return m.from.hasData()&&m.to.hasData()}},$f={0:null,1:"TERRAIN_VERTEX_MORPHING"};function Gf(m,s,d){if(s===0)return 0;const f=s<1&&d===514?.25/s:1;return 6*Math.pow(1.5,22-m)*Math.max(s,1)*f}function Cx(m,s){const d=1<<m.z;return!s&&(m.x===0||m.x===d-1)||m.y===0||m.y===d-1}function uh(m,s){if(!m.style||!m.style.enable3dLights())return;const d=m.context,f=d.gl;d.activeTexture.set(f.TEXTURE1),s?s.bind(f.LINEAR,f.CLAMP_TO_EDGE):m.emptyTexture.bind(f.LINEAR,f.CLAMP_TO_EDGE)}const em=m=>({u_matrix:m});function tm(m,s,d,f,_){if(_>0){const b=o.o.now(),S=(b-m.timeAdded)/_,A=s?(b-s.timeAdded)/_:-1,E=d.getSource(),D=f.coveringZoomLevel({tileSize:E.tileSize,roundZoom:E.roundZoom}),M=!s||Math.abs(s.tileID.overscaledZ-D)>Math.abs(m.tileID.overscaledZ-D),B=M&&m.refreshedUponExpiration?1:o.aA(M?S:1-A,0,1);return s?{opacity:1,mix:1-B,isFading:S<1}:{opacity:B,mix:0,isFading:S<1}}return{opacity:1,mix:0,isFading:!1}}class Hf extends Ca{constructor(s){const d=xn("mock-dem",{type:"raster-dem",maxzoom:s.transform.maxZoom},s.style.dispatcher,s.style);super("mock-dem",d,!1),d.setEventedParent(this),this._sourceLoaded=!0}_loadTile(s,d){s.state="loaded",d(null)}}class Ex extends Ca{constructor(s){const d=xn("proxy",{type:"geojson",maxzoom:s.transform.maxZoom},s.style.dispatcher,s.style);super("proxy",d,!1),d.setEventedParent(this),this.map=this.getSource().map=s,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(s,d,f){if(s.freezeTileCoverage)return;this.transform=s;const _=s.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((b,S)=>{if(b[S.key]="",!this._tiles[S.key]){const A=new Hl(S,this._source.tileSize*S.overscaleFactor(),s.tileZoom,void 0,void 0,this._source.worldview);A.state="loaded",this._tiles[S.key]=A}return b},{});for(const b in this._tiles)b in _||(this.freeFBO(b),this._tiles[b].unloadVectorData(),delete this._tiles[b])}freeFBO(s){const d=this.proxyCachedFBO[s];if(d!==void 0){const f=Object.values(d);this.renderCachePool.push(...f),delete this.proxyCachedFBO[s]}}deallocRenderCache(){this.renderCache.forEach(s=>s.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Ix extends o.aQ{constructor(s,d,f){super(s.overscaledZ,s.wrap,s.canonical.z,s.canonical.x,s.canonical.y),this.proxyTileKey=d,this.projMatrix=f}}class Px extends o.bV{constructor(s,d){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},this.painter=s,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[f,_,b]=function(){const E=new o.bd,D=new o.b0,M=131;E.reserve(17161),D.reserve(33800);const B=o.al/128,z=o.al+B/2,V=z+B;for(let W=-B;W<V;W+=B)for(let J=-B;J<V;J+=B){const ce=J<0||J>z||W<0||W>z?24575:0,_e=o.aA(Math.round(J),0,o.al),xe=o.aA(Math.round(W),0,o.al);E.emplaceBack(_e+ce,xe)}const Q=(W,J)=>{const ce=J*M+W;D.emplaceBack(ce+1,ce,ce+M),D.emplaceBack(ce+M,ce+M+1,ce+1)};for(let W=1;W<129;W++)for(let J=1;J<129;J++)Q(J,W);return[0,129].forEach(W=>{for(let J=0;J<130;J++)Q(J,W),Q(W,J)}),[E,D,32768]}(),S=s.context;this.gridBuffer=S.createVertexBuffer(f,o.bf.members),this.gridIndexBuffer=S.createIndexBuffer(_),this.gridSegments=o.bg.simpleSegment(0,0,f.length,_.length),this.gridNoSkirtSegments=o.bg.simpleSegment(0,0,f.length,b),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new Ex(d.map),this.orthoMatrix=o.bC(),o.ce(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,o.al,0,o.al,0,1);const A=S.gl;this._overlapStencilMode=new ji({func:A.GEQUAL,mask:255},0,255,A.KEEP,A.KEEP,A.REPLACE),this._previousZoom=s.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=d,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new Hf(d.map),this._pendingGroundEffectLayers=[],this._emissiveTexture=!1}set style(s){s.on("data",this._onStyleDataEvent.bind(this)),this._style=s,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(s,d,f){if(s&&s.terrain){this._style!==s&&(this.style=s,this._evaluationZoom=void 0);const _=s.terrain.properties,b=s.terrain.drapeRenderMode===0,S=s.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=o.o.now();const A=s.terrain&&s.terrain.scope,E=_.get("source"),D=b?this._mockSourceCache:s.getSourceCache(E,A);if(!D)return void o.w(`Couldn't find terrain source "${E}".`);if(this.sourceCache=D,this._attenuationRange=s.terrain.getAttenuationRange(),this._exaggeration=S?this.calculateExaggeration(d):_.get("exaggeration"),!d.projection.requiresDraping&&S&&this._exaggeration===0)return void this._disable();this.enabled=!0;const M=()=>{this.sourceCache.used&&o.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const B=this.getScaledDemTileSize();this.sourceCache.update(d,B,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,M(),this._initializing=!0),M(),d.updateElevation(!0,f),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(d),this._emptyDEMTextureDirty=!0,this._previousZoom=d.zoom}else this._disable()}calculateExaggeration(s){if(this._attenuationRange&&s.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(s.zoom);const d=this._previousCameraAltitude,f=s.getFreeCameraOptions().position.z/s.pixelsPerMeter*s.worldSize;this._previousCameraAltitude=f;const _=d!=null?f-d:Number.MAX_VALUE;if(Math.abs(_)<2)return this._exaggeration;const b=s.zoom,S=this._style.terrain;if(!this._previousUpdateTimestamp)return S.getExaggeration(b);let A=b-this._previousZoom;const E=this._previousUpdateTimestamp;let D=b;this._evaluationZoom!=null&&(D=this._evaluationZoom,Math.abs(b-D)>.5&&(A=.5*(b-D+A)),A*_<0&&(D+=A)),this._evaluationZoom=D;const M=S.getExaggeration(D),B=M===S.getExaggeration(Math.max(0,D-.1));if(B&&Math.abs(M-this._exaggeration)<.01)return M;let z=Math.min(.1,.00375*(this._updateTimestamp-E));return(B||M<.1||Math.abs(A)<1e-4)&&(z=Math.min(.2,4*z)),o.ak(this._exaggeration,M,z)}resetTileLookupCache(s){this._findCoveringTileCache[s]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(s){s.dataType==="source"&&s.coord?this._clearRenderCacheForTile(s.sourceCacheId,s.coord):s.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const s in this._style._mergedSourceCaches)this._style._mergedSourceCaches[s].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach(s=>s.fb.destroy()),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const s=2*this.proxySourceCache.getSource().tileSize;return[s,s]}set useVertexMorphing(s){this._useVertexMorphing=s}updateTileBinding(s){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const d=this.proxySourceCache,f=this.painter.transform;this._initializing&&(this._initializing=f._centerAltitude===0&&this.getAtPointOrZero(o.ae.fromLngLat(f.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const _=this.proxyCoords=d.getIds().map(E=>{const D=d.getTileByID(E).tileID;return D.projMatrix=f.calculateProjMatrix(D.toUnwrapped()),D});(function(E,D){const M=D.transform.pointCoordinate(D.transform.getCameraPoint()),B=new o.P(M.x,M.y);E.sort((z,V)=>{if(V.overscaledZ-z.overscaledZ)return V.overscaledZ-z.overscaledZ;const Q=new o.P(z.canonical.x+(1<<z.canonical.z)*z.wrap,z.canonical.y),W=new o.P(V.canonical.x+(1<<V.canonical.z)*V.wrap,V.canonical.y),J=B.mult(1<<z.canonical.z);return J.x-=.5,J.y-=.5,J.distSqr(Q)-J.distSqr(W)})})(_,this.painter);const b=this.proxyToSource||{};this.proxyToSource={},_.forEach(E=>{this.proxyToSource[E.key]={}}),this.terrainTileForTile={};const S=this._style._mergedSourceCaches;for(const E in S){const D=S[E];if(!D.used||(D!==this.sourceCache&&this.resetTileLookupCache(D.id),this._setupProxiedCoordsForOrtho(D,s[E],b),D.usedForTerrain))continue;const M=s[E];D.getSource().reparseOverscaled&&this._assignTerrainTiles(M)}this.proxiedCoords[d.id]=_.map(E=>new Ix(E,E.key,this.orthoMatrix)),this._assignTerrainTiles(_),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(b),this.renderingToTexture=!1;const A={};this._visibleDemTiles=[];for(const E of this.proxyCoords){const D=this.terrainTileForTile[E.key];if(!D)continue;const M=D.tileID.key;M in A||(this._visibleDemTiles.push(D),A[M]=M)}}_assignTerrainTiles(s){this._initializing||s.forEach(d=>{if(this.terrainTileForTile[d.key])return;const f=this._findTileCoveringTileID(d,this.sourceCache);f&&(this.terrainTileForTile[d.key]=f)})}_prepareDEMTextures(){const s=this.painter.context,d=s.gl;for(const f in this.terrainTileForTile){const _=this.terrainTileForTile[f],b=_.dem;!b||_.demTexture&&!_.needsDEMTextureUpload||(s.activeTexture.set(d.TEXTURE1),xx(this.painter,_,b))}}_prepareDemTileUniforms(s,d,f,_){if(!d||d.demTexture==null)return!1;const b=s.tileID.canonical,S=Math.pow(2,d.tileID.canonical.z-b.z),A=_||"";return f[`u_dem_tl${A}`]=[b.x*S%1,b.y*S%1],f[`u_dem_scale${A}`]=S,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let s=0;const d=this._visibleDemTiles.reduce((f,_)=>{if(!_.dem)return f;const b=_.dem.tree.minimums[0];return b>0&&s++,f+b},0);return s?d/s:0}_updateEmptyDEMTexture(){const s=this.painter.context,d=s.gl;s.activeTexture.set(d.TEXTURE2);const f=this._getLoadedAreaMinimum(),_=new o.dL({width:1,height:1},new Float32Array([f]));this._emptyDEMTextureDirty=!1;let b=this._emptyDEMTexture;return b?b.update(_,{premultiply:!1}):b=this._emptyDEMTexture=new o.T(s,_,d.R32F,{premultiply:!1}),b}setupElevationDraw(s,d,f){const _=this.painter.context,b=_.gl,S={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};S.u_exaggeration=this.exaggeration();let A=null,E=null,D=1;if(f&&f.morphing&&this._useVertexMorphing){const V=f.morphing.srcDemTile,Q=f.morphing.dstDemTile;D=f.morphing.phase,V&&Q&&(this._prepareDemTileUniforms(s,V,S,"_prev")&&(E=V),this._prepareDemTileUniforms(s,Q,S)&&(A=Q))}const M=V=>V&&V.demTexture&&this.painter.linearFloatFilteringSupported()?b.LINEAR:b.NEAREST;let B=null;var z;if(this.enabled?E&&A?(B=A.demTexture,_.activeTexture.set(b.TEXTURE4),E.demTexture.bind(M(E),b.CLAMP_TO_EDGE),S.u_dem_lerp=D):(A=this.terrainTileForTile[s.tileID.key],B=this._prepareDemTileUniforms(s,A,S)?A.demTexture:this.emptyDEMTexture):B=this.emptyDEMTexture,_.activeTexture.set(b.TEXTURE2),B&&(S.u_dem_size=(z=B).size[0]===1?1:z.size[0]-2,B.bind(M(A),b.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(f&&f.useDepthForOcclusion,d,S),f&&f.useMeterToDem&&A){const V=(1<<A.tileID.canonical.z)*o.cf(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;S.u_meter_to_dem=V}if(f&&f.labelPlaneMatrixInv&&(S.u_label_plane_matrix_inv=f.labelPlaneMatrixInv),d.setTerrainUniformValues(_,S),this.painter.transform.projection.name==="globe"){const V=this.globeUniformValues(this.painter.transform,s.tileID.canonical,f&&f.useDenormalizedUpVectorScale);d.setGlobeUniformValues(_,V)}}globeUniformValues(s,d,f){const _=s.projection;return{u_tile_tl_up:_.upVector(d,0,0),u_tile_tr_up:_.upVector(d,o.al,0),u_tile_br_up:_.upVector(d,o.al,o.al),u_tile_bl_up:_.upVector(d,0,o.al),u_tile_up_scale:f?o.dM(1):_.upVectorScale(d,s.center.lat,s.worldSize).metersToTile}}renderToBackBuffer(s){const d=this.painter,f=this.painter.context;s.length!==0&&(f.bindFramebuffer.set(null),f.viewport.set([0,0,d.width,d.height]),d.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(_,b,S,A,E){if(_.transform.projection.name==="globe")(function(D,M,B,z,V){const Q=D.context,W=Q.gl;let J,ce;const _e=D.transform,xe=o.dE(D,Q,_e),fe=(at,nt)=>{if(ce===nt)return;const ft=[$f[nt],"PROJECTION_GLOBE_VIEW"];xe&&ft.push("CUSTOM_ANTIALIASING");const Nt=D.isTileAffectedByFog(at);J=D.getOrCreateProgram("globeRaster",{defines:ft,overrideFog:Nt}),ce=nt},Fe=D.colorModeForRenderPass(),De=new si(W.LEQUAL,si.ReadWrite,D.depthRangeFor3D);jc.update(V);const Oe=o.dF(_e),Ee=[o.aF(_e.center.lng),o.aJ(_e.center.lat)],Se=D.globeSharedBuffers,qe=[_e.width*o.o.devicePixelRatio,_e.height*o.o.devicePixelRatio],Ye=Float32Array.from(_e.globeMatrix),Qe={useDenormalizedUpVectorScale:!0};{const at=D.transform,nt=Gf(at.zoom,M.exaggeration(),M.sourceCache._source.tileSize);ce=-1;const ft=W.TRIANGLES;for(const Nt of z){const rt=B.getTile(Nt),$e=ji.disabled,dt=M.prevTerrainTileForTile[Nt.key],ot=M.terrainTileForTile[Nt.key];Jp(dt,ot)&&jc.newMorphing(Nt.key,dt,ot,V,250),uh(D,rt.emissiveTexture),Q.activeTexture.set(W.TEXTURE0),rt.texture&&rt.texture.bind(W.LINEAR,W.CLAMP_TO_EDGE);const Ct=jc.getMorphValuesForProxy(Nt.key),Rt=Ct?1:0;Ct&&Object.assign(Qe,{morphing:{srcDemTile:Ct.from,dstDemTile:Ct.to,phase:o.dD(Ct.phase)}});const Ut=o.dG(Nt.canonical),kt=o.dH(Ut.getCenter().lat),Mt=o.dI(Nt.canonical,Ut,kt,at.worldSize/at._pixelsPerMercatorPixel),ei=o.bk(o.dJ(Nt.canonical)),Qt=D.emissiveMode==="mrt-fallback"?1:0,Wt=qf(at.expandedFarZProjMatrix,Ye,Oe,ei,o.aj(at.zoom),Ee,at.frustumCorners.TL,at.frustumCorners.TR,at.frustumCorners.BR,at.frustumCorners.BL,at.globeCenterInViewSpace,at.globeRadius,qe,nt,at._farZ,Qt,Mt);if(fe(Nt,Rt),J&&(M.setupElevationDraw(rt,J,Qe),D.uploadCommonUniforms(Q,J,Nt.toUnwrapped()),Se)){const[Kt,gi,Ci]=Se.getGridBuffers(kt,nt!==0);J.draw(D,ft,De,$e,Fe,Ai.backCCW,Wt,"globe_raster",Kt,gi,Ci)}}}if(Se&&(D.renderDefaultNorthPole||D.renderDefaultSouthPole)){const at=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];xe&&at.push("CUSTOM_ANTIALIASING"),J=D.getOrCreateProgram("globeRaster",{defines:at});for(const nt of z){const{x:ft,y:Nt,z:rt}=nt.canonical,$e=Nt===0,dt=Nt===(1<<rt)-1,[ot,Ct,Rt,Ut]=Se.getPoleBuffers(rt,!1);if(Ut&&($e||dt)){const kt=B.getTile(nt);uh(D,kt.emissiveTexture),Q.activeTexture.set(W.TEXTURE0),kt.texture&&kt.texture.bind(W.LINEAR,W.CLAMP_TO_EDGE);let Mt=o.dK(rt,ft,_e);const ei=o.bk(o.dJ(nt.canonical)),Qt=D.emissiveMode==="mrt-fallback"?1:0,Wt=(Kt,gi)=>Kt.draw(D,W.TRIANGLES,De,ji.disabled,Fe,Ai.disabled,qf(_e.expandedFarZProjMatrix,Mt,Mt,ei,0,Ee,_e.frustumCorners.TL,_e.frustumCorners.TR,_e.frustumCorners.BR,_e.frustumCorners.BL,_e.globeCenterInViewSpace,_e.globeRadius,qe,0,_e._farZ,Qt),"globe_pole_raster",gi,Rt,Ut);M.setupElevationDraw(kt,J,Qe),D.uploadCommonUniforms(Q,J,nt.toUnwrapped()),$e&&D.renderDefaultNorthPole&&Wt(J,ot),dt&&D.renderDefaultSouthPole&&(Mt=o.cS(o.bC(),Mt,[1,-1,1]),Wt(J,Ct))}}}})(_,b,S,A,E);else{const D=_.context,M=D.gl;let B,z;const V=_.shadowRenderer,Q=dl(_,_.longestCutoffRange),W=Fe=>{if(z===Fe)return;const De=[];De.push($f[Fe]),Q.shouldRenderCutoff&&De.push("RENDER_CUTOFF"),V&&(De.push("RENDER_SHADOWS","DEPTH_TEXTURE"),V.useNormalOffset&&De.push("NORMAL_OFFSET")),B=_.getOrCreateProgram("terrainRaster",{defines:De}),z=Fe},J=_.colorModeForRenderPass(),ce=new si(M.LEQUAL,si.ReadWrite,_.depthRangeFor3D);jc.update(E);const _e=_.transform,xe=Gf(_e.zoom,b.exaggeration(),b.sourceCache._source.tileSize);let fe=[0,0,0];if(V){const Fe=_.style.directionalLight,De=_.style.ambientLight;Fe&&De&&(fe=hl(_.style,Fe,De))}{z=-1;const Fe=M.TRIANGLES,[De,Oe]=[b.gridIndexBuffer,b.gridSegments];for(const Ee of A){const Se=S.getTile(Ee),qe=ji.disabled,Ye=b.prevTerrainTileForTile[Ee.key],Qe=b.terrainTileForTile[Ee.key];Jp(Ye,Qe)&&jc.newMorphing(Ee.key,Ye,Qe,E,250),uh(_,Se.emissiveTexture),D.activeTexture.set(M.TEXTURE0),Se.texture&&Se.texture.bind(M.LINEAR,M.CLAMP_TO_EDGE);const at=jc.getMorphValuesForProxy(Ee.key),nt=at?1:0;let ft;at&&(ft={morphing:{srcDemTile:at.from,dstDemTile:at.to,phase:o.dD(at.phase)}});const Nt=_.emissiveMode==="mrt-fallback"?1:0,rt=Uo(Ee.projMatrix,Cx(Ee.canonical,_e.renderWorldCopies)?xe/10:xe,fe,Nt);if(W(nt),!B)continue;b.setupElevationDraw(Se,B,ft);const $e=Ee.toUnwrapped();V&&V.setupShadows($e,B),_.uploadCommonUniforms(D,B,$e,null,Q),B.draw(_,Fe,ce,qe,J,Ai.backCCW,rt,"terrain_raster",b.gridBuffer,De,Oe)}}}}(d,this,this.proxySourceCache,s,this._updateTimestamp),this.renderingToTexture=!0,d.gpuTimingDeferredRenderEnd(),s.splice(0,s.length))}renderBatch(s){if(this._drapedRenderBatches.length===0)return s+1;this.renderingToTexture=!0;const d=this.painter,f=this.painter.context,_=this.proxySourceCache,b=this.proxiedCoords[_.id],S=this._drapedRenderBatches.shift(),A=d.style.order,E=[];this._updateFBOs(d.emissiveMode==="mrt-fallback");let D=0;for(const M of b){const B=_.getTileByID(M.proxyTileKey),z=_.proxyCachedFBO[M.key]?_.proxyCachedFBO[M.key][s]:void 0,V=z!==void 0?_.renderCache[z]:this.pool[D++],Q=z!==void 0;if(B.texture=V.tex,B.emissiveTexture=V.emissiveTex,Q&&!V.dirty){E.push(B.tileID);continue}f.bindFramebuffer.set(V.fb.framebuffer);const W=f.gl;let J;W.drawBuffers(d.emissiveMode==="mrt-fallback"?[W.COLOR_ATTACHMENT0,W.COLOR_ATTACHMENT1]:[W.COLOR_ATTACHMENT0]),this.renderedToTile=!1,V.dirty&&(f.clear({color:o.ao.transparent,stencil:0}),V.dirty=!1);for(let ce=S.start;ce<=S.end;++ce){const _e=d.style._mergedLayers[A[ce]];if(_e.isHidden(d.transform.zoom))continue;const xe=d.style.getLayerSourceCache(_e),fe=xe?this.proxyToSource[M.key][xe.id]:[M];if(!fe)continue;const Fe=fe;f.viewport.set([0,0,V.fb.width,V.fb.height]),J!==(xe?xe.id:null)&&(this._setupStencil(V,fe,_e,xe),J=xe?xe.id:null),d.renderLayer(d,xe,_e,Fe)}if(W.drawBuffers([W.COLOR_ATTACHMENT0]),this._drapedRenderBatches.length===0)for(const ce of this._pendingGroundEffectLayers){const _e=d.style._mergedLayers[A[ce]];if(_e.isHidden(d.transform.zoom))continue;const xe=d.style.getLayerSourceCache(_e),fe=xe?this.proxyToSource[M.key][xe.id]:[M];if(!fe)continue;const Fe=fe;f.viewport.set([0,0,V.fb.width,V.fb.height]),J!==(xe?xe.id:null)&&(this._setupStencil(V,fe,_e,xe),J=xe?xe.id:null),d.renderLayer(d,xe,_e,Fe)}this.renderedToTile?(V.dirty=!0,E.push(B.tileID)):Q||--D,D===5&&(D=0,this.renderToBackBuffer(E))}return this.renderToBackBuffer(E),this.renderingToTexture=!1,f.bindFramebuffer.set(null),f.viewport.set([0,0,d.width,d.height]),S.end+1}postRender(){}isLayerOrderingCorrect(s){const d=s.order.length;let f=-1,_=d;for(let b=0;b<d;++b)this._style.isLayerDraped(s._mergedLayers[s.order[b]])?f=Math.max(f,b):_=Math.min(_,b);return _>f}getMinElevationBelowMSL(){let s=0;return this._visibleDemTiles.filter(d=>d.dem).forEach(d=>{s=Math.min(s,d.dem.tree.minimums[0])}),s===0?s:(s-30)*this._exaggeration}raycast(s,d,f){if(!this._visibleDemTiles)return null;const _=this._visibleDemTiles.filter(b=>b.dem).map(b=>{const S=b.tileID,A=1<<S.overscaledZ,{x:E,y:D}=S.canonical,M=E/A,B=(E+1)/A,z=D/A,V=(D+1)/A;return{minx:M,miny:z,maxx:B,maxy:V,t:b.dem.tree.raycastRoot(M,z,B,V,s,d,f),tile:b}});_.sort((b,S)=>(b.t!==null?b.t:Number.MAX_VALUE)-(S.t!==null?S.t:Number.MAX_VALUE));for(const b of _){if(b.t==null)return null;const S=b.tile.dem.tree.raycast(b.minx,b.miny,b.maxx,b.maxy,s,d,f);if(S!=null)return S}return null}_createFBO(){const s=this.painter.context,d=s.gl,f=this.drapeBufferSize;s.activeTexture.set(d.TEXTURE0);const _=new o.T(s,{width:f[0],height:f[1],data:null},d.RGBA8);_.bind(d.LINEAR,d.CLAMP_TO_EDGE);const b=s.createFramebuffer(f[0],f[1],1,null);let S;return b.colorAttachment0.set(_.texture),this._emissiveTexture&&(S=new o.T(s,{width:f[0],height:f[1],data:null},d.R8),S.bind(d.LINEAR,d.CLAMP_TO_EDGE),b.createColorAttachment(s,1),b.colorAttachment1.set(S.texture)),b.depthAttachment=new bb(s,b.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=s.createRenderbuffer(s.gl.DEPTH_STENCIL,f[0],f[1]),this._stencilRef=0,b.depthAttachment.set(this._sharedDepthStencil),s.clear({stencil:0})):b.depthAttachment.set(this._sharedDepthStencil),s.extTextureFilterAnisotropic&&d.texParameterf(d.TEXTURE_2D,s.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,s.extTextureFilterAnisotropicMax),{fb:b,tex:_,emissiveTex:S,dirty:!1}}_updateFBOs(s){if(this._emissiveTexture!==s){for(const d of this.pool)this._updateFBO(d,s);for(const d of this.proxySourceCache.renderCache)this._updateFBO(d,s);this._emissiveTexture=s}}_updateFBO(s,d){const f=s.fb,_=this.painter.context,b=_.gl,S=this.drapeBufferSize;if(d){const A=new o.T(_,{width:S[0],height:S[1],data:null},b.R8);A.bind(b.LINEAR,b.CLAMP_TO_EDGE),s.emissiveTex=A,f.createColorAttachment(_,1),f.colorAttachment1.set(A.texture)}else s.emissiveTex=void 0,f.removeColorAttachment(_,1);s.dirty=!0}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(const s in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[s].hasTransition())return!0;return this._style.order.some(s=>{const d=this._style._mergedLayers[s],f=d.isHidden(this.painter.transform.zoom);return d.type==="hillshade"||d.type==="custom"?!f&&d.shouldRedrape():!f&&d.hasTransition()})}_clearLineLayersFromRenderCache(){let s=!1;for(const f of this._style.getSources())if(f instanceof Xs){s=!0;break}if(!s)return;const d={};for(let f=0;f<this._style.order.length;++f){const _=this._style._mergedLayers[this._style.order[f]],b=this._style.getLayerSourceCache(_);if(!b||d[b.id]||_.isHidden(this.painter.transform.zoom)||_.type!=="line")continue;const S=_.widthExpression(),A=_.emissiveStrengthExpression();if(S instanceof o.ad||A instanceof o.ad){d[b.id]=!0;for(const E of this.proxyCoords){const D=this.proxyToSource[E.key][b.id];if(D)for(const M of D)this._clearRenderCacheForTile(b.id,M)}}}}_clearRasterLayersFromRenderCache(){let s=!1;for(const f in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[f]._source instanceof Ms){s=!0;break}if(!s)return;const d={};for(let f=0;f<this._style.order.length;++f){const _=this._style._mergedLayers[this._style.order[f]],b=this._style.getLayerSourceCache(_);if(!b||d[b.id]||_.isHidden(this.painter.transform.zoom)||_.type!=="raster")continue;const S=_.paint.get("raster-fade-duration");for(const A of this.proxyCoords){const E=this.proxyToSource[A.key][b.id];if(E)for(const D of E){const M=tm(b.getTile(D),b.findLoadedParent(D,0),b,this.painter.transform,S);(M.opacity!==1||M.mix!==0)&&this._clearRenderCacheForTile(b.id,D)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();const s=this._style.order,d=s.length;if(d===0)return;const f=[];this._pendingGroundEffectLayers=[];let _,b=0,S=this._style._mergedLayers[s[b]];for(;!this._style.isLayerDraped(S)&&S.isHidden(this.painter.transform.zoom)&&++b<d;)S=this._style._mergedLayers[s[b]];for(;b<d;++b){const A=this._style._mergedLayers[s[b]];A.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(A)?_===void 0&&(_=b):(A.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(b),_!==void 0&&(f.push({start:_,end:b-1}),_=void 0)))}if(_!==void 0&&f.push({start:_,end:b-1}),f.length!==0){const A=f[f.length-1];this._pendingGroundEffectLayers.every(E=>E>A.end)||o.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=f}_setupRenderCache(s){const d=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,d.renderCache.length>d.renderCachePool.length){const S=Object.values(d.proxyCachedFBO);d.proxyCachedFBO={};for(let A=0;A<S.length;++A){const E=Object.values(S[A]);d.renderCachePool.push(...E)}}return}this._clearRasterLayersFromRenderCache();const f=this.proxyCoords,_=this._tilesDirty;for(let S=f.length-1;S>=0;S--){const A=f[S];if(d.getTileByID(A.key),d.proxyCachedFBO[A.key]!==void 0){const E=s[A.key],D=this.proxyToSource[A.key];let M=0;for(const B in D){const z=D[B],V=E[B];if(!V||V.length!==z.length||z.some((Q,W)=>Q!==V[W]||_[B]&&_[B].hasOwnProperty(Q.key))){M=-1;break}++M}for(const B in d.proxyCachedFBO[A.key])d.renderCache[d.proxyCachedFBO[A.key][B]].dirty=M<0||M!==Object.values(E).length}}const b=[...this._drapedRenderBatches];b.sort((S,A)=>A.end-A.start-(S.end-S.start));for(const S of b)for(const A of f){if(d.proxyCachedFBO[A.key])continue;let E=d.renderCachePool.pop();E===void 0&&d.renderCache.length<50&&(E=d.renderCache.length,d.renderCache.push(this._createFBO())),E!==void 0&&(d.proxyCachedFBO[A.key]={},d.proxyCachedFBO[A.key][S.start]=E,d.renderCache[E].dirty=!0)}this._tilesDirty={}}_setupStencil(s,d,f,_){if(!_||!this._sourceTilesOverlap[_.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const b=this.painter.context,S=b.gl;if(d.length<=1)return void(this._overlapStencilType=!1);let A;if(f.isTileClipped())A=d.length,this._overlapStencilMode.test={func:S.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(d[0].overscaledZ>d[d.length-1].overscaledZ))return void(this._overlapStencilType=!1);A=1,this._overlapStencilMode.test={func:S.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+A>255&&(b.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=A,this._overlapStencilMode.ref=this._stencilRef,f.isTileClipped()&&this._renderTileClippingMasks(d,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(s){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[s.key]),this._overlapStencilMode):ji.disabled}_renderTileClippingMasks(s,d){const f=this.painter,_=this.painter.context,b=_.gl;f._tileClippingMaskIDs={},_.setColorMode(Di.disabled),_.setDepthMode(si.disabled);const S=f.getOrCreateProgram("clippingMask");for(const A of s){const E=f._tileClippingMaskIDs[A.key]=--d;S.draw(f,b.TRIANGLES,si.disabled,new ji({func:b.ALWAYS,mask:0},E,255,b.KEEP,b.KEEP,b.REPLACE),Di.disabled,Ai.disabled,em(A.projMatrix),"$clipping",f.tileExtentBuffer,f.quadTriangleIndexBuffer,f.tileExtentSegments)}}pointCoordinate(s){const d=this.painter.transform;if(s.x<0||s.x>d.width||s.y<0||s.y>d.height)return null;const f=[s.x,s.y,1,1];o.aC(f,f,d.pixelMatrixInverse),o.cK(f,f,1/f[3]),f[0]/=d.worldSize,f[1]/=d.worldSize;const _=d._camera.position,b=o.cf(1,d.center.lat),S=[_[0],_[1],_[2]/b,0],A=o.da([],f.slice(0,3),S);o.aw(A,A);const E=this.raycast(S,A,this._exaggeration);return E!==null&&E?(o.bH(S,S,A,E),S[3]=S[2],S[2]*=b,S):null}_setupProxiedCoordsForOrtho(s,d,f){if(s.getSource()instanceof o.aU)return this._setupProxiedCoordsForImageSource(s,d,f);this._findCoveringTileCache[s.id]=this._findCoveringTileCache[s.id]||{};const _=this.proxiedCoords[s.id]=[],b=this.proxyCoords;for(let E=0;E<b.length;E++){const D=b[E],M=this._findTileCoveringTileID(D,s);if(M){const B=this._createProxiedId(D,M,f[D.key]&&f[D.key][s.id]);_.push(B),this.proxyToSource[D.key][s.id]=[B]}}let S=!1;const A=new Set;for(let E=0;E<d.length;E++){const D=s.getTile(d[E]);if(!D||!D.hasData())continue;const M=this._findTileCoveringTileID(D.tileID,this.proxySourceCache);if(M&&M.tileID.canonical.z!==D.tileID.canonical.z){const B=this.proxyToSource[M.tileID.key][s.id],z=this._createProxiedId(M.tileID,D,f[M.tileID.key]&&f[M.tileID.key][s.id]);B?B.splice(B.length-1,0,z):this.proxyToSource[M.tileID.key][s.id]=[z];const V=this.proxyToSource[M.tileID.key][s.id];A.has(V)||A.add(V),_.push(z),S=!0}}if(this._sourceTilesOverlap[s.id]=S,S&&this._debugParams.sortTilesHiZFirst)for(const E of A)E.sort((D,M)=>M.overscaledZ-D.overscaledZ)}_setupProxiedCoordsForImageSource(s,d,f){if(!s.getSource().loaded())return;const _=this.proxiedCoords[s.id]=[],b=this.proxyCoords,S=s.getSource(),A=S.tileID;if(!A)return;const E=new o.P(A.x,A.y)._div(1<<A.z),D=S.coordinates.map(o.ae.fromLngLat).reduce((B,z)=>(B.min.x=Math.min(B.min.x,z.x-E.x),B.min.y=Math.min(B.min.y,z.y-E.y),B.max.x=Math.max(B.max.x,z.x-E.x),B.max.y=Math.max(B.max.y,z.y-E.y),B),{min:new o.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new o.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),M=(B,z)=>{const V=B.wrap+B.canonical.x/(1<<B.canonical.z),Q=B.canonical.y/(1<<B.canonical.z),W=o.al/(1<<B.canonical.z),J=z.wrap+z.canonical.x/(1<<z.canonical.z),ce=z.canonical.y/(1<<z.canonical.z);return V+W<J+D.min.x||V>J+D.max.x||Q+W<ce+D.min.y||Q>ce+D.max.y};for(let B=0;B<b.length;B++){const z=b[B];for(let V=0;V<d.length;V++){const Q=s.getTile(d[V]);if(!Q||!Q.hasData()||M(z,Q.tileID))continue;const W=this._createProxiedId(z,Q,f[z.key]&&f[z.key][s.id]),J=this.proxyToSource[z.key][s.id];J?J.push(W):this.proxyToSource[z.key][s.id]=[W],_.push(W)}}}_createProxiedId(s,d,f){let _=this.orthoMatrix;if(f){const b=f.find(S=>S.key===d.tileID.key);if(b)return b}if(d.tileID.key!==s.key){const b=s.canonical.z-d.tileID.canonical.z;let S,A,E;_=o.bC();const D=d.tileID.wrap-s.wrap<<s.overscaledZ;b>0?(S=o.al>>b,A=S*((d.tileID.canonical.x<<b)-s.canonical.x+D),E=S*((d.tileID.canonical.y<<b)-s.canonical.y)):(S=o.al<<-b,A=o.al*(d.tileID.canonical.x-(s.canonical.x+D<<-b)),E=o.al*(d.tileID.canonical.y-(s.canonical.y<<-b))),o.ce(_,0,S,0,S,0,1),o.br(_,_,[A,E,0])}return new Ix(d.tileID,s.key,_)}_findTileCoveringTileID(s,d){let f=d.getTile(s);if(f&&f.hasData())return f;const _=this._findCoveringTileCache[d.id],b=_[s.key];if(f=b?d.getTileByID(b):null,f&&f.hasData()||b===null)return f;let S=f?f.tileID:s,A=S.overscaledZ;const E=d.getSource().minzoom,D=[];if(!b){const B=d.getSource().maxzoom;if(s.canonical.z>=B){const z=s.canonical.z-B;d.getSource().reparseOverscaled?(A=Math.max(s.canonical.z+2,d.transform.tileZoom),S=new o.aQ(A,s.wrap,B,s.canonical.x>>z,s.canonical.y>>z)):z!==0&&(A=B,S=new o.aQ(A,s.wrap,B,s.canonical.x>>z,s.canonical.y>>z))}S.key!==s.key&&(D.push(S.key),f=d.getTile(S))}const M=B=>{D.forEach(z=>{_[z]=B}),D.length=0};for(A-=1;A>=E&&(!f||!f.hasData());A--){f&&M(f.tileID.key);const B=S.calculateScaledKey(A);if(f=d.getTileByID(B),f&&f.hasData())break;const z=_[B];if(z===null)break;z===void 0?D.push(B):f=d.getTileByID(z)}return M(f?f.tileID.key:null),f&&f.hasData()?f:null}findDEMTileFor(s){return this.enabled?this._findTileCoveringTileID(s,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(s,d){let f=this._tilesDirty[s];f||(f=this._tilesDirty[s]={}),f[d.key]=!0}}function dh(m,s,d){const f=function(A,E,D){const M=o.bJ(E,A),B=o.bJ(D,[.2126,.7152,.0722]),z=(Q,W,J)=>(1-J)*Q+J*W,V=z(1-.3*Math.min(B,1),1,Math.min(M+1,1));return z(.92,1,Math.asin(o.aA(E[2],-1,1))/Math.PI+.5)*V}(m,[0,0,1],s),_=[0,0,0];o.c5(_,d.slice(0,3),f);const b=[0,0,0];o.c5(b,s.slice(0,3),m[2]);const S=[0,0,0];return o.d8(S,_,b),o.db(S)}const nN=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],sN=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","building","buildingBloom","elevatedStructures","model","symbol"];class wb{static cacheKey(s,d,f,_){const b=[d];_&&b.push(_.cacheKey);for(const S of f)s.usedDefines.has(S)&&b.push(S);return b.join("/")}constructor(s,d,f,_,b,S){const A=s.gl;this.program=A.createProgram(),this.configuration=_,this.name=d,this.fixedDefines=[...S];const E=`#version 300 es
${(_?_.defines():[]).concat(S.map(W=>`#define ${W}`)).join(`
`)}`,D=[E,XT];for(const W of f.fragmentIncludes)D.push(pu[W]);D.push(f.fragmentSource);const M=D.join(`
`),B=[E,hb];for(const W of f.vertexIncludes)B.push(pu[W]);this.forceManualRenderingForInstanceIDShaders=s.forceManualRenderingForInstanceIDShaders&&f.vertexSource.includes("gl_InstanceID"),this.forceManualRenderingForInstanceIDShaders&&B.push("uniform int u_instanceID;"),B.push(f.vertexSource);let z=B.join(`
`);this.forceManualRenderingForInstanceIDShaders&&(z=z.replaceAll("gl_InstanceID","u_instanceID"));const V=A.createShader(A.FRAGMENT_SHADER);if(A.isContextLost())return void(this.failedToCreate=!0);A.shaderSource(V,M),A.compileShader(V),A.attachShader(this.program,V);const Q=A.createShader(A.VERTEX_SHADER);A.isContextLost()?this.failedToCreate=!0:(A.shaderSource(Q,z),A.compileShader(Q),A.attachShader(this.program,Q),this.attributes={},A.linkProgram(this.program),A.deleteShader(Q),A.deleteShader(V),this.fixedUniforms=b(s),this.fixedUniformsEntries=Object.entries(this.fixedUniforms),this.binderUniforms=_?_.getUniforms(s):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(W=>({u_instanceID:new o.ch(W)}))(s)),(S.includes("TERRAIN")||d.includes("symbol")||d.includes("circle"))&&(this.terrainUniforms=(W=>({u_dem:new o.ch(W),u_dem_prev:new o.ch(W),u_dem_tl:new o.ck(W),u_dem_scale:new o.cj(W),u_dem_tl_prev:new o.ck(W),u_dem_scale_prev:new o.cj(W),u_dem_size:new o.cj(W),u_dem_lerp:new o.cj(W),u_exaggeration:new o.cj(W),u_depth:new o.ch(W),u_depth_size_inv:new o.ck(W),u_depth_range_unpack:new o.ck(W),u_occluder_half_size:new o.cj(W),u_occlusion_depth_offset:new o.cj(W),u_meter_to_dem:new o.cj(W),u_label_plane_matrix_inv:new o.cl(W)}))(s)),S.includes("GLOBE")&&(this.globeUniforms=(W=>({u_tile_tl_up:new o.ci(W),u_tile_tr_up:new o.ci(W),u_tile_br_up:new o.ci(W),u_tile_bl_up:new o.ci(W),u_tile_up_scale:new o.cj(W)}))(s)),S.includes("FOG")&&(this.fogUniforms=(W=>({u_fog_matrix:new o.cl(W),u_fog_range:new o.ck(W),u_fog_color:new o.d3(W),u_fog_horizon_blend:new o.cj(W),u_fog_vertical_limit:new o.ck(W),u_fog_temporal_offset:new o.cj(W),u_frustum_tl:new o.ci(W),u_frustum_tr:new o.ci(W),u_frustum_br:new o.ci(W),u_frustum_bl:new o.ci(W),u_globe_pos:new o.ci(W),u_globe_radius:new o.cj(W),u_globe_transition:new o.cj(W),u_is_globe:new o.ch(W),u_viewport:new o.ck(W)}))(s)),S.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(W=>({u_cutoff_params:new o.d3(W)}))(s)),S.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(W=>({u_lighting_ambient_color:new o.ci(W),u_lighting_directional_dir:new o.ci(W),u_lighting_directional_color:new o.ci(W),u_ground_radiance:new o.ci(W)}))(s)),S.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(W=>({u_light_matrix_0:new o.cl(W),u_light_matrix_1:new o.cl(W),u_fade_range:new o.ck(W),u_shadow_normal_offset:new o.ci(W),u_shadow_intensity:new o.cj(W),u_shadow_texel_size:new o.cj(W),u_shadow_map_resolution:new o.cj(W),u_shadow_direction:new o.ci(W),u_shadow_bias:new o.ci(W),u_shadowmap_0:new o.ch(W),u_shadowmap_1:new o.ch(W)}))(s)))}getAttributeLocation(s,d){let f=this.attributes[d];return f===void 0&&(f=this.attributes[d]=s.getAttribLocation(this.program,d)),f}setTerrainUniformValues(s,d){if(!this.terrainUniforms)return;const f=this.terrainUniforms;if(!this.failedToCreate){s.program.set(this.program);for(const _ in d)f[_]&&f[_].set(this.program,_,d[_])}}setGlobeUniformValues(s,d){if(!this.globeUniforms)return;const f=this.globeUniforms;if(!this.failedToCreate){s.program.set(this.program);for(const _ in d)f[_]&&f[_].set(this.program,_,d[_])}}setFogUniformValues(s,d){if(!this.fogUniforms)return;const f=this.fogUniforms;if(!this.failedToCreate){s.program.set(this.program);for(const _ in d)f[_].set(this.program,_,d[_])}}setCutoffUniformValues(s,d){if(!this.cutoffUniforms)return;const f=this.cutoffUniforms;if(!this.failedToCreate){s.program.set(this.program);for(const _ in d)f[_].set(this.program,_,d[_])}}setLightsUniformValues(s,d){if(!this.lightsUniforms)return;const f=this.lightsUniforms;if(!this.failedToCreate){s.program.set(this.program);for(const _ in d)f[_].set(this.program,_,d[_])}}setShadowUniformValues(s,d){if(this.failedToCreate||!this.shadowUniforms)return;const f=this.shadowUniforms;s.program.set(this.program);for(const _ in d)f[_].set(this.program,_,d[_])}_drawDebugWireframe(s,d,f,_,b,S,A,E,D,M){const B=s.options.wireframe;if(B.terrain===!1&&B.layers2D===!1&&B.layers3D===!1)return;const z=s.context;if(!(!(!B.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!B.layers2D||s._terrain&&s._terrain.renderingToTexture||!nN.includes(this.name))||!(!B.layers3D||!sN.includes(this.name))))return;const V=z.gl,Q=s.wireframeDebugCache.getLinesFromTrianglesBuffer(s.frameCounter,b,z);if(!Q)return;const W=[...this.fixedDefines,"DEBUG_WIREFRAME"],J=s.getOrCreateProgram(this.name,{config:this.configuration,defines:W});z.program.set(J.program);const ce=(fe,Fe,De)=>{if(Fe[fe]&&De[fe])for(const Oe in Fe[fe])De[fe][Oe]&&De[fe][Oe].set(De.program,Oe,Fe[fe][Oe].current)};D&&D.setUniforms(J.program,z,J.binderUniforms,A,{zoom:E}),ce("fixedUniforms",this,J),ce("terrainUniforms",this,J),ce("globeUniforms",this,J),ce("fogUniforms",this,J),ce("lightsUniforms",this,J),ce("shadowUniforms",this,J),Q.bind(),z.setColorMode(new Di([V.ONE,V.ONE_MINUS_SRC_ALPHA,V.ZERO,V.ONE],o.ao.transparent,[!0,!0,!0,!1])),z.setDepthMode(new si(d.func===V.LESS?V.LEQUAL:d.func,si.ReadOnly,d.range)),z.setStencilMode(ji.disabled);const _e=3*S.primitiveLength*2,xe=3*S.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){const fe=M||1;for(let Fe=0;Fe<fe;++Fe)J.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",Fe),V.drawElements(V.LINES,_e,V.UNSIGNED_SHORT,xe)}else M&&M>1?V.drawElementsInstanced(V.LINES,_e,V.UNSIGNED_SHORT,xe,M):V.drawElements(V.LINES,_e,V.UNSIGNED_SHORT,xe);b.bind(),z.program.set(this.program),z.setDepthMode(d),z.setStencilMode(f),z.setColorMode(_)}checkUniforms(s,d,f){if(this.fixedDefines.includes(d)){for(const _ of Object.keys(f))if(!f[_].initialized)throw new Error(`Program '${this.name}', from draw '${s}': uniform ${_} not set but required by ${d} being defined`)}}draw(s,d,f,_,b,S,A,E,D,M,B,z,V,Q,W,J){const ce=s.context,_e=ce.gl;if(this.failedToCreate)return;ce.program.set(this.program),ce.setDepthMode(f),ce.setStencilMode(_),ce.setColorMode(b),ce.setCullFace(S);for(const[Ee,Se]of this.fixedUniformsEntries)Se.set(this.program,Ee,A[Ee]);Q&&Q.setUniforms(this.program,ce,this.binderUniforms,z,{zoom:V});const xe={[_e.POINTS]:1,[_e.LINES]:2,[_e.TRIANGLES]:3,[_e.LINE_STRIP]:1}[d];this.checkUniforms(E,"RENDER_SHADOWS",this.shadowUniforms);const fe=W||[],Fe=Q?Q.getPaintVertexBuffers():[],De=d===_e.TRIANGLES&&M,Oe=J&&J>0?1:void 0;for(const Ee of B.get()){const Se=Ee.vaos||(Ee.vaos={});if((Se[E]||(Se[E]=new YT)).bind(ce,this,D,Fe,M,Ee.vertexOffset,fe,Oe),this.forceManualRenderingForInstanceIDShaders){const qe=J||1;for(let Ye=0;Ye<qe;++Ye)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",Ye),M?_e.drawElements(d,Ee.primitiveLength*xe,_e.UNSIGNED_SHORT,Ee.primitiveOffset*xe*2):_e.drawArrays(d,Ee.vertexOffset,Ee.vertexLength)}else J&&J>1?_e.drawElementsInstanced(d,Ee.primitiveLength*xe,_e.UNSIGNED_SHORT,Ee.primitiveOffset*xe*2,J):M?_e.drawElements(d,Ee.primitiveLength*xe,_e.UNSIGNED_SHORT,Ee.primitiveOffset*xe*2):_e.drawArrays(d,Ee.vertexOffset,Ee.vertexLength);De&&this._drawDebugWireframe(s,f,_,b,M,Ee,z,V,Q,J)}}}function Sb(m,s,d=0){const f=Math.pow(2,s.tileID.overscaledZ),_=s.tileSize*Math.pow(2,m.transform.tileZoom)/f,b=_*(s.tileID.canonical.x+s.tileID.wrap*f),S=_*s.tileID.canonical.y;return{u_image:0,u_texsize:s.imageAtlasTexture?s.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/o.ay(s,1,m.transform.tileZoom),u_pixel_coord_upper:[b>>16,S>>16],u_pixel_coord_lower:[65535&b,65535&S],u_pattern_transition:d}}const Wf={terrain:0,flat:1},aN=o.bC(),Zf=(m,s,d,f,_,b,S,A,E,D,M,B,z,V,Q,W,J,ce)=>{const _e=s.style.light,xe=_e.properties.get("position"),fe=[xe.x,xe.y,xe.z],Fe=o.dO();_e.properties.get("anchor")==="viewport"&&(o.dP(Fe,-s.transform.angle),o.dQ(fe,fe,Fe));const De=_e.properties.get("color").toPremultipliedRenderColor(null),Oe=s.transform,Ee={u_matrix:m,u_lightpos:fe,u_lightintensity:_e.properties.get("intensity"),u_lightcolor:[De.r,De.g,De.b],u_vertical_gradient:+d,u_opacity:f,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:aN,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:Wf[D],u_base_type:Wf[M],u_ao:_,u_edge_radius:b,u_width_scale:S,u_flood_light_color:Q,u_vertical_scale:W,u_flood_light_intensity:J,u_ground_shadow_factor:ce};return Oe.projection.name==="globe"&&(Ee.u_tile_id=[A.canonical.x,A.canonical.y,1<<A.canonical.z],Ee.u_zoom_transition=B,Ee.u_inv_rot_matrix=V,Ee.u_merc_center=z,Ee.u_up_dir=Oe.projection.upVector(new o.cD(0,0,0),z[0]*o.al,z[1]*o.al),Ee.u_height_lift=E),Ee},jx=(m,s,d,f,_,b)=>({u_matrix:m,u_edge_radius:s,u_width_scale:d,u_vertical_scale:f,u_height_type:Wf[_],u_base_type:Wf[b]}),Tb=(m,s,d,f,_,b,S,A,E,D,M,B,z,V,Q,W,J,ce)=>{const _e=Zf(m,s,d,f,_,b,S,A,D,M,B,z,V,Q,W,J,1,[0,0,0]),xe={u_height_factor:-Math.pow(2,A.overscaledZ)/E.tileSize/8};return Object.assign(_e,Sb(s,E,ce),xe)},ud=(m,s,d)=>({u_matrix:m,u_emissive_strength:s,u_ground_shadow_factor:d}),Rx=(m,s,d,f,_,b=0)=>Object.assign(ud(m,s,_),Sb(d,f,b)),Nb=(m,s,d,f)=>({u_matrix:m,u_world:d,u_emissive_strength:s,u_ground_shadow_factor:f}),Ab=(m,s,d,f,_,b,S=0)=>Object.assign(Rx(m,s,d,f,b,S),{u_world:_}),kx=(m,s)=>({u_matrix:m,u_depth_bias:s}),fu=(m,s)=>({u_matrix:m,u_ground_shadow_factor:s}),dd=(m,s,d,f,_)=>({u_matrix:m,u_camera_pos:[s[0],s[1],s[2]],u_depth_bias:d,u_height_scale:f,u_reset_depth:_}),Xf=(m,s,d,f,_,b,S,A,E)=>({u_matrix:m,u_normal_matrix:s,u_opacity:d,u_faux_facade_ao_intensity:f,u_camera_pos:_,u_tile_to_meter:b,u_facade_emissive_chance:S,u_flood_light_color:A,u_flood_light_intensity:E}),Cb=m=>({u_matrix:m}),gu=m=>({u_matrix:m}),Dx=(m,s,d,f,_,b,S,A)=>{const E=o.al/b.tileSize;return{u_matrix:m,u_inv_rot_matrix:s,u_camera_to_center_distance:d.getCameraToCenterDistance(A),u_extrude_scale:[d.pixelsToGLUnits[0]/E,d.pixelsToGLUnits[1]/E],u_zoom_transition:f,u_tile_id:S,u_merc_center:_}},Yf=(m,s,d,f)=>({u_matrix:m,u_inv_matrix:s,u_camera_to_center_distance:d.getCameraToCenterDistance(f),u_viewport_size:[d.width,d.height]}),Mx=(m,s,d=1)=>({u_matrix:m,u_color:s,u_overlay:0,u_overlay_scale:d}),Eb=o.bC(),Ox=(m,s,d,f,_,b,S)=>{const A=m.transform,E=A.projection.name==="globe",D=E?o.dR(A.zoom,s.canonical)*A._pixelsPerMercatorPixel:o.ay(d,1,b),M={u_matrix:s.projMatrix,u_extrude_scale:D,u_intensity:S,u_inv_rot_matrix:Eb,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(E){M.u_inv_rot_matrix=f,M.u_merc_center=_,M.u_tile_id=[s.canonical.x,s.canonical.y,1<<s.canonical.z],M.u_zoom_transition=o.aj(A.zoom);const B=_[0]*o.al,z=_[1]*o.al;M.u_up_dir=A.projection.upVector(new o.cD(0,0,0),B,z)}return M};function Kf(m,[s,d,f,_],[b,S]){if(b===S)return[0,0,0,0];const A=255*(m-1)/(m*(S-b));return[s*A,d*A,f*A,_*A]}function Ib(m,s,[d,f]){return d===f?0:.5/m+(s-d)*(m-1)/(m*(f-d))}const Lx=(m,s,d,f,_,b,S,A,E,D,M,B,z,V,Q,W,J,ce,_e,xe,fe)=>({u_matrix:m,u_normalize_matrix:s,u_globe_matrix:d,u_merc_matrix:f,u_grid_matrix:_,u_tl_parent:b,u_scale_parent:D,u_fade_t:M.mix,u_opacity:M.opacity*B.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:B.paint.get("raster-brightness-min"),u_brightness_high:B.paint.get("raster-brightness-max"),u_saturation_factor:o.dT(B.paint.get("raster-saturation")),u_contrast_factor:o.dS(B.paint.get("raster-contrast")),u_spin_weights:im(B.paint.get("raster-hue-rotate")),u_perspective_transform:z,u_raster_elevation:V,u_zoom_transition:S,u_merc_center:A,u_cutoff_params:E,u_colorization_mix:Kf(o.dU,W,ce),u_colorization_offset:Ib(o.dU,J,ce),u_color_ramp:Q,u_texture_offset:[xe/(_e+2*xe),_e/(_e+2*xe)],u_texture_res:[_e+2*xe,_e+2*xe],u_emissive_strength:fe});function im(m){m*=Math.PI/180;const s=Math.sin(m),d=Math.cos(m);return[(2*d+1)/3,(-Math.sqrt(3)*s-d+1)/3,(Math.sqrt(3)*s-d+1)/3]}const hh=.05,oN=(m,s,d,f,_,b,S,A,E,D,M,B)=>({u_matrix:m,u_normalize_matrix:s,u_globe_matrix:d,u_merc_matrix:f,u_grid_matrix:_,u_tl_parent:b,u_scale_parent:D,u_fade_t:M.mix,u_opacity:M.opacity,u_image0:0,u_image1:1,u_raster_elevation:B,u_zoom_transition:S,u_merc_center:A,u_cutoff_params:E}),Pb=(m,s,d,f,_,b,S,A,E,D)=>({u_particle_texture:m,u_particle_texture_side_len:s,u_tile_offset:d,u_velocity:f,u_color_ramp:b,u_velocity_res:_,u_max_speed:S,u_uv_offset:A,u_data_scale:[255*E[0],255*E[1]],u_data_offset:D,u_particle_pos_scale:1.1,u_particle_pos_offset:[hh,hh]}),lN=(m,s,d,f,_,b,S,A,E,D)=>({u_particle_texture:m,u_particle_texture_side_len:s,u_velocity:d,u_velocity_res:f,u_max_speed:_,u_speed_factor:b,u_reset_rate:S,u_rand_seed:Math.random(),u_uv_offset:A,u_data_scale:[255*E[0],255*E[1]],u_data_offset:D,u_particle_pos_scale:1.1,u_particle_pos_offset:[hh,hh]}),Qf=o.bC(),rm=(m,s,d,f,_,b,S,A,E,D,M,B,z,V,Q,W,J,ce,_e,xe,fe,Fe,De,Oe)=>{const Ee=_.transform,Se={u_is_size_zoom_constant:+(m==="constant"||m==="source"),u_is_size_feature_constant:+(m==="constant"||m==="camera"),u_size_t:s?s.uSizeT:0,u_size:s?s.uSize:0,u_camera_to_center_distance:Ee.getCameraToCenterDistance(_e),u_rotate_symbol:+d,u_aspect_ratio:Ee.width/Ee.height,u_fade_change:_.options.fadeDuration?_.symbolFadeChange:1,u_matrix:b,u_label_plane_matrix:S,u_coord_matrix:A,u_is_text:+D,u_elevation_from_sea:E?1:0,u_pitch_with_map:+f,u_texsize:M,u_texsize_icon:B,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Qf,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Qf,u_up_vector:[0,-1,0],u_color_adj_mat:Fe,u_icon_transition:De||0,u_gamma_scale:f?_.transform.getCameraToCenterDistance(_e)*Math.cos(_.terrain?0:_.transform._pitch):1,u_device_pixel_ratio:o.o.devicePixelRatio,u_is_halo:1,u_scale_factor:Oe||1,u_ground_shadow_factor:xe,u_inv_matrix:o.bl(o.bC(),S),u_normal_scale:fe,u_lutTexture:10};return _e.name==="globe"&&(Se.u_tile_id=[V.canonical.x,V.canonical.y,1<<V.canonical.z],Se.u_zoom_transition=Q,Se.u_inv_rot_matrix=J,Se.u_merc_center=W,Se.u_camera_forward=Ee._camera.forward(),Se.u_ecef_origin=o.dV(Ee.globeMatrix,V.toUnwrapped()),Se.u_tile_matrix=Float32Array.from(Ee.globeMatrix),Se.u_up_vector=ce),Se},yu=(m,s,d,f)=>({u_matrix:m,u_emissive_strength:s,u_opacity:d,u_color:f}),nm=(m,s,d,f,_,b,S,A,E)=>Object.assign(function(D,M,B,z,V,Q){const{width:W,height:J}=z.imageManager.getPixelSize(M),ce=Math.pow(2,Q.tileID.overscaledZ),_e=Q.tileSize*Math.pow(2,z.transform.tileZoom)/ce,xe=_e*(Q.tileID.canonical.x+Q.tileID.wrap*ce),fe=_e*Q.tileID.canonical.y;return{u_image:0,u_pattern_tl:B.tl,u_pattern_br:B.br,u_texsize:[W,J],u_pattern_size:B.displaySize,u_pattern_units_to_pixels:V?[z.transform.width,-1*z.transform.height]:[1/o.ay(Q,1,z.transform.tileZoom),1/o.ay(Q,1,z.transform.tileZoom)],u_pixel_coord_upper:[xe>>16,fe>>16],u_pixel_coord_lower:[65535&xe,65535&fe]}}(0,b,S,f,A,E),{u_matrix:m,u_emissive_strength:s,u_opacity:d}),hd=new Float32Array(o.bA([])),Jf=(m,s,d,f,_,b,S,A,E,D,M,B,z,V=[0,0,0],Q,W,J)=>{const ce=_.style.light,_e=ce.properties.get("position"),xe=[-_e.x,-_e.y,_e.z],fe=o.dO();ce.properties.get("anchor")==="viewport"&&(o.dP(fe,-_.transform.angle),o.dQ(xe,xe,fe));const Fe=M.alphaMode==="MASK",De=ce.properties.get("color").toNonPremultipliedRenderColor(null),Oe=z.paint.get("model-ambient-occlusion-intensity"),Ee=z.paint.get("model-color").constantOr(o.ao.white).toNonPremultipliedRenderColor(null);return Ee.a=z.paint.get("model-color-mix-intensity").constantOr(0),J&&(Ee.r=J[0],Ee.g=J[1],Ee.b=J[2],Ee.a=J[3]),W&&(Ee.r=W.color.r,Ee.g=W.color.g,Ee.b=W.color.b,Ee.a=W.colorMix,B=W.emissionStrength,b*=W.opacity),{u_matrix:m,u_lighting_matrix:s,u_normal_matrix:d,u_node_matrix:f||hd,u_lightpos:xe,u_lightintensity:ce.properties.get("intensity"),u_lightcolor:[De.r,De.g,De.b],u_camera_pos:V,u_opacity:b,u_baseTextureIsAlpha:0,u_alphaMask:+Fe,u_alphaCutoff:M.alphaCutoff,u_baseColorFactor:S.toNonPremultipliedRenderColor(null).toArray01(),u_emissiveFactor:A.toNonPremultipliedRenderColor(null).toArray01(),u_metallicFactor:E,u_roughnessFactor:D,u_baseColorTexture:5,u_metallicRoughnessTexture:6,u_normalTexture:7,u_occlusionTexture:8,u_emissionTexture:9,u_lutTexture:10,u_color_mix:Ee.toArray01(),u_aoIntensity:Oe,u_emissive_strength:B,u_occlusionTextureTransform:Q||[0,0,0,0]}},sm=(m,s=hd,d=hd)=>({u_matrix:m,u_instance:s,u_node_matrix:d}),eg={fillExtrusion:m=>({u_matrix:new o.cl(m),u_lightpos:new o.ci(m),u_lightintensity:new o.cj(m),u_lightcolor:new o.ci(m),u_vertical_gradient:new o.cj(m),u_opacity:new o.cj(m),u_edge_radius:new o.cj(m),u_width_scale:new o.cj(m),u_ao:new o.ck(m),u_height_type:new o.ch(m),u_base_type:new o.ch(m),u_tile_id:new o.ci(m),u_zoom_transition:new o.cj(m),u_inv_rot_matrix:new o.cl(m),u_merc_center:new o.ck(m),u_up_dir:new o.ci(m),u_height_lift:new o.cj(m),u_flood_light_color:new o.ci(m),u_vertical_scale:new o.cj(m),u_flood_light_intensity:new o.cj(m),u_ground_shadow_factor:new o.ci(m)}),fillExtrusionDepth:m=>({u_matrix:new o.cl(m),u_edge_radius:new o.cj(m),u_width_scale:new o.cj(m),u_vertical_scale:new o.cj(m),u_height_type:new o.ch(m),u_base_type:new o.ch(m)}),fillExtrusionPattern:m=>({u_matrix:new o.cl(m),u_lightpos:new o.ci(m),u_lightintensity:new o.cj(m),u_lightcolor:new o.ci(m),u_vertical_gradient:new o.cj(m),u_height_factor:new o.cj(m),u_edge_radius:new o.cj(m),u_width_scale:new o.cj(m),u_ao:new o.ck(m),u_height_type:new o.ch(m),u_base_type:new o.ch(m),u_tile_id:new o.ci(m),u_zoom_transition:new o.cj(m),u_inv_rot_matrix:new o.cl(m),u_merc_center:new o.ck(m),u_up_dir:new o.ci(m),u_height_lift:new o.cj(m),u_image:new o.ch(m),u_texsize:new o.ck(m),u_pixel_coord_upper:new o.ck(m),u_pixel_coord_lower:new o.ck(m),u_tile_units_to_pixels:new o.cj(m),u_opacity:new o.cj(m),u_pattern_transition:new o.cj(m)}),fillExtrusionGroundEffect:m=>({u_matrix:new o.cl(m),u_opacity:new o.cj(m),u_ao_pass:new o.cj(m),u_meter_to_tile:new o.cj(m),u_ao:new o.ck(m),u_flood_light_intensity:new o.cj(m),u_flood_light_color:new o.ci(m),u_attenuation:new o.cj(m),u_edge_radius:new o.cj(m),u_fb:new o.ch(m),u_fb_size:new o.cj(m),u_dynamic_offset:new o.cj(m)}),fill:m=>({u_matrix:new o.cl(m),u_emissive_strength:new o.cj(m),u_ground_shadow_factor:new o.ci(m)}),fillPattern:m=>({u_matrix:new o.cl(m),u_emissive_strength:new o.cj(m),u_image:new o.ch(m),u_texsize:new o.ck(m),u_pixel_coord_upper:new o.ck(m),u_pixel_coord_lower:new o.ck(m),u_tile_units_to_pixels:new o.cj(m),u_ground_shadow_factor:new o.ci(m),u_pattern_transition:new o.cj(m)}),fillOutline:m=>({u_matrix:new o.cl(m),u_emissive_strength:new o.cj(m),u_world:new o.ck(m),u_ground_shadow_factor:new o.ci(m)}),fillOutlinePattern:m=>({u_matrix:new o.cl(m),u_emissive_strength:new o.cj(m),u_world:new o.ck(m),u_image:new o.ch(m),u_texsize:new o.ck(m),u_pixel_coord_upper:new o.ck(m),u_pixel_coord_lower:new o.ck(m),u_tile_units_to_pixels:new o.cj(m),u_ground_shadow_factor:new o.ci(m),u_pattern_transition:new o.cj(m)}),building:m=>({u_matrix:new o.cl(m),u_normal_matrix:new o.cl(m),u_opacity:new o.cj(m),u_faux_facade_ao_intensity:new o.cj(m),u_camera_pos:new o.ci(m),u_tile_to_meter:new o.cj(m),u_facade_emissive_chance:new o.cj(m),u_flood_light_color:new o.ci(m),u_flood_light_intensity:new o.cj(m)}),buildingBloom:m=>({u_matrix:new o.cl(m)}),buildingDepth:m=>({u_matrix:new o.cl(m)}),elevatedStructuresDepth:m=>({u_matrix:new o.cl(m),u_depth_bias:new o.cj(m)}),elevatedStructures:m=>({u_matrix:new o.cl(m),u_ground_shadow_factor:new o.ci(m)}),elevatedStructuresDepthReconstruct:m=>({u_matrix:new o.cl(m),u_camera_pos:new o.ci(m),u_depth_bias:new o.cj(m),u_height_scale:new o.cj(m),u_reset_depth:new o.cj(m)}),circle:o.dY,collisionBox:m=>({u_matrix:new o.cl(m),u_inv_rot_matrix:new o.cl(m),u_camera_to_center_distance:new o.cj(m),u_extrude_scale:new o.ck(m),u_zoom_transition:new o.cj(m),u_merc_center:new o.ck(m),u_tile_id:new o.ci(m)}),collisionCircle:m=>({u_matrix:new o.cl(m),u_inv_matrix:new o.cl(m),u_camera_to_center_distance:new o.cj(m),u_viewport_size:new o.ck(m)}),debug:m=>({u_color:new o.dB(m),u_matrix:new o.cl(m),u_overlay:new o.ch(m),u_overlay_scale:new o.cj(m)}),clippingMask:m=>({u_matrix:new o.cl(m)}),heatmap:m=>({u_extrude_scale:new o.cj(m),u_intensity:new o.cj(m),u_matrix:new o.cl(m),u_inv_rot_matrix:new o.cl(m),u_merc_center:new o.ck(m),u_tile_id:new o.ci(m),u_zoom_transition:new o.cj(m),u_up_dir:new o.ci(m)}),heatmapTexture:m=>({u_image:new o.ch(m),u_color_ramp:new o.ch(m),u_opacity:new o.cj(m)}),hillshade:m=>({u_matrix:new o.cl(m),u_image:new o.ch(m),u_latrange:new o.ck(m),u_light:new o.ck(m),u_shadow:new o.dB(m),u_highlight:new o.dB(m),u_emissive_strength:new o.cj(m),u_accent:new o.dB(m)}),hillshadePrepare:m=>({u_matrix:new o.cl(m),u_image:new o.ch(m),u_dimension:new o.ck(m),u_zoom:new o.cj(m)}),line:o.dX,linePattern:o.dW,raster:m=>({u_matrix:new o.cl(m),u_normalize_matrix:new o.cl(m),u_globe_matrix:new o.cl(m),u_merc_matrix:new o.cl(m),u_grid_matrix:new o.dC(m),u_tl_parent:new o.ck(m),u_scale_parent:new o.cj(m),u_fade_t:new o.cj(m),u_opacity:new o.cj(m),u_image0:new o.ch(m),u_image1:new o.ch(m),u_brightness_low:new o.cj(m),u_brightness_high:new o.cj(m),u_saturation_factor:new o.cj(m),u_contrast_factor:new o.cj(m),u_spin_weights:new o.ci(m),u_perspective_transform:new o.ck(m),u_raster_elevation:new o.cj(m),u_zoom_transition:new o.cj(m),u_merc_center:new o.ck(m),u_cutoff_params:new o.d3(m),u_colorization_mix:new o.d3(m),u_colorization_offset:new o.cj(m),u_color_ramp:new o.ch(m),u_texture_offset:new o.ck(m),u_texture_res:new o.ck(m),u_emissive_strength:new o.cj(m)}),rasterParticle:m=>({u_matrix:new o.cl(m),u_normalize_matrix:new o.cl(m),u_globe_matrix:new o.cl(m),u_merc_matrix:new o.cl(m),u_grid_matrix:new o.dC(m),u_tl_parent:new o.ck(m),u_scale_parent:new o.cj(m),u_fade_t:new o.cj(m),u_opacity:new o.cj(m),u_image0:new o.ch(m),u_image1:new o.ch(m),u_raster_elevation:new o.cj(m),u_zoom_transition:new o.cj(m),u_merc_center:new o.ck(m),u_cutoff_params:new o.d3(m)}),rasterParticleTexture:m=>({u_texture:new o.ch(m),u_opacity:new o.cj(m)}),rasterParticleDraw:m=>({u_particle_texture:new o.ch(m),u_particle_texture_side_len:new o.cj(m),u_tile_offset:new o.ck(m),u_velocity:new o.ch(m),u_color_ramp:new o.ch(m),u_velocity_res:new o.ck(m),u_max_speed:new o.cj(m),u_uv_offset:new o.ck(m),u_data_scale:new o.ck(m),u_data_offset:new o.cj(m),u_particle_pos_scale:new o.cj(m),u_particle_pos_offset:new o.ck(m)}),rasterParticleUpdate:m=>({u_particle_texture:new o.ch(m),u_particle_texture_side_len:new o.cj(m),u_velocity:new o.ch(m),u_velocity_res:new o.ck(m),u_max_speed:new o.cj(m),u_speed_factor:new o.cj(m),u_reset_rate:new o.cj(m),u_rand_seed:new o.cj(m),u_uv_offset:new o.ck(m),u_data_scale:new o.ck(m),u_data_offset:new o.cj(m),u_particle_pos_scale:new o.cj(m),u_particle_pos_offset:new o.ck(m)}),symbol:m=>({u_is_size_zoom_constant:new o.ch(m),u_is_size_feature_constant:new o.ch(m),u_size_t:new o.cj(m),u_size:new o.cj(m),u_camera_to_center_distance:new o.cj(m),u_rotate_symbol:new o.ch(m),u_aspect_ratio:new o.cj(m),u_fade_change:new o.cj(m),u_matrix:new o.cl(m),u_label_plane_matrix:new o.cl(m),u_coord_matrix:new o.cl(m),u_is_text:new o.ch(m),u_elevation_from_sea:new o.ch(m),u_pitch_with_map:new o.ch(m),u_texsize:new o.ck(m),u_texsize_icon:new o.ck(m),u_texture:new o.ch(m),u_texture_icon:new o.ch(m),u_gamma_scale:new o.cj(m),u_device_pixel_ratio:new o.cj(m),u_tile_id:new o.ci(m),u_zoom_transition:new o.cj(m),u_inv_rot_matrix:new o.cl(m),u_merc_center:new o.ck(m),u_camera_forward:new o.ci(m),u_tile_matrix:new o.cl(m),u_up_vector:new o.ci(m),u_ecef_origin:new o.ci(m),u_is_halo:new o.ch(m),u_icon_transition:new o.cj(m),u_color_adj_mat:new o.cl(m),u_scale_factor:new o.cj(m),u_ground_shadow_factor:new o.ci(m),u_inv_matrix:new o.cl(m),u_normal_scale:new o.cj(m),u_lutTexture:new o.ch(m)}),background:m=>({u_matrix:new o.cl(m),u_emissive_strength:new o.cj(m),u_opacity:new o.cj(m),u_color:new o.dB(m)}),backgroundPattern:m=>({u_matrix:new o.cl(m),u_emissive_strength:new o.cj(m),u_opacity:new o.cj(m),u_image:new o.ch(m),u_pattern_tl:new o.ck(m),u_pattern_br:new o.ck(m),u_texsize:new o.ck(m),u_pattern_size:new o.ck(m),u_pixel_coord_upper:new o.ck(m),u_pixel_coord_lower:new o.ck(m),u_pattern_units_to_pixels:new o.ck(m)}),terrainRaster:m=>({u_matrix:new o.cl(m),u_image0:new o.ch(m),u_image1:new o.ch(m),u_skirt_height:new o.cj(m),u_ground_shadow_factor:new o.ci(m),u_emissive_texture_available:new o.cj(m)}),skybox:m=>({u_matrix:new o.cl(m),u_sun_direction:new o.ci(m),u_cubemap:new o.ch(m),u_opacity:new o.cj(m),u_temporal_offset:new o.cj(m)}),skyboxGradient:m=>({u_matrix:new o.cl(m),u_color_ramp:new o.ch(m),u_center_direction:new o.ci(m),u_radius:new o.cj(m),u_opacity:new o.cj(m),u_temporal_offset:new o.cj(m)}),skyboxCapture:m=>({u_matrix_3f:new o.dC(m),u_sun_direction:new o.ci(m),u_sun_intensity:new o.cj(m),u_color_tint_r:new o.d3(m),u_color_tint_m:new o.d3(m),u_luminance:new o.cj(m)}),globeRaster:m=>({u_proj_matrix:new o.cl(m),u_globe_matrix:new o.cl(m),u_normalize_matrix:new o.cl(m),u_merc_matrix:new o.cl(m),u_zoom_transition:new o.cj(m),u_merc_center:new o.ck(m),u_image0:new o.ch(m),u_image1:new o.ch(m),u_grid_matrix:new o.dC(m),u_skirt_height:new o.cj(m),u_far_z_cutoff:new o.cj(m),u_frustum_tl:new o.ci(m),u_frustum_tr:new o.ci(m),u_frustum_br:new o.ci(m),u_frustum_bl:new o.ci(m),u_globe_pos:new o.ci(m),u_globe_radius:new o.cj(m),u_viewport:new o.ck(m),u_emissive_texture_available:new o.cj(m)}),globeAtmosphere:m=>({u_frustum_tl:new o.ci(m),u_frustum_tr:new o.ci(m),u_frustum_br:new o.ci(m),u_frustum_bl:new o.ci(m),u_horizon:new o.cj(m),u_transition:new o.cj(m),u_fadeout_range:new o.cj(m),u_atmosphere_fog_color:new o.d3(m),u_high_color:new o.d3(m),u_space_color:new o.d3(m),u_temporal_offset:new o.cj(m),u_horizon_angle:new o.cj(m)}),model:m=>({u_matrix:new o.cl(m),u_lighting_matrix:new o.cl(m),u_normal_matrix:new o.cl(m),u_node_matrix:new o.cl(m),u_lightpos:new o.ci(m),u_lightintensity:new o.cj(m),u_lightcolor:new o.ci(m),u_camera_pos:new o.ci(m),u_opacity:new o.cj(m),u_baseColorFactor:new o.d3(m),u_emissiveFactor:new o.d3(m),u_metallicFactor:new o.cj(m),u_roughnessFactor:new o.cj(m),u_baseTextureIsAlpha:new o.ch(m),u_alphaMask:new o.ch(m),u_alphaCutoff:new o.cj(m),u_baseColorTexture:new o.ch(m),u_metallicRoughnessTexture:new o.ch(m),u_normalTexture:new o.ch(m),u_occlusionTexture:new o.ch(m),u_emissionTexture:new o.ch(m),u_lutTexture:new o.ch(m),u_color_mix:new o.d3(m),u_aoIntensity:new o.cj(m),u_emissive_strength:new o.cj(m),u_occlusionTextureTransform:new o.d3(m)}),modelDepth:m=>({u_matrix:new o.cl(m),u_instance:new o.cl(m),u_node_matrix:new o.cl(m)}),groundShadow:m=>({u_matrix:new o.cl(m),u_ground_shadow_factor:new o.ci(m)}),stars:m=>({u_matrix:new o.cl(m),u_up:new o.ci(m),u_right:new o.ci(m),u_intensity_multiplier:new o.cj(m)}),snowParticle:m=>({u_modelview:new o.cl(m),u_projection:new o.cl(m),u_time:new o.cj(m),u_cam_pos:new o.ci(m),u_velocityConeAperture:new o.cj(m),u_velocity:new o.cj(m),u_horizontalOscillationRadius:new o.cj(m),u_horizontalOscillationRate:new o.cj(m),u_boxSize:new o.cj(m),u_billboardSize:new o.cj(m),u_simpleShapeParameters:new o.ck(m),u_screenSize:new o.ck(m),u_thinningCenterPos:new o.ck(m),u_thinningShape:new o.ci(m),u_thinningAffectedRatio:new o.cj(m),u_thinningParticleOffset:new o.cj(m),u_particleColor:new o.d3(m),u_direction:new o.ci(m)}),rainParticle:m=>({u_modelview:new o.cl(m),u_projection:new o.cl(m),u_time:new o.cj(m),u_cam_pos:new o.ci(m),u_texScreen:new o.ch(m),u_velocityConeAperture:new o.cj(m),u_velocity:new o.cj(m),u_boxSize:new o.cj(m),u_rainDropletSize:new o.ck(m),u_distortionStrength:new o.cj(m),u_rainDirection:new o.ci(m),u_color:new o.d3(m),u_screenSize:new o.ck(m),u_thinningCenterPos:new o.ck(m),u_thinningShape:new o.ci(m),u_thinningAffectedRatio:new o.cj(m),u_thinningParticleOffset:new o.cj(m),u_shapeDirectionalPower:new o.cj(m),u_shapeNormalPower:new o.cj(m),u_mode:new o.cj(m)}),vignette:m=>({u_vignetteShape:new o.ci(m),u_vignetteColor:new o.d3(m)}),occlusion:m=>({u_matrix:new o.cl(m),u_anchorPos:new o.ci(m),u_screenSizePx:new o.ck(m),u_occluderSizePx:new o.ck(m),u_color:new o.d3(m)})};class tc{constructor(s,d,f,_){this.id=tc.uniqueIdxCounter,tc.uniqueIdxCounter++,this.context=s;const b=s.gl;this.buffer=b.createBuffer(),this.dynamicDraw=!!f,this.context.unbindVAO(),s.bindElementBuffer.set(this.buffer),b.bufferData(b.ELEMENT_ARRAY_BUFFER,d.arrayBuffer,this.dynamicDraw?b.DYNAMIC_DRAW:b.STATIC_DRAW),this.dynamicDraw||_||d.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(s){this.id=tc.uniqueIdxCounter,tc.uniqueIdxCounter++;const d=this.context.gl;this.context.unbindVAO(),this.bind(),d.bufferSubData(d.ELEMENT_ARRAY_BUFFER,0,s.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}tc.uniqueIdxCounter=0;const jb={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class cN{constructor(s,d,f,_,b,S){this.length=d.length,this.attributes=f,this.itemSize=d.bytesPerElement,this.dynamicDraw=_,this.instanceCount=S,this.context=s;const A=s.gl;this.buffer=A.createBuffer(),s.bindVertexBuffer.set(this.buffer),A.bufferData(A.ARRAY_BUFFER,d.arrayBuffer,this.dynamicDraw?A.DYNAMIC_DRAW:A.STATIC_DRAW),this.dynamicDraw||b||d.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(s){const d=this.context.gl;this.bind(),d.bufferSubData(d.ARRAY_BUFFER,0,s.arrayBuffer)}enableAttributes(s,d){for(let f=0;f<this.attributes.length;f++){const _=d.getAttributeLocation(s,this.attributes[f].name);_!==-1&&s.enableVertexAttribArray(_)}}setVertexAttribPointers(s,d,f){for(let _=0;_<this.attributes.length;_++){const b=this.attributes[_],S=d.getAttributeLocation(s,b.name);S!==-1&&s.vertexAttribPointer(S,b.components,s[jb[b.type]],!1,this.itemSize,b.offset+this.itemSize*(f||0))}}setVertexAttribDivisor(s,d,f){for(let _=0;_<this.attributes.length;_++){const b=d.getAttributeLocation(s,this.attributes[_].name);b!==-1&&this.instanceCount&&this.instanceCount>0&&s.vertexAttribDivisor(b,f)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class pd{constructor(s,d,f,_,b){this.context=s,this.width=d,this.height=f;const S=this.framebuffer=s.gl.createFramebuffer();_>0&&(this.colorAttachment0=new Uf(s,S,0)),_>1&&(this.colorAttachment1=new Uf(s,S,1)),b&&(this.depthAttachmentType=b,this.depthAttachment=b==="renderbuffer"?new ch(s,S):new Qp(s,S))}createColorAttachment(s,d){d===0?this.colorAttachment0=new Uf(s,this.framebuffer,0):d===1&&(this.colorAttachment1=new Uf(s,this.framebuffer,1))}removeColorAttachment(s,d){const f=this.context.gl;let _;d===0?(_=this.colorAttachment0.get(),this.colorAttachment0=void 0):d===1&&(_=this.colorAttachment1.get(),this.colorAttachment1=void 0),_&&f.deleteTexture(_)}destroy(){const s=this.context.gl;if(this.colorAttachment0){const d=this.colorAttachment0.get();d&&s.deleteTexture(d)}if(this.colorAttachment1){const d=this.colorAttachment1.get();d&&s.deleteTexture(d)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){const d=this.depthAttachment.get();d&&s.deleteRenderbuffer(d)}else{const d=this.depthAttachment.get();d&&s.deleteTexture(d)}s.deleteFramebuffer(this.framebuffer)}}class tg{constructor(s,d){this.gl=s,this.clearColor=new eN(this),this.clearDepth=new pb(this),this.clearStencil=new _x(this),this.colorMask=new Lf(this),this.depthMask=new vx(this),this.stencilMask=new cd(this),this.stencilFunc=new sh(this),this.stencilOp=new Yp(this),this.stencilTest=new ah(this),this.depthRange=new mb(this),this.depthTest=new bx(this),this.depthFunc=new fb(this),this.blend=new oh(this),this.blendFunc=new Ff(this),this.blendColor=new zf(this),this.blendEquation=new wx(this),this.cullFace=new Bf(this),this.cullFaceSide=new Kp(this),this.frontFace=new gb(this),this.program=new yb(this),this.activeTexture=new xb(this),this.viewport=new lh(this),this.bindFramebuffer=new _b(this),this.bindRenderbuffer=new tN(this),this.bindTexture=new iN(this),this.bindVertexBuffer=new rN(this),this.bindElementBuffer=new Sx(this),this.bindVertexArrayOES=new Tx(this),this.pixelStoreUnpack=new Nx(this),this.pixelStoreUnpackPremultiplyAlpha=new Ax(this),this.pixelStoreUnpackFlipY=new vb(this),this.options=d?Object.assign({},d):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=s.getExtension("EXT_texture_filter_anisotropic")||s.getExtension("MOZ_EXT_texture_filter_anisotropic")||s.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=s.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=s.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=s.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=s.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=d&&!!d.forceManualRenderingForInstanceIDShaders||this.renderer&&this.renderer.indexOf("PowerVR")!==-1,this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=s.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=s.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=s.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=s.getParameter(s.MAX_TEXTURE_SIZE),this.extBlendFuncExtended=s.getExtension("WEBGL_blend_func_extended")}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(s,d,f){return new tc(this,s,d,f)}createVertexBuffer(s,d,f,_,b){return new cN(this,s,d,f,_,b)}createRenderbuffer(s,d,f){const _=this.gl,b=_.createRenderbuffer();return this.bindRenderbuffer.set(b),_.renderbufferStorage(_.RENDERBUFFER,s,d,f),this.bindRenderbuffer.set(null),b}createFramebuffer(s,d,f,_){return new pd(this,s,d,f,_)}clear({color:s,depth:d,stencil:f,colorMask:_}){const b=this.gl;let S=0;s&&(S|=b.COLOR_BUFFER_BIT,this.clearColor.set(s.toNonPremultipliedRenderColor(null)),this.colorMask.set(_||[!0,!0,!0,!0])),d!==void 0&&(S|=b.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(d),this.depthMask.set(!0)),f!==void 0&&(S|=b.STENCIL_BUFFER_BIT,this.clearStencil.set(f),this.stencilMask.set(255)),b.clear(S)}setCullFace(s){s.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(s.mode),this.frontFace.set(s.frontFace))}setDepthMode(s){s.func!==this.gl.ALWAYS||s.mask?(this.depthTest.set(!0),this.depthFunc.set(s.func),this.depthMask.set(s.mask),this.depthRange.set(s.range)):this.depthTest.set(!1)}setStencilMode(s){s.test.func!==this.gl.ALWAYS||s.mask?(this.stencilTest.set(!0),this.stencilMask.set(s.mask),this.stencilOp.set([s.fail,s.depthFail,s.pass]),this.stencilFunc.set({func:s.test.func,ref:s.ref,mask:s.test.mask})):this.stencilTest.set(!1)}setColorMode(s){o.by(s.blendFunction,Di.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(s.blendFunction),this.blendColor.set(s.blendColor),s.blendEquation?this.blendEquation.set(s.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(s.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let Yt;function Fx(m,s,d,f,_,b,S){const A=m.context,E=A.gl,D=m.transform,M=[o.aF(D.center.lng),o.aJ(D.center.lat)],B=d.layout.get("symbol-placement"),z=d.layout.get("text-variable-anchor"),V=d.layout.get("icon-rotation-alignment")==="map",Q=d.layout.get("text-rotation-alignment")==="map",W=B!=="point",J=[];let ce=0,_e=0;for(let Ee=0;Ee<f.length;Ee++){const Se=f[Ee],qe=s.getTile(Se),Ye=qe.getBucket(d);if(!Ye)continue;const Qe=Ye.getProjection().createInversionMatrix(D,Se.canonical),at=[],nt=Cf(Se,Ye,D),ft=!S&&V&&W,Nt=S&&Q&&W,rt=z&&Ye.hasTextData(),$e=Ye.hasIconTextFit()&&rt&&Ye.hasIconData(),dt=ft||Nt||S&&rt||$e,ot=Ye.projection.name==="globe",Ct=ot?o.aj(D.zoom):0;ot&&(at.push("PROJECTION_GLOBE_VIEW"),dt&&at.push("PROJECTED_POS_ON_VIEWPORT"));const Rt=m.getOrCreateProgram("collisionBox",{defines:at});let Ut=nt;_[0]===0&&_[1]===0||(Ut=m.translatePosMatrix(nt,qe,_,b));const kt=S?Ye.textCollisionBox:Ye.iconCollisionBox,Mt=Ye.collisionCircleArray;if(Mt.length>0){const Qt=o.bC(),Wt=Ut;o.cP(Qt,Ye.placementInvProjMatrix,D.glCoordMatrix),o.cP(Qt,Qt,Ye.placementViewportMatrix),J.push({circleArray:Mt,circleOffset:_e,transform:Wt,invTransform:Qt,projection:Ye.getProjection()}),ce+=Mt.length/4,_e=ce}if(!kt)continue;m.terrain&&m.terrain.setupElevationDraw(qe,Rt);const ei=ot?[Se.canonical.x,Se.canonical.y,1<<Se.canonical.z]:[0,0,0];Rt.draw(m,E.LINES,si.disabled,ji.disabled,m.colorModeForRenderPass(),Ai.disabled,Dx(Ut,Qe,D,Ct,M,qe,ei,Ye.getProjection()),d.id,kt.layoutVertexBuffer,kt.indexBuffer,kt.segments,null,D.zoom,null,[kt.collisionVertexBuffer,kt.collisionVertexBufferExt])}if(!S||!J.length)return;const xe=m.getOrCreateProgram("collisionCircle"),fe=new o.dZ;fe.resize(4*ce),fe._trim();let Fe=0;for(const Ee of J)for(let Se=0;Se<Ee.circleArray.length/4;Se++){const qe=4*Se,Ye=Ee.circleArray[qe+0],Qe=Ee.circleArray[qe+1],at=Ee.circleArray[qe+2],nt=Ee.circleArray[qe+3];fe.emplace(Fe++,Ye,Qe,at,nt,0),fe.emplace(Fe++,Ye,Qe,at,nt,1),fe.emplace(Fe++,Ye,Qe,at,nt,2),fe.emplace(Fe++,Ye,Qe,at,nt,3)}(!Yt||Yt.length<2*ce)&&(Yt=function(Ee){const Se=2*Ee,qe=new o.b0;qe.resize(Se),qe._trim();for(let Ye=0;Ye<Se;Ye++){const Qe=6*Ye;qe.uint16[Qe+0]=4*Ye+0,qe.uint16[Qe+1]=4*Ye+1,qe.uint16[Qe+2]=4*Ye+2,qe.uint16[Qe+3]=4*Ye+2,qe.uint16[Qe+4]=4*Ye+3,qe.uint16[Qe+5]=4*Ye+0}return qe}(ce));const De=A.createIndexBuffer(Yt,!0),Oe=A.createVertexBuffer(fe,o.d_.members,!0);for(const Ee of J){const Se=Yf(Ee.transform,Ee.invTransform,D,Ee.projection);xe.draw(m,E.TRIANGLES,si.disabled,ji.disabled,m.colorModeForRenderPass(),Ai.disabled,Se,d.id,Oe,De,o.bg.simpleSegment(0,2*Ee.circleOffset,Ee.circleArray.length,Ee.circleArray.length/2),null,D.zoom)}Oe.destroy(),De.destroy()}const Cl=o.bC();function Rc(m){const s=m._camera.getWorldToCamera(m.worldSize,1),d=o.aB([],s,m.globeMatrix);o.bl(d,d);const f=[0,0,0],_=[0,1,0,0];return o.aC(_,_,d),f[0]=_[0],f[1]=_[1],f[2]=_[2],o.aw(f,f),f}function Rb({width:m,height:s,anchor:d,textOffset:f,textScale:_},b){const{horizontalAlign:S,verticalAlign:A}=o.c1(d),E=-(S-.5)*m,D=-(A-.5)*s,M=o.c2(d,f);return new o.P((E/_+M[0])*b,(D/_+M[1])*b)}function kb(m,s,d,f,_,b,S,A,E,D){const M=m.text.placedSymbolArray,B=m.text.dynamicLayoutVertexArray,z=m.icon.dynamicLayoutVertexArray,V={},Q=m.getProjection(),W=La(S,Q,_),J=_.elevation,ce=Q.upVectorScale(S.canonical,_.center.lat,_.worldSize).metersToTile;B.clear();for(let _e=0;_e<M.length;_e++){const xe=M.get(_e),{tileAnchorX:fe,tileAnchorY:Fe,numGlyphs:De}=xe,Oe=xe.hidden||!xe.crossTileID||m.allowVerticalPlacement&&!xe.placedOrientation?null:f[xe.crossTileID];if(Oe){let Ee=0,Se=0,qe=0;const Ye=m.elevationType==="road";if(J||Ye){const ot=Ye?m.getElevationFeatureForText(_e):null,Ct=o.bV.getAtTileOffset(S,new o.P(fe,Fe),J,ot),[Rt,Ut,kt]=Q.upVector(S.canonical,fe,Fe);Ee=Ct*Rt*ce,Se=Ct*Ut*ce,qe=Ct*kt*ce}let[Qe,at,nt,ft]=Qa(xe.projectedAnchorX+Ee,xe.projectedAnchorY+Se,xe.projectedAnchorZ+qe,d?W:b);const Nt=Ac(_.getCameraToCenterDistance(Q),ft);let rt=o.bM(m.textSizeData,E,xe)*Nt/o.bY;d&&(rt*=m.tilePixelRatio/A);const $e=Rb(Oe,rt);d?({x:Qe,y:at,z:nt}=Q.projectTilePoint(fe+$e.x,Fe+$e.y,S.canonical),[Qe,at,nt]=Qa(Qe+Ee,at+Se,nt+qe,b)):(s&&$e._rotate(-_.angle),Qe+=$e.x,at+=$e.y,nt=0);const dt=m.allowVerticalPlacement&&xe.placedOrientation===o.bL.vertical?Math.PI/2:0;for(let ot=0;ot<De;ot++)o.bO(B,Qe,at,nt,dt);D&&xe.associatedIconIndex>=0&&(V[xe.associatedIconIndex]={x:Qe,y:at,z:nt,angle:dt})}else Ls(De,B)}if(D){z.clear();const _e=m.icon.placedSymbolArray;for(let xe=0;xe<_e.length;xe++){const fe=_e.get(xe),{numGlyphs:Fe}=fe,De=V[xe];if(fe.hidden||!De)Ls(Fe,z);else{const{x:Oe,y:Ee,z:Se,angle:qe}=De;for(let Ye=0;Ye<Fe;Ye++)o.bO(z,Oe,Ee,Se,qe)}}m.icon.dynamicLayoutVertexBuffer.updateData(z)}m.text.dynamicLayoutVertexBuffer.updateData(B)}function ig(m,s,d,f,_,b,S={}){const A=d.paint.get("icon-translate"),E=d.paint.get("text-translate"),D=d.paint.get("icon-translate-anchor"),M=d.paint.get("text-translate-anchor"),B=d.layout.get("icon-rotation-alignment"),z=d.layout.get("text-rotation-alignment"),V=d.layout.get("icon-pitch-alignment"),Q=d.layout.get("text-pitch-alignment"),W=d.layout.get("icon-keep-upright"),J=d.layout.get("text-keep-upright"),ce=d.paint.get("icon-color-saturation"),_e=d.paint.get("icon-color-contrast"),xe=d.paint.get("icon-color-brightness-min"),fe=d.paint.get("icon-color-brightness-max"),Fe=d.layout.get("symbol-elevation-reference")==="sea",De=d.layout.get("icon-image-use-theme")==="none",Oe=m.context,Ee=Oe.gl,Se=m.transform,qe=B==="map",Ye=z==="map",Qe=V==="map",at=Q==="map",nt=d.layout.get("symbol-sort-key").constantOr(1)!==void 0;let ft=!1;const Nt=m.depthModeForSublayer(0,si.ReadOnly),rt=new si(m.context.gl.LEQUAL,si.ReadOnly,m.depthRangeFor3D),$e=[o.aF(Se.center.lng),o.aJ(Se.center.lat)],dt=d.layout.get("text-variable-anchor"),ot=Se.projection.name==="globe",Ct=[],Rt=[0,-1,0];for(const Ut of f){const kt=s.getTile(Ut),Mt=kt.getBucket(d);if(!Mt||Mt.projection.name==="mercator"&&ot||Mt.fullyClipped)continue;const ei=Mt.projection.name==="globe",Qt=ei?o.aj(Se.zoom):0,Wt=La(Ut,Mt.getProjection(),Se),Kt=Se.calculatePixelsToTileUnitsMatrix(kt),gi=dt&&Mt.hasTextData(),Ci=Mt.hasIconTextFit()&&gi&&Mt.hasIconData(),Hi=Mt.getProjection().createInversionMatrix(Se,Ut.canonical),lr=(1<<kt.tileID.canonical.z)*o.al/m.transform.worldSize,ki=Pr=>{let rr=[0,0,0];if(Pr){const Gi=m.style.directionalLight,Zr=m.style.ambientLight;Gi&&Zr&&(rr=hl(m.style,Gi,Zr))}return rr},yr=Pr=>{Se.depthOcclusionForSymbolsAndCircles&&(d.hasOcclusionOpacityProperties||m.terrain)&&(Pr.push("DEPTH_D24"),Pr.push("DEPTH_OCCLUSION"))},Li=Pr=>{d.lut&&!De&&(d.lut.texture||(d.lut.texture=new o.d$(m.context,d.lut.image,[d.lut.image.height,d.lut.image.height,d.lut.image.height],Oe.gl.RGBA8)),Oe.activeTexture.set(Oe.gl.TEXTURE0+10),d.lut.texture&&d.lut.texture.bind(Oe.gl.LINEAR,Oe.gl.CLAMP_TO_EDGE),Pr.push("APPLY_LUT_ON_GPU"))},Dr=()=>{const Pr=qe&&d.layout.get("symbol-placement")!=="point",rr=[];yr(rr),Li(rr);const Gi=Pr||Ci,Zr=Mt.elevationType==="road",Dn=m.shadowRenderer,Kr=Zr&&Qe&&!!Dn&&Dn.enabled,tn=ki(Kr),Va=Zr&&Qe&&!m.terrain?rt:Nt,ro=d.paint.get("icon-image-cross-fade");m.terrainRenderModeElevated()&&Qe&&rr.push("PITCH_WITH_MAP_TERRAIN"),ei&&(rr.push("PROJECTION_GLOBE_VIEW"),Gi&&rr.push("PROJECTED_POS_ON_VIEWPORT")),ro>0&&Mt.hasAnySecondaryIcon&&rr.push("ICON_TRANSITION"),!Mt.icon.zOffsetVertexBuffer||Zr&&m.terrain||rr.push("Z_OFFSET"),ce===0&&_e===0&&xe===0&&fe===1||rr.push("COLOR_ADJUSTMENT"),Mt.sdfIcons&&rr.push("RENDER_SDF"),Kr&&rr.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),Zr&&Qe&&!m.terrain&&Mt.icon.orientationVertexBuffer&&rr.push("ELEVATED_ROADS");const Fs=Mt.icon.programConfigurations.get(d.id),jr=m.getOrCreateProgram("symbol",{config:Fs,defines:rr}),vo=kt.imageAtlasTexture?kt.imageAtlasTexture.size:[0,0],ua=Mt.iconSizeData,no=o.bK(ua,Se.zoom),ml=Qe||!Se.isOrthographic,Ua=Xl(Wt,kt.tileID.canonical,Qe,qe,Se,Mt.getProjection(),Kt),_n=Ys(Wt,kt.tileID.canonical,Qe,qe,Se,Mt.getProjection(),Kt),Hn=m.translatePosMatrix(_n,kt,A,D,!0),Qr=m.translatePosMatrix(Wt,kt,A,D),ts=Gi?Cl:Ua,ba=qe&&!Qe&&!Pr;let zn=Rt;!ot&&!Se.mercatorFromTransition||qe||(zn=Rc(Se));const bo=ei?zn:Rt,bm=d.getColorAdjustmentMatrix(ce,_e,xe,fe),sc=rm(ua.kind,no,ba,Qe,m,Qr,ts,Hn,Fe,!1,vo,[0,0],0,Ut,Qt,$e,Hi,bo,Mt.getProjection(),tn,lr,bm,ro,null),Th=kt.imageAtlasTexture?kt.imageAtlasTexture:null,Nh=d.layout.get("icon-size").constantOr(0)!==1||Mt.iconsNeedLinear,wo=Mt.sdfIcons||m.options.rotating||m.options.zooming||Nh||ml?Ee.LINEAR:Ee.NEAREST,ac=Mt.sdfIcons&&d.paint.get("icon-halo-width").constantOr(1)!==0,oc=m.terrain&&Qe&&Pr?o.bl(o.bC(),Ua):Cl;if(Pr&&Mt.icon){const Ho=o.bV.getAtTileOffsetFunc(Ut,Se.center.lat,Se.worldSize,Mt.getProjection()),Mc=zo(Wt,kt.tileID.canonical,Qe,qe,Se,Mt.getProjection(),Kt),xd=d.layout.get("icon-size-scale-range"),gg=o.aA(m.scaleFactor,xd[0],xd[1]);Ar(Mt,Wt,m,!1,Mc,_n,Qe,W,Ho,Ut,gg)}return{program:jr,buffers:Mt.icon,uniformValues:sc,atlasTexture:Th,atlasTextureIcon:null,atlasInterpolation:wo,atlasInterpolationIcon:null,isSDF:Mt.sdfIcons,hasHalo:ac,depthMode:Va,tile:kt,renderWithShadows:Kr,labelPlaneMatrixInv:oc}},Rr=()=>{const Pr=Ye&&d.layout.get("symbol-placement")!=="point",rr=[],Gi=Pr||dt||Ci,Zr=Mt.elevationType==="road",Dn=m.shadowRenderer,Kr=Zr&&at&&!!Dn&&Dn.enabled,tn=ki(Kr),Va=Zr&&at&&!m.terrain?rt:Nt;m.terrainRenderModeElevated()&&at&&rr.push("PITCH_WITH_MAP_TERRAIN"),ei&&(rr.push("PROJECTION_GLOBE_VIEW"),Gi&&rr.push("PROJECTED_POS_ON_VIEWPORT")),!Mt.text.zOffsetVertexBuffer||Zr&&m.terrain||rr.push("Z_OFFSET"),Mt.iconsInText&&rr.push("RENDER_TEXT_AND_SYMBOL"),rr.push("RENDER_SDF"),Kr&&rr.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),Zr&&at&&!m.terrain&&Mt.text.orientationVertexBuffer&&rr.push("ELEVATED_ROADS"),yr(rr);const ro=Mt.text.programConfigurations.get(d.id),Fs=m.getOrCreateProgram("symbol",{config:ro,defines:rr});let jr,vo=[0,0],ua=null;const no=Mt.textSizeData;Mt.iconsInText&&(vo=kt.imageAtlasTexture?kt.imageAtlasTexture.size:[0,0],ua=kt.imageAtlasTexture?kt.imageAtlasTexture:null,jr=at||!Se.isOrthographic||m.options.rotating||m.options.zooming||no.kind==="composite"||no.kind==="camera"?Ee.LINEAR:Ee.NEAREST);const ml=kt.glyphAtlasTexture?kt.glyphAtlasTexture.size:[0,0],Ua=d.layout.get("text-size-scale-range"),_n=o.aA(m.scaleFactor,Ua[0],Ua[1]),Hn=o.bK(no,Se.zoom,_n),Qr=Xl(Wt,kt.tileID.canonical,at,Ye,Se,Mt.getProjection(),Kt),ts=Ys(Wt,kt.tileID.canonical,at,Ye,Se,Mt.getProjection(),Kt),ba=m.translatePosMatrix(ts,kt,E,M,!0),zn=m.translatePosMatrix(Wt,kt,E,M),bo=Gi?Cl:Qr,bm=Ye&&!at&&!Pr;let sc=Rt;!ot&&!Se.mercatorFromTransition||Ye||(sc=Rc(Se));const Th=rm(no.kind,Hn,bm,at,m,zn,bo,ba,Fe,!0,ml,vo,0,Ut,Qt,$e,Hi,ei?sc:Rt,Mt.getProjection(),tn,lr,null,null,_n),Nh=kt.glyphAtlasTexture?kt.glyphAtlasTexture:null,wo=Ee.LINEAR,ac=d.paint.get("text-halo-width").constantOr(1)!==0,oc=m.terrain&&at&&Pr?o.bl(o.bC(),Qr):Cl;if(Pr&&Mt.text){const Ho=o.bV.getAtTileOffsetFunc(Ut,Se.center.lat,Se.worldSize,Mt.getProjection()),Mc=zo(Wt,kt.tileID.canonical,at,Ye,Se,Mt.getProjection(),Kt);Ar(Mt,Wt,m,!0,Mc,ts,at,J,Ho,Ut,_n)}return{program:Fs,buffers:Mt.text,uniformValues:Th,atlasTexture:Nh,atlasTextureIcon:ua,atlasInterpolation:wo,atlasInterpolationIcon:jr,isSDF:!0,hasHalo:ac,depthMode:Va,tile:kt,renderWithShadows:Kr,labelPlaneMatrixInv:oc}},Fr=Mt.icon.segments.get().length,ur=Mt.text.segments.get().length,Ui=Fr&&!S.onlyText?Dr():null,Ir=ur&&!S.onlyIcons?Rr():null,hn=d.paint.get("icon-opacity").constantOr(1),pn=d.paint.get("text-opacity").constantOr(1);if(nt&&Mt.canOverlap){ft=!0;const Pr=hn&&!S.onlyText?Mt.icon.segments.get():[],rr=pn&&!S.onlyIcons?Mt.text.segments.get():[];for(const Gi of Pr)Ct.push({segments:new o.bg([Gi]),sortKey:Gi.sortKey,state:Ui});for(const Gi of rr)Ct.push({segments:new o.bg([Gi]),sortKey:Gi.sortKey,state:Ir})}else S.onlyText||Ct.push({segments:hn?Mt.icon.segments:new o.bg([]),sortKey:0,state:Ui}),S.onlyIcons||Ct.push({segments:pn?Mt.text.segments:new o.bg([]),sortKey:0,state:Ir})}ft&&Ct.sort((Ut,kt)=>Ut.sortKey-kt.sortKey);for(const Ut of Ct){const kt=Ut.state;if(kt)if(m.terrain?m.terrain.setupElevationDraw(kt.tile,kt.program,{useDepthForOcclusion:Se.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:kt.labelPlaneMatrixInv}):m.setupDepthForOcclusion(Se.depthOcclusionForSymbolsAndCircles,kt.program),Oe.activeTexture.set(Ee.TEXTURE0),kt.atlasTexture&&kt.atlasTexture.bind(kt.atlasInterpolation,Ee.CLAMP_TO_EDGE,!0),kt.atlasTextureIcon&&(Oe.activeTexture.set(Ee.TEXTURE1),kt.atlasTextureIcon&&kt.atlasTextureIcon.bind(kt.atlasInterpolationIcon,Ee.CLAMP_TO_EDGE,!0)),kt.renderWithShadows&&m.shadowRenderer.setupShadows(kt.tile.tileID.toUnwrapped(),kt.program,"vector-tile"),m.uploadCommonLightUniforms(m.context,kt.program),kt.hasHalo){const Mt=kt.uniformValues;Mt.u_is_halo=1,rg(kt.buffers,Ut.segments,d,m,kt.program,kt.depthMode,_,b,Mt,2),Mt.u_is_halo=0}else{if(kt.isSDF){const Mt=kt.uniformValues;kt.hasHalo&&(Mt.u_is_halo=1,rg(kt.buffers,Ut.segments,d,m,kt.program,kt.depthMode,_,b,Mt,1)),Mt.u_is_halo=0}rg(kt.buffers,Ut.segments,d,m,kt.program,kt.depthMode,_,b,kt.uniformValues,1)}}}function rg(m,s,d,f,_,b,S,A,E,D){const M=[m.dynamicLayoutVertexBuffer,m.opacityVertexBuffer,m.iconTransitioningVertexBuffer,m.globeExtVertexBuffer,m.zOffsetVertexBuffer,m.orientationVertexBuffer];_.draw(f,f.context.gl.TRIANGLES,b,S,A,Ai.disabled,E,d.id,m.layoutVertexBuffer,m.indexBuffer,s,d.paint,f.transform.zoom,m.programConfigurations.get(d.id),M,D)}function zx(m,s){const d=1<<m.canonical.z,f=(s.x*d-m.canonical.x-m.wrap*d)*o.al,_=(s.y*d-m.canonical.y)*o.al,b=o.e8(s.z,s.y);return o.d5(f,_,b)}function Bx(m,s,d,f,_){if(!d.layout||d.layout.get("fill-elevation-reference")==="none"||d.paint.get("fill-opacity").constantOr(1)===0)return;const b=m.context.gl,S=new si(m.context.gl.LEQUAL,si.ReadWrite,m.depthRangeFor3D),A=new si(m.context.gl.GREATER,si.ReadWrite,m.depthRangeFor3D),E=function(V){let Q=.01;return V.isOrthographic&&(Q=o.ak(1e-4,Q,o.d0(V.pitch>=Jl?1:V.pitch/Jl))),2*Q}(m.transform),D=m.transform.getFreeCameraOptions().position,M="elevatedStructuresDepthReconstruct",B=m.getOrCreateProgram(M,{defines:["DEPTH_RECONSTRUCTION"]}),z=m.getOrCreateProgram(M);for(const V of f){const Q=s.getTile(V),W=Q.getBucket(d);if(!W)continue;const J=W.elevatedStructures;if(!J)continue;const ce=W.elevationBufferData.heightRange,_e=zx(V.toUnwrapped(),D),xe=m.translatePosMatrix(V.projMatrix,Q,d.paint.get("fill-translate"),d.paint.get("fill-translate-anchor"));let fe,Fe,De,Oe;if(_==="initialize"){if(!ce||ce.min>=1||J.depthSegments.segments[0].primitiveLength===0)continue;fe=dd(xe,_e,E,1,0),Fe=S,De=J.depthSegments,Oe=B}else if(_==="reset"){if(!ce||ce.min>=0||J.maskSegments.segments[0].primitiveLength===0)continue;fe=dd(xe,_e,0,0,1),Fe=A,De=J.maskSegments,Oe=B}else if(_==="geometry"){if(J.depthSegments.segments[0].primitiveLength===0)continue;fe=dd(xe,_e,E,1,0),Fe=S,De=J.depthSegments,Oe=z}Oe.draw(m,b.TRIANGLES,Fe,ji.disabled,Di.disabled,Ai.disabled,fe,d.id,J.vertexBuffer,J.indexBuffer,De,d.paint,m.transform.zoom)}}function ph(m,s,d,f){const{painter:_,sourceCache:b,layer:S,coords:A,colorMode:E,elevationType:D,terrainEnabled:M,pass:B}=m,z=_.context.gl,V=S.paint.get("fill-pattern"),Q=S.paint.get("fill-pattern-cross-fade"),W=V.constantOr(null);let J=D;D!=="road"||s&&!M||(J="none");const ce=J==="road",_e=m.painter.shadowRenderer,xe=ce&&!!_e&&_e.enabled,fe=new si(_.context.gl.LEQUAL,si.ReadOnly,_.depthRangeFor3D);let Fe=[0,0,0];if(xe){const Se=_.style.directionalLight,qe=_.style.ambientLight;Se&&qe&&(Fe=hl(_.style,Se,qe))}const De=V&&V.constantOr(1),Oe=_.terrain&&_.terrain.renderingToTexture,Ee=(Se,qe)=>{let Ye,Qe,at,nt,ft;qe?(Ye=De&&!S.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",at=z.LINES):(Ye=De?"fillPattern":"fill",at=z.TRIANGLES);for(const Nt of A){const rt=b.getTile(Nt);if(De&&!rt.patternsLoaded())continue;const $e=rt.getBucket(S);if(!$e)continue;const dt=s?$e.elevationBufferData:$e.bufferData;if(dt.isEmpty())continue;_.prepareDrawTile();const ot=dt.programConfigurations.get(S.id),Ct=_.isTileAffectedByFog(Nt),Rt=[],Ut=[];ce&&(Rt.push("ELEVATED_ROADS"),Ut.push(dt.elevatedLayoutVertexBuffer)),xe&&Rt.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),Oe&&d&&Rt.push("USE_MRT1"),De&&(_.context.activeTexture.set(z.TEXTURE0),rt.imageAtlasTexture&&rt.imageAtlasTexture.bind(z.LINEAR,z.CLAMP_TO_EDGE),ot.updatePaintBuffers());let kt=!1;if(W&&rt.imageAtlas){const Kt=rt.imageAtlas,gi=o.e3.from(W),Ci=gi.getPrimary().scaleSelf(o.o.devicePixelRatio).toString(),Hi=gi.getSecondary(),lr=Kt.patternPositions.get(Ci),ki=Hi?Kt.patternPositions.get(Hi.scaleSelf(o.o.devicePixelRatio).toString()):null;kt=!!lr&&!!ki,lr&&ot.setConstantPatternPositions(lr,ki)}Q>0&&(kt||ot.getPatternTransitionVertexBuffer("fill-pattern"))&&Rt.push("FILL_PATTERN_TRANSITION");const Mt=_.getOrCreateProgram(Ye,{config:ot,overrideFog:Ct,defines:Rt}),ei=_.translatePosMatrix(Nt.projMatrix,rt,S.paint.get("fill-translate"),S.paint.get("fill-translate-anchor"));xe&&_e.setupShadows(rt.tileID.toUnwrapped(),Mt,"vector-tile");const Qt=S.paint.get("fill-emissive-strength");if(qe){nt=dt.lineIndexBuffer,ft=dt.lineSegments;const Kt=_.terrain&&_.terrain.renderingToTexture?_.terrain.drapeBufferSize:[z.drawingBufferWidth,z.drawingBufferHeight];Qe=Ye==="fillOutlinePattern"&&De?Ab(ei,Qt,_,rt,Kt,Fe,Q):Nb(ei,Qt,Kt,Fe)}else nt=dt.indexBuffer,ft=dt.triangleSegments,Qe=De?Rx(ei,Qt,_,rt,Fe,Q):ud(ei,Qt,Fe);_.uploadCommonUniforms(_.context,Mt,Nt.toUnwrapped());let Wt=Se;(D==="road"&&!M||D==="offset")&&(Wt=fe),Mt.draw(_,at,Wt,f||_.stencilModeForClipping(Nt),E,Ai.disabled,Qe,S.id,dt.layoutVertexBuffer,nt,ft,S.paint,_.transform.zoom,ot,Ut)}};_.renderPass===B&&Ee(_.depthModeForSublayer(1,_.renderPass==="opaque"?si.ReadWrite:si.ReadOnly),!1),J==="none"&&_.renderPass==="translucent"&&S.paint.get("fill-antialias")&&Ee(_.depthModeForSublayer(S.getPaintProperty("fill-outline-color")?2:0,si.ReadOnly),!0)}function mh(m,s,d,f,_,b,S,A){d.resetLayerRenderingStats(m);const E=m.context,D=E.gl,M=m.transform,B=d.paint.get("fill-extrusion-pattern"),z=d.paint.get("fill-extrusion-pattern-cross-fade"),V=B.constantOr(null),Q=B.constantOr(1),W=d.paint.get("fill-extrusion-opacity"),J=m.style.enable3dLights(),ce=d.paint.get(J&&!Q?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),_e=[d.paint.get("fill-extrusion-ambient-occlusion-intensity"),ce],xe=d.layout.get("fill-extrusion-edge-radius"),fe=xe>0&&!d.paint.get("fill-extrusion-rounded-roof"),Fe=fe?0:xe,De=M.projection.name==="globe"?o.eb():0,Oe=M.projection.name==="globe",Ee=Oe?o.aj(M.zoom):0,Se=[o.aF(M.center.lng),o.aJ(M.center.lat)],qe=d.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",Ye=d.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(qe?null:d.lut).toArray01().slice(0,3),Qe=d.paint.get("fill-extrusion-flood-light-intensity"),at=d.paint.get("fill-extrusion-vertical-scale"),nt=d.paint.get("fill-extrusion-line-width").constantOr(1)!==0,ft=d.paint.get("fill-extrusion-height-alignment"),Nt=d.paint.get("fill-extrusion-base-alignment"),rt=dl(m,d.paint.get("fill-extrusion-cutoff-fade-range")),$e=[];let dt;Oe&&$e.push("PROJECTION_GLOBE_VIEW"),_e[0]>0&&$e.push("FAUX_AO"),fe&&$e.push("ZERO_ROOF_RADIUS"),A&&$e.push("HAS_CENTROID"),Qe>0&&$e.push("FLOOD_LIGHT"),rt.shouldRenderCutoff&&$e.push("RENDER_CUTOFF"),nt&&$e.push("RENDER_WALL_MODE");const ot=m.renderPass==="shadow",Ct=m.shadowRenderer,Rt=ot&&!!Ct,Ut=ot?Ai.disabled:Ai.backCCW;m.shadowRenderer&&(m.shadowRenderer.useNormalOffset=!0);let kt=[0,0,0];if(Ct){const Qt=m.style.directionalLight,Wt=m.style.ambientLight;Qt&&Wt&&(kt=hl(m.style,Qt,Wt)),ot||($e.push("RENDER_SHADOWS","DEPTH_TEXTURE"),Ct.useNormalOffset&&$e.push("NORMAL_OFFSET")),dt=$e.concat(["SHADOWS_SINGLE_CASCADE"])}const Mt=Rt?"fillExtrusionDepth":Q?"fillExtrusionPattern":"fillExtrusion",ei=d.getLayerRenderingStats();for(const Qt of f){const Wt=s.getTile(Qt),Kt=Wt.getBucket(d);if(!Kt||Kt.projection.name!==M.projection.name)continue;let gi=!1;Ct&&(gi=Ct.getMaxCascadeForTile(Qt.toUnwrapped())===0);const Ci=m.isTileAffectedByFog(Qt),Hi=Kt.programConfigurations.get(d.id);let lr=!1;if(V&&Wt.imageAtlas){const ur=Wt.imageAtlas,Ui=o.e3.from(V),Ir=Ui.getPrimary().scaleSelf(o.o.devicePixelRatio).toString(),hn=Ui.getSecondary(),pn=ur.patternPositions.get(Ir),Pr=hn?ur.patternPositions.get(hn.scaleSelf(o.o.devicePixelRatio).toString()):null;lr=!!pn&&!!Pr,pn&&Hi.setConstantPatternPositions(pn,Pr)}z>0&&(lr||Hi.getPatternTransitionVertexBuffer("fill-extrusion-pattern"))&&$e.push("FILL_EXTRUSION_PATTERN_TRANSITION");const ki=m.getOrCreateProgram(Mt,{config:Hi,defines:gi?dt:$e,overrideFog:Ci});if(m.terrain&&m.terrain.setupElevationDraw(Wt,ki,{useMeterToDem:!0}),!Kt.centroidVertexBuffer){const ur=ki.getAttributeLocation(D,"a_centroid_pos");ur!==-1&&D.vertexAttrib2f(ur,0,0)}!ot&&Ct&&Ct.setupShadows(Wt.tileID.toUnwrapped(),ki,"vector-tile"),Q&&(m.context.activeTexture.set(D.TEXTURE0),Wt.imageAtlasTexture&&Wt.imageAtlasTexture.bind(D.LINEAR,D.CLAMP_TO_EDGE),Hi.updatePaintBuffers());const yr=d.paint.get("fill-extrusion-vertical-gradient"),Li=1/Kt.tileToMeter;let Dr;if(ot&&Ct){if(Vx(Wt.tileID,Kt.maxHeight,m))continue;const ur=Ct.calculateShadowPassMatrixFromTile(Wt.tileID.toUnwrapped());Dr=jx(ur,Fe,Li,at,ft,Nt)}else{const ur=m.translatePosMatrix(Qt.expandedProjMatrix,Wt,d.paint.get("fill-extrusion-translate"),d.paint.get("fill-extrusion-translate-anchor")),Ui=M.projection.createInversionMatrix(M,Qt.canonical);Dr=Q?Tb(ur,m,yr,W,_e,Fe,Li,Qt,Wt,De,ft,Nt,Ee,Se,Ui,Ye,at,z):Zf(ur,m,yr,W,_e,Fe,Li,Qt,De,ft,Nt,Ee,Se,Ui,Ye,at,Qe,kt)}m.uploadCommonUniforms(E,ki,Qt.toUnwrapped(),null,rt);let Rr=Kt.segments;if(M.projection.name==="mercator"&&!ot&&(Rr=Kt.getVisibleSegments(Wt.tileID,m.terrain,m.transform.getFrustum(0)),!Rr.get().length))continue;if(ei)if(ot)for(const ur of Rr.get())ei.numRenderedVerticesInShadowPass+=ur.primitiveLength;else for(const ur of Rr.get())ei.numRenderedVerticesInTransparentPass+=ur.primitiveLength;const Fr=[];(m.terrain||A)&&Fr.push(Kt.centroidVertexBuffer),Oe&&Fr.push(Kt.layoutVertexExtBuffer),nt&&Fr.push(Kt.wallVertexBuffer),ki.draw(m,E.gl.TRIANGLES,_,b,S,Ut,Dr,d.id,Kt.layoutVertexBuffer,Kt.indexBuffer,Rr,d.paint,m.transform.zoom,Hi,Fr)}m.shadowRenderer&&(m.shadowRenderer.useNormalOffset=!1)}class am{constructor(){this.translate=[0,0],this.translateAnchor="map",this.edgeRadius=0,this.cutoffFadeRange=0}}function ic(m,s,d,f,_,b,S,A,E,D,M,B,z,V,Q,W,J,ce,_e,xe){const fe=s.context,Fe=fe.gl,De=s.transform,Oe=s.transform.zoom,Ee=[],Se=m.translate,qe=m.translateAnchor,Ye=m.edgeRadius,Qe=dl(s,m.cutoffFadeRange);M==="clear"?(Ee.push("CLEAR_SUBPASS"),xe&&(Ee.push("CLEAR_FROM_TEXTURE"),fe.activeTexture.set(Fe.TEXTURE0),xe.bind(Fe.LINEAR,Fe.CLAMP_TO_EDGE))):M==="sdf"?Ee.push("SDF_SUBPASS"):M==="emissive"&&(Ee.push("USE_MRT1"),fe.activeTexture.set(Fe.TEXTURE0),xe.bind(Fe.LINEAR,Fe.CLAMP_TO_EDGE)),ce&&Ee.push("HAS_CENTROID"),Qe.shouldRenderCutoff&&Ee.push("RENDER_CUTOFF");const at=(nt,ft,Nt,rt,$e)=>{let dt=Ee;ft.groundRadiusBuffer!=null&&(dt=Ee.concat("HAS_ATTRIBUTE_a_flood_light_ground_radius"));const ot=ft.programConfigurations.get(f.id),Ct=s.isTileAffectedByFog(nt),Rt=s.getOrCreateProgram("fillExtrusionGroundEffect",{config:ot,defines:dt,overrideFog:Ct}),Ut=((Mt,ei,Qt,Wt,Kt,gi,Ci,Hi,lr,ki,yr)=>({u_matrix:ei,u_opacity:Qt,u_ao_pass:Wt?1:0,u_meter_to_tile:Kt,u_ao:gi,u_flood_light_intensity:Ci,u_flood_light_color:Hi,u_attenuation:lr,u_edge_radius:ki,u_fb:0,u_fb_size:yr,u_dynamic_offset:1}))(0,rt,B,D,$e,[z,V*$e],Q,W,J,Oe>=17?0:Ye*$e,xe?xe.size[0]:0),kt=[];ce&&kt.push(ft.hiddenByLandmarkVertexBuffer),ft.groundRadiusBuffer!=null&&kt.push(ft.groundRadiusBuffer),s.uploadCommonUniforms(fe,Rt,nt.toUnwrapped(),null,Qe),Rt.draw(s,fe.gl.TRIANGLES,b,S,A,E,Ut,f.id,ft.vertexBuffer,ft.indexBuffer,Nt,f.paint,Oe,ot,kt)};for(const nt of _){const ft=d.getTile(nt),Nt=ft.getBucket(f);if(!Nt||Nt.projection.name!==De.projection.name||!Nt.groundEffect||Nt.groundEffect&&!Nt.groundEffect.hasData())continue;const rt=Nt.groundEffect,$e=1/Nt.tileToMeter;{const dt=s.translatePosMatrix(nt.projMatrix,ft,Se,qe),ot=rt.getDefaultSegment();at(nt,rt,ot,dt,$e)}if(_e)for(let dt=0;dt<4;dt++){const ot=o.e9[dt](nt),Ct=d.getTile(ot);if(!Ct)continue;const Rt=Ct.getBucket(f);if(!Rt||Rt.projection.name!==De.projection.name||!Rt.groundEffect||Rt.groundEffect&&!Rt.groundEffect.hasData())continue;const Ut=Rt.groundEffect;let kt,Mt;dt===0?(kt=[-o.al,0,0],Mt=1):dt===1?(kt=[o.al,0,0],Mt=0):dt===2?(kt=[0,-o.al,0],Mt=3):(kt=[0,o.al,0],Mt=2);const ei=Ut.regionSegments[Mt];if(!ei)continue;const Qt=new Float32Array(16);o.br(Qt,nt.projMatrix,kt),at(nt,Ut,ei,s.translatePosMatrix(Qt,ft,Se,qe),$e)}}}function Db(m,s,d,f,_,b,S){f.centroidVertexArray.length===0&&f.createCentroidsBuffer();const A=b?b.findDEMTileFor(d):null;if(!(A&&A.dem||S))return;b&&A&&A.dem&&f.selfDEMTileTimestamp!==A.dem._timestamp&&(f.borderDoneWithNeighborZ=[-1,-1,-1,-1],f.selfDEMTileTimestamp=A.dem._timestamp);const E=(J,ce)=>{(J.flags|ce.flags)&o.ec?(J.flags|=o.ec,ce.flags|=o.ec):(J.flags&=~o.ec,ce.flags&=~o.ec)},D=J=>new o.P(Math.ceil((J+o.ed)*o.ee),0),M=J=>{const ce=s.getSource().minzoom,_e=fe=>{const Fe=s.getTileByID(fe);if(Fe&&Fe.hasData())return Fe.getBucket(_)},xe=[0,-1,1];for(const fe of xe){if(J.overscaledZ+fe<ce)continue;const Fe=_e(J.calculateScaledKey(J.overscaledZ+fe));if(Fe)return Fe}},B=[0,0,0],z=(J,ce)=>(B[0]=Math.min(J.min.y,ce.min.y),B[1]=Math.max(J.max.y,ce.max.y),B[2]=o.al-ce.min.x>J.max.x?ce.min.x-o.al:J.max.x,B),V=(J,ce)=>(B[0]=Math.min(J.min.x,ce.min.x),B[1]=Math.max(J.max.x,ce.max.x),B[2]=o.al-ce.min.y>J.max.y?ce.min.y-o.al:J.max.y,B),Q=[(J,ce)=>z(J,ce),(J,ce)=>z(ce,J),(J,ce)=>V(J,ce),(J,ce)=>V(ce,J)],W=(J,ce,_e,xe,fe,Fe,De)=>{if(!b)return 0;const Oe=[[Fe?_e:J,Fe?J:_e,0],[Fe?_e:ce,Fe?ce:_e,0]],Ee=De<0?o.al+De:De,Se=[Fe?Ee:(J+ce)/2,Fe?(J+ce)/2:Ee,0];return _e===0&&De<0||_e!==0&&De>0?b.getForTilePoints(fe,[Se],!0,xe):Oe.push(Se),b.getForTilePoints(d,Oe,!0,A),Math.max(Oe[0][2],Oe[1][2],Se[2])/b.exaggeration()};for(let J=0;J<4;J++){const ce=f.borderFeatureIndices[J];if(ce.length===0)continue;const _e=o.e9[J](d),xe=M(_e);if(!(xe&&xe instanceof o.ea))continue;const fe=b?b.findDEMTileFor(_e):null;if(!(fe&&fe.dem||S)||(b&&fe&&fe.dem&&f.borderDEMTileTimestamp[J]!==fe.dem._timestamp&&(f.borderDoneWithNeighborZ[J]=-1,f.borderDEMTileTimestamp[J]=fe.dem._timestamp),f.borderDoneWithNeighborZ[J]===xe.canonical.z))continue;xe.centroidVertexArray.length===0&&xe.createCentroidsBuffer();const Fe=(J<2?1:5)-J,De=xe.borderDoneWithNeighborZ[Fe]!==f.canonical.z,Oe=xe.borderFeatureIndices[Fe];let Ee=0;if(f.canonical.z!==xe.canonical.z){for(const Se of ce)f.showCentroid(f.featuresOnBorder[Se]);if(De)for(const Se of Oe)xe.showCentroid(xe.featuresOnBorder[Se]);f.borderDoneWithNeighborZ[J]=xe.canonical.z,xe.borderDoneWithNeighborZ[Fe]=f.canonical.z}for(const Se of ce){const qe=f.featuresOnBorder[Se],Ye=f.centroidData[qe.centroidDataIndex],Qe=qe.borders[J];let at;for(;Ee<Oe.length;){at=xe.featuresOnBorder[Oe[Ee]];const nt=at.borders[Fe];if(nt[1]>Qe[0]+3||nt[0]>Qe[0]-3)break;xe.showCentroid(at),Ee++}if(at&&Ee<Oe.length){const nt=Ee;let ft=0;for(;!(at.borders[Fe][0]>Qe[1]-3)&&(ft++,++Ee!==Oe.length);)at=xe.featuresOnBorder[Oe[Ee]];at=xe.featuresOnBorder[Oe[nt]];let Nt=!1;if(ft>=1){const dt=at.borders[Fe];Math.abs(Qe[0]-dt[0])<3&&Math.abs(Qe[1]-dt[1])<3&&(ft=1,Nt=!0,Ee=nt+1)}else if(ft===0){f.showCentroid(qe);continue}const rt=xe.centroidData[at.centroidDataIndex];S&&Nt&&E(Ye,rt);const $e=qe.intersectsCount()>1||at.intersectsCount()>1;if(ft>1)Ee=nt,Ye.centroidXY=rt.centroidXY=new o.P(0,0);else if(fe&&fe.dem&&!$e){const dt=Q[J](Ye,rt),ot=J%2?o.al-1:0,Ct=W(dt[0],Math.min(o.al-1,dt[1]),ot,fe,_e,J<2,dt[2]);Ye.centroidXY=rt.centroidXY=D(Ct)}else $e?Ye.centroidXY=rt.centroidXY=new o.P(0,0):(Ye.centroidXY=f.encodeBorderCentroid(qe),rt.centroidXY=xe.encodeBorderCentroid(at));f.writeCentroidToBuffer(Ye),xe.writeCentroidToBuffer(rt)}else f.showCentroid(qe)}f.borderDoneWithNeighborZ[J]=xe.canonical.z,xe.borderDoneWithNeighborZ[Fe]=f.canonical.z}(f.needsCentroidUpdate||!f.centroidVertexBuffer&&f.centroidVertexArray.length!==0)&&f.uploadCentroid(m)}const Mb=[1,0,0],Ob=[0,1,0],Lb=[0,0,1];function Vx(m,s,d){const f=d.transform,_=d.shadowRenderer;if(!_)return!0;const b=m.toUnwrapped(),S=f.tileSize*_._cascades[d.currentShadowCascade].scale;let A=s;if(f.elevation){const W=f.elevation.getMinMaxForTile(m);W&&(A+=W.max)}const E=[..._.shadowDirection];E[2]=-E[2];const D=_.computeSimplifiedTileShadowVolume(b,A,S,E);if(!D)return!1;const M=[Mb,Ob,Lb,E,[E[0],0,E[2]],[0,E[1],E[2]]],B=f.projection.name==="globe",z=f.scaleZoom(S),V=o.cB.fromInvProjectionMatrix(f.invProjMatrix,f.worldSize,z,!B),Q=_.getCurrentCascadeFrustum();return V.intersectsPrecise(D.vertices,D.planes,M)===0||Q.intersectsPrecise(D.vertices,D.planes,M)===0}function fh(m){const{painter:s,source:d,layer:f,coords:_}=m;let b=m.defines;const S=s.context,A=s.renderPass==="shadow",E=s.renderPass==="light-beam",D=s.shadowRenderer,M=o.ef(s.transform.center.lat,s.transform.zoom),B=dl(s,f.paint.get("building-cutoff-fade-range"));B.shouldRenderCutoff&&(b=b.concat("RENDER_CUTOFF")),m.floodLightIntensity>0&&(b=b.concat("FLOOD_LIGHT"));for(const z of _){const V=d.getTile(z),Q=V.getBucket(f);if(!Q)continue;D&&D.getMaxCascadeForTile(z.toUnwrapped())===0&&(b=b.concat("SHADOWS_SINGLE_CASCADE"));const W=Q.programConfigurations.get(f.id);let J,ce,_e,xe=s.translatePosMatrix(z.expandedProjMatrix,V,[0,0],"map");if(xe=o.cS(o.bC(),xe,[1,1,m.verticalScale]),A&&D){if(Vx(V.tileID,Q.maxHeight*M,s))continue;let Fe=D.calculateShadowPassMatrixFromTile(V.tileID.toUnwrapped());Fe=o.cS(o.bC(),Fe,[1,1,m.verticalScale]),_e=gu(Fe),J=ce=s.getOrCreateProgram("buildingDepth",{config:W,defines:b,overrideFog:!1})}else if(E)J=ce=s.getOrCreateProgram("buildingBloom",{config:W,defines:b,overrideFog:!1}),_e=Cb(xe);else{const Fe=s.transform.calculatePosMatrix(z.toUnwrapped(),s.transform.worldSize);o.cS(Fe,Fe,[1,1,m.verticalScale]);const De=o.bC();o.cS(De,Fe,[1,-1,1/M]),o.bl(De,De),o.eg(De,De);const Oe=s.transform.getFreeCameraOptions().position,Ee=1<<z.canonical.z;if(_e=Xf(xe,De,m.opacity,m.facadeAOIntensity,[((Oe.x-z.wrap)*Ee-z.canonical.x)*o.al,(Oe.y*Ee-z.canonical.y)*o.al,Oe.z*Ee*o.al],Q.tileToMeter,m.facadeEmissiveChance,m.floodLightColor,m.floodLightIntensity),ce=s.getOrCreateProgram("building",{config:W,defines:b,overrideFog:!1}),m.depthOnly===!0)J=ce;else{const Se=b.concat(["BUILDING_FAUX_FACADE","HAS_ATTRIBUTE_a_faux_facade_color_emissive"]);J=s.getOrCreateProgram("building",{config:W,defines:Se,overrideFog:!1})}D&&(D.setupShadowsFromMatrix(Fe,ce,!0),J!==ce&&D.setupShadowsFromMatrix(Fe,J,!0))}const fe=(Fe,De)=>{if(E){const Oe=Fe.entranceBloom;De.draw(s,S.gl.TRIANGLES,m.depthMode,ji.disabled,m.blendMode,Ai.disabled,_e,f.id,Oe.layoutVertexBuffer,Oe.indexBuffer,Oe.segmentsBucket,f.paint,s.transform.zoom,W,[Oe.layoutAttenuationBuffer,Oe.layoutColorBuffer])}else{const Oe=Fe.segmentsBucket;let Ee=[Fe.layoutNormalBuffer,Fe.layoutCentroidBuffer,Fe.layoutColorBuffer,Fe.layoutFloodLightDataBuffer];Fe.layoutFacadePaintBuffer&&(Ee=Ee.concat([Fe.layoutFacadeDataBuffer,Fe.layoutFacadeVerticalRangeBuffer,Fe.layoutFacadePaintBuffer])),De.draw(s,S.gl.TRIANGLES,m.depthMode,ji.disabled,m.blendMode,A?Ai.disabled:Ai.backCW,_e,f.id,Fe.layoutVertexBuffer,Fe.indexBuffer,Oe,f.paint,s.transform.zoom,W,Ee)}};s.uploadCommonUniforms(S,ce,z.toUnwrapped(),null,B),Q.buildingWithoutFacade&&fe(Q.buildingWithoutFacade,ce),Q.buildingWithFacade&&(J!==ce&&s.uploadCommonUniforms(S,J,z.toUnwrapped(),null,B),fe(Q.buildingWithFacade,J))}}function ng(m,s,d,f,_,b,S,A,E,D,M,B,z){const V=m.context.gl,Q=m.depthModeForSublayer(1,si.ReadOnly,V.LEQUAL,!0),W=.1*(1-(J=M))+3*J;var J;const ce=m._showOverdrawInspector,_e=B,xe=new am;ce||ic(xe,m,s,d,f,Q,new ji({func:V.ALWAYS,mask:255},255,255,V.KEEP,V.KEEP,V.REPLACE),new Di([V.ONE,V.ONE,V.ONE,V.ONE],o.ao.transparent,[!1,!1,!1,!0],V.MIN),Ai.disabled,_,"sdf",b,S,A,E,D,W,_e,!1);{const fe=ce?ji.disabled:new ji({func:V.EQUAL,mask:255},255,255,V.KEEP,V.DECR,V.DECR),Fe=ce?m.colorModeForRenderPass():new Di([V.ONE_MINUS_DST_ALPHA,V.DST_ALPHA,V.ONE,V.ONE],o.ao.transparent,[!0,!0,!0,!0]);ic(xe,m,s,d,f,Q,fe,Fe,Ai.disabled,_,"color",b,S,A,E,D,W,_e,!1)}}function Ux(m){return[m[0]*o.eh,m[1]*o.eh,m[2]*o.eh,0]}function sg(m,s,d,f,_,b,S,A,E){const D=f.getSource(),M=d.globeSharedBuffers;if(!M)return;let B,z,V;if(s&&(B=f.getTile(s)),D instanceof o.aU?(z=D.texture,V=o.dK(0,0,d.transform)):B&&s&&(z=B.texture,V=o.dK(s.canonical.z,s.canonical.x,d.transform)),!z||!V)return;m||(V=o.cS(o.bC(),V,[1,-1,1]));const Q=d.context,W=Q.gl,J=_.paint.get("raster-resampling")==="nearest"?W.NEAREST:W.LINEAR,ce=d.colorModeForDrapableLayerRenderPass(b),_e=S.defines;_e.push("GLOBE_POLES");const xe=new si(W.LEQUAL,si.ReadWrite,d.depthRangeFor3D),fe=Float32Array.from(d.transform.expandedFarZProjMatrix),Fe=Float32Array.from(o.bk(o.dJ(new o.cD(0,0,0))));d.terrain&&d.terrain.prepareDrawTile(),Q.activeTexture.set(W.TEXTURE0),z.bind(J,W.CLAMP_TO_EDGE),Q.activeTexture.set(W.TEXTURE1),z.bind(J,W.CLAMP_TO_EDGE),"useMipmap"in z&&Q.extTextureFilterAnisotropic&&d.transform.pitch>20&&W.texParameterf(W.TEXTURE_2D,Q.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Q.extTextureFilterAnisotropicMax);const[De,Oe,Ee,Se]=s?M.getPoleBuffers(s.canonical.z,!1):M.getPoleBuffers(0,!0),qe=_.paint.get("raster-elevation");let Ye;m?(Ye=De,d.renderDefaultNorthPole=qe!==0):(Ye=Oe,d.renderDefaultSouthPole=qe!==0);const Qe=Ux(S.mix),at=((ft,Nt,rt,$e,dt,ot,Ct,Rt,Ut,kt,Mt,ei,Qt)=>Lx(ft,Nt,rt,new Float32Array(16),new Float32Array(9),[0,0],$e,[0,0],[0,0,0,0],1,{opacity:1,mix:0},ot,[0,0],Rt,2,kt,Mt,ei,1,0,Qt))(fe,Fe,V,o.aj(d.transform.zoom),0,_,0,qe,0,Qe,S.offset,S.range,b),nt=d.getOrCreateProgram("raster",{defines:_e});d.uploadCommonUniforms(Q,nt,null),nt.draw(d,W.TRIANGLES,xe,E,ce,A,at,_.id,Ye,Ee,Se)}function Fb(m){if(m.isOrthographic)return[0,0,0,0];const s=m._nearZ,d=m.projection.farthestPixelDistance(m),f=d-s,_=.2*m.height,b=s+_;return[s,d,(b-_-s)/f,(b-s)/f]}function zb(m,s,d,f){if(m)return s instanceof Os&&m instanceof eh?s.getTextureDescriptor(m,d,!0):{texture:m.texture,mix:Ux(f.mix),offset:f.offset,buffer:0,tileSize:1}}var qx=o.ei([{name:"a_index",type:"Int16",components:1}]);class Bb{constructor(s,d,f,_){const b={width:f[0],height:f[1],data:null},S=s.gl;this.targetColorTexture=new o.T(s,b,S.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new o.T(s,b,S.RGBA8,{useMipmap:!1}),this.context=s,this.updateParticleTexture(d,_),this.lastInvalidatedAt=0}updateParticleTexture(s,d){if(this.particleTextureDimension===d.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const f=this.context.gl,_=d.width*d.height;this.particleTexture0=new o.T(this.context,d,f.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new o.T(this.context,d,f.RGBA8,{premultiply:!1,useMipmap:!1});const b=new o.ej;b.reserve(_);for(let S=0;S<_;S++)b.emplaceBack(S);this.particleIndexBuffer=this.context.createVertexBuffer(b,qx.members,!0),this.particleSegment=o.bg.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=d.width}update(s){return!(this.lastInvalidatedAt<s&&(this.lastInvalidatedAt=o.o.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function $x(m,s,d){if(!m)return null;const f=s.getTextureDescriptor(m,d,!0);if(!f)return null;let{texture:_,mix:b,offset:S,tileSize:A,buffer:E,format:D}=f;if(!_||!D)return null;let M=!1;return D==="uint32"&&(M=!0,b[3]=0,b=Kf(o.ek,b,[0,d.paint.get("raster-particle-max-speed")]),S=Ib(o.ek,S,[0,d.paint.get("raster-particle-max-speed")])),{texture:_,textureOffset:[E/(A+2*E),A/(A+2*E)],tileSize:A,scalarData:M,scale:b,offset:S,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[D]]}}function Vb(m){const s=m._nearZ,d=m.projection.farthestPixelDistance(m),f=d-s,_=.2*m.height,b=s+_;return[s,d,(b-_-s)/f,(b-s)/f]}const Gx=new o.ao(1,0,0,1),Hx=new o.ao(0,1,0,1),Wx=new o.ao(0,0,1,1),uN=new o.ao(1,0,1,1),dN=new o.ao(0,1,1,1);function Ub(m,s,d,f,_,b){for(let S=0;S<d.length;S++)if(_){const D=new o.ao(f.r*.8,f.g*.8,f.b*.8,1);xu(m,s,d[S],f,-1,-1,b),xu(m,s,d[S],f,-1,1,b),xu(m,s,d[S],f,1,1,b),xu(m,s,d[S],f,1,-1,b),xu(m,s,d[S],D,0,0,b)}else xu(m,s,d[S],f,0,0,b)}function xu(m,s,d,f,_,b,S){const A=m.context,E=m.transform,D=A.gl,M=E.projection.name==="globe",B=M?["PROJECTION_GLOBE_VIEW"]:[];let z=o.bz(d.projMatrix);if(M&&o.aj(E.zoom)>0){const Qe=o.bj(d.canonical,E),at=o.el(Qe);z=o.aB(new Float32Array(16),E.globeMatrix,at),o.aB(z,E.projMatrix,z)}const V=o.bC();V[12]+=2*_/(o.o.devicePixelRatio*E.width),V[13]+=2*b/(o.o.devicePixelRatio*E.height),o.aB(z,V,z);const Q=m.getOrCreateProgram("debug",{defines:B}),W=s.getTileByID(d.key);m.terrain&&m.terrain.setupElevationDraw(W,Q);const J=si.disabled,ce=ji.disabled,_e=m.colorModeForRenderPass(),xe="$debug";A.activeTexture.set(D.TEXTURE0),m.emptyTexture.bind(D.LINEAR,D.CLAMP_TO_EDGE),M?W._makeGlobeTileDebugBuffers(m.context,E):W._makeDebugTileBoundsBuffers(m.context,E.projection);const fe=W._tileDebugBuffer||m.debugBuffer,Fe=W._tileDebugIndexBuffer||m.debugIndexBuffer,De=W._tileDebugSegments||m.debugSegments;if(Q.draw(m,D.LINE_STRIP,J,ce,_e,Ai.disabled,Mx(z,f.toPremultipliedRenderColor(null)),xe,fe,Fe,De,null,null,null,[W._globeTileDebugBorderBuffer]),S){const Qe=W.latestRawTileData,at=Math.floor((Qe&&Qe.byteLength||0)/1024);let nt=d.canonical.toString();d.overscaledZ!==d.canonical.z&&(nt+=` => ${d.overscaledZ}`),nt+=` ${W.state}`,nt+=` ${at}kb`,function(ft,Nt){ft.initDebugOverlayCanvas();const rt=ft.debugOverlayCanvas,$e=ft.context.gl,dt=ft.debugOverlayCanvas.getContext("2d");dt.clearRect(0,0,rt.width,rt.height),dt.shadowColor="white",dt.shadowBlur=2,dt.lineWidth=1.5,dt.strokeStyle="white",dt.textBaseline="top",dt.font="bold 36px Open Sans, sans-serif",dt.fillText(Nt,5,5),dt.strokeText(Nt,5,5),ft.debugOverlayTexture.update(rt),ft.debugOverlayTexture.bind($e.LINEAR,$e.CLAMP_TO_EDGE)}(m,nt)}const Oe=s.getTile(d).tileSize,Ee=512/Math.min(Oe,512)*(d.overscaledZ/E.zoom)*.5,Se=W._tileDebugTextBuffer||m.debugBuffer,qe=W._tileDebugTextIndexBuffer||m.quadTriangleIndexBuffer,Ye=W._tileDebugTextSegments||m.debugSegments;Q.draw(m,D.TRIANGLES,J,ce,Di.alphaBlended,Ai.disabled,Mx(z,o.ao.transparent.toPremultipliedRenderColor(null),Ee),xe,Se,qe,Ye,null,null,null,[W._globeTileDebugTextBuffer])}function qb(m,s,d,f){ag(m,0,s+d/2,m.transform.width,d,f)}function Zx(m,s,d,f){ag(m,s-d/2,0,d,m.transform.height,f)}function ag(m,s,d,f,_,b){const S=m.context,A=S.gl;A.enable(A.SCISSOR_TEST),A.scissor(s*o.o.devicePixelRatio,d*o.o.devicePixelRatio,f*o.o.devicePixelRatio,_*o.o.devicePixelRatio),S.clear({color:b}),A.disable(A.SCISSOR_TEST)}const $b=o.ei([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:hN}=$b;function _u(m,s,d,f){m.emplaceBack(s,d,f)}class io{constructor(s){this.vertexArray=new o.em,this.indices=new o.b0,_u(this.vertexArray,-1,-1,1),_u(this.vertexArray,1,-1,1),_u(this.vertexArray,-1,1,1),_u(this.vertexArray,1,1,1),_u(this.vertexArray,-1,-1,-1),_u(this.vertexArray,1,-1,-1),_u(this.vertexArray,-1,1,-1),_u(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=s.createVertexBuffer(this.vertexArray,hN),this.indexBuffer=s.createIndexBuffer(this.indices),this.segment=o.bg.simpleSegment(0,0,36,12)}}function vu(m,s,d,f,_,b){const S=m.context.gl,A=s.paint.get("sky-atmosphere-color"),E=s.paint.get("sky-atmosphere-halo-color"),D=s.paint.get("sky-atmosphere-sun-intensity"),M=((B,z,V,Q,W)=>({u_matrix_3f:B,u_sun_direction:z,u_sun_intensity:V,u_color_tint_r:[Q.r,Q.g,Q.b,Q.a],u_color_tint_m:[W.r,W.g,W.b,W.a],u_luminance:5e-5}))(o.eo(o.dO(),f),_,D,A.toPremultipliedRenderColor(null),E.toPremultipliedRenderColor(null));S.framebufferTexture2D(S.FRAMEBUFFER,S.COLOR_ATTACHMENT0,S.TEXTURE_CUBE_MAP_POSITIVE_X+b,s.skyboxTexture,0),d.draw(m,S.TRIANGLES,si.disabled,ji.disabled,Di.unblended,Ai.frontCW,M,"skyboxCapture",s.skyboxGeometry.vertexBuffer,s.skyboxGeometry.indexBuffer,s.skyboxGeometry.segment)}const Fa=o.ei([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class bu{constructor(s){const d=new o.ep;d.emplaceBack(-1,1,1,0,0),d.emplaceBack(1,1,1,1,0),d.emplaceBack(1,-1,1,1,1),d.emplaceBack(-1,-1,1,0,1);const f=new o.b0;f.emplaceBack(0,1,2),f.emplaceBack(2,3,0),this.vertexBuffer=s.createVertexBuffer(d,Fa.members),this.indexBuffer=s.createIndexBuffer(f),this.segments=o.bg.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const Gb=o.ei([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class Xx{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class Yx{constructor(s){this.colorModeAlphaBlendedWriteRGB=new Di([1,cu,1,cu],o.ao.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new Di([1,0,1,0],o.ao.transparent,[!1,!1,!1,!0]),this.params=new Xx,this.updateNeeded=!0}update(s){const d=s.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new bu(d);const f=this.params.sizeRange,_=this.params.intensityRange,b=function(M){const B=o.eq(30),z=[];for(let V=0;V<M;++V){const Q=2*Math.PI*B(),W=Math.acos(1-2*B())-.5*Math.PI;z.push(o.d5(Math.cos(W)*Math.cos(Q),Math.cos(W)*Math.sin(Q),Math.sin(W)))}return z}(this.params.starsCount),S=o.eq(300),A=new o.er,E=new o.b0;let D=0;for(let M=0;M<b.length;++M){const B=o.c5([],b[M],200),z=Math.max(0,1+.01*f*(1*S()-.5)),V=Math.max(0,1+.01*_*(1*S()-.5));A.emplaceBack(B[0],B[1],B[2],-1,-1,z,V),A.emplaceBack(B[0],B[1],B[2],1,-1,z,V),A.emplaceBack(B[0],B[1],B[2],1,1,z,V),A.emplaceBack(B[0],B[1],B[2],-1,1,z,V),E.emplaceBack(D+0,D+1,D+2),E.emplaceBack(D+0,D+2,D+3),D+=4}this.starsVx=d.createVertexBuffer(A,Gb.members),this.starsIdx=d.createIndexBuffer(E),this.starsSegments=o.bg.simpleSegment(0,0,A.length,E.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(s,d){const f=s.context,_=f.gl,b=s.transform,S=new si(_.LEQUAL,si.ReadOnly,[0,1]),A=o.aj(b.zoom),E=s.style.getLut(d.scope),D=d.properties.get("color-use-theme")==="none",M=d.properties.get("color").toNonPremultipliedRenderColor(D?null:E),B=d.properties.get("high-color-use-theme")==="none",z=d.properties.get("high-color").toNonPremultipliedRenderColor(B?null:E),V=d.properties.get("space-color-use-theme")==="none",Q=d.properties.get("space-color").toNonPremultipliedRenderColor(V?null:E),W=5e-4,J=o.es(d.properties.get("horizon-blend"),0,1,W,.25),ce=o.dE(s,f,b)&&J===W?b.worldSize/(2*Math.PI*1.025)-1:b.globeRadius,_e=s.frameCounter/1e3%1,xe=o.ag(b.globeCenterInViewSpace),fe=Math.sqrt(Math.pow(xe,2)-Math.pow(ce,2)),Fe=Math.acos(fe/xe),De=Oe=>{const Ee=b.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];Oe&&Ee.push("ALPHA_PASS");const Se=s.getOrCreateProgram("globeAtmosphere",{defines:Ee}),qe=((Qe,at,nt,ft,Nt,rt,$e,dt,ot,Ct,Rt,Ut)=>({u_frustum_tl:Qe,u_frustum_tr:at,u_frustum_br:nt,u_frustum_bl:ft,u_horizon:Nt,u_transition:rt,u_fadeout_range:$e,u_atmosphere_fog_color:dt.toArray01(),u_high_color:ot.toArray01(),u_space_color:Ct.toArray01(),u_temporal_offset:Rt,u_horizon_angle:Ut}))(b.frustumCorners.TL,b.frustumCorners.TR,b.frustumCorners.BR,b.frustumCorners.BL,b.frustumCorners.horizon,A,J,M,z,Q,_e,Fe);s.uploadCommonUniforms(f,Se);const Ye=this.atmosphereBuffer;Ye&&Se.draw(s,_.TRIANGLES,S,ji.disabled,Oe?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Ai.backCW,qe,Oe?"atmosphere_glow_alpha":"atmosphere_glow",Ye.vertexBuffer,Ye.indexBuffer,Ye.segments)};De(!1),De(!0)}drawStars(s,d){const f=o.aA(d.properties.get("star-intensity"),0,1);if(f===0)return;const _=s.context,b=_.gl,S=s.transform,A=s.getOrCreateProgram("stars"),E=o.c7([]);o.c9(E,E,-S._pitch),o.c8(E,E,-S.angle),o.c9(E,E,o.an(S._center.lat)),o.et(E,E,-o.an(S._center.lng));const D=o.cc(new Float32Array(16),E),M=o.aB([],S.starsProjMatrix,D),B=o.eo([],D),z=o.eu([],B),V=[0,1,0];o.dQ(V,V,z),o.c5(V,V,this.params.sizeMultiplier);const Q=[1,0,0];o.dQ(Q,Q,z),o.c5(Q,Q,this.params.sizeMultiplier);const W=(J=V,ce=Q,_e=f,{u_matrix:Float32Array.from(M),u_up:J,u_right:ce,u_intensity_multiplier:_e});var J,ce,_e;s.uploadCommonUniforms(_,A),this.starsVx&&this.starsIdx&&A.draw(s,b.TRIANGLES,si.disabled,ji.disabled,this.colorModeAlphaBlendedWriteRGB,Ai.disabled,W,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}class Kx{constructor(){this.visibleTiles=[]}updateBorders(s,d){const f=[],_=[],b=s._getRenderableCoordinates(!1,!0);for(const E of b){const D=s.getTile(E);if(!D.hasData())continue;const M=D.getBucket(d);M&&(M.isEmpty()||(f.push(E.key),_.push({bucket:M,tileID:E.canonical})))}let S=f.length!==this.visibleTiles.length;if(!S){f.sort();for(let E=0;E<f.length;E++)if(f[E]!==this.visibleTiles[E]){S=!0;break}}if(!S)return;const A=new Set;this.visibleTiles=f,_.sort((E,D)=>E.tileID.z-D.tileID.z||E.tileID.x-D.tileID.x||E.tileID.y-D.tileID.y);for(const E of _){const D=new Array,M=new Array,B=E.bucket;for(const z of B.featuresOnBorder)A.has(z.featureId)?M.push(z.footprintIndex):(A.add(z.featureId),D.push(z.footprintIndex));B.updateFootprintHiddenFlags(D,o.ev,!1),B.updateFootprintHiddenFlags(M,o.ev,!0)}}}function Qx(m,s){const d=[...m],f=s.cameraWorldSizeForFog/s.worldSize,_=o.bA([]);return o.cS(_,_,[f,f,1]),o.aB(d,_,d),o.aB(d,s.worldToFogMatrix,d),d}function El(m,s,d,f,_){const b=d.material,S=f.context,{baseColorTexture:A,metallicRoughnessTexture:E}=b.pbrMetallicRoughness,{normalTexture:D,occlusionTexture:M,emissionTexture:B}=b;function z(Q,W,J){if(Q&&(m.push(W),S.activeTexture.set(S.gl.TEXTURE0+J),Q.gfxTexture)){const{minFilter:ce,magFilter:_e,wrapS:xe,wrapT:fe}=Q.sampler;Q.gfxTexture.bindExtraParam(ce,_e,xe,fe)}}z(A,"HAS_TEXTURE_u_baseColorTexture",5),z(E,"HAS_TEXTURE_u_metallicRoughnessTexture",6),z(D,"HAS_TEXTURE_u_normalTexture",7),z(M,"HAS_TEXTURE_u_occlusionTexture",8),z(B,"HAS_TEXTURE_u_emissionTexture",9),_&&(_.texture||(_.texture=new o.d$(f.context,_.image,[_.image.height,_.image.height,_.image.height],S.gl.RGBA8)),S.activeTexture.set(S.gl.TEXTURE0+10),_.texture&&_.texture.bind(S.gl.LINEAR,S.gl.CLAMP_TO_EDGE),m.push("APPLY_LUT_ON_GPU")),d.texcoordBuffer&&(m.push("HAS_ATTRIBUTE_a_uv_2f"),s.push(d.texcoordBuffer)),d.colorBuffer&&(m.push(d.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),s.push(d.colorBuffer)),d.normalBuffer&&(m.push("HAS_ATTRIBUTE_a_normal_3f"),s.push(d.normalBuffer)),d.pbrBuffer&&(m.push("HAS_ATTRIBUTE_a_pbr"),m.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),s.push(d.pbrBuffer)),b.alphaMode!=="OPAQUE"&&b.alphaMode!=="MASK"||m.push("UNPREMULT_TEXTURE_IN_SHADER"),b.defined||m.push("DIFFUSE_SHADED");const V=f.shadowRenderer;V&&(m.push("RENDER_SHADOWS","DEPTH_TEXTURE"),V.useNormalOffset&&m.push("NORMAL_OFFSET"))}function Vr(m,s,d,f,_,b){const S=m.modelOpacity,A=s.context,E=new si(s.context.gl.LEQUAL,m.isLightMesh?si.ReadOnly:si.ReadWrite,s.depthRangeFor3D),D=s.transform,M=m.mesh,B=M.material,z=B.pbrMetallicRoughness,V=s.style.fog;let Q;Q=s.transform.projection.zAxisUnit==="pixels"?[...m.nodeModelMatrix]:o.aB([],f.zScaleMatrix,m.nodeModelMatrix),o.aB(Q,f.negCameraPosMatrix,Q);const W=o.bl([],Q);o.eg(W,W);const J=d.paint.get("model-color-use-theme").constantOr("default")==="none",ce=d.paint.get("model-emissive-strength").constantOr(0),_e=Jf(new Float32Array(m.worldViewProjection),new Float32Array(Q),new Float32Array(W),null,s,S,z.baseColorFactor,B.emissiveFactor,z.metallicFactor,z.roughnessFactor,B,ce,d,void 0,void 0,m.materialOverride,m.modelColor),xe={defines:[]},fe=[],Fe=s.shadowRenderer;Fe&&(Fe.useNormalOffset=!1),El(xe.defines,fe,M,s,J?null:d.lut);let De=null;if(V){const Se=Qx(m.nodeModelMatrix,s.transform);if(De=new Float32Array(Se),D.projection.name!=="globe"){const qe=M.aabb.min,Ye=M.aabb.max,[Qe,at]=V.getOpacityForBounds(Se,qe[0],qe[1],Ye[0],Ye[1]);xe.overrideFog=Qe>=Ht||at>=Ht}}const Oe=dl(s,d.paint.get("model-cutoff-fade-range"));Oe.shouldRenderCutoff&&xe.defines.push("RENDER_CUTOFF");const Ee=s.getOrCreateProgram("model",xe);s.uploadCommonUniforms(A,Ee,null,De,Oe),s.renderPass!=="shadow"&&Fe&&Fe.setupShadowsFromMatrix(m.nodeModelMatrix,Ee),Ee.draw(s,A.gl.TRIANGLES,E,_,b,M.material.doubleSided?Ai.disabled:Ai.backCCW,_e,d.id,M.vertexBuffer,M.indexBuffer,M.segments,d.paint,s.transform.zoom,void 0,fe)}function om(m,s){return m.style._importedAsBasemap?"basemap":s.scope}function lm(m,s,d,f,_,b,S,A,E,D){const M=m.transform,B=!!s.isGeometryBloom&&s.isGeometryBloom;if(B&&m.renderPass==="shadow")return;const z=M.projection.name==="globe"?o.eD(d,M):[...d];o.aB(z,z,s.globalMatrix);const V=o.aB([],f,z);if(s.meshes)for(const Q of s.meshes){const W=A.get(Q.material.name);if(W&&W.opacity<=0)continue;if(Q.material.alphaMode!=="BLEND"){S.push({mesh:Q,depth:0,modelIndex:_,worldViewProjection:V,nodeModelMatrix:z,isLightMesh:B,materialOverride:W,modelOpacity:E,modelColor:D});continue}const J=o.af([],Q.centroid,V);!M.isOrthographic&&J[2]<=0||b.push({mesh:Q,depth:J[2],modelIndex:_,worldViewProjection:V,nodeModelMatrix:z,isLightMesh:B,materialOverride:W,modelOpacity:E,modelColor:D})}if(s.children)for(const Q of s.children)lm(m,Q,d,f,_,b,S,A,E,D)}function gh(m,s,d,f){const _=d.shadowRenderer;if(!_)return;const b=_.getShadowPassDepthMode(),S=_.getShadowPassColorMode(),A=_.calculateShadowPassMatrixFromMatrix(s),E=sm(A);d.getOrCreateProgram("modelDepth",{defines:d._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(d,d.context.gl.TRIANGLES,b,ji.disabled,S,Ai.disabled,E,f.id,m.vertexBuffer,m.indexBuffer,m.segments,f.paint,d.transform.zoom,void 0,void 0)}function Hb(m,s,d,f,_,b){for(const S of _){const A=Object.assign({},f);A.part=S;const E={type:"Unknown",id:s,properties:A},D={orientation:m.paint.get("model-rotation").evaluate(E,d)};b.set(S,D)}}function Wb(m,s,d,f,_,b){for(const S of _){const A=Object.assign({},f);A.part=S;const E={type:"Unknown",id:s,properties:A},D={color:m.paint.get("model-color").evaluate(E,d),colorMix:m.paint.get("model-color-mix-intensity").evaluate(E,d),opacity:m.paint.get("model-opacity").evaluate(E,d),emissionStrength:m.paint.get("model-emissive-strength").evaluate(E,d)};b.set(S,D)}}function Jx(m,s,d,f,_){let b=!1;for(const A of f)A.modelOpacity!==1&&(Vr(A,m,s,_[A.modelIndex],ji.disabled,Di.disabled),b=!0);for(const A of f)Vr(A,m,s,_[A.modelIndex],A.modelOpacity!==1?m.stencilModeFor3D():ji.disabled,m.colorModeForRenderPass());b&&m.resetStencilClippingMasks();const S=Di.additive;for(const A of d)Vr(A,m,s,_[A.modelIndex],ji.disabled,A.isLightMesh?S:m.colorModeForRenderPass())}function md(m,s,d){const f=s.updateZoomBasedPaintProperties(),_=function(b,S,A){let E,D,M,B=b.terrain?b.terrain.exaggeration():0;if(b.terrain&&B>0){const z=b.terrain,V=z.findDEMTileFor(A);V&&V.dem?E=o.eF.create(z,A,V):B=0}if(B===0&&(S.terrainElevationMin=0,S.terrainElevationMax=0),B===S.validForExaggeration&&(B===0||E&&E._demTile&&E._demTile.tileID===S.validForDEMTile.id&&E._dem._timestamp===S.validForDEMTile.timestamp))return!1;for(const z in S.instancesPerModel){const V=S.instancesPerModel[z];for(let Q=0;Q<V.instancedDataArray.length;++Q){const W=(E?B*E.getElevationAt(0|V.instancedDataArray.float32[16*Q],0|V.instancedDataArray.float32[16*Q+1],!0,!0):0)+V.instancesEvaluatedElevation[Q];V.instancedDataArray.float32[16*Q+6]=W,D=D?Math.min(S.terrainElevationMin,W):W,M=M?Math.max(S.terrainElevationMax,W):W}}return S.terrainElevationMin=D||0,S.terrainElevationMax=M||0,S.validForExaggeration=B,S.validForDEMTile=E&&E._demTile?{id:E._demTile.tileID,timestamp:E._dem._timestamp}:{id:void 0,timestamp:0},!0}(m,s,d);(f||_)&&(s.uploaded=!1,s.upload(m.context))}const za={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new o.d9([0,0,0],[o.al,o.al,0])};function Dt(m,s){const d=1<<m.canonical.z,f=s.getFreeCameraOptions().position,_=s.elevation,b=m.canonical.x/d,S=(m.canonical.x+1)/d,A=m.canonical.y/d,E=(m.canonical.y+1)/d;let D=s._centerAltitude;if(_){const V=_.getMinMaxForTile(m);V&&V.max>D&&(D=V.max)}const M=o.aA(f.x,b,S)-f.x,B=o.aA(f.y,A,E)-f.y,z=o.cf(D,s.center.lat)-f.z;return s._zoomFromMercatorZ(Math.sqrt(M*M+B*B+z*z))}function $t(m,s,d,f,_,b,S){const A=m.context,E=m.renderPass==="shadow",D=m.shadowRenderer,M=E&&D?D.getShadowPassDepthMode():new si(A.gl.LEQUAL,si.ReadWrite,m.depthRangeFor3D),B=m.isTileAffectedByFog(b),z=m.transform.projection.name==="globe";if(d.meshes)for(const V of d.meshes){const Q=z?[]:["MODEL_POSITION_ON_GPU"],W=[];let J,ce,_e;const xe=!z&&f.instancedDataArray.length>20;xe&&Q.push("INSTANCED_ARRAYS");const fe=dl(m,s.paint.get("model-cutoff-fade-range"));if(fe.shouldRenderCutoff&&Q.push("RENDER_CUTOFF"),E&&D)J=m.getOrCreateProgram("modelDepth",{defines:Q}),ce=sm(S.shadowTileMatrix,S.shadowTileMatrix,Float32Array.from(d.globalMatrix)),_e=D.getShadowPassColorMode();else{El(Q,W,V,m,s.paint.get("model-color-use-theme").constantOr("default")==="none"?null:s.lut),J=m.getOrCreateProgram("model",{defines:Q,overrideFog:B});const De=V.material,Oe=De.pbrMetallicRoughness,Ee=s.paint.get("model-opacity").constantOr(1),Se=s.paint.get("model-emissive-strength").constantOr(0);ce=Jf(b.expandedProjMatrix,Float32Array.from(d.globalMatrix),new Float32Array(16),null,m,Ee,Oe.baseColorFactor,De.emissiveFactor,Oe.metallicFactor,Oe.roughnessFactor,De,Se,s,_),D&&(S.shadowUniformsInitialized?J.setShadowUniformValues(A,D.getShadowUniformValues()):(D.setupShadows(b.toUnwrapped(),J,"model-tile"),S.shadowUniformsInitialized=!0)),_e=fe.shouldRenderCutoff||Ee<1||De.alphaMode!=="OPAQUE"?Di.alphaBlended:Di.unblended}m.uploadCommonUniforms(A,J,b.toUnwrapped(),null,fe);const Fe=V.material.doubleSided?Ai.disabled:Ai.backCCW;if(xe)W.push(f.instancedDataBuffer),J.draw(m,A.gl.TRIANGLES,M,ji.disabled,_e,Fe,ce,s.id,V.vertexBuffer,V.indexBuffer,V.segments,s.paint,m.transform.zoom,void 0,W,f.instancedDataArray.length);else{const De=E?"u_instance":"u_normal_matrix";for(let Oe=0;Oe<f.instancedDataArray.length;++Oe)ce[De]=new Float32Array(f.instancedDataArray.arrayBuffer,64*Oe,16),J.draw(m,A.gl.TRIANGLES,M,ji.disabled,_e,Fe,ce,s.id,V.vertexBuffer,V.indexBuffer,V.segments,s.paint,m.transform.zoom,void 0,W)}}if(d.children)for(const V of d.children)$t(m,s,V,f,_,b,S)}const yh=[1,-1,1];function kn(m,s,d,f){if(!d.modelManager)return!0;const _=d.modelManager;if(!d.shadowRenderer)return!0;const b=d.shadowRenderer,S=s.aabb;let A=!0,E=m.maxHeight;if(E===0){let M=0;for(const B in m.instancesPerModel){const z=_.getModel(B,f);z?M=Math.max(M,Math.max(Math.max(z.aabb.max[0],z.aabb.max[1]),z.aabb.max[2])):A=!1}E=m.maxScale*M*1.41+m.maxVerticalOffset,A&&(m.maxHeight=E)}S.max[2]=E,S.min[2]+=m.terrainElevationMin,S.max[2]+=m.terrainElevationMax,o.af(S.min,S.min,s.tileMatrix),o.af(S.max,S.max,s.tileMatrix);const D=S.intersects(b.getCurrentCascadeFrustum());return d.currentShadowCascade===0&&(m.isInsideFirstShadowMapFrustum=D===2),D===0}function et(m,s){const d=m.uniformValues.u_cutoff_params[0],f=m.uniformValues.u_cutoff_params[1],_=m.uniformValues.u_cutoff_params[2],b=m.uniformValues.u_cutoff_params[3];return f===d||b===_?1:o.aA(((s-d)/(f-d)-_)/(b-_),0,1)}function Zb(m,s,d,f){if(s.pitch<20)return 1;const _=s.getWorldToCameraMatrix();o.aB(_,_,m);const b=o.bU(d.min[0],d.min[1],d.min[2],1);let S=o.aC(o.eG(),b,_),A=S,E=S;b[1]=d.max[1],S=o.aC(o.eG(),b,_),A=S[1]<A[1]?S:A,E=S[1]>E[1]?S:E,b[0]=d.max[0],S=o.aC(o.eG(),b,_),A=S[1]<A[1]?S:A,E=S[1]>E[1]?S:E,b[1]=d.min[1],S=o.aC(o.eG(),b,_),A=S[1]<A[1]?S:A,E=S[1]>E[1]?S:E;const D=o.aA(f[0],0,1),M=100*s.pixelsPerMeter*o.aA(f[1],0,1),B=o.aA(f[2],0,1),z=o.eH(o.eG(),A,E,D),V=Math.tan(.5*s.fovX),Q=-z[2]*V;if(M===0)return z[1]<-Math.abs(Q)?B:1;const W=(-Math.abs(Q)-z[1])/M,J=(_e,xe,fe)=>(1-fe)*_e+fe*xe,ce=o.aA(J(1,B,W),B,1);return J(1,ce,o.aA((s.pitch-20)/20,0,1))}class og{}class e_{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(s,d,f){{const B=this._storage.get(d.id);if(B)return B.lastUsedFrameIdx=s,B.buf}const _=f.gl,b=_.getBufferParameter(_.ELEMENT_ARRAY_BUFFER,_.BUFFER_SIZE),S=new ArrayBuffer(b),A=new Int16Array(S);_.getBufferSubData(_.ELEMENT_ARRAY_BUFFER,0,new Int16Array(S));const E=new o.eJ;for(let B=0;B<b/2;B+=3){const z=A[B],V=A[B+1],Q=A[B+2];E.emplaceBack(z,V),E.emplaceBack(V,Q),E.emplaceBack(Q,z)}const D=f.bindVertexArrayOES.current,M=new og;return M.buf=new tc(f,E),M.lastUsedFrameIdx=s,this._storage.set(d.id,M),f.bindVertexArrayOES.set(D),M.buf}update(s){for(const[d,f]of this._storage)s-f.lastUsedFrameIdx>30&&(f.buf.destroy(),this._storage.delete(d))}destroy(){for(const[s,d]of this._storage)d.buf.destroy(),this._storage.delete(s)}}class t_{constructor(){this.occluderSize=30,this.depthOffset=-1e-4}}const Xb=o.ei([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class i_{constructor(s){this.revealStart=11,this.revealRange=2}}const xh=o.ei([{type:"Float32",name:"a_pos_2f",components:2}]);class pN{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(s,d){const f=s.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){const S=new o.eK,A=new o.b0;S.emplaceBack(-1,-1),S.emplaceBack(1,-1),S.emplaceBack(1,1),S.emplaceBack(-1,1),A.emplaceBack(0,1,2),A.emplaceBack(0,2,3),this.vignetteVx=s.context.createVertexBuffer(S,xh.members),this.vignetteIdx=s.context.createIndexBuffer(A)}const _=o.bg.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){s.uploadCommonUniforms(s.context,f);const S={u_vignetteShape:(b={vignetteShape:[d.start,d.range,Math.pow(10,d.fadePower)],vignetteColor:[d.color.r,d.color.g,d.color.b,d.color.a*d.strength]}).vignetteShape,u_vignetteColor:b.vignetteColor};f.draw(s,s.context.gl.TRIANGLES,si.disabled,ji.disabled,Di.alphaBlended,Ai.disabled,S,"vignette",this.vignetteVx,this.vignetteIdx,_)}var b}}class mN{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(s,d){const f=s.getFreeCameraOptions().position,_=f.toAltitude(),b=f.toLngLat(),S=o.an(b.lng),A=o.an(b.lat),E=s.pixelsPerMeter/d,D=S*o.eM,M=o.eM*Math.log(Math.tan(Math.PI/4+A/2));if(this._offsetXPrev===void 0)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{const B=-this._offsetYPrev+M,z=-this._elevationPrev+_;this._accumulatedOffsetX+=(-this._offsetXPrev+D)*E,this._accumulatedOffsetY+=B*E,this._accumulatedElevation+=z*E,this._offsetXPrev=D,this._offsetYPrev=M,this._elevationPrev=_}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function r_(m,s){return[-(m[0]-Math.floor(m[0]/s)*s),-(m[1]-Math.floor(m[1]/s)*s),-(m[2]-Math.floor(m[2]/s)*s)]}function cm(m){const s=o.eq(1323123451230),d=[];for(let f=0;f<m;++f){const _=2*s()-1,b=2*s()-1,S=2*s()-1;d.push(o.d5(_,b,S))}return d}function rc(m,s,d,f,_){const b=o.aA((_-d)/(f-d),0,1);return(1-b)*m+b*s}class n_{constructor(s){this._movement=new mN,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new pN,this._ppmScaleFactor=s}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(s,d){const f=s.transform;this._movement.update(f,this._ppmScaleFactor);const _=f.starsProjMatrix,b=o.c7([]);o.c9(b,b,o.an(90)-f._pitch),o.c8(b,b,-f.angle);const S=o.cc(new Float32Array(16),b),A=o.eL(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),E=o.eg([],A),D=o.aB([],E,S),M=Date.now()/1e3;return this._accumulatedTimeFromStart+=(M-this._prevTime)*d,this._prevTime=M,{projectionMatrix:_,modelviewMatrix:D}}}class Yb extends n_{constructor(s){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new i_("Precipitation > Rain"),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(s){const d=s.context;if(!this.particlesVx){const f=cm(this.particlesCount),_=new o.eN,b=new o.b0;let S=0;const A=o.eq(1323123451230);for(let E=0;E<f.length;++E){const D=f[E],M=[2*A()-1,A(),A(),A()];_.emplaceBack(D[0],D[1],D[2],-1,-1,...M),_.emplaceBack(D[0],D[1],D[2],1,-1,...M),_.emplaceBack(D[0],D[1],D[2],1,1,...M),_.emplaceBack(D[0],D[1],D[2],-1,1,...M),b.emplaceBack(S+0,S+1,S+2),b.emplaceBack(S+0,S+2,S+3),S+=4}this.particlesVx=d.createVertexBuffer(_,Xb.members),this.particlesIdx=d.createIndexBuffer(b)}}draw(s){if(!this._params.overrideStyleParameters&&!s.style.rain)return;const d=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},f=s.transform.zoom;if(d.revealStart>f)return;const _=rc(0,1,d.revealStart,d.revealStart+d.revealRange,f);if(!this.particlesVx||!this.particlesIdx)return;const b=structuredClone(this._params);let S=[-b.direction.x,b.direction.y,-100];o.aw(S,S);const A=structuredClone(this._vignetteParams);A.strength*=_,b.overrideStyleParameters||(b.intensity=s.style.rain.state.density,b.timeFactor=s.style.rain.state.intensity,b.color=structuredClone(s.style.rain.state.color),S=structuredClone(s.style.rain.state.direction),b.screenThinning.intensity=s.style.rain.state.centerThinning,b.dropletSizeX=s.style.rain.state.dropletSize[0],b.dropletSizeYScale=s.style.rain.state.dropletSize[1]/s.style.rain.state.dropletSize[0],b.distortionStrength=100*s.style.rain.state.distortionStrength,A.strength=1,A.color=structuredClone(s.style.rain.state.vignetteColor));const E=this.updateOnRender(s,b.timeFactor),D=s.context,M=D.gl,B=s.transform;this.screenTexture&&this.screenTexture.size[0]===s.width&&this.screenTexture.size[1]===s.height||(this.screenTexture=new o.T(D,{width:s.width,height:s.height,data:null},M.RGBA8)),b.distortionStrength>0&&(D.activeTexture.set(M.TEXTURE0),this.screenTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE),M.copyTexSubImage2D(M.TEXTURE_2D,0,0,0,0,0,s.width,s.height));const z=s.getOrCreateProgram("rainParticle");s.uploadCommonUniforms(D,z),D.activeTexture.set(M.TEXTURE0),this.screenTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE);const V=[b.color.r,b.color.g,b.color.b,b.color.a],Q=(W,J)=>{const ce=r_(this._movement.getPosition(),W),_e=b.dropletSizeX,xe=b.dropletSizeX*b.dropletSizeYScale,fe=s.width/2,Fe=s.height/2,De=rc(0,b.screenThinning.start,0,1,b.screenThinning.intensity),Oe=rc(.001,b.screenThinning.range,0,1,b.screenThinning.intensity),Ee=rc(0,b.screenThinning.particleOffset,0,1,b.screenThinning.intensity),Se=(qe={modelview:E.modelviewMatrix,projection:E.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:ce,velocityConeAperture:b.velocityConeAperture,velocity:b.velocity,boxSize:W,rainDropletSize:[_e,xe],distortionStrength:b.distortionStrength,rainDirection:S,color:V,screenSize:[B.width,B.height],thinningCenterPos:[fe,Fe],thinningShape:[De,Oe,Math.pow(10,b.screenThinning.fadePower)],thinningAffectedRatio:b.screenThinning.affectedRatio,thinningParticleOffset:Ee,shapeDirectionalPower:b.shapeDirPower,shapeNormalPower:b.shapeNormalPower,mode:J?0:1},{u_modelview:Float32Array.from(qe.modelview),u_projection:Float32Array.from(qe.projection),u_time:qe.time,u_cam_pos:qe.camPos,u_texScreen:0,u_velocityConeAperture:qe.velocityConeAperture,u_velocity:qe.velocity,u_boxSize:qe.boxSize,u_rainDropletSize:qe.rainDropletSize,u_distortionStrength:qe.distortionStrength,u_rainDirection:qe.rainDirection,u_color:qe.color,u_screenSize:qe.screenSize,u_thinningCenterPos:qe.thinningCenterPos,u_thinningShape:qe.thinningShape,u_thinningAffectedRatio:qe.thinningAffectedRatio,u_thinningParticleOffset:qe.thinningParticleOffset,u_shapeDirectionalPower:qe.shapeDirectionalPower,u_shapeNormalPower:qe.shapeNormalPower,u_mode:qe.mode});var qe;const Ye=Math.round(b.intensity*this.particlesCount),Qe=o.bg.simpleSegment(0,0,4*Ye,2*Ye);z.draw(s,M.TRIANGLES,si.disabled,ji.disabled,Di.alphaBlended,Ai.disabled,Se,"rain_particles",this.particlesVx,this.particlesIdx,Qe)};b.distortionStrength>0&&Q(b.boxSize,!0),Q(b.boxSize,!1),this._vignette.draw(s,A)}}const lg=o.ei([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class um extends n_{constructor(s){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new i_("Precipitation > Snow"),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(s){const d=s.context;if(!this.particlesVx){const f=cm(this.particlesCount),_=new o.eO,b=new o.b0;let S=0;const A=o.eq(1323123451230);for(let E=0;E<f.length;++E){const D=f[E],M=A(),B=A(),z=A(),V=[E/f.length,M,B,z],Q=[A(),A()];_.emplaceBack(D[0],D[1],D[2],-1,-1,...V,...Q),_.emplaceBack(D[0],D[1],D[2],1,-1,...V,...Q),_.emplaceBack(D[0],D[1],D[2],1,1,...V,...Q),_.emplaceBack(D[0],D[1],D[2],-1,1,...V,...Q),b.emplaceBack(S+0,S+1,S+2),b.emplaceBack(S+0,S+2,S+3),S+=4}this.particlesVx=d.createVertexBuffer(_,lg.members),this.particlesIdx=d.createIndexBuffer(b)}}draw(s){if(!this._params.overrideStyleParameters&&!s.style.snow)return;const d=structuredClone(this._params);let f=[-d.direction.x,d.direction.y,-100];o.aw(f,f);const _=structuredClone(this._vignetteParams),b=d.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},S=s.transform.zoom;if(b.revealStart>S)return;const A=rc(0,1,b.revealStart,b.revealStart+b.revealRange,S);_.strength*=A,d.overrideStyleParameters||(d.intensity=s.style.snow.state.density,d.timeFactor=s.style.snow.state.intensity,d.color=structuredClone(s.style.snow.state.color),f=structuredClone(s.style.snow.state.direction),d.screenThinning.intensity=s.style.snow.state.centerThinning,d.billboardSize=2.79*s.style.snow.state.flakeSize,_.strength=1,_.color=structuredClone(s.style.snow.state.vignetteColor));const E=this.updateOnRender(s,d.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;const D=s.context,M=D.gl,B=s.transform,z=s.getOrCreateProgram("snowParticle");s.uploadCommonUniforms(D,z),((V,Q,W)=>{const J=r_(this._movement.getPosition(),V),ce=B.width/2,_e=B.height/2,xe=rc(0,W.screenThinning.start,0,1,W.screenThinning.intensity),fe=rc(.001,W.screenThinning.range,0,1,W.screenThinning.intensity),Fe=rc(0,W.screenThinning.particleOffset,0,1,W.screenThinning.intensity),De=(Oe={modelview:E.modelviewMatrix,projection:E.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:J,velocityConeAperture:W.velocityConeAperture,velocity:W.velocity,horizontalOscillationRadius:W.horizontalOscillationRadius,horizontalOscillationRate:W.horizontalOscillationRate,boxSize:V,billboardSize:1*W.billboardSize,simpleShapeParameters:[W.shapeFadeStart,W.shapeFadePower],screenSize:[B.width,B.height],thinningCenterPos:[ce,_e],thinningShape:[xe,fe,Math.pow(10,W.screenThinning.fadePower)],thinningAffectedRatio:W.screenThinning.affectedRatio,thinningParticleOffset:Fe,color:[W.color.r,W.color.g,W.color.b,W.color.a],direction:f},{u_modelview:Float32Array.from(Oe.modelview),u_projection:Float32Array.from(Oe.projection),u_time:Oe.time,u_cam_pos:Oe.camPos,u_velocityConeAperture:Oe.velocityConeAperture,u_velocity:Oe.velocity,u_horizontalOscillationRadius:Oe.horizontalOscillationRadius,u_horizontalOscillationRate:Oe.horizontalOscillationRate,u_boxSize:Oe.boxSize,u_billboardSize:Oe.billboardSize,u_simpleShapeParameters:Oe.simpleShapeParameters,u_screenSize:Oe.screenSize,u_thinningCenterPos:Oe.thinningCenterPos,u_thinningShape:Oe.thinningShape,u_thinningAffectedRatio:Oe.thinningAffectedRatio,u_thinningParticleOffset:Oe.thinningParticleOffset,u_particleColor:Oe.color,u_direction:Oe.direction});var Oe;const Ee=Math.round(W.intensity*this.particlesCount),Se=o.bg.simpleSegment(0,0,4*Ee,2*Ee);this.particlesVx&&this.particlesIdx&&z.draw(s,M.TRIANGLES,si.disabled,ji.disabled,Di.alphaBlended,Ai.disabled,De,"snow_particles",this.particlesVx,this.particlesIdx,Se)})(d.boxSize,0,d),this._vignette.draw(s,_)}}const fd={symbol:function(m,s,d,f,_){if(m.renderPass!=="translucent")return;const b=ji.disabled,S=m.colorModeForRenderPass(),A=d.layout.get("text-variable-anchor"),E=d.layout.get("text-size-scale-range"),D=o.aA(m.scaleFactor,E[0],E[1]);A&&function(z,V,Q,W,J,ce,_e,xe){const fe=V.transform,Fe=J==="map",De=ce==="map";for(const Oe of z){const Ee=W.getTile(Oe),Se=Ee.getBucket(Q);if(!Se||!Se.text||!Se.text.segments.get().length)continue;const qe=o.bK(Se.textSizeData,fe.zoom,xe),Ye=La(Oe,Se.getProjection(),fe),Qe=fe.calculatePixelsToTileUnitsMatrix(Ee),at=Xl(Ye,Ee.tileID.canonical,De,Fe,fe,Se.getProjection(),Qe),nt=Se.hasIconTextFit()&&Se.hasIconData();qe&&kb(Se,Fe,De,_e,fe,at,Oe,Math.pow(2,fe.zoom-Ee.tileID.overscaledZ),qe,nt)}}(f,m,d,s,d.layout.get("text-rotation-alignment"),d.layout.get("text-pitch-alignment"),_,D);const M=d.paint.get("icon-opacity").constantOr(1)!==0,B=d.paint.get("text-opacity").constantOr(1)!==0;d.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(M||B)?ig(m,s,d,f,b,S):(M&&ig(m,s,d,f,b,S,{onlyIcons:!0}),B&&ig(m,s,d,f,b,S,{onlyText:!0})),s.map.showCollisionBoxes&&(Fx(m,s,d,f,d.paint.get("text-translate"),d.paint.get("text-translate-anchor"),!0),Fx(m,s,d,f,d.paint.get("icon-translate"),d.paint.get("icon-translate-anchor"),!1))},circle:function(m,s,d,f){if(m.renderPass!=="translucent")return;const _=d.paint.get("circle-opacity"),b=d.paint.get("circle-stroke-width"),S=d.paint.get("circle-stroke-opacity"),A=d.layout.get("circle-sort-key").constantOr(1)!==void 0,E=d.paint.get("circle-emissive-strength");if(_.constantOr(1)===0&&(b.constantOr(1)===0||S.constantOr(1)===0))return;const D=m.context,M=D.gl,B=m.transform,z=!(!m.terrain||!m.terrain.enabled),V=d.layout.get("circle-elevation-reference"),Q=m.depthModeForSublayer(0,si.ReadOnly),W=new si(m.context.gl.LEQUAL,si.ReadOnly,m.depthRangeFor3D),J=V==="none"||z?Q:W,ce=ji.disabled,_e=m.colorModeForDrapableLayerRenderPass(E),xe=B.projection.name==="globe",fe=[o.aF(B.center.lng),o.aJ(B.center.lat)],Fe=[];for(let Oe=0;Oe<f.length;Oe++){const Ee=f[Oe],Se=s.getTile(Ee),qe=Se.getBucket(d);if(!qe||qe.projection.name!==B.projection.name)continue;const Ye=qe.programConfigurations.get(d.id),Qe=qe.layoutVertexBuffer,at=qe.globeExtVertexBuffer,nt=qe.indexBuffer,ft=o.e0(d),Nt=[at],rt=m.isTileAffectedByFog(Ee);xe&&ft.push("PROJECTION_GLOBE_VIEW"),ft.push("DEPTH_D24"),m.terrain&&B.depthOcclusionForSymbolsAndCircles&&ft.push("DEPTH_OCCLUSION"),qe.hasElevation&&!m.terrain&&(ft.push("ELEVATED_ROADS"),Nt.push(qe.elevatedLayoutVertexBuffer));const $e=m.getOrCreateProgram("circle",{config:Ye,defines:ft,overrideFog:rt}),dt=B.projection.createInversionMatrix(B,Ee.canonical),ot={programConfiguration:Ye,program:$e,layoutVertexBuffer:Qe,dynamicBuffers:Nt,indexBuffer:nt,uniformValues:o.e1(m,Ee,Se,dt,fe,d),tile:Se};if(A){const Ct=qe.segments.get();for(const Rt of Ct)Fe.push({segments:new o.bg([Rt]),sortKey:Rt.sortKey,state:ot})}else Fe.push({segments:qe.segments,sortKey:0,state:ot})}A&&Fe.sort((Oe,Ee)=>Oe.sortKey-Ee.sortKey);const De={useDepthForOcclusion:B.depthOcclusionForSymbolsAndCircles};for(const Oe of Fe){const{programConfiguration:Ee,program:Se,layoutVertexBuffer:qe,dynamicBuffers:Ye,indexBuffer:Qe,uniformValues:at,tile:nt}=Oe.state,ft=Oe.segments;m.terrain&&m.terrain.setupElevationDraw(nt,Se,De),m.uploadCommonUniforms(D,Se,nt.tileID.toUnwrapped()),Se.draw(m,M.TRIANGLES,J,ce,_e,Ai.disabled,at,d.id,qe,Qe,ft,d.paint,B.zoom,Ee,Ye)}},heatmap:function(m,s,d,f){if(d.paint.get("heatmap-opacity")!==0)if(m.renderPass==="offscreen"){const _=m.context,b=_.gl,S=ji.disabled,A=new Di([b.ONE,b.ONE,b.ONE,b.ONE],o.ao.transparent,[!0,!0,!0,!0]);(function(V,Q,W,J){const ce=V.gl,_e=Q.width*J,xe=Q.height*J;V.activeTexture.set(ce.TEXTURE1),V.viewport.set([0,0,_e,xe]);let fe=W.heatmapFbo;if(!fe||fe&&(fe.width!==_e||fe.height!==xe)){fe&&fe.destroy();const Fe=ce.createTexture();ce.bindTexture(ce.TEXTURE_2D,Fe),ce.texParameteri(ce.TEXTURE_2D,ce.TEXTURE_WRAP_S,ce.CLAMP_TO_EDGE),ce.texParameteri(ce.TEXTURE_2D,ce.TEXTURE_WRAP_T,ce.CLAMP_TO_EDGE),ce.texParameteri(ce.TEXTURE_2D,ce.TEXTURE_MIN_FILTER,ce.LINEAR),ce.texParameteri(ce.TEXTURE_2D,ce.TEXTURE_MAG_FILTER,ce.LINEAR),fe=W.heatmapFbo=V.createFramebuffer(_e,xe,1,null),function(De,Oe,Ee,Se,qe,Ye){const Qe=De.gl;Qe.texImage2D(Qe.TEXTURE_2D,0,De.extRenderToTextureHalfFloat?Qe.RGBA16F:Qe.RGBA,qe,Ye,0,Qe.RGBA,De.extRenderToTextureHalfFloat?Qe.HALF_FLOAT:Qe.UNSIGNED_BYTE,null),Se.colorAttachment0.set(Ee)}(V,0,Fe,fe,_e,xe)}else ce.bindTexture(ce.TEXTURE_2D,fe.colorAttachment0.get()),V.bindFramebuffer.set(fe.framebuffer)})(_,m,d,m.transform.projection.name==="globe"?.5:.25),_.clear({color:o.ao.transparent});const E=m.transform,D=E.projection.name==="globe",M=D?["PROJECTION_GLOBE_VIEW"]:[],B=D?Ai.frontCCW:Ai.disabled,z=[o.aF(E.center.lng),o.aJ(E.center.lat)];for(let V=0;V<f.length;V++){const Q=f[V];if(s.hasRenderableParent(Q))continue;const W=s.getTile(Q),J=W.getBucket(d);if(!J||J.projection.name!==E.projection.name)continue;const ce=m.isTileAffectedByFog(Q),_e=J.programConfigurations.get(d.id),xe=m.getOrCreateProgram("heatmap",{config:_e,defines:M,overrideFog:ce}),{zoom:fe}=m.transform;m.terrain&&m.terrain.setupElevationDraw(W,xe),m.uploadCommonUniforms(_,xe,Q.toUnwrapped());const Fe=E.projection.createInversionMatrix(E,Q.canonical);xe.draw(m,b.TRIANGLES,si.disabled,S,A,B,Ox(m,Q,W,Fe,z,fe,d.paint.get("heatmap-intensity")),d.id,J.layoutVertexBuffer,J.indexBuffer,J.segments,d.paint,m.transform.zoom,_e,D?[J.globeExtVertexBuffer]:null)}_.viewport.set([0,0,m.width,m.height])}else m.renderPass==="translucent"&&(m.context.setColorMode(m.colorModeForRenderPass()),function(_,b){const S=_.context,A=S.gl,E=b.heatmapFbo;if(!E)return;S.activeTexture.set(A.TEXTURE0),A.bindTexture(A.TEXTURE_2D,E.colorAttachment0.get()),S.activeTexture.set(A.TEXTURE1);let D=b.colorRampTexture;D||(D=b.colorRampTexture=new o.T(S,b.colorRamp,A.RGBA8)),D.bind(A.LINEAR,A.CLAMP_TO_EDGE),_.getOrCreateProgram("heatmapTexture").draw(_,A.TRIANGLES,si.disabled,ji.disabled,_.colorModeForRenderPass(),Ai.disabled,((M,B)=>({u_image:0,u_color_ramp:1,u_opacity:B.paint.get("heatmap-opacity")}))(0,b),b.id,_.viewportBuffer,_.quadTriangleIndexBuffer,_.viewportSegments,b.paint,_.transform.zoom)}(m,d))},line:function(m,s,d,f){if(m.renderPass!=="translucent")return;const _=d.paint.get("line-opacity"),b=d.paint.get("line-width");if(_.constantOr(1)===0||b.constantOr(1)===0)return;const S=d.paint.get("line-emissive-strength").isConstant(),A=d.paint.get("line-emissive-strength").constantOr(0),E=d.paint.get("line-occlusion-opacity"),D=d.layout.get("line-elevation-reference"),M=d.layout.get("line-width-unit")==="meters",B=D==="sea",z=!(!m.terrain||!m.terrain.enabled),V=m.context,Q=V.gl;if(d.hasElevatedBuckets&&m.transform.projection.name==="globe")return;const W=d.layout.get("line-cross-slope"),J=W!==void 0,ce=W<1,_e=m.colorModeForDrapableLayerRenderPass(S?A:null),xe=m.terrain&&m.terrain.renderingToTexture,fe=xe?1:o.o.devicePixelRatio,Fe=d.paint.get("line-dasharray"),De=Fe.constantOr(1),Oe=d.layout.get("line-cap"),Ee=Fe.constantOr(null),Se=Oe.constantOr(null),qe=d.paint.get("line-pattern"),Ye=qe.constantOr(1),Qe=d.paint.get("line-pattern-cross-fade"),at=qe.constantOr(null),nt=d.paint.get("line-opacity").constantOr(1);let ft=!Ye&&nt!==1||m.depthOcclusion&&E>0&&E<1;const Nt=d.paint.get("line-gradient"),rt=Ye?"linePattern":"line",$e=o.e2(d);let dt;if(xe&&m.terrain&&m.terrain.clipOrMaskOverlapStencilType()&&(ft=!1),E!==0&&m.depthOcclusion){const Ut=d.paint._values["line-opacity"];Ut&&Ut.value&&Ut.value.kind==="constant"?dt=Ut.value:o.w(`Occlusion opacity for layer ${d.id} is supported only when line-opacity isn't data-driven.`)}b.value.kind!=="constant"&&b.value.isLineProgressConstant===!1&&$e.push("VARIABLE_LINE_WIDTH"),xe&&(m.emissiveMode!=="dual-source-blending"||S?m.emissiveMode==="mrt-fallback"&&$e.push("USE_MRT1"):$e.push("DUAL_SOURCE_BLENDING"));const ot=(Ut,kt,Mt,ei,Qt,Wt)=>{for(const Kt of Ut){const gi=s.getTile(Kt);if(Ye&&!gi.patternsLoaded())continue;const Ci=gi.getBucket(d);if(!Ci||Ci.elevationType!=="none"&&!Qt||Ci.elevationType==="none"&&Qt)continue;m.prepareDrawTile();const Hi=[...kt],lr=m.shadowRenderer,ki=Ci.elevationType==="road"&&!!lr&&lr.enabled;let yr=[0,0,0];if(ki){const Gi=m.style.directionalLight,Zr=m.style.ambientLight;Gi&&Zr&&(yr=hl(m.style,Gi,Zr)),Hi.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET")}const Li=Ci.programConfigurations.get(d.id);let Dr=!1;if(at&&gi.imageAtlas){const Gi=o.e3.from(at),Zr=Gi.getPrimary().scaleSelf(fe).toString(),Dn=gi.imageAtlas.patternPositions.get(Zr),Kr=Gi.getSecondary(),tn=Kr?gi.imageAtlas.patternPositions.get(Kr.scaleSelf(fe).toString()):null;Dr=!!Dn&&!!tn,Dn&&Li.setConstantPatternPositions(Dn,tn)}Qe>0&&(Dr||Li.getPatternTransitionVertexBuffer("line-pattern"))&&Hi.push("LINE_PATTERN_TRANSITION");const Rr=m.isTileAffectedByFog(Kt),Fr=m.getOrCreateProgram(rt,{config:Li,defines:Hi,overrideFog:Rr});if(!Ye&&Ee&&Se&&gi.lineAtlas){const Gi=gi.lineAtlas.getDash(Ee,Se);Gi&&Li.setConstantPatternPositions(Gi)}ki&&lr.setupShadows(gi.tileID.toUnwrapped(),Fr,"vector-tile");let[ur,Ui]=d.paint.get("line-trim-offset");(Se==="round"||Se==="square")&&ur!==Ui&&(ur===0&&(ur-=1),Ui===1&&(Ui+=1));const Ir=xe?Kt.projMatrix:null,hn=M?1/Ci.tileToMeter/o.ay(gi,1,m.transform.zoom):1,pn=M?1/Ci.tileToMeter/o.ay(gi,1,Math.floor(m.transform.zoom)):1,Pr=Ye?o.e4(m,gi,d,Ir,fe,hn,pn,[ur,Ui],yr,Qe):o.e5(m,gi,d,Ir,Ci.lineClipsArray.length,fe,hn,pn,[ur,Ui],yr);if(Nt){const Gi=Ci.gradients[d.id];let Zr=Gi.texture;if(d.gradientVersion!==Gi.version){let Dn=256;if(d.stepInterpolant){const Kr=s.getSource().maxzoom,tn=Kt.canonical.z===Kr?Math.ceil(1<<m.transform.maxZoom-Kt.canonical.z):1;Dn=o.aA(o.e6(Ci.maxLineLength/o.al*1024*tn),256,V.maxTextureSize)}Gi.gradient=o.e7({expression:d.gradientExpression(),evaluationKey:"lineProgress",resolution:Dn,image:Gi.gradient||void 0,clips:Ci.lineClipsArray}),Gi.texture?Gi.texture.update(Gi.gradient):Gi.texture=new o.T(V,Gi.gradient,Q.RGBA8),Gi.version=d.gradientVersion,Zr=Gi.texture}V.activeTexture.set(Q.TEXTURE1),Zr.bind(d.stepInterpolant?Q.NEAREST:Q.LINEAR,Q.CLAMP_TO_EDGE)}De&&(V.activeTexture.set(Q.TEXTURE0),gi.lineAtlasTexture&&gi.lineAtlasTexture.bind(Q.LINEAR,Q.REPEAT),Li.updatePaintBuffers()),Ye&&(V.activeTexture.set(Q.TEXTURE0),gi.imageAtlasTexture&&gi.imageAtlasTexture.bind(Q.LINEAR,Q.CLAMP_TO_EDGE),Li.updatePaintBuffers()),Qt&&!B&&m.terrain.setupElevationDraw(gi,Fr),m.uploadCommonUniforms(V,Fr,Kt.toUnwrapped());const rr=Gi=>{dt!=null&&(dt.value=nt*E),Fr.draw(m,Q.TRIANGLES,Mt,Gi,_e,Ai.disabled,Pr,d.id,Ci.layoutVertexBuffer,Ci.indexBuffer,Ci.segments,d.paint,m.transform.zoom,Li,[Ci.layoutVertexBuffer2,Ci.patternVertexBuffer,Ci.zOffsetVertexBuffer]),dt!=null&&(dt.value=nt)};if(ft&&!Qt){const Gi=m.stencilModeForClipping(Kt).ref;Gi===0&&xe&&V.clear({stencil:0});const Zr={func:Q.EQUAL,mask:255};Pr.u_alpha_discard_threshold=.8,rr(new ji(Zr,Gi,255,Q.KEEP,Q.KEEP,Q.INVERT)),Pr.u_alpha_discard_threshold=0,rr(new ji(Zr,Gi,255,Q.KEEP,Q.KEEP,Q.KEEP))}else Pr.u_alpha_discard_threshold=ft&&Qt&&Wt?.8:0,rr(Qt?ei:m.stencilModeForClipping(Kt))}};let Ct=m.depthModeForSublayer(0,si.ReadOnly);const Rt=new si(m.depthOcclusion?Q.GREATER:Q.LEQUAL,si.ReadOnly,m.depthRangeFor3D);if(d.hasNonElevatedBuckets){const Ut=!xe&&m.terrain;E!==0&&Ut?o.w(`Occlusion opacity for layer ${d.id} is supported on terrain only if the layer has line-z-offset enabled.`):Ut?o.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${d.id}.`):ot(f,$e,Ct,ji.disabled,!1,!0)}if(d.hasElevatedBuckets){D==="hd-road-markup"?z||(Ct=Rt,$e.push("ELEVATED_ROADS")):($e.push("ELEVATED"),Ct=Rt,J&&$e.push(ce?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),B&&$e.push("ELEVATION_REFERENCE_SEA"));const Ut=ft?m.stencilModeFor3D():ji.disabled;m.forceTerrainMode=!0,ot(f,$e,Ct,Ut,!0,!0),ft&&ot(f,$e,Ct,Ut,!0,!1),m.forceTerrainMode=!1}ft&&(m.resetStencilClippingMasks(),xe&&V.clear({stencil:0})),E===0||m.depthOcclusion||xe||m.layersWithOcclusionOpacity.push(m.currentLayer)},fill:function(m,s,d,f){const _=d.paint.get("fill-color"),b=d.paint.get("fill-opacity");if(b.constantOr(1)===0)return;const S=d.paint.get("fill-emissive-strength"),A=m.colorModeForDrapableLayerRenderPass(S),E=d.paint.get("fill-pattern"),D=m.opaquePassEnabledForLayer()&&!E.constantOr(1)&&_.constantOr(o.ao.transparent).a===1&&b.constantOr(0)===1?"opaque":"translucent";let M="none";d.layout.get("fill-elevation-reference")!=="none"?M="road":d.paint.get("fill-z-offset").constantOr(1)!==0&&(M="offset");const B=!(!m.terrain||!m.terrain.enabled),z={painter:m,sourceCache:s,layer:d,coords:f,colorMode:A,elevationType:M,terrainEnabled:B,pass:D};if(m.renderPass==="shadow")return void(m.shadowRenderer&&M==="road"&&!B&&function(Q){const{painter:W,sourceCache:J,layer:ce,coords:_e}=Q,xe=W.context.gl,fe=Q.painter.shadowRenderer;for(const Fe of _e){const De=J.getTile(Fe),Oe=De.getBucket(ce);if(!Oe)continue;const Ee=Oe.elevatedStructures;if(!Ee||!Ee.shadowCasterSegments||Ee.shadowCasterSegments.segments[0].primitiveLength===0)continue;W.prepareDrawTile();const Se=Oe.bufferData.programConfigurations.get(ce.id),qe=W.isTileAffectedByFog(Fe),Ye=W.getOrCreateProgram("elevatedStructuresDepth",{config:Se,overrideFog:qe}),Qe=fe.calculateShadowPassMatrixFromTile(De.tileID.toUnwrapped());W.uploadCommonUniforms(W.context,Ye,Fe.toUnwrapped());const at=kx(Qe,0);Ye.draw(W,xe.TRIANGLES,fe.getShadowPassDepthMode(),ji.disabled,fe.getShadowPassColorMode(),Ai.disabled,at,ce.id,Ee.vertexBuffer,Ee.indexBuffer,Ee.shadowCasterSegments,ce.paint,W.transform.zoom,Se)}}(z));const V=m.emissiveMode==="mrt-fallback";if(M!=="offset"){if(ph(z,!1,V),M==="road"){const Q=!B&&m.renderPass==="translucent";Q&&Bx(m,s,d,f,"geometry"),ph(z,!0,V,ji.disabled),Q&&function(W){const{painter:J,sourceCache:ce,layer:_e,coords:xe,colorMode:fe}=W,Fe=J.context.gl,De=W.painter.shadowRenderer,Oe=!!De&&De.enabled,Ee=new si(J.context.gl.LEQUAL,si.ReadOnly,J.depthRangeFor3D);let Se=[0,0,0];if(Oe){const Ye=J.style.directionalLight,Qe=J.style.ambientLight;Ye&&Qe&&(Se=hl(J.style,Ye,Qe))}const qe=Ye=>{for(const Qe of xe){const at=ce.getTile(Qe),nt=at.getBucket(_e);if(!nt)continue;const ft=nt.elevatedStructures;if(!ft)continue;let Nt,rt;if(Ye?(Nt=ft.renderableBridgeSegments,rt=ft.bridgeProgramConfigurations.get(_e.id)):(Nt=ft.renderableTunnelSegments,rt=ft.tunnelProgramConfigurations.get(_e.id)),!Nt||Nt.segments[0].primitiveLength===0)continue;rt.updatePaintBuffers(),J.prepareDrawTile();const $e=J.isTileAffectedByFog(Qe),dt=[];Oe&&dt.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET");const ot=J.getOrCreateProgram("elevatedStructures",{config:rt,overrideFog:$e,defines:dt}),Ct=J.translatePosMatrix(Qe.projMatrix,at,_e.paint.get("fill-translate"),_e.paint.get("fill-translate-anchor"));Oe&&De.setupShadows(at.tileID.toUnwrapped(),ot,"vector-tile");const Rt=fu(Ct,Se);J.uploadCommonUniforms(J.context,ot,Qe.toUnwrapped()),ot.draw(J,Fe.TRIANGLES,Ee,ji.disabled,fe,Ai.backCCW,Rt,_e.id,ft.vertexBuffer,ft.indexBuffer,Nt,_e.paint,J.transform.zoom,rt,[ft.vertexBufferNormal])}};qe(!0),qe(!1)}(z)}}else ph(z,!1,V,m.stencilModeFor3D())},"fill-extrusion":function(m,s,d,f){const _=d.paint.get("fill-extrusion-opacity"),b=m.context,S=b.gl,A=m.terrain,E=A&&A.renderingToTexture;if(_===0)return;const D=m.emissiveMode==="mrt-fallback",M=m.conflationActive&&m.style.isLayerClipped(d,s.getSource()),B=m.style.order.indexOf(d.fqid);if(M&&function(z,V,Q,W,J){for(const ce of W){const _e=V.getTile(ce).getBucket(Q);_e&&(_e.updateReplacement(ce,z.replacementSource,J),_e.uploadCentroid(z.context))}}(m,s,d,f,B),A||M)for(const z of f){const V=s.getTile(z).getBucket(d);V&&Db(m.context,s,z,V,d,A,M)}if(m.renderPass==="shadow"&&m.shadowRenderer){const z=m.shadowRenderer;if(A&&_<.65&&d._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof o.ad)return;const V=z.getShadowPassDepthMode(),Q=z.getShadowPassColorMode();mh(m,s,d,f,V,ji.disabled,Q,M)}else if(m.renderPass==="translucent"){const z=!d.paint.get("fill-extrusion-pattern").constantOr(1),V=d.paint.get("fill-extrusion-color").constantOr(o.ao.white);if(!E&&V.a!==0){const Q=new si(m.context.gl.LEQUAL,si.ReadWrite,m.depthRangeFor3D);_===1&&z?mh(m,s,d,f,Q,ji.disabled,Di.unblended,M):(mh(m,s,d,f,Q,ji.disabled,Di.disabled,M),mh(m,s,d,f,Q,m.stencilModeFor3D(),m.colorModeForRenderPass(),M),m.resetStencilClippingMasks())}if(m.style.enable3dLights()&&z&&(!A&&m.transform.projection.name!=="globe"||E)){const Q=d.paint.get("fill-extrusion-opacity"),W=d.paint.get("fill-extrusion-ambient-occlusion-intensity"),J=d.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),ce=d.paint.get("fill-extrusion-flood-light-intensity"),_e=d.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",xe=d.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(_e?null:d.lut).toArray01().slice(0,3),fe=W>0&&J>0,Fe=ce>0,De=(Se,qe,Ye)=>(1-Ye)*Se+Ye*qe,Oe=new am;Oe.translate=d.paint.get("fill-extrusion-translate"),Oe.translateAnchor=d.paint.get("fill-extrusion-translate-anchor"),Oe.edgeRadius=d.layout.get("fill-extrusion-edge-radius"),Oe.cutoffFadeRange=d.paint.get("fill-extrusion-cutoff-fade-range");const Ee=Se=>{const qe=m.depthModeForSublayer(1,si.ReadOnly,S.LEQUAL,!0),Ye=d.paint.get(Se?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Qe=De(.1,3,Ye),at=m._showOverdrawInspector;if(!at){const nt=new ji({func:S.ALWAYS,mask:255},255,255,S.KEEP,S.KEEP,S.REPLACE),ft=new Di([S.ONE,S.ONE,S.ONE,S.ONE],o.ao.transparent,[!1,!1,!1,!0],S.MIN);ic(Oe,m,s,d,f,qe,nt,ft,Ai.disabled,Se,"sdf",Q,W,J,ce,xe,Qe,M,!1)}{const nt=at?ji.disabled:new ji({func:S.EQUAL,mask:255},255,255,S.KEEP,S.DECR,S.DECR),ft=at?m.colorModeForRenderPass():new Di([S.ONE_MINUS_DST_ALPHA,S.DST_ALPHA,S.ONE,S.ONE],o.ao.transparent,[!0,!0,!0,!0]);ic(Oe,m,s,d,f,qe,nt,ft,Ai.disabled,Se,"color",Q,W,J,ce,xe,Qe,M,!1)}};if(E){const Se=()=>{const Ye=A.drapeBufferSize[0],Qe=A.drapeBufferSize[1];let at=A.framebufferCopyTexture;return at&&(!at||at.size[0]===Ye&&at.size[1]===Qe)||(at&&at.destroy(),at=A.framebufferCopyTexture=new o.T(b,new o.q({width:Ye,height:Qe}),S.RGBA8)),at.bind(S.LINEAR,S.CLAMP_TO_EDGE),S.copyTexSubImage2D(S.TEXTURE_2D,0,0,0,0,0,Ye,Qe),at},qe=(Ye,Qe,at)=>{const nt=m.depthModeForSublayer(1,si.ReadOnly,S.LEQUAL,!1),ft=d.paint.get(Ye?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Nt=De(.1,3,ft);{const rt=new Di([S.ONE,S.ONE,S.ONE,S.ONE],o.ao.transparent,[!1,!1,!1,!0]);ic(Oe,m,s,d,f,nt,ji.disabled,rt,Ai.disabled,Ye,"clear",Q,W,J,ce,xe,Nt,M,Qe)}{const rt=new ji({func:S.ALWAYS,mask:255},255,255,S.KEEP,S.KEEP,S.REPLACE),$e=new Di([S.ONE,S.ONE,S.ONE,S.ONE],o.ao.transparent,[!1,!1,!1,!0],S.MIN);ic(Oe,m,s,d,f,nt,rt,$e,Ai.disabled,Ye,"sdf",Q,W,J,ce,xe,Nt,M,Qe)}D&&!Ye&&(at=Se());{const rt=Ye?S.ZERO:S.ONE_MINUS_DST_ALPHA,$e=new ji({func:S.EQUAL,mask:255},255,255,S.KEEP,S.DECR,S.DECR),dt=new Di([rt,S.DST_ALPHA,S.ONE_MINUS_DST_ALPHA,S.ZERO],o.ao.transparent,[!0,!0,!0,!0]);ic(Oe,m,s,d,f,nt,$e,dt,Ai.disabled,Ye,"color",Q,W,J,ce,xe,Nt,M,Qe)}if(!D||Ye){const rt=new Di([S.ONE,S.ONE,S.ONE,Ye?S.ZERO:S.ONE],o.ao.transparent,[!1,!1,!1,!0],Ye?S.FUNC_ADD:S.MAX);ic(Oe,m,s,d,f,nt,ji.disabled,rt,Ai.disabled,Ye,"clear",Q,W,J,ce,xe,Nt,M,Qe,at)}else{S.drawBuffers([S.NONE,S.COLOR_ATTACHMENT1]);const rt=new ji({func:S.EQUAL,mask:255},254,255,S.KEEP,S.DECR,S.DECR),$e=new Di([S.ONE,S.ONE,S.ONE,S.ONE],o.ao.transparent,[!0,!1,!1,!1],S.MAX);ic(Oe,m,s,d,f,nt,rt,$e,Ai.disabled,Ye,"emissive",Q,W,J,ce,xe,Nt,M,Qe,at),S.drawBuffers([S.COLOR_ATTACHMENT0])}};if(fe||Fe){let Ye;m.prepareDrawTile(),D&&!fe||(Ye=Se()),fe&&qe(!0,!1,Ye),Fe&&qe(!1,!0,Ye)}}else fe&&Ee(!0),Fe&&Ee(!1),(fe||Fe)&&m.resetStencilClippingMasks()}}},building:function(m,s,d,f){m.currentLayer<m.firstLightBeamLayer&&(m.firstLightBeamLayer=m.currentLayer);const _=d.paint.get("building-ambient-occlusion-ground-intensity"),b=d.paint.get("building-ambient-occlusion-ground-radius"),S=d.paint.get("building-ambient-occlusion-ground-attenuation"),A=d.paint.get("building-opacity");if(A<=0)return;let E=_>0&&b>0,D=!0;const M=d.paint.get("building-vertical-scale");if(M<=0)return;m.shadowRenderer||(D=!1);const B=m.conflationActive&&m.style.isLayerClipped(d,s.getSource()),z=m.style.order.indexOf(d.fqid);if(function(V,Q,W,J,ce,_e){for(const xe of _e){const fe=Q.getTile(xe).getBucket(W);fe&&(ce&&fe.updateReplacement(xe,V.replacementSource,J),fe.uploadUpdatedIndexBuffer(V.context))}}(m,s,d,z,B,f),function(V,Q,W,J){for(const ce of J){const _e=Q.getTile(ce).getBucket(W);_e&&_e.needsEvaluation()&&_e.uploadUpdatedColorBuffer(V.context)}}(m,s,d,f),d.resetLayerRenderingStats(m),m.shadowRenderer&&(m.shadowRenderer.useNormalOffset=!0),m.renderPass==="shadow"&&m.shadowRenderer){const V=m.shadowRenderer,Q=[],W=V.getShadowPassDepthMode();fh({painter:m,source:s,layer:d,coords:f,defines:Q,blendMode:V.getShadowPassColorMode(),depthMode:W,opacity:A,verticalScale:M,facadeEmissiveChance:0,facadeAOIntensity:0,floodLightIntensity:0,floodLightColor:[0,0,0]})}else if(m.renderPass==="translucent"){let V=["HAS_ATTRIBUTE_a_part_color_emissive","LIGHTING_3D_MODE"];D&&(V=V.concat("RENDER_SHADOWS","DEPTH_TEXTURE")),m.shadowRenderer&&m.shadowRenderer.useNormalOffset&&(V=V.concat("NORMAL_OFFSET"));const Q=d.paint.get("building-facade-emissive-chance"),W=d.paint.get("building-ambient-occlusion-intensity"),J=d.paint.get("building-flood-light-intensity"),ce=d.paint.get("building-flood-light-color-use-theme").constantOr("default")==="none",_e=d.paint.get("building-flood-light-color").toNonPremultipliedRenderColor(ce?null:d.lut).toArray01().slice(0,3),xe=d.paint.get("building-flood-light-ground-attenuation"),fe=J>0,Fe=new si(m.context.gl.LEQUAL,si.ReadWrite,m.depthRangeFor3D);A<1&&fh({painter:m,source:s,layer:d,coords:f,defines:V,blendMode:Di.disabled,depthMode:Fe,opacity:A,verticalScale:M,facadeEmissiveChance:Q,facadeAOIntensity:W,floodLightIntensity:J,floodLightColor:_e,depthOnly:!0});const De=m.colorModeForRenderPass();fh({painter:m,source:s,layer:d,coords:f,defines:V,blendMode:De,depthMode:Fe,opacity:A,verticalScale:M,facadeEmissiveChance:Q,facadeAOIntensity:W,floodLightIntensity:J,floodLightColor:_e}),E&&ng(m,s,d,f,!0,A,_,b,J,_e,S,B),fe&&ng(m,s,d,f,!1,A,_,b,J,_e,xe,B)}else if(m.renderPass==="light-beam"){const V=["HAS_ATTRIBUTE_a_part_color_emissive","HAS_ATTRIBUTE_a_bloom_attenuation"],Q=new si(m.context.gl.LEQUAL,si.ReadOnly,m.depthRangeFor3D);fh({painter:m,source:s,layer:d,coords:f,defines:V,blendMode:Di.alphaBlended,depthMode:Q,opacity:A,verticalScale:M,facadeEmissiveChance:0,facadeAOIntensity:0,floodLightIntensity:0,floodLightColor:[0,0,0]})}m.shadowRenderer&&(m.shadowRenderer.useNormalOffset=!1),m.resetStencilClippingMasks()},hillshade:function(m,s,d,f){if(m.renderPass!=="offscreen"&&m.renderPass!=="translucent"||m.style.disableElevatedTerrain)return;const _=m.context,b=m.terrain&&m.terrain.renderingToTexture,[S,A]=m.renderPass!=="translucent"||b?[{},f]:m.stencilConfigForOverlap(f);for(const E of A){const D=s.getTile(E);if(D.needsHillshadePrepare&&m.renderPass==="offscreen")JT(m,D,d);else if(m.renderPass==="translucent"){const M=m.depthModeForSublayer(0,si.ReadOnly),B=d.paint.get("hillshade-emissive-strength"),z=m.colorModeForDrapableLayerRenderPass(B),V=b&&m.terrain?m.terrain.stencilModeForRTTOverlap(E):S[E.overscaledZ];QT(m,E,D,d,M,V,z)}}_.viewport.set([0,0,m.width,m.height]),m.resetStencilClippingMasks()},raster:function(m,s,d,f,_,b){if(m.renderPass!=="translucent"||d.paint.get("raster-opacity")===0)return;const S=m.transform.projection.name==="globe",A=d.paint.get("raster-elevation")!==0,E=A&&S;if(m.renderElevatedRasterBackface&&!E)return;const D=m.context,M=D.gl,B=s.getSource(),z=function(De,Oe,Ee,Se,qe){const Ye=Oe.paint.get("raster-color"),Qe=De.type==="raster-array",at=[],nt=Oe.paint.get("raster-resampling"),ft=Oe.paint.get("raster-color-mix");let Nt=Oe.paint.get("raster-color-range");const rt=[ft[0],ft[1],ft[2],0],$e=ft[3];let dt=nt==="nearest"?Se.NEAREST:Se.LINEAR;if(Qe&&(at.push("RASTER_ARRAY"),Ye||at.push("RASTER_COLOR"),nt==="linear"&&at.push("RASTER_ARRAY_LINEAR"),dt=Se.NEAREST,!Nt&&De.rasterLayers)){const ot=De.rasterLayers.find(({id:Ct})=>Ct===Oe.sourceLayer);ot&&ot.fields&&ot.fields.range&&(Nt=ot.fields.range)}if(Nt=Nt||[0,1],Ye){at.push("RASTER_COLOR"),Ee.activeTexture.set(Se.TEXTURE2),Oe.updateColorRamp(Nt);let ot=Oe.colorRampTexture;ot||(ot=Oe.colorRampTexture=new o.T(Ee,Oe.colorRamp,Se.RGBA8)),ot.bind(dt,Se.CLAMP_TO_EDGE)}return qe&&at.push("USE_MRT1"),{mix:rt,range:Nt,offset:$e,defines:at,resampling:dt}}(B,d,D,M,m.terrain&&m.terrain.renderingToTexture&&m.emissiveMode==="mrt-fallback");if(B instanceof o.aU&&!f.length&&!S)return;const V=d.paint.get("raster-emissive-strength"),Q=m.colorModeForDrapableLayerRenderPass(V),W=m.terrain&&m.terrain.renderingToTexture,J=!m.options.moving,ce=d.paint.get("raster-resampling")==="nearest"?M.NEAREST:M.LINEAR;if(B instanceof o.aU&&!f.length&&(B.onNorthPole||B.onSouthPole)){const De=A?m.stencilModeFor3D():ji.disabled;return void sg(!!B.onNorthPole,null,m,s,d,V,z,Ai.disabled,De)}if(!f.length)return;const[_e,xe]=B instanceof o.aU||W?[{},f]:m.stencilConfigForOverlap(f),fe=xe[xe.length-1].overscaledZ;E&&z.defines.push("PROJECTION_GLOBE_VIEW"),A&&z.defines.push("RENDER_CUTOFF");const Fe=(De,Oe,Ee)=>{for(const Se of De){const qe=Se.toUnwrapped(),Ye=s.getTile(Se);if(W&&(!Ye||!Ye.hasData()))continue;D.activeTexture.set(M.TEXTURE0);const Qe=zb(Ye,B,d,z);if(!Qe||!Qe.texture)continue;const{texture:at,mix:nt,offset:ft,tileSize:Nt,buffer:rt}=Qe;let $e,dt;W?($e=si.disabled,dt=Se.projMatrix):A?($e=new si(M.LEQUAL,si.ReadWrite,m.depthRangeFor3D),dt=S?Float32Array.from(m.transform.expandedFarZProjMatrix):m.transform.calculateProjMatrix(qe,J)):($e=m.depthModeForSublayer(Se.overscaledZ-fe,d.paint.get("raster-opacity")===1?si.ReadWrite:si.ReadOnly,M.LESS),dt=m.transform.calculateProjMatrix(qe,J));const ot=m.terrain&&W?m.terrain.stencilModeForRTTOverlap(Se):_e[Se.overscaledZ],Ct=b?0:d.paint.get("raster-fade-duration");Ye.registerFadeDuration(Ct);const Rt=s.findLoadedParent(Se,0),Ut=tm(Ye,Rt,s,m.transform,Ct);let kt,Mt;!Ut.isFading&&Ye.refreshedUponExpiration&&(Ye.refreshedUponExpiration=!1),m.terrain&&m.terrain.prepareDrawTile(),D.activeTexture.set(M.TEXTURE0),at.bind(ce,M.CLAMP_TO_EDGE),D.activeTexture.set(M.TEXTURE1),Rt?(Rt.texture&&Rt.texture.bind(ce,M.CLAMP_TO_EDGE),kt=Math.pow(2,Rt.tileID.overscaledZ-Ye.tileID.overscaledZ),Mt=[Ye.tileID.canonical.x*kt%1,Ye.tileID.canonical.y*kt%1]):at.bind(ce,M.CLAMP_TO_EDGE),"useMipmap"in at&&D.extTextureFilterAnisotropic&&m.transform.pitch>20&&M.texParameterf(M.TEXTURE_2D,D.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,D.extTextureFilterAnisotropicMax);const ei=m.transform;let Qt;const Wt=A?Fb(ei):[0,0,0,0];let Kt,gi,Ci,Hi,lr,ki=0;if(E&&B instanceof o.aU&&B.coordinates.length>3)Kt=Float32Array.from(o.bk(o.dJ(new o.cD(0,0,0)))),gi=Float32Array.from(ei.globeMatrix),Ci=Float32Array.from(o.dF(ei)),Hi=[o.aF(ei.center.lng),o.aJ(ei.center.lat)],Qt=B.elevatedGlobePerspectiveTransform,lr=B.elevatedGlobeGridMatrix||new Float32Array(9);else if(E){const Rr=o.dG(Se.canonical);ki=o.dH(Rr.getCenter().lat),Kt=Float32Array.from(o.bk(o.dJ(Se.canonical))),gi=Float32Array.from(ei.globeMatrix),Ci=Float32Array.from(o.dF(ei)),Hi=[o.aF(ei.center.lng),o.aJ(ei.center.lat)],Qt=[0,0],lr=Float32Array.from(o.dI(Se.canonical,Rr,ki,ei.worldSize/ei._pixelsPerMercatorPixel))}else Qt=B instanceof o.aU?B.perspectiveTransform:[0,0],Kt=new Float32Array(16),gi=new Float32Array(9),Ci=new Float32Array(16),Hi=[0,0],lr=new Float32Array(9);const yr=Lx(dt,Kt,gi,Ci,lr,Mt||[0,0],o.aj(m.transform.zoom),Hi,Wt,kt||1,Ut,d,Qt,A?d.paint.get("raster-elevation"):0,2,nt,ft,z.range,Nt,rt,V),Li=m.isTileAffectedByFog(Se),Dr=m.getOrCreateProgram("raster",{defines:z.defines,overrideFog:Li});if(m.uploadCommonUniforms(D,Dr,qe),B instanceof o.aU){const Rr=B.elevatedGlobeVertexBuffer,Fr=B.elevatedGlobeIndexBuffer;if(W||!S)B.boundsBuffer&&B.boundsSegments&&Dr.draw(m,M.TRIANGLES,$e,ji.disabled,Q,Ai.disabled,yr,d.id,B.boundsBuffer,m.quadTriangleIndexBuffer,B.boundsSegments);else if(Rr&&Fr){const ur=ei.zoom<=o.c_?B.elevatedGlobeSegments:B.getSegmentsForLongitude(ei.center.lng);ur&&Dr.draw(m,M.TRIANGLES,$e,ji.disabled,Q,Oe,yr,d.id,Rr,Fr,ur)}}else if(E){$e=new si(M.LEQUAL,si.ReadOnly,m.depthRangeFor3D);const Rr=m.globeSharedBuffers;if(Rr){const[Fr,ur,Ui]=Rr.getGridBuffers(ki,!1);Dr.draw(m,M.TRIANGLES,$e,Ee||ot,m.colorModeForRenderPass(),Oe,yr,d.id,Fr,ur,Ui)}}else{const{tileBoundsBuffer:Rr,tileBoundsIndexBuffer:Fr,tileBoundsSegments:ur}=m.getTileBoundsBuffers(Ye);Dr.draw(m,M.TRIANGLES,$e,ot,Q,Ai.disabled,yr,d.id,Rr,Fr,ur)}}if(!(B instanceof o.aU)&&E)for(const Se of De){const qe=Se.canonical.y===(1<<Se.canonical.z)-1;Se.canonical.y===0&&sg(!0,Se,m,s,d,V,z,Oe,Ee||ji.disabled),qe&&sg(!1,Se,m,s,d,V,z,Oe===Ai.frontCW?Ai.backCW:Ai.frontCW,Ee||ji.disabled)}};E?Fe(xe,m.renderElevatedRasterBackface?Ai.backCW:Ai.frontCW,m.stencilModeFor3D()):Fe(xe,Ai.disabled,void 0),m.resetStencilClippingMasks()},"raster-particle":function(m,s,d,f,_,b){m.renderPass==="offscreen"&&function(S,A,E,D){if(!D.length)return;const M=S.context,B=M.gl,z=A.getSource();if(!(z instanceof Os))return;const V=Math.ceil(Math.sqrt(E.paint.get("raster-particle-count")));let Q=E.particlePositionRGBAImage;if(!Q||Q.width!==V){const xe=function(fe){const Fe=fe*fe,De=new Uint8Array(4*Fe),Oe=function(Se){return Se|=0,Se=Math.imul(2747636419^Se,2654435769),Se=Math.imul(Se^Se>>>16,2654435769),((Se=Math.imul(Se^Se>>>16,2654435769))>>>0)/4294967296},Ee=.9090909090909091;for(let Se=0;Se<Fe;Se++){const qe=Ee*(Oe(2*Se+0)+hh),Ye=Ee*(Oe(2*Se+1)+hh),Qe=255*qe%1,at=255*Ye%1,nt=Qe,ft=Ye-at/255,Nt=at;De[4*Se+0]=255*(qe-Qe/255),De[4*Se+1]=255*nt,De[4*Se+2]=255*ft,De[4*Se+3]=255*Nt}return De}(V);Q=E.particlePositionRGBAImage=new o.q({width:V,height:V},xe)}let W=E.particleFramebuffer;W?W.width!==V&&(W.destroy(),W=E.particleFramebuffer=M.createFramebuffer(V,V,1,null)):W=E.particleFramebuffer=M.createFramebuffer(V,V,1,null);const J=[];for(const xe of D){const fe=A.getTile(xe);if(!(fe instanceof eh))continue;const Fe=$x(fe,z,E);if(!Fe)continue;const De=[fe.tileSize,fe.tileSize];let Oe=E.tileFramebuffer;Oe||(Oe=E.tileFramebuffer=M.createFramebuffer(De[0],De[1],1,null));let Ee=fe.rasterParticleState;Ee||(Ee=fe.rasterParticleState=new Bb(M,xe,De,Q));const Se=Ee.update(E.lastInvalidatedAt);Ee.particleTextureDimension!==V&&Ee.updateParticleTexture(xe,Q);const qe=Ee.targetColorTexture;Ee.targetColorTexture=Ee.backgroundColorTexture,Ee.backgroundColorTexture=qe;const Ye=Ee.particleTexture0;Ee.particleTexture0=Ee.particleTexture1,Ee.particleTexture1=Ye,J.push([xe,Fe,Ee,Se])}if(J.length===0)return;const ce=o.o.now(),_e=E.previousDrawTimestamp?.001*(ce-E.previousDrawTimestamp):.0167;if(E.previousDrawTimestamp=ce,E.hasColorMap()){M.activeTexture.set(B.TEXTURE0+2);let xe=E.colorRampTexture;xe||(xe=E.colorRampTexture=new o.T(M,E.colorRamp,B.RGBA8)),xe.bind(B.LINEAR,B.CLAMP_TO_EDGE)}M.bindFramebuffer.set(E.tileFramebuffer.framebuffer),function(xe,fe,Fe){const De=xe.context,Oe=De.gl,Ee=fe.tileFramebuffer;De.activeTexture.set(Oe.TEXTURE0);const Se={u_texture:0,u_opacity:1.05*(Ye=fe.paint.get("raster-particle-fade-opacity-factor"))/(Ye+.05)},qe=xe.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var Ye;for(const Qe of Fe){const[,,at,nt]=Qe;Ee.colorAttachment0.set(at.targetColorTexture.texture),De.viewport.set([0,0,Ee.width,Ee.height]),De.clear({color:o.ao.transparent}),nt&&(at.backgroundColorTexture.bind(Oe.NEAREST,Oe.CLAMP_TO_EDGE),qe.draw(xe,Oe.TRIANGLES,si.disabled,ji.disabled,Di.alphaBlended,Ai.disabled,Se,fe.id,xe.viewportBuffer,xe.quadTriangleIndexBuffer,xe.viewportSegments))}}(S,E,J),function(xe,fe,Fe,De){const Oe=xe.context,Ee=Oe.gl,Se=Fe.tileFramebuffer,qe=xe.transform.projection.name==="globe",Ye=Fe.paint.get("raster-particle-max-speed");for(const Qe of De){const[at,nt,ft]=Qe;Oe.activeTexture.set(Ee.TEXTURE0+0),nt.texture.bind(Ee.LINEAR,Ee.CLAMP_TO_EDGE),Se.colorAttachment0.set(ft.targetColorTexture.texture);const Nt=xe.getOrCreateProgram("rasterParticleDraw",{defines:nt.defines,overrideFog:!1});Oe.activeTexture.set(Ee.TEXTURE0+1);const rt=nt.scalarData?[]:[0,1,2,3].map(ot=>o.e9[ot](at));rt.push(at);const $e=at.canonical.x,dt=at.canonical.y;for(const ot of rt){const Ct=fe.getTile(qe?ot.wrapped():ot);if(!Ct)continue;const Rt=Ct.rasterParticleState;if(!Rt)continue;const Ut=ot.canonical.x+(1<<ot.canonical.z)*(ot.wrap-at.wrap),kt=ot.canonical.y;Rt.particleTexture0.bind(Ee.NEAREST,Ee.CLAMP_TO_EDGE);const Mt=Pb(1,Rt.particleTexture0.size[0],[Ut-$e,kt-dt],0,nt.texture.size,2,Ye,nt.textureOffset,nt.scale,nt.offset);Nt.draw(xe,Ee.POINTS,si.disabled,ji.disabled,Di.alphaBlended,Ai.disabled,Mt,Fe.id,Rt.particleIndexBuffer,void 0,Rt.particleSegment)}}}(S,A,E,J),M.bindFramebuffer.set(E.particleFramebuffer.framebuffer),function(xe,fe,Fe,De){const Oe=xe.context,Ee=Oe.gl,Se=fe.paint.get("raster-particle-max-speed"),qe=De*fe.paint.get("raster-particle-speed-factor")*.15,Ye=function(at){return Math.pow(at,6)}(.01+1*fe.paint.get("raster-particle-reset-rate-factor")),Qe=fe.particleFramebuffer;Oe.viewport.set([0,0,Qe.width,Qe.height]);for(const at of Fe){const[,nt,ft]=at;Oe.activeTexture.set(Ee.TEXTURE0+0),nt.texture.bind(Ee.LINEAR,Ee.CLAMP_TO_EDGE),Oe.activeTexture.set(Ee.TEXTURE0+1);const Nt=ft.particleTexture0;Nt.bind(Ee.NEAREST,Ee.CLAMP_TO_EDGE);const rt=lN(1,Nt.size[0],0,nt.texture.size,Se,qe,Ye,nt.textureOffset,nt.scale,nt.offset);Qe.colorAttachment0.set(ft.particleTexture1.texture),Oe.clear({color:o.ao.transparent}),xe.getOrCreateProgram("rasterParticleUpdate",{defines:nt.defines}).draw(xe,Ee.TRIANGLES,si.disabled,ji.disabled,Di.unblended,Ai.disabled,rt,fe.id,xe.viewportBuffer,xe.quadTriangleIndexBuffer,xe.viewportSegments)}}(S,E,J,_e)}(m,s,d,f),m.renderPass==="translucent"&&(function(S,A,E,D){const M=S.context,B=M.gl,z=A.getSource().tileSize,V=5*(1-o.ah(o.cL,o.cL+1,S.transform.zoom))*z+E.paint.get("raster-particle-elevation"),Q=!S.options.moving,W=S.transform.projection.name==="globe";if(!D.length)return;const[J,ce]=S.stencilConfigForOverlap(D),_e=[];W&&_e.push("PROJECTION_GLOBE_VIEW");const xe=S.stencilModeFor3D();for(const fe of ce){const Fe=fe.toUnwrapped(),De=A.getTile(fe);if(!De.rasterParticleState)continue;const Oe=De.rasterParticleState,Ee=100;De.registerFadeDuration(Ee);const Se=A.findLoadedParent(fe,0),qe=tm(De,Se,A,S.transform,Ee);let Ye,Qe;S.terrain&&S.terrain.prepareDrawTile(),M.activeTexture.set(B.TEXTURE0),Oe.targetColorTexture.bind(B.LINEAR,B.CLAMP_TO_EDGE),M.activeTexture.set(B.TEXTURE1),Se&&Se.rasterParticleState?(Se.rasterParticleState.targetColorTexture.bind(B.LINEAR,B.CLAMP_TO_EDGE),Ye=Math.pow(2,Se.tileID.overscaledZ-De.tileID.overscaledZ),Qe=[De.tileID.canonical.x*Ye%1,De.tileID.canonical.y*Ye%1]):Oe.targetColorTexture.bind(B.LINEAR,B.CLAMP_TO_EDGE);const at=W?Float32Array.from(S.transform.expandedFarZProjMatrix):S.transform.calculateProjMatrix(Fe,Q),nt=S.transform,ft=Vb(nt),Nt=o.dG(fe.canonical),rt=o.dH(Nt.getCenter().lat);let $e,dt,ot,Ct,Rt;W?($e=Float32Array.from(o.bk(o.dJ(fe.canonical))),dt=Float32Array.from(nt.globeMatrix),ot=Float32Array.from(o.dF(nt)),Ct=[o.aF(nt.center.lng),o.aJ(nt.center.lat)],Rt=Float32Array.from(o.dI(fe.canonical,Nt,rt,nt.worldSize/nt._pixelsPerMercatorPixel))):($e=new Float32Array(16),dt=new Float32Array(9),ot=new Float32Array(16),Ct=[0,0],Rt=new Float32Array(9));const Ut=oN(at,$e,dt,ot,Rt,Qe||[0,0],o.aj(S.transform.zoom),Ct,ft,Ye||1,qe,V),kt=S.isTileAffectedByFog(fe),Mt=S.getOrCreateProgram("rasterParticle",{defines:_e,overrideFog:kt});if(S.uploadCommonUniforms(M,Mt,Fe),W){const ei=new si(B.LEQUAL,si.ReadOnly,S.depthRangeFor3D),Qt=0,Wt=S.globeSharedBuffers;if(Wt){const[Kt,gi,Ci]=Wt.getGridBuffers(rt,Qt!==0);Mt.draw(S,B.TRIANGLES,ei,xe,Di.alphaBlended,S.renderElevatedRasterBackface?Ai.frontCCW:Ai.backCCW,Ut,E.id,Kt,gi,Ci)}}else{const ei=S.depthModeForSublayer(0,si.ReadOnly),Qt=J[fe.overscaledZ],{tileBoundsBuffer:Wt,tileBoundsIndexBuffer:Kt,tileBoundsSegments:gi}=S.getTileBoundsBuffers(De);Mt.draw(S,B.TRIANGLES,ei,Qt,Di.alphaBlended,Ai.disabled,Ut,E.id,Wt,Kt,gi)}}S.resetStencilClippingMasks()}(m,s,d,f),m.style.map.triggerRepaint())},background:function(m,s,d,f){const _=d.paint.get("background-color"),b=d.paint.get("background-color-use-theme").constantOr("default")==="none",S=d.paint.get("background-opacity"),A=d.paint.get("background-emissive-strength"),E=d.paint.get("background-pitch-alignment")==="viewport";if(S===0)return;const D=m.context,M=D.gl,B=m.transform,z=B.tileSize,V=d.paint.get("background-pattern");let Q;if(V!==void 0&&(V===null||(Q=m.imageManager.getPattern(o.I.from(V.toString()),d.scope,m.style.getLut(d.scope)),!Q)))return;const W=!V&&_.a===1&&S===1&&m.opaquePassEnabledForLayer()?"opaque":"translucent";if(m.renderPass!==W)return;const J=ji.disabled,ce=m.depthModeForSublayer(0,W==="opaque"?si.ReadWrite:si.ReadOnly),_e=m.colorModeForDrapableLayerRenderPass(A),xe=V?"backgroundPattern":"background";let fe,Fe=f;Fe||(fe=m.getBackgroundTiles(),Fe=Object.values(fe).map(Oe=>Oe.tileID)),V&&(D.activeTexture.set(M.TEXTURE0),m.imageManager.bind(m.context,d.scope));const De=[];if(m.terrain&&m.terrain.renderingToTexture&&m.emissiveMode==="mrt-fallback"&&De.push("USE_MRT1"),E){const Oe=m.getOrCreateProgram(xe,{overrideFog:!1,overrideRtt:!0,defines:De}),Ee=new Float32Array(o.bA([])),Se=new o.aQ(0,0,0,0,0),qe=V?nm(Ee,A,S,m,0,d.scope,Q,E,{tileID:Se,tileSize:z}):yu(Ee,A,S,_.toPremultipliedRenderColor(b?null:d.lut));return void Oe.draw(m,M.TRIANGLES,ce,J,_e,Ai.disabled,qe,d.id,m.viewportBuffer,m.quadTriangleIndexBuffer,m.viewportSegments)}for(const Oe of Fe){const Ee=m.isTileAffectedByFog(Oe),Se=m.getOrCreateProgram(xe,{overrideFog:Ee,defines:De}),qe=Oe.toUnwrapped(),Ye=f?Oe.projMatrix:m.transform.calculateProjMatrix(qe);m.prepareDrawTile();const Qe=s?s.getTile(Oe):fe?fe[Oe.key]:new Hl(Oe,z,B.zoom,m),at=V?nm(Ye,A,S,m,0,d.scope,Q,E,{tileID:Oe,tileSize:z}):yu(Ye,A,S,_.toPremultipliedRenderColor(b?null:d.lut));m.uploadCommonUniforms(D,Se,qe);const{tileBoundsBuffer:nt,tileBoundsIndexBuffer:ft,tileBoundsSegments:Nt}=m.getTileBoundsBuffers(Qe);Se.draw(m,M.TRIANGLES,ce,J,_e,Ai.disabled,at,d.id,nt,ft,Nt)}},sky:function(m,s,d){const f=m._atmosphere?o.aj(m.transform.zoom):1,_=d.paint.get("sky-opacity")*f;if(_===0)return;const b=m.context,S=d.paint.get("sky-type"),A=new si(b.gl.LEQUAL,si.ReadOnly,[0,1]),E=m.frameCounter/1e3%1;S==="atmosphere"?m.renderPass==="offscreen"?d.needsSkyboxCapture(m)&&(function(D,M){const B=D.context,z=B.gl;let V=M.skyboxFbo;if(!V){V=M.skyboxFbo=B.createFramebuffer(32,32,1,null),M.skyboxGeometry=new io(B),M.skyboxTexture=B.gl.createTexture(),z.bindTexture(z.TEXTURE_CUBE_MAP,M.skyboxTexture),z.texParameteri(z.TEXTURE_CUBE_MAP,z.TEXTURE_WRAP_S,z.CLAMP_TO_EDGE),z.texParameteri(z.TEXTURE_CUBE_MAP,z.TEXTURE_WRAP_T,z.CLAMP_TO_EDGE),z.texParameteri(z.TEXTURE_CUBE_MAP,z.TEXTURE_MIN_FILTER,z.LINEAR),z.texParameteri(z.TEXTURE_CUBE_MAP,z.TEXTURE_MAG_FILTER,z.LINEAR);for(let ce=0;ce<6;++ce)z.texImage2D(z.TEXTURE_CUBE_MAP_POSITIVE_X+ce,0,z.RGBA,32,32,0,z.RGBA,z.UNSIGNED_BYTE,null)}B.bindFramebuffer.set(V.framebuffer),B.viewport.set([0,0,32,32]);const Q=M.getCenter(D,!0),W=D.getOrCreateProgram("skyboxCapture"),J=new Float64Array(16);o.bA(J),o.en(J,J,.5*-Math.PI),vu(D,M,W,J,Q,0),o.bA(J),o.en(J,J,.5*Math.PI),vu(D,M,W,J,Q,1),o.bA(J),o.cU(J,J,.5*-Math.PI),vu(D,M,W,J,Q,2),o.bA(J),o.cU(J,J,.5*Math.PI),vu(D,M,W,J,Q,3),o.bA(J),vu(D,M,W,J,Q,4),o.bA(J),o.en(J,J,Math.PI),vu(D,M,W,J,Q,5),B.viewport.set([0,0,D.width,D.height])}(m,d),d.markSkyboxValid(m)):m.renderPass==="sky"&&function(D,M,B,z,V){const Q=D.context,W=Q.gl,J=D.transform,ce=D.getOrCreateProgram("skybox");Q.activeTexture.set(W.TEXTURE0),W.bindTexture(W.TEXTURE_CUBE_MAP,M.skyboxTexture);const _e=((xe,fe,Fe,De,Oe)=>({u_matrix:xe,u_sun_direction:fe,u_cubemap:0,u_opacity:De,u_temporal_offset:Oe}))(J.skyboxMatrix,M.getCenter(D,!1),0,z,V);D.uploadCommonUniforms(Q,ce),ce.draw(D,W.TRIANGLES,B,ji.disabled,D.colorModeForRenderPass(),Ai.backCW,_e,"skybox",M.skyboxGeometry.vertexBuffer,M.skyboxGeometry.indexBuffer,M.skyboxGeometry.segment)}(m,d,A,_,E):S==="gradient"&&m.renderPass==="sky"&&function(D,M,B,z,V){const Q=D.context,W=Q.gl,J=D.transform,ce=D.getOrCreateProgram("skyboxGradient");M.skyboxGeometry||(M.skyboxGeometry=new io(Q)),Q.activeTexture.set(W.TEXTURE0);let _e=M.colorRampTexture;_e||(_e=M.colorRampTexture=new o.T(Q,M.colorRamp,W.RGBA8)),_e.bind(W.LINEAR,W.CLAMP_TO_EDGE);const xe=((fe,Fe,De,Oe,Ee)=>({u_matrix:fe,u_color_ramp:0,u_center_direction:Fe,u_radius:o.an(De),u_opacity:Oe,u_temporal_offset:Ee}))(J.skyboxMatrix,M.getCenter(D,!1),M.paint.get("sky-gradient-radius"),z,V);D.uploadCommonUniforms(Q,ce),ce.draw(D,W.TRIANGLES,B,ji.disabled,D.colorModeForRenderPass(),Ai.backCW,xe,"skyboxGradient",M.skyboxGeometry.vertexBuffer,M.skyboxGeometry.indexBuffer,M.skyboxGeometry.segment)}(m,d,A,_,E)},custom:function(m,s,d,f){const _=m.context,b=d.implementation;if(!m.transform.projection.unsupportedLayers||!m.transform.projection.unsupportedLayers.includes("custom")||m.terrain&&(m.terrain.renderingToTexture||m.renderPass==="offscreen")&&d.isDraped(s)){if(m.renderPass==="offscreen"){const S=b.prerender;if(S){if(m.setCustomLayerDefaults(),_.setColorMode(m.colorModeForRenderPass()),m.transform.projection.name==="globe"){const A=m.transform.pointMerc;S.call(b,_.gl,m.transform.customLayerMatrix(),m.transform.getProjection(),m.transform.globeToMercatorMatrix(),o.aj(m.transform.zoom),[A.x,A.y],m.transform.pixelsPerMeterRatio)}else S.call(b,_.gl,m.transform.customLayerMatrix());_.setDirty(),m.setBaseState()}}else if(m.renderPass==="translucent"){if(m.terrain&&m.terrain.renderingToTexture){const A=b.renderToTile;if(A){const E=f[0].canonical,D={x:E.x+f[0].wrap*(b.wrapTileId?0:1<<E.z),y:E.y,z:E.z};_.setDepthMode(si.disabled),_.setStencilMode(ji.disabled),_.setColorMode(m.colorModeForRenderPass()),m.setCustomLayerDefaults(),A.call(b,_.gl,D),_.setDirty(),m.setBaseState()}return}m.setCustomLayerDefaults(),_.setColorMode(m.colorModeForRenderPass()),_.setStencilMode(ji.disabled);const S=b.renderingMode==="3d"?new si(m.context.gl.LEQUAL,si.ReadWrite,m.depthRangeFor3D):m.depthModeForSublayer(0,si.ReadOnly);if(_.setDepthMode(S),m.transform.projection.name==="globe"){const A=m.transform.pointMerc;b.render(_.gl,m.transform.customLayerMatrix(),m.transform.getProjection(),m.transform.globeToMercatorMatrix(),o.aj(m.transform.zoom),[A.x,A.y],m.transform.pixelsPerMeterRatio)}else b.render(_.gl,m.transform.customLayerMatrix());_.setDirty(),m.setBaseState(),_.bindFramebuffer.set(null)}}else o.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(m,s,d,f){if(m.renderPass==="opaque")return;const _=d.paint.get("model-opacity").constantOr(1),b=d.paint.get("model-elevation-reference"),S=b==="ground",A=b==="ground";if(_===0)return;const E=d.paint.get("model-cast-shadows");if(m.renderPass==="shadow"&&(!E||m.terrain&&_<.65&&d._transitionablePaint._values["model-opacity"].value.expression instanceof o.ad))return;const D=m.shadowRenderer,M=d.paint.get("model-receive-shadows");D&&(D.useNormalOffset=!0,M||(D.enabled=!1));const B=()=>{D&&(D.useNormalOffset=!0,M||(D.enabled=!0))},z=s.getSource();if(m.renderPass==="light-beam"&&z.type!=="batched-model")return;if(z.type==="vector"||z.type==="geojson")return function(fe,Fe,De,Oe,Ee){const Se=fe.transform,qe=Se.projection.name==="globe",Ye=Se.getFreeCameraOptions().position;if(!fe.modelManager)return;const Qe=fe.modelManager;De.modelManager=Qe;const at=fe.shadowRenderer;if(!De._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const nt=De._unevaluatedLayout._values["model-id"],ft=Object.assign({},De.layout.get("model-id").parameters),Nt=fe.style.order.indexOf(De.fqid),rt=De.paint.get("model-opacity").constantOr(1);for(const $e of Oe){const dt=Fe.getTile($e).getBucket(De);if(!dt||dt.projection.name!==Se.projection.name)continue;const ot=dt.getModelUris();if(ot&&!dt.modelsRequested&&(Qe.addModelsFromBucket(ot,Ee),dt.modelsRequested=!0),qe)ft.zoom=$e.overscaledZ;else{const Wt=Dt($e,Se);ft.zoom=Wt}const Ct=nt.possiblyEvaluate(ft);if(md(fe,dt,$e),za.shadowUniformsInitialized=!1,za.useSingleShadowCascade=!!at&&at.getMaxCascadeForTile($e.toUnwrapped())===0,fe.renderPass==="shadow"&&at){if(fe.currentShadowCascade===1&&dt.isInsideFirstShadowMapFrustum)continue;const Wt=Se.calculatePosMatrix($e.toUnwrapped(),Se.worldSize);if(za.tileMatrix.set(Wt),za.shadowTileMatrix=Float32Array.from(at.calculateShadowPassMatrixFromMatrix(Wt)),za.aabb.min=[0,0,0],za.aabb.max[0]=za.aabb.max[1]=o.al,za.aabb.max[2]=0,kn(dt,za,fe,De.scope))continue}const Rt=1<<$e.canonical.z,Ut=[((Ye.x-$e.wrap)*Rt-$e.canonical.x)*o.al,(Ye.y*Rt-$e.canonical.y)*o.al,Ye.z*Rt*o.al];fe.conflationActive&&Object.keys(dt.instancesPerModel).length>0&&fe.style.isLayerClipped(De,Fe.getSource())&&dt.updateReplacement($e,fe.replacementSource,Nt,De.scope)&&(dt.uploaded=!1,dt.upload(fe.context));let kt=0;const Mt=new Array,ei=new Array,Qt=new Array;for(let Wt in dt.instancesPerModel){const Kt=dt.instancesPerModel[Wt];Kt.features.length>0&&!qe&&(Wt=Ct.evaluate(Kt.features[0].feature,{}));const gi=Qe.getModel(Wt,Ee);if(gi||Qe.hasURLBeenRequested(Wt)||dt.modelUris.includes(Wt)||(dt.modelUris.push(Wt),dt.modelsRequested=!1),gi&&gi.uploaded)if(qe){const Ci=o.c5([],[Ye.x,Ye.y,Ye.z],fe.transform.worldSize);o.ew(Ci,Ci);for(let Hi=0;Hi<Kt.instancedDataArray.length;++Hi){const lr=[0,0,0],ki=[1,1,1],yr=o.ex(),Li=Kt.tileCoordinatesForInstance(Hi),Dr=Kt.transformForInstance(Hi);o.ey(ki,Dr),o.ez(yr,Dr),o.eA(lr,yr);const Rr=Kt.translationForInstance(Hi),Fr=new o.aT(0,0);o.eB(dt.canonical,Fr,Li.x,Li.y);const ur=o.bC();o.eC(ur,gi,fe.transform,Fr,lr,ki,Rr,!0,!1,!1);const Ui=Kt.colorForInstance(Hi),Ir=o.bA([]),hn=o.ef(Fr.lat,fe.transform.zoom),pn=o.bq([],[1,1,1/hn]);o.br(Ir,Ir,Ci),Qt.push({zScaleMatrix:pn,negCameraPosMatrix:Ir});for(const Pr of gi.nodes)lm(fe,Pr,ur,fe.transform.expandedFarZProjMatrix,kt,Mt,ei,gi.materialOverrides,rt,Ui);++kt}}else for(const Ci of gi.nodes)$t(fe,De,Ci,Kt,Ut,$e,za)}if(qe)if(fe.renderPass==="shadow"){for(const Wt of ei)gh(Wt.mesh,Wt.nodeModelMatrix,fe,De);for(const Wt of Mt)gh(Wt.mesh,Wt.nodeModelMatrix,fe,De)}else Jx(fe,De,Mt,ei,Qt)}}(m,s,d,f,om(m,d)),void B();if(!z.loaded())return;if(z.type==="batched-model")return function(fe,Fe,De,Oe){De.resetLayerRenderingStats(fe);const Ee=fe.context,Se=fe.transform,qe=fe.style.fog,Ye=fe.shadowRenderer;if(Se.projection.name!=="mercator")return void o.w(`Drawing 3D landmark models for ${Se.projection.name} projection is not yet implemented`);const Qe=fe.transform.getFreeCameraOptions().position,at=o.c5([],[Qe.x,Qe.y,Qe.z],fe.transform.worldSize),nt=o.ew([],at),ft=o.bA([]),Nt=o.ef(Se.center.lat,Se.zoom),rt=o.bq([],[1,1,1/Nt]);o.br(ft,ft,nt);const $e=De.paint.get("model-opacity").constantOr(1),dt=new si(Ee.gl.LEQUAL,si.ReadWrite,fe.depthRangeFor3D),ot=new si(Ee.gl.LEQUAL,si.ReadOnly,fe.depthRangeFor3D),Ct=new o.d9([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),Rt=fe.renderPass==="shadow",Ut=Rt&&Ye?Ye.getCurrentCascadeFrustum():Se.getFrustum(Se.scaleZoom(Se.worldSize)),kt=De.paint.get("model-front-cutoff"),Mt=kt[2]<1,ei=dl(fe,De.paint.get("model-cutoff-fade-range")),Qt=De.getLayerRenderingStats();(function(Wt,Kt,gi,Ci){const Hi=Wt.terrain?Wt.terrain.exaggeration():0,lr=Wt.transform.zoom;for(const ki of Ci){const yr=Kt.getTile(ki).getBucket(gi);yr&&(yr.setFilter(gi.filter),Wt.conflationActive&&yr.updateReplacement(ki,Wt.replacementSource),yr.evaluateTransform(Wt,gi),Wt.terrain&&Hi>0&&yr.elevationUpdate(Wt.terrain,Hi,ki,gi.source),yr.needsReEvaluation(Wt,lr,gi)&&yr.evaluate(gi))}})(fe,Fe,De,Oe),function(){let Wt,Kt,gi;Mt?(Wt=Oe.length-1,Kt=-1,gi=-1):(Wt=0,Kt=Oe.length,gi=1);const Ci=new Float64Array(16),Hi=o.cA(),lr=new o.P(0,0);for(let ki=Wt;ki!==Kt;ki+=gi){const yr=Oe[ki],Li=Fe.getTile(yr).getBucket(De);if(!Li||!Li.uploaded)continue;let Dr=!1;Ye&&(Dr=Ye.getMaxCascadeForTile(yr.toUnwrapped())===0);const Rr=Se.calculatePosMatrix(yr.toUnwrapped(),Se.worldSize),Fr=Li.modelTraits;!Rt&&Mt&&(o.bl(Ci,Rr),o.af(Hi,at,Ci),lr.x=Hi[0],lr.y=Hi[1]);const ur=[];Li.setFilter(De.filter);for(const Ui of Li.getNodesInfo()){if(Ui.hiddenByReplacement||!Ui.node.meshes)continue;const Ir=Ui.node;let hn=0;fe.terrain&&Ir.elevation&&(hn=Ir.elevation*fe.terrain.exaggeration());const pn=(()=>{const jr=Ui.aabb;return Ct.min=[...jr.min],Ct.max=[...jr.max],Ct.min[2]+=hn,Ct.max[2]+=hn,o.af(Ct.min,Ct.min,Rr),o.af(Ct.max,Ct.max,Rr),Ct})(),Pr=Ui.evaluatedScale;if(Pr[0]<=1&&Pr[1]<=1&&Pr[2]<=1&&pn.intersects(Ut)===0)continue;if(!Rt&&Mt){const jr=.16666666666666666;Ui.cameraCollisionOpacity=at[0]>pn.min[0]&&at[0]<pn.max[0]&&at[1]>pn.min[1]&&at[1]<pn.max[1]&&at[2]*Nt<pn.max[2]&&Ir.footprint&&o.c0(lr,Ir.footprint)?Math.max(Ui.cameraCollisionOpacity-jr,0):Math.min(1,Ui.cameraCollisionOpacity+jr)}const rr=[...Rr],Gi=1/o.d7(yr.canonical),Zr=Ir.anchor?Ir.anchor[0]:0,Dn=Ir.anchor?Ir.anchor[1]:0;o.br(rr,rr,[Zr*(Pr[0]-1)+Ui.evaluatedTranslation[0]*Gi,Dn*(Pr[1]-1)+Ui.evaluatedTranslation[1]*Gi,hn+Ui.evaluatedTranslation[2]]),o.cq(Pr,o.eE)||o.cS(rr,rr,Pr);const Kr=o.aB([],rr,Ir.globalMatrix),tn=o.aB([],Se.expandedFarZProjMatrix,Kr),Va=o.aB([],Se.expandedFarZProjMatrix,rr),ro=o.aC([],[Zr,Dn,hn,1],tn)[2];Ir.hidden=!1;let Fs=$e;Rt||(Mt&&(Fs*=Ui.cameraCollisionOpacity,Fs*=Zb(rr,Se,Ui.aabb,kt)),Fs*=et(ei,ro)),Fs!==0?ur.push({nodeInfo:Ui,depth:ro,opacity:Fs,wvpForNode:tn,wvpForTile:Va,nodeModelMatrix:Kr,tileModelMatrix:rr}):Ir.hidden=!0}Rt||ur.sort((Ui,Ir)=>!Mt||Ui.opacity===1&&Ir.opacity===1?Ui.depth<Ir.depth?-1:1:Ui.opacity===1?-1:Ir.opacity===1?1:Ui.depth>Ir.depth?-1:1);for(const Ui of ur){const Ir=Ui.nodeInfo,hn=Ir.node;let pn=o.aB([],rt,Ui.tileModelMatrix);o.aB(pn,ft,pn);const Pr=o.bl([],pn);o.eg(Pr,Pr),o.cS(Pr,Pr,yh),pn=o.aB(pn,pn,hn.globalMatrix);const rr=fe.renderPass==="light-beam",Gi=De.paint.get("model-color-use-theme").constantOr("default")==="none",Zr=Fr&o.eI.HasMapboxMeshFeatures,Dn=Zr?0:Ir.evaluatedRMEA[0][2];for(let Kr=0;Kr<hn.meshes.length;++Kr){const tn=hn.meshes[Kr],Va=Kr===hn.lightMeshIndex;let ro=Ui.wvpForNode;if(Va){if(!rr&&!fe.terrain&&fe.shadowRenderer){fe.currentLayer<fe.firstLightBeamLayer&&(fe.firstLightBeamLayer=fe.currentLayer);continue}ro=Ui.wvpForTile}else if(rr)continue;const Fs={defines:[]},jr=[];if(!Rt&&Ye&&(Ye.useNormalOffset=!!tn.normalBuffer),El(Fs.defines,jr,tn,fe,Gi?null:De.lut),Zr||Fs.defines.push("DIFFUSE_SHADED"),Dr&&Fs.defines.push("SHADOWS_SINGLE_CASCADE"),Qt&&(Rt?Qt.numRenderedVerticesInShadowPass+=tn.vertexArray.length:Qt.numRenderedVerticesInTransparentPass+=tn.vertexArray.length),Rt){gh(tn,Ui.nodeModelMatrix,fe,De);continue}let vo=null;if(qe){const Hn=Qx(Ui.nodeModelMatrix,fe.transform);if(vo=new Float32Array(Hn),Se.projection.name!=="globe"){const Qr=tn.aabb.min,ts=tn.aabb.max,[ba,zn]=qe.getOpacityForBounds(Hn,Qr[0],Qr[1],ts[0],ts[1]);Fs.overrideFog=ba>=Ht||zn>=Ht}}const ua=tn.material;let no;ua.occlusionTexture&&ua.occlusionTexture.offsetScale&&(no=ua.occlusionTexture.offsetScale,Fs.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));const ml=fe.getOrCreateProgram("model",Fs);!Rt&&Ye&&Ye.setupShadowsFromMatrix(Ui.tileModelMatrix,ml,Ye.useNormalOffset),fe.uploadCommonUniforms(Ee,ml,null,vo);const Ua=ua.pbrMetallicRoughness;Ua.metallicFactor=.9,Ua.roughnessFactor=.5;const _n=Jf(new Float32Array(ro),new Float32Array(pn),new Float32Array(Pr),new Float32Array(hn.globalMatrix),fe,Ui.opacity,Ua.baseColorFactor,ua.emissiveFactor,Ua.metallicFactor,Ua.roughnessFactor,ua,Dn,De,[0,0,0],no);!Va&&(Ir.hasTranslucentParts||Ui.opacity<1)&&ml.draw(fe,Ee.gl.TRIANGLES,dt,ji.disabled,Di.disabled,Ai.backCCW,_n,De.id,tn.vertexBuffer,tn.indexBuffer,tn.segments,De.paint,fe.transform.zoom,void 0,jr),ml.draw(fe,Ee.gl.TRIANGLES,Va?ot:dt,ji.disabled,Va||Ui.opacity<1||Ir.hasTranslucentParts?Di.alphaBlended:Di.unblended,Ai.backCCW,_n,De.id,tn.vertexBuffer,tn.indexBuffer,tn.segments,De.paint,fe.transform.zoom,void 0,jr)}}}}()}(m,s,d,f),void B();if(z.type!=="model")return;const V=z.getModels(),Q=[],W=m.transform.getFreeCameraOptions().position,J=o.c5([],[W.x,W.y,W.z],m.transform.worldSize);o.ew(J,J);const ce=[],_e=[];let xe=0;for(const fe of V){const Fe=s.getFeatureState("",fe.id),De={type:"Unknown",id:fe.id,properties:fe.featureProperties},Oe=d.paint.get("model-rotation").evaluate(De,Fe),Ee=d.paint.get("model-scale").evaluate(De,Fe),Se=d.paint.get("model-translation").evaluate(De,Fe),qe=d.paint.get("model-opacity").evaluate(De,Fe);Hb(d,fe.id,Fe,fe.featureProperties,fe.nodeOverrideNames,fe.nodeOverrides),Wb(d,fe.id,Fe,fe.featureProperties,fe.materialOverrideNames,fe.materialOverrides),fe.nodeOverrides.size>0&&fe.computeBoundsAndApplyParent(),fe.computeModelMatrix(m,Oe,Ee,Se,A,S,!1);const Ye=o.bA([]),Qe=o.ef(fe.position.lat,m.transform.zoom),at=o.bq([],[1,1,1/Qe]);o.br(Ye,Ye,J),Q.push({zScaleMatrix:at,negCameraPosMatrix:Ye});for(const nt of fe.nodes)lm(m,nt,fe.matrix,m.transform.expandedFarZProjMatrix,xe,ce,_e,fe.materialOverrides,qe);xe++}if(ce.sort((fe,Fe)=>Fe.depth-fe.depth),m.renderPass!=="shadow")Jx(m,d,ce,_e,Q),B();else{for(const fe of _e)gh(fe.mesh,fe.nodeModelMatrix,m,d);for(const fe of ce)gh(fe.mesh,fe.nodeModelMatrix,m,d);B()}}},s_={line:function(m,s,d){if(m.hasElevatedBuckets=!1,m.hasNonElevatedBuckets=!1,m._unevaluatedLayout.getValue("line-elevation-reference")!==void 0||m._unevaluatedLayout.getValue("line-z-offset")!==void 0){if(s){const f=s.getVisibleCoordinates();for(const _ of f){const b=s.getTile(_).getBucket(m);if(b&&(b.elevationType!=="none"?m.hasElevatedBuckets=!0:m.hasNonElevatedBuckets=!0,m.hasElevatedBuckets&&m.hasNonElevatedBuckets))break}}}else m.hasNonElevatedBuckets=!0},model:function(m,s,d){const f=s.getSource();if(!f.loaded())return;if(f.type==="vector"||f.type==="geojson")return void(d.modelManager&&d.modelManager.upload(d,om(d,m)));if(f.type==="batched-model"||f.type!=="model")return;const _=f.getModels();for(const b of _)b.upload(d.context)},raster:function(m,s,d){const f=s.getSource();if(!(f instanceof Os&&f.loaded()))return;const _=m.sourceLayer||f.rasterLayerIds&&f.rasterLayerIds[0];if(!_)return;const b=m.paint.get("raster-array-band")||f.getInitialBand(_);if(b==null)return;const S=s.getIds().map(A=>s.getTileByID(A));for(const A of S)A.updateNeeded(m.id,b)&&f.prepareTile(A,_,m.id,b)},"raster-particle":function(m,s,d){const f=s.getSource();if(!(f instanceof Os&&f.loaded()))return;const _=m.sourceLayer||f.rasterLayerIds&&f.rasterLayerIds[0];if(!_)return;const b=m.paint.get("raster-particle-array-band")||f.getInitialBand(_);if(b==null)return;const S=s.getIds().map(A=>s.getTileByID(A));for(const A of S)A.updateNeeded(m.id,b)&&f.prepareTile(A,_,m.id,b)}},a_={fill:Bx},Kb={fill:function(m,s,d,f){if(!d.layout||d.layout.get("fill-elevation-reference")==="none"||d.paint.get("fill-opacity").constantOr(1)===0)return;const _=m.context.gl,b=new si(_.LEQUAL,si.ReadOnly,m.depthRangeFor3D),S=new ji({func:_.ALWAYS,mask:255},255,255,_.KEEP,_.KEEP,_.REPLACE),A=m.transform.getFreeCameraOptions().position,E=m.getOrCreateProgram("elevatedStructuresDepthReconstruct");for(const D of f){const M=s.getTile(D),B=M.getBucket(d);if(!B)continue;const z=B.elevatedStructures;if(!z||z.depthSegments.segments[0].primitiveLength===0)continue;const V=zx(D.toUnwrapped(),A),Q=m.translatePosMatrix(D.projMatrix,M,d.paint.get("fill-translate"),d.paint.get("fill-translate-anchor")),W=dd(Q,V,0,1,0);E.draw(m,_.TRIANGLES,b,S,Di.disabled,Ai.disabled,W,d.id,z.vertexBuffer,z.indexBuffer,z.depthSegments,d.paint,m.transform.zoom)}}};class Qb{constructor(s,d,f,_,b){this.context=new tg(s,d),this.transform=f,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this._timeStamp=o.o.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const S=["fill","line","symbol","circle","heatmap","fill-extrusion","building","raster","raster-particle","hillshade","model","background","sky"];for(const E of S)this._debugParams.enabledLayers[E]=!0;for(const E of S);this.occlusionParams=new t_,this.setup(),this.numSublayers=Ca.maxUnderzooming+Ca.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new o.eP,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new Hp(this),this._wireframeDebugCache=new e_,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];const A=new o.q({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new o.T(this.context,A,s.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=_,this.worldview=b,this._forceEmissiveMode=!1,this.emissiveMode="constant"}updateTerrain(s,d){const f=!!s&&!!s.terrain&&this.transform.projection.supportsTerrain;if(!(f||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Px(this,s));const _=this._terrain;this.transform.elevation=f?_:null,_.update(s,this.transform,d),this.transform.elevation&&!_.enabled&&(this.transform.elevation=null)}_updateFog(s){const d=s.fog;if(!d||this.transform.projection.name==="globe"||d.getOpacity(this.transform.pitch)<1||d.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[f,_]=d.getFovAdjustedRange(this.transform._fov);if(f>_)return void(this.transform.fogCullDistSq=null);const b=f+.78*(_-f);this.transform.fogCullDistSq=b*b}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(s){s&&!this._terrain&&(this._terrain=new Px(this,this.style)),this._forceTerrainMode=s}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(s,d){if(this.width=s*o.o.devicePixelRatio,this.height=d*o.o.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const f of this.style.order)this.style._mergedLayers[f].resize()}setup(){const s=this.context,d=new o.bd;d.emplaceBack(0,0),d.emplaceBack(o.al,0),d.emplaceBack(0,o.al),d.emplaceBack(o.al,o.al),this.tileExtentBuffer=s.createVertexBuffer(d,o.bf.members),this.tileExtentSegments=o.bg.simpleSegment(0,0,4,2);const f=new o.bd;f.emplaceBack(0,0),f.emplaceBack(o.al,0),f.emplaceBack(0,o.al),f.emplaceBack(o.al,o.al),this.debugBuffer=s.createVertexBuffer(f,o.bf.members),this.debugSegments=o.bg.simpleSegment(0,0,4,5);const _=new o.bd;_.emplaceBack(-1,-1),_.emplaceBack(1,-1),_.emplaceBack(-1,1),_.emplaceBack(1,1),this.viewportBuffer=s.createVertexBuffer(_,o.bf.members),this.viewportSegments=o.bg.simpleSegment(0,0,4,2);const b=new o.b1;b.emplaceBack(0,0,0,0),b.emplaceBack(o.al,0,o.al,0),b.emplaceBack(0,o.al,0,o.al),b.emplaceBack(o.al,o.al,o.al,o.al),this.mercatorBoundsBuffer=s.createVertexBuffer(b,o.bi.members),this.mercatorBoundsSegments=o.bg.simpleSegment(0,0,4,2);const S=new o.b0;S.emplaceBack(0,1,2),S.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=s.createIndexBuffer(S);const A=new o.be;for(const D of[0,1,3,2,0])A.emplaceBack(D);this.debugIndexBuffer=s.createIndexBuffer(A),this.emptyTexture=new o.T(s,new o.q({width:1,height:1},Uint8Array.of(0,0,0,0)),s.gl.RGBA8),this.identityMat=o.bC();const E=this.context.gl;this.stencilClearMode=new ji({func:E.ALWAYS,mask:0},0,255,E.ZERO,E.ZERO,E.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(s){return s._makeTileBoundsBuffers(this.context,this.transform.projection),s._tileBoundsBuffer?{tileBoundsBuffer:s._tileBoundsBuffer,tileBoundsIndexBuffer:s._tileBoundsIndexBuffer,tileBoundsSegments:s._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const s=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,s.TRIANGLES,si.disabled,this.stencilClearMode,Di.disabled,Ai.disabled,em(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(s,d,f){if(!d||this.currentStencilSource===d.id||!s.isTileClipped()||!f||f.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let A=!1;for(const E of f)if(this._tileClippingMaskIDs[E.key]===void 0){A=!0;break}if(!A)return}this.currentStencilSource=d.id;const _=this.context,b=_.gl;this.nextStencilID+f.length>256&&this.clearStencil(),_.setColorMode(Di.disabled),_.setDepthMode(si.disabled);const S=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const A of f){const E=d.getTile(A),D=this._tileClippingMaskIDs[A.key]=this.nextStencilID++,{tileBoundsBuffer:M,tileBoundsIndexBuffer:B,tileBoundsSegments:z}=this.getTileBoundsBuffers(E);S.draw(this,b.TRIANGLES,si.disabled,new ji({func:b.ALWAYS,mask:0},D,255,b.KEEP,b.KEEP,b.REPLACE),Di.disabled,Ai.disabled,em(A.projMatrix),"$clipping",M,B,z)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const s=this.nextStencilID++,d=this.context.gl;return new ji({func:d.NOTEQUAL,mask:255},s,255,d.KEEP,d.KEEP,d.REPLACE)}stencilModeForClipping(s){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(s);const d=this.context.gl;return new ji({func:d.EQUAL,mask:255},this._tileClippingMaskIDs[s.key],0,d.KEEP,d.KEEP,d.REPLACE)}stencilConfigForOverlap(s){const d=this.context.gl,f=s.sort((S,A)=>A.overscaledZ-S.overscaledZ),_=f[f.length-1].overscaledZ,b=f[0].overscaledZ-_+1;if(b>1){this.currentStencilSource=void 0,this.nextStencilID+b>256&&this.clearStencil();const S={};for(let A=0;A<b;A++)S[A+_]=new ji({func:d.GEQUAL,mask:255},A+this.nextStencilID,255,d.KEEP,d.KEEP,d.REPLACE);return this.nextStencilID+=b,[S,f]}return[{[_]:ji.disabled},f]}colorModeForRenderPass(){const s=this.context.gl;return this._showOverdrawInspector?new Di([s.CONSTANT_COLOR,s.ONE,s.CONSTANT_COLOR,s.ONE],new o.ao(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?Di.unblended:Di.alphaBlended}colorModeForDrapableLayerRenderPass(s){const d=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?s!=null&&this.emissiveMode!=="mrt-fallback"||this.emissiveMode==="constant"?new Di([d.ONE,d.ONE_MINUS_SRC_ALPHA,d.CONSTANT_ALPHA,d.ONE_MINUS_SRC_ALPHA],new o.ao(0,0,0,s??0),[!0,!0,!0,!0]):this.emissiveMode==="dual-source-blending"?new Di([d.ONE,d.ONE_MINUS_SRC_ALPHA,this.context.extBlendFuncExtended.SRC1_ALPHA_WEBGL,d.ONE_MINUS_SRC_ALPHA],o.ao.transparent,[!0,!0,!0,!0]):this.colorModeForRenderPass():this.colorModeForRenderPass()}depthModeForSublayer(s,d,f,_=!1){if(this.depthOcclusion)return new si(this.context.gl.GREATER,si.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!_)return si.disabled;const b=1-((1+this.currentLayer)*this.numSublayers+s)*this.depthEpsilon;return new si(f||this.context.gl.LEQUAL,d,[b,b])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){const s=this.context.gl,d=Math.ceil(this.width),f=Math.ceil(this.height),_=this.context.bindFramebuffer.get(),b=s.getParameter(s.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===d&&this.depthFBO.height===f||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),d!==0&&f!==0&&(this.depthFBO=new pd(this.context,d,f,0,"texture"),this.depthTexture=new o.T(this.context,{width:d,height:f,data:null},s.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(_),s.bindTexture(s.TEXTURE_2D,b),this.depthFBO&&(s.bindFramebuffer(s.READ_FRAMEBUFFER,null),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),s.blitFramebuffer(0,0,d,f,0,0,d,f,s.DEPTH_BUFFER_BIT,s.NEAREST),s.bindFramebuffer(s.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(this._dt===0?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce((s,d)=>s+d/this._fpsHistory.length,0))}render(s,d){const f=o.o.now();this._dt=f-this._timeStamp,this._timeStamp=f,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=s.map.repaint,this.style=s,this.options=d;const _=this.style._mergedLayers,b=!(!this.terrain||!this.terrain.enabled),S=()=>this.style._getOrder(b).filter(rt=>{const $e=_[rt];return!($e.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[$e.type]});let A=S(),E=!1,D=!1,M=null,B=0,z=!1;for(const rt of A){const $e=_[rt];$e.visibility!=="none"&&($e.type==="circle"?E=!0:$e.type==="building"?(M=$e,++B):$e.type==="symbol"&&($e.hasOcclusionOpacityProperties?D=!0:E=!0))}this.updateEmissiveMode();let V=A.map(rt=>_[rt]);const Q=this.style._mergedSourceCaches;this.imageManager=s.imageManager,this.modelManager=s.modelManager,this.symbolFadeChange=s.placement.symbolFadeChange(o.o.now()),this.imageManager.beginFrame();for(const rt in Q){const $e=Q[rt];$e.used&&($e.prepare(this.context),$e.getSource().usedInConflation&&++B)}let W=!1;for(const rt of V)rt.isHidden(this.transform.zoom)||(rt.type==="clip"&&(W=!0),this.prepareLayer(rt));const J={},ce={},_e={},xe={},fe={};for(const rt in Q){const $e=Q[rt];J[rt]=$e.getVisibleCoordinates(),ce[rt]=J[rt].slice().reverse(),_e[rt]=$e.getVisibleCoordinates(!0).reverse(),xe[rt]=$e.getShadowCasterCoordinates(),fe[rt]=$e.sortCoordinatesByDistance(J[rt])}const Fe=rt=>{const $e=this.style.getLayerSourceCache(rt);return $e&&$e.used?$e.getSource():null};if(B||W||this._clippingActiveLastFrame){const rt=[],$e=[];let dt=0;for(const ot of V)this.isSourceForClippingOrConflation(ot,Fe(ot))&&(rt.push(ot),$e.push(dt)),dt++;if(rt&&(W||rt.length>1)||this._clippingActiveLastFrame){W=!1;const ot=[];for(let Ct=0;Ct<rt.length;Ct++){const Rt=rt[Ct],Ut=$e[Ct],kt=this.style.getLayerSourceCache(Rt);if(!kt||!kt.used||!kt.getSource().usedInConflation&&Rt.type!=="clip"&&Rt.type!=="building")continue;let Mt=o.eQ,ei=o.b_.None;const Qt=[];let Wt=!0;if(Rt.type==="building")Mt=o.eS;else if(Rt.type==="clip"){Mt=Ut;for(const Kt of Rt.layout.get("clip-layer-types"))ei|=Kt==="model"?o.b_.Model:Kt==="symbol"?o.b_.Symbol:o.b_.FillExtrusion;for(const Kt of Rt.layout.get("clip-layer-scope"))Qt.push(Kt);Rt.isHidden(this.transform.zoom)?Wt=!1:W=!0}Wt&&ot.push({layer:Rt.fqid,cache:kt,order:Mt,clipMask:ei,clipScope:Qt})}this.replacementSource.setSources(ot),z=!0}}this._clippingActiveLastFrame=W,z||this.replacementSource.clear(),this.conflationActive=z,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let rt=0;rt<V.length;rt++){const $e=V[rt];if($e.visibility==="none")continue;const dt=$e.cutoffRange();if(this.longestCutoffRange=Math.max(dt,this.longestCutoffRange),dt>0){const ot=Fe($e);ot&&(this.minCutoffZoom=Math.max(ot.minzoom,this.minCutoffZoom)),$e.minzoom&&(this.minCutoffZoom=Math.max($e.minzoom,this.minCutoffZoom))}$e.is3D(b)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=rt),this._lastOcclusionLayer=rt)}const De=this.style&&this.style.fog;De?(this._fogVisible=De.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=De.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(_e),this.opaquePassCutoff=0,A=S(),V=A.map(rt=>_[rt]));const Oe=this._shadowRenderer;if(Oe){Oe.updateShadowParameters(this.transform,this.style.directionalLight);for(const rt in Q)for(const $e of J[rt]){let dt={min:0,max:0};this.terrain&&(dt=this.terrain.getMinMaxForTile($e)||dt),Oe.addShadowReceiver($e.toUnwrapped(),dt.min,dt.max)}}this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new o.eR(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new Yx(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);const Ee=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),Se=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(Ee&&!this._snow&&(this._snow=new um(this)),!Ee&&this._snow&&(this._snow.destroy(),delete this._snow),Se&&!this._rain&&(this._rain=new Yb(this)),!Se&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),M){this.buildingTileBorderManager||(this.buildingTileBorderManager=new Kx);const rt=this.style.getLayerSourceCache(M);this.buildingTileBorderManager.updateBorders(rt,M)}if(!nn.has(this.context.gl))return;this.renderPass="offscreen";for(const rt of V){const $e=s.getLayerSourceCache(rt);if(!rt.hasOffscreenPass()||rt.isHidden(this.transform.zoom))continue;const dt=$e?ce[$e.id]:void 0;(rt.type==="custom"||rt.type==="raster"||rt.type==="raster-particle"||rt.isSky()||dt&&dt.length)&&this.renderLayer(this,$e,rt,dt)}this.depthRangeFor3D=[0,1-(V.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,xe)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const qe=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),Ye=(()=>{if(d.showOverdrawInspector)return o.ao.black;const rt=this.style.fog;if(rt&&this.transform.projection.supportsFog){const $e=this.style.getLut(rt.scope);if(!qe){const dt=rt.properties.get("color-use-theme")==="none",ot=rt.properties.get("color").toNonPremultipliedRenderColor(dt?null:$e).toArray01();return new o.ao(...ot)}if(qe){const dt=rt.properties.get("space-color-use-theme")==="none",ot=rt.properties.get("space-color").toNonPremultipliedRenderColor(dt?null:$e).toArray01();return new o.ao(...ot)}}return o.ao.transparent})();if(this.context.clear({color:Ye,depth:1}),this.clearStencil(),this._showOverdrawInspector=d.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&qe&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=A.length-1;this.currentLayer>=0;this.currentLayer--){const rt=V[this.currentLayer],$e=s.getLayerSourceCache(rt);if(rt.isSky())continue;const dt=$e?(rt.is3D(b)?fe:ce)[$e.id]:void 0;this._renderTileClippingMasks(rt,$e,dt),this.renderLayer(this,$e,rt,dt)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&qe&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||o.aj(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<A.length;this.currentLayer++){const rt=V[this.currentLayer],$e=s.getLayerSourceCache(rt);rt.isSky()&&this.renderLayer(this,$e,rt,$e?ce[$e.id]:void 0)}function Qe(rt,$e){let dt;return $e&&(dt=(rt.type==="symbol"?_e:rt.is3D(b)?fe:ce)[$e.id]),dt}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<A.length;){const rt=V[this.currentLayer];if(rt.type==="raster"||rt.type==="raster-particle"){const $e=s.getLayerSourceCache(rt);this.renderLayer(this,$e,rt,Qe(rt,$e))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;const at=Oe?Oe.getGroundShadowLayerIndex():-1;let nt=!1,ft=-1;for(let rt=0;rt<A.length;++rt){const $e=V[rt];$e.isHidden(this.transform.zoom)||$e.is3D(b)&&(ft=rt)}D&&ft===-1&&(E=!0);let Nt=!1;for(;this.currentLayer<A.length;){const rt=V[this.currentLayer],$e=s.getLayerSourceCache(rt);if(rt.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(rt)){if(rt.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!Nt&&rt.is3D(b)&&!b){const dt=this.currentLayer,ot=Ct=>{for(this.currentLayer=0;this.currentLayer<V.length;this.currentLayer++){const Rt=V[this.currentLayer];if(a_[Rt.type]){const Ut=this.style.getLayerSourceCache(Rt);a_[Rt.type](this,Ut,Rt,Qe(Rt,Ut),Ct)}}};ot("initialize"),ot("reset"),this.currentLayer=dt,Nt=!0}if(E&&!nt&&this.terrain&&!this.transform.isOrthographic&&(nt=!0,this.blitDepth()),D&&ft!==-1&&this.currentLayer===ft+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(rt,$e,$e?J[$e.id]:void 0),this.renderLayer(this,$e,rt,Qe(rt,$e)),!this.terrain&&Oe&&this.currentLayer===at){{this.clearStencil(),this.resetStencilClippingMasks();const dt=this.currentLayer;for(this.currentLayer=0;this.currentLayer<V.length;this.currentLayer++){const ot=V[this.currentLayer];if(Kb[ot.type]){const Ct=this.style.getLayerSourceCache(ot);Kb[ot.type](this,Ct,ot,Qe(ot,Ct))}}this.currentLayer=dt}if(Oe.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer){const dt=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=dt;this.currentLayer++){const ot=V[this.currentLayer];if(!ot.hasLightBeamPass())continue;const Ct=s.getLayerSourceCache(ot);this.renderLayer(this,Ct,ot,Ct?ce[Ct.id]:void 0)}this.currentLayer=dt,this.renderPass="translucent"}}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const dt=this.currentLayer;this.depthOcclusion=!0;for(const ot of this.layersWithOcclusionOpacity){this.currentLayer=ot;const Ct=V[this.currentLayer],Rt=s.getLayerSourceCache(Ct),Ut=Rt?ce[Rt.id]:void 0;this.terrain||this._renderTileClippingMasks(Ct,Rt,Rt?J[Rt.id]:void 0),this.renderLayer(this,Rt,Ct,Ut)}this.depthOcclusion=!1,this.currentLayer=dt,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let rt=null;V.forEach($e=>{const dt=s.getLayerSourceCache($e);dt&&!$e.isHidden(this.transform.zoom)&&dt.getVisibleCoordinates().length&&(!rt||rt.getSource().maxzoom<dt.getSource().maxzoom)&&(rt=dt)}),rt&&this.options.showTileBoundaries&&Ub(this,rt,rt.getVisibleCoordinates(),o.ao.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&Ub(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new o.ao(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(rt){const $e=rt.transform.padding;qb(rt,rt.transform.height-($e.top||0),3,Gx),qb(rt,$e.bottom||0,3,Hx),Zx(rt,$e.left||0,3,Wx),Zx(rt,rt.transform.width-($e.right||0),3,uN);const dt=rt.transform.centerPoint;(function(ot,Ct,Rt,Ut){ag(ot,Ct-1,Rt-10,2,20,Ut),ag(ot,Ct-10,Rt-1,20,2,Ut)})(rt,dt.x,rt.transform.height-dt.y,dN)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),z||(this.conflationActive=!1)}prepareLayer(s){this.gpuTimingStart(s);const{unsupportedLayers:d}=this.transform.projection,f=!d||!d.includes(s.type);if(s_[s.type]&&(f||this.terrain&&s.type==="custom")){const _=this.style.getLayerSourceCache(s);s_[s.type](s,_,this)}this.gpuTimingEnd()}renderLayer(s,d,f,_){f.isHidden(this.transform.zoom)||(f.type==="background"||f.type==="sky"||f.type==="custom"||f.type==="model"||f.type==="raster"||f.type==="raster-particle"||_&&_.length)&&(this.id=f.id,this.gpuTimingStart(f),s.transform.projection.unsupportedLayers&&s.transform.projection.unsupportedLayers.includes(f.type)&&(!s.terrain||f.type!=="custom")||f.type==="clip"||fd[f.type](s,d,f,_,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(s){if(!this.options.gpuTiming)return;const d=this.context.extTimerQuery,f=this.context.gl;let _=this.gpuTimers[s.id];_||(_=this.gpuTimers[s.id]={calls:0,cpuTime:0,query:f.createQuery()}),_.calls++,f.beginQuery(d.TIME_ELAPSED_EXT,_.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const s=this.context.extTimerQuery,d=this.context.gl,f=d.createQuery();this.deferredRenderGpuTimeQueries.push(f),d.beginQuery(s.TIME_ELAPSED_EXT,f)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const s=this.gpuTimers;return this.gpuTimers={},s}collectDeferredRenderGpuQueries(){const s=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],s}queryGpuTimers(s){const d={};for(const f in s){const _=s[f],b=this.context.extTimerQuery,S=b.getQueryParameter(_.query,this.context.gl.QUERY_RESULT)/1e6;b.deleteQueryEXT(_.query),d[f]=S}return d}queryGpuTimeDeferredRender(s){if(!this.options.gpuTimingDeferredRender)return 0;const d=this.context.gl;let f=0;for(const _ of s)f+=d.getQueryParameter(_,d.QUERY_RESULT)/1e6,d.deleteQuery(_);return f}translatePosMatrix(s,d,f,_,b){if(!f[0]&&!f[1])return s;const S=b?_==="map"?this.transform.angle:0:_==="viewport"?-this.transform.angle:0;if(S){const D=Math.sin(S),M=Math.cos(S);f=[f[0]*M-f[1]*D,f[0]*D+f[1]*M]}const A=[b?f[0]:o.ay(d,f[0],this.transform.zoom),b?f[1]:o.ay(d,f[1],this.transform.zoom),0],E=new Float32Array(16);return o.br(E,s,A),E}saveTileTexture(s){if(s.context!==this.context)return;const d=s.size[0],f=this._tileTextures[d];f?f.push(s):this._tileTextures[d]=[s]}getTileTexture(s){const d=this._tileTextures[s];return d&&d.length>0?d.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(s,d,f){const _=f===void 0?this.terrain&&this.terrain.renderingToTexture:f,b=[];return this.style&&this.style.enable3dLights()&&(s==="globeRaster"||s==="terrainRaster"?(b.push("LIGHTING_3D_MODE"),b.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):_||b.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"&&(this._shadowMapDebug||b.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(b.push("TERRAIN"),this.linearFloatFilteringSupported()&&b.push("TERRAIN_DEM_FLOAT_FORMAT")),this.transform.projection.name==="globe"&&b.push("GLOBE"),!this._fogVisible||_||d!==void 0&&!d||b.push("FOG","FOG_DITHERING"),_&&b.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&b.push("OVERDRAW_INSPECTOR"),b}getOrCreateProgram(s,d){this.cache=this.cache||{};const f=d&&d.defines||[],_=d&&d.config,b=this.currentGlobalDefines(s,d&&d.overrideFog,d&&d.overrideRtt).concat(f),S=wb.cacheKey(yx[s],s,b,_);return this.cache[S]||(this.cache[S]=new wb(this.context,s,yx[s],_,eg[s],b)),this.cache[S]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const s=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(s.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new o.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(s,d){if(this.style.enable3dLights()){const f=this.style.directionalLight,_=this.style.ambientLight;if(f&&_){const b=((S,A,E)=>{const D=S.properties.get("direction"),M=S.properties.get("color-use-theme")==="none",B=S.properties.get("color").toNonPremultipliedRenderColor(M?null:E.getLut(S.scope)).toArray01(),z=S.properties.get("intensity"),V=A.properties.get("color-use-theme")==="none",Q=A.properties.get("color").toNonPremultipliedRenderColor(V?null:E.getLut(A.scope)).toArray01(),W=A.properties.get("intensity"),J=[D.x,D.y,D.z],ce=o.dN(Q,W),_e=o.dN(B,z);return{u_lighting_ambient_color:ce,u_lighting_directional_dir:J,u_lighting_directional_color:_e,u_ground_radiance:dh(J,_e,ce)}})(f,_,this.style);d.setLightsUniformValues(s,b)}}}uploadCommonUniforms(s,d,f,_,b){if(this.uploadCommonLightUniforms(s,d),this.terrain&&this.terrain.renderingToTexture)return;const S=this.style.fog;if(S){const A=S.getOpacity(this.transform.pitch),E=((D,M,B,z,V,Q,W,J,ce,_e,xe,fe)=>{const Fe=D.transform,De=M.properties.get("color-use-theme")==="none",Oe=M.properties.get("color").toNonPremultipliedRenderColor(De?null:D.style.getLut(M.scope)).toArray01();Oe[3]=z;const Ee=D.frameCounter/1e3%1,[Se,qe]=M.properties.get("vertical-range");return{u_fog_matrix:B?Fe.calculateFogTileMatrix(B):fe||D.identityMat,u_fog_range:M.getFovAdjustedRange(Fe._fov),u_fog_color:Oe,u_fog_horizon_blend:M.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(Se,qe),qe],u_fog_temporal_offset:Ee,u_frustum_tl:V,u_frustum_tr:Q,u_frustum_br:W,u_frustum_bl:J,u_globe_pos:ce,u_globe_radius:_e,u_viewport:xe,u_globe_transition:o.aj(Fe.zoom),u_is_globe:+(Fe.projection.name==="globe")}})(this,S,f,A,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*o.o.devicePixelRatio,this.transform.height*o.o.devicePixelRatio],_);d.setFogUniformValues(s,E)}b&&d.setCutoffUniformValues(s,b.uniformValues)}setTileLoadedFlag(s){this.tileLoaded=s}saveCanvasCopy(){const s=this.canvasCopy();s&&(this.frameCopies.push(s),this.tileLoaded=!1)}canvasCopy(){const s=this.context.gl,d=s.createTexture();return s.bindTexture(s.TEXTURE_2D,d),s.copyTexImage2D(s.TEXTURE_2D,0,s.RGBA,0,0,s.drawingBufferWidth,s.drawingBufferHeight,0),d}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const s=this.style&&this.style.fog;return!!s&&s.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const s=this._backgroundTiles,d=this._backgroundTiles={},f=this.transform.coveringTiles({tileSize:512});for(const _ of f)d[_.key]=s[_.key]||new Hl(_,512,this.transform.tileZoom,this,void 0,this.worldview);return d}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(s,d){return!(!s.is3D(!(!this.terrain||!this.terrain.enabled))||s.type!=="clip"&&s.type!=="building"&&(s.minzoom&&s.minzoom>this.transform.zoom||(this.style._clipLayerPresent||s.sourceLayer!=="building"&&s.sourceLayer!=="procedural_buildings")&&(!d||d.type!=="batched-model")))}isTileAffectedByFog(s){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let d=this._cachedTileFogOpacities[s.key];return d||(this._cachedTileFogOpacities[s.key]=d=this.style.fog.getOpacityForTile(s)),d[0]>=Ht||d[1]>=Ht}setupDepthForOcclusion(s,d,f){const _=this.context,b=_.gl,S=!!f;var A;f||(f={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),_.activeTexture.set(b.TEXTURE3),s&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(b.NEAREST,b.CLAMP_TO_EDGE),f.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],f.u_depth_range_unpack=[2/((A=this.depthRangeFor3D)[1]-A[0]),-1-2*A[0]/(A[1]-A[0])],f.u_occluder_half_size=.5*this.occlusionParams.occluderSize,f.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(b.NEAREST,b.CLAMP_TO_EDGE),_.activeTexture.set(b.TEXTURE0),S||d.setTerrainUniformValues(_,f)}updateEmissiveMode(){if(this._forceEmissiveMode)return;const s=this.style.hasDataDrivenEmissiveStrength();this.emissiveMode=s?this.context.extBlendFuncExtended?"dual-source-blending":"mrt-fallback":"constant"}}function Jb(m,s){let d=!1,f=null;const _=()=>{f=null,d&&(m(),f=setTimeout(_,s),d=!1)};return()=>(d=!0,f||_(),f)}class Ba{constructor(s){this._hashName=s&&encodeURIComponent(s),o.aY(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Jb(this._updateHashUnthrottled.bind(this),300)}addTo(s){return this._map=s,window.addEventListener("hashchange",this._onHashChange,!1),s.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const s=this._map;if(!s)return"";const d=e1(s);if(this._hashName){const f=this._hashName;let _=!1;const b=location.hash.slice(1).split("&").map(S=>{const A=S.split("=")[0];return A===f?(_=!0,`${A}=${d}`):S}).filter(S=>S);return _||b.push(`${f}=${d}`),`#${b.join("&")}`}return`#${d}`}_getCurrentHash(){const s=location.hash.replace("#","");if(this._hashName){let d;return s.split("&").map(f=>f.split("=")).forEach(f=>{f[0]===this._hashName&&(d=f)}),(d&&d[1]||"").split("/")}return s.split("/")}_onHashChange(){const s=this._map;if(!s)return!1;const d=this._getCurrentHash();if(d.length>=3&&!d.some(f=>isNaN(Number(f)))){const f=s.dragRotate.isEnabled()&&s.touchZoomRotate.isEnabled()?+(d[3]||0):s.getBearing();return s.jumpTo({center:[+d[2],+d[1]],zoom:+d[0],bearing:f,pitch:+(d[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function e1(m,s){const d=m.getCenter(),f=Math.round(100*m.getZoom())/100,_=Math.ceil((f*Math.LN2+Math.log(512/360/.5))/Math.LN10),b=Math.pow(10,_),S=Math.round(d.lng*b)/b,A=Math.round(d.lat*b)/b,E=m.getBearing(),D=m.getPitch();let M=s?`/${S}/${A}/${f}`:`${f}/${A}/${S}`;return(E||D)&&(M+="/"+Math.round(10*E)/10),D&&(M+=`/${Math.round(D)}`),M}const wu={linearity:.3,easing:o.eT(0,0,.3,1)},fN=Object.assign({deceleration:2500,maxSpeed:1400},wu),en=Object.assign({deceleration:20,maxSpeed:1400},wu),sr=Object.assign({deceleration:1e3,maxSpeed:360},wu),t1=Object.assign({deceleration:1e3,maxSpeed:90},wu);class Su{constructor(s){this._map=s,this.clear()}clear(){this._inertiaBuffer=[]}record(s){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:o.o.now(),settings:s})}_drainInertiaBuffer(){const s=this._inertiaBuffer,d=o.o.now();for(;s.length>0&&d-s[0].time>160;)s.shift()}_onMoveEnd(s){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const d={zoom:0,bearing:0,pitch:0,pan:new o.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:b}of this._inertiaBuffer)d.zoom+=b.zoomDelta||0,d.bearing+=b.bearingDelta||0,d.pitch+=b.pitchDelta||0,b.panDelta&&d.pan._add(b.panDelta),b.around&&(d.around=b.around),b.pinchAround&&(d.pinchAround=b.pinchAround);const f=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,_={};if(d.pan.mag()){const b=Dc(d.pan.mag(),f,Object.assign({},fN,s||{}));_.offset=d.pan.mult(b.amount/d.pan.mag()),_.center=this._map.transform.center,kc(_,b)}if(d.zoom){const b=Dc(d.zoom,f,en);_.zoom=this._map.transform.zoom+b.amount,kc(_,b)}if(d.bearing){const b=Dc(d.bearing,f,sr);_.bearing=this._map.transform.bearing+o.aA(b.amount,-179,179),kc(_,b)}if(d.pitch){const b=Dc(d.pitch,f,t1);_.pitch=this._map.transform.pitch+b.amount,kc(_,b)}if(_.zoom||_.bearing){const b=d.pinchAround===void 0?d.around:d.pinchAround;_.around=b?this._map.unproject(b):this._map.getCenter()}return this.clear(),_.noMoveStart=!0,_}}function kc(m,s){(!m.duration||m.duration<s.duration)&&(m.duration=s.duration,m.easing=s.easing)}function Dc(m,s,d){const{maxSpeed:f,linearity:_,deceleration:b}=d,S=o.aA(m*_/(s/1e3),-f,f),A=Math.abs(S)/(b*_);return{easing:d.easing,duration:1e3*A,amount:S*(A/2)}}class Qs extends o.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(s,d,f,_={}){const b=ae(d.getCanvasContainer(),f),S=d.unproject(b);super(s,Object.assign({point:b,lngLat:S,originalEvent:f},_)),this._defaultPrevented=!1,this.target=d}}class _h extends o.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(s,d,f){const _=s==="touchend"?f.changedTouches:f.touches,b=q(d.getCanvasContainer(),_),S=b.map(E=>d.unproject(E)),A=b.reduce((E,D,M,B)=>E.add(D.div(B.length)),new o.P(0,0));super(s,{points:b,point:A,lngLats:S,lngLat:d.unproject(A),originalEvent:f}),this._defaultPrevented=!1}}class o_ extends o.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(s,d){super("wheel",{originalEvent:d}),this._defaultPrevented=!1}}class l_{constructor(s,d){this._map=s,this._clickTolerance=d.clickTolerance}reset(){this._mousedownPos=void 0}wheel(s){return this._firePreventable(new o_(this._map,s))}mousedown(s,d){return this._mousedownPos=d,this._firePreventable(new Qs(s.type,this._map,s))}mouseup(s){this._map.fire(new Qs(s.type,this._map,s))}preclick(s){const d=new MouseEvent("preclick",s);this._map.fire(new Qs(d.type,this._map,d))}click(s,d){this._mousedownPos&&this._mousedownPos.dist(d)>=this._clickTolerance||(this.preclick(s),this._map.fire(new Qs(s.type,this._map,s)))}dblclick(s){return this._firePreventable(new Qs(s.type,this._map,s))}mouseover(s){this._map.fire(new Qs(s.type,this._map,s))}mouseout(s){this._map.fire(new Qs(s.type,this._map,s))}touchstart(s){return this._firePreventable(new _h(s.type,this._map,s))}touchmove(s){this._map.fire(new _h(s.type,this._map,s))}touchend(s){this._map.fire(new _h(s.type,this._map,s))}touchcancel(s){this._map.fire(new _h(s.type,this._map,s))}_firePreventable(s){if(this._map.fire(s),s.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class c_{constructor(s){this._map=s}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(s){this._map.fire(new Qs(s.type,this._map,s))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Qs("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(s){this._delayContextMenu?this._contextMenuEvent=s:this._map.fire(new Qs(s.type,this._map,s)),this._map.listens("contextmenu")&&s.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class pl{constructor(s,d){this._map=s,this._el=s.getCanvasContainer(),this._container=s.getContainer(),this._clickTolerance=d.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(s,d){this.isEnabled()&&s.shiftKey&&s.button===0&&(Ae(),this._startPos=this._lastPos=d,this._active=!0)}mousemoveWindow(s,d){if(!this._active)return;const f=d,_=this._startPos,b=this._lastPos;if(!_||!b||b.equals(f)||!this._box&&f.dist(_)<this._clickTolerance)return;this._lastPos=f,this._box||(this._box=he("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",s));const S=Math.min(_.x,f.x),A=Math.max(_.x,f.x),E=Math.min(_.y,f.y),D=Math.max(_.y,f.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${S}px,${E}px)`,this._box.style.width=A-S+"px",this._box.style.height=D-E+"px")})}mouseupWindow(s,d){if(!this._active)return;const f=this._startPos,_=d;if(f&&s.button===0){if(this.reset(),ne(),f.x!==_.x||f.y!==_.y)return this._map.fire(new o.z("boxzoomend",{originalEvent:s})),{cameraAnimation:b=>b.fitScreenCoordinates(f,_,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",s)}}keydown(s){this._active&&s.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",s))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),Te(),delete this._startPos,delete this._lastPos}_fireEvent(s,d){return this._map.fire(new o.z(s,{originalEvent:d}))}}function nc(m,s){const d={};for(let f=0;f<m.length;f++)d[m[f].identifier]=s[f];return d}class vh{constructor(s){this.reset(),this.numTouches=s.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(s,d,f){(this.centroid||f.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=s.timeStamp),f.length===this.numTouches&&(this.centroid=function(_){const b=new o.P(0,0);for(const S of _)b._add(S);return b.div(_.length)}(d),this.touches=nc(f,d)))}touchmove(s,d,f){if(this.aborted||!this.centroid)return;const _=nc(f,d);for(const b in this.touches){const S=_[b];(!S||S.dist(this.touches[b])>30)&&(this.aborted=!0)}}touchend(s,d,f){if((!this.centroid||s.timeStamp-this.startTime>500)&&(this.aborted=!0),f.length===0){const _=!this.aborted&&this.centroid;if(this.reset(),_)return _}}}class bh{constructor(s){this.singleTap=new vh(s),this.numTaps=s.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(s,d,f){this.singleTap.touchstart(s,d,f)}touchmove(s,d,f){this.singleTap.touchmove(s,d,f)}touchend(s,d,f){const _=this.singleTap.touchend(s,d,f);if(_){const b=s.timeStamp-this.lastTime<500,S=!this.lastTap||this.lastTap.dist(_)<30;if(b&&S||this.reset(),this.count++,this.lastTime=s.timeStamp,this.lastTap=_,this.count===this.numTaps)return this.reset(),_}}}class u_{constructor(){this._zoomIn=new bh({numTouches:1,numTaps:2}),this._zoomOut=new bh({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(s,d,f){this._zoomIn.touchstart(s,d,f),this._zoomOut.touchstart(s,d,f)}touchmove(s,d,f){this._zoomIn.touchmove(s,d,f),this._zoomOut.touchmove(s,d,f)}touchend(s,d,f){const _=this._zoomIn.touchend(s,d,f),b=this._zoomOut.touchend(s,d,f);return _?(this._active=!0,s.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:S=>S.easeTo({duration:300,zoom:S.getZoom()+1,around:S.unproject(_)},{originalEvent:s})}):b?(this._active=!0,s.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:S=>S.easeTo({duration:300,zoom:S.getZoom()-1,around:S.unproject(b)},{originalEvent:s})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const d_=0,Tu=2,h_={[d_]:1,[Tu]:2},qo={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};class dm{constructor(s){this.reset(),this._clickTolerance=s.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(s,d){return!1}_move(s,d){return{}}mousedown(s,d){if(this._lastPoint)return;const f=oe(s);this._correctButton(s,f)&&(this._lastPoint=d,this._eventButton=f)}mousemoveWindow(s,d){const f=this._lastPoint;if(f){if(s.preventDefault(),this._eventButton!=null&&function(_,b){const S=h_[b];return _.buttons===void 0||(_.buttons&S)!==S}(s,this._eventButton))this.reset();else if(this._moved||!(d.dist(f)<this._clickTolerance))return this._moved=!0,this._lastPoint=d,this._move(f,d)}}mouseupWindow(s){this._lastPoint&&oe(s)===this._eventButton&&(this._moved&&ne(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class cg extends dm{mousedown(s,d){super.mousedown(s,d),this._lastPoint&&(this._active=!0)}_correctButton(s,d){return d===0&&!s.ctrlKey}_move(s,d){return{around:d,panDelta:d.sub(s)}}}class ug extends dm{constructor(s){super(s),this._pitchRotateKey=s.pitchRotateKey?qo[s.pitchRotateKey]:void 0}_correctButton(s,d){return this._pitchRotateKey?d===0&&s[this._pitchRotateKey]:d===0&&s.ctrlKey||d===2}_move(s,d){const f=.8*(d.x-s.x);if(f)return this._active=!0,{bearingDelta:f}}contextmenu(s){this._pitchRotateKey||s.preventDefault()}}class dg extends dm{constructor(s){super(s),this._pitchRotateKey=s.pitchRotateKey?qo[s.pitchRotateKey]:void 0}_correctButton(s,d){return this._pitchRotateKey?d===0&&s[this._pitchRotateKey]:d===0&&s.ctrlKey||d===2}_move(s,d){const f=-.5*(d.y-s.y);if(f)return this._active=!0,{pitchDelta:f}}contextmenu(s){this._pitchRotateKey||s.preventDefault()}}class ys{constructor(s,d){this._map=s,this._el=s.getCanvasContainer(),this._minTouches=1,this._clickTolerance=d.clickTolerance||1,this.reset(),o.aY(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new o.P(0,0)}touchstart(s,d,f){return this._calculateTransform(s,d,f)}touchmove(s,d,f){if(this._active&&!(f.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(f.length===1&&!o.eU())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return s.cancelable&&s.preventDefault(),this._calculateTransform(s,d,f)}}touchend(s,d,f){this._calculateTransform(s,d,f),this._active&&f.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(s,d,f){f.length>0&&(this._active=!0);const _=nc(f,d),b=new o.P(0,0),S=new o.P(0,0);let A=0;for(const D in _){const M=_[D],B=this._touches[D];B&&(b._add(M),S._add(M.sub(B)),A++,_[D]=M)}if(this._touches=_,A<this._minTouches||!S.mag())return;const E=S.div(A);return this._sum._add(E),this._sum.mag()<this._clickTolerance?void 0:{around:b.div(A),panDelta:E}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=he("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}}class hm{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(s){}_move(s,d,f){return{}}touchstart(s,d,f){this._firstTwoTouches||f.length<2||(this._firstTwoTouches=[f[0].identifier,f[1].identifier],this._start([d[0],d[1]]))}touchmove(s,d,f){const _=this._firstTwoTouches;if(!_)return;s.preventDefault();const[b,S]=_,A=wh(f,d,b),E=wh(f,d,S);if(!A||!E)return;const D=this._aroundCenter?null:A.add(E).div(2);return this._move([A,E],D,s)}touchend(s,d,f){if(!this._firstTwoTouches)return;const[_,b]=this._firstTwoTouches,S=wh(f,d,_),A=wh(f,d,b);S&&A||(this._active&&ne(),this.reset())}touchcancel(){this.reset()}enable(s){this._enabled=!0,this._aroundCenter=!!s&&s.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function wh(m,s,d){for(let f=0;f<m.length;f++)if(m[f].identifier===d)return s[f]}function hg(m,s){return Math.log2(m/s)}class gd extends hm{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(s){this._startDistance=this._distance=s[0].dist(s[1])}_move(s,d){const f=this._distance;if(this._distance=s[0].dist(s[1]),this._active||!(Math.abs(hg(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:hg(this._distance,f),pinchAround:d}}}function pg(m,s){return 180*m.angleWith(s)/Math.PI}class p_ extends hm{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(s){this._startVector=this._vector=s[0].sub(s[1]),this._minDiameter=s[0].dist(s[1])}_move(s,d){const f=this._vector;if(this._vector=s[0].sub(s[1]),f&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:pg(this._vector,f),pinchAround:d}}_isBelowThreshold(s){this._minDiameter=Math.min(this._minDiameter,s.mag());const d=25/(Math.PI*this._minDiameter)*360,f=this._startVector;if(!f)return!1;const _=pg(s,f);return Math.abs(_)<d}}function pm(m){return Math.abs(m.y)>Math.abs(m.x)}class yd extends hm{constructor(s){super(),this._map=s}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(s){this._lastPoints=s,pm(s[0].sub(s[1]))&&(this._valid=!1)}_move(s,d,f){const _=this._lastPoints;if(!_)return;const b=s[0].sub(_[0]),S=s[1].sub(_[1]);return this._map._cooperativeGestures&&!o.eU()&&f.touches.length<3||(this._valid=this.gestureBeginsVertically(b,S,f.timeStamp),!this._valid)?void 0:(this._lastPoints=s,this._active=!0,{pitchDelta:(b.y+S.y)/2*-.5})}gestureBeginsVertically(s,d,f){if(this._valid!==void 0)return this._valid;const _=s.mag()>=2,b=d.mag()>=2;if(!_&&!b)return;if(!_||!b)return this._firstMove==null&&(this._firstMove=f),f-this._firstMove<100&&void 0;const S=s.y>0==d.y>0;return pm(s)&&pm(d)&&S}}const m_={panStep:100,bearingStep:15,pitchStep:10};class mm{constructor(){const s=m_;this._panStep=s.panStep,this._bearingStep=s.bearingStep,this._pitchStep=s.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(s){if(s.altKey||s.ctrlKey||s.metaKey)return;let d=0,f=0,_=0,b=0,S=0;switch(s.keyCode){case 61:case 107:case 171:case 187:d=1;break;case 189:case 109:case 173:d=-1;break;case 37:s.shiftKey?f=-1:(s.preventDefault(),b=-1);break;case 39:s.shiftKey?f=1:(s.preventDefault(),b=1);break;case 38:s.shiftKey?_=1:(s.preventDefault(),S=-1);break;case 40:s.shiftKey?_=-1:(s.preventDefault(),S=1);break;default:return}return this._rotationDisabled&&(f=0,_=0),{cameraAnimation:A=>{const E=A.getZoom();A.easeTo({duration:300,easeId:"keyboardHandler",easing:f_,zoom:d?Math.round(E)+d*(s.shiftKey?2:1):E,bearing:A.getBearing()+f*this._bearingStep,pitch:A.getPitch()+_*this._pitchStep,offset:[-b*this._panStep,-S*this._panStep],center:A.getCenter()},{originalEvent:s})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function f_(m){return m*(2-m)}const fm=4.000244140625,g_=1/450;class mg{constructor(s,d){this._map=s,this._el=s.getCanvasContainer(),this._handler=d,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=g_,o.aY(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(s){this._defaultZoomRate=s}setWheelZoomRate(s){this._wheelZoomRate=s}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(s){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!s&&s.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(s){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(s.ctrlKey||s.metaKey||this.isZooming()||o.eU()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let d=s.deltaMode===WheelEvent.DOM_DELTA_LINE?40*s.deltaY:s.deltaY;const f=o.o.now(),_=f-(this._lastWheelEventTime||0);this._lastWheelEventTime=f,d!==0&&d%fm===0?this._type="wheel":d!==0&&Math.abs(d)<4?this._type="trackpad":_>400?(this._type=null,this._lastValue=d,this._timeout=window.setTimeout(this._onTimeout,40,s)):this._type||(this._type=Math.abs(_*d)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,d+=this._lastValue)),s.shiftKey&&d&&(d/=4),this._type&&(this._lastWheelEvent=s,this._delta-=d,this._active||this._start(s)),s.preventDefault()}_onTimeout(s){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(s)}_start(s){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const d=ae(this._el,s);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:d,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const s=this._map.transform;this._type==="wheel"&&s.projection.wrap&&(s._center.lng>=180||s._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const d=()=>s._terrainEnabled()&&this._aroundCoord?s.computeZoomRelativeTo(this._aroundCoord):s.zoom;if(this._delta!==0){const D=this._type==="wheel"&&Math.abs(this._delta)>fm?this._wheelZoomRate:this._defaultZoomRate;let M=2/(1+Math.exp(-Math.abs(this._delta*D)));this._delta<0&&M!==0&&(M=1/M);const B=d(),z=Math.pow(2,B),V=typeof this._targetZoom=="number"?s.zoomScale(this._targetZoom):z;this._targetZoom=Math.min(s.maxZoom,Math.max(s.minZoom,s.scaleZoom(V*M))),this._type==="wheel"&&(this._startZoom=B,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const f=typeof this._targetZoom=="number"?this._targetZoom:d(),_=this._startZoom,b=this._easing;let S,A=!1;if(this._type==="wheel"&&_&&b){const D=Math.min((o.o.now()-this._lastWheelEventTime)/200,1),M=b(D);S=o.ak(_,f,M),D<1?this._frameId||(this._frameId=!0):A=!0}else S=f,A=!0;this._active=!0,A&&(this._active=!1,this._finishTimeout=window.setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let E=S-d();return E*this._lastDelta<0&&(E=0),{noInertia:!0,needsRenderFrame:!A,zoomDelta:E,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(s){let d=o.eV;if(this._prevEase){const f=this._prevEase,_=(o.o.now()-f.start)/f.duration,b=f.easing(_+.01)-f.easing(_),S=.27/Math.sqrt(b*b+1e-4)*.01,A=Math.sqrt(.0729-S*S);d=o.eT(S,A,.25,1)}return this._prevEase={start:o.o.now(),duration:s,easing:d},d}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=he("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}}class i1{constructor(s,d){this._clickZoom=s,this._tapZoom=d}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class r1{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(s,d){return s.preventDefault(),{cameraAnimation:f=>{f.easeTo({duration:300,zoom:f.getZoom()+(s.shiftKey?-1:1),around:f.unproject(d)},{originalEvent:s})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class n1{constructor(){this._tap=new bh({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(s,d,f){this._swipePoint||(this._tapTime&&s.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?f.length>0&&(this._swipePoint=d[0],this._swipeTouch=f[0].identifier):this._tap.touchstart(s,d,f))}touchmove(s,d,f){if(this._tapTime){if(this._swipePoint){if(f[0].identifier!==this._swipeTouch)return;const _=d[0],b=_.y-this._swipePoint.y;return this._swipePoint=_,s.preventDefault(),this._active=!0,{zoomDelta:b/128}}}else this._tap.touchmove(s,d,f)}touchend(s,d,f){this._tapTime?this._swipePoint&&f.length===0&&this.reset():this._tap.touchend(s,d,f)&&(this._tapTime=s.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class s1{constructor(s,d,f){this._el=s,this._mousePan=d,this._touchPan=f}enable(s){this._inertiaOptions=s||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class a1{constructor(s,d,f){this._pitchWithRotate=s.pitchWithRotate,this._mouseRotate=d,this._mousePitch=f}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class o1{constructor(s,d,f,_){this._el=s,this._touchZoom=d,this._touchRotate=f,this._tapDragZoom=_,this._rotationDisabled=!1,this._enabled=!0}enable(s){this._touchZoom.enable(s),this._rotationDisabled||this._touchRotate.enable(s),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const gm=m=>m.zoom||m.drag||m.pitch||m.rotate;class l1 extends o.z{}class c1{constructor(){this.constants=[1,1,.01],this.radius=0}setup(s,d){const f=o.av([],d,s);this.radius=o.ag(f[2]<0?o.eX([],f,this.constants):[f[0],f[1],0])}projectRay(s){o.eX(s,s,this.constants),o.aw(s,s),o.eY(s,s,this.constants);const d=o.c5([],s,this.radius);if(d[2]>0){const f=o.c5([],[0,0,1],o.bJ(d,[0,0,1])),_=o.c5([],o.aw([],[d[0],d[1],0]),this.radius),b=o.d8([],d,o.c5([],o.av([],o.d8([],_,f),d),2));d[0]=b[0],d[1]=b[1]}return d}}function ym(m){return m.panDelta&&m.panDelta.mag()||m.zoomDelta||m.bearingDelta||m.pitchDelta}class u1{constructor(s,d){this._map=s,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Su(s),this._bearingSnap=d.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new c1,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(d),o.aY(["handleEvent","handleWindowEvent"],this);const f=this._el;this._listeners=[[f,"touchstart",{passive:!0}],[f,"touchmove",{passive:!1}],[f,"touchend",void 0],[f,"touchcancel",void 0],[f,"mousedown",void 0],[f,"mousemove",void 0],[f,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[f,"mouseover",void 0],[f,"mouseout",void 0],[f,"dblclick",void 0],[f,"click",void 0],[f,"keydown",{capture:!1}],[f,"keyup",void 0],[f,"wheel",{passive:!1}],[f,"contextmenu",void 0],[window,"blur",void 0]];for(const[_,b,S]of this._listeners){const A=_===document?this.handleWindowEvent:this.handleEvent;_.addEventListener(b,A,S)}}destroy(){for(const[s,d,f]of this._listeners){const _=s===document?this.handleWindowEvent:this.handleEvent;s.removeEventListener(d,_,f)}}_addDefaultHandlers(s){const d=this._map,f=d.getCanvasContainer();this._add("mapEvent",new l_(d,s));const _=d.boxZoom=new pl(d,s);this._add("boxZoom",_);const b=new u_,S=new r1;d.doubleClickZoom=new i1(S,b),this._add("tapZoom",b),this._add("clickZoom",S);const A=new n1;this._add("tapDragZoom",A);const E=d.touchPitch=new yd(d);this._add("touchPitch",E);const D=new ug(s),M=new dg(s);d.dragRotate=new a1(s,D,M),this._add("mouseRotate",D,["mousePitch"]),this._add("mousePitch",M,["mouseRotate"]);const B=new cg(s),z=new ys(d,s);d.dragPan=new s1(f,B,z),this._add("mousePan",B),this._add("touchPan",z,["touchZoom","touchRotate"]);const V=new p_,Q=new gd;d.touchZoomRotate=new o1(f,Q,V,A),this._add("touchRotate",V,["touchPan","touchZoom"]),this._add("touchZoom",Q,["touchPan","touchRotate"]),this._add("blockableMapEvent",new c_(d));const W=d.scrollZoom=new mg(d,this);this._add("scrollZoom",W,["mousePan"]);const J=d.keyboard=new mm;this._add("keyboard",J);for(const ce of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])s.interactive&&s[ce]&&d[ce].enable(s[ce])}_add(s,d,f){this._handlers.push({handlerName:s,handler:d,allowed:f}),this._handlersById[s]=d}stop(s){if(!this._updatingCamera){for(const{handler:d}of this._handlers)d.reset();this._inertia.clear(),this._fireEvents({},{},s),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:s}of this._handlers)if(s.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!gm(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(s,d,f){for(const _ in s)if(_!==f&&(!d||d.indexOf(_)<0))return!0;return!1}handleWindowEvent(s){this.handleEvent(s,`${s.type}Window`)}_getMapTouches(s){const d=[];for(const f of s)this._el.contains(f.target)&&d.push(f);return d}handleEvent(s,d){this._updatingCamera=!0;const f=s.type==="renderFrame",_=f?void 0:s,b={needsRenderFrame:!1},S={},A={},E=s.touches?this._getMapTouches(s.touches):void 0,D=E?q(this._el,E):f?void 0:ae(this._el,s);for(const{handlerName:z,handler:V,allowed:Q}of this._handlers){if(!V.isEnabled())continue;let W;this._blockedByActive(A,Q,z)?V.reset():V[d||s.type]&&(W=V[d||s.type](s,D,E),this.mergeHandlerResult(b,S,W,z,_),W&&W.needsRenderFrame&&this._triggerRenderFrame()),(W||V.isActive())&&(A[z]=V)}const M={};for(const z in this._previousActiveHandlers)A[z]||(M[z]=_);this._previousActiveHandlers=A,(Object.keys(M).length||ym(b))&&(this._changes.push([b,S,M]),this._triggerRenderFrame()),(Object.keys(A).length||ym(b))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:B}=b;B&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],B(this._map))}mergeHandlerResult(s,d,f,_,b){if(!f)return;Object.assign(s,f);const S={handlerName:_,originalEvent:f.originalEvent||b};f.zoomDelta!==void 0&&(d.zoom=S),f.panDelta!==void 0&&(d.drag=S),f.pitchDelta!==void 0&&(d.pitch=S),f.bearingDelta!==void 0&&(d.rotate=S)}_applyChanges(){const s={},d={},f={};for(const[_,b,S]of this._changes)_.panDelta&&(s.panDelta=(s.panDelta||new o.P(0,0))._add(_.panDelta)),_.zoomDelta&&(s.zoomDelta=(s.zoomDelta||0)+_.zoomDelta),_.bearingDelta&&(s.bearingDelta=(s.bearingDelta||0)+_.bearingDelta),_.pitchDelta&&(s.pitchDelta=(s.pitchDelta||0)+_.pitchDelta),_.around!==void 0&&(s.around=_.around),_.aroundCoord!==void 0&&(s.aroundCoord=_.aroundCoord),_.pinchAround!==void 0&&(s.pinchAround=_.pinchAround),_.noInertia&&(s.noInertia=_.noInertia),Object.assign(d,b),Object.assign(f,S);this._updateMapTransform(s,d,f),this._changes=[]}_updateMapTransform(s,d,f){const _=this._map,b=_.transform,S=_e=>[_e.x,_e.y,_e.z];if((()=>{const _e=this._eventsInProgress.drag;return _e&&!this._handlersById[_e.handlerName].isActive()})()&&!ym(s)){const _e=b.zoom;b.cameraElevationReference="sea",this._originalZoom!=null&&b._orthographicProjectionAtLowPitch&&b.projection.name!=="globe"&&b.pitch===0?(b.cameraElevationReference="ground",b.zoom=this._originalZoom):(b.recenterOnTerrain(),b.cameraElevationReference="ground"),_e!==b.zoom&&this._map._update(!0)}if(b._isCameraConstrained&&_._stop(!0),!ym(s))return void this._fireEvents(d,f,!0);let{panDelta:A,zoomDelta:E,bearingDelta:D,pitchDelta:M,around:B,aroundCoord:z,pinchAround:V}=s;b._isCameraConstrained&&(E>0&&(E=0),b._isCameraConstrained=!1),V!==void 0&&(B=V),(E||(_e=>d[_e]&&!this._eventsInProgress[_e])("drag"))&&B&&(this._dragOrigin=S(b.pointCoordinate3D(B)),this._originalZoom=b.zoom,this._trackingEllipsoid.setup(b._camera.position,this._dragOrigin)),b.cameraElevationReference="sea",_._stop(!0),B=B||_.transform.centerPoint,D&&(b.bearing+=D),M&&(b.pitch+=M),b._updateCameraState();const Q=[0,0,0];if(A)if(b.projection.name==="mercator"){const _e=this._trackingEllipsoid.projectRay(b.screenPointToMercatorRay(B).dir),xe=this._trackingEllipsoid.projectRay(b.screenPointToMercatorRay(B.sub(A)).dir);Q[0]=xe[0]-_e[0],Q[1]=xe[1]-_e[1]}else{const _e=b.pointCoordinate(B);if(b.projection.name==="globe"){A=A.rotate(-b.angle);const xe=b._pixelsPerMercatorPixel/b.worldSize;Q[0]=-A.x*o.eW(o.a$(_e.y))*xe,Q[1]=-A.y*o.eW(b.center.lat)*xe}else{const xe=b.pointCoordinate(B.sub(A));_e&&xe&&(Q[0]=xe.x-_e.x,Q[1]=xe.y-_e.y)}}const W=b.zoom,J=[0,0,0];if(E){const _e=S(z||b.pointCoordinate3D(B)),xe={dir:o.aw([],o.av([],_e,b._camera.position))};if(xe.dir[2]<0){const fe=b.zoomDeltaToMovement(_e,E);o.c5(J,xe.dir,fe)}}const ce=o.d8(Q,Q,J);b._translateCameraConstrained(ce),E&&Math.abs(b.zoom-W)>1e-4&&b.recenterOnTerrain(),b.cameraElevationReference="ground",this._map._update(),s.noInertia||this._inertia.record(s),this._fireEvents(d,f,!0)}_fireEvents(s,d,f){const _=gm(this._eventsInProgress),b=gm(s),S={};for(const M in s){const{originalEvent:B}=s[M];this._eventsInProgress[M]||(S[`${M}start`]=B),this._eventsInProgress[M]=s[M]}!_&&b&&this._fireEvent("movestart",b.originalEvent);for(const M in S)this._fireEvent(M,S[M]);b&&this._fireEvent("move",b.originalEvent);for(const M in s){const{originalEvent:B}=s[M];this._fireEvent(M,B)}const A={};let E;for(const M in this._eventsInProgress){const{handlerName:B,originalEvent:z}=this._eventsInProgress[M];this._handlersById[B].isActive()||(delete this._eventsInProgress[M],E=d[B]||z,A[`${M}end`]=E)}for(const M in A)this._fireEvent(M,A[M]);const D=gm(this._eventsInProgress);if(f&&(_||b)&&!D){this._updatingCamera=!0;const M=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),B=z=>z!==0&&-this._bearingSnap<z&&z<this._bearingSnap;M?(B(M.bearing||this._map.getBearing())&&(M.bearing=0),this._map.easeTo(M,{originalEvent:E})):(this._map.fire(new o.z("moveend",{originalEvent:E})),B(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(s,d){this._map.fire(new o.z(s,d?{originalEvent:d}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(s=>{this._frameId=void 0,this.handleEvent(new l1("renderFrame",{timeStamp:s})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const y_="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class d1 extends o.E{constructor(s,d){super(),this._moving=!1,this._zooming=!1,this.transform=s,this._bearingSnap=d.bearingSnap,this._respectPrefersReducedMotion=d.respectPrefersReducedMotion!==!1,o.aY(["_renderFrameCallback"],this)}getCenter(){return new o.aT(this.transform.center.lng,this.transform.center.lat)}setCenter(s,d){return this.jumpTo({center:s},d)}panBy(s,d,f){return s=o.P.convert(s).mult(-1),this.panTo(this.transform.center,Object.assign({offset:s},d),f)}panTo(s,d,f){return this.easeTo(Object.assign({center:s},d),f)}getZoom(){return this.transform.zoom}setZoom(s,d){return this.jumpTo({zoom:s},d),this}zoomTo(s,d,f){return this.easeTo(Object.assign({zoom:s},d),f)}zoomIn(s,d){return this.zoomTo(this.getZoom()+1,s,d),this}zoomOut(s,d){return this.zoomTo(this.getZoom()-1,s,d),this}getBearing(){return this.transform.bearing}setBearing(s,d){return this.jumpTo({bearing:s},d),this}getPadding(){return this.transform.padding}setPadding(s,d){return this.jumpTo({padding:s},d),this}rotateTo(s,d,f){return this.easeTo(Object.assign({bearing:s},d),f)}resetNorth(s,d){return this.rotateTo(0,Object.assign({duration:1e3},s),d),this}resetNorthPitch(s,d){return this.easeTo(Object.assign({bearing:0,pitch:0,duration:1e3},s),d),this}snapToNorth(s,d){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(s,d):this}getPitch(){return this.transform.pitch}setPitch(s,d){return this.jumpTo({pitch:s},d),this}cameraForBounds(s,d){s=o.aI.convert(s);const f=d&&d.bearing||0,_=d&&d.pitch||0,b=s.getNorthWest(),S=s.getSouthEast();return this._cameraForBounds(this.transform,b,S,f,_,d)}_extendPadding(s){const d={top:0,right:0,bottom:0,left:0};return s==null?Object.assign({},d,this.transform.padding):typeof s=="number"?{top:s,bottom:s,right:s,left:s}:Object.assign({},d,s)}_extendCameraOptions(s){return(s=Object.assign({offset:[0,0],maxZoom:this.transform.maxZoom},s)).padding=this._extendPadding(s.padding),s}_minimumAABBFrustumDistance(s,d){const f=d.max[0]-d.min[0],_=d.max[1]-d.min[1];return f/_>s.aspect?f/(2*Math.tan(.5*s.fovX)*s.aspect):_/(2*Math.tan(.5*s.fovY)*s.aspect)}_cameraForBoundsOnGlobe(s,d,f,_,b,S){const A=s.clone(),E=this._extendCameraOptions(S);A.bearing=_,A.pitch=b;const D=o.aT.convert(d),M=o.aT.convert(f),B=.5*(D.lat+M.lat),z=.5*(D.lng+M.lng),V=o.eZ(B,z),Q=o.aw([],V),W=o.aw([],o.bI([],Q,[0,1,0])),J=o.bI([],W,Q),ce=[W[0],W[1],W[2],0,J[0],J[1],J[2],0,Q[0],Q[1],Q[2],0,0,0,0,1],_e=[V,o.eZ(D.lat,D.lng),o.eZ(M.lat,D.lng),o.eZ(M.lat,M.lng),o.eZ(D.lat,M.lng),o.eZ(B,D.lng),o.eZ(B,M.lng),o.eZ(D.lat,z),o.eZ(M.lat,z)];let xe=o.d9.fromPoints(_e.map(ot=>[o.bJ(W,ot),o.bJ(J,ot),o.bJ(Q,ot)]));const fe=o.af([],xe.center,ce);o.e_(fe)===0&&o.e$(fe,0,0,1),o.aw(fe,fe),o.c5(fe,fe,o.aD),A.center=o.f0(fe);const Fe=A.getWorldToCameraMatrix(),De=o.bl(new Float64Array(16),Fe);xe=o.d9.applyTransform(xe,o.aB([],Fe,ce));const Oe=this._extendAABB(xe,A,E,_);if(!Oe)return void o.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");xe=Oe,o.af(fe,fe,Fe);const Ee=.5*(xe.max[2]-xe.min[2]),Se=this._minimumAABBFrustumDistance(A,xe),qe=o.c5([],[0,0,1],Ee),Ye=o.d8(qe,fe,qe),Qe=Se+(A.pitch===0?0:o.bG(fe,Ye)),at=A.globeCenterInViewSpace,nt=o.av([],fe,[at[0],at[1],at[2]]);o.aw(nt,nt),o.c5(nt,nt,Qe);const ft=o.d8([],fe,nt);o.af(ft,ft,De);const Nt=o.eM/o.aD,rt=o.ag(ft),$e=o.cf(Math.max(rt*Nt-o.eM,Number.EPSILON),0),dt=Math.min(A.zoomFromMercatorZAdjusted($e),E.maxZoom);return dt>.5*(o.c_+o.cL)?(A.setProjection({name:"mercator"}),A.zoom=dt,this._cameraForBounds(A,d,f,_,b,S)):{center:A.center,zoom:dt,bearing:_,pitch:b}}_extendAABB(s,d,f,_){const b=.5*((f.padding.left||0)+(f.padding.right||0)),S=.5*((f.padding.top||0)+(f.padding.bottom||0)),A=S,E=b,D=b,M=S,B=d.width-(E+D),z=d.height-(A+M),V=o.av([],s.max,s.min),Q=Math.min(B/V[0],z/V[1]),W=Math.min(d.scaleZoom(d.scale*Q),f.maxZoom);if(isNaN(W))return null;const J=d.scale/d.zoomScale(W),ce=new o.d9([s.min[0]-E*J,s.min[1]-M*J,s.min[2]],[s.max[0]+D*J,s.max[1]+A*J,s.max[2]]),_e=(typeof f.offset.x=="number"&&typeof f.offset.y=="number"?new o.P(f.offset.x,f.offset.y):o.P.convert(f.offset)).rotate(-o.an(_));return ce.center[0]-=_e.x*J,ce.center[1]+=_e.y*J,ce}queryTerrainElevation(s,d){const f=this.transform.elevation;return f?(d=Object.assign({},{exaggerated:!0},d),f.getAtPoint(o.ae.fromLngLat(s),null,d.exaggerated)):null}_cameraForBounds(s,d,f,_,b,S){if(s.projection.name==="globe")return this._cameraForBoundsOnGlobe(s,d,f,_,b,S);const A=s.clone(),E=this._extendCameraOptions(S);A.bearing=_,A.pitch=b;const D=o.aT.convert(d),M=o.aT.convert(f),B=new o.aT(D.lng,M.lat),z=new o.aT(M.lng,D.lat),V=A.project(D),Q=A.project(M),W=this.queryTerrainElevation(D),J=this.queryTerrainElevation(M),ce=this.queryTerrainElevation(B),_e=this.queryTerrainElevation(z),xe=[[V.x,V.y,Math.min(W||0,J||0,ce||0,_e||0)],[Q.x,Q.y,Math.max(W||0,J||0,ce||0,_e||0)]];let fe=o.d9.fromPoints(xe);const Fe=A.getWorldToCameraMatrix(),De=o.bl(new Float64Array(16),Fe);fe=o.d9.applyTransform(fe,Fe);const Oe=this._extendAABB(fe,A,E,_);if(!Oe)return void o.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");fe=Oe;const Ee=.5*o.av([],fe.max,fe.min)[2],Se=this._minimumAABBFrustumDistance(A,fe),qe=[0,0,1,0];o.aC(qe,qe,Fe),o.f1(qe,qe);const Ye=o.c5([],qe,Se+Ee),Qe=o.d8([],fe.center,Ye);o.af(fe.center,fe.center,De),o.af(Qe,Qe,De);const at=A.unproject(new o.P(fe.center[0],fe.center[1])),nt=o.f2(A.projection,at),ft=Math.pow(2,nt),Nt=Math.min(A._zoomFromMercatorZ(Qe[2]*A.pixelsPerMeter*ft/A.worldSize),E.maxZoom);return A.mercatorFromTransition&&Nt<.5*(o.c_+o.cL)?(A.setProjection({name:"globe"}),A.zoom=Nt,this._cameraForBounds(A,d,f,_,b,S)):{center:at,zoom:Nt,bearing:_,pitch:b}}fitBounds(s,d,f){const _=this.cameraForBounds(s,d);return this._fitInternal(_,d,f)}fitScreenCoordinates(s,d,f,_,b){const S=o.P.convert(s),A=o.P.convert(d),E=new o.P(Math.min(S.x,A.x),Math.min(S.y,A.y)),D=new o.P(Math.max(S.x,A.x),Math.max(S.y,A.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(S,A))return this;const M=this.transform.pointLocation3D(E),B=this.transform.pointLocation3D(D),z=this.transform.pointLocation3D(new o.P(E.x,D.y)),V=this.transform.pointLocation3D(new o.P(D.x,E.y)),Q=[Math.min(M.lng,B.lng,z.lng,V.lng),Math.min(M.lat,B.lat,z.lat,V.lat)],W=[Math.max(M.lng,B.lng,z.lng,V.lng),Math.max(M.lat,B.lat,z.lat,V.lat)],J=_&&_.pitch?_.pitch:this.getPitch(),ce=this._cameraForBounds(this.transform,Q,W,f,J,_);return this._fitInternal(ce,_,b)}_fitInternal(s,d,f){return s?(d=Object.assign(s,d)).linear?this.easeTo(d,f):this.flyTo(d,f):this}jumpTo(s,d){this.stop();const f=s.preloadOnly?this.transform.clone():this.transform;let _=!1,b=!1,S=!1;"zoom"in s&&f.zoom!==+s.zoom&&(_=!0,f.zoom=+s.zoom),s.center!==void 0&&(f.center=o.aT.convert(s.center)),"bearing"in s&&f.bearing!==+s.bearing&&(b=!0,f.bearing=+s.bearing),"pitch"in s&&f.pitch!==+s.pitch&&(S=!0,f.pitch=+s.pitch);const A=typeof s.padding=="number"?this._extendPadding(s.padding):s.padding;if(s.padding!=null&&!f.isPaddingEqual(A))if(s.retainPadding===!1){const E=f.clone();E.padding=A,f.setLocationAtPoint(f.center,E.centerPoint)}else f.padding=A;return s.preloadOnly?(this._preloadTiles(f),this):(this.fire(new o.z("movestart",d)).fire(new o.z("move",d)),_&&this.fire(new o.z("zoomstart",d)).fire(new o.z("zoom",d)).fire(new o.z("zoomend",d)),b&&this.fire(new o.z("rotatestart",d)).fire(new o.z("rotate",d)).fire(new o.z("rotateend",d)),S&&this.fire(new o.z("pitchstart",d)).fire(new o.z("pitch",d)).fire(new o.z("pitchend",d)),this.fire(new o.z("moveend",d)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||o.w(y_),this.transform.getFreeCameraOptions()}setFreeCameraOptions(s,d){const f=this.transform;if(!f.projection.supportsFreeCamera)return o.w(y_),this;this.stop();const _=f.zoom,b=f.pitch,S=f.bearing;f.setFreeCameraOptions(s);const A=_!==f.zoom,E=b!==f.pitch,D=S!==f.bearing;return this.fire(new o.z("movestart",d)).fire(new o.z("move",d)),A&&this.fire(new o.z("zoomstart",d)).fire(new o.z("zoom",d)).fire(new o.z("zoomend",d)),D&&this.fire(new o.z("rotatestart",d)).fire(new o.z("rotate",d)).fire(new o.z("rotateend",d)),E&&this.fire(new o.z("pitchstart",d)).fire(new o.z("pitch",d)).fire(new o.z("pitchend",d)),this.fire(new o.z("moveend",d)),this}easeTo(s,d){this._stop(!1,s.easeId),((s=Object.assign({offset:[0,0],duration:500,easing:o.eV},s)).animate===!1||this._prefersReducedMotion(s))&&(s.duration=0);const f=this.transform,_=this.getZoom(),b=this.getBearing(),S=this.getPitch(),A=this.getPadding(),E="zoom"in s?+s.zoom:_,D="bearing"in s?this._normalizeBearing(s.bearing,b):b,M="pitch"in s?+s.pitch:S,B=this._extendPadding(s.padding),z=o.P.convert(s.offset);let V,Q,W;if(f.projection.name==="globe"){const qe=o.ae.fromLngLat(f.center),Ye=z.rotate(-f.angle);qe.x+=Ye.x/f.worldSize,qe.y+=Ye.y/f.worldSize;const Qe=qe.toLngLat(),at=o.aT.convert(s.center||Qe);this._normalizeCenter(at),V=f.centerPoint.add(Ye),Q=new o.P(qe.x,qe.y).mult(f.worldSize),W=new o.P(o.aF(at.lng),o.aJ(at.lat)).mult(f.worldSize).sub(Q)}else{V=f.centerPoint.add(z);const qe=f.pointLocation(V),Ye=o.aT.convert(s.center||qe);this._normalizeCenter(Ye),Q=f.project(qe),W=f.project(Ye).sub(Q)}const J=f.zoomScale(E-_);let ce,_e;s.around&&(ce=o.aT.convert(s.around),_e=f.locationPoint(ce));const xe=this._zooming||E!==_,fe=this._rotating||b!==D,Fe=this._pitching||M!==S,De=!f.isPaddingEqual(B),Oe=s.retainPadding===!1?f.clone():f,Ee=qe=>Ye=>{if(xe&&(qe.zoom=o.ak(_,E,Ye)),fe&&(qe.bearing=o.ak(b,D,Ye)),Fe&&(qe.pitch=o.ak(S,M,Ye)),De&&(Oe.interpolatePadding(A,B,Ye),V=Oe.centerPoint.add(z)),ce)qe.setLocationAtPoint(ce,_e);else{const Qe=qe.zoomScale(qe.zoom-_),at=E>_?Math.min(2,J):Math.max(.5,J),nt=Math.pow(at,1-Ye),ft=qe.unproject(Q.add(W.mult(Ye*nt)).mult(Qe));qe.setLocationAtPoint(qe.renderWorldCopies?ft.wrap():ft,V)}return s.preloadOnly||this._fireMoveEvents(d),qe};if(s.preloadOnly){const qe=this._emulate(Ee,s.duration,f);return this._preloadTiles(qe),this}const Se={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=xe,this._rotating=fe,this._pitching=Fe,this._padding=De,this._easeId=s.easeId,this._prepareEase(d,s.noMoveStart,Se),this._ease(Ee(f),qe=>{f.cameraElevationReference==="sea"&&f.recenterOnTerrain(),this._afterEase(d,qe)},s),this}_prepareEase(s,d,f={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),d||f.moving||this.fire(new o.z("movestart",s)),this._zooming&&!f.zooming&&this.fire(new o.z("zoomstart",s)),this._rotating&&!f.rotating&&this.fire(new o.z("rotatestart",s)),this._pitching&&!f.pitching&&this.fire(new o.z("pitchstart",s))}_fireMoveEvents(s){this.fire(new o.z("move",s)),this._zooming&&this.fire(new o.z("zoom",s)),this._rotating&&this.fire(new o.z("rotate",s)),this._pitching&&this.fire(new o.z("pitch",s))}_afterEase(s,d){if(this._easeId&&d&&this._easeId===d)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const f=this._zooming,_=this._rotating,b=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,f&&this.fire(new o.z("zoomend",s)),_&&this.fire(new o.z("rotateend",s)),b&&this.fire(new o.z("pitchend",s)),this.fire(new o.z("moveend",s))}flyTo(s,d){if(this._prefersReducedMotion(s)){const ot=o.aH(s,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(ot,d)}this.stop(),s=Object.assign({offset:[0,0],speed:1.2,curve:1.42,easing:o.eV},s);const f=this.transform,_=this.getZoom(),b=this.getBearing(),S=this.getPitch(),A=this.getPadding(),E="zoom"in s?o.aA(+s.zoom,f.minZoom,f.maxZoom):_,D="bearing"in s?this._normalizeBearing(s.bearing,b):b,M="pitch"in s?+s.pitch:S,B=this._extendPadding(s.padding),z=f.zoomScale(E-_),V=o.P.convert(s.offset);let Q=f.centerPoint.add(V);const W=f.pointLocation(Q),J=o.aT.convert(s.center||W);this._normalizeCenter(J);const ce=f.project(W),_e=f.project(J).sub(ce);let xe=s.curve;const fe=Math.max(f.width,f.height),Fe=fe/z,De=_e.mag();if("minZoom"in s){const ot=o.aA(Math.min(s.minZoom,_,E),f.minZoom,f.maxZoom),Ct=fe/f.zoomScale(ot-_);xe=Math.sqrt(Ct/De*2)}const Oe=xe*xe;function Ee(ot){const Ct=(Fe*Fe-fe*fe+(ot?-1:1)*Oe*Oe*De*De)/(2*(ot?Fe:fe)*Oe*De);return Math.log(Math.sqrt(Ct*Ct+1)-Ct)}function Se(ot){return(Math.exp(ot)-Math.exp(-ot))/2}function qe(ot){return(Math.exp(ot)+Math.exp(-ot))/2}const Ye=Ee(0);let Qe=function(ot){return qe(Ye)/qe(Ye+xe*ot)},at=function(ot){return fe*((qe(Ye)*(Se(Ct=Ye+xe*ot)/qe(Ct))-Se(Ye))/Oe)/De;var Ct},nt=(Ee(1)-Ye)/xe;if(Math.abs(De)<1e-6||!isFinite(nt)){if(Math.abs(fe-Fe)<1e-6)return this.easeTo(s,d);const ot=Fe<fe?-1:1;nt=Math.abs(Math.log(Fe/fe))/xe,at=function(){return 0},Qe=function(Ct){return Math.exp(ot*xe*Ct)}}s.duration="duration"in s?+s.duration:1e3*nt/("screenSpeed"in s?+s.screenSpeed/xe:+s.speed),s.maxDuration&&s.duration>s.maxDuration&&(s.duration=0);const ft=b!==D,Nt=M!==S,rt=!f.isPaddingEqual(B),$e=s.retainPadding===!1?f.clone():f,dt=ot=>Ct=>{const Rt=Ct*nt,Ut=1/Qe(Rt);ot.zoom=Ct===1?E:_+ot.scaleZoom(Ut),ft&&(ot.bearing=o.ak(b,D,Ct)),Nt&&(ot.pitch=o.ak(S,M,Ct)),rt&&($e.interpolatePadding(A,B,Ct),Q=$e.centerPoint.add(V));const kt=Ct===1?J:ot.unproject(ce.add(_e.mult(at(Rt))).mult(Ut));return ot.setLocationAtPoint(ot.renderWorldCopies?kt.wrap():kt,Q),ot._updateCameraOnTerrain(),s.preloadOnly||this._fireMoveEvents(d),ot};if(s.preloadOnly){const ot=this._emulate(dt,s.duration,f);return this._preloadTiles(ot),this}return this._zooming=!0,this._rotating=ft,this._pitching=Nt,this._padding=rt,this._prepareEase(d,!1),this._ease(dt(f),()=>this._afterEase(d),s),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(s){}_cancelRenderFrame(s){}_stop(s,d){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const f=this._onEaseEnd;this._onEaseEnd=void 0,f.call(this,d)}if(!s){const f=this.handlers;f&&f.stop(!1)}return this}_ease(s,d,f){f.animate===!1||f.duration===0?(s(1),d()):(this._easeStart=o.o.now(),this._easeOptions=f,this._onEaseFrame=s,this._onEaseEnd=d,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const s=Math.min((o.o.now()-this._easeStart)/this._easeOptions.duration,1),d=this._onEaseFrame;d&&d(this._easeOptions.easing(s)),s<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(s,d){s=o.bT(s,-180,180);const f=Math.abs(s-d);return Math.abs(s-360-d)<f&&(s-=360),Math.abs(s+360-d)<f&&(s+=360),s}_normalizeCenter(s){const d=this.transform;if(d.maxBounds||d.projection.name!=="globe"&&!d.renderWorldCopies)return;const f=s.lng-d.center.lng;s.lng+=f>180?-360:f<-180?360:0}_prefersReducedMotion(s){return this._respectPrefersReducedMotion&&o.o.prefersReducedMotion&&!(s&&s.essential)}_emulate(s,d,f){const _=Math.ceil(15*d/1e3),b=[],S=s(f.clone());for(let A=0;A<=_;A++){const E=S(A/_);b.push(E.clone())}return b}_preloadTiles(s,d){}}class h1{constructor(s={}){this.options=s,o.aY(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(s){const d=this.options&&this.options.compact,f=s._getUIString("AttributionControl.ToggleAttribution");this._map=s,this._container=he("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=he("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",f);const _=he("span","mapboxgl-ctrl-icon",this._compactButton);return _.setAttribute("aria-hidden","true"),_.setAttribute("title",f),this._innerContainer=he("div","mapboxgl-ctrl-attrib-inner",this._container),d&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),d===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let s=this._editLink;s||(s=this._editLink=this._container.querySelector(".mapbox-improve-map"));const d=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||o.e.ACCESS_TOKEN}];if(s){const f=d.reduce((_,b,S)=>(b.value&&(_+=`${b.key}=${b.value}${S<d.length-1?"&":""}`),_),"?");s.href=`${o.e.FEEDBACK_URL}/${f}#${e1(this._map,!0)}`,s.rel="noopener nofollow"}}_updateData(s){!s||(s.dataType!=="source"||s.sourceDataType!=="metadata"&&s.sourceDataType!=="visibility")&&s.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let s=[];if(this._map.style.stylesheet){const _=this._map.style.stylesheet;this.styleOwner=_.owner,this.styleId=_.id}const d=this._map.style._mergedSourceCaches;for(const _ in d){const b=d[_];if(b.used){const S=b.getSource();S.attribution&&s.indexOf(S.attribution)<0&&s.push(S.attribution)}}s.sort((_,b)=>_.length-b.length),s=s.filter((_,b)=>{for(let S=b+1;S<s.length;S++)if(s[S].indexOf(_)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?s=[...this.options.customAttribution,...s]:s.unshift(this.options.customAttribution));const f=s.map(_=>function(b){const S=new DOMParser().parseFromString(b,"text/html");return Array.from(S.body.querySelectorAll("*")).reverse().forEach(A=>{const E=A.textContent||"";if(A.tagName!=="A")return void A.replaceWith(...A.childNodes);const D=A.getAttribute("href");if(!D||!/^(https?:|mailto:)/i.test(D))return void A.replaceWith(S.createTextNode(E));const M=S.createElement("a");M.href=D,M.textContent=E,M.rel="noopener nofollow";const B=A.getAttribute("class");B&&(M.className=B),A.replaceWith(M)}),S.body.innerHTML}(_)).join(" | ");f!==this._attribHTML&&(this._attribHTML=f,s.length?(this._innerContainer.innerHTML=f,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class p1{constructor(){o.aY(["_updateLogo","_updateCompact"],this)}onAdd(s){this._map=s,this._container=he("div","mapboxgl-ctrl");const d=he("a","mapboxgl-ctrl-logo");return d.target="_blank",d.rel="noopener nofollow",d.href="https://www.mapbox.com/",d.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),d.setAttribute("rel","noopener nofollow"),this._container.appendChild(d),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(s){s&&s.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const s=this._map.style._sourceCaches;if(Object.entries(s).length===0)return!0;for(const d in s){const f=s[d].getSource();if(f.hasOwnProperty("mapbox_logo")&&!f.mapbox_logo)return!1}return!0}_updateCompact(){const s=this._container.children;if(s.length){const d=s[0];this._map.getCanvasContainer().offsetWidth<250?d.classList.add("mapboxgl-compact"):d.classList.remove("mapboxgl-compact")}}}class m1{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(s){const d=++this._id;return this._queue.push({callback:s,id:d,cancelled:!1}),d}remove(s){const d=this._currentlyRunning,f=d?this._queue.concat(d):this._queue;for(const _ of f)if(_.id===s)return void(_.cancelled=!0)}run(s=0){const d=this._currentlyRunning=this._queue;this._queue=[];for(const f of d)if(!f.cancelled&&(f.callback(s),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class dn{constructor(s){this.jumpTo(s)}getValue(s){if(s<=this._startTime)return this._start;if(s>=this._endTime)return this._end;const d=o.dD((s-this._startTime)/(this._endTime-this._startTime));return this._start*(1-d)+this._end*d}isEasing(s){return s>=this._startTime&&s<=this._endTime}jumpTo(s){this._startTime=-1/0,this._endTime=-1/0,this._start=s,this._end=s}easeTo(s,d,f){this._start=this.getValue(d),this._end=s,this._startTime=d,this._endTime=d+f}}const f1={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use  + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class g1 extends o.z{constructor(s,d,f,_){const{point:b,lngLat:S,originalEvent:A,target:E}=s;super(s.type,{point:b,lngLat:S,originalEvent:A,target:E}),this.preventDefault=()=>{s.preventDefault()},this.id=d,this.interaction=f,this.feature=_}}class gN{constructor(s){this.map=s,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(s,d){if(this.typeById.has(s))throw new Error(`Interaction id "${s}" already exists.`);const f=d.filter;let _=d.type;f&&this.filters.set(s,o.b6(f)),_==="mouseover"&&(_="mouseenter"),_==="mouseout"&&(_="mouseleave");const b=this.interactionsByType.get(_)||new Map;_==="mouseenter"||_==="mouseleave"?(this.delegatedInteractions.size===0&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(s,d)):b.size===0&&this.map.on(_,this.handleType),b.size===0&&this.interactionsByType.set(_,b),b.set(s,d),this.typeById.set(s,_)}get(s){const d=this.typeById.get(s);if(!d)return;const f=this.interactionsByType.get(d);return f?f.get(s):void 0}remove(s){const d=this.typeById.get(s);if(!d)return;this.typeById.delete(s),this.filters.delete(s);const f=this.interactionsByType.get(d);f&&(f.delete(s),d==="mouseenter"||d==="mouseleave"?(this.delegatedInteractions.delete(s),this.delegatedInteractions.size===0&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):f.size===0&&this.map.off(d,this.handleType))}queryTargets(s,d){const f=[];for(const[_,b]of d)b.target&&f.push({targetId:_,target:b.target,filter:this.filters.get(_)});return this.map.style.queryRenderedTargets(s,f,this.map.transform)}handleMove(s){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;const d=this.queryTargets(s.point,Array.from(this.delegatedInteractions).reverse());d.length&&(s.type="mouseenter",this.handleType(s,d));const f=new Map;for(const[_,{feature:b}]of this.prevHoveredFeatures)this.hoveredFeatures.has(_)||f.set(b.id,b);f.size&&(s.type="mouseleave",this.handleType(s,Array.from(f.values())))}handleOut(s){const d=Array.from(this.hoveredFeatures.values()).map(({feature:f})=>f);d.length&&(s.type="mouseleave",this.handleType(s,d)),this.hoveredFeatures.clear()}handleType(s,d){const f=s.type==="mouseenter";if(f&&!this.interactionsByType.has(s.type))return void o.w("mouseenter interaction required for mouseleave to work.");const _=Array.from(this.interactionsByType.get(s.type)).reverse(),b=!!d;d=d||this.queryTargets(s.point,_);let S=!1;const A=new Set;for(const E of d){for(const[D,M]of _){if(!M.target)continue;const B=E.variants?E.variants[D]:null;if(B){for(const z of B){if(Sl(z,E,A,D))continue;const V=new o.dx(E,z),Q=xa(z,E,D);b&&V.id!==void 0&&(V.state=this.map.getFeatureState(V));const W=f?this.prevHoveredFeatures.get(Q):null,J=new g1(s,D,M,V),ce=W?W.stop:M.handler(J);if(f&&this.hoveredFeatures.set(Q,{feature:E,stop:ce}),ce!==!1){S=!0;break}}if(S)break}}if(S)break}if(!S)for(const[E,D]of _){const{handler:M,target:B}=D;if(!B&&M(new g1(s,E,D,null))!==!1)break}}}function yN(m,s){if(Array.isArray(m)&&Array.isArray(s)){const d=new Set(m),f=new Set(s);return d.size===f.size&&m.every(_=>f.has(_))}return o.by(m,s)}const xm={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},y1={showCompass:!0,showZoom:!0,visualizePitch:!1};class x_{constructor(s,d,f=!1){this._clickTolerance=10,this.element=d,this.mouseRotate=new ug({clickTolerance:s.dragRotate._mouseRotate._clickTolerance}),this.map=s,f&&(this.mousePitch=new dg({clickTolerance:s.dragRotate._mousePitch._clickTolerance})),o.aY(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),d.addEventListener("mousedown",this.mousedown),d.addEventListener("touchstart",this.touchstart,{passive:!1}),d.addEventListener("touchmove",this.touchmove),d.addEventListener("touchend",this.touchend),d.addEventListener("touchcancel",this.reset)}down(s,d){this.mouseRotate.mousedown(s,d),this.mousePitch&&this.mousePitch.mousedown(s,d),Ae()}move(s,d){const f=this.map,_=this.mouseRotate.mousemoveWindow(s,d),b=_&&_.bearingDelta;if(b&&f.setBearing(f.getBearing()+b),this.mousePitch){const S=this.mousePitch.mousemoveWindow(s,d),A=S&&S.pitchDelta;A&&f.setPitch(f.getPitch()+A)}}off(){const s=this.element;s.removeEventListener("mousedown",this.mousedown),s.removeEventListener("touchstart",this.touchstart),s.removeEventListener("touchmove",this.touchmove),s.removeEventListener("touchend",this.touchend),s.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){Te(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(s){this.down(Object.assign({},s,{ctrlKey:!0,preventDefault:()=>s.preventDefault()}),ae(this.element,s)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(s){this.move(s,ae(this.element,s))}mouseup(s){this.mouseRotate.mouseupWindow(s),this.mousePitch&&this.mousePitch.mouseupWindow(s),this.offTemp()}touchstart(s){s.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=q(this.element,s.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>s.preventDefault()},this._startPos))}touchmove(s){s.targetTouches.length!==1?this.reset():(this._lastPos=q(this.element,s.targetTouches)[0],this.move({preventDefault:()=>s.preventDefault()},this._lastPos))}touchend(s){s.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function _m(m,s,d){if(m=new o.aT(m.lng,m.lat),s){const f=new o.aT(m.lng-360,m.lat),_=new o.aT(m.lng+360,m.lat),b=360*Math.ceil(Math.abs(m.lng-d.center.lng)/360),S=d.locationPoint3D(m).distSqr(s),A=s.x<0||s.y<0||s.x>d.width||s.y>d.height;d.locationPoint3D(f).distSqr(s)<S&&(A||Math.abs(f.lng-d.center.lng)<b)?m=f:d.locationPoint3D(_).distSqr(s)<S&&(A||Math.abs(_.lng-d.center.lng)<b)&&(m=_)}for(;Math.abs(m.lng-d.center.lng)>180;){const f=d.locationPoint3D(m);if(f.x>=0&&f.y>=0&&f.x<=d.width&&f.y<=d.height)break;m.lng>d.center.lng?m.lng-=360:m.lng+=360}return m}const Il={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},$o={rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};class es extends o.E{constructor(s,d){super(),(s instanceof HTMLElement||d)&&(s=Object.assign({element:s},d)),o.aY(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this);const{anchor:f="center",color:_="#3FB1CE",scale:b=1,draggable:S=!1,clickTolerance:A=0,rotation:E=$o.rotation,rotationAlignment:D=$o.rotationAlignment,pitchAlignment:M=$o.pitchAlignment,occludedOpacity:B=$o.occludedOpacity,altitude:z=$o.altitude}=s||{};this._anchor=f,this._color=_,this._scale=b,this._draggable=S,this._clickTolerance=A,this._rotation=E,this._rotationAlignment=D,this._pitchAlignment=M,this._occludedOpacity=B,this._altitude=z,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),s&&s.element?(this._element=s.element,this._offset=o.P.convert(s&&s.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=o.P.convert(s&&s.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",W=>{W.preventDefault()}),this._element.addEventListener("mousedown",W=>{W.preventDefault()});const V=this._element.classList;for(const W in Il)V.remove(`mapboxgl-marker-anchor-${W}`);V.add(`mapboxgl-marker-anchor-${this._anchor}`);const Q=s&&s.className?s.className.trim().split(/\s+/):[];V.add(...Q),this._popup=null}_createDefaultMarker(){const s=he("div"),d=se("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},s);if(this._altitude===0){const f=se("radialGradient",{id:"shadowGradient"},se("defs",{},d));se("stop",{offset:"10%","stop-opacity":.4},f),se("stop",{offset:"100%","stop-opacity":.05},f),se("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},d)}return se("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},d),se("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},d),se("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},d),s}addTo(s){return s===this._map||(this.remove(),this._map=s,s.getCanvasContainer().appendChild(this._element),s.on("move",this._updateMoving),s.on("moveend",this._update),s.on("remove",this._clearFadeTimer),s._addMarker(this),this.setDraggable(this._draggable),this._update(),s.on("click",this._onMapClick)),this}remove(){const s=this._map;return s&&(s.off("click",this._onMapClick),s.off("move",this._updateMoving),s.off("moveend",this._update),s.off("mousedown",this._addDragHandler),s.off("touchstart",this._addDragHandler),s.off("mouseup",this._onUp),s.off("touchend",this._onUp),s.off("mousemove",this._onMove),s.off("touchmove",this._onMove),s.off("remove",this._clearFadeTimer),s._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(s){return this._lngLat=o.aT.convert(s),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(s){return s===this._altitude||(this._defaultMarker&&(this._altitude===0&&s!==0||this._altitude!==0&&s===0)&&(this._element=this._createDefaultMarker()),this._altitude=s||$o.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(s){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),s){if(!("offset"in s.options)){const _=Math.sqrt(Math.pow(13.5,2)/2);s.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[_,-1*(38.1-13.5+_)],"bottom-right":[-_,-1*(38.1-13.5+_)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=s,s._marker=this,s._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(s){const d=s.code,f=s.charCode||s.keyCode;d!=="Space"&&d!=="Enter"&&f!==32&&f!==13||this.togglePopup()}_onMapClick(s){const d=s.originalEvent.target,f=this._element;this._popup&&(d===f||f.contains(d))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const s=this._popup;return s?(s.isOpen()?(s.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(s.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const s=this._map,d=this._pos;if(!s||!d)return!1;const f=s.unproject(d,this._altitude),_=s.getFreeCameraOptions();if(!_.position)return!1;const b=_.position.toLngLat();return b.distanceTo(f)<.9*b.distanceTo(this._lngLat)}_evaluateOpacity(){const s=this._map;if(!s)return;const d=this._pos;if(!d||d.x<0||d.x>s.transform.width||d.y<0||d.y>s.transform.height)return void this._clearFadeTimer();const f=s.unproject(d,this._altitude);let _;s._showingGlobe()&&o.f5(s.transform,this._lngLat)?_=0:(_=1-s._queryFogOpacity(f),s.transform._terrainEnabled()&&s.getTerrain()&&this._behindTerrain()&&(_*=this._occludedOpacity)),this._element.style.opacity=`${_}`,this._element.style.pointerEvents=_>0?"auto":"none",this._popup&&this._popup._setOpacity(_),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const s=this._pos;if(!s||!this._map)return;const d=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${s.x}px,${s.y}px)
            ${Il[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${d.x}px,${d.y}px)
        `}_calculateXYTransform(){const s=this._pos,d=this._map,f=this.getPitchAlignment();if(!d||!s||f!=="map")return"";if(!d._showingGlobe()){const E=d.getPitch();return E?`rotateX(${E}deg)`:""}const _=o.cX(o.f6(d.transform,this._lngLat)),b=s.sub(o.f7(d.transform)),S=Math.abs(b.x)+Math.abs(b.y);if(S===0)return"";const A=_/S;return`rotateX(${-b.y*A}deg) rotateY(${b.x*A}deg)`}_calculateZTransform(){const s=this._pos,d=this._map;if(!d||!s)return"";let f=0;const _=this.getRotationAlignment();if(_==="map")if(d._showingGlobe()){const b=d.project(new o.aT(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),S=d.project(new o.aT(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(b);f=o.cX(Math.atan2(S.y,S.x))-90}else f=-d.getBearing();else if(_==="horizon"){const b=o.ah(4,6,d.getZoom()),S=o.f7(d.transform);S.y+=b*d.transform.height;const A=s.sub(S),E=o.cX(Math.atan2(A.y,A.x));f=(E>90?E-270:E+90)*(1-b)}return f+=this._rotation,f?`rotateZ(${f}deg)`:""}_update(s){cancelAnimationFrame(this._updateFrameId);const d=this._map;d&&(d.transform.renderWorldCopies&&(this._lngLat=_m(this._lngLat,this._pos,d.transform)),this._pos=d.project(this._lngLat,this._altitude),s===!0?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),d._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(d._showingGlobe()||d.getTerrain()||d.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(s){return this._offset=o.P.convert(s),this._update(),this}addClassName(s){return this._element.classList.add(s),this}removeClassName(s){return this._element.classList.remove(s),this}toggleClassName(s){return this._element.classList.toggle(s)}_onMove(s){const d=this._map;if(!d)return;const f=this._pointerdownPos,_=this._positionDelta;if(f&&_){if(!this._isDragging){const b=this._clickTolerance||d._clickTolerance;if(s.point.dist(f)<b)return;this._isDragging=!0}this._pos=s.point.sub(_),this._lngLat=d.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new o.z("dragstart"))),this.fire(new o.z("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const s=this._map;s&&(s.off("mousemove",this._onMove),s.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new o.z("dragend")),this._state="inactive"}_addDragHandler(s){const d=this._map,f=this._pos;d&&f&&this._element.contains(s.originalEvent.target)&&(s.preventDefault(),this._positionDelta=s.point.sub(f),this._pointerdownPos=s.point,this._state="pending",d.on("mousemove",this._onMove),d.on("touchmove",this._onMove),d.once("mouseup",this._onUp),d.once("touchend",this._onUp))}setDraggable(s){this._draggable=!!s;const d=this._map;return d&&(s?(d.on("mousedown",this._addDragHandler),d.on("touchstart",this._addDragHandler)):(d.off("mousedown",this._addDragHandler),d.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(s){return this._rotation=s||$o.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(s){return this._rotationAlignment=s||$o.rotationAlignment,this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(s){return this._pitchAlignment=s||$o.pitchAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(s){return this._occludedOpacity=s||$o.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const Go={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1,showButton:!0,followUserLocation:!0},vm={maxWidth:100,unit:"metric"},fg={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},x1={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0},xN=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Sh(m=new o.P(0,0),s="bottom"){if(typeof m=="number"){const d=Math.round(Math.sqrt(.5*Math.pow(m,2)));switch(s){case"top":return new o.P(0,m);case"top-left":return new o.P(d,d);case"top-right":return new o.P(-d,d);case"bottom":return new o.P(0,-m);case"bottom-left":return new o.P(d,-d);case"bottom-right":return new o.P(-d,-d);case"left":return new o.P(m,0);case"right":return new o.P(-m,0)}return new o.P(0,0)}return m instanceof o.P||Array.isArray(m)?o.P.convert(m):o.P.convert(m[s]||[0,0])}return{version:C,supported:X.supported,setRTLTextPlugin:o.fb,getRTLTextPluginStatus:o.fa,Map:class extends d1{constructor(m){F.mark(R.create);const s=m;if((m=Object.assign({},xm,m)).minZoom!=null&&m.maxZoom!=null&&m.minZoom>m.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(m.minPitch!=null&&m.maxPitch!=null&&m.minPitch>m.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(m.minPitch!=null&&m.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(m.maxPitch!=null&&m.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(m.antialias&&o.f3(window)&&(m.antialias=!1,o.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Pf(m.minZoom,m.maxZoom,m.minPitch,m.maxPitch,m.renderWorldCopies,null,null),m),this._repaint=!!m.repaint,this._interactive=m.interactive,this._minTileCacheSize=m.minTileCacheSize,this._maxTileCacheSize=m.maxTileCacheSize,this._failIfMajorPerformanceCaveat=m.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=m.preserveDrawingBuffer,this._antialias=m.antialias,this._trackResize=m.trackResize,this._bearingSnap=m.bearingSnap,this._refreshExpiredTiles=m.refreshExpiredTiles,this._fadeDuration=m.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=m.crossSourceCollisions,this._collectResourceTiming=m.collectResourceTiming,this._language=this._parseLanguage(m.language),this._worldview=m.worldview,this._renderTaskQueue=new m1,this._domRenderTaskQueue=new m1,this._controls=[],this._markers=[],this._popups=[],this._mapId=o.b2(),this._locale=Object.assign({},f1,m.locale),this._clickTolerance=m.clickTolerance,this._cooperativeGestures=m.cooperativeGestures,this._performanceMetricsCollection=m.performanceMetricsCollection,this._tessellationStep=m.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=m.precompilePrograms,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new dn(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=m.scaleFactor,this._requestManager=new ze(m.transformRequest,m.accessToken,m.testMode),this._silenceAuthErrors=!!m.testMode,this._contextCreateOptions=m.contextCreateOptions?Object.assign({},m.contextCreateOptions):{},typeof m.container=="string"){const d=document.getElementById(m.container);if(!d)throw new Error(`Container '${m.container.toString()}' not found.`);this._container=d}else{if(!(m.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=m.container}if(this._container.childNodes.length>0&&o.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),m.maxBounds&&this.setMaxBounds(m.maxBounds),this._spriteFormat=m.spriteFormat,o.aY(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new u1(this,m),this._localFontFamily=m.localFontFamily,this._localIdeographFontFamily=m.localIdeographFontFamily,(m.style||!m.testMode)&&this.setStyle(m.style||o.e.DEFAULT_STYLE,{config:m.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),m.projection&&this.setProjection(m.projection),m.hash&&(this._hash=new Ba(typeof m.hash=="string"&&m.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){s.center==null&&s.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:m.center,zoom:m.zoom,bearing:m.bearing,pitch:m.pitch});const d=m.bounds;d&&(this.resize(),this.fitBounds(d,Object.assign({},m.fitBoundsOptions,{duration:0})))}this.resize(),m.attributionControl&&this.addControl(new h1({customAttribution:m.customAttribution})),this._logoControl=new p1,this.addControl(this._logoControl,m.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent(),this._postStyleWithAppearanceEvent()}),this.on("data",d=>{this._update(d.dataType==="style"),this.fire(new o.z(`${d.dataType}data`,d))}),this.on("dataloading",d=>{this.fire(new o.z(`${d.dataType}dataloading`,d))}),this._interactions=new gN(this)}_getMapId(){return this._mapId}addControl(m,s){if(s===void 0&&(s=m.getDefaultPosition?m.getDefaultPosition():"top-right"),!m||!m.onAdd)return this.fire(new o.y(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const d=m.onAdd(this);this._controls.push(m);const f=this._controlPositions[s];return s.indexOf("bottom")!==-1?f.insertBefore(d,f.firstChild):f.appendChild(d),this}removeControl(m){if(!m||!m.onRemove)return this.fire(new o.y(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const s=this._controls.indexOf(m);return s>-1&&this._controls.splice(s,1),m.onRemove(this),this}hasControl(m){return this._controls.indexOf(m)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(m){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const s=!this._moving;return s&&this.fire(new o.z("movestart",m)).fire(new o.z("move",m)),this.fire(new o.z("resize",m)),s&&this.fire(new o.z("moveend",m)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(m){return this.transform.setMaxBounds(o.aI.convert(m)),this._update()}setMinZoom(m){if((m=m??-2)>=-2&&m<=this.transform.maxZoom)return this.transform.minZoom=m,this._update(),this.getZoom()<m?this.setZoom(m):this.fire(new o.z("zoomstart")).fire(new o.z("zoom")).fire(new o.z("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(m){if((m=m??22)>=this.transform.minZoom)return this.transform.maxZoom=m,this._update(),this.getZoom()>m?this.setZoom(m):this.fire(new o.z("zoomstart")).fire(new o.z("zoom")).fire(new o.z("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(m){if((m=m??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(m>=0&&m<=this.transform.maxPitch)return this.transform.minPitch=m,this._update(),this.getPitch()<m?this.setPitch(m):this.fire(new o.z("pitchstart")).fire(new o.z("pitch")).fire(new o.z("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(m){if((m=m??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(m>=this.transform.minPitch)return this.transform.maxPitch=m,this._update(),this.getPitch()>m?this.setPitch(m):this.fire(new o.z("pitchstart")).fire(new o.z("pitch")).fire(new o.z("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(m){return this._scaleFactor=m,this.painter.scaleFactor=m,this.style&&this.style._setLabelPlacementStale(),this.style._updateFilteredLayers(s=>s.type==="symbol"),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(m){return this.transform.renderWorldCopies=m,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(m){return m==="auto"?navigator.language:Array.isArray(m)?m.length===0?void 0:m.map(s=>s==="auto"?navigator.language:s):m}setLanguage(m){const s=this._parseLanguage(m);if(!this.style||s===this._language)return this;this._language=s,this.style.reloadSources();for(const d of this._controls)d._setLanguage&&d._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(m){return this.style&&m!==this._worldview?(this._worldview=m,this._styleDirty=!0,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(m){return this._lazyInitEmptyStyle(),m?typeof m=="string"&&(m={name:m}):m=null,this._useExplicitProjection=!!m,this._prioritizeAndUpdateProjection(m,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;const m=this.transform,s=m.projection.name;let d;s==="globe"&&m.zoom>=o.cL?(m.setMercatorFromTransition(),d=!0):s==="mercator"&&m.zoom<o.cL&&(m.setProjection({name:"globe"}),d=!0),d&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate(),this._update(!0))}_prioritizeAndUpdateProjection(m,s){return this._updateProjection(m||s||{name:"mercator"})}_updateProjection(m){let s;const d=this.transform.mercatorFromTransition;s=m.name==="globe"&&this.transform.zoom>=o.cL?this.transform.setMercatorFromTransition():this.transform.setProjection(m),this.style.applyProjectionUpdate();const f=this.transform.getProjection().name==="mercator"&&d!==this.transform.mercatorFromTransition;return(s||f)&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(m,s){return this.transform.locationPoint3D(o.aT.convert(m),s)}unproject(m,s){return this.transform.pointLocation3D(o.P.convert(m),s)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(m,s,d){const f=_=>{let b=[];if(Array.isArray(s)){const S=s.filter(A=>this.getLayer(A));b=S.length?this.queryRenderedFeatures(_,{layers:S}):[]}else b=this.queryRenderedFeatures(_,{target:s});return b};if(m==="mouseenter"||m==="mouseover"){let _=!1;return{listener:d,targets:s,delegates:{mousemove:S=>{const A=f(S.point);A.length?_||(_=!0,d.call(this,new Qs(m,this,S.originalEvent,{features:A}))):_=!1},mouseout:()=>{_=!1}}}}if(m==="mouseleave"||m==="mouseout"){let _=!1;return{listener:d,targets:s,delegates:{mousemove:A=>{f(A.point).length?_=!0:_&&(_=!1,d.call(this,new Qs(m,this,A.originalEvent)))},mouseout:A=>{_&&(_=!1,d.call(this,new Qs(m,this,A.originalEvent)))}}}}{const _=b=>{const S=f(b.point);S.length&&(b.features=S,d.call(this,b),delete b.features)};return{listener:d,targets:s,delegates:{[m]:_}}}}on(m,s,d){if(typeof s=="function"||d===void 0)return super.on(m,s);if(typeof s=="string"&&(s=[s]),!this._areTargetsValid(s))return this;const f=this._createDelegatedListener(m,s,d);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[m]=this._delegatedListeners[m]||[],this._delegatedListeners[m].push(f);for(const _ in f.delegates)this.on(_,f.delegates[_]);return this}once(m,s,d){if(typeof s=="function"||d===void 0)return super.once(m,s);if(typeof s=="string"&&(s=[s]),!this._areTargetsValid(s))return this;const f=this._createDelegatedListener(m,s,d);for(const _ in f.delegates)this.once(_,f.delegates[_]);return this}off(m,s,d){if(typeof s=="function"||d===void 0)return super.off(m,s);if(typeof s=="string"&&(s=[s]),!this._areTargetsValid(s))return this;const f=this._delegatedListeners?this._delegatedListeners[m]:void 0;return f&&(_=>{for(let b=0;b<_.length;b++){const S=_[b];if(S.listener===d&&yN(S.targets,s)){for(const A in S.delegates)this.off(A,S.delegates[A]);return _.splice(b,1),this}}})(f),this}queryRenderedFeatures(m,s){if(!this.style)return[];if(m===void 0||m instanceof o.P||Array.isArray(m)||s!==void 0||(s=m,m=void 0),m=m||[[0,0],[this.transform.width,this.transform.height]],!s){const b=this.style.queryRenderedFeatures(m,void 0,this.transform),S=this.style.queryRenderedFeatureset(m,void 0,this.transform);return b.concat(S)}let d=!0;if(s.target&&(d=this._isTargetValid(s.target),d&&!s.layers))return this.style.queryRenderedFeatureset(m,s,this.transform);let f=!0;if(s.layers&&Array.isArray(s.layers)){for(const b of s.layers)if(!this._isValidId(b)){f=!1;break}if(f&&!s.target)return this.style.queryRenderedFeatures(m,s,this.transform)}let _=[];return f&&(_=_.concat(this.style.queryRenderedFeatures(m,s,this.transform))),d&&(_=_.concat(this.style.queryRenderedFeatureset(m,s,this.transform))),_}querySourceFeatures(m,s){return!m||typeof m=="string"&&!this._isValidId(m)?[]:this.style.querySourceFeatures(m,s)}queryRasterValue(m,s,d){return this._isValidId(m)?this.style.queryRasterValue(m,s,d):Promise.resolve(null)}isPointOnSurface(m){const{name:s}=this.transform.projection;return s!=="globe"&&s!=="mercator"&&o.w(`${s} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(o.P.convert(m))}addInteraction(m,s){return this._interactions.add(m,s),this}removeInteraction(m){return this._interactions.remove(m),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(m){return this._cooperativeGestures=m,this}setStyle(m,s){return s=Object.assign({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},s),this.style&&m&&s.diff!==!1&&s.localFontFamily===this._localFontFamily&&s.localIdeographFontFamily===this._localIdeographFontFamily&&!s.config?(this.style._diffStyle(m,(d,f)=>{if(d){const _=typeof d=="string"?d:d instanceof Error?d.message:d.error;o.w(`Unable to perform style diff: ${_}. Rebuilding the style from scratch.`),this._updateStyle(m,s)}else f&&this._update(!0)},()=>this._postStyleLoadEvent()),this):(this._localIdeographFontFamily=s.localIdeographFontFamily,this._localFontFamily=s.localFontFamily,this._updateStyle(m,s))}_getUIString(m){const s=this._locale[m];if(s==null)throw new Error(`Missing UI string '${m}'`);return s}_updateStyle(m,s){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),m){const d=Object.assign({},s);s&&s.config&&(d.initialConfig=s.config,delete d.config),this.style=new _o(this,d).load(m),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new _o(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(o.w("There is no style added to the map."),!1)}_isValidId(m){return m==null?(this.fire(new o.y(new Error("IDs can't be empty."))),!1):!o.dr(m)||(this.fire(new o.y(new Error(`IDs can't contain special symbols: "${m}".`))),!1)}_isTargetValid(m){return"featuresetId"in m?this._isValidId("importId"in m?m.importId:m.featuresetId):"layerId"in m&&this._isValidId(m.layerId)}_areTargetsValid(m){if(Array.isArray(m)){for(const s of m)if(!this._isValidId(s))return!1;return!0}return this._isTargetValid(m)}addSource(m,s){return this._isValidId(m)?(this._lazyInitEmptyStyle(),this.style.addSource(m,s),this._update(!0)):this}isSourceLoaded(m){return!!this._isValidId(m)&&!!this.style&&this.style._isSourceCacheLoaded(m)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(m,s,d){this._lazyInitEmptyStyle(),this.style.addSourceType(m,s,d)}removeSource(m){return this._isValidId(m)?(this.style.removeSource(m),this._updateTerrain(),this._update(!0)):this}getSource(m){return this._isValidId(m)?this.style.getOwnSource(m):null}addImage(m,s,{pixelRatio:d=1,sdf:f=!1,stretchX:_,stretchY:b,content:S}={}){this._lazyInitEmptyStyle();const A=o.I.from(m);if(s instanceof HTMLImageElement||ImageBitmap&&s instanceof ImageBitmap){const{width:E,height:D,data:M}=o.o.getImageData(s);this.style.addImage(A,{data:new o.q({width:E,height:D},M),pixelRatio:d,stretchX:_,stretchY:b,content:S,sdf:f,version:0,usvg:!1})}else if(s.width===void 0||s.height===void 0)this.fire(new o.y(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:E,height:D}=s,M=s;this.style.addImage(A,{data:new o.q({width:E,height:D},new Uint8Array(M.data)),pixelRatio:d,stretchX:_,stretchY:b,content:S,sdf:f,usvg:!1,version:0,userImage:M}),M.onAdd&&M.onAdd(this,m)}}updateImage(m,s){this._lazyInitEmptyStyle();const d=o.I.from(m),f=this.style.getImage(d);if(!f)return void this.fire(new o.y(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const _=s instanceof HTMLImageElement||ImageBitmap&&s instanceof ImageBitmap?o.o.getImageData(s):s,{width:b,height:S,data:A}=_;if(b===void 0||S===void 0)return void this.fire(new o.y(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(b!==(f.usvg?f.icon.usvg_tree.width:f.data.width)||S!==(f.usvg?f.icon.usvg_tree.height:f.data.height))return void this.fire(new o.y(new Error(`The width and height of the updated image (${b}, ${S})
                must be that same as the previous version of the image
                (${f.data.width}, ${f.data.height})`)));const E=!(s instanceof HTMLImageElement||ImageBitmap&&s instanceof ImageBitmap);let D=!1;f.usvg?(f.data=new o.q({width:b,height:S},new Uint8Array(A)),f.usvg=!1,f.icon=void 0,D=!0):f.data.replace(A,E),this.style.updateImage(d,f,D)}hasImage(m){return m?!!this.style&&!!this.style.getImage(o.I.from(m)):(this.fire(new o.y(new Error("Missing required image id"))),!1)}removeImage(m){this.style.removeImage(o.I.from(m))}loadImage(m,s){o.n(this._requestManager.transformRequest(m,o.R.Image),(d,f)=>{s(d,f instanceof HTMLImageElement?o.o.getImageData(f):f)})}listImages(){return this.style.listImages().map(m=>m.name)}addModel(m,s){this._lazyInitEmptyStyle(),this.style.addModel(m,s)}hasModel(m){return m?this.style.hasModel(m):(this.fire(new o.y(new Error("Missing required model id"))),!1)}removeModel(m){this.style.removeModel(m)}listModels(){return this.style.listModels()}addLayer(m,s){return this._isValidId(m.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(m,s),this._update(!0)):this}getSlot(m){const s=this.getLayer(m);return s&&s.slot||null}setSlot(m,s){return this.style.setSlot(m,s),this.style.mergeLayers(),this._update(!0)}addImport(m,s){return this.style.addImport(m,s).catch(d=>this.fire(new o.y(new Error("Failed to add import",d)))),this}updateImport(m,s){return typeof s!="string"&&s.id!==m?(this.removeImport(m),this.addImport(s)):(this.style.updateImport(m,s),this._update(!0))}removeImport(m){return this.style.removeImport(m),this}moveImport(m,s){return this.style.moveImport(m,s),this._update(!0)}moveLayer(m,s){return this._isValidId(m)?(this.style.moveLayer(m,s),this._update(!0)):this}removeLayer(m){return this._isValidId(m)?(this.style.removeLayer(m),this._update(!0)):this}getLayer(m){if(!this._isValidId(m))return null;const s=this.style.getOwnLayer(m);return s?s.type==="custom"?s.implementation:s.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(m,s,d){return this._isValidId(m)?(this.style.setLayerZoomRange(m,s,d),this._update(!0)):this}setFilter(m,s,d={}){return this._isValidId(m)?(this.style.setFilter(m,s,d),this._update(!0)):this}getFilter(m){return this._isValidId(m)?this.style.getFilter(m):null}setPaintProperty(m,s,d,f={}){return this._isValidId(m)?(this.style.setPaintProperty(m,s,d,f),this._update(!0)):this}getPaintProperty(m,s){return this._isValidId(m)?this.style.getPaintProperty(m,s):null}setLayoutProperty(m,s,d,f={}){return this._isValidId(m)?(this.style.setLayoutProperty(m,s,d,f),this._update(!0)):this}getLayoutProperty(m,s){return this._isValidId(m)?this.style.getLayoutProperty(m,s):null}setLayerProperty(m,s,d,f={}){return this._isValidId(m)?(s==="appearances"&&this._postAddingAppearancesToStyleEvent(),this.style.setLayerProperty(m,s,d,f),this._update(!0)):this}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(m){return this.style.setGlyphsUrl(m),this._update(!0)}getSchema(m){return this.style.getSchema(m)}setSchema(m,s){return this.style.setSchema(m,s),this._update(!0)}getConfig(m){return this.style.getConfig(m)}setConfig(m,s){return this.style.setConfig(m,s),this._update(!0)}getConfigProperty(m,s){return this.style.getConfigProperty(m,s)}setConfigProperty(m,s,d){return this.style.setConfigProperty(m,s,d),this._update(!0)}getFeaturesetDescriptors(m){return this.style.getFeaturesetDescriptors(m)}setLights(m){if(this._lazyInitEmptyStyle(),m&&m.length===1&&m[0].type==="flat"){const s=m[0];s.properties?this.style.setFlatLight(s.properties,s.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(m),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const m=this.style.getLights()||[];return m.length===0&&m.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),m}setLight(m,s={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:m}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(m){return this._lazyInitEmptyStyle(),!m&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(m),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(m){return this._lazyInitEmptyStyle(),this.style.setFog(m),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(m){return this._lazyInitEmptyStyle(),this.style.setSnow(m),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(m){return this._lazyInitEmptyStyle(),this.style.setRain(m),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(m){return this._lazyInitEmptyStyle(),this.style.setColorTheme(m),this._update(!0)}setImportColorTheme(m,s){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(m,s),this._update(!0)}setCamera(m){return this.style.setCamera(m),this._triggerCameraUpdate(m)}_triggerCameraUpdate(m){return this._update(this.transform.setOrthographicProjectionAtLowPitch(m["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(m){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(o.aT.convert(m),this.transform):0}setFeatureState(m,s){return m.source&&!this._isValidId(m.source)?this:(this.style.setFeatureState(m,s),this._update())}removeFeatureState(m,s){return m.source&&!this._isValidId(m.source)?this:(this.style.removeFeatureState(m,s),this._update())}getFeatureState(m){return m.source&&!this._isValidId(m.source)?null:this.style.getFeatureState(m)}_selectIndoorFloor(m){this.style.indoorManager.selectFloor(m)}_setIndoorActiveFloorsVisibility(m){this.style.indoorManager.setActiveFloorsVisibility(m)}getIndoorTileOptions(m,s){return this.style.isIndoorEnabled()?this.style.indoorManager.getIndoorTileOptions(m,s):null}_updateContainerDimensions(){if(!this._container)return;const m=this._container.getBoundingClientRect().width||400,s=this._container.getBoundingClientRect().height||300;let d,f,_,b=this._container;for(;b&&(!f||!_);){const S=window.getComputedStyle(b).transform;S&&S!=="none"&&(d=S.match(/matrix.*\((.+)\)/)[1].split(", "),d[0]&&d[0]!=="0"&&d[0]!=="1"&&(f=d[0]),d[3]&&d[3]!=="0"&&d[3]!=="1"&&(_=d[3])),b=b.parentElement}this._containerWidth=f?Math.abs(m/f):m,this._containerHeight=_?Math.abs(s/_):s}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&o.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const m=this._container;m.classList.add("mapboxgl-map"),(this._missingCSSCanary=he("div","mapboxgl-canary",m)).style.visibility="hidden",this._detectMissingCSS();const s=this._canvasContainer=he("div","mapboxgl-canvas-container",m);this._canvas=he("canvas","mapboxgl-canvas",s),this._interactive&&(s.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const d=this._controlContainer=he("div","mapboxgl-control-container",m),f=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach(_=>{f[_]=he("div",`mapboxgl-ctrl-${_}`,d)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(m,s){const d=o.o.devicePixelRatio||1;this._canvas.width=d*Math.ceil(m),this._canvas.height=d*Math.ceil(s),this._canvas.style.width=`${m}px`,this._canvas.style.height=`${s}px`}_addMarker(m){this._markers.push(m)}_removeMarker(m){const s=this._markers.indexOf(m);s!==-1&&this._markers.splice(s,1)}_addPopup(m){this._popups.push(m)}_removePopup(m){const s=this._popups.indexOf(m);s!==-1&&this._popups.splice(s,1)}_setupPainter(){const m=Object.assign({},X.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),s=this._canvas.getContext("webgl2",m);s?(Gn(s,!0),this.painter=new Qb(s,this._contextCreateOptions,this.transform,this._scaleFactor,this._worldview),this.on("data",d=>{if(d.dataType==="source"){const f=this.transform.elevation?this.transform.elevation._source():null;f&&d.sourceCacheId===f.id&&this.style&&this.style._setLabelPlacementStale(),this.painter.setTileLoadedFlag(!0)}}),o.k.testSupport(s)):this.fire(new o.y(new Error("Failed to initialize WebGL")))}_contextLost(m){m.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new o.z("webglcontextlost",{originalEvent:m}))}_contextRestored(m){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style&&(this.style.clearLayers(),this.style.imageManager.destroyAtlasTextures(),this.style.reloadModels(),this.style.clearSources()),this._update(),this.fire(new o.z("webglcontextrestored",{originalEvent:m}))}_onMapScroll(m){if(m.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(m){return this.style?(this._styleDirty=this._styleDirty||m,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(m){return this._update(),this._renderTaskQueue.add(m)}_cancelRenderFrame(m){this._renderTaskQueue.remove(m)}_requestDomTask(m){!this.loaded()||this.loaded()&&!this.isMoving()?m():this._domRenderTaskQueue.add(m)}_render(m){let s;this.fire(new o.z("renderstart")),++this._frameId;const d=this.painter.context.extTimerQuery,f=o.o.now(),_=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(s=_.createQuery(),_.beginQuery(d.TIME_ELAPSED_EXT,s)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(m),this._domRenderTaskQueue.run(m),this._removed)return;this._updateProjectionTransition();const b=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const E=this.transform.zoom,D=this.transform.pitch,M=o.o.now(),B=new o.ac(E,{now:M,fadeDuration:b,pitch:D,transition:this.style.transition,worldview:this._worldview});this.style.update(B)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let S=!1;if(this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),S=this._updateAverageElevation(f),this.style.updateSources(this.transform),this.style.updateImageProviders(),this.isMoving()||this._forceMarkerAndPopupUpdate()):S=this._updateAverageElevation(f),this.style&&(this._placementDirty=this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,b,this._crossSourceCollisions,this.painter.replacementSource)),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:b,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new o.z("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,F.mark(R.load),this.fire(new o.z("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this.style.modelManager.isLoaded()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),s){const E=o.o.now()-f;_.endQuery(d.TIME_ELAPSED_EXT),setTimeout(()=>{const D=_.getQueryParameter(s,_.QUERY_RESULT)/1e6;_.deleteQuery(s),this.fire(new o.z("gpu-timing-frame",{cpuTime:E,gpuTime:D}))},50)}if(this.listens("gpu-timing-layer")){const E=this.painter.collectGpuTimers();setTimeout(()=>{const D=this.painter.queryGpuTimers(E);this.fire(new o.z("gpu-timing-layer",{layerTimes:D}))},50)}if(this.listens("gpu-timing-deferred-render")){const E=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{const D=this.painter.queryGpuTimeDeferredRender(E);this.fire(new o.z("gpu-timing-deferred-render",{gpuTime:D}))},50)}const A=this._sourcesDirty||this._styleDirty||this._placementDirty||S;if(A||this._repaint)this.triggerRepaint();else{const E=this.idle();if(E&&(S=this._updateAverageElevation(f,!0)),S)this.triggerRepaint();else if(this._triggerFrame(!1),E&&(this.fire(new o.z("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const D=this._calculateSpeedIndex();this.fire(new o.z("speedindexcompleted",{speedIndex:D})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||A||(this._fullyLoaded=!0,F.mark(R.fullLoad),this._performanceMetricsCollection&&Bi(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(m){for(const s of this._markers)m&&!this.getRenderWorldCopies()&&(s._lngLat=s._lngLat.wrap()),s._update();for(const s of this._popups)!m||this.getRenderWorldCopies()||s._trackPointer||(s._lngLat=s._lngLat.wrap()),s._update()}_updateAverageElevation(m,s=!1){const d=_=>(this.transform.averageElevation=_,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&d(0);const f=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(f||(s||m-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(m)){const _=this.transform.averageElevation;let b=this.transform.sampleAverageElevation();this.transform.elevation!=null&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(b)?b=0:this._averageElevationLastSampledAt=m;const S=Math.abs(_-b);if(S>1){if(this._isInitialLoad||f)return this._averageElevation.jumpTo(b),d(b);this._averageElevation.easeTo(b,m,300)}else if(S>1e-4)return this._averageElevation.jumpTo(b),d(b)}return!!this._averageElevation.isEasing(m)&&d(this._averageElevation.getValue(m))}_authenticate(){$r(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,m=>{if(m&&(m.message===ie||m.status===401)){const s=this.painter.context.gl;Gn(s,!1),this._logoControl instanceof p1&&this._logoControl._updateLogo(),s&&s.clear(s.DEPTH_BUFFER_BIT|s.COLOR_BUFFER_BIT|s.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new o.y(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),yi(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_postStyleLoadEvent(){this.style.globalId&&ht(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_postStyleWithAppearanceEvent(){this.style.globalId&&this.style.hasAppearances()&&ni(this._requestManager._customAccessToken)}_postAddingAppearancesToStyleEvent(){Fi(this._requestManager._customAccessToken)}_updateTerrain(){const m=this._isDragging();this.painter.updateTerrain(this.style,m)}_calculateSpeedIndex(){const m=this.painter.canvasCopy(),s=this.painter.getCanvasCopiesAndTimestamps();s.timeStamps.push(performance.now());const d=this.painter.context.gl,f=d.createFramebuffer();function _(b){d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,b,0);const S=new Uint8Array(d.drawingBufferWidth*d.drawingBufferHeight*4);return d.readPixels(0,0,d.drawingBufferWidth,d.drawingBufferHeight,d.RGBA,d.UNSIGNED_BYTE,S),S}return d.bindFramebuffer(d.FRAMEBUFFER,f),this._canvasPixelComparison(_(m),s.canvasCopies.map(_),s.timeStamps)}_canvasPixelComparison(m,s,d){let f=d[1]-d[0];const _=m.length/4;for(let b=0;b<s.length;b++){const S=s[b];let A=0;for(let E=0;E<S.length;E+=4)S[E]===m[E]&&S[E+1]===m[E+1]&&S[E+2]===m[E+2]&&S[E+3]===m[E+3]&&(A+=1);f+=(d[b+2]-d[b+1])*(1-A/_)}return f}remove(){this._hash&&this._hash.remove();for(const s of this._controls)s.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const m=this.painter.context.gl.getExtension("WEBGL_lose_context");m&&m.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),nn.delete(this.painter.context.gl),Ki.remove(),Et.remove(),this._removed=!0,this.fire(new o.z("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(m){this._renderNextFrame=this._renderNextFrame||m,this.style&&!this._frame&&(this._frame=o.o.frame(s=>{const d=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,d&&this._render(s)}))}_preloadTiles(m){const s=this.style?this.style.getSourceCaches():[];return o.bw(s,(d,f)=>d._preloadTiles(m,f),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(m){this._trackResize&&this.resize({originalEvent:m})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(m){this._showTileBoundaries!==m&&(this._showTileBoundaries=m,this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(m){this._showParseStatus!==m&&(this._showParseStatus=m,this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(m){this._showTerrainWireframe!==m&&(this._showTerrainWireframe=m,this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(m){this._showLayers2DWireframe!==m&&(this._showLayers2DWireframe=m,this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(m){this._showLayers3DWireframe!==m&&(this._showLayers3DWireframe=m,this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(m){this._speedIndexTiming!==m&&(this._speedIndexTiming=m,this._update())}get showPadding(){return!!this._showPadding}set showPadding(m){this._showPadding!==m&&(this._showPadding=m,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(m){this._showCollisionBoxes!==m&&(this._showCollisionBoxes=m,this.style&&m?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(m){this._showOverdrawInspector!==m&&(this._showOverdrawInspector=m,this._update())}get repaint(){return!!this._repaint}set repaint(m){this._repaint!==m&&(this._repaint=m,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(m){this._vertices=m,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(m){this._showTileAABBs!==m&&(this._showTileAABBs=m,m&&this._update())}_setCacheLimits(m,s){o.f4(m,s)}get version(){return C}},NavigationControl:class{constructor(m={}){this.options=Object.assign({},y1,m),this._container=he("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",s=>s.preventDefault()),this.options.showZoom&&(o.aY(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",s=>{this._map&&this._map.zoomIn({},{originalEvent:s})}),he("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",s=>{this._map&&this._map.zoomOut({},{originalEvent:s})}),he("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(o.aY(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",s=>{const d=this._map;d&&(this.options.visualizePitch?d.resetNorthPitch({},{originalEvent:s}):d.resetNorth({},{originalEvent:s}))}),this._compassIcon=he("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const m=this._map;if(!m)return;const s=m.getZoom(),d=s===m.getMaxZoom(),f=s===m.getMinZoom();this._zoomInButton.disabled=d,this._zoomOutButton.disabled=f,this._zoomInButton.setAttribute("aria-disabled",d.toString()),this._zoomOutButton.setAttribute("aria-disabled",f.toString())}_rotateCompassArrow(){const m=this._map;if(!m)return;const s=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(m.transform.pitch*(Math.PI/180)),.5)}) rotateX(${m.transform.pitch}deg) rotateZ(${m.transform.angle*(180/Math.PI)}deg)`:`rotate(${m.transform.angle*(180/Math.PI)}deg)`;m._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=s)})}onAdd(m){return this._map=m,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),m.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&m.on("pitch",this._rotateCompassArrow),m.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new x_(m,this._compass,this.options.visualizePitch)),this._container}onRemove(){const m=this._map;m&&(this._container.remove(),this.options.showZoom&&m.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&m.off("pitch",this._rotateCompassArrow),m.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(m,s){const d=he("button",m,this._container);return d.type="button",d.addEventListener("click",s),d}_setButtonTitle(m,s){if(!this._map)return;const d=this._map._getUIString(`NavigationControl.${s}`);m.setAttribute("aria-label",d),m.firstElementChild&&m.firstElementChild.setAttribute("title",d)}},GeolocateControl:class extends o.E{constructor(m={}){super();const s=navigator.geolocation;this.options=Object.assign({geolocation:s},Go,m),o.aY(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=Jb(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(m){return this._map=m,this._container=he("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._clearRequestTimeout(),this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(m){const s=(d=!!this.options.geolocation)=>{this._supportsGeolocation=d,m(d)};this._supportsGeolocation!==void 0?m(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then(d=>s(d.state!=="denied")).catch(()=>s()):s()}_isOutOfMapMaxBounds(m){const s=this._map.getMaxBounds(),d=m.coords;return!!s&&(d.longitude<s.getWest()||d.longitude>s.getEast()||d.latitude<s.getSouth()||d.latitude>s.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(m){if(this._map){if(this._clearRequestTimeout(),this._isOutOfMapMaxBounds(m))return this._setErrorState(),this.fire(new o.z("outofmaxbounds",m)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=m,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this.options.followUserLocation?(this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active")):(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"));break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(m),this.options.followUserLocation&&(!this.options.trackUserLocation||this._watchState==="ACTIVE_LOCK")&&this._updateCamera(m),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new o.z("geolocate",Object.assign({coords:m.coords,timestamp:m.timestamp},m.toJSON?{toJSON:m.toJSON.bind(m)}:{}))),this._finish()}}_updateCamera(m){const s=new o.aT(m.coords.longitude,m.coords.latitude),d=m.coords.accuracy,f=this._map.getBearing(),_=Object.assign({bearing:f},this.options.fitBoundsOptions);this._map.fitBounds(s.toBounds(d),_,{geolocateSource:!0})}_updateMarker(m){if(m){const s=new o.aT(m.coords.longitude,m.coords.latitude);this._accuracyCircleMarker.setLngLat(s).addTo(this._map),this._userLocationDotMarker.setLngLat(s).addTo(this._map),this._accuracy=m.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const m=this._map.transform,s=o.cf(1,m._center.lat)*m.worldSize,d=Math.ceil(2*this._accuracy*s);this._circleElement.style.width=`${d}px`,this._circleElement.style.height=`${d}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(m){if(this._map){if(this._clearRequestTimeout(),this.options.trackUserLocation)if(m.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const s=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",s),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",s),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(m.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new o.z("error",{code:m.code,message:m.message,PERMISSION_DENIED:m.PERMISSION_DENIED,POSITION_UNAVAILABLE:m.POSITION_UNAVAILABLE,TIMEOUT:m.TIMEOUT})),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_startRequestTimeout(){this._clearRequestTimeout();const m=this.options.positionOptions.timeout;m&&(this._requestTimeoutId=window.setTimeout(()=>{this._onError({code:3,message:"Geolocation request timed out"})},m))}_clearRequestTimeout(){this._requestTimeoutId!==void 0&&(clearTimeout(this._requestTimeoutId),this._requestTimeoutId=void 0)}_setupUI(m){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",s=>s.preventDefault()),this._geolocateButton=he("button","mapboxgl-ctrl-geolocate",this._container),he("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",m===!1){o.w("Geolocation support is not available so the GeolocateControl will be disabled.");const s=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",s),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",s)}else{const s=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",s),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",s)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=he("div","mapboxgl-user-location"),this._dotElement.appendChild(he("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(he("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new es({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=he("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new es({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.showButton||(this._container.style.display="none"),this.options.trackUserLocation&&this._map.on("movestart",s=>{s.geolocateSource||this._watchState!=="ACTIVE_LOCK"||s.originalEvent&&s.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new o.z("trackuserlocationend")))})}}_onDeviceOrientation(m){this._userLocationDotMarker&&(m.webkitCompassHeading?this._heading=m.webkitCompassHeading:m.absolute===!0&&(this._heading=-1*m.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return o.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new o.z("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new o.z("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new o.z("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let m;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(m={maximumAge:6e5,timeout:0},this._noTimeout=!0):(m=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,m),this._startRequestTimeout(),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._startRequestTimeout(),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}setFollowUserLocation(m){return this.options.followUserLocation=m??Go.followUserLocation,this.options.trackUserLocation&&this._watchState!=="OFF"&&(this.options.followUserLocation?this._watchState!=="BACKGROUND"&&this._watchState!=="BACKGROUND_ERROR"||(this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new o.z("trackuserlocationstart"))):this._watchState!=="ACTIVE_LOCK"&&this._watchState!=="ACTIVE_ERROR"||(this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this.fire(new o.z("trackuserlocationend")))),this}_addDeviceOrientationListener(){const m=()=>{const s="ondeviceorientationabsolute"in window?"deviceorientationabsolute":"deviceorientation";window.addEventListener(s,this._onDeviceOrientation)};typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(s=>{s==="granted"&&m()}).catch(console.error):m()}_clearWatch(){this._clearRequestTimeout(),this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:h1,ScaleControl:class{constructor(m={}){this.options=Object.assign({},vm,m),o.aY(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const m=this.options.maxWidth||100,s=this._map,d=s._containerHeight/2,f=s._containerWidth/2-m/2,_=s.unproject([f,d]),b=s.unproject([f+m,d]),S=_.distanceTo(b);if(this.options.unit==="imperial"){const A=3.2808*S;A>5280?this._setScale(m,A/5280,"mile"):this._setScale(m,A,"foot")}else this.options.unit==="nautical"?this._setScale(m,S/1852,"nautical-mile"):S>=1e3?this._setScale(m,S/1e3,"kilometer"):this._setScale(m,S,"meter")}_setScale(m,s,d){this._map._requestDomTask(()=>{const f=function(b){const S=Math.pow(10,`${Math.floor(b)}`.length-1);let A=b/S;return A=A>=10?10:A>=5?5:A>=3?3:A>=2?2:A>=1?1:function(E){const D=Math.pow(10,Math.ceil(-Math.log(E)/Math.LN10));return Math.round(E*D)/D}(A),S*A}(s),_=f/s;this._container.innerHTML=d!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:d}).format(f):`${f}&nbsp;${fg[d]}`,this._container.style.width=m*_+"px"})}onAdd(m){return this._map=m,this._language=m.getLanguage(),this._container=he("div","mapboxgl-ctrl mapboxgl-ctrl-scale",m.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(m){this._language=m,this._update()}setUnit(m){this.options.unit=m,this._update()}},FullscreenControl:class{constructor(m={}){this._fullscreen=!1,m&&m.container&&(m.container instanceof HTMLElement?this._container=m.container:o.w("Full screen control 'container' must be a DOM element.")),o.aY(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(m){return this._map=m,this._container||(this._container=this._map.getContainer()),this._controlContainer=he("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",o.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const m=this._fullscreenButton=he("button","mapboxgl-ctrl-fullscreen",this._controlContainer);he("span","mapboxgl-ctrl-icon",m).setAttribute("aria-hidden","true"),m.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const m=this._getTitle();this._fullscreenButton.setAttribute("aria-label",m),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",m)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},IndoorControl:cx,Popup:class extends o.E{constructor(m){super(),this.options=Object.assign(Object.create(x1),m),this._altitude=this.options.altitude,o.aY(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(m&&m.className?m.className.trim().split(/\s+/):[])}addTo(m){return this._map&&this.remove(),this._map=m,this.options.closeOnClick&&m.on("preclick",this._onClose),this.options.closeOnMove&&m.on("move",this._onClose),m.on("remove",this.remove),this._update(),m._addPopup(this),this._focusFirstElement(),this._trackPointer?(m.on("mousemove",this._onMouseEvent),m.on("mouseup",this._onMouseEvent),m._canvasContainer.classList.add("mapboxgl-track-pointer")):m.on("move",this._update),this.fire(new o.z("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const m=this._map;return m&&(m.off("move",this._update),m.off("move",this._onClose),m.off("preclick",this._onClose),m.off("click",this._onClose),m.off("remove",this.remove),m.off("mousemove",this._onMouseEvent),m.off("mouseup",this._onMouseEvent),m.off("drag",this._onMouseEvent),m._canvasContainer&&m._canvasContainer.classList.remove("mapboxgl-track-pointer"),m._removePopup(this),this._map=void 0),this.fire(new o.z("close")),this}getLngLat(){return this._lngLat}setLngLat(m){this._lngLat=o.aT.convert(m),this._pos=null,this._trackPointer=!1,this._update();const s=this._map;return s&&(s.on("move",this._update),s.off("mousemove",this._onMouseEvent),s._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(m){return this._altitude=m,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const m=this._map;return m&&(m.off("move",this._update),m.on("mousemove",this._onMouseEvent),m.on("drag",this._onMouseEvent),m._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(m){return this.setDOMContent(document.createTextNode(m))}setHTML(m){const s=document.createDocumentFragment(),d=document.createElement("body");let f;for(d.innerHTML=m;f=d.firstChild,f;)s.appendChild(f);return this.setDOMContent(s)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(m){return this.options.maxWidth=m,this._update(),this}setDOMContent(m){let s=this._content;if(s)for(;s.hasChildNodes();)s.firstChild&&s.removeChild(s.firstChild);else s=this._content=he("div","mapboxgl-popup-content",this._container||void 0);if(s.appendChild(m),this.options.closeButton){const d=this._closeButton=he("button","mapboxgl-popup-close-button",s);d.type="button",d.setAttribute("aria-label","Close popup"),d.innerHTML='<span aria-hidden="true">&#215;</span>',d.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(m){return this._classList.add(m),this._updateClassList(),this}removeClassName(m){return this._classList.delete(m),this._updateClassList(),this}setOffset(m){return this.options.offset=m,this._update(),this}toggleClassName(m){let s;return this._classList.delete(m)?s=!1:(this._classList.add(m),s=!0),this._updateClassList(),s}_onMouseEvent(m){this._update(m.point)}_getAnchor(m){if(this.options.anchor)return this.options.anchor;const s=this._map,d=this._container,f=this._pos;if(!s||!d||!f)return"bottom";const _=d.offsetWidth,b=d.offsetHeight,S=f.x<_/2,A=f.x>s.transform.width-_/2;if(f.y+m<b)return S?"top-left":A?"top-right":"top";if(f.y>s.transform.height-b){if(S)return"bottom-left";if(A)return"bottom-right"}return S?"left":A?"right":"bottom"}_updateClassList(){const m=this._container;if(!m)return;const s=[...this._classList];s.push("mapboxgl-popup"),this._anchor&&s.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&s.push("mapboxgl-popup-track-pointer"),m.className=s.join(" ")}_update(m){const s=this._map,d=this._content;if(!s||!this._lngLat&&!this._trackPointer||!d)return;let f=this._container;if(f||(f=this._container=he("div","mapboxgl-popup",s.getContainer()),this._tip=he("div","mapboxgl-popup-tip",f),f.appendChild(d)),this.options.maxWidth&&f.style.maxWidth!==this.options.maxWidth&&(f.style.maxWidth=this.options.maxWidth),s.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=_m(this._lngLat,this._pos,s.transform)),!this._trackPointer||m){const _=this._pos=this._trackPointer&&m instanceof o.P?m:s.project(this._lngLat,this._altitude),b=Sh(this.options.offset),S=this._anchor=this._getAnchor(b.y),A=Sh(this.options.offset,S),E=_.add(A).round();s._requestDomTask(()=>{this._container&&S&&(this._container.style.transform=`${Il[S]} translate(${E.x}px,${E.y}px)`)})}if(!this._marker&&s._showingGlobe()){const _=o.f5(s.transform,this._lngLat)?0:1;this._setOpacity(_)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const m=this._container.querySelector(xN);m&&m.focus()}_onClose(){this.remove()}_setOpacity(m){this._container&&(this._container.style.opacity=`${m}`),this._content&&(this._content.style.pointerEvents=m?"auto":"none")}},Marker:es,Style:_o,LngLat:o.aT,LngLatBounds:o.aI,Point:o.P,MercatorCoordinate:o.ae,FreeCameraOptions:sb,Evented:o.E,config:o.e,prewarm:o.f9,clearPrewarmedResources:o.f8,get accessToken(){return o.e.ACCESS_TOKEN},set accessToken(m){o.e.ACCESS_TOKEN=m},get baseApiUrl(){return o.e.API_URL},set baseApiUrl(m){o.e.API_URL=m},get workerCount(){return o.fi.workerCount},set workerCount(m){o.fi.workerCount=m},get maxParallelImageRequests(){return o.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(m){o.e.MAX_PARALLEL_IMAGE_REQUESTS=m},clearStorage(m){o.fh(m)},get workerUrl(){return o.fg.workerUrl},set workerUrl(m){o.fg.workerUrl=m},get workerClass(){return o.fg.workerClass},set workerClass(m){o.fg.workerClass=m},get workerParams(){return o.fg.workerParams},set workerParams(m){o.fg.workerParams=m},get dracoUrl(){return o.ff()},set dracoUrl(m){o.fe(m)},get meshoptUrl(){return o.fd()},set meshoptUrl(m){o.fc(m)},setNow:o.o.setNow,restoreNow:o.o.restoreNow}});var w=h;return w})})(yU);var mse=yU.exports;const T3=d5(mse),_U={CANVAS:"mapboxgl-canvas",CONTROL_BASE:"mapboxgl-ctrl",CONTROL_PREFIX:"mapboxgl-ctrl-",CONTROL_BUTTON:"mapbox-gl-draw_ctrl-draw-btn",CONTROL_BUTTON_LINE:"mapbox-gl-draw_line",CONTROL_BUTTON_POLYGON:"mapbox-gl-draw_polygon",CONTROL_BUTTON_POINT:"mapbox-gl-draw_point",CONTROL_BUTTON_TRASH:"mapbox-gl-draw_trash",CONTROL_BUTTON_COMBINE_FEATURES:"mapbox-gl-draw_combine",CONTROL_BUTTON_UNCOMBINE_FEATURES:"mapbox-gl-draw_uncombine",CONTROL_GROUP:"mapboxgl-ctrl-group",ATTRIBUTION:"mapboxgl-ctrl-attrib",ACTIVE_BUTTON:"active",BOX_SELECT:"mapbox-gl-draw_boxselect"},fse={HOT:"mapbox-gl-draw-hot",COLD:"mapbox-gl-draw-cold"},ka={ADD:"add",MOVE:"move",DRAG:"drag",POINTER:"pointer",NONE:"none"},OT={POLYGON:"polygon",LINE:"line_string",POINT:"point"},Tn={FEATURE:"Feature",POLYGON:"Polygon",LINE_STRING:"LineString",POINT:"Point",FEATURE_COLLECTION:"FeatureCollection",MULTI_PREFIX:"Multi",MULTI_POINT:"MultiPoint",MULTI_LINE_STRING:"MultiLineString",MULTI_POLYGON:"MultiPolygon"},ya={DRAW_LINE_STRING:"draw_line_string",DRAW_POLYGON:"draw_polygon",DRAW_POINT:"draw_point",SIMPLE_SELECT:"simple_select",DIRECT_SELECT:"direct_select"},Lp={CREATE:"draw.create",DELETE:"draw.delete",UPDATE:"draw.update",SELECTION_CHANGE:"draw.selectionchange",MODE_CHANGE:"draw.modechange",ACTIONABLE:"draw.actionable",RENDER:"draw.render",COMBINE_FEATURES:"draw.combine",UNCOMBINE_FEATURES:"draw.uncombine"},zj={MOVE:"move",CHANGE_PROPERTIES:"change_properties",CHANGE_COORDINATES:"change_coordinates"},Do={FEATURE:"feature",MIDPOINT:"midpoint",VERTEX:"vertex"},po={ACTIVE:"true",INACTIVE:"false"},gse=["scrollZoom","boxZoom","dragRotate","dragPan","keyboard","doubleClickZoom","touchZoomRotate"],yse=-90,yI=-85,xse=90,xI=85,_se=-270,vse=270,bse=Object.freeze(Object.defineProperty({__proto__:null,LAT_MAX:xse,LAT_MIN:yse,LAT_RENDERED_MAX:xI,LAT_RENDERED_MIN:yI,LNG_MAX:vse,LNG_MIN:_se,activeStates:po,classes:_U,cursors:ka,events:Lp,geojsonTypes:Tn,interactions:gse,meta:Do,modes:ya,sources:fse,types:OT,updateActions:zj},Symbol.toStringTag,{value:"Module"}));function Bj(t){return function(e){const r=e.featureTarget;return!r||!r.properties?!1:r.properties.meta===t}}function wse(t){return!t.originalEvent||!t.originalEvent.shiftKey?!1:t.originalEvent.button===0}function nx(t){return!t.featureTarget||!t.featureTarget.properties?!1:t.featureTarget.properties.active===po.ACTIVE&&t.featureTarget.properties.meta===Do.FEATURE}function vU(t){return!t.featureTarget||!t.featureTarget.properties?!1:t.featureTarget.properties.active===po.INACTIVE&&t.featureTarget.properties.meta===Do.FEATURE}function Vj(t){return t.featureTarget===void 0}function bU(t){return!t.featureTarget||!t.featureTarget.properties?!1:t.featureTarget.properties.meta===Do.FEATURE}function LT(t){const e=t.featureTarget;return!e||!e.properties?!1:e.properties.meta===Do.VERTEX}function _I(t){return t.originalEvent?t.originalEvent.shiftKey===!0:!1}function Uj(t){return t.key==="Escape"||t.keyCode===27}function qj(t){return t.key==="Enter"||t.keyCode===13}function sx(t){if(this._items={},this._nums={},this._length=t?t.length:0,!!t)for(let e=0,r=t.length;e<r;e++)this.add(t[e]),t[e]!==void 0&&(typeof t[e]=="string"?this._items[t[e]]=e:this._nums[t[e]]=e)}sx.prototype.add=function(t){return this.has(t)?this:(this._length++,typeof t=="string"?this._items[t]=this._length:this._nums[t]=this._length,this)};sx.prototype.delete=function(t){return this.has(t)===!1?this:(this._length--,delete this._items[t],delete this._nums[t],this)};sx.prototype.has=function(t){return typeof t!="string"&&typeof t!="number"?!1:this._items[t]!==void 0||this._nums[t]!==void 0};sx.prototype.values=function(){const t=[];return Object.keys(this._items).forEach(e=>{t.push({k:e,v:this._items[e]})}),Object.keys(this._nums).forEach(e=>{t.push({k:JSON.parse(e),v:this._nums[e]})}),t.sort((e,r)=>e.v-r.v).map(e=>e.k)};sx.prototype.clear=function(){return this._length=0,this._items={},this._nums={},this};Do.FEATURE,Do.MIDPOINT,Do.VERTEX;let Sse=(t,e=21)=>(r=e)=>{let c="",h=r|0;for(;h--;)c+=t[Math.random()*t.length|0];return c};const Tse=Sse("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",32);function wU(){return Tse()}const sl=function(t,e){this.ctx=t,this.properties=e.properties||{},this.coordinates=e.geometry.coordinates,this.id=e.id||wU(),this.type=e.geometry.type};sl.prototype.changed=function(){this.ctx.store.featureChanged(this.id)};sl.prototype.incomingCoords=function(t){this.setCoordinates(t)};sl.prototype.setCoordinates=function(t){this.coordinates=t,this.changed()};sl.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.coordinates))};sl.prototype.setProperty=function(t,e){this.properties[t]=e};sl.prototype.toGeoJSON=function(){return JSON.parse(JSON.stringify({id:this.id,type:Tn.FEATURE,properties:this.properties,geometry:{coordinates:this.getCoordinates(),type:this.type}}))};sl.prototype.internal=function(t){const e={id:this.id,meta:Do.FEATURE,"meta:type":this.type,active:po.INACTIVE,mode:t};if(this.ctx.options.userProperties)for(const r in this.properties)e[`user_${r}`]=this.properties[r];return{type:Tn.FEATURE,properties:e,geometry:{coordinates:this.getCoordinates(),type:this.type}}};const rb=function(t,e){sl.call(this,t,e)};rb.prototype=Object.create(sl.prototype);rb.prototype.isValid=function(){return typeof this.coordinates[0]=="number"&&typeof this.coordinates[1]=="number"};rb.prototype.updateCoordinate=function(t,e,r){arguments.length===3?this.coordinates=[e,r]:this.coordinates=[t,e],this.changed()};rb.prototype.getCoordinate=function(){return this.getCoordinates()};const wf=function(t,e){sl.call(this,t,e)};wf.prototype=Object.create(sl.prototype);wf.prototype.isValid=function(){return this.coordinates.length>1};wf.prototype.addCoordinate=function(t,e,r){this.changed();const c=parseInt(t,10);this.coordinates.splice(c,0,[e,r])};wf.prototype.getCoordinate=function(t){const e=parseInt(t,10);return JSON.parse(JSON.stringify(this.coordinates[e]))};wf.prototype.removeCoordinate=function(t){this.changed(),this.coordinates.splice(parseInt(t,10),1)};wf.prototype.updateCoordinate=function(t,e,r){const c=parseInt(t,10);this.coordinates[c]=[e,r],this.changed()};const ed=function(t,e){sl.call(this,t,e),this.coordinates=this.coordinates.map(r=>r.slice(0,-1))};ed.prototype=Object.create(sl.prototype);ed.prototype.isValid=function(){return this.coordinates.length===0?!1:this.coordinates.every(t=>t.length>2)};ed.prototype.incomingCoords=function(t){this.coordinates=t.map(e=>e.slice(0,-1)),this.changed()};ed.prototype.setCoordinates=function(t){this.coordinates=t,this.changed()};ed.prototype.addCoordinate=function(t,e,r){this.changed();const c=t.split(".").map(x=>parseInt(x,10));this.coordinates[c[0]].splice(c[1],0,[e,r])};ed.prototype.removeCoordinate=function(t){this.changed();const e=t.split(".").map(c=>parseInt(c,10)),r=this.coordinates[e[0]];r&&(r.splice(e[1],1),r.length<3&&this.coordinates.splice(e[0],1))};ed.prototype.getCoordinate=function(t){const e=t.split(".").map(c=>parseInt(c,10)),r=this.coordinates[e[0]];return JSON.parse(JSON.stringify(r[e[1]]))};ed.prototype.getCoordinates=function(){return this.coordinates.map(t=>t.concat([t[0]]))};ed.prototype.updateCoordinate=function(t,e,r){this.changed();const c=t.split("."),h=parseInt(c[0],10),x=parseInt(c[1],10);this.coordinates[h]===void 0&&(this.coordinates[h]=[]),this.coordinates[h][x]=[e,r]};const Nse={MultiPoint:rb,MultiLineString:wf,MultiPolygon:ed},FT=(t,e,r,c,h)=>{const x=r.split("."),w=parseInt(x[0],10),o=x[1]?x.slice(1).join("."):null;return t[w][e](o,c,h)},td=function(t,e){if(sl.call(this,t,e),delete this.coordinates,this.model=Nse[e.geometry.type],this.model===void 0)throw new TypeError(`${e.geometry.type} is not a valid type`);this.features=this._coordinatesToFeatures(e.geometry.coordinates)};td.prototype=Object.create(sl.prototype);td.prototype._coordinatesToFeatures=function(t){const e=this.model.bind(this);return t.map(r=>new e(this.ctx,{id:wU(),type:Tn.FEATURE,properties:{},geometry:{coordinates:r,type:this.type.replace("Multi","")}}))};td.prototype.isValid=function(){return this.features.every(t=>t.isValid())};td.prototype.setCoordinates=function(t){this.features=this._coordinatesToFeatures(t),this.changed()};td.prototype.getCoordinate=function(t){return FT(this.features,"getCoordinate",t)};td.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.features.map(t=>t.type===Tn.POLYGON?t.getCoordinates():t.coordinates)))};td.prototype.updateCoordinate=function(t,e,r){FT(this.features,"updateCoordinate",t,e,r),this.changed()};td.prototype.addCoordinate=function(t,e,r){FT(this.features,"addCoordinate",t,e,r),this.changed()};td.prototype.removeCoordinate=function(t){FT(this.features,"removeCoordinate",t),this.changed()};td.prototype.getFeatures=function(){return this.features};function np(t,e){this.x=t,this.y=e}np.prototype={clone(){return new np(this.x,this.y)},add(t){return this.clone()._add(t)},sub(t){return this.clone()._sub(t)},multByPoint(t){return this.clone()._multByPoint(t)},divByPoint(t){return this.clone()._divByPoint(t)},mult(t){return this.clone()._mult(t)},div(t){return this.clone()._div(t)},rotate(t){return this.clone()._rotate(t)},rotateAround(t,e){return this.clone()._rotateAround(t,e)},matMult(t){return this.clone()._matMult(t)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(t){return this.x===t.x&&this.y===t.y},dist(t){return Math.sqrt(this.distSqr(t))},distSqr(t){const e=t.x-this.x,r=t.y-this.y;return e*e+r*r},angle(){return Math.atan2(this.y,this.x)},angleTo(t){return Math.atan2(this.y-t.y,this.x-t.x)},angleWith(t){return this.angleWithSep(t.x,t.y)},angleWithSep(t,e){return Math.atan2(this.x*e-this.y*t,this.x*t+this.y*e)},_matMult(t){const e=t[0]*this.x+t[1]*this.y,r=t[2]*this.x+t[3]*this.y;return this.x=e,this.y=r,this},_add(t){return this.x+=t.x,this.y+=t.y,this},_sub(t){return this.x-=t.x,this.y-=t.y,this},_mult(t){return this.x*=t,this.y*=t,this},_div(t){return this.x/=t,this.y/=t,this},_multByPoint(t){return this.x*=t.x,this.y*=t.y,this},_divByPoint(t){return this.x/=t.x,this.y/=t.y,this},_unit(){return this._div(this.mag()),this},_perp(){const t=this.y;return this.y=this.x,this.x=-t,this},_rotate(t){const e=Math.cos(t),r=Math.sin(t),c=e*this.x-r*this.y,h=r*this.x+e*this.y;return this.x=c,this.y=h,this},_rotateAround(t,e){const r=Math.cos(t),c=Math.sin(t),h=e.x+r*(this.x-e.x)-c*(this.y-e.y),x=e.y+c*(this.x-e.x)+r*(this.y-e.y);return this.x=h,this.y=x,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:np};np.convert=function(t){if(t instanceof np)return t;if(Array.isArray(t))return new np(+t[0],+t[1]);if(t.x!==void 0&&t.y!==void 0)return new np(+t.x,+t.y);throw new Error("Expected [x, y] or {x, y} point format")};function $j(t,e){const r=e.getBoundingClientRect();return new np(t.clientX-r.left-(e.clientLeft||0),t.clientY-r.top-(e.clientTop||0))}function Dv(t,e,r,c){return{type:Tn.FEATURE,properties:{meta:Do.VERTEX,parent:t,coord_path:r,active:c?po.ACTIVE:po.INACTIVE},geometry:{type:Tn.POINT,coordinates:e}}}function Ase(t){return!isNaN(t)&&t!==null&&!Array.isArray(t)}function SU(t,e,r){if(t!==null)for(var c,h,x,w,o,C,R,F=0,$=0,Y,H=t.type,X=H==="FeatureCollection",he=H==="Feature",se=X?t.features.length:1,de=0;de<se;de++){R=X?t.features[de].geometry:he?t.geometry:t,Y=R?R.type==="GeometryCollection":!1,o=Y?R.geometries.length:1;for(var K=0;K<o;K++){var ge=0,Ae=0;if(w=Y?R.geometries[K]:R,w!==null){C=w.coordinates;var Te=w.type;switch(F=0,Te){case null:break;case"Point":if(e(C,$,de,ge,Ae)===!1)return!1;$++,ge++;break;case"LineString":case"MultiPoint":for(c=0;c<C.length;c++){if(e(C[c],$,de,ge,Ae)===!1)return!1;$++,Te==="MultiPoint"&&ge++}Te==="LineString"&&ge++;break;case"Polygon":case"MultiLineString":for(c=0;c<C.length;c++){for(h=0;h<C[c].length-F;h++){if(e(C[c][h],$,de,ge,Ae)===!1)return!1;$++}Te==="MultiLineString"&&ge++,Te==="Polygon"&&Ae++}Te==="Polygon"&&ge++;break;case"MultiPolygon":for(c=0;c<C.length;c++){for(Ae=0,h=0;h<C[c].length;h++){for(x=0;x<C[c][h].length-F;x++){if(e(C[c][h][x],$,de,ge,Ae)===!1)return!1;$++}Ae++}ge++}break;case"GeometryCollection":for(c=0;c<w.geometries.length;c++)if(SU(w.geometries[c],e)===!1)return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}function Cse(t){if(!t)throw new Error("geojson is required");switch(t.type){case"Feature":return TU(t);case"FeatureCollection":return Ese(t);case"Point":case"LineString":case"Polygon":case"MultiPoint":case"MultiLineString":case"MultiPolygon":case"GeometryCollection":return Gj(t);default:throw new Error("unknown GeoJSON type")}}function TU(t){const e={type:"Feature"};return Object.keys(t).forEach(r=>{switch(r){case"type":case"properties":case"geometry":return;default:e[r]=t[r]}}),e.properties=NU(t.properties),t.geometry==null?e.geometry=null:e.geometry=Gj(t.geometry),e}function NU(t){const e={};return t&&Object.keys(t).forEach(r=>{const c=t[r];typeof c=="object"?c===null?e[r]=null:Array.isArray(c)?e[r]=c.map(h=>h):e[r]=NU(c):e[r]=c}),e}function Ese(t){const e={type:"FeatureCollection"};return Object.keys(t).forEach(r=>{switch(r){case"type":case"features":return;default:e[r]=t[r]}}),e.features=t.features.map(r=>TU(r)),e}function Gj(t){const e={type:t.type};return t.bbox&&(e.bbox=t.bbox),t.type==="GeometryCollection"?(e.geometries=t.geometries.map(r=>Gj(r)),e):(e.coordinates=AU(t.coordinates),e)}function AU(t){const e=t;return typeof e[0]!="object"?e.slice():e.map(r=>AU(r))}function N3(t,e={}){return CU(t,"mercator",e)}function Ise(t,e={}){return CU(t,"wgs84",e)}function CU(t,e,r={}){r=r||{};var c=r.mutate;if(!t)throw new Error("geojson is required");return Array.isArray(t)&&Ase(t[0])?t=e==="mercator"?A3(t):C3(t):(c!==!0&&(t=Cse(t)),SU(t,function(h){var x=e==="mercator"?A3(h):C3(h);h[0]=x[0],h[1]=x[1]})),t}function A3(t){var e=Math.PI/180,r=6378137,c=20037508342789244e-9,h=Math.abs(t[0])<=180?t[0]:t[0]-Pse(t[0])*360,x=[r*h*e,r*Math.log(Math.tan(Math.PI*.25+.5*t[1]*e))];return x[0]>c&&(x[0]=c),x[0]<-c&&(x[0]=-c),x[1]>c&&(x[1]=c),x[1]<-c&&(x[1]=-c),x}function C3(t){var e=180/Math.PI,r=6378137;return[t[0]*e/r,(Math.PI*.5-2*Math.atan(Math.exp(-t[1]/r)))*e]}function Pse(t){return t<0?-1:t>0?1:0}function jse(t,e,r){const c=e.geometry.coordinates,h=r.geometry.coordinates;if(c[1]>xI||c[1]<yI||h[1]>xI||h[1]<yI)return null;const x=N3(c),w=N3(h),o=$=>Number($.toFixed(8)),C=($,Y)=>($+Y)/2,R=Ise([C(x[0],w[0]),C(x[1],w[1])]),F=[o(R[0]),o(R[1])];return{type:Tn.FEATURE,properties:{meta:Do.MIDPOINT,parent:t,lng:F[0],lat:F[1],coord_path:r.properties.coord_path},geometry:{type:Tn.POINT,coordinates:F}}}function Hj(t,e={},r=null){const{type:c,coordinates:h}=t.geometry,x=t.properties&&t.properties.id;let w=[];c===Tn.POINT?w.push(Dv(x,h,r,C(r))):c===Tn.POLYGON?h.forEach((F,$)=>{o(F,r!==null?`${r}.${$}`:String($))}):c===Tn.LINE_STRING?o(h,r):c.indexOf(Tn.MULTI_PREFIX)===0&&R();function o(F,$){let Y="",H=null;F.forEach((X,he)=>{const se=$!=null?`${$}.${he}`:String(he),de=Dv(x,X,se,C(se));if(e.midpoints&&H){const ge=jse(x,H,de);ge&&w.push(ge)}H=de;const K=JSON.stringify(X);Y!==K&&w.push(de),he===0&&(Y=K)})}function C(F){return e.selectedPaths?e.selectedPaths.indexOf(F)!==-1:!1}function R(){const F=c.replace(Tn.MULTI_PREFIX,"");h.forEach(($,Y)=>{const H={type:Tn.FEATURE,properties:t.properties,geometry:{type:F,coordinates:$}};w=w.concat(Hj(H,e,Y))})}return w}const Zu={enable(t){setTimeout(()=>{!t.map||!t.map.doubleClickZoom||!t._ctx||!t._ctx.store||!t._ctx.store.getInitialConfigValue||t._ctx.store.getInitialConfigValue("doubleClickZoom")&&t.map.doubleClickZoom.enable()},0)},disable(t){setTimeout(()=>{!t.map||!t.map.doubleClickZoom||t.map.doubleClickZoom.disable()},0)}},{LAT_MIN:$w,LAT_MAX:Gw,LAT_RENDERED_MIN:E3,LAT_RENDERED_MAX:I3,LNG_MIN:P3,LNG_MAX:j3}=bse;function Rse(t){const e={Point:0,LineString:1,Polygon:2,MultiPoint:1,MultiLineString:2,MultiPolygon:3}[t.geometry.type],r=[t.geometry.coordinates].flat(e),c=r.map(o=>o[0]),h=r.map(o=>o[1]),x=o=>Math.min.apply(null,o),w=o=>Math.max.apply(null,o);return[x(c),x(h),w(c),w(h)]}function EU(t,e){let r=$w,c=Gw,h=$w,x=Gw,w=j3,o=P3;t.forEach(R=>{const F=Rse(R),$=F[1],Y=F[3],H=F[0],X=F[2];$>r&&(r=$),Y<c&&(c=Y),Y>h&&(h=Y),$<x&&(x=$),H<w&&(w=H),X>o&&(o=X)});const C=e;return r+C.lat>I3&&(C.lat=I3-r),h+C.lat>Gw&&(C.lat=Gw-h),c+C.lat<E3&&(C.lat=E3-c),x+C.lat<$w&&(C.lat=$w-x),w+C.lng<=P3&&(C.lng+=Math.ceil(Math.abs(C.lng)/360)*360),o+C.lng>=j3&&(C.lng-=Math.ceil(Math.abs(C.lng)/360)*360),C}function IU(t,e){const r=EU(t.map(c=>c.toGeoJSON()),e);t.forEach(c=>{const h=c.getCoordinates(),x=R=>{const F={lng:R[0]+r.lng,lat:R[1]+r.lat};return[F.lng,F.lat]},w=R=>R.map(F=>x(F)),o=R=>R.map(F=>w(F));let C;c.type===Tn.POINT?C=x(h):c.type===Tn.LINE_STRING||c.type===Tn.MULTI_POINT?C=h.map(x):c.type===Tn.POLYGON||c.type===Tn.MULTI_LINE_STRING?C=h.map(w):c.type===Tn.MULTI_POLYGON&&(C=h.map(o)),c.incomingCoords(C)})}const hs={};hs.onSetup=function(t){const e={dragMoveLocation:null,boxSelectStartLocation:null,boxSelectElement:void 0,boxSelecting:!1,canBoxSelect:!1,dragMoving:!1,canDragMove:!1,initialDragPanState:this.map.dragPan.isEnabled(),initiallySelectedFeatureIds:t.featureIds||[]};return this.setSelected(e.initiallySelectedFeatureIds.filter(r=>this.getFeature(r)!==void 0)),this.fireActionable(),this.setActionableState({combineFeatures:!0,uncombineFeatures:!0,trash:!0}),e};hs.fireUpdate=function(){this.fire(Lp.UPDATE,{action:zj.MOVE,features:this.getSelected().map(t=>t.toGeoJSON())})};hs.fireActionable=function(){const t=this.getSelected(),e=t.filter(x=>this.isInstanceOf("MultiFeature",x));let r=!1;if(t.length>1){r=!0;const x=t[0].type.replace("Multi","");t.forEach(w=>{w.type.replace("Multi","")!==x&&(r=!1)})}const c=e.length>0,h=t.length>0;this.setActionableState({combineFeatures:r,uncombineFeatures:c,trash:h})};hs.getUniqueIds=function(t){return t.length?t.map(r=>r.properties.id).filter(r=>r!==void 0).reduce((r,c)=>(r.add(c),r),new sx).values():[]};hs.stopExtendedInteractions=function(t){t.boxSelectElement&&(t.boxSelectElement.parentNode&&t.boxSelectElement.parentNode.removeChild(t.boxSelectElement),t.boxSelectElement=null),(t.canDragMove||t.canBoxSelect)&&t.initialDragPanState===!0&&this.map.dragPan.enable(),t.boxSelecting=!1,t.canBoxSelect=!1,t.dragMoving=!1,t.canDragMove=!1};hs.onStop=function(){Zu.enable(this)};hs.onMouseMove=function(t,e){return bU(e)&&t.dragMoving&&this.fireUpdate(),this.stopExtendedInteractions(t),!0};hs.onMouseOut=function(t){return t.dragMoving?this.fireUpdate():!0};hs.onTap=hs.onClick=function(t,e){if(Vj(e))return this.clickAnywhere(t,e);if(Bj(Do.VERTEX)(e))return this.clickOnVertex(t,e);if(bU(e))return this.clickOnFeature(t,e)};hs.clickAnywhere=function(t){const e=this.getSelectedIds();e.length&&(this.clearSelectedFeatures(),e.forEach(r=>this.doRender(r))),Zu.enable(this),this.stopExtendedInteractions(t)};hs.clickOnVertex=function(t,e){this.changeMode(ya.DIRECT_SELECT,{featureId:e.featureTarget.properties.parent,coordPath:e.featureTarget.properties.coord_path,startPos:e.lngLat}),this.updateUIClasses({mouse:ka.MOVE})};hs.startOnActiveFeature=function(t,e){this.stopExtendedInteractions(t),this.map.dragPan.disable(),this.doRender(e.featureTarget.properties.id),t.canDragMove=!0,t.dragMoveLocation=e.lngLat};hs.clickOnFeature=function(t,e){Zu.disable(this),this.stopExtendedInteractions(t);const r=_I(e),c=this.getSelectedIds(),h=e.featureTarget.properties.id,x=this.isSelected(h);if(!r&&x&&this.getFeature(h).type!==Tn.POINT)return this.changeMode(ya.DIRECT_SELECT,{featureId:h});x&&r?(this.deselect(h),this.updateUIClasses({mouse:ka.POINTER}),c.length===1&&Zu.enable(this)):!x&&r?(this.select(h),this.updateUIClasses({mouse:ka.MOVE})):!x&&!r&&(c.forEach(w=>this.doRender(w)),this.setSelected(h),this.updateUIClasses({mouse:ka.MOVE})),this.doRender(h)};hs.onMouseDown=function(t,e){if(t.initialDragPanState=this.map.dragPan.isEnabled(),nx(e))return this.startOnActiveFeature(t,e);if(this.drawConfig.boxSelect&&wse(e))return this.startBoxSelect(t,e)};hs.startBoxSelect=function(t,e){this.stopExtendedInteractions(t),this.map.dragPan.disable(),t.boxSelectStartLocation=$j(e.originalEvent,this.map.getContainer()),t.canBoxSelect=!0};hs.onTouchStart=function(t,e){if(nx(e))return this.startOnActiveFeature(t,e)};hs.onDrag=function(t,e){if(t.canDragMove)return this.dragMove(t,e);if(this.drawConfig.boxSelect&&t.canBoxSelect)return this.whileBoxSelect(t,e)};hs.whileBoxSelect=function(t,e){t.boxSelecting=!0,this.updateUIClasses({mouse:ka.ADD}),t.boxSelectElement||(t.boxSelectElement=document.createElement("div"),t.boxSelectElement.classList.add(_U.BOX_SELECT),this.map.getContainer().appendChild(t.boxSelectElement));const r=$j(e.originalEvent,this.map.getContainer()),c=Math.min(t.boxSelectStartLocation.x,r.x),h=Math.max(t.boxSelectStartLocation.x,r.x),x=Math.min(t.boxSelectStartLocation.y,r.y),w=Math.max(t.boxSelectStartLocation.y,r.y),o=`translate(${c}px, ${x}px)`;t.boxSelectElement.style.transform=o,t.boxSelectElement.style.WebkitTransform=o,t.boxSelectElement.style.width=`${h-c}px`,t.boxSelectElement.style.height=`${w-x}px`};hs.dragMove=function(t,e){t.dragMoving=!0,e.originalEvent.stopPropagation();const r={lng:e.lngLat.lng-t.dragMoveLocation.lng,lat:e.lngLat.lat-t.dragMoveLocation.lat};IU(this.getSelected(),r),t.dragMoveLocation=e.lngLat};hs.onTouchEnd=hs.onMouseUp=function(t,e){if(t.dragMoving)this.fireUpdate();else if(t.boxSelecting){const r=[t.boxSelectStartLocation,$j(e.originalEvent,this.map.getContainer())],c=this.featuresAt(null,r,"click"),h=this.getUniqueIds(c).filter(x=>!this.isSelected(x));h.length&&(this.select(h),h.forEach(x=>this.doRender(x)),this.updateUIClasses({mouse:ka.MOVE}))}this.stopExtendedInteractions(t)};hs.toDisplayFeatures=function(t,e,r){e.properties.active=this.isSelected(e.properties.id)?po.ACTIVE:po.INACTIVE,r(e),this.fireActionable(),!(e.properties.active!==po.ACTIVE||e.geometry.type===Tn.POINT)&&Hj(e).forEach(r)};hs.onTrash=function(){this.deleteFeature(this.getSelectedIds()),this.fireActionable()};hs.onCombineFeatures=function(){const t=this.getSelected();if(t.length===0||t.length<2)return;const e=[],r=[],c=t[0].type.replace("Multi","");for(let h=0;h<t.length;h++){const x=t[h];if(x.type.replace("Multi","")!==c)return;x.type.includes("Multi")?x.getCoordinates().forEach(w=>{e.push(w)}):e.push(x.getCoordinates()),r.push(x.toGeoJSON())}if(r.length>1){const h=this.newFeature({type:Tn.FEATURE,properties:r[0].properties,geometry:{type:`Multi${c}`,coordinates:e}});this.addFeature(h),this.deleteFeature(this.getSelectedIds(),{silent:!0}),this.setSelected([h.id]),this.fire(Lp.COMBINE_FEATURES,{createdFeatures:[h.toGeoJSON()],deletedFeatures:r})}this.fireActionable()};hs.onUncombineFeatures=function(){const t=this.getSelected();if(t.length===0)return;const e=[],r=[];for(let c=0;c<t.length;c++){const h=t[c];this.isInstanceOf("MultiFeature",h)&&(h.getFeatures().forEach(x=>{this.addFeature(x),x.properties=h.properties,e.push(x.toGeoJSON()),this.select([x.id])}),this.deleteFeature(h.id,{silent:!0}),r.push(h.toGeoJSON()))}e.length>1&&this.fire(Lp.UNCOMBINE_FEATURES,{createdFeatures:e,deletedFeatures:r}),this.fireActionable()};const PU=Bj(Do.VERTEX),jU=Bj(Do.MIDPOINT),ps={};ps.fireUpdate=function(){this.fire(Lp.UPDATE,{action:zj.CHANGE_COORDINATES,features:this.getSelected().map(t=>t.toGeoJSON())})};ps.fireActionable=function(t){this.setActionableState({combineFeatures:!1,uncombineFeatures:!1,trash:t.selectedCoordPaths.length>0})};ps.startDragging=function(t,e){t.initialDragPanState==null&&(t.initialDragPanState=this.map.dragPan.isEnabled()),this.map.dragPan.disable(),t.canDragMove=!0,t.dragMoveLocation=e.lngLat};ps.stopDragging=function(t){t.canDragMove&&t.initialDragPanState===!0&&this.map.dragPan.enable(),t.initialDragPanState=null,t.dragMoving=!1,t.canDragMove=!1,t.dragMoveLocation=null};ps.onVertex=function(t,e){this.startDragging(t,e);const r=e.featureTarget.properties,c=t.selectedCoordPaths.indexOf(r.coord_path);!_I(e)&&c===-1?t.selectedCoordPaths=[r.coord_path]:_I(e)&&c===-1&&t.selectedCoordPaths.push(r.coord_path);const h=this.pathsToCoordinates(t.featureId,t.selectedCoordPaths);this.setSelectedCoordinates(h)};ps.onMidpoint=function(t,e){this.startDragging(t,e);const r=e.featureTarget.properties;t.feature.addCoordinate(r.coord_path,r.lng,r.lat),this.fireUpdate(),t.selectedCoordPaths=[r.coord_path]};ps.pathsToCoordinates=function(t,e){return e.map(r=>({feature_id:t,coord_path:r}))};ps.onFeature=function(t,e){t.selectedCoordPaths.length===0?this.startDragging(t,e):this.stopDragging(t)};ps.dragFeature=function(t,e,r){IU(this.getSelected(),r),t.dragMoveLocation=e.lngLat};ps.dragVertex=function(t,e,r){const c=t.selectedCoordPaths.map(w=>t.feature.getCoordinate(w)),h=c.map(w=>({type:Tn.FEATURE,properties:{},geometry:{type:Tn.POINT,coordinates:w}})),x=EU(h,r);for(let w=0;w<c.length;w++){const o=c[w];t.feature.updateCoordinate(t.selectedCoordPaths[w],o[0]+x.lng,o[1]+x.lat)}};ps.clickNoTarget=function(){this.changeMode(ya.SIMPLE_SELECT)};ps.clickInactive=function(){this.changeMode(ya.SIMPLE_SELECT)};ps.clickActiveFeature=function(t){t.selectedCoordPaths=[],this.clearSelectedCoordinates(),t.feature.changed()};ps.onSetup=function(t){const e=t.featureId,r=this.getFeature(e);if(!r)throw new Error("You must provide a featureId to enter direct_select mode");if(r.type===Tn.POINT)throw new TypeError("direct_select mode doesn't handle point features");const c={featureId:e,feature:r,dragMoveLocation:t.startPos||null,dragMoving:!1,canDragMove:!1,selectedCoordPaths:t.coordPath?[t.coordPath]:[]};return this.setSelectedCoordinates(this.pathsToCoordinates(e,c.selectedCoordPaths)),this.setSelected(e),Zu.disable(this),this.setActionableState({trash:!0}),c};ps.onStop=function(){Zu.enable(this),this.clearSelectedCoordinates()};ps.toDisplayFeatures=function(t,e,r){t.featureId===e.properties.id?(e.properties.active=po.ACTIVE,r(e),Hj(e,{map:this.map,midpoints:!0,selectedPaths:t.selectedCoordPaths}).forEach(r)):(e.properties.active=po.INACTIVE,r(e)),this.fireActionable(t)};ps.onTrash=function(t){t.selectedCoordPaths.sort((e,r)=>r.localeCompare(e,"en",{numeric:!0})).forEach(e=>t.feature.removeCoordinate(e)),this.fireUpdate(),t.selectedCoordPaths=[],this.clearSelectedCoordinates(),this.fireActionable(t),t.feature.isValid()===!1&&(this.deleteFeature([t.featureId]),this.changeMode(ya.SIMPLE_SELECT,{}))};ps.onMouseMove=function(t,e){const r=nx(e),c=PU(e),h=jU(e),x=t.selectedCoordPaths.length===0;return r&&x?this.updateUIClasses({mouse:ka.MOVE}):c&&!x?this.updateUIClasses({mouse:ka.MOVE}):this.updateUIClasses({mouse:ka.NONE}),(c||r||h)&&t.dragMoving&&this.fireUpdate(),this.stopDragging(t),!0};ps.onMouseOut=function(t){return t.dragMoving&&this.fireUpdate(),!0};ps.onTouchStart=ps.onMouseDown=function(t,e){if(PU(e))return this.onVertex(t,e);if(nx(e))return this.onFeature(t,e);if(jU(e))return this.onMidpoint(t,e)};ps.onDrag=function(t,e){if(t.canDragMove!==!0)return;t.dragMoving=!0,e.originalEvent.stopPropagation();const r={lng:e.lngLat.lng-t.dragMoveLocation.lng,lat:e.lngLat.lat-t.dragMoveLocation.lat};t.selectedCoordPaths.length>0?this.dragVertex(t,e,r):this.dragFeature(t,e,r),t.dragMoveLocation=e.lngLat};ps.onClick=function(t,e){if(Vj(e))return this.clickNoTarget(t,e);if(nx(e))return this.clickActiveFeature(t,e);if(vU(e))return this.clickInactive(t,e);this.stopDragging(t)};ps.onTap=function(t,e){if(Vj(e))return this.clickNoTarget(t,e);if(nx(e))return this.clickActiveFeature(t,e);if(vU(e))return this.clickInactive(t,e)};ps.onTouchEnd=ps.onMouseUp=function(t){t.dragMoving&&this.fireUpdate(),this.stopDragging(t)};const Zd={};Zd.onSetup=function(){const t=this.newFeature({type:Tn.FEATURE,properties:{},geometry:{type:Tn.POINT,coordinates:[]}});return this.addFeature(t),this.clearSelectedFeatures(),this.updateUIClasses({mouse:ka.ADD}),this.activateUIButton(OT.POINT),this.setActionableState({trash:!0}),{point:t}};Zd.stopDrawingAndRemove=function(t){this.deleteFeature([t.point.id],{silent:!0}),this.changeMode(ya.SIMPLE_SELECT)};Zd.onTap=Zd.onClick=function(t,e){this.updateUIClasses({mouse:ka.MOVE}),t.point.updateCoordinate("",e.lngLat.lng,e.lngLat.lat),this.fire(Lp.CREATE,{features:[t.point.toGeoJSON()]}),this.changeMode(ya.SIMPLE_SELECT,{featureIds:[t.point.id]})};Zd.onStop=function(t){this.activateUIButton(),t.point.getCoordinate().length||this.deleteFeature([t.point.id],{silent:!0})};Zd.toDisplayFeatures=function(t,e,r){const c=e.properties.id===t.point.id;if(e.properties.active=c?po.ACTIVE:po.INACTIVE,!c)return r(e)};Zd.onTrash=Zd.stopDrawingAndRemove;Zd.onKeyUp=function(t,e){if(Uj(e)||qj(e))return this.stopDrawingAndRemove(t,e)};function vI(t,e){return t.lngLat?t.lngLat.lng===e[0]&&t.lngLat.lat===e[1]:!1}const Xu={};Xu.onSetup=function(){const t=this.newFeature({type:Tn.FEATURE,properties:{},geometry:{type:Tn.POLYGON,coordinates:[[]]}});return this.addFeature(t),this.clearSelectedFeatures(),Zu.disable(this),this.updateUIClasses({mouse:ka.ADD}),this.activateUIButton(OT.POLYGON),this.setActionableState({trash:!0}),{polygon:t,currentVertexPosition:0}};Xu.clickAnywhere=function(t,e){if(t.currentVertexPosition>0&&vI(e,t.polygon.coordinates[0][t.currentVertexPosition-1]))return this.changeMode(ya.SIMPLE_SELECT,{featureIds:[t.polygon.id]});this.updateUIClasses({mouse:ka.ADD}),t.polygon.updateCoordinate(`0.${t.currentVertexPosition}`,e.lngLat.lng,e.lngLat.lat),t.currentVertexPosition++,t.polygon.updateCoordinate(`0.${t.currentVertexPosition}`,e.lngLat.lng,e.lngLat.lat)};Xu.clickOnVertex=function(t){return this.changeMode(ya.SIMPLE_SELECT,{featureIds:[t.polygon.id]})};Xu.onMouseMove=function(t,e){t.polygon.updateCoordinate(`0.${t.currentVertexPosition}`,e.lngLat.lng,e.lngLat.lat),LT(e)&&this.updateUIClasses({mouse:ka.POINTER})};Xu.onTap=Xu.onClick=function(t,e){return LT(e)?this.clickOnVertex(t,e):this.clickAnywhere(t,e)};Xu.onKeyUp=function(t,e){Uj(e)?(this.deleteFeature([t.polygon.id],{silent:!0}),this.changeMode(ya.SIMPLE_SELECT)):qj(e)&&this.changeMode(ya.SIMPLE_SELECT,{featureIds:[t.polygon.id]})};Xu.onStop=function(t){this.updateUIClasses({mouse:ka.NONE}),Zu.enable(this),this.activateUIButton(),this.getFeature(t.polygon.id)!==void 0&&(t.polygon.removeCoordinate(`0.${t.currentVertexPosition}`),t.polygon.isValid()?this.fire(Lp.CREATE,{features:[t.polygon.toGeoJSON()]}):(this.deleteFeature([t.polygon.id],{silent:!0}),this.changeMode(ya.SIMPLE_SELECT,{},{silent:!0})))};Xu.toDisplayFeatures=function(t,e,r){const c=e.properties.id===t.polygon.id;if(e.properties.active=c?po.ACTIVE:po.INACTIVE,!c)return r(e);if(e.geometry.coordinates.length===0)return;const h=e.geometry.coordinates[0].length;if(!(h<3)){if(e.properties.meta=Do.FEATURE,r(Dv(t.polygon.id,e.geometry.coordinates[0][0],"0.0",!1)),h>3){const x=e.geometry.coordinates[0].length-3;r(Dv(t.polygon.id,e.geometry.coordinates[0][x],`0.${x}`,!1))}if(h<=4){const x=[[e.geometry.coordinates[0][0][0],e.geometry.coordinates[0][0][1]],[e.geometry.coordinates[0][1][0],e.geometry.coordinates[0][1][1]]];if(r({type:Tn.FEATURE,properties:e.properties,geometry:{coordinates:x,type:Tn.LINE_STRING}}),h===3)return}return r(e)}};Xu.onTrash=function(t){this.deleteFeature([t.polygon.id],{silent:!0}),this.changeMode(ya.SIMPLE_SELECT)};const Yu={};Yu.onSetup=function(t){t=t||{};const e=t.featureId;let r,c,h="forward";if(e){if(r=this.getFeature(e),!r)throw new Error("Could not find a feature with the provided featureId");let x=t.from;if(x&&x.type==="Feature"&&x.geometry&&x.geometry.type==="Point"&&(x=x.geometry),x&&x.type==="Point"&&x.coordinates&&x.coordinates.length===2&&(x=x.coordinates),!x||!Array.isArray(x))throw new Error("Please use the `from` property to indicate which point to continue the line from");const w=r.coordinates.length-1;if(r.coordinates[w][0]===x[0]&&r.coordinates[w][1]===x[1])c=w+1,r.addCoordinate(c,...r.coordinates[w]);else if(r.coordinates[0][0]===x[0]&&r.coordinates[0][1]===x[1])h="backwards",c=0,r.addCoordinate(c,...r.coordinates[0]);else throw new Error("`from` should match the point at either the start or the end of the provided LineString")}else r=this.newFeature({type:Tn.FEATURE,properties:{},geometry:{type:Tn.LINE_STRING,coordinates:[]}}),c=0,this.addFeature(r);return this.clearSelectedFeatures(),Zu.disable(this),this.updateUIClasses({mouse:ka.ADD}),this.activateUIButton(OT.LINE),this.setActionableState({trash:!0}),{line:r,currentVertexPosition:c,direction:h}};Yu.clickAnywhere=function(t,e){if(t.currentVertexPosition>0&&vI(e,t.line.coordinates[t.currentVertexPosition-1])||t.direction==="backwards"&&vI(e,t.line.coordinates[t.currentVertexPosition+1]))return this.changeMode(ya.SIMPLE_SELECT,{featureIds:[t.line.id]});this.updateUIClasses({mouse:ka.ADD}),t.line.updateCoordinate(t.currentVertexPosition,e.lngLat.lng,e.lngLat.lat),t.direction==="forward"?(t.currentVertexPosition++,t.line.updateCoordinate(t.currentVertexPosition,e.lngLat.lng,e.lngLat.lat)):t.line.addCoordinate(0,e.lngLat.lng,e.lngLat.lat)};Yu.clickOnVertex=function(t){return this.changeMode(ya.SIMPLE_SELECT,{featureIds:[t.line.id]})};Yu.onMouseMove=function(t,e){t.line.updateCoordinate(t.currentVertexPosition,e.lngLat.lng,e.lngLat.lat),LT(e)&&this.updateUIClasses({mouse:ka.POINTER})};Yu.onTap=Yu.onClick=function(t,e){if(LT(e))return this.clickOnVertex(t,e);this.clickAnywhere(t,e)};Yu.onKeyUp=function(t,e){qj(e)?this.changeMode(ya.SIMPLE_SELECT,{featureIds:[t.line.id]}):Uj(e)&&(this.deleteFeature([t.line.id],{silent:!0}),this.changeMode(ya.SIMPLE_SELECT))};Yu.onStop=function(t){Zu.enable(this),this.activateUIButton(),this.getFeature(t.line.id)!==void 0&&(t.line.removeCoordinate(`${t.currentVertexPosition}`),t.line.isValid()?this.fire(Lp.CREATE,{features:[t.line.toGeoJSON()]}):(this.deleteFeature([t.line.id],{silent:!0}),this.changeMode(ya.SIMPLE_SELECT,{},{silent:!0})))};Yu.onTrash=function(t){this.deleteFeature([t.line.id],{silent:!0}),this.changeMode(ya.SIMPLE_SELECT)};Yu.toDisplayFeatures=function(t,e,r){const c=e.properties.id===t.line.id;if(e.properties.active=c?po.ACTIVE:po.INACTIVE,!c)return r(e);e.geometry.coordinates.length<2||(e.properties.meta=Do.FEATURE,r(Dv(t.line.id,e.geometry.coordinates[t.direction==="forward"?e.geometry.coordinates.length-2:1],`${t.direction==="forward"?e.geometry.coordinates.length-2:1}`,!1)),r(e))};ya.SIMPLE_SELECT;const qh={none:{id:"none",label:"View Only",cursor:"default"},siteLocation:{id:"siteLocation",label:"Set Site Location",cursor:"crosshair",type:"marker",layer:"siteSurvey",single:!0},operationsBoundary:{id:"operationsBoundary",label:"Draw Operations Boundary",cursor:"crosshair",type:"polygon",layer:"siteSurvey",single:!0},obstacle:{id:"obstacle",label:"Add Obstacle",cursor:"crosshair",type:"marker",layer:"siteSurvey",single:!1},launchPoint:{id:"launchPoint",label:"Set Launch Point",cursor:"crosshair",type:"marker",layer:"flightPlan",single:!0},recoveryPoint:{id:"recoveryPoint",label:"Set Recovery Point",cursor:"crosshair",type:"marker",layer:"flightPlan",single:!0},pilotPosition:{id:"pilotPosition",label:"Set Pilot Position",cursor:"crosshair",type:"marker",layer:"flightPlan",single:!0},flightGeography:{id:"flightGeography",label:"Draw Flight Geography",cursor:"crosshair",type:"polygon",layer:"flightPlan",single:!0},musterPoint:{id:"musterPoint",label:"Add Muster Point",cursor:"crosshair",type:"marker",layer:"emergency",single:!1},evacuationRoute:{id:"evacuationRoute",label:"Draw Evacuation Route",cursor:"crosshair",type:"line",layer:"emergency",single:!1}};function zT(t,e,r={}){var bi,ar;const{initialSiteId:c=null,editMode:h=!1,allowedLayers:x=["siteSurvey","flightPlan","emergency"],initialBasemap:w="streets"}=r,[o,C]=ue.useState(c||(t==null?void 0:t.activeSiteId)||((ar=(bi=t==null?void 0:t.sites)==null?void 0:bi[0])==null?void 0:ar.id)||null),[R,F]=ue.useState({siteSurvey:!0,flightPlan:!0,emergency:!0}),[$,Y]=ue.useState(qh.none),[H,X]=ue.useState(!1),[he,se]=ue.useState([]),[de,K]=ue.useState(null),[ge,Ae]=ue.useState(w),[Te,Ce]=ue.useState(null),[ne,ae]=ue.useState(12),[q,oe]=ue.useState(!1),ke=ue.useRef(t);ue.useEffect(()=>{ke.current=t},[t]),ue.useEffect(()=>{t!=null&&t.activeSiteId&&t.activeSiteId!==o&&C(t.activeSiteId)},[t==null?void 0:t.activeSiteId]);const Ve=ue.useMemo(()=>Array.isArray(t==null?void 0:t.sites)?t.sites:[],[t==null?void 0:t.sites]),ie=ue.useMemo(()=>!o||Ve.length===0?null:Ve.find(li=>li.id===o)||Ve[0],[Ve,o]),ze=ue.useMemo(()=>(ie==null?void 0:ie.mapData)||null,[ie]),ve=ue.useMemo(()=>ie?z6(ie):null,[ie]),Le=ue.useMemo(()=>fre(Ve),[Ve]),Ke=ue.useMemo(()=>q?Le:ve,[q,Le,ve]),Pe=ue.useMemo(()=>ie?V6(ie):null,[ie]),It=ue.useMemo(()=>ie?B6(ie):null,[ie]),tt=ue.useMemo(()=>{const li={siteSurvey:{markers:[],polygons:[]},flightPlan:{markers:[],polygons:[]},emergency:{markers:[],lines:[]}};return(q?Ve:ie?[ie]:[]).forEach((Jt,Vi)=>{const fi=Jt==null?void 0:Jt.mapData;if(!fi)return;const vi=Jt.id===o,Pi=vi?null:`hsl(${Vi*60}, 70%, 50%)`;R.siteSurvey&&fi.siteSurvey&&(fi.siteSurvey.siteLocation&&li.siteSurvey.markers.push({...fi.siteSurvey.siteLocation,siteId:Jt.id,siteName:Jt.name,isActive:vi,_siteColor:Pi}),fi.siteSurvey.operationsBoundary&&li.siteSurvey.polygons.push({...fi.siteSurvey.operationsBoundary,siteId:Jt.id,siteName:Jt.name,isActive:vi,_siteColor:Pi}),Array.isArray(fi.siteSurvey.obstacles)&&fi.siteSurvey.obstacles.forEach(Nr=>{li.siteSurvey.markers.push({...Nr,elementType:Nr.elementType||"obstacles",siteId:Jt.id,siteName:Jt.name,isActive:vi,_siteColor:Pi})})),R.flightPlan&&fi.flightPlan&&(fi.flightPlan.launchPoint&&li.flightPlan.markers.push({...fi.flightPlan.launchPoint,siteId:Jt.id,siteName:Jt.name,isActive:vi,_siteColor:Pi}),fi.flightPlan.recoveryPoint&&li.flightPlan.markers.push({...fi.flightPlan.recoveryPoint,siteId:Jt.id,siteName:Jt.name,isActive:vi,_siteColor:Pi}),fi.flightPlan.pilotPosition&&li.flightPlan.markers.push({...fi.flightPlan.pilotPosition,siteId:Jt.id,siteName:Jt.name,isActive:vi,_siteColor:Pi}),fi.flightPlan.flightGeography&&li.flightPlan.polygons.push({...fi.flightPlan.flightGeography,siteId:Jt.id,siteName:Jt.name,isActive:vi,_siteColor:Pi}),fi.flightPlan.contingencyVolume&&li.flightPlan.polygons.push({...fi.flightPlan.contingencyVolume,siteId:Jt.id,siteName:Jt.name,isActive:vi,_siteColor:Pi}),fi.flightPlan.groundRiskBuffer&&li.flightPlan.polygons.push({...fi.flightPlan.groundRiskBuffer,siteId:Jt.id,siteName:Jt.name,isActive:vi,_siteColor:Pi})),R.emergency&&fi.emergency&&(Array.isArray(fi.emergency.musterPoints)&&fi.emergency.musterPoints.forEach(Nr=>{li.emergency.markers.push({...Nr,elementType:Nr.elementType||"musterPoints",siteId:Jt.id,siteName:Jt.name,isActive:vi,_siteColor:Pi})}),Array.isArray(fi.emergency.evacuationRoutes)&&fi.emergency.evacuationRoutes.forEach(Nr=>{li.emergency.lines.push({...Nr,siteId:Jt.id,siteName:Jt.name,isActive:vi,_siteColor:Pi})}))}),li},[Ve,ie,o,R,q]),zt=ue.useCallback(li=>{C(li),K(null),Y(qh.none),X(!1),se([]),e&&t&&e({activeSiteId:li})},[e,t]),vt=ue.useCallback(li=>{F(ai=>({...ai,[li]:!ai[li]}))},[]),Ot=ue.useCallback((li,ai)=>{F(Jt=>({...Jt,[li]:ai}))},[]),Et=ue.useCallback(()=>{F({siteSurvey:!0,flightPlan:!0,emergency:!0})},[]),yi=ue.useCallback(()=>{F({siteSurvey:!1,flightPlan:!1,emergency:!1})},[]),mi=ue.useCallback(li=>{h&&qh[li]&&(Y(qh[li]),X(!0),se([]),K(null))},[h]),ht=ue.useCallback(()=>{Y(qh.none),X(!1),se([])},[]),hi=ue.useCallback(li=>{H&&se(ai=>[...ai,[li.lng,li.lat]])},[H]),ni=ue.useCallback(()=>{se(li=>li.slice(0,-1))},[]),ui=ue.useCallback(li=>{if(!e)return;const ai=ke.current;if(!ai)return;const Jt=ai.sites||[],Vi=ai.activeSiteId||o;if(!Vi||Jt.length===0)return;if(!Jt.find(Pi=>Pi.id===Vi)){console.warn(`[useMapData] Target site ${Vi} not found in sites array`);return}const vi=Jt.map(Pi=>{if(Pi.id!==Vi)return Pi;const Nr=typeof li=="function"?li(Pi.mapData):{...Pi.mapData,...li};return{...Pi,mapData:Nr,updatedAt:new Date().toISOString()}});e({sites:vi})},[o,e]),Fi=ue.useCallback((li,ai,Jt={})=>{if(!ie)return null;let Vi=li;li==="obstacle"&&(Vi="obstacles"),li==="musterPoint"&&(Vi="musterPoints"),li==="evacuationRoute"&&(Vi="evacuationRoutes");const fi=In[Vi];if(!fi)return console.warn(`No style found for element type: ${li} (tried: ${Vi})`),null;let vi;switch(li){case"obstacle":case"obstacles":vi=O6(ai.lng,ai.lat,{...Jt,...fi});break;case"musterPoints":case"musterPoint":vi=L6(ai.lng,ai.lat,{...Jt,...fi});break;default:vi=rp(ai.lng,ai.lat,{elementType:li,...Jt,...fi})}const Pi=fi.layer;return ui(Nr=>{const er=Nr?{...Nr}:{};return er[Pi]||(er[Pi]={}),li==="obstacles"||li==="obstacle"?(er.siteSurvey||(er.siteSurvey={}),Array.isArray(er.siteSurvey.obstacles)||(er.siteSurvey.obstacles=[]),er.siteSurvey.obstacles=[...er.siteSurvey.obstacles,vi]):li==="musterPoints"||li==="musterPoint"?(er.emergency||(er.emergency={musterPoints:[],evacuationRoutes:[]}),Array.isArray(er.emergency.musterPoints)||(er.emergency.musterPoints=[]),er.emergency.musterPoints.length===0&&(vi.isPrimary=!0),er.emergency.musterPoints=[...er.emergency.musterPoints,vi]):er[Pi][li]=vi,er}),vi},[ie,ui]),Ii=ue.useCallback((li,ai,Jt={})=>{if(!ie||!ai||ai.length<3)return null;const Vi=In[li];if(!Vi)return null;const fi=ai[0],vi=ai[ai.length-1];let Pi=ai;(fi[0]!==vi[0]||fi[1]!==vi[1])&&(Pi=[...ai,fi]);const Nr=jj(Pi,{elementType:li,area:Rj({geometry:{coordinates:[Pi]}}),...Jt,...Vi}),er=Vi.layer;return ui(Wr=>{const kr={...Wr};return kr[er]||(kr[er]={}),kr[er][li]=Nr,kr}),Nr},[ie,ui]),Bi=ue.useCallback((li,ai={})=>{if(!ie||!li||li.length<2)return null;const Jt=F6(li,ai);return ui(Vi=>{const fi=Vi?{...Vi}:{};return fi.emergency||(fi.emergency={musterPoints:[],evacuationRoutes:[]}),Array.isArray(fi.emergency.evacuationRoutes)||(fi.emergency.evacuationRoutes=[]),fi.emergency.evacuationRoutes.length===0&&(Jt.isPrimary=!0),fi.emergency.evacuationRoutes=[...fi.emergency.evacuationRoutes,Jt],fi}),Jt},[ie,ui]),Ki=ue.useCallback((li,ai)=>{if(!ie)return;let Jt=ai;ai==="obstacle"&&(Jt="obstacles"),ai==="musterPoint"&&(Jt="musterPoints"),ai==="evacuationRoute"&&(Jt="evacuationRoutes");const Vi=In[Jt];Vi&&(ui(fi=>{var Nr,er,Wr;const vi=JSON.parse(JSON.stringify(fi)),Pi=Vi.layer;return ai==="obstacles"||ai==="obstacle"?Array.isArray((Nr=vi.siteSurvey)==null?void 0:Nr.obstacles)&&(vi.siteSurvey.obstacles=vi.siteSurvey.obstacles.filter(kr=>kr.id!==li)):ai==="musterPoints"||ai==="musterPoint"?Array.isArray((er=vi.emergency)==null?void 0:er.musterPoints)&&(vi.emergency.musterPoints=vi.emergency.musterPoints.filter(kr=>kr.id!==li),vi.emergency.musterPoints.length>0&&!vi.emergency.musterPoints.some(kr=>kr.isPrimary)&&(vi.emergency.musterPoints[0].isPrimary=!0)):ai==="evacuationRoutes"||ai==="evacuationRoute"?Array.isArray((Wr=vi.emergency)==null?void 0:Wr.evacuationRoutes)&&(vi.emergency.evacuationRoutes=vi.emergency.evacuationRoutes.filter(kr=>kr.id!==li),vi.emergency.evacuationRoutes.length>0&&!vi.emergency.evacuationRoutes.some(kr=>kr.isPrimary)&&(vi.emergency.evacuationRoutes[0].isPrimary=!0)):vi[Pi]&&(vi[Pi][ai]=null),vi}),K(null))},[ie,ui]),$r=ue.useCallback((li,ai,Jt)=>{if(!ie)return;let Vi=ai;ai==="obstacle"&&(Vi="obstacles"),ai==="musterPoint"&&(Vi="musterPoints"),ai==="evacuationRoute"&&(Vi="evacuationRoutes");const fi=In[Vi];fi&&ui(vi=>{var er,Wr,kr,di;const Pi=JSON.parse(JSON.stringify(vi)),Nr=fi.layer;return ai==="obstacles"||ai==="obstacle"?Array.isArray((er=Pi.siteSurvey)==null?void 0:er.obstacles)&&(Pi.siteSurvey.obstacles=Pi.siteSurvey.obstacles.map(or=>or.id===li?{...or,...Jt,updatedAt:new Date().toISOString()}:or)):ai==="musterPoints"||ai==="musterPoint"?Array.isArray((Wr=Pi.emergency)==null?void 0:Wr.musterPoints)&&(Pi.emergency.musterPoints=Pi.emergency.musterPoints.map(or=>or.id===li?{...or,...Jt,updatedAt:new Date().toISOString()}:or)):ai==="evacuationRoutes"||ai==="evacuationRoute"?Array.isArray((kr=Pi.emergency)==null?void 0:kr.evacuationRoutes)&&(Pi.emergency.evacuationRoutes=Pi.emergency.evacuationRoutes.map(or=>or.id===li?{...or,...Jt,updatedAt:new Date().toISOString()}:or)):(di=Pi[Nr])!=null&&di[ai]&&(Pi[Nr][ai]={...Pi[Nr][ai],...Jt,updatedAt:new Date().toISOString()}),Pi})},[ie,ui]),nn=ue.useCallback((li=null)=>{if(!H||!$||$.id==="none")return;const{id:ai,type:Jt}=$;if(Jt==="marker"){const Vi=li||(he.length>0?{lng:he[he.length-1][0],lat:he[he.length-1][1]}:null);Vi&&Fi(ai,Vi)}else Jt==="polygon"?he.length>=3&&Ii(ai,he):Jt==="line"&&he.length>=2&&Bi(he);ht()},[H,$,he,Fi,Ii,Bi,ht]),Gn=ue.useCallback(()=>{oe(!1)},[]),Tr=ue.useCallback(()=>{oe(!0)},[]),jt=ue.useCallback((li,ai)=>{var Pi,Nr;if(!((Pi=li==null?void 0:li.geometry)!=null&&Pi.coordinates)||!((Nr=ai==null?void 0:ai.geometry)!=null&&Nr.coordinates))return null;const[Jt,Vi]=li.geometry.coordinates,[fi,vi]=ai.geometry.coordinates;return gre({lat:Vi,lng:Jt},{lat:vi,lng:fi})},[]);return ue.useEffect(()=>{o&&Ve.length>0?Ve.some(ai=>ai.id===o)||C(Ve[0].id):!o&&Ve.length>0&&C(Ve[0].id)},[Ve,o]),{sites:Ve,activeSiteId:o,activeSite:ie,activeMapData:ze,visibleLayers:R,drawingMode:$,isDrawing:H,drawingPoints:he,selectedElement:de,basemap:ge,showAllSites:q,activeSiteBounds:ve,allSitesBounds:Le,currentBounds:Ke,activeSiteStats:Pe,activeSiteValidation:It,visibleMapElements:tt,selectSite:zt,toggleLayer:vt,setLayerVisibility:Ot,showAllLayers:Et,hideAllLayers:yi,startDrawing:mi,cancelDrawing:ht,addDrawingPoint:hi,removeLastDrawingPoint:ni,completeDrawing:nn,setSelectedElement:K,setMarker:Fi,setPolygon:Ii,addEvacuationRoute:Bi,removeElement:Ki,updateElement:$r,updateSiteMapData:ui,fitToActiveSite:Gn,fitToAllSites:Tr,setBasemap:Ae,setMapCenter:Ce,setMapZoom:ae,mapCenter:Te,mapZoom:ne,setShowAllSites:oe,getDistanceBetween:jt,DRAWING_MODES:qh,MAP_LAYERS:Q0,MAP_ELEMENT_STYLES:In,MAP_BASEMAPS:J0}}const Cp=t=>{t.stopPropagation()};function kse({sites:t,activeSiteId:e,onSelectSite:r,onAddSite:c,onDuplicateSite:h,onDeleteSite:x,editMode:w=!1,compact:o=!1}){const[C,R]=ue.useState(null),[F,$]=ue.useState({top:0,left:0}),Y=ue.useCallback((X,he)=>{X.stopPropagation(),r(he)},[r]),H=ue.useCallback((X,he)=>{if(X.stopPropagation(),C===he)R(null);else{const se=X.currentTarget.getBoundingClientRect();$({top:se.bottom+4,left:se.right-144}),R(he)}},[C]);return o?n.jsx("div",{className:"relative pointer-events-auto",children:n.jsx("select",{value:e||"",onChange:X=>{X.stopPropagation(),r(X.target.value)},onClick:X=>X.stopPropagation(),className:"input text-sm py-1.5 pr-8",children:t.map(X=>n.jsx("option",{value:X.id,children:X.name},X.id))})}):n.jsxs("div",{className:"map-control-panel bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden pointer-events-auto",onWheel:Cp,children:[n.jsx("div",{className:"px-3 py-2 bg-gray-50 border-b border-gray-200",children:n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("span",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider",children:["Sites (",t.length,"/10)"]}),w&&t.length<10&&n.jsx("button",{type:"button",onClick:X=>{X.stopPropagation(),c==null||c()},className:"p-1 text-aeria-navy hover:bg-aeria-navy/10 rounded transition-colors",title:"Add new site",children:n.jsx(vr,{className:"w-4 h-4"})})]})}),n.jsx("div",{className:"max-h-60 overflow-y-auto",onWheel:Cp,style:{overscrollBehavior:"contain"},children:t.map((X,he)=>{const se=X.id===e,de=u3[X.status]||u3.draft;return n.jsxs("div",{className:`relative flex items-center gap-2 px-3 py-2 cursor-pointer transition-colors ${se?"bg-aeria-navy/10 border-l-2 border-aeria-navy":"hover:bg-gray-50 border-l-2 border-transparent"}`,onClick:K=>Y(K,X.id),children:[n.jsx("div",{className:"w-3 h-3 rounded-full flex-shrink-0",style:{backgroundColor:`hsl(${he*60}, 70%, 50%)`}}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsx("p",{className:`text-sm font-medium truncate ${se?"text-aeria-navy":"text-gray-900"}`,children:X.name}),n.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded ${de.color}`,children:de.label})]}),w&&n.jsx("button",{type:"button",onClick:K=>H(K,X.id),className:"p-1 text-gray-400 hover:text-gray-600 rounded",children:n.jsx(Qd,{className:"w-4 h-4"})})]},X.id)})}),C&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"fixed inset-0 z-[9998]",onClick:X=>{X.stopPropagation(),R(null)}}),n.jsxs("div",{className:"fixed w-36 bg-white rounded-lg shadow-xl border border-gray-200 py-1 z-[9999]",style:{top:F.top,left:Math.max(8,F.left)},children:[n.jsxs("button",{type:"button",onClick:X=>{X.stopPropagation(),h==null||h(C),R(null)},className:"w-full px-3 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2",children:[n.jsx(Op,{className:"w-4 h-4"}),"Duplicate"]}),t.length>1&&n.jsxs("button",{type:"button",onClick:X=>{X.stopPropagation(),x==null||x(C),R(null)},className:"w-full px-3 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2",children:[n.jsx(Ln,{className:"w-4 h-4"}),"Delete"]})]})]})]})}function BT({visibleLayers:t,onToggleLayer:e,allowedLayers:r=["siteSurvey","flightPlan","emergency"],compact:c=!1}){const[h,x]=ue.useState(!c),w=Object.entries(Q0).filter(([C])=>r.includes(C)),o=ue.useCallback((C,R)=>{C.stopPropagation(),e(R)},[e]);return c?n.jsx("div",{className:"flex gap-1 bg-white rounded-lg shadow-lg border border-gray-200 p-1 pointer-events-auto",children:w.map(([C,R])=>{const F=t[C];return n.jsx("button",{type:"button",onClick:$=>o($,C),className:`p-1.5 rounded transition-colors ${F?"bg-gray-100 text-gray-700":"text-gray-400 hover:bg-gray-50"}`,title:`${R.label} ${F?"(visible)":"(hidden)"}`,children:n.jsx("div",{className:"w-3 h-3 rounded-sm",style:{backgroundColor:F?R.color:"#ccc"}})},C)})}):n.jsxs("div",{className:"map-control-panel bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden pointer-events-auto",onWheel:Cp,children:[n.jsxs("button",{type:"button",onClick:C=>{C.stopPropagation(),x(R=>!R)},className:"w-full px-3 py-2 bg-gray-50 border-b border-gray-200 flex items-center justify-between hover:bg-gray-100 transition-colors",children:[n.jsxs("span",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider flex items-center gap-2",children:[n.jsx(vT,{className:"w-4 h-4"}),"Layers"]}),h?n.jsx($n,{className:"w-4 h-4 text-gray-400"}):n.jsx(fn,{className:"w-4 h-4 text-gray-400"})]}),h&&n.jsx("div",{className:"p-2 space-y-1",children:w.map(([C,R])=>{const F=t[C];return n.jsxs("button",{type:"button",onClick:$=>o($,C),className:`w-full flex items-center gap-3 px-2 py-1.5 rounded transition-colors hover:bg-gray-100 ${F?"bg-gray-50":"opacity-50"}`,children:[n.jsx("div",{className:"w-3 h-3 rounded-sm",style:{backgroundColor:R.color}}),n.jsx("span",{className:"flex-1 text-left text-sm text-gray-700",children:R.label}),F?n.jsx(ga,{className:"w-4 h-4 text-gray-500"}):n.jsx(v6,{className:"w-4 h-4 text-gray-400"})]},C)})})]})}function VT({drawingMode:t,isDrawing:e,drawingPoints:r,onStartDrawing:c,onCancelDrawing:h,onCompleteDrawing:x,onRemoveLastPoint:w,activeLayer:o="siteSurvey",editMode:C=!1}){var H;const[R,F]=ue.useState(!0);if(!C)return null;const Y={siteSurvey:[{mode:"siteLocation",icon:Wn,label:"Site Location"},{mode:"operationsBoundary",icon:vS,label:"Boundary"},{mode:"obstacle",icon:ir,label:"Obstacle"}],flightPlan:[{mode:"launchPoint",icon:Zn,label:"Launch"},{mode:"recoveryPoint",icon:go,label:"Recovery"},{mode:"pilotPosition",icon:fa,label:"Pilot"},{mode:"flightGeography",icon:vS,label:"Flight Area"}],emergency:[{mode:"musterPoint",icon:lf,label:"Muster"},{mode:"evacuationRoute",icon:cf,label:"Evac Route"}]}[o]||[];return n.jsxs("div",{className:"map-control-panel bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden pointer-events-auto",onWheel:Cp,children:[n.jsxs("button",{type:"button",onClick:X=>{X.stopPropagation(),F(he=>!he)},className:"w-full px-3 py-2 bg-gray-50 border-b border-gray-200 flex items-center justify-between hover:bg-gray-100 transition-colors",children:[n.jsxs("span",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider flex items-center gap-2",children:[n.jsx(Vie,{className:"w-4 h-4"}),"Drawing Tools"]}),R?n.jsx($n,{className:"w-4 h-4 text-gray-400"}):n.jsx(fn,{className:"w-4 h-4 text-gray-400"})]}),R&&n.jsxs("div",{className:"p-2 max-h-64 overflow-y-auto",onWheel:Cp,style:{overscrollBehavior:"contain"},children:[e&&n.jsxs("div",{className:"mb-2 p-2 bg-aeria-navy/10 rounded-lg",children:[n.jsx("p",{className:"text-xs font-medium text-aeria-navy mb-1",children:((H=qh[t.id])==null?void 0:H.label)||"Drawing"}),t.type==="polygon"&&n.jsxs("p",{className:"text-xs text-gray-600",children:["Points: ",r.length," (need 3+)"]}),t.type==="line"&&n.jsxs("p",{className:"text-xs text-gray-600",children:["Points: ",r.length," (need 2+)"]}),n.jsxs("div",{className:"flex gap-1 mt-2",children:[r.length>0&&n.jsx("button",{type:"button",onClick:X=>{X.stopPropagation(),w()},className:"flex-1 px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200",children:"Undo"}),n.jsx("button",{type:"button",onClick:X=>{X.stopPropagation(),h()},className:"flex-1 px-2 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200",children:"Cancel"}),(t.type==="polygon"&&r.length>=3||t.type==="line"&&r.length>=2)&&n.jsx("button",{type:"button",onClick:X=>{X.stopPropagation(),x()},className:"flex-1 px-2 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200",children:"Done"})]})]}),n.jsx("div",{className:"grid grid-cols-2 gap-1",children:Y.map(({mode:X,icon:he,label:se})=>{const de=t.id===X;return n.jsxs("button",{type:"button",onClick:K=>{K.stopPropagation(),de?h():c(X)},disabled:e&&!de,className:`flex items-center gap-2 px-2 py-1.5 rounded text-sm transition-colors ${de?"bg-aeria-navy text-white":e?"bg-gray-100 text-gray-400 cursor-not-allowed":"bg-gray-50 text-gray-700 hover:bg-gray-100"}`,children:[n.jsx(he,{className:"w-4 h-4"}),n.jsx("span",{className:"truncate",children:se})]},X)})})]})]})}function Dse({currentBasemap:t,onChangeBasemap:e}){const[r,c]=ue.useState(!1),h=Object.entries(J0),x=J0[t]||J0.streets,w=x.icon==="map"?n3:x.icon==="globe"?i3:xS;return n.jsxs("div",{className:"map-control-panel relative pointer-events-auto",children:[n.jsx("button",{type:"button",onClick:o=>{o.stopPropagation(),c(C=>!C)},className:"p-2 bg-white rounded-lg shadow border border-gray-200 text-gray-700 hover:bg-gray-50 transition-colors",title:"Change basemap",children:n.jsx(w,{className:"w-5 h-5"})}),r&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"fixed inset-0 z-30",onClick:o=>{o.stopPropagation(),c(!1)}}),n.jsx("div",{className:"absolute bottom-full right-0 mb-2 bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden z-40",onWheel:Cp,children:h.map(([o,C])=>{const R=C.icon==="map"?n3:C.icon==="globe"?i3:xS,F=o===t;return n.jsxs("button",{type:"button",onClick:$=>{$.stopPropagation(),e(o),c(!1)},className:`w-full px-3 py-2 text-left text-sm flex items-center gap-2 transition-colors ${F?"bg-aeria-navy/10 text-aeria-navy":"text-gray-700 hover:bg-gray-50"}`,children:[n.jsx(R,{className:"w-4 h-4"}),C.label,F&&n.jsx(ru,{className:"w-4 h-4 ml-auto"})]},o)})})]})]})}function Mse({onFitToSite:t,onFitToAll:e,onZoomIn:r,onZoomOut:c,showAllSites:h,isFullscreen:x=!1,onToggleFullscreen:w}){return n.jsxs("div",{className:"map-control-panel flex flex-col gap-1 bg-white rounded-lg shadow border border-gray-200 p-1 pointer-events-auto",onWheel:Cp,children:[n.jsx("button",{type:"button",onClick:o=>{o.stopPropagation(),r()},className:"p-2 text-gray-700 hover:bg-gray-100 rounded transition-colors",title:"Zoom in",children:n.jsx(vr,{className:"w-5 h-5"})}),n.jsx("button",{type:"button",onClick:o=>{o.stopPropagation(),c()},className:"p-2 text-gray-700 hover:bg-gray-100 rounded transition-colors",title:"Zoom out",children:n.jsx(Fie,{className:"w-5 h-5"})}),n.jsx("div",{className:"w-full h-px bg-gray-200 my-1"}),n.jsx("button",{type:"button",onClick:o=>{o.stopPropagation(),t()},className:`p-2 rounded transition-colors ${h?"text-gray-700 hover:bg-gray-100":"text-aeria-navy bg-aeria-navy/10"}`,title:"Fit to active site",children:n.jsx(go,{className:"w-5 h-5"})}),n.jsx("button",{type:"button",onClick:o=>{o.stopPropagation(),e()},className:`p-2 rounded transition-colors ${h?"text-aeria-navy bg-aeria-navy/10":"text-gray-700 hover:bg-gray-100"}`,title:"Fit to all sites",children:n.jsx(Oie,{className:"w-5 h-5"})}),w&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"w-full h-px bg-gray-200 my-1"}),n.jsx("button",{type:"button",onClick:o=>{o.stopPropagation(),w()},className:`p-2 rounded transition-colors ${x?"text-aeria-navy bg-aeria-navy/10":"text-gray-700 hover:bg-gray-100"}`,title:x?"Exit fullscreen":"Expand map",children:x?n.jsx(N6,{className:"w-5 h-5"}):n.jsx(_6,{className:"w-5 h-5"})})]})]})}function Ose({isFullscreen:t,onToggleFullscreen:e}){return e?n.jsx("button",{type:"button",onClick:r=>{r.stopPropagation(),e()},className:`p-2.5 bg-white rounded-lg shadow-lg border border-gray-300 transition-all pointer-events-auto hover:shadow-xl ${t?"text-aeria-navy bg-aeria-navy/10 ring-2 ring-aeria-navy":"text-gray-700 hover:bg-gray-50 hover:border-gray-400"}`,title:t?"Exit fullscreen (Esc)":"Expand map",children:t?n.jsx(N6,{className:"w-5 h-5"}):n.jsx(_6,{className:"w-5 h-5"})}):null}function Lse({sites:t,activeSiteId:e,onSelectSite:r,onAddSite:c,onDuplicateSite:h,onDeleteSite:x,visibleLayers:w,onToggleLayer:o,allowedLayers:C,drawingMode:R,isDrawing:F,drawingPoints:$,onStartDrawing:Y,onCancelDrawing:H,onCompleteDrawing:X,onRemoveLastPoint:he,activeLayer:se,currentBasemap:de,onChangeBasemap:K,onFitToSite:ge,onFitToAll:Ae,onZoomIn:Te,onZoomOut:Ce,showAllSites:ne,isFullscreen:ae=!1,onToggleFullscreen:q,editMode:oe=!1,position:ke="left"}){const Ve=ke==="right"?"right-4":"left-4";return n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:`map-control-panel absolute top-4 ${Ve} z-50 flex flex-col gap-3 max-h-[calc(100%-8rem)] overflow-y-auto pointer-events-auto`,style:{overscrollBehavior:"contain"},onWheel:Cp,children:[n.jsx(kse,{sites:t,activeSiteId:e,onSelectSite:r,onAddSite:c,onDuplicateSite:h,onDeleteSite:x,editMode:oe}),n.jsx(BT,{visibleLayers:w,onToggleLayer:o,allowedLayers:C}),oe&&n.jsx(VT,{drawingMode:R,isDrawing:F,drawingPoints:$,onStartDrawing:Y,onCancelDrawing:H,onCompleteDrawing:X,onRemoveLastPoint:he,activeLayer:se,editMode:oe})]}),n.jsxs("div",{className:"map-control-panel absolute bottom-4 right-4 z-50 flex items-end gap-2 pointer-events-auto",children:[n.jsx(Dse,{currentBasemap:de,onChangeBasemap:K}),n.jsx(Mse,{onFitToSite:ge,onFitToAll:Ae,onZoomIn:Te,onZoomOut:Ce,showAllSites:ne,isFullscreen:ae,onToggleFullscreen:q})]})]})}function Vc({icon:t,label:e,color:r,type:c="marker",strokeStyle:h="solid",fillOpacity:x=.1,description:w}){const[o,C]=ue.useState(!1);return n.jsxs("div",{className:"flex items-center gap-2 py-1 relative",onMouseEnter:()=>C(!0),onMouseLeave:()=>C(!1),children:[c==="marker"&&n.jsx("div",{className:"w-5 h-5 flex items-center justify-center rounded-full",style:{backgroundColor:`${r}20`,border:`2px solid ${r}`},children:t&&n.jsx(t,{className:"w-3 h-3",style:{color:r}})}),c==="polygon"&&n.jsx("div",{className:"w-5 h-4 rounded-sm",style:{backgroundColor:`${r}${Math.round(x*255).toString(16).padStart(2,"0")}`,border:`2px ${h} ${r}`}}),c==="line"&&n.jsxs("div",{className:"w-5 flex items-center",children:[n.jsx("div",{className:"w-full h-0.5",style:{backgroundColor:r,borderStyle:h}}),n.jsx(fc,{className:"w-3 h-3 -ml-1",style:{color:r}})]}),n.jsx("span",{className:"text-xs text-gray-700 flex-1",children:e}),w&&n.jsx(Ns,{className:"w-3 h-3 text-gray-400"}),o&&w&&n.jsx("div",{className:"absolute left-full ml-2 px-2 py-1 bg-gray-900 text-white text-xs rounded shadow-lg z-50 whitespace-nowrap",children:w})]})}function MC({title:t,color:e,children:r,defaultExpanded:c=!0}){const[h,x]=ue.useState(c);return n.jsxs("div",{className:"border-b border-gray-100 last:border-0",children:[n.jsxs("button",{onClick:()=>x(!h),className:"w-full flex items-center gap-2 px-2 py-1.5 hover:bg-gray-50 transition-colors",children:[n.jsx("div",{className:"w-2 h-2 rounded-full",style:{backgroundColor:e}}),n.jsx("span",{className:"text-xs font-medium text-gray-700 flex-1 text-left",children:t}),h?n.jsx($n,{className:"w-3 h-3 text-gray-400"}):n.jsx(fn,{className:"w-3 h-3 text-gray-400"})]}),h&&n.jsx("div",{className:"px-2 pb-2 pl-4",children:r})]})}function Fse({visibleLayers:t={siteSurvey:!0,flightPlan:!0,emergency:!0},compact:e=!1,position:r="bottom-left"}){const[c,h]=ue.useState(!e),x={"bottom-left":"bottom-4 left-4","bottom-right":"bottom-4 right-4","top-left":"top-4 left-4","top-right":"top-4 right-4"};return e&&!c?n.jsx("button",{onClick:()=>h(!0),className:`absolute ${x[r]} z-10 p-2 bg-white rounded-lg shadow-lg border border-gray-200 hover:bg-gray-50 transition-colors`,title:"Show legend",children:n.jsx(Ns,{className:"w-5 h-5 text-gray-600"})}):n.jsxs("div",{className:`${e?`absolute ${x[r]} z-10`:""} bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden min-w-[180px]`,children:[n.jsxs("div",{className:"px-3 py-2 bg-gray-50 border-b border-gray-200 flex items-center justify-between",children:[n.jsx("span",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider",children:"Legend"}),e&&n.jsx("button",{onClick:()=>h(!1),className:"p-1 text-gray-400 hover:text-gray-600 rounded",children:n.jsx(fn,{className:"w-4 h-4"})})]}),n.jsxs("div",{className:"max-h-80 overflow-y-auto",children:[t.siteSurvey&&n.jsxs(MC,{title:"Site Survey",color:Q0.siteSurvey.color,children:[n.jsx(Vc,{icon:Wn,label:"Site Location",color:In.siteLocation.color,type:"marker",description:"Center point of operation site"}),n.jsx(Vc,{label:"Operations Boundary",color:In.operationsBoundary.color,type:"polygon",fillOpacity:In.operationsBoundary.fillOpacity,strokeStyle:In.operationsBoundary.strokeStyle,description:"Area where operations will take place"}),n.jsx(Vc,{icon:ir,label:"Obstacle",color:In.obstacles.color,type:"marker",description:"Identified obstacles (towers, wires, etc.)"})]}),t.flightPlan&&n.jsxs(MC,{title:"Flight Plan",color:Q0.flightPlan.color,children:[n.jsx(Vc,{icon:cf,label:"Launch Point",color:In.launchPoint.color,type:"marker",description:"RPAS launch/takeoff location"}),n.jsx(Vc,{icon:go,label:"Recovery Point",color:In.recoveryPoint.color,type:"marker",description:"RPAS landing/recovery location"}),n.jsx(Vc,{icon:g6,label:"Pilot Position",color:In.pilotPosition.color,type:"marker",description:"Remote pilot operating position"}),n.jsx(Vc,{label:"Flight Geography",color:In.flightGeography.color,type:"polygon",fillOpacity:In.flightGeography.fillOpacity,strokeStyle:"dashed",description:"Intended flight area (SORA)"}),n.jsx(Vc,{label:"Contingency Volume",color:In.contingencyVolume.color,type:"polygon",fillOpacity:In.contingencyVolume.fillOpacity,strokeStyle:"dotted",description:"Buffer for abnormal situations"}),n.jsx(Vc,{label:"Ground Risk Buffer",color:In.groundRiskBuffer.color,type:"polygon",fillOpacity:In.groundRiskBuffer.fillOpacity,strokeStyle:"dotted",description:"Extended ground risk area"})]}),t.emergency&&n.jsxs(MC,{title:"Emergency",color:Q0.emergency.color,children:[n.jsx(Vc,{icon:lf,label:"Muster Point",color:In.musterPoints.color,type:"marker",description:"Emergency assembly location"}),n.jsx(Vc,{label:"Evacuation Route",color:In.evacuationRoutes.color,type:"line",strokeStyle:"solid",description:"Primary evacuation path"})]})]})]})}function zse({sites:t,activeSiteId:e}){return!Array.isArray(t)||t.length<=1?null:n.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 p-2",children:[n.jsx("p",{className:"text-xs font-medium text-gray-500 mb-1",children:"Sites"}),n.jsx("div",{className:"space-y-1",children:t.map((r,c)=>{const h=r.id===e,x=`hsl(${c*60}, 70%, 50%)`;return n.jsxs("div",{className:`flex items-center gap-2 px-1 py-0.5 rounded ${h?"bg-gray-100":""}`,children:[n.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:x}}),n.jsx("span",{className:`text-xs ${h?"font-medium text-gray-900":"text-gray-600"}`,children:r.name})]},r.id)})})]})}if(typeof document<"u"){const t="aeria-map-animations";if(!document.getElementById(t)){const e=document.createElement("style");e.id=t,e.textContent=`
      @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.6; transform: scale(1.1); }
      }
    `,document.head.appendChild(e)}}const R3={"map-pin":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="white" stroke-width="1"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3" fill="white"/></svg>',"alert-triangle":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="white" stroke-width="1"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13" stroke="white" stroke-width="2"/><circle cx="12" cy="17" r="1" fill="white"/></svg>',"plane-takeoff":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M2 22h20M6.36 17.4 4 17l-2-4 1.1-.55a2 2 0 0 1 1.8 0l.17.1a2 2 0 0 0 1.8 0L8 12 5 6l.9-.45a2 2 0 0 1 2.09.2l4.02 3a2 2 0 0 0 2.1.2l4.19-2.06a2.41 2.41 0 0 1 1.73-.17L21 7a1.4 1.4 0 0 1 .87 1.99l-.38.76c-.23.46-.6.84-1.07 1.08L7.58 17.2a2 2 0 0 1-1.22.18Z"/></svg>',"plane-landing":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M2 22h20M3.77 10.77 2 9l2-4 1.1.55a2 2 0 0 1 .9 1.48l.26 1.97a2 2 0 0 0 .9 1.48L9 10l-1-6 1.1-.55a2 2 0 0 1 2.12.19l4.16 3.12a2 2 0 0 0 2.12.19l4.8-2.4a2.41 2.41 0 0 1 1.73-.17L21 5a1.4 1.4 0 0 1 .87 1.99l-.38.76a2 2 0 0 1-1.07 1.08l-12 5.23a2 2 0 0 1-1.64-.01l-3.01-1.28Z"/></svg>',user:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 1 0-16 0"/></svg>',flag:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="white" stroke-width="1"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15" stroke="currentColor" stroke-width="2"/></svg>',target:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" fill="white"/><circle cx="12" cy="12" r="6" fill="currentColor"/><circle cx="12" cy="12" r="2" fill="white"/></svg>'},Bse=(t,e="map-pin",r=32)=>{const c=document.createElement("div");c.className="map-marker",c.style.width=`${r}px`,c.style.height=`${r}px`,c.style.cursor="pointer",c.style.transition="filter 0.15s ease, transform 0.15s ease";const h=R3[e]||R3["map-pin"];return c.innerHTML=h.replace("currentColor",t),c},Vse=(t,e)=>{e?(t.style.filter="drop-shadow(0 0 8px rgba(59, 130, 246, 0.9))",t.style.transform="scale(1.15)",t.classList.add("map-marker-selected")):(t.style.filter="",t.style.transform="",t.classList.remove("map-marker-selected"))};function Wj({project:t,onUpdate:e,editMode:r=!1,activeLayer:c="siteSurvey",height:h="500px",showControls:x=!0,showLegend:w=!0,allowedLayers:o=["siteSurvey","flightPlan","emergency"],onSiteChange:C,onElementSelect:R,className:F="",externalMapData:$=null}){var Da,ms,pt,oi,Mi,qi,Xn,mr,sn,al,Ma,fs,ol,ll,wt,Xa;const Y=ue.useRef(null),H=ue.useRef(null),X=ue.useRef({});ue.useRef(null);const he=ue.useRef([]),se=ue.useRef([]),de=ue.useRef(!1),K=ue.useRef(qh.none),ge=ue.useRef(null),Ae=ue.useRef(null),Te=ue.useRef(r),Ce=ue.useRef(jt),ne=ue.useRef("streets"),[ae,q]=ue.useState(!1),[oe,ke]=ue.useState(null),[Ve,ie]=ue.useState(!navigator.onLine),[ze,ve]=ue.useState(!1),[Le,Ke]=ue.useState(0),Pe=zT(t,e,{editMode:r,allowedLayers:o,initialBasemap:"streets"}),It=$||Pe,{sites:tt,activeSiteId:zt,activeSite:vt,visibleLayers:Ot,drawingMode:Et,isDrawing:yi,drawingPoints:mi,selectedElement:ht,basemap:hi,showAllSites:ni,currentBounds:ui,visibleMapElements:Fi,selectSite:Ii,toggleLayer:Bi,startDrawing:Ki,cancelDrawing:$r,addDrawingPoint:nn,removeLastDrawingPoint:Gn,completeDrawing:Tr,setSelectedElement:jt,setMarker:bi,setPolygon:ar,addEvacuationRoute:li,removeElement:ai,updateElement:Jt,setBasemap:Vi,fitToActiveSite:fi,fitToAllSites:vi,setShowAllSites:Pi}=It;ue.useEffect(()=>{de.current=yi},[yi]),ue.useEffect(()=>{K.current=Et},[Et]),ue.useEffect(()=>{ge.current=Tr},[Tr]),ue.useEffect(()=>{Ae.current=nn},[nn]),ue.useEffect(()=>{Te.current=r},[r]),ue.useEffect(()=>{Ce.current=jt},[jt]),ue.useEffect(()=>{if(!r)return;const Oi=Xr=>{(Xr.key==="Delete"||Xr.key==="Backspace")&&ht&&(Xr.preventDefault(),ai==null||ai(ht.id,ht.elementType)),Xr.key==="Escape"&&ht&&jt(null)};return window.addEventListener("keydown",Oi),()=>window.removeEventListener("keydown",Oi)},[r,ht,ai,jt]),ue.useEffect(()=>{if(!(!Y.current||H.current)){ke("Mapbox token not configured. Please set VITE_MAPBOX_TOKEN in your environment.");return}},[]),ue.useEffect(()=>{var Ze;if(!H.current||!ae)return;const Oi=H.current,Xr=(Ze=J0[hi])==null?void 0:Ze.style;if(!Xr)return;if(hi===ne.current&&ne.current!==null){ne.current=null;return}const Zi=()=>{Ke(te=>te+1)};return Oi.once("style.load",Zi),Oi.setStyle(Xr),()=>{Oi.off("style.load",Zi)}},[hi,ae]),ue.useEffect(()=>{!H.current||!ae||!ui||H.current.fitBounds(ui,{padding:50,maxZoom:16,duration:500})},[ui,ae]),ue.useEffect(()=>{if(!H.current||!ae)return;Object.values(X.current).forEach(Xr=>Xr.remove()),X.current={};const Oi=(Xr,Zi)=>{Xr.forEach(Ze=>{var At,St,Ht;if(!((At=Ze==null?void 0:Ze.geometry)!=null&&At.coordinates))return;const[te,pe]=Ze.geometry.coordinates,Ne=In[Ze.elementType]||{},Ue=Ze._siteColor||Ne.color||"#3B82F6",Ie=Ne.icon||"map-pin",Xe=Bse(Ue,Ie,Ze.isActive?32:24);Xe.dataset.markerId=Ze.id,Xe.addEventListener("click",ci=>{ci.stopPropagation(),jt(Ze),R==null||R(Ze)});const Je=new T3.Popup({offset:25,closeButton:!1}).setHTML(`
          <div class="text-sm">
            <p class="font-medium">${((St=Ze.properties)==null?void 0:St.label)||Ne.label||"Marker"}</p>
            ${Ze.siteName?`<p class="text-gray-500 text-xs">${Ze.siteName}</p>`:""}
            ${(Ht=Ze.properties)!=null&&Ht.description?`<p class="text-gray-600 text-xs mt-1">${Ze.properties.description}</p>`:""}
            ${r&&Ze.isActive?'<p class="text-blue-500 text-xs mt-1 font-medium">Drag to move  Click to select</p>':""}
          </div>
        `),He=r&&Ze.isActive,it=new T3.Marker({element:Xe,draggable:He,anchor:"center"}).setLngLat([te,pe]).setPopup(Je).addTo(H.current);He&&it.on("dragend",()=>{const ci=it.getLngLat();Jt==null||Jt(Ze.id,Ze.elementType,{geometry:{type:"Point",coordinates:[ci.lng,ci.lat]}})}),X.current[Ze.id]=it})};Oi(Fi.siteSurvey.markers),Oi(Fi.flightPlan.markers),Oi(Fi.emergency.markers)},[Fi,ae,jt,R,r,Jt]),ue.useEffect(()=>{Object.entries(X.current).forEach(([Oi,Xr])=>{const Zi=Xr.getElement();Zi&&Vse(Zi,(ht==null?void 0:ht.id)===Oi)})},[ht]),ue.useEffect(()=>{if(!H.current||!ae)return;const Oi=H.current;["polygons-fill","polygons-outline","lines","hatched-polygons-fill","hatched-polygons-outline","hatched-polygons-inner"].forEach(Je=>{Oi.getLayer(Je)&&Oi.removeLayer(Je)}),["polygons-source","lines-source","hatched-polygons-source"].forEach(Je=>{Oi.getSource(Je)&&Oi.removeSource(Je)});const Ze=[...Fi.siteSurvey.polygons,...Fi.flightPlan.polygons].filter(Je=>{var He,it,At;return((At=(it=(He=Je==null?void 0:Je.geometry)==null?void 0:He.coordinates)==null?void 0:it[0])==null?void 0:At.length)>0}),te=Ze.filter(Je=>Je.elementType!=="flightGeography"),pe=Ze.filter(Je=>Je.elementType==="flightGeography"),Ne=[...Fi.emergency.lines||[]].filter(Je=>{var He,it;return((it=(He=Je==null?void 0:Je.geometry)==null?void 0:He.coordinates)==null?void 0:it.length)>0});if(te.length>0){const Je=te.map(He=>{const it=In[He.elementType]||{},At=He._siteColor||it.color||"#3B82F6";return{type:"Feature",properties:{id:He.id,color:At,fillOpacity:it.fillOpacity||.1,strokeWidth:it.strokeWidth||2,isActive:He.isActive},geometry:He.geometry}});Oi.addSource("polygons-source",{type:"geojson",data:{type:"FeatureCollection",features:Je}}),Oi.addLayer({id:"polygons-fill",type:"fill",source:"polygons-source",paint:{"fill-color":["get","color"],"fill-opacity":["get","fillOpacity"]}}),Oi.addLayer({id:"polygons-outline",type:"line",source:"polygons-source",paint:{"line-color":["get","color"],"line-width":["get","strokeWidth"],"line-opacity":["case",["get","isActive"],1,.6]}})}if(pe.length>0){const Je=pe.map(He=>{const it=In[He.elementType]||{},At=He._siteColor||it.color||"#10B981";return{type:"Feature",properties:{id:He.id,color:At,isActive:He.isActive},geometry:He.geometry}});Oi.addSource("hatched-polygons-source",{type:"geojson",data:{type:"FeatureCollection",features:Je}}),Oi.addLayer({id:"hatched-polygons-fill",type:"fill",source:"hatched-polygons-source",paint:{"fill-color":["get","color"],"fill-opacity":.05}}),Oi.addLayer({id:"hatched-polygons-outline",type:"line",source:"hatched-polygons-source",paint:{"line-color":["get","color"],"line-width":2.5,"line-opacity":["case",["get","isActive"],1,.7],"line-dasharray":[4,3]}}),Oi.addLayer({id:"hatched-polygons-inner",type:"line",source:"hatched-polygons-source",paint:{"line-color":["get","color"],"line-width":1,"line-opacity":["case",["get","isActive"],.5,.3],"line-dasharray":[2,4],"line-offset":-8}})}if(Ne.length>0){const Je=Ne.map(He=>{const it=In[He.elementType]||{},At=He._siteColor||it.color||"#EF4444";return{type:"Feature",properties:{id:He.id,color:At,strokeWidth:it.strokeWidth||3,isActive:He.isActive},geometry:He.geometry}});Oi.addSource("lines-source",{type:"geojson",data:{type:"FeatureCollection",features:Je}}),Oi.addLayer({id:"lines",type:"line",source:"lines-source",paint:{"line-color":["get","color"],"line-width":["get","strokeWidth"],"line-opacity":["case",["get","isActive"],1,.6]},layout:{"line-cap":"round","line-join":"round"}})}he.current=[...te,...pe],se.current=Ne;const Ue=["polygons-fill","hatched-polygons-fill","lines"],Ie=()=>{Te.current&&!de.current&&(Oi.getCanvas().style.cursor="pointer")},Xe=()=>{Oi.getCanvas().style.cursor=de.current?"crosshair":"grab"};return Ue.forEach(Je=>{Oi.getLayer(Je)&&(Oi.on("mouseenter",Je,Ie),Oi.on("mouseleave",Je,Xe))}),()=>{Ue.forEach(Je=>{Oi.getLayer(Je)&&(Oi.off("mouseenter",Je,Ie),Oi.off("mouseleave",Je,Xe))})}},[Fi,ae,Le]),ue.useEffect(()=>{if(!H.current||!ae)return;const Oi=H.current,Xr="drawing-preview",Zi="drawing-preview-line",Ze="drawing-preview-points";if(Oi.getLayer(Zi)&&Oi.removeLayer(Zi),Oi.getLayer(Ze)&&Oi.removeLayer(Ze),Oi.getSource(Xr)&&Oi.removeSource(Xr),!yi||mi.length===0)return;const pe=(In[Et.id]||{}).color||"#3B82F6",Ne=[];if(mi.length>=2){const Ue=[...mi];Et.type==="polygon"&&mi.length>=3&&Ue.push(mi[0]),Ne.push({type:"Feature",properties:{type:"line"},geometry:{type:"LineString",coordinates:Ue}})}mi.forEach((Ue,Ie)=>{Ne.push({type:"Feature",properties:{type:"point",index:Ie},geometry:{type:"Point",coordinates:Ue}})}),Oi.addSource(Xr,{type:"geojson",data:{type:"FeatureCollection",features:Ne}}),Oi.addLayer({id:Zi,type:"line",source:Xr,filter:["==",["get","type"],"line"],paint:{"line-color":pe,"line-width":2,"line-dasharray":[2,2]}}),Oi.addLayer({id:Ze,type:"circle",source:Xr,filter:["==",["get","type"],"point"],paint:{"circle-radius":6,"circle-color":"#FFFFFF","circle-stroke-color":pe,"circle-stroke-width":2}})},[yi,mi,Et,ae,Le]),ue.useEffect(()=>{if(!H.current)return;const Oi=yi?"crosshair":"grab";H.current.getCanvas().style.cursor=Oi},[yi]),ue.useEffect(()=>{const Oi=()=>ie(!1),Xr=()=>ie(!0);return window.addEventListener("online",Oi),window.addEventListener("offline",Xr),()=>{window.removeEventListener("online",Oi),window.removeEventListener("offline",Xr)}},[]);const Nr=ue.useCallback(Oi=>{Ii(Oi),C==null||C(Oi)},[Ii,C]),er=ue.useCallback(()=>{console.log("Add site requested")},[]),Wr=ue.useCallback(Oi=>{console.log("Duplicate site:",Oi)},[]),kr=ue.useCallback(Oi=>{confirm("Are you sure you want to delete this site?")&&console.log("Delete site:",Oi)},[]),di=ue.useCallback(()=>{H.current&&H.current.zoomIn()},[]),or=ue.useCallback(()=>{H.current&&H.current.zoomOut()},[]),jn=ue.useCallback(()=>{ve(Oi=>!Oi)},[]);return ue.useEffect(()=>{H.current&&setTimeout(()=>{var Oi;(Oi=H.current)==null||Oi.resize()},50)},[ze]),ue.useEffect(()=>{const Oi=Xr=>{Xr.key==="Escape"&&ze&&ve(!1)};return window.addEventListener("keydown",Oi),()=>window.removeEventListener("keydown",Oi)},[ze]),oe?n.jsx("div",{className:`bg-gray-100 rounded-lg flex items-center justify-center ${F}`,style:{height:h},children:n.jsxs("div",{className:"text-center p-6",children:[n.jsx(Cs,{className:"w-12 h-12 text-red-500 mx-auto mb-3"}),n.jsx("p",{className:"text-gray-700 font-medium mb-2",children:"Map Error"}),n.jsx("p",{className:"text-gray-500 text-sm",children:oe})]})}):n.jsxs("div",{className:`relative bg-gray-100 overflow-hidden ${ze?"fixed inset-0 z-[9999]":"rounded-lg"} ${F}`,style:{height:ze?"100vh":h},children:[n.jsx("div",{ref:Y,className:"absolute inset-0"}),!ae&&n.jsx("div",{className:"absolute inset-0 bg-white/80 flex items-center justify-center z-20",children:n.jsxs("div",{className:"text-center",children:[n.jsx(Ro,{className:"w-8 h-8 text-aeria-navy animate-spin mx-auto mb-2"}),n.jsx("p",{className:"text-sm text-gray-600",children:"Loading map..."})]})}),Ve&&n.jsxs("div",{className:"absolute top-4 left-1/2 -translate-x-1/2 z-20 px-3 py-1.5 bg-amber-100 text-amber-800 rounded-full text-sm font-medium flex items-center gap-2",children:[n.jsx(rre,{className:"w-4 h-4"}),"Offline Mode"]}),x&&ae&&n.jsx(Lse,{sites:tt,activeSiteId:zt,onSelectSite:Nr,onAddSite:er,onDuplicateSite:Wr,onDeleteSite:kr,visibleLayers:Ot,onToggleLayer:Bi,allowedLayers:o,drawingMode:Et,isDrawing:yi,drawingPoints:mi,onStartDrawing:Ki,onCancelDrawing:$r,onCompleteDrawing:Tr,onRemoveLastPoint:Gn,activeLayer:c,currentBasemap:hi,onChangeBasemap:Vi,onFitToSite:fi,onFitToAll:vi,onZoomIn:di,onZoomOut:or,showAllSites:ni,editMode:r,isFullscreen:ze,onToggleFullscreen:jn}),!x&&ae&&n.jsx("div",{className:"absolute bottom-20 right-4 z-30",children:n.jsx(Ose,{isFullscreen:ze,onToggleFullscreen:jn})}),w&&ae&&n.jsx("div",{className:"absolute bottom-4 left-4 z-10",children:n.jsx(Fse,{visibleLayers:Ot,compact:!0,position:"bottom-left"})}),ni&&tt.length>1&&ae&&n.jsx("div",{className:"absolute top-4 right-4 z-10",children:n.jsx(zse,{sites:tt,activeSiteId:zt})}),r&&ht&&n.jsxs("div",{className:"absolute bottom-20 left-1/2 -translate-x-1/2 z-20 bg-white rounded-lg shadow-xl border border-gray-200 p-3 min-w-[200px] max-w-[280px]",children:[n.jsxs("div",{className:"flex items-start justify-between gap-3",children:[n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsx("p",{className:"font-medium text-gray-900 text-sm truncate",children:((Da=ht.properties)==null?void 0:Da.label)||((ms=In[ht.elementType])==null?void 0:ms.label)||"Selected Element"}),n.jsxs("p",{className:"text-xs text-gray-500 mt-0.5",children:[ht.elementType,((pt=ht.geometry)==null?void 0:pt.type)==="Polygon"&&" (boundary)",((oi=ht.geometry)==null?void 0:oi.type)==="LineString"&&" (route)"]}),((Mi=ht.geometry)==null?void 0:Mi.coordinates)&&ht.geometry.type==="Point"&&n.jsxs("p",{className:"text-xs text-gray-400 mt-1 font-mono",children:[(qi=ht.geometry.coordinates[1])==null?void 0:qi.toFixed(6),", ",(Xn=ht.geometry.coordinates[0])==null?void 0:Xn.toFixed(6)]}),((mr=ht.geometry)==null?void 0:mr.type)==="Polygon"&&n.jsxs("p",{className:"text-xs text-gray-400 mt-1",children:[((al=(sn=ht.geometry.coordinates)==null?void 0:sn[0])==null?void 0:al.length)-1||0," vertices",((Ma=ht.properties)==null?void 0:Ma.area)&&`  ${(ht.properties.area/1e4).toFixed(2)} ha`]}),((fs=ht.geometry)==null?void 0:fs.type)==="LineString"&&n.jsxs("p",{className:"text-xs text-gray-400 mt-1",children:[((ol=ht.geometry.coordinates)==null?void 0:ol.length)||0," points",((ll=ht.properties)==null?void 0:ll.distance)&&`  ${ht.properties.distance.toFixed(0)}m`]})]}),n.jsx("button",{onClick:()=>{ai==null||ai(ht.id,ht.elementType),jt(null)},className:"flex-shrink-0 p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors",title:"Delete element (Del)",children:n.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[n.jsx("path",{d:"M3 6h18"}),n.jsx("path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"}),n.jsx("path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"}),n.jsx("line",{x1:"10",y1:"11",x2:"10",y2:"17"}),n.jsx("line",{x1:"14",y1:"11",x2:"14",y2:"17"})]})})]}),n.jsxs("div",{className:"mt-2 pt-2 border-t border-gray-100 flex items-center gap-2 text-xs text-gray-500",children:[((wt=ht.geometry)==null?void 0:wt.type)==="Point"&&n.jsxs(n.Fragment,{children:[n.jsx("span",{className:"bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded",children:"Drag"}),n.jsx("span",{children:"to move"}),n.jsx("span",{className:"mx-1",children:"|"})]}),n.jsx("span",{className:"bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded",children:"Del"}),n.jsx("span",{children:"to delete"}),((Xa=ht.geometry)==null?void 0:Xa.type)!=="Point"&&n.jsxs(n.Fragment,{children:[n.jsx("span",{className:"mx-1",children:"|"}),n.jsx("span",{className:"bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded",children:"Esc"}),n.jsx("span",{children:"to deselect"})]})]}),n.jsx("button",{onClick:()=>jt(null),className:"absolute -top-2 -right-2 w-5 h-5 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center text-gray-500 text-xs",children:""})]}),yi&&n.jsxs("div",{className:"absolute bottom-4 left-1/2 -translate-x-1/2 z-20 px-4 py-2 bg-aeria-navy text-white rounded-lg shadow-lg text-sm",children:[n.jsx("p",{className:"font-medium",children:Et.label}),Et.type==="marker"&&n.jsx("p",{className:"text-white/80 text-xs",children:"Click on map to place"}),Et.type==="polygon"&&n.jsx("p",{className:"text-white/80 text-xs",children:"Click to add points, double-click to finish"}),Et.type==="line"&&n.jsx("p",{className:"text-white/80 text-xs",children:"Click to add points, double-click to finish"})]})]})}const Use=[{value:"VLOS",label:"VLOS",description:"Visual Line of Sight - Pilot maintains direct visual contact",color:"bg-green-100 text-green-800 border-green-300"},{value:"EVLOS",label:"EVLOS",description:"Extended VLOS - Visual observers extend operational range",color:"bg-amber-100 text-amber-800 border-amber-300"},{value:"BVLOS",label:"BVLOS",description:"Beyond VLOS - No direct visual contact with RPAS",color:"bg-red-100 text-red-800 border-red-300"}],qse=[{value:"inside-out",label:"Inside-Out",description:"Start with flight path, add buffers outward"},{value:"reverse",label:"Reverse",description:"Start with available ground, determine max flight area"},{value:"manual",label:"Manual",description:"Draw flight geography directly on map"}],k3=[{value:"point",label:"Point Operation",description:"Stationary or near-stationary flight around a single point"},{value:"corridor",label:"Corridor / Linear",description:"Flight along a linear path (pipeline, road, powerline)"},{value:"area",label:"Area Survey",description:"Flight covering a defined area with multiple passes"}],D3=[{value:"altitude",label:"Altitude-Based",description:"1:1 ratio - buffer equals flight altitude"},{value:"ballistic",label:"Ballistic Calculation",description:"Based on max speed, altitude, and glide ratio"},{value:"fixed",label:"Fixed Distance",description:"Manual fixed-distance buffer"},{value:"containment",label:"With Containment",description:"Reduced buffer with demonstrated containment"}],$se=[{trigger:"Loss of C2 Link",action:"Return to Home (RTH) automatically engages. If no RTH within 30 seconds, land in place.",priority:"high"},{trigger:"Low Battery Warning",action:"Immediately return to launch point. Land with minimum 20% remaining.",priority:"high"},{trigger:"GPS Loss",action:"Switch to ATTI mode, maintain visual contact, manual return and land.",priority:"high"},{trigger:"Fly-Away",action:"Attempt to regain control. If unsuccessful, contact FIC immediately.",priority:"critical"},{trigger:"Deteriorating Weather",action:"Land immediately if conditions fall below minimums.",priority:"medium"},{trigger:"Aircraft in Vicinity",action:"Descend and hold position or land. Give way to all manned aircraft.",priority:"high"}],M3=[{value:"A",label:"Class A",description:"Controlled - IFR only",controlled:!0},{value:"B",label:"Class B",description:"Controlled - Major airports",controlled:!0},{value:"C",label:"Class C",description:"Controlled - Busy airports",controlled:!0},{value:"D",label:"Class D",description:"Controlled - Towered airports",controlled:!0},{value:"E",label:"Class E",description:"Controlled - Low altitude",controlled:!0},{value:"F",label:"Class F",description:"Special use airspace",controlled:!1},{value:"G",label:"Class G",description:"Uncontrolled airspace",controlled:!1}];function zh({title:t,icon:e,children:r,defaultOpen:c=!0,badge:h=null,status:x=null}){const[w,o]=ue.useState(c),C={complete:"bg-green-100 text-green-700",partial:"bg-amber-100 text-amber-700",missing:"bg-red-100 text-red-700"};return n.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[n.jsxs("button",{onClick:()=>o(!w),className:"w-full px-4 py-3 bg-gray-50 flex items-center justify-between hover:bg-gray-100 transition-colors",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[e&&n.jsx(e,{className:"w-5 h-5 text-gray-500"}),n.jsx("span",{className:"font-medium text-gray-900",children:t}),h&&n.jsx("span",{className:"px-2 py-0.5 text-xs font-medium bg-aeria-navy/10 text-aeria-navy rounded-full",children:h}),x&&n.jsx("span",{className:`px-2 py-0.5 text-xs font-medium rounded-full ${C[x]}`,children:x==="complete"?" Complete":x==="partial"?"Partial":"Missing"})]}),w?n.jsx($n,{className:"w-5 h-5 text-gray-400"}):n.jsx(fn,{className:"w-5 h-5 text-gray-400"})]}),w&&n.jsx("div",{className:"p-4 space-y-4",children:r})]})}function Gse({sites:t,activeSiteId:e,onSelectSite:r}){return t.length<=1?null:n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 flex items-center gap-3 overflow-x-auto",children:[n.jsx("span",{className:"text-sm font-medium text-gray-500 whitespace-nowrap",children:"Site:"}),n.jsx("div",{className:"flex gap-2",children:t.map((c,h)=>{const x=c.id===e;return n.jsxs("button",{onClick:()=>r(c.id),className:`px-3 py-1.5 rounded-lg text-sm font-medium whitespace-nowrap transition-colors flex items-center gap-2 ${x?"bg-aeria-navy text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[n.jsx("div",{className:"w-2 h-2 rounded-full",style:{backgroundColor:x?"white":`hsl(${h*60}, 70%, 50%)`}}),c.name]},c.id)})})]})}function Hse({value:t,onChange:e}){return n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Operation Type"}),n.jsx("div",{className:"grid grid-cols-3 gap-3",children:Use.map(r=>{const c=t===r.value;return n.jsxs("button",{type:"button",onClick:()=>e(r.value),className:`p-4 rounded-lg border-2 text-left transition-all ${c?`${r.color} ring-2 ring-offset-2`:"border-gray-200 hover:border-gray-300"}`,children:[n.jsx("div",{className:"font-bold text-lg mb-1",children:r.label}),n.jsx("p",{className:"text-xs opacity-80",children:r.description})]},r.value)})})]})}function Wse({projectAircraft:t=[],siteAircraft:e=[],primaryAircraftId:r=null,onToggleAircraft:c,onSetPrimary:h,onNavigateToAircraft:x}){if(t.length===0)return n.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4",children:[n.jsxs("p",{className:"text-sm text-amber-800 flex items-center gap-2",children:[n.jsx(ir,{className:"w-4 h-4"}),"No aircraft in project fleet. Add aircraft in project settings first."]}),x&&n.jsxs("button",{type:"button",onClick:x,className:"mt-2 text-sm text-amber-700 hover:text-amber-900 flex items-center gap-1",children:[n.jsx(vie,{className:"w-3 h-3"}),"Go to Aircraft"]})]});const w=e.map(o=>typeof o=="string"?o:o.id);return n.jsxs("div",{className:"space-y-3",children:[n.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3",children:n.jsxs("p",{className:"text-sm text-blue-800",children:[n.jsx(Ns,{className:"w-4 h-4 inline mr-1"}),"Select aircraft for this site. Mark one as ",n.jsx("strong",{children:"primary"})," for SORA calculations."]})}),n.jsx("div",{className:"space-y-2",children:t.map(o=>{const C=w.includes(o.id),R=r===o.id;return n.jsxs("div",{className:`flex items-center gap-3 p-3 rounded-lg border transition-colors ${C?"bg-aeria-navy/5 border-aeria-navy":"bg-gray-50 border-gray-200"}`,children:[n.jsx("input",{type:"checkbox",checked:C,onChange:()=>c(o.id),className:"w-4 h-4 text-aeria-navy rounded focus:ring-aeria-navy"}),n.jsx(Zn,{className:`w-5 h-5 ${C?"text-aeria-navy":"text-gray-400"}`}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsx("p",{className:`font-medium ${C?"text-aeria-navy":"text-gray-900"}`,children:o.nickname||`${o.make} ${o.model}`}),n.jsxs("p",{className:"text-xs text-gray-500",children:[o.make," ",o.model,"  ",o.mtow?`${o.mtow}kg`:"Weight N/A",o.maxSpeed&&`  Max ${o.maxSpeed}m/s`]})]}),C&&n.jsx("button",{type:"button",onClick:()=>h(o.id),className:`px-3 py-1 text-xs font-medium rounded-full transition-colors ${R?"bg-green-100 text-green-700 border border-green-300":"bg-gray-100 text-gray-600 hover:bg-gray-200 border border-gray-300"}`,children:R?" Primary":"Set Primary"})]},o.id)})}),w.length>0&&!r&&n.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-3",children:n.jsxs("p",{className:"text-sm text-amber-800",children:[n.jsx(ir,{className:"w-4 h-4 inline mr-1"}),"Select a primary aircraft for SORA calculations."]})}),w.length===0&&n.jsx("p",{className:"text-sm text-gray-500 italic text-center py-2",children:"No aircraft assigned to this site yet."})]})}function Zse({weatherMinimums:t={},onChange:e}){const r=(c,h)=>{e({...t,[c]:h})};return n.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[n.jsxs("div",{children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1 flex items-center gap-1",children:[n.jsx(ga,{className:"w-4 h-4"}),"Min Visibility"]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("input",{type:"number",step:"0.5",min:"0",value:t.minVisibility||"",onChange:c=>r("minVisibility",c.target.value?Number(c.target.value):null),className:"input w-20"}),n.jsx("span",{className:"text-sm text-gray-500",children:"SM"})]})]}),n.jsxs("div",{children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1 flex items-center gap-1",children:[n.jsx(Ej,{className:"w-4 h-4"}),"Min Ceiling"]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("input",{type:"number",step:"100",min:"0",value:t.minCeiling||"",onChange:c=>r("minCeiling",c.target.value?Number(c.target.value):null),className:"input w-20"}),n.jsx("span",{className:"text-sm text-gray-500",children:"ft AGL"})]})]}),n.jsxs("div",{children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1 flex items-center gap-1",children:[n.jsx(by,{className:"w-4 h-4"}),"Max Wind"]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("input",{type:"number",step:"1",min:"0",value:t.maxWind||"",onChange:c=>r("maxWind",c.target.value?Number(c.target.value):null),className:"input w-20"}),n.jsx("span",{className:"text-sm text-gray-500",children:"m/s"})]})]}),n.jsxs("div",{children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1 flex items-center gap-1",children:[n.jsx(Rv,{className:"w-4 h-4"}),"Max Gust"]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("input",{type:"number",step:"1",min:"0",value:t.maxGust||"",onChange:c=>r("maxGust",c.target.value?Number(c.target.value):null),className:"input w-20"}),n.jsx("span",{className:"text-sm text-gray-500",children:"m/s"})]})]}),n.jsx("div",{className:"col-span-2 md:col-span-4",children:n.jsxs("label",{className:"flex items-center gap-3 cursor-pointer",children:[n.jsx("input",{type:"checkbox",checked:t.precipitation===!1,onChange:c=>r("precipitation",!c.target.checked),className:"w-4 h-4 text-aeria-navy rounded focus:ring-aeria-navy"}),n.jsx("span",{className:"text-sm text-gray-700",children:"No precipitation allowed during operation"})]})}),n.jsxs("div",{className:"col-span-2 md:col-span-4",children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Weather Notes"}),n.jsx("textarea",{value:t.notes||"",onChange:c=>r("notes",c.target.value),placeholder:"Additional weather considerations...",rows:2,className:"input"})]})]})}function Xse({contingencies:t=[],onChange:e}){const r=()=>{e([...t,{trigger:"",action:"",priority:"medium"}])},c=(o,C,R)=>{const F=[...t];F[o]={...F[o],[C]:R},e(F)},h=o=>{e(t.filter((C,R)=>R!==o))},x=()=>{t.length>0&&!confirm("This will replace existing contingencies. Continue?")||e($se)},w={critical:"bg-red-100 text-red-700 border-red-300",high:"bg-amber-100 text-amber-700 border-amber-300",medium:"bg-blue-100 text-blue-700 border-blue-300",low:"bg-gray-100 text-gray-700 border-gray-300"};return n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("p",{className:"text-sm text-gray-600",children:"Define contingency procedures for abnormal situations"}),n.jsxs("button",{type:"button",onClick:x,className:"text-sm text-aeria-navy hover:underline flex items-center gap-1",children:[n.jsx(Op,{className:"w-3 h-3"}),"Load Defaults"]})]}),t.map((o,C)=>n.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg space-y-2",children:[n.jsxs("div",{className:"flex items-start gap-2",children:[n.jsxs("select",{value:o.priority||"medium",onChange:R=>c(C,"priority",R.target.value),className:`px-2 py-1 text-xs font-medium rounded border ${w[o.priority||"medium"]}`,children:[n.jsx("option",{value:"critical",children:"Critical"}),n.jsx("option",{value:"high",children:"High"}),n.jsx("option",{value:"medium",children:"Medium"}),n.jsx("option",{value:"low",children:"Low"})]}),n.jsx("input",{type:"text",value:o.trigger||"",onChange:R=>c(C,"trigger",R.target.value),placeholder:"Trigger condition...",className:"input flex-1 text-sm py-1"}),n.jsx("button",{onClick:()=>h(C),className:"p-1 text-gray-400 hover:text-red-500 rounded",children:n.jsx(Ln,{className:"w-4 h-4"})})]}),n.jsx("textarea",{value:o.action||"",onChange:R=>c(C,"action",R.target.value),placeholder:"Response action...",rows:2,className:"input text-sm"})]},C)),n.jsxs("button",{type:"button",onClick:r,className:"w-full px-4 py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-gray-400 hover:text-gray-600 flex items-center justify-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Add Contingency"]})]})}function Yse({site:t,projectFlightPlan:e}){var C;const r=((C=t==null?void 0:t.mapData)==null?void 0:C.flightPlan)||{};t!=null&&t.flightPlan;const c=!!r.launchPoint,h=!!r.recoveryPoint,x=!!r.pilotPosition,w=!!r.flightGeography,o=w?Rj(r.flightGeography):null;return n.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[n.jsxs("div",{className:`p-3 rounded-lg ${c?"bg-green-50 border border-green-200":"bg-gray-50 border border-gray-200"}`,children:[n.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[n.jsx(cf,{className:`w-4 h-4 ${c?"text-green-600":"text-gray-400"}`}),n.jsx("span",{className:"text-sm font-medium",children:"Launch Point"})]}),n.jsx("p",{className:`text-xs ${c?"text-green-700":"text-gray-500"}`,children:c?"Set on map":"Not set"})]}),n.jsxs("div",{className:`p-3 rounded-lg ${h?"bg-green-50 border border-green-200":"bg-gray-50 border border-gray-200"}`,children:[n.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[n.jsx(go,{className:`w-4 h-4 ${h?"text-orange-600":"text-gray-400"}`}),n.jsx("span",{className:"text-sm font-medium",children:"Recovery Point"})]}),n.jsx("p",{className:`text-xs ${h?"text-green-700":"text-gray-500"}`,children:h?"Set on map":"Not set"})]}),n.jsxs("div",{className:`p-3 rounded-lg ${x?"bg-green-50 border border-green-200":"bg-gray-50 border border-gray-200"}`,children:[n.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[n.jsx(fa,{className:`w-4 h-4 ${x?"text-purple-600":"text-gray-400"}`}),n.jsx("span",{className:"text-sm font-medium",children:"Pilot Position"})]}),n.jsx("p",{className:`text-xs ${x?"text-green-700":"text-gray-500"}`,children:x?"Set on map":"Not set"})]}),n.jsxs("div",{className:`p-3 rounded-lg ${w?"bg-green-50 border border-green-200":"bg-gray-50 border border-gray-200"}`,children:[n.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[n.jsx(vS,{className:`w-4 h-4 ${w?"text-green-600":"text-gray-400"}`}),n.jsx("span",{className:"text-sm font-medium",children:"Flight Geography"})]}),n.jsx("p",{className:`text-xs ${w?"text-green-700":"text-gray-500"}`,children:o?`${(o/1e4).toFixed(2)} ha`:"Not drawn"})]})]})}function Kse({project:t,onUpdate:e,onNavigateToSection:r}){var de,K,ge,Ae,Te,Ce,ne,ae,q,oe,ke,Ve,ie,ze,ve,Le,Ke,Pe,It;const[c,h]=ue.useState(!0),x=zT(t,e,{editMode:!0,allowedLayers:["siteSurvey","flightPlan"],initialBasemap:"streets"}),w=ue.useMemo(()=>Array.isArray(t==null?void 0:t.sites)?t.sites:[],[t==null?void 0:t.sites]),o=(t==null?void 0:t.activeSiteId)||((de=w[0])==null?void 0:de.id)||null,C=ue.useMemo(()=>w.find(tt=>tt.id===o)||w[0]||null,[w,o]),R=(t==null?void 0:t.flightPlan)||{},F=(C==null?void 0:C.flightPlan)||{},$=ue.useCallback(tt=>{e({activeSiteId:tt})},[e]),Y=ue.useCallback(tt=>{e({flightPlan:{...R,...tt}})},[R,e]),H=ue.useCallback(tt=>{if(!o)return;const zt=w.map(vt=>vt.id!==o?vt:{...vt,flightPlan:{...vt.flightPlan,...tt},updatedAt:new Date().toISOString()});e({sites:zt})},[w,o,e]);ue.useCallback(tt=>{const zt=R.aircraft||[],vt=zt.some(Et=>Et.id===tt);let Ot;vt?Ot=zt.filter(Et=>Et.id!==tt):Ot=[...zt,{id:tt}],Y({aircraft:Ot})},[R.aircraft,Y]);const X=ue.useCallback(tt=>{const zt=F.aircraft||[],vt=zt.includes(tt);let Ot,Et=F.primaryAircraftId;vt?(Ot=zt.filter(yi=>yi!==tt),Et===tt&&(Et=Ot[0]||null)):(Ot=[...zt,tt],!Et&&Ot.length===1&&(Et=tt)),H({aircraft:Ot,primaryAircraftId:Et})},[F.aircraft,F.primaryAircraftId,H]),he=ue.useCallback(tt=>{H({primaryAircraftId:tt})},[H]),se=ue.useMemo(()=>{var zt;const tt=[];if(C){const vt=((zt=C.mapData)==null?void 0:zt.flightPlan)||{};vt.launchPoint||tt.push("Launch point not set"),vt.recoveryPoint||tt.push("Recovery point not set")}return!F.aircraft||F.aircraft.length===0?tt.push("No aircraft assigned to site"):F.primaryAircraftId||tt.push("No primary aircraft selected"),F.operationType||tt.push("Operation type not selected"),{isComplete:tt.length===0,issues:tt}},[C,R,F]);return!C&&w.length===0?n.jsxs("div",{className:"text-center py-12",children:[n.jsx(Zn,{className:"w-12 h-12 mx-auto text-gray-300 mb-4"}),n.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Sites Configured"}),n.jsx("p",{className:"text-gray-500 mb-4",children:"Add operation sites in Site Survey before creating flight plans."}),n.jsx("button",{onClick:()=>r==null?void 0:r("siteSurvey"),className:"btn-primary",children:"Go to Site Survey"})]}):n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[n.jsxs("div",{children:[n.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Flight Plan"}),n.jsx("p",{className:"text-gray-500",children:"Define flight parameters, positions, and contingencies for each site"})]}),n.jsx("div",{className:"flex items-center gap-2",children:n.jsxs("button",{onClick:()=>h(!c),className:`btn ${c?"btn-primary":"btn-secondary"} inline-flex items-center gap-2`,children:[c?n.jsx(ga,{className:"w-4 h-4"}):n.jsx(Wn,{className:"w-4 h-4"}),c?"Viewing Map":"Show Map"]})})]}),n.jsx(Gse,{sites:w,activeSiteId:o,onSelectSite:$}),!se.isComplete&&n.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4",children:[n.jsxs("h4",{className:"font-medium text-amber-800 mb-2 flex items-center gap-2",children:[n.jsx(ir,{className:"w-4 h-4"}),"Flight Plan Incomplete"]}),n.jsx("ul",{className:"text-sm text-amber-700 space-y-1",children:se.issues.map((tt,zt)=>n.jsxs("li",{children:[" ",tt]},zt))})]}),c&&n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{className:"flex flex-wrap gap-3 items-center",children:[n.jsx(BT,{visibleLayers:x.visibleLayers,onToggleLayer:x.toggleLayer,allowedLayers:["siteSurvey","flightPlan"],compact:!0}),n.jsx(VT,{drawingMode:x.drawingMode,isDrawing:x.isDrawing,drawingPoints:x.drawingPoints,onStartDrawing:x.startDrawing,onCancelDrawing:x.cancelDrawing,onCompleteDrawing:x.completeDrawing,onRemoveLastPoint:x.removeLastDrawingPoint,activeLayer:"flightPlan",editMode:!0}),w.length>1&&n.jsxs("label",{className:"flex items-center gap-2 px-3 py-2 bg-white rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50",children:[n.jsx("input",{type:"checkbox",checked:x.showAllSites,onChange:tt=>x.setShowAllSites(tt.target.checked),className:"w-4 h-4 text-aeria-navy rounded focus:ring-aeria-navy"}),n.jsx(ga,{className:"w-4 h-4 text-gray-500"}),n.jsx("span",{className:"text-sm text-gray-700",children:"All Sites"})]})]}),n.jsx("div",{className:"card p-0 overflow-hidden",children:n.jsx(Wj,{project:t,onUpdate:e,editMode:!0,activeLayer:"flightPlan",height:"400px",allowedLayers:["siteSurvey","flightPlan"],showLegend:!0,showControls:!1,externalMapData:x,onSiteChange:$})})]}),n.jsxs(zh,{title:"Flight Positions",icon:Wn,status:(ge=(K=C==null?void 0:C.mapData)==null?void 0:K.flightPlan)!=null&&ge.launchPoint&&((Te=(Ae=C==null?void 0:C.mapData)==null?void 0:Ae.flightPlan)!=null&&Te.recoveryPoint)?"complete":"missing",children:[n.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4",children:n.jsxs("p",{className:"text-sm text-blue-800",children:[n.jsx(Ns,{className:"w-4 h-4 inline mr-1"}),"Use the ",n.jsx("strong",{children:"Drawing Tools"})," on the map to set launch point, recovery point, pilot position, and flight geography."]})}),n.jsx(Yse,{site:C,projectFlightPlan:R})]}),n.jsxs(zh,{title:"Operation Parameters",icon:kv,status:F.operationType?"complete":"missing",children:[n.jsx(Hse,{value:F.operationType||"VLOS",onChange:tt=>H({operationType:tt})}),n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Max Altitude (AGL)"}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("input",{type:"number",step:"10",min:"0",max:"400",value:F.maxAltitudeAGL||"",onChange:tt=>H({maxAltitudeAGL:tt.target.value?Number(tt.target.value):null}),placeholder:"120",className:"input w-24"}),n.jsx("span",{className:"text-sm text-gray-500",children:"m"})]}),n.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Limit: 122m (400ft)"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Max Distance from Pilot"}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("input",{type:"number",step:"100",min:"0",value:F.maxDistanceFromPilot||"",onChange:tt=>H({maxDistanceFromPilot:tt.target.value?Number(tt.target.value):null}),placeholder:"500",className:"input w-24"}),n.jsx("span",{className:"text-sm text-gray-500",children:"m"})]}),n.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"VLOS typically 500m"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Planned Flight Duration"}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("input",{type:"number",step:"5",min:"0",value:F.flightDuration||"",onChange:tt=>H({flightDuration:tt.target.value?Number(tt.target.value):null}),placeholder:"20",className:"input w-24"}),n.jsx("span",{className:"text-sm text-gray-500",children:"min"})]}),n.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Per flight / battery"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Total Flights Planned"}),n.jsx("input",{type:"number",step:"1",min:"1",value:F.totalFlights||"",onChange:tt=>H({totalFlights:tt.target.value?Number(tt.target.value):null}),placeholder:"1",className:"input w-24"})]})]})]}),n.jsx(zh,{title:"Flight Geography",icon:vS,badge:F.areaType?(Ce=k3.find(tt=>tt.value===F.areaType))==null?void 0:Ce.label:null,status:F.areaType?"complete":"incomplete",children:n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Operation Area Type"}),n.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:k3.map(tt=>n.jsxs("label",{className:`flex items-start gap-3 p-3 rounded-lg border cursor-pointer transition-colors ${F.areaType===tt.value?"bg-aeria-navy/5 border-aeria-navy":"bg-gray-50 border-gray-200 hover:border-gray-300"}`,children:[n.jsx("input",{type:"radio",name:"areaType",value:tt.value,checked:F.areaType===tt.value,onChange:zt=>H({areaType:zt.target.value}),className:"mt-1"}),n.jsxs("div",{children:[n.jsx("span",{className:"font-medium text-gray-900",children:tt.label}),n.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:tt.description})]})]},tt.value))})]}),n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Flight Geography Method"}),n.jsx("select",{value:F.flightGeographyMethod||"manual",onChange:tt=>H({flightGeographyMethod:tt.target.value}),className:"input",children:qse.map(tt=>n.jsxs("option",{value:tt.value,children:[tt.label," - ",tt.description]},tt.value))})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Ground Risk Buffer Method"}),n.jsx("select",{value:F.groundRiskBufferMethod||"altitude",onChange:tt=>H({groundRiskBufferMethod:tt.target.value}),className:"input",children:D3.map(tt=>n.jsx("option",{value:tt.value,children:tt.label},tt.value))}),n.jsx("p",{className:"text-xs text-gray-500 mt-1",children:(ne=D3.find(tt=>tt.value===(F.groundRiskBufferMethod||"altitude")))==null?void 0:ne.description})]})]}),n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Contingency Buffer"}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("input",{type:"number",step:"10",min:"0",value:F.contingencyBuffer||"",onChange:tt=>H({contingencyBuffer:tt.target.value?Number(tt.target.value):null}),placeholder:"50",className:"input w-24"}),n.jsx("span",{className:"text-sm text-gray-500",children:"m"})]}),n.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Max speed  15 sec typical"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Ground Risk Buffer"}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("input",{type:"number",step:"10",min:"0",value:F.groundRiskBuffer||"",onChange:tt=>H({groundRiskBuffer:tt.target.value?Number(tt.target.value):null}),placeholder:"120",className:"input w-24"}),n.jsx("span",{className:"text-sm text-gray-500",children:"m"})]}),n.jsx("p",{className:"text-xs text-gray-500 mt-1",children:F.groundRiskBufferMethod==="altitude"?`Auto: ${F.maxAltitudeAGL||120}m (1:1)`:"Manual entry"})]}),n.jsx("div",{className:"flex items-center",children:n.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[n.jsx("input",{type:"checkbox",checked:F.adjacentAreaConsidered||!1,onChange:tt=>H({adjacentAreaConsidered:tt.target.checked}),className:"w-4 h-4 text-aeria-navy rounded"}),n.jsxs("div",{children:[n.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Adjacent Area Assessed"}),n.jsx("p",{className:"text-xs text-gray-500",children:"Per SORA Step 8"})]})]})})]}),n.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3",children:n.jsxs("p",{className:"text-sm text-blue-800",children:[n.jsx(Ns,{className:"w-4 h-4 inline mr-1"}),"Draw your flight geography on the map using the ",n.jsx("strong",{children:"Drawing Tools"}),". The flight volume, contingency volume, and ground risk buffer will be visualized."]})})]})}),n.jsx(zh,{title:"Flight Plan Notes",icon:Ns,defaultOpen:!1,children:n.jsx("textarea",{value:F.notes||"",onChange:tt=>H({notes:tt.target.value}),placeholder:"Additional notes about flight operations at this site...",rows:4,className:"input"})}),n.jsx(zh,{title:"Airspace",icon:Jc,badge:(ae=F.airspace)!=null&&ae.classification?`Class ${F.airspace.classification}`:null,status:(q=F.airspace)!=null&&q.classification?"complete":"incomplete",children:n.jsxs("div",{className:"space-y-4",children:[n.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3",children:n.jsxs("p",{className:"text-sm text-blue-800",children:[n.jsx(Ns,{className:"w-4 h-4 inline mr-1"}),"Airspace classification affects SORA Air Risk Class (ARC) determination."]})}),n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Airspace Classification"}),n.jsx("select",{value:((oe=F.airspace)==null?void 0:oe.classification)||"G",onChange:tt=>{const zt=M3.find(vt=>vt.value===tt.target.value);H({airspace:{...F.airspace,classification:tt.target.value,controlled:(zt==null?void 0:zt.controlled)||!1}})},className:"input",children:M3.map(tt=>n.jsxs("option",{value:tt.value,children:[tt.label," - ",tt.description]},tt.value))})]}),n.jsxs("div",{className:"flex items-center gap-4",children:[n.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[n.jsx("input",{type:"checkbox",checked:((ke=F.airspace)==null?void 0:ke.atcCoordinationRequired)||!1,onChange:tt=>H({airspace:{...F.airspace,atcCoordinationRequired:tt.target.checked}}),className:"w-4 h-4 text-aeria-navy rounded"}),n.jsx("span",{className:"text-sm text-gray-700",children:"ATC Coordination Required"})]}),n.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[n.jsx("input",{type:"checkbox",checked:((Ve=F.airspace)==null?void 0:Ve.notamRequired)||!1,onChange:tt=>H({airspace:{...F.airspace,notamRequired:tt.target.checked}}),className:"w-4 h-4 text-aeria-navy rounded"}),n.jsx("span",{className:"text-sm text-gray-700",children:"NOTAM Required"})]})]})]}),n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nearest Aerodrome"}),n.jsx("input",{type:"text",value:((ie=F.airspace)==null?void 0:ie.nearestAerodrome)||"",onChange:tt=>H({airspace:{...F.airspace,nearestAerodrome:tt.target.value}}),placeholder:"e.g., CYYC Calgary Intl",className:"input"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Distance (km)"}),n.jsx("input",{type:"number",step:"0.1",value:((ze=F.airspace)==null?void 0:ze.aerodromeDistance)||"",onChange:tt=>H({airspace:{...F.airspace,aerodromeDistance:tt.target.value?Number(tt.target.value):null}}),placeholder:"e.g., 12.5",className:"input"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Direction"}),n.jsx("input",{type:"text",value:((ve=F.airspace)==null?void 0:ve.aerodromeDirection)||"",onChange:tt=>H({airspace:{...F.airspace,aerodromeDirection:tt.target.value}}),placeholder:"e.g., NNW",className:"input"})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Airspace Notes / Restrictions"}),n.jsx("textarea",{value:((Le=F.airspace)==null?void 0:Le.notes)||"",onChange:tt=>H({airspace:{...F.airspace,notes:tt.target.value}}),placeholder:"Enter any airspace restrictions, special considerations, or coordination requirements...",rows:3,className:"input"})]})]})}),n.jsx(zh,{title:"Site Aircraft",icon:Zn,badge:((Ke=F.aircraft)==null?void 0:Ke.length)>0?`${F.aircraft.length} assigned`:null,status:((Pe=F.aircraft)==null?void 0:Pe.length)>0&&F.primaryAircraftId?"complete":"missing",children:n.jsx(Wse,{projectAircraft:(t==null?void 0:t.aircraft)||[],siteAircraft:F.aircraft||[],primaryAircraftId:F.primaryAircraftId,onToggleAircraft:X,onSetPrimary:he})}),n.jsx(zh,{title:"Weather Minimums",icon:Ej,defaultOpen:!1,children:n.jsx(Zse,{weatherMinimums:R.weatherMinimums||{},onChange:tt=>Y({weatherMinimums:tt})})}),n.jsx(zh,{title:"Contingency Procedures",icon:ir,badge:((It=R.contingencies)==null?void 0:It.length)>0?`${R.contingencies.length} defined`:null,defaultOpen:!1,children:n.jsx(Xse,{contingencies:R.contingencies||[],onChange:tt=>Y({contingencies:tt})})}),n.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4 flex items-center justify-between",children:[n.jsxs("div",{children:[n.jsx("h4",{className:"font-medium text-gray-900",children:"SORA Assessment"}),n.jsx("p",{className:"text-sm text-gray-500",children:"Flight plan parameters feed into SORA risk calculations"})]}),n.jsxs("button",{onClick:()=>r==null?void 0:r("sora"),className:"btn-secondary inline-flex items-center gap-2",children:["View SORA",n.jsx(fc,{className:"w-4 h-4"})]})]})]})}async function Qse(t,e,r,c="general"){if(!t)throw new Error("No file provided");if(!e)throw new Error("Project ID required");if(!r)throw new Error("Site ID required");if(!["image/jpeg","image/png","image/webp","image/heic"].includes(t.type))throw new Error("Invalid file type. Please upload JPEG, PNG, or WebP images.");const x=10*1024*1024;if(t.size>x)throw new Error("File too large. Maximum size is 10MB.");const w=Date.now(),o=t.name.replace(/[^a-zA-Z0-9.-]/g,"_"),C=`${w}_${o}`,R=`projects/${e}/sites/${r}/photos/${c}/${C}`,F=h6(p6,R),$=await Zte(F,t,{contentType:t.type,customMetadata:{originalName:t.name,uploadedAt:new Date().toISOString(),category:c}});return{url:await Xte($.ref),path:R,name:t.name,size:t.size,type:t.type,uploadedAt:new Date().toISOString()}}async function Jse(t){if(!t)throw new Error("Storage path required");const e=h6(p6,t);await Yte(e)}const O3=[{id:"site_overview",label:"Site Overview",icon:dI},{id:"obstacles",label:"Obstacles",icon:Cs},{id:"access_points",label:"Access Points",icon:dI},{id:"hazards",label:"Hazards",icon:Cs},{id:"surrounding_area",label:"Surrounding Area",icon:By},{id:"other",label:"Other",icon:bl}];function eae({projectId:t,siteId:e,photos:r=[],onPhotosChange:c,maxPhotos:h=20}){const[x,w]=ue.useState(!1),[o,C]=ue.useState({current:0,total:0}),[R,F]=ue.useState(null),[$,Y]=ue.useState("site_overview"),[H,X]=ue.useState(null),[he,se]=ue.useState(!1),de=ue.useRef(null),K=ue.useCallback(async q=>{if(!q||q.length===0)return;if(!t||!e){F("Project and site must be saved before uploading photos");return}const oe=Array.from(q);if(r.length+oe.length>h){F(`Maximum ${h} photos allowed. You can add ${h-r.length} more.`);return}const ke=["image/jpeg","image/png","image/webp","image/heic"];if(oe.filter(ze=>!ke.includes(ze.type)).length>0){F("Only JPEG, PNG, and WebP images are allowed");return}F(null),w(!0),C({current:0,total:oe.length});const ie=[...r];for(let ze=0;ze<oe.length;ze++)try{C({current:ze+1,total:oe.length});const ve=await Qse(oe[ze],t,e,$);ie.push({...ve,category:$,caption:""})}catch(ve){console.error("Upload error:",ve),F(`Failed to upload ${oe[ze].name}: ${ve.message}`)}w(!1),C({current:0,total:0}),c(ie)},[t,e,r,$,h,c]),ge=ue.useCallback(q=>{q.preventDefault(),se(!0)},[]),Ae=ue.useCallback(q=>{q.preventDefault(),se(!1)},[]),Te=ue.useCallback(q=>{q.preventDefault(),se(!1),K(q.dataTransfer.files)},[K]),Ce=ue.useCallback(async q=>{const oe=r[q];try{oe.path&&await Jse(oe.path);const ke=r.filter((Ve,ie)=>ie!==q);c(ke)}catch(ke){console.error("Delete error:",ke),F(`Failed to delete photo: ${ke.message}`)}},[r,c]),ne=ue.useCallback((q,oe)=>{const ke=[...r];ke[q]={...ke[q],caption:oe},c(ke)},[r,c]),ae=r.reduce((q,oe,ke)=>{const Ve=oe.category||"other";return q[Ve]||(q[Ve]=[]),q[Ve].push({...oe,index:ke}),q},{});return n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Photo Category"}),n.jsx("div",{className:"flex flex-wrap gap-2",children:O3.map(q=>n.jsxs("button",{type:"button",onClick:()=>Y(q.id),className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-1.5 ${$===q.id?"bg-aeria-navy text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[n.jsx(q.icon,{className:"w-4 h-4"}),q.label]},q.id))})]}),n.jsxs("div",{onDragOver:ge,onDragLeave:Ae,onDrop:Te,className:`relative border-2 border-dashed rounded-lg p-6 text-center transition-colors ${he?"border-aeria-navy bg-aeria-navy/5":"border-gray-300 hover:border-gray-400"} ${x?"pointer-events-none opacity-50":""}`,children:[n.jsx("input",{ref:de,type:"file",multiple:!0,accept:"image/jpeg,image/png,image/webp,image/heic",onChange:q=>K(q.target.files),className:"hidden"}),x?n.jsxs("div",{className:"py-4",children:[n.jsx(Ro,{className:"w-8 h-8 mx-auto text-aeria-navy animate-spin mb-2"}),n.jsxs("p",{className:"text-sm text-gray-600",children:["Uploading ",o.current," of ",o.total,"..."]})]}):n.jsxs(n.Fragment,{children:[n.jsx(bl,{className:"w-10 h-10 mx-auto text-gray-400 mb-3"}),n.jsxs("p",{className:"text-gray-600 mb-2",children:["Drag and drop photos here, or"," ",n.jsx("button",{type:"button",onClick:()=>{var q;return(q=de.current)==null?void 0:q.click()},className:"text-aeria-navy font-medium hover:underline",children:"browse"})]}),n.jsxs("p",{className:"text-xs text-gray-500",children:["JPEG, PNG, or WebP  Max 10MB each  ",r.length,"/",h," photos"]})]})]}),R&&n.jsxs("div",{className:"flex items-center gap-2 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm",children:[n.jsx(Cs,{className:"w-4 h-4 flex-shrink-0"}),n.jsx("span",{children:R}),n.jsx("button",{type:"button",onClick:()=>F(null),className:"ml-auto text-red-500 hover:text-red-700",children:n.jsx(cs,{className:"w-4 h-4"})})]}),Object.entries(ae).length>0&&n.jsx("div",{className:"space-y-4",children:O3.filter(q=>{var oe;return((oe=ae[q.id])==null?void 0:oe.length)>0}).map(q=>n.jsxs("div",{children:[n.jsxs("h4",{className:"text-sm font-medium text-gray-700 mb-2 flex items-center gap-1.5",children:[n.jsx(q.icon,{className:"w-4 h-4"}),q.label," (",ae[q.id].length,")"]}),n.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3",children:ae[q.id].map(oe=>n.jsxs("div",{className:"relative group aspect-square rounded-lg overflow-hidden bg-gray-100 border border-gray-200",children:[n.jsx("img",{src:oe.url,alt:oe.caption||oe.name,className:"w-full h-full object-cover"}),n.jsxs("div",{className:"absolute inset-0 bg-black/0 group-hover:bg-black/40 transition-colors flex items-center justify-center gap-2 opacity-0 group-hover:opacity-100",children:[n.jsx("button",{type:"button",onClick:()=>X(oe),className:"p-2 bg-white rounded-full text-gray-700 hover:bg-gray-100",title:"View full size",children:n.jsx(nre,{className:"w-4 h-4"})}),n.jsx("button",{type:"button",onClick:()=>Ce(oe.index),className:"p-2 bg-white rounded-full text-red-600 hover:bg-red-50",title:"Delete photo",children:n.jsx(Ln,{className:"w-4 h-4"})})]}),oe.caption&&n.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-black/60 text-white text-xs p-1 truncate",children:oe.caption})]},oe.index))})]},q.id))}),r.length===0&&!x&&n.jsxs("div",{className:"text-center py-6 text-gray-500",children:[n.jsx(By,{className:"w-12 h-12 mx-auto text-gray-300 mb-2"}),n.jsx("p",{className:"text-sm",children:"No photos uploaded yet"})]}),H&&n.jsxs("div",{className:"fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4",onClick:()=>X(null),children:[n.jsx("button",{type:"button",onClick:()=>X(null),className:"absolute top-4 right-4 p-2 text-white hover:text-gray-300",children:n.jsx(cs,{className:"w-8 h-8"})}),n.jsx("img",{src:H.url,alt:H.caption||H.name,className:"max-w-full max-h-full object-contain",onClick:q=>q.stopPropagation()}),n.jsx("div",{className:"absolute bottom-4 left-4 right-4 max-w-lg mx-auto",onClick:q=>q.stopPropagation(),children:n.jsx("input",{type:"text",value:H.caption||"",onChange:q=>ne(H.index,q.target.value),placeholder:"Add a caption...",className:"w-full px-4 py-2 bg-white/90 rounded-lg text-gray-900 placeholder-gray-500"})})]})]})}function tae({count:t}){return t?n.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 bg-green-100 text-green-700 rounded-full text-xs font-medium",children:[n.jsx(bl,{className:"w-3 h-3"}),t]}):null}const b0=[{value:"tower",label:"Tower/Antenna",icon:""},{value:"wire",label:"Power Lines/Wires",icon:""},{value:"building",label:"Building/Structure",icon:""},{value:"tree",label:"Trees/Vegetation",icon:""},{value:"terrain",label:"Terrain Feature",icon:""},{value:"water",label:"Water Tower/Tank",icon:""},{value:"crane",label:"Crane",icon:""},{value:"other",label:"Other",icon:""}];function $g({title:t,icon:e,children:r,defaultOpen:c=!0,badge:h=null}){const[x,w]=ue.useState(c);return n.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[n.jsxs("button",{onClick:()=>w(!x),className:"w-full px-4 py-3 bg-gray-50 flex items-center justify-between hover:bg-gray-100 transition-colors",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[e&&n.jsx(e,{className:"w-5 h-5 text-gray-500"}),n.jsx("span",{className:"font-medium text-gray-900",children:t}),h&&n.jsx("span",{className:"px-2 py-0.5 text-xs font-medium bg-aeria-navy/10 text-aeria-navy rounded-full",children:h})]}),x?n.jsx($n,{className:"w-5 h-5 text-gray-400"}):n.jsx(fn,{className:"w-5 h-5 text-gray-400"})]}),x&&n.jsx("div",{className:"p-4 space-y-4",children:r})]})}function iae({sites:t,activeSiteId:e,onSelectSite:r,onAddSite:c,onDuplicateSite:h,onDeleteSite:x,onRenameSite:w}){const[o,C]=ue.useState(null),[R,F]=ue.useState({top:0,left:0}),[$,Y]=ue.useState(null),[H,X]=ue.useState(""),he=K=>{Y(K.id),X(K.name),C(null)},se=K=>{H.trim()&&w(K,H.trim()),Y(null),X("")},de=(K,ge)=>{if(K.stopPropagation(),o===ge)C(null);else{const Ae=K.currentTarget.getBoundingClientRect();F({top:Ae.bottom+4,left:Ae.right-144}),C(ge)}};return n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[n.jsxs("div",{className:"px-4 py-3 bg-gray-50 border-b border-gray-200 flex items-center justify-between",children:[n.jsx("h3",{className:"font-medium text-gray-900",children:"Operation Sites"}),n.jsxs("span",{className:"text-sm text-gray-500",children:[t.length,"/10"]})]}),n.jsx("div",{className:"divide-y divide-gray-100",children:t.map((K,ge)=>{const Ae=K.id===e,Te=$===K.id,Ce=V6(K);return n.jsxs("div",{className:`flex items-center gap-3 px-4 py-3 cursor-pointer transition-colors ${Ae?"bg-aeria-navy/5 border-l-4 border-aeria-navy":"hover:bg-gray-50 border-l-4 border-transparent"}`,onClick:()=>!Te&&r(K.id),children:[n.jsx("div",{className:"w-3 h-3 rounded-full flex-shrink-0",style:{backgroundColor:`hsl(${ge*60}, 70%, 50%)`}}),n.jsx("div",{className:"flex-1 min-w-0",children:Te?n.jsxs("div",{className:"flex items-center gap-2",onClick:ne=>ne.stopPropagation(),children:[n.jsx("input",{type:"text",value:H,onChange:ne=>X(ne.target.value),onKeyDown:ne=>{ne.key==="Enter"&&se(K.id),ne.key==="Escape"&&Y(null)},className:"flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-aeria-navy",autoFocus:!0}),n.jsx("button",{onClick:()=>se(K.id),className:"p-1 text-green-600 hover:bg-green-50 rounded",children:n.jsx(ru,{className:"w-4 h-4"})}),n.jsx("button",{onClick:()=>Y(null),className:"p-1 text-gray-400 hover:bg-gray-100 rounded",children:n.jsx(cs,{className:"w-4 h-4"})})]}):n.jsxs(n.Fragment,{children:[n.jsx("p",{className:`text-sm font-medium truncate ${Ae?"text-aeria-navy":"text-gray-900"}`,children:K.name}),n.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[Ce.hasLocation&&n.jsxs("span",{className:"flex items-center gap-1",children:[n.jsx(Wn,{className:"w-3 h-3"})," Located"]}),Ce.hasBoundary&&n.jsxs("span",{className:"flex items-center gap-1",children:[n.jsx("span",{className:"w-2 h-2 border border-current"})," Bounded"]}),Ce.obstacleCount>0&&n.jsxs("span",{children:[Ce.obstacleCount," obstacles"]})]})]})}),!Te&&n.jsx("div",{onClick:ne=>ne.stopPropagation(),children:n.jsx("button",{onClick:ne=>de(ne,K.id),className:"p-1 text-gray-400 hover:text-gray-600 rounded",children:n.jsx(Qd,{className:"w-4 h-4"})})})]},K.id)})}),o&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"fixed inset-0 z-[9998]",onClick:()=>C(null)}),n.jsxs("div",{className:"fixed w-36 bg-white rounded-lg shadow-xl border border-gray-200 py-1 z-[9999]",style:{top:R.top,left:Math.max(8,R.left)},children:[n.jsxs("button",{onClick:()=>he(t.find(K=>K.id===o)),className:"w-full px-3 py-1.5 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2",children:[n.jsx(Uie,{className:"w-4 h-4"}),"Rename"]}),n.jsxs("button",{onClick:()=>{h(o),C(null)},className:"w-full px-3 py-1.5 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2",children:[n.jsx(Op,{className:"w-4 h-4"}),"Duplicate"]}),t.length>1&&n.jsxs("button",{onClick:()=>{x(o),C(null)},className:"w-full px-3 py-1.5 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2",children:[n.jsx(Ln,{className:"w-4 h-4"}),"Delete"]})]})]}),t.length<10&&n.jsxs("button",{onClick:c,className:"w-full px-4 py-3 text-sm text-aeria-navy hover:bg-aeria-navy/5 flex items-center justify-center gap-2 border-t border-gray-200",children:[n.jsx(vr,{className:"w-4 h-4"}),"Add Site"]})]})}function L3({value:t,onChange:e,label:r="Population Category"}){var c;return n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:r}),n.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2",children:Object.entries(pI).map(([h,x])=>{const w=t===h;return n.jsxs("button",{type:"button",onClick:()=>e(h),className:`p-3 rounded-lg border text-left transition-all ${w?"border-aeria-navy bg-aeria-navy/5 ring-2 ring-aeria-navy/20":"border-gray-200 hover:border-gray-300 hover:bg-gray-50"}`,children:[n.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[n.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:x.color}}),n.jsx("span",{className:`text-sm font-medium ${w?"text-aeria-navy":"text-gray-900"}`,children:x.label})]}),n.jsx("p",{className:"text-xs text-gray-500",children:x.density})]},h)})}),t&&n.jsxs("p",{className:"mt-2 text-sm text-gray-600",children:[n.jsx(Ns,{className:"w-4 h-4 inline mr-1"}),(c=pI[t])==null?void 0:c.description]})]})}function rae({obstacles:t=[],onUpdate:e,onRemove:r,onAdd:c}){const[h,x]=ue.useState(!1),[w,o]=ue.useState({obstacleType:"other",height:"",notes:"",lat:"",lng:""}),C=()=>{if(!w.lat||!w.lng){alert("Please enter coordinates (latitude and longitude)");return}const R=parseFloat(w.lat),F=parseFloat(w.lng);if(isNaN(R)||isNaN(F)||R<-90||R>90||F<-180||F>180){alert("Invalid coordinates. Latitude must be -90 to 90, Longitude must be -180 to 180");return}c({obstacleType:w.obstacleType,height:w.height?Number(w.height):null,notes:w.notes,geometry:{type:"Point",coordinates:[F,R]}}),o({obstacleType:"other",height:"",notes:"",lat:"",lng:""}),x(!1)};return n.jsxs("div",{className:"space-y-4",children:[h?n.jsxs("div",{className:"p-4 bg-amber-50 border border-amber-200 rounded-lg space-y-3",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("h4",{className:"font-medium text-gray-900",children:"Add Manual Obstacle"}),n.jsx("button",{type:"button",onClick:()=>x(!1),className:"text-gray-400 hover:text-gray-600",children:n.jsx(cs,{className:"w-4 h-4"})})]}),n.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"Type"}),n.jsx("select",{value:w.obstacleType,onChange:R=>o(F=>({...F,obstacleType:R.target.value})),className:"input text-sm",children:b0.map(R=>n.jsx("option",{value:R.value,children:R.label},R.value))})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"Height (m)"}),n.jsx("input",{type:"number",value:w.height,onChange:R=>o(F=>({...F,height:R.target.value})),placeholder:"e.g., 30",className:"input text-sm"})]})]}),n.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"Latitude *"}),n.jsx("input",{type:"number",step:"any",value:w.lat,onChange:R=>o(F=>({...F,lat:R.target.value})),placeholder:"e.g., 49.7",className:"input text-sm"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"Longitude *"}),n.jsx("input",{type:"number",step:"any",value:w.lng,onChange:R=>o(F=>({...F,lng:R.target.value})),placeholder:"e.g., -123.1",className:"input text-sm"})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"Notes"}),n.jsx("input",{type:"text",value:w.notes,onChange:R=>o(F=>({...F,notes:R.target.value})),placeholder:"e.g., Guy wires, red aviation lights",className:"input text-sm"})]}),n.jsxs("div",{className:"flex justify-end gap-2",children:[n.jsx("button",{type:"button",onClick:()=>x(!1),className:"px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800",children:"Cancel"}),n.jsx("button",{type:"button",onClick:C,className:"px-3 py-1.5 text-sm bg-aeria-navy text-white rounded-lg hover:bg-aeria-navy/90",children:"Add Obstacle"})]})]}):n.jsxs("button",{type:"button",onClick:()=>x(!0),className:"w-full py-2 px-4 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-gray-400 hover:text-gray-600 flex items-center justify-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Add Obstacle Manually"]}),t.length===0?n.jsx("p",{className:"text-sm text-gray-500 italic text-center py-4",children:"No obstacles marked yet."}):n.jsx("div",{className:"space-y-2",children:t.map(R=>{var $;const F=b0.find(Y=>Y.value===R.obstacleType)||b0[b0.length-1];return n.jsxs("div",{className:"flex items-start gap-3 p-3 bg-gray-50 rounded-lg",children:[n.jsx("span",{className:"text-xl",children:F.icon}),n.jsxs("div",{className:"flex-1 min-w-0 space-y-2",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("select",{value:R.obstacleType||"other",onChange:Y=>e(R.id,{obstacleType:Y.target.value}),className:"input text-sm py-1",children:b0.map(Y=>n.jsx("option",{value:Y.value,children:Y.label},Y.value))}),n.jsx("input",{type:"number",value:R.height||"",onChange:Y=>e(R.id,{height:Y.target.value?Number(Y.target.value):null}),placeholder:"Height (m)",className:"input text-sm py-1 w-28"})]}),n.jsx("input",{type:"text",value:R.notes||"",onChange:Y=>e(R.id,{notes:Y.target.value}),placeholder:"Notes (e.g., guy wires, lighting)",className:"input text-sm py-1 w-full"}),(($=R.geometry)==null?void 0:$.coordinates)&&n.jsxs("p",{className:"text-xs text-gray-500",children:["Location: ",R.geometry.coordinates[1].toFixed(5),", ",R.geometry.coordinates[0].toFixed(5)]})]}),n.jsx("button",{type:"button",onClick:()=>r(R.id),className:"p-1 text-gray-400 hover:text-red-500 rounded",children:n.jsx(Ln,{className:"w-4 h-4"})})]},R.id)})})]})}function nae({project:t,onUpdate:e}){var Te,Ce,ne,ae,q,oe,ke,Ve,ie,ze,ve,Le,Ke,Pe,It,tt,zt,vt,Ot;const[r,c]=ue.useState(!0),h=zT(t,e,{editMode:!0,allowedLayers:["siteSurvey"],initialBasemap:"streets"}),x=ue.useMemo(()=>Array.isArray(t==null?void 0:t.sites)?t.sites:[],[t==null?void 0:t.sites]),w=(t==null?void 0:t.activeSiteId)||((Te=x[0])==null?void 0:Te.id)||null,o=ue.useMemo(()=>x.find(Et=>Et.id===w)||x[0]||null,[x,w]),C=(o==null?void 0:o.siteSurvey)||{},R=((Ce=o==null?void 0:o.mapData)==null?void 0:Ce.siteSurvey)||{},F=ue.useCallback(Et=>{e({activeSiteId:Et})},[e]),$=ue.useCallback(()=>{const Et=CT({name:`Site ${x.length+1}`,order:x.length});e({sites:[...x,Et],activeSiteId:Et.id})},[x,e]),Y=ue.useCallback(Et=>{const yi=x.find(ht=>ht.id===Et);if(!yi)return;const mi={...JSON.parse(JSON.stringify(yi)),id:`site_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:`${yi.name} (Copy)`,status:"draft",order:x.length,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};e({sites:[...x,mi],activeSiteId:mi.id})},[x,e]),H=ue.useCallback(Et=>{var ht;if(x.length<=1){alert("Cannot delete the last site");return}if(!confirm("Are you sure you want to delete this site?"))return;const yi=x.filter(hi=>hi.id!==Et),mi=w===Et?(ht=yi[0])==null?void 0:ht.id:w;e({sites:yi,activeSiteId:mi})},[x,w,e]),X=ue.useCallback((Et,yi)=>{const mi=x.map(ht=>ht.id===Et?{...ht,name:yi,updatedAt:new Date().toISOString()}:ht);e({sites:mi})},[x,e]),he=ue.useCallback(Et=>{if(!w)return;const yi=x.map(mi=>mi.id!==w?mi:{...mi,siteSurvey:{...mi.siteSurvey,...Et},updatedAt:new Date().toISOString()});e({sites:yi})},[x,w,e]),se=ue.useCallback((Et,yi)=>{if(!w)return;const mi=x.map(ht=>{var hi;return ht.id!==w?ht:{...ht,siteSurvey:{...ht.siteSurvey,[Et]:{...((hi=ht.siteSurvey)==null?void 0:hi[Et])||{},...yi}},updatedAt:new Date().toISOString()}});e({sites:mi})},[x,w,e]),de=ue.useCallback((Et,yi)=>{if(!w)return;const mi=x.map(ht=>{var ui,Fi,Ii;if(ht.id!==w)return ht;const ni=(((Fi=(ui=ht.mapData)==null?void 0:ui.siteSurvey)==null?void 0:Fi.obstacles)||[]).map(Bi=>Bi.id===Et?{...Bi,...yi,updatedAt:new Date().toISOString()}:Bi);return{...ht,mapData:{...ht.mapData,siteSurvey:{...(Ii=ht.mapData)==null?void 0:Ii.siteSurvey,obstacles:ni}},updatedAt:new Date().toISOString()}});e({sites:mi})},[x,w,e]),K=ue.useCallback(Et=>{if(!w)return;const yi=x.map(mi=>{var hi,ni,ui;if(mi.id!==w)return mi;const ht=((ni=(hi=mi.mapData)==null?void 0:hi.siteSurvey)==null?void 0:ni.obstacles)||[];return{...mi,mapData:{...mi.mapData,siteSurvey:{...(ui=mi.mapData)==null?void 0:ui.siteSurvey,obstacles:ht.filter(Fi=>Fi.id!==Et)}},updatedAt:new Date().toISOString()}});e({sites:yi})},[x,w,e]),ge=ue.useCallback(Et=>{if(!w)return;const yi={id:`obstacle_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,elementType:"obstacle",...Et,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},mi=x.map(ht=>{var ni,ui,Fi;if(ht.id!==w)return ht;const hi=((ui=(ni=ht.mapData)==null?void 0:ni.siteSurvey)==null?void 0:ui.obstacles)||[];return{...ht,mapData:{...ht.mapData,siteSurvey:{...(Fi=ht.mapData)==null?void 0:Fi.siteSurvey,obstacles:[...hi,yi]}},updatedAt:new Date().toISOString()}});e({sites:mi})},[x,w,e]),Ae=ue.useMemo(()=>o?B6(o):null,[o]);return o?n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[n.jsxs("div",{children:[n.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Site Survey"}),n.jsx("p",{className:"text-gray-500",children:"Document location, boundaries, and hazards for each operation site"})]}),n.jsx("div",{className:"flex items-center gap-2",children:n.jsxs("button",{onClick:()=>c(!r),className:`btn ${r?"btn-primary":"btn-secondary"} inline-flex items-center gap-2`,children:[r?n.jsx(ga,{className:"w-4 h-4"}):n.jsx(Wn,{className:"w-4 h-4"}),r?"Viewing Map":"Show Map"]})})]}),n.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-6",children:[n.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[n.jsx(iae,{sites:x,activeSiteId:w,onSelectSite:F,onAddSite:$,onDuplicateSite:Y,onDeleteSite:H,onRenameSite:X}),r&&n.jsx(BT,{visibleLayers:h.visibleLayers,onToggleLayer:h.toggleLayer,allowedLayers:["siteSurvey"]}),r&&x.length>1&&n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3",children:[n.jsxs("label",{className:"flex items-center justify-between cursor-pointer",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(ga,{className:"w-4 h-4 text-gray-500"}),n.jsx("span",{className:"text-sm font-medium text-gray-700",children:"View All Sites"})]}),n.jsxs("div",{className:"relative",children:[n.jsx("input",{type:"checkbox",checked:h.showAllSites,onChange:Et=>h.setShowAllSites(Et.target.checked),className:"sr-only peer"}),n.jsx("div",{className:"w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-aeria-navy/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-aeria-navy"})]})]}),h.showAllSites&&n.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["Showing data from all ",x.length," sites. Each site has a unique color."]})]}),r&&n.jsx(VT,{drawingMode:h.drawingMode,isDrawing:h.isDrawing,drawingPoints:h.drawingPoints,onStartDrawing:h.startDrawing,onCancelDrawing:h.cancelDrawing,onCompleteDrawing:h.completeDrawing,onRemoveLastPoint:h.removeLastDrawingPoint,activeLayer:"siteSurvey",editMode:!0}),Ae&&n.jsxs("div",{className:`p-4 rounded-lg border ${Ae.isComplete?"bg-green-50 border-green-200":"bg-amber-50 border-amber-200"}`,children:[n.jsx("h4",{className:`font-medium mb-2 ${Ae.isComplete?"text-green-800":"text-amber-800"}`,children:Ae.isComplete?" Survey Complete":"Survey Incomplete"}),!Ae.isComplete&&n.jsx("ul",{className:"text-sm space-y-1",children:Ae.issues.map((Et,yi)=>n.jsxs("li",{className:"text-amber-700",children:[" ",Et.message]},yi))})]})]}),n.jsxs("div",{className:"lg:col-span-3 space-y-6",children:[r&&n.jsx("div",{className:"card p-0 overflow-hidden",children:n.jsx(Wj,{project:t,onUpdate:e,editMode:!0,activeLayer:"siteSurvey",height:"400px",allowedLayers:["siteSurvey"],showLegend:!0,showControls:!1,externalMapData:h,onSiteChange:F})}),n.jsxs($g,{title:"Location Details",icon:Wn,badge:R.siteLocation?"Set":null,children:[n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Site Name / Description"}),n.jsx("input",{type:"text",value:C.locationName||"",onChange:Et=>he({locationName:Et.target.value}),placeholder:"e.g., North Field Survey Area",className:"input"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Address / Location Reference"}),n.jsx("input",{type:"text",value:C.address||"",onChange:Et=>he({address:Et.target.value}),placeholder:"e.g., 123 Industrial Rd, Calgary AB",className:"input"})]})]}),R.siteLocation&&n.jsx("div",{className:"mt-3 p-3 bg-blue-50 rounded-lg",children:n.jsxs("p",{className:"text-sm text-blue-800",children:[n.jsx(Wn,{className:"w-4 h-4 inline mr-1"}),n.jsx("strong",{children:"Coordinates:"})," ",R.siteLocation.geometry.coordinates[1].toFixed(6),","," ",R.siteLocation.geometry.coordinates[0].toFixed(6)]})}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Access Instructions"}),n.jsx("textarea",{value:C.accessInstructions||"",onChange:Et=>he({accessInstructions:Et.target.value}),placeholder:"Describe how to access the site, gate codes, parking locations...",rows:3,className:"input"})]})]}),n.jsxs($g,{title:"Population Assessment",icon:ds,badge:(ne=C.population)!=null&&ne.category?(ae=pI[C.population.category])==null?void 0:ae.label:null,children:[n.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4",children:n.jsxs("p",{className:"text-sm text-amber-800",children:[n.jsx(ir,{className:"w-4 h-4 inline mr-1"}),n.jsx("strong",{children:"SORA Requirement:"})," Population category determines initial Ground Risk Class (iGRC). Select the category that best represents the operations area."]})}),n.jsx(L3,{value:(q=C.population)==null?void 0:q.category,onChange:Et=>se("population",{category:Et,assessmentDate:new Date().toISOString()}),label:"Operations Area Population"}),n.jsx("div",{className:"mt-4",children:n.jsx(L3,{value:(oe=C.population)==null?void 0:oe.adjacentCategory,onChange:Et=>se("population",{adjacentCategory:Et}),label:"Adjacent Area Population (for containment assessment)"})}),n.jsxs("div",{className:"mt-4",children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Population Assessment Justification"}),n.jsx("textarea",{value:((ke=C.population)==null?void 0:ke.justification)||"",onChange:Et=>se("population",{justification:Et.target.value}),placeholder:"Describe the basis for your population category selection...",rows:3,className:"input"})]})]}),n.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[n.jsxs("div",{className:"flex items-center gap-2 text-blue-800",children:[n.jsx(Zn,{className:"w-5 h-5"}),n.jsx("span",{className:"font-medium",children:"Airspace Classification"})]}),n.jsxs("p",{className:"text-sm text-blue-700 mt-1",children:["Airspace information is now configured in the ",n.jsx("strong",{children:"Flight Plan"})," section, as it's directly related to flight operations and SORA air risk assessment."]}),n.jsxs("button",{type:"button",onClick:()=>onNavigateToSection==null?void 0:onNavigateToSection("flightPlan"),className:"mt-2 text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1",children:["Go to Flight Plan",n.jsx(fc,{className:"w-3 h-3"})]})]}),n.jsxs($g,{title:"Obstacles & Hazards",icon:ir,badge:((Ve=R.obstacles)==null?void 0:Ve.length)>0?`${R.obstacles.length} marked`:null,children:[n.jsx("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4",children:n.jsxs("p",{className:"text-sm text-gray-600",children:[n.jsx(Ns,{className:"w-4 h-4 inline mr-1"}),"Mark obstacles using the ",n.jsx("strong",{children:"map drawing tools"})," or ",n.jsx("strong",{children:"add manually"})," below with coordinates."]})}),n.jsx(rae,{obstacles:R.obstacles||[],onUpdate:de,onRemove:K,onAdd:ge})]}),n.jsxs($g,{title:"Site Surroundings",icon:xS,defaultOpen:!1,children:[n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[n.jsx(xS,{className:"w-4 h-4 inline mr-1"}),"Terrain"]}),n.jsx("input",{type:"text",value:((ie=C.surroundings)==null?void 0:ie.terrain)||"",onChange:Et=>se("surroundings",{terrain:Et.target.value}),placeholder:"e.g., Flat agricultural land, gentle slope",className:"input"})]}),n.jsxs("div",{children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[n.jsx(Qie,{className:"w-4 h-4 inline mr-1"}),"Vegetation"]}),n.jsx("input",{type:"text",value:((ze=C.surroundings)==null?void 0:ze.vegetation)||"",onChange:Et=>se("surroundings",{vegetation:Et.target.value}),placeholder:"e.g., Open grassland, scattered trees",className:"input"})]}),n.jsxs("div",{children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[n.jsx(zy,{className:"w-4 h-4 inline mr-1"}),"Structures"]}),n.jsx("input",{type:"text",value:((ve=C.surroundings)==null?void 0:ve.structures)||"",onChange:Et=>se("surroundings",{structures:Et.target.value}),placeholder:"e.g., Industrial buildings to the east",className:"input"})]}),n.jsxs("div",{children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[n.jsx(xie,{className:"w-4 h-4 inline mr-1"}),"Water Features"]}),n.jsx("input",{type:"text",value:((Le=C.surroundings)==null?void 0:Le.waterFeatures)||"",onChange:Et=>se("surroundings",{waterFeatures:Et.target.value}),placeholder:"e.g., Creek 200m south, pond on-site",className:"input"})]})]}),n.jsxs("div",{className:"mt-4",children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Wildlife Considerations"}),n.jsx("textarea",{value:((Ke=C.surroundings)==null?void 0:Ke.wildlife)||"",onChange:Et=>se("surroundings",{wildlife:Et.target.value}),placeholder:"Note any wildlife concerns, nesting areas, migration patterns...",rows:2,className:"input"})]})]}),n.jsxs($g,{title:"Site Access",icon:mie,defaultOpen:!1,children:[n.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[n.jsxs("label",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer",children:[n.jsx("input",{type:"checkbox",checked:((Pe=C.access)==null?void 0:Pe.vehicleAccess)??!0,onChange:Et=>se("access",{vehicleAccess:Et.target.checked}),className:"w-4 h-4 text-aeria-navy rounded focus:ring-aeria-navy"}),n.jsxs("div",{children:[n.jsx("p",{className:"font-medium text-gray-900",children:"Vehicle Access"}),n.jsx("p",{className:"text-sm text-gray-500",children:"Site accessible by vehicle"})]})]}),n.jsxs("label",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer",children:[n.jsx("input",{type:"checkbox",checked:((It=C.access)==null?void 0:It.parkingAvailable)??!0,onChange:Et=>se("access",{parkingAvailable:Et.target.checked}),className:"w-4 h-4 text-aeria-navy rounded focus:ring-aeria-navy"}),n.jsxs("div",{children:[n.jsx("p",{className:"font-medium text-gray-900",children:"Parking Available"}),n.jsx("p",{className:"text-sm text-gray-500",children:"Adequate parking on-site"})]})]})]}),n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[n.jsx(Iie,{className:"w-4 h-4 inline mr-1"}),"Land Owner / Contact"]}),n.jsx("input",{type:"text",value:((tt=C.access)==null?void 0:tt.landOwner)||"",onChange:Et=>se("access",{landOwner:Et.target.value}),placeholder:"e.g., ABC Corp - John Smith",className:"input"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Permissions Required"}),n.jsx("input",{type:"text",value:Array.isArray((zt=C.access)==null?void 0:zt.permissionsRequired)?C.access.permissionsRequired.join(", "):"",onChange:Et=>se("access",{permissionsRequired:Et.target.value.split(",").map(yi=>yi.trim()).filter(Boolean)}),placeholder:"e.g., Land access permit, Site induction",className:"input"})]})]}),n.jsxs("div",{className:"mt-4",children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Access Notes"}),n.jsx("textarea",{value:((vt=C.access)==null?void 0:vt.accessNotes)||"",onChange:Et=>se("access",{accessNotes:Et.target.value}),placeholder:"Gate codes, special access requirements, timing restrictions...",rows:2,className:"input"})]})]}),n.jsxs($g,{title:"Survey Notes & Photos",icon:rs,defaultOpen:!1,children:[n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Survey Date"}),n.jsx("input",{type:"date",value:C.surveyDate?C.surveyDate.split("T")[0]:"",onChange:Et=>he({surveyDate:Et.target.value}),className:"input"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Surveyed By"}),n.jsx("input",{type:"text",value:C.surveyedBy||"",onChange:Et=>he({surveyedBy:Et.target.value}),placeholder:"e.g., John Smith, PIC",className:"input"})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Additional Notes"}),n.jsx("textarea",{value:C.notes||"",onChange:Et=>he({notes:Et.target.value}),placeholder:"Any additional observations or notes from the site survey...",rows:4,className:"input"})]}),n.jsxs("div",{className:"mt-6",children:[n.jsxs("h4",{className:"text-sm font-medium text-gray-700 mb-3 flex items-center gap-2",children:[n.jsx(bl,{className:"w-4 h-4"}),"Site Photos",n.jsx(tae,{count:(Ot=C.photos)==null?void 0:Ot.length})]}),n.jsx(eae,{projectId:t==null?void 0:t.id,siteId:w,photos:C.photos||[],onPhotosChange:Et=>he({photos:Et}),maxPhotos:20})]})]})]})]})]}):n.jsxs("div",{className:"text-center py-12",children:[n.jsx(Wn,{className:"w-12 h-12 mx-auto text-gray-300 mb-4"}),n.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Sites Configured"}),n.jsx("p",{className:"text-gray-500 mb-4",children:"Add your first operation site to begin the survey."}),n.jsxs("button",{onClick:$,className:"btn-primary",children:[n.jsx(vr,{className:"w-4 h-4 mr-2"}),"Add First Site"]})]})}const F3=[{id:"flyaway",label:"Fly-Away / Lost Link",icon:"",color:"red"},{id:"injury",label:"Personal Injury",icon:"",color:"amber"},{id:"fire",label:"Fire",icon:"",color:"orange"},{id:"medical",label:"Medical Emergency",icon:"",color:"red"},{id:"collision",label:"Collision / Crash",icon:"",color:"red"},{id:"wildlife",label:"Wildlife Encounter",icon:"",color:"amber"},{id:"weather",label:"Severe Weather",icon:"",color:"blue"},{id:"security",label:"Security Threat",icon:"",color:"purple"},{id:"environmental",label:"Environmental Spill",icon:"",color:"green"}],sae=[{name:"Emergency Services",phone:"911",role:"emergency",isPrimary:!0},{name:"NAV CANADA FIC",phone:"1-866-541-4101",role:"aviation",notes:"Flight Information Centre - Report fly-away/incidents"},{name:"Transport Canada",phone:"1-888-463-0521",role:"regulatory",notes:"Civil Aviation - Serious incident reporting"}],aae=[{type:"flyaway",steps:["Immediately attempt to regain control using all available means","If control cannot be regained within 30 seconds, assume fly-away","Contact NAV CANADA FIC (1-866-541-4101) immediately","Provide: Aircraft type, last known position, altitude, heading","Alert all crew to monitor for aircraft","Do NOT leave the area until authorized","Complete incident report within 24 hours"]},{type:"injury",steps:["Stop all flight operations immediately","Assess the scene for ongoing hazards","Call 911 if serious injury","Administer first aid within training limits","Do not move injured person unless in immediate danger","Designate someone to meet emergency services","Document incident details"]},{type:"collision",steps:["Ensure safety of all personnel","Secure the crash site - do not disturb wreckage","Call 911 if injuries or property damage","Contact NAV CANADA FIC immediately","Photograph scene before any cleanup","Collect witness statements","Report to Transport Canada within 24 hours if required"]}];function Gg({title:t,icon:e,children:r,defaultOpen:c=!0,badge:h=null}){const[x,w]=ue.useState(c);return n.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[n.jsxs("button",{onClick:()=>w(!x),className:"w-full px-4 py-3 bg-gray-50 flex items-center justify-between hover:bg-gray-100 transition-colors",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[e&&n.jsx(e,{className:"w-5 h-5 text-gray-500"}),n.jsx("span",{className:"font-medium text-gray-900",children:t}),h&&n.jsx("span",{className:"px-2 py-0.5 text-xs font-medium bg-red-100 text-red-700 rounded-full",children:h})]}),x?n.jsx($n,{className:"w-5 h-5 text-gray-400"}):n.jsx(fn,{className:"w-5 h-5 text-gray-400"})]}),x&&n.jsx("div",{className:"p-4 space-y-4",children:r})]})}function oae({sites:t,activeSiteId:e,onSelectSite:r}){return t.length<=1?null:n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 flex items-center gap-3 overflow-x-auto",children:[n.jsx("span",{className:"text-sm font-medium text-gray-500 whitespace-nowrap",children:"Site:"}),n.jsx("div",{className:"flex gap-2",children:t.map((c,h)=>{var o,C,R;const x=c.id===e,w=((R=(C=(o=c.mapData)==null?void 0:o.emergency)==null?void 0:C.musterPoints)==null?void 0:R.length)||0;return n.jsxs("button",{onClick:()=>r(c.id),className:`px-3 py-1.5 rounded-lg text-sm font-medium whitespace-nowrap transition-colors flex items-center gap-2 ${x?"bg-red-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[n.jsx("div",{className:"w-2 h-2 rounded-full",style:{backgroundColor:x?"white":`hsl(${h*60}, 70%, 50%)`}}),c.name,w>0&&n.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded-full ${x?"bg-white/20":"bg-red-100 text-red-700"}`,children:w})]},c.id)})})]})}function lae({musterPoints:t=[],onUpdate:e,onRemove:r,onSetPrimary:c}){return t.length===0?n.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-6 text-center",children:[n.jsx(lf,{className:"w-8 h-8 mx-auto text-gray-400 mb-2"}),n.jsx("p",{className:"text-gray-600 mb-2",children:"No muster points defined"}),n.jsxs("p",{className:"text-sm text-gray-500",children:["Use the ",n.jsx("strong",{children:"Muster Point"})," tool on the map to add rally points"]})]}):n.jsx("div",{className:"space-y-2",children:t.map((h,x)=>{var w;return n.jsxs("div",{className:`flex items-start gap-3 p-3 rounded-lg border ${h.isPrimary?"bg-red-50 border-red-200":"bg-gray-50 border-gray-200"}`,children:[n.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${h.isPrimary?"bg-red-500 text-white":"bg-gray-300 text-gray-600"}`,children:n.jsx(lf,{className:"w-4 h-4"})}),n.jsxs("div",{className:"flex-1 min-w-0 space-y-2",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("input",{type:"text",value:h.name||`Muster Point ${x+1}`,onChange:o=>e(h.id,{name:o.target.value}),className:"input text-sm py-1 flex-1",placeholder:"Muster point name"}),h.isPrimary&&n.jsx("span",{className:"px-2 py-0.5 text-xs font-medium bg-red-100 text-red-700 rounded-full",children:"Primary"})]}),n.jsx("textarea",{value:h.description||"",onChange:o=>e(h.id,{description:o.target.value}),placeholder:"Description (e.g., Near main gate, by large oak tree)",rows:2,className:"input text-sm"}),((w=h.geometry)==null?void 0:w.coordinates)&&n.jsxs("p",{className:"text-xs text-gray-500",children:[" ",h.geometry.coordinates[1].toFixed(5),", ",h.geometry.coordinates[0].toFixed(5)]})]}),n.jsxs("div",{className:"flex flex-col gap-1",children:[n.jsx("button",{onClick:()=>c(h.id),className:`p-1.5 rounded ${h.isPrimary?"text-red-500 bg-red-100":"text-gray-400 hover:text-amber-500 hover:bg-amber-50"}`,title:h.isPrimary?"Primary muster point":"Set as primary",children:h.isPrimary?n.jsx(j6,{className:"w-4 h-4 fill-current"}):n.jsx(P6,{className:"w-4 h-4"})}),n.jsx("button",{onClick:()=>r(h.id),className:"p-1.5 text-gray-400 hover:text-red-500 rounded hover:bg-red-50",title:"Remove muster point",children:n.jsx(Ln,{className:"w-4 h-4"})})]})]},h.id)})})}function cae({routes:t=[],onUpdate:e,onRemove:r,onSetPrimary:c}){return t.length===0?n.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-6 text-center",children:[n.jsx(_S,{className:"w-8 h-8 mx-auto text-gray-400 mb-2"}),n.jsx("p",{className:"text-gray-600 mb-2",children:"No evacuation routes defined"}),n.jsxs("p",{className:"text-sm text-gray-500",children:["Use the ",n.jsx("strong",{children:"Evacuation Route"})," tool on the map to draw routes"]})]}):n.jsx("div",{className:"space-y-2",children:t.map((h,x)=>n.jsxs("div",{className:`flex items-start gap-3 p-3 rounded-lg border ${h.isPrimary?"bg-red-50 border-red-200":"bg-gray-50 border-gray-200"}`,children:[n.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${h.isPrimary?"bg-red-500 text-white":"bg-gray-300 text-gray-600"}`,children:n.jsx(_S,{className:"w-4 h-4"})}),n.jsxs("div",{className:"flex-1 min-w-0 space-y-2",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("input",{type:"text",value:h.name||`Route ${x+1}`,onChange:w=>e(h.id,{name:w.target.value}),className:"input text-sm py-1 flex-1",placeholder:"Route name"}),h.isPrimary&&n.jsx("span",{className:"px-2 py-0.5 text-xs font-medium bg-red-100 text-red-700 rounded-full",children:"Primary"})]}),n.jsx("textarea",{value:h.description||"",onChange:w=>e(h.id,{description:w.target.value}),placeholder:"Route description (e.g., Follow access road to main gate)",rows:2,className:"input text-sm"})]}),n.jsxs("div",{className:"flex flex-col gap-1",children:[n.jsx("button",{onClick:()=>c(h.id),className:`p-1.5 rounded ${h.isPrimary?"text-red-500 bg-red-100":"text-gray-400 hover:text-amber-500 hover:bg-amber-50"}`,title:h.isPrimary?"Primary route":"Set as primary",children:h.isPrimary?n.jsx(j6,{className:"w-4 h-4 fill-current"}):n.jsx(P6,{className:"w-4 h-4"})}),n.jsx("button",{onClick:()=>r(h.id),className:"p-1.5 text-gray-400 hover:text-red-500 rounded hover:bg-red-50",title:"Remove route",children:n.jsx(Ln,{className:"w-4 h-4"})})]})]},h.id))})}function uae({contacts:t=[],onChange:e}){const r=()=>{e([...t,{id:`contact_${Date.now()}`,name:"",phone:"",role:"",notes:"",isPrimary:t.length===0}])},c=(w,o,C)=>{const R=[...t];R[w]={...R[w],[o]:C},e(R)},h=w=>{e(t.filter((o,C)=>C!==w))},x=()=>{t.length>0&&!confirm("This will add default emergency contacts. Continue?")||e([...t,...sae.map(w=>({...w,id:`contact_${Date.now()}_${Math.random().toString(36).substr(2,5)}`}))])};return n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("p",{className:"text-sm text-gray-600",children:"Key contacts for emergency response"}),n.jsxs("button",{type:"button",onClick:x,className:"text-sm text-aeria-navy hover:underline flex items-center gap-1",children:[n.jsx(Op,{className:"w-3 h-3"}),"Add Default Contacts"]})]}),t.map((w,o)=>n.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg space-y-2",children:[n.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[n.jsx("input",{type:"text",value:w.name||"",onChange:C=>c(o,"name",C.target.value),placeholder:"Name / Organization",className:"input text-sm py-1.5"}),n.jsx("input",{type:"tel",value:w.phone||"",onChange:C=>c(o,"phone",C.target.value),placeholder:"Phone Number",className:"input text-sm py-1.5"}),n.jsxs("div",{className:"flex gap-2",children:[n.jsxs("select",{value:w.role||"",onChange:C=>c(o,"role",C.target.value),className:"input text-sm py-1.5 flex-1",children:[n.jsx("option",{value:"",children:"Select role..."}),n.jsx("option",{value:"emergency",children:"Emergency Services"}),n.jsx("option",{value:"aviation",children:"Aviation Authority"}),n.jsx("option",{value:"regulatory",children:"Regulatory"}),n.jsx("option",{value:"client",children:"Client Contact"}),n.jsx("option",{value:"manager",children:"Operations Manager"}),n.jsx("option",{value:"safety",children:"Safety Officer"}),n.jsx("option",{value:"medical",children:"Medical"}),n.jsx("option",{value:"other",children:"Other"})]}),n.jsx("button",{onClick:()=>h(o),className:"p-1.5 text-gray-400 hover:text-red-500 rounded",children:n.jsx(Ln,{className:"w-4 h-4"})})]})]}),n.jsx("input",{type:"text",value:w.notes||"",onChange:C=>c(o,"notes",C.target.value),placeholder:"Notes (when to contact, availability)",className:"input text-sm py-1.5 w-full"})]},w.id||o)),n.jsxs("button",{type:"button",onClick:r,className:"w-full px-4 py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-gray-400 hover:text-gray-600 flex items-center justify-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Add Contact"]})]})}function dae({facilities:t={},onChange:e}){const r=(c,h)=>{e({...t,[c]:h})};return n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{className:"p-4 bg-red-50 border border-red-200 rounded-lg",children:[n.jsxs("h4",{className:"font-medium text-red-800 mb-3 flex items-center gap-2",children:[n.jsx(sie,{className:"w-5 h-5"}),"Nearest Hospital"]}),n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[n.jsx("input",{type:"text",value:t.hospitalName||"",onChange:c=>r("hospitalName",c.target.value),placeholder:"Hospital Name",className:"input text-sm"}),n.jsx("input",{type:"tel",value:t.hospitalPhone||"",onChange:c=>r("hospitalPhone",c.target.value),placeholder:"Phone Number",className:"input text-sm"}),n.jsx("input",{type:"text",value:t.hospitalAddress||"",onChange:c=>r("hospitalAddress",c.target.value),placeholder:"Address",className:"input text-sm md:col-span-2"}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("input",{type:"number",step:"0.1",value:t.hospitalDistance||"",onChange:c=>r("hospitalDistance",c.target.value?Number(c.target.value):null),placeholder:"Distance",className:"input text-sm w-24"}),n.jsx("span",{className:"text-sm text-gray-500",children:"km"}),n.jsx("input",{type:"number",value:t.hospitalTime||"",onChange:c=>r("hospitalTime",c.target.value?Number(c.target.value):null),placeholder:"Time",className:"input text-sm w-24"}),n.jsx("span",{className:"text-sm text-gray-500",children:"min"})]})]})]}),n.jsxs("div",{className:"p-4 bg-orange-50 border border-orange-200 rounded-lg",children:[n.jsxs("h4",{className:"font-medium text-orange-800 mb-3 flex items-center gap-2",children:[n.jsx(Tie,{className:"w-5 h-5"}),"Nearest Fire Station"]}),n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[n.jsx("input",{type:"text",value:t.fireStationName||"",onChange:c=>r("fireStationName",c.target.value),placeholder:"Fire Station Name",className:"input text-sm"}),n.jsx("input",{type:"tel",value:t.fireStationPhone||"",onChange:c=>r("fireStationPhone",c.target.value),placeholder:"Non-Emergency Phone",className:"input text-sm"})]})]}),n.jsxs("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[n.jsxs("h4",{className:"font-medium text-blue-800 mb-3 flex items-center gap-2",children:[n.jsx(Ds,{className:"w-5 h-5"}),"Nearest Police / RCMP"]}),n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[n.jsx("input",{type:"text",value:t.policeStationName||"",onChange:c=>r("policeStationName",c.target.value),placeholder:"Detachment Name",className:"input text-sm"}),n.jsx("input",{type:"tel",value:t.policeStationPhone||"",onChange:c=>r("policeStationPhone",c.target.value),placeholder:"Non-Emergency Phone",className:"input text-sm"})]})]})]})}function hae({procedures:t=[],onChange:e}){const[r,c]=ue.useState(null),h=R=>{const F=aae.find($=>$.type===R);e([...t,{id:`proc_${Date.now()}`,type:R,steps:(F==null?void 0:F.steps)||[""],notes:""}])},x=(R,F)=>{e(t.map($=>$.id===R?{...$,steps:F}:$))},w=R=>{e(t.filter(F=>F.id!==R))},o=t.map(R=>R.type),C=F3.filter(R=>!o.includes(R.id));return n.jsxs("div",{className:"space-y-3",children:[t.map(R=>{var Y;const F=F3.find(H=>H.id===R.type),$=r===R.id;return n.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[n.jsxs("button",{onClick:()=>c($?null:R.id),className:"w-full px-4 py-3 bg-gray-50 flex items-center justify-between hover:bg-gray-100",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("span",{className:"text-xl",children:(F==null?void 0:F.icon)||""}),n.jsx("span",{className:"font-medium text-gray-900",children:(F==null?void 0:F.label)||R.type}),n.jsxs("span",{className:"text-sm text-gray-500",children:["(",((Y=R.steps)==null?void 0:Y.length)||0," steps)"]})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("button",{onClick:H=>{H.stopPropagation(),w(R.id)},className:"p-1 text-gray-400 hover:text-red-500",children:n.jsx(Ln,{className:"w-4 h-4"})}),$?n.jsx($n,{className:"w-4 h-4"}):n.jsx(fn,{className:"w-4 h-4"})]})]}),$&&n.jsxs("div",{className:"p-4 space-y-3",children:[n.jsx("p",{className:"text-sm text-gray-500",children:"Define step-by-step response procedure:"}),(R.steps||[""]).map((H,X)=>n.jsxs("div",{className:"flex items-start gap-2",children:[n.jsx("span",{className:"w-6 h-6 rounded-full bg-gray-200 text-gray-600 text-xs flex items-center justify-center flex-shrink-0 mt-1",children:X+1}),n.jsx("textarea",{value:H,onChange:he=>{const se=[...R.steps];se[X]=he.target.value,x(R.id,se)},placeholder:`Step ${X+1}`,rows:2,className:"input text-sm flex-1"}),n.jsx("button",{onClick:()=>{const he=R.steps.filter((se,de)=>de!==X);x(R.id,he.length?he:[""])},className:"p-1 text-gray-400 hover:text-red-500",children:n.jsx(Ln,{className:"w-4 h-4"})})]},X)),n.jsxs("button",{onClick:()=>x(R.id,[...R.steps||[],""]),className:"text-sm text-aeria-navy hover:underline flex items-center gap-1",children:[n.jsx(vr,{className:"w-3 h-3"}),"Add Step"]})]})]},R.id)}),C.length>0&&n.jsxs("div",{className:"flex flex-wrap gap-2 pt-2",children:[n.jsx("span",{className:"text-sm text-gray-500 py-1",children:"Add procedure:"}),C.map(R=>n.jsxs("button",{onClick:()=>h(R.id),className:"px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-full flex items-center gap-1",children:[n.jsx("span",{children:R.icon}),R.label]},R.id))]})]})}function pae({project:t,onUpdate:e}){var K,ge,Ae,Te,Ce,ne;const[r,c]=ue.useState(!0),h=zT(t,e,{editMode:!0,allowedLayers:["siteSurvey","flightPlan","emergency"],initialBasemap:"streets"}),x=ue.useMemo(()=>Array.isArray(t==null?void 0:t.sites)?t.sites:[],[t==null?void 0:t.sites]),w=(t==null?void 0:t.activeSiteId)||((K=x[0])==null?void 0:K.id)||null,o=ue.useMemo(()=>x.find(ae=>ae.id===w)||x[0]||null,[x,w]),C=(t==null?void 0:t.emergencyPlan)||{},R=((ge=o==null?void 0:o.mapData)==null?void 0:ge.emergency)||{},F=ue.useCallback(ae=>{e({activeSiteId:ae})},[e]),$=ue.useCallback(ae=>{e({emergencyPlan:{...C,...ae}})},[C,e]),Y=ue.useCallback((ae,q)=>{if(!w)return;const oe=x.map(ke=>{var ze,ve,Le;if(ke.id!==w)return ke;const ie=(((ve=(ze=ke.mapData)==null?void 0:ze.emergency)==null?void 0:ve.musterPoints)||[]).map(Ke=>Ke.id===ae?{...Ke,...q}:Ke);return{...ke,mapData:{...ke.mapData,emergency:{...(Le=ke.mapData)==null?void 0:Le.emergency,musterPoints:ie}},updatedAt:new Date().toISOString()}});e({sites:oe})},[x,w,e]),H=ue.useCallback(ae=>{if(!w)return;const q=x.map(oe=>{var Ve,ie,ze;if(oe.id!==w)return oe;const ke=((ie=(Ve=oe.mapData)==null?void 0:Ve.emergency)==null?void 0:ie.musterPoints)||[];return{...oe,mapData:{...oe.mapData,emergency:{...(ze=oe.mapData)==null?void 0:ze.emergency,musterPoints:ke.filter(ve=>ve.id!==ae)}},updatedAt:new Date().toISOString()}});e({sites:q})},[x,w,e]),X=ue.useCallback(ae=>{if(!w)return;const q=x.map(oe=>{var ie,ze,ve;if(oe.id!==w)return oe;const Ve=(((ze=(ie=oe.mapData)==null?void 0:ie.emergency)==null?void 0:ze.musterPoints)||[]).map(Le=>({...Le,isPrimary:Le.id===ae}));return{...oe,mapData:{...oe.mapData,emergency:{...(ve=oe.mapData)==null?void 0:ve.emergency,musterPoints:Ve}},updatedAt:new Date().toISOString()}});e({sites:q})},[x,w,e]),he=ue.useCallback((ae,q)=>{if(!w)return;const oe=x.map(ke=>{var ze,ve,Le;if(ke.id!==w)return ke;const ie=(((ve=(ze=ke.mapData)==null?void 0:ze.emergency)==null?void 0:ve.evacuationRoutes)||[]).map(Ke=>Ke.id===ae?{...Ke,...q}:Ke);return{...ke,mapData:{...ke.mapData,emergency:{...(Le=ke.mapData)==null?void 0:Le.emergency,evacuationRoutes:ie}},updatedAt:new Date().toISOString()}});e({sites:oe})},[x,w,e]),se=ue.useCallback(ae=>{if(!w)return;const q=x.map(oe=>{var Ve,ie,ze;if(oe.id!==w)return oe;const ke=((ie=(Ve=oe.mapData)==null?void 0:Ve.emergency)==null?void 0:ie.evacuationRoutes)||[];return{...oe,mapData:{...oe.mapData,emergency:{...(ze=oe.mapData)==null?void 0:ze.emergency,evacuationRoutes:ke.filter(ve=>ve.id!==ae)}},updatedAt:new Date().toISOString()}});e({sites:q})},[x,w,e]),de=ue.useCallback(ae=>{if(!w)return;const q=x.map(oe=>{var ie,ze,ve;if(oe.id!==w)return oe;const Ve=(((ze=(ie=oe.mapData)==null?void 0:ie.emergency)==null?void 0:ze.evacuationRoutes)||[]).map(Le=>({...Le,isPrimary:Le.id===ae}));return{...oe,mapData:{...oe.mapData,emergency:{...(ve=oe.mapData)==null?void 0:ve.emergency,evacuationRoutes:Ve}},updatedAt:new Date().toISOString()}});e({sites:q})},[x,w,e]);return n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[n.jsxs("div",{children:[n.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Emergency Plan"}),n.jsx("p",{className:"text-gray-500",children:"Define muster points, evacuation routes, and emergency procedures"})]}),n.jsx("div",{className:"flex items-center gap-2",children:n.jsxs("button",{onClick:()=>c(!r),className:`btn ${r?"btn-primary":"btn-secondary"} inline-flex items-center gap-2`,children:[r?n.jsx(ga,{className:"w-4 h-4"}):n.jsx(Wn,{className:"w-4 h-4"}),r?"Viewing Map":"Show Map"]})})]}),n.jsx(oae,{sites:x,activeSiteId:w,onSelectSite:F}),n.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:n.jsxs("div",{className:"flex items-start gap-3",children:[n.jsx(Wie,{className:"w-6 h-6 text-red-500 flex-shrink-0"}),n.jsxs("div",{children:[n.jsx("h3",{className:"font-medium text-red-800",children:"In an Emergency: Call 911"}),n.jsxs("p",{className:"text-sm text-red-700 mt-1",children:["For fly-away incidents, also contact NAV CANADA FIC: ",n.jsx("strong",{children:"1-866-541-4101"})]})]})]})}),r&&n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{className:"flex flex-wrap gap-3 items-center",children:[n.jsx(BT,{visibleLayers:h.visibleLayers,onToggleLayer:h.toggleLayer,allowedLayers:["siteSurvey","flightPlan","emergency"],compact:!0}),n.jsx(VT,{drawingMode:h.drawingMode,isDrawing:h.isDrawing,drawingPoints:h.drawingPoints,onStartDrawing:h.startDrawing,onCancelDrawing:h.cancelDrawing,onCompleteDrawing:h.completeDrawing,onRemoveLastPoint:h.removeLastDrawingPoint,activeLayer:"emergency",editMode:!0}),x.length>1&&n.jsxs("label",{className:"flex items-center gap-2 px-3 py-2 bg-white rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50",children:[n.jsx("input",{type:"checkbox",checked:h.showAllSites,onChange:ae=>h.setShowAllSites(ae.target.checked),className:"w-4 h-4 text-aeria-navy rounded focus:ring-aeria-navy"}),n.jsx(ga,{className:"w-4 h-4 text-gray-500"}),n.jsx("span",{className:"text-sm text-gray-700",children:"All Sites"})]})]}),n.jsx("div",{className:"card p-0 overflow-hidden",children:n.jsx(Wj,{project:t,onUpdate:e,editMode:!0,activeLayer:"emergency",height:"400px",allowedLayers:["siteSurvey","flightPlan","emergency"],showLegend:!0,showControls:!1,externalMapData:h,onSiteChange:F})})]}),n.jsxs(Gg,{title:"Muster Points",icon:lf,badge:((Ae=R.musterPoints)==null?void 0:Ae.length)>0?`${R.musterPoints.length} points`:null,children:[n.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4",children:n.jsxs("p",{className:"text-sm text-blue-800",children:[n.jsx(Ns,{className:"w-4 h-4 inline mr-1"}),"Use the ",n.jsx("strong",{children:"Muster Point"})," drawing tool on the map to add rally points. Designate one as the primary muster point."]})}),n.jsx(lae,{musterPoints:R.musterPoints||[],onUpdate:Y,onRemove:H,onSetPrimary:X})]}),n.jsxs(Gg,{title:"Evacuation Routes",icon:_S,badge:((Te=R.evacuationRoutes)==null?void 0:Te.length)>0?`${R.evacuationRoutes.length} routes`:null,children:[n.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4",children:n.jsxs("p",{className:"text-sm text-blue-800",children:[n.jsx(Ns,{className:"w-4 h-4 inline mr-1"}),"Use the ",n.jsx("strong",{children:"Evacuation Route"})," drawing tool on the map to draw escape paths. Define primary and secondary routes."]})}),n.jsx(cae,{routes:R.evacuationRoutes||[],onUpdate:he,onRemove:se,onSetPrimary:de})]}),n.jsx(Gg,{title:"Emergency Contacts",icon:Hd,badge:((Ce=C.contacts)==null?void 0:Ce.length)>0?`${C.contacts.length}`:null,children:n.jsx(uae,{contacts:C.contacts||[],onChange:ae=>$({contacts:ae})})}),n.jsx(Gg,{title:"Nearest Emergency Facilities",icon:Vl,defaultOpen:!1,children:n.jsx(dae,{facilities:C.facilities||{},onChange:ae=>$({facilities:ae})})}),n.jsx(Gg,{title:"Emergency Response Procedures",icon:rs,badge:((ne=C.procedures)==null?void 0:ne.length)>0?`${C.procedures.length}`:null,defaultOpen:!1,children:n.jsx(hae,{procedures:C.procedures||[],onChange:ae=>$({procedures:ae})})}),n.jsx(Gg,{title:"Additional Emergency Notes",icon:ir,defaultOpen:!1,children:n.jsx("textarea",{value:C.notes||"",onChange:ae=>$({notes:ae.target.value}),placeholder:"Any additional emergency planning notes, site-specific hazards, or special considerations...",rows:4,className:"input"})})]})}const z3=[{id:"hard_hat",category:"head",item:"Hard Hat",specification:"CSA Z94.1 Type 1 or 2"},{id:"bump_cap",category:"head",item:"Bump Cap",specification:"For minor impact hazards"},{id:"sun_hat",category:"head",item:"Sun Hat / Wide Brim",specification:"UV protection"},{id:"winter_hat",category:"head",item:"Winter Hat / Toque",specification:"Cold weather protection"},{id:"safety_glasses",category:"eye",item:"Safety Glasses",specification:"ANSI Z87.1 / CSA Z94.3"},{id:"tinted_glasses",category:"eye",item:"Tinted Safety Glasses",specification:"UV protection"},{id:"safety_goggles",category:"eye",item:"Safety Goggles",specification:"Splash/dust protection"},{id:"face_shield",category:"eye",item:"Face Shield",specification:"Full face protection"},{id:"ear_plugs",category:"hearing",item:"Ear Plugs",specification:"NRR 25dB minimum"},{id:"ear_muffs",category:"hearing",item:"Ear Muffs",specification:"NRR 25dB minimum"},{id:"work_gloves",category:"hand",item:"Work Gloves",specification:"General purpose"},{id:"leather_gloves",category:"hand",item:"Leather Gloves",specification:"Cut/abrasion resistant"},{id:"insulated_gloves",category:"hand",item:"Insulated Gloves",specification:"Cold weather"},{id:"nitrile_gloves",category:"hand",item:"Nitrile Gloves",specification:"Chemical/fluid protection"},{id:"safety_boots",category:"foot",item:"Safety Boots",specification:"CSA Grade 1, green triangle"},{id:"rubber_boots",category:"foot",item:"Rubber Boots",specification:"Waterproof with safety toe"},{id:"winter_boots",category:"foot",item:"Insulated Winter Boots",specification:"CSA approved, -40C"},{id:"hi_vis_vest",category:"body",item:"High-Visibility Vest",specification:"CSA Z96-15 Class 2"},{id:"hi_vis_jacket",category:"body",item:"Hi-Vis Jacket",specification:"CSA Z96-15 Class 2/3"},{id:"rain_gear",category:"body",item:"Rain Gear",specification:"Waterproof jacket/pants"},{id:"winter_jacket",category:"body",item:"Winter Jacket",specification:"Insulated outerwear"},{id:"coveralls",category:"body",item:"Coveralls",specification:"FR rated if required"},{id:"fr_clothing",category:"body",item:"FR Clothing",specification:"NFPA 2112 / CSA Z462"},{id:"dust_mask",category:"respiratory",item:"Dust Mask",specification:"N95 minimum"},{id:"respirator",category:"respiratory",item:"Half-Face Respirator",specification:"With appropriate cartridges"},{id:"harness",category:"fall",item:"Fall Arrest Harness",specification:"CSA Z259.10"},{id:"lanyard",category:"fall",item:"Shock-Absorbing Lanyard",specification:"CSA Z259.11"},{id:"sunscreen",category:"other",item:"Sunscreen",specification:"SPF 30+ minimum"},{id:"bug_spray",category:"other",item:"Insect Repellent",specification:"DEET or equivalent"},{id:"cooling_towel",category:"other",item:"Cooling Towel/Vest",specification:"Heat stress prevention"},{id:"hand_warmers",category:"other",item:"Hand/Toe Warmers",specification:"Cold weather operations"}],B3=[{value:"head",label:"Head Protection",icon:Qc,color:"bg-blue-100 text-blue-700"},{value:"eye",label:"Eye & Face Protection",icon:ga,color:"bg-purple-100 text-purple-700"},{value:"hearing",label:"Hearing Protection",icon:_ie,color:"bg-orange-100 text-orange-700"},{value:"hand",label:"Hand Protection",icon:Cie,color:"bg-green-100 text-green-700"},{value:"foot",label:"Foot Protection",icon:b6,color:"bg-amber-100 text-amber-700"},{value:"body",label:"Body Protection",icon:Hie,color:"bg-cyan-100 text-cyan-700"},{value:"respiratory",label:"Respiratory Protection",icon:Ds,color:"bg-red-100 text-red-700"},{value:"fall",label:"Fall Protection",icon:ir,color:"bg-rose-100 text-rose-700"},{value:"other",label:"Other / Weather",icon:R6,color:"bg-gray-100 text-gray-700"}];function mae({project:t,onUpdate:e}){const[r,c]=ue.useState(!1),[h,x]=ue.useState({head:!0,eye:!0,hearing:!0,hand:!0,foot:!0,body:!0,respiratory:!1,fall:!1,other:!0}),[w,o]=ue.useState({category:"other",item:"",specification:"",required:!1,notes:""}),R=t.ppe?t.ppe.items&&!t.ppe.selectedItems?{selectedItems:["hi_vis_vest","safety_boots"],customItems:t.ppe.items||[],requirements:{},siteSpecific:t.ppe.siteSpecific||"",clientRequirements:t.ppe.clientRequirements||"",inspectionNotes:t.ppe.inspectionNotes||""}:{selectedItems:t.ppe.selectedItems||[],customItems:t.ppe.customItems||[],requirements:t.ppe.requirements||{},siteSpecific:t.ppe.siteSpecific||"",clientRequirements:t.ppe.clientRequirements||"",inspectionNotes:t.ppe.inspectionNotes||""}:{selectedItems:["hi_vis_vest","safety_boots"],customItems:[],requirements:{}},F=Te=>{e({ppe:{selectedItems:R.selectedItems,customItems:R.customItems,requirements:R.requirements,siteSpecific:R.siteSpecific,clientRequirements:R.clientRequirements,inspectionNotes:R.inspectionNotes,...Te}})},$=Te=>{const ne=R.selectedItems.includes(Te)?R.selectedItems.filter(ae=>ae!==Te):[...R.selectedItems,Te];F({selectedItems:ne})},Y=Te=>{F({requirements:{...R.requirements,[Te]:!R.requirements[Te]}})},H=Te=>R.selectedItems.includes(Te),X=Te=>R.requirements[Te]||!1,he=()=>{w.item.trim()&&(F({customItems:[...R.customItems,{...w,id:`custom_${Date.now()}`}]}),o({category:"other",item:"",specification:"",required:!1,notes:""}),c(!1))},se=Te=>{F({customItems:R.customItems.filter(Ce=>Ce.id!==Te)})},de=Te=>z3.filter(Ce=>Ce.category===Te),K=Te=>de(Te).filter(Ce=>H(Ce.id)).length,ge=z3.filter(Te=>H(Te.id)),Ae=ge.filter(Te=>X(Te.id)).length;return n.jsxs("div",{className:"space-y-6",children:[n.jsx("div",{className:"card",children:n.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[n.jsx("div",{className:"p-2 bg-amber-100 rounded-lg",children:n.jsx(Qc,{className:"w-5 h-5 text-amber-700"})}),n.jsxs("div",{className:"flex-1",children:[n.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Personal Protective Equipment"}),n.jsx("p",{className:"text-sm text-gray-500",children:"Select required PPE for this operation"})]}),n.jsxs("div",{className:"text-right",children:[n.jsx("p",{className:"text-2xl font-bold text-gray-900",children:ge.length+R.customItems.length}),n.jsx("p",{className:"text-xs text-gray-500",children:"items selected"})]})]})}),B3.map(Te=>{const Ce=de(Te.value),ne=K(Te.value),ae=Te.icon,q=h[Te.value];return n.jsxs("div",{className:"card",children:[n.jsxs("button",{onClick:()=>x(oe=>({...oe,[Te.value]:!oe[Te.value]})),className:"w-full flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("div",{className:`p-2 rounded-lg ${Te.color}`,children:n.jsx(ae,{className:"w-5 h-5"})}),n.jsxs("div",{className:"text-left",children:[n.jsx("h3",{className:"font-medium text-gray-900",children:Te.label}),n.jsxs("p",{className:"text-sm text-gray-500",children:[ne," of ",Ce.length," selected"]})]})]}),q?n.jsx($n,{className:"w-5 h-5 text-gray-400"}):n.jsx(fn,{className:"w-5 h-5 text-gray-400"})]}),q&&n.jsx("div",{className:"mt-4 grid gap-2",children:Ce.map(oe=>{const ke=H(oe.id),Ve=X(oe.id);return n.jsxs("div",{className:`flex items-center justify-between p-3 rounded-lg border-2 transition-colors ${ke?"border-green-500 bg-green-50":"border-gray-200 hover:border-gray-300"}`,children:[n.jsxs("label",{className:"flex items-center gap-3 flex-1 cursor-pointer",children:[n.jsx("input",{type:"checkbox",checked:ke,onChange:()=>$(oe.id),className:"w-5 h-5 rounded border-gray-300 text-green-600"}),n.jsxs("div",{children:[n.jsx("p",{className:`font-medium ${ke?"text-gray-900":"text-gray-700"}`,children:oe.item}),n.jsx("p",{className:"text-xs text-gray-500",children:oe.specification})]})]}),ke&&n.jsx("button",{onClick:()=>Y(oe.id),className:`px-2 py-1 text-xs font-medium rounded ${Ve?"bg-red-100 text-red-700":"bg-gray-100 text-gray-600"}`,children:Ve?"Required":"Optional"})]},oe.id)})})]},Te.value)}),n.jsxs("div",{className:"card",children:[n.jsxs("div",{className:"flex items-center justify-between mb-4",children:[n.jsx("h3",{className:"font-medium text-gray-900",children:"Custom PPE Items"}),n.jsxs("button",{onClick:()=>c(!r),className:"btn-secondary inline-flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Add Custom"]})]}),r&&n.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg mb-4 space-y-3",children:[n.jsxs("div",{className:"grid sm:grid-cols-2 gap-3",children:[n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Category"}),n.jsx("select",{value:w.category,onChange:Te=>o({...w,category:Te.target.value}),className:"input",children:B3.map(Te=>n.jsx("option",{value:Te.value,children:Te.label},Te.value))})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Item Name *"}),n.jsx("input",{type:"text",value:w.item,onChange:Te=>o({...w,item:Te.target.value}),className:"input",placeholder:"e.g., Welding Hood"})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Specification"}),n.jsx("input",{type:"text",value:w.specification,onChange:Te=>o({...w,specification:Te.target.value}),className:"input",placeholder:"e.g., ANSI Z87.1"})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[n.jsx("input",{type:"checkbox",checked:w.required,onChange:Te=>o({...w,required:Te.target.checked}),className:"rounded"}),n.jsx("span",{className:"text-sm",children:"Required"})]}),n.jsxs("div",{className:"flex gap-2",children:[n.jsx("button",{onClick:()=>c(!1),className:"btn-secondary",children:"Cancel"}),n.jsx("button",{onClick:he,className:"btn-primary",disabled:!w.item.trim(),children:"Add"})]})]})]}),R.customItems.length>0?n.jsx("div",{className:"space-y-2",children:R.customItems.map(Te=>n.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[n.jsxs("div",{children:[n.jsx("p",{className:"font-medium text-gray-900",children:Te.item}),n.jsx("p",{className:"text-xs text-gray-500",children:Te.specification})]}),n.jsx("button",{onClick:()=>se(Te.id),className:"p-1.5 text-gray-400 hover:text-red-500 rounded",children:n.jsx(Ln,{className:"w-4 h-4"})})]},Te.id))}):!r&&n.jsx("p",{className:"text-sm text-gray-500 text-center py-4",children:"No custom items. Use common items above or add custom ones."})]}),n.jsxs("div",{className:"card",children:[n.jsx("h3",{className:"font-medium text-gray-900 mb-4",children:"Additional Notes"}),n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Site-Specific Requirements"}),n.jsx("textarea",{value:R.siteSpecific,onChange:Te=>F({siteSpecific:Te.target.value}),className:"input min-h-[80px]",placeholder:"Site-specific PPE requirements..."})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Client Requirements"}),n.jsx("textarea",{value:R.clientRequirements,onChange:Te=>F({clientRequirements:Te.target.value}),className:"input min-h-[80px]",placeholder:"Client-specific requirements..."})]})]})]}),(ge.length>0||R.customItems.length>0)&&n.jsxs("div",{className:"card bg-green-50 border-green-200",children:[n.jsxs("h3",{className:"font-medium text-green-900 mb-3 flex items-center gap-2",children:[n.jsx(qr,{className:"w-5 h-5"}),"PPE Summary"]}),n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4 text-sm",children:[n.jsxs("div",{children:[n.jsxs("h4",{className:"font-medium text-green-800 mb-2",children:["Required (",Ae,")"]}),n.jsxs("ul",{className:"space-y-1",children:[ge.filter(Te=>X(Te.id)).map(Te=>n.jsxs("li",{className:"text-green-700",children:[" ",Te.item]},Te.id)),Ae===0&&n.jsx("li",{className:"text-green-600 italic",children:"None marked required"})]})]}),n.jsxs("div",{children:[n.jsxs("h4",{className:"font-medium text-green-800 mb-2",children:["Recommended (",ge.length-Ae+R.customItems.length,")"]}),n.jsxs("ul",{className:"space-y-1",children:[ge.filter(Te=>!X(Te.id)).map(Te=>n.jsxs("li",{className:"text-green-700",children:[" ",Te.item]},Te.id)),R.customItems.map(Te=>n.jsxs("li",{className:"text-green-700",children:[" ",Te.item," (custom)"]},Te.id))]})]})]})]})]})}const Hw=[{value:"cell",label:"Cell Phone",icon:I6,description:"Standard cellular coverage"},{value:"radio",label:"Two-Way Radio",icon:Jc,description:"UHF/VHF handheld radios"},{value:"satellite",label:"Satellite Phone/Device",icon:M6,description:"InReach, satellite phone"},{value:"hand_signals",label:"Hand Signals",icon:ds,description:"Visual communication"},{value:"other",label:"Other",icon:T6,description:"Specify in notes"}],fae=[{channel:"1",name:"Primary Ops",purpose:"Main operations channel"},{channel:"2",name:"Emergency",purpose:"Emergency communications only"}],gae=[{value:"15",label:"Every 15 minutes"},{value:"30",label:"Every 30 minutes"},{value:"60",label:"Every hour"},{value:"flight",label:"Before/after each flight"},{value:"custom",label:"Custom interval"}];function yae({project:t,onUpdate:e}){const[r,c]=ue.useState({methods:!0,radio:!0,checkin:!0,emergency:!0});ue.useEffect(()=>{t.communications||e({communications:{primaryMethod:"cell",backupMethod:"radio",cellCoverage:"full",cellNotes:"",radioChannels:[...fae],radioType:"",radioNotes:"",satelliteDevice:"",satelliteId:"",checkInInterval:"30",customInterval:"",checkInProcedure:"Crew members check in with PIC at specified intervals. Confirm location, status, and any concerns.",checkInContacts:[],emergencyWord:"MAYDAY",stopWord:"STOP STOP STOP",lostCommsProcedure:`If communication is lost for more than 15 minutes:
1. Attempt contact on backup method
2. Return to last known position
3. If still no contact, return to muster point
4. Initiate emergency protocol if no contact within 30 minutes`,aeronauticalRadio:!1,aeronauticalFrequencies:"",additionalNotes:""}})},[t.communications]);const h=t.communications||{},x=se=>{e({communications:{...h,...se}})},w=se=>{c(de=>({...de,[se]:!de[se]}))},o=()=>{x({radioChannels:[...h.radioChannels||[],{channel:"",name:"",purpose:""}]})},C=(se,de,K)=>{const ge=[...h.radioChannels||[]];ge[se]={...ge[se],[de]:K},x({radioChannels:ge})},R=se=>{const de=(h.radioChannels||[]).filter((K,ge)=>ge!==se);x({radioChannels:de})},F=()=>{x({checkInContacts:[...h.checkInContacts||[],{name:"",phone:"",role:""}]})},$=(se,de,K)=>{const ge=[...h.checkInContacts||[]];ge[se]={...ge[se],[de]:K},x({checkInContacts:ge})},Y=se=>{const de=(h.checkInContacts||[]).filter((K,ge)=>ge!==se);x({checkInContacts:de})},H=se=>Hw.find(de=>de.value===se)||Hw[4],X=H(h.primaryMethod).icon,he=H(h.backupMethod).icon;return n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"card",children:[n.jsxs("button",{onClick:()=>w("methods"),className:"flex items-center justify-between w-full text-left",children:[n.jsxs("h2",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[n.jsx(Jc,{className:"w-5 h-5 text-aeria-blue"}),"Communication Methods"]}),r.methods?n.jsx($n,{className:"w-5 h-5 text-gray-400"}):n.jsx(fn,{className:"w-5 h-5 text-gray-400"})]}),r.methods&&n.jsxs("div",{className:"mt-4 space-y-4",children:[n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[n.jsxs("div",{className:"p-4 bg-green-50 rounded-lg border border-green-200",children:[n.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[n.jsx(X,{className:"w-5 h-5 text-green-700"}),n.jsx("span",{className:"font-medium text-green-800",children:"Primary Method"})]}),n.jsx("select",{value:h.primaryMethod||"cell",onChange:se=>x({primaryMethod:se.target.value}),className:"input",children:Hw.map(se=>n.jsx("option",{value:se.value,children:se.label},se.value))})]}),n.jsxs("div",{className:"p-4 bg-blue-50 rounded-lg border border-blue-200",children:[n.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[n.jsx(he,{className:"w-5 h-5 text-blue-700"}),n.jsx("span",{className:"font-medium text-blue-800",children:"Backup Method"})]}),n.jsx("select",{value:h.backupMethod||"radio",onChange:se=>x({backupMethod:se.target.value}),className:"input",children:Hw.map(se=>n.jsx("option",{value:se.value,children:se.label},se.value))})]})]}),(h.primaryMethod==="cell"||h.backupMethod==="cell")&&n.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg border border-gray-200",children:[n.jsxs("h3",{className:"font-medium text-gray-900 mb-3 flex items-center gap-2",children:[n.jsx(I6,{className:"w-4 h-4"}),"Cell Coverage at Site"]}),n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Coverage Quality"}),n.jsxs("select",{value:h.cellCoverage||"full",onChange:se=>x({cellCoverage:se.target.value}),className:"input",children:[n.jsx("option",{value:"full",children:"Full Coverage"}),n.jsx("option",{value:"partial",children:"Partial/Spotty Coverage"}),n.jsx("option",{value:"minimal",children:"Minimal Coverage"}),n.jsx("option",{value:"none",children:"No Coverage"})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Coverage Notes"}),n.jsx("input",{type:"text",value:h.cellNotes||"",onChange:se=>x({cellNotes:se.target.value}),className:"input",placeholder:"e.g., Best signal near parking area"})]})]})]}),(h.primaryMethod==="satellite"||h.backupMethod==="satellite")&&n.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg border border-gray-200",children:[n.jsxs("h3",{className:"font-medium text-gray-900 mb-3 flex items-center gap-2",children:[n.jsx(M6,{className:"w-4 h-4"}),"Satellite Device Details"]}),n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Device Type"}),n.jsx("input",{type:"text",value:h.satelliteDevice||"",onChange:se=>x({satelliteDevice:se.target.value}),className:"input",placeholder:"e.g., Garmin InReach Mini"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Device ID / Number"}),n.jsx("input",{type:"text",value:h.satelliteId||"",onChange:se=>x({satelliteId:se.target.value}),className:"input",placeholder:"ID or phone number"})]})]})]})]})]}),(h.primaryMethod==="radio"||h.backupMethod==="radio")&&n.jsxs("div",{className:"card",children:[n.jsxs("button",{onClick:()=>w("radio"),className:"flex items-center justify-between w-full text-left",children:[n.jsxs("h2",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[n.jsx(tre,{className:"w-5 h-5 text-aeria-blue"}),"Radio Channels"]}),r.radio?n.jsx($n,{className:"w-5 h-5 text-gray-400"}):n.jsx(fn,{className:"w-5 h-5 text-gray-400"})]}),r.radio&&n.jsxs("div",{className:"mt-4 space-y-4",children:[n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Radio Type/Model"}),n.jsx("input",{type:"text",value:h.radioType||"",onChange:se=>x({radioType:se.target.value}),className:"input",placeholder:"e.g., Motorola T600, BaoFeng UV-5R"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Radio Notes"}),n.jsx("input",{type:"text",value:h.radioNotes||"",onChange:se=>x({radioNotes:se.target.value}),className:"input",placeholder:"e.g., FRS/GMRS, programmed frequencies"})]})]}),n.jsxs("div",{children:[n.jsxs("div",{className:"flex items-center justify-between mb-2",children:[n.jsx("label",{className:"label mb-0",children:"Channel Assignments"}),n.jsxs("button",{onClick:o,className:"text-sm text-aeria-blue hover:text-aeria-navy inline-flex items-center gap-1",children:[n.jsx(vr,{className:"w-4 h-4"}),"Add Channel"]})]}),n.jsx("div",{className:"space-y-2",children:(h.radioChannels||[]).map((se,de)=>n.jsxs("div",{className:"flex items-center gap-2 p-2 bg-gray-50 rounded-lg",children:[n.jsx("input",{type:"text",value:se.channel,onChange:K=>C(de,"channel",K.target.value),className:"input text-sm w-20 text-center font-mono",placeholder:"Ch"}),n.jsx("input",{type:"text",value:se.name,onChange:K=>C(de,"name",K.target.value),className:"input text-sm flex-1",placeholder:"Channel name"}),n.jsx("input",{type:"text",value:se.purpose,onChange:K=>C(de,"purpose",K.target.value),className:"input text-sm flex-1",placeholder:"Purpose"}),n.jsx("button",{onClick:()=>R(de),className:"p-1.5 text-gray-400 hover:text-red-500",children:n.jsx(Ln,{className:"w-4 h-4"})})]},de))})]})]})]}),n.jsxs("div",{className:"card",children:[n.jsxs("button",{onClick:()=>w("checkin"),className:"flex items-center justify-between w-full text-left",children:[n.jsxs("h2",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[n.jsx(Wu,{className:"w-5 h-5 text-aeria-blue"}),"Check-In Procedures"]}),r.checkin?n.jsx($n,{className:"w-5 h-5 text-gray-400"}):n.jsx(fn,{className:"w-5 h-5 text-gray-400"})]}),r.checkin&&n.jsxs("div",{className:"mt-4 space-y-4",children:[n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Check-In Interval"}),n.jsx("select",{value:h.checkInInterval||"30",onChange:se=>x({checkInInterval:se.target.value}),className:"input",children:gae.map(se=>n.jsx("option",{value:se.value,children:se.label},se.value))})]}),h.checkInInterval==="custom"&&n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Custom Interval"}),n.jsx("input",{type:"text",value:h.customInterval||"",onChange:se=>x({customInterval:se.target.value}),className:"input",placeholder:"e.g., Every 45 minutes"})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Check-In Procedure"}),n.jsx("textarea",{value:h.checkInProcedure||"",onChange:se=>x({checkInProcedure:se.target.value}),className:"input min-h-[80px]",placeholder:"Describe the check-in procedure..."})]}),n.jsxs("div",{children:[n.jsxs("div",{className:"flex items-center justify-between mb-2",children:[n.jsx("label",{className:"label mb-0",children:"Check-In Contacts"}),n.jsxs("button",{onClick:F,className:"text-sm text-aeria-blue hover:text-aeria-navy inline-flex items-center gap-1",children:[n.jsx(vr,{className:"w-4 h-4"}),"Add Contact"]})]}),(h.checkInContacts||[]).length===0?n.jsx("p",{className:"text-sm text-gray-500 italic",children:"No check-in contacts specified. Typically crew checks in with PIC."}):n.jsx("div",{className:"space-y-2",children:(h.checkInContacts||[]).map((se,de)=>n.jsxs("div",{className:"flex items-center gap-2 p-2 bg-gray-50 rounded-lg",children:[n.jsx("input",{type:"text",value:se.name,onChange:K=>$(de,"name",K.target.value),className:"input text-sm flex-1",placeholder:"Name"}),n.jsx("input",{type:"tel",value:se.phone,onChange:K=>$(de,"phone",K.target.value),className:"input text-sm w-36 font-mono",placeholder:"Phone"}),n.jsx("input",{type:"text",value:se.role,onChange:K=>$(de,"role",K.target.value),className:"input text-sm w-32",placeholder:"Role"}),n.jsx("button",{onClick:()=>Y(de),className:"p-1.5 text-gray-400 hover:text-red-500",children:n.jsx(Ln,{className:"w-4 h-4"})})]},de))})]})]})]}),n.jsxs("div",{className:"card",children:[n.jsxs("button",{onClick:()=>w("emergency"),className:"flex items-center justify-between w-full text-left",children:[n.jsxs("h2",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[n.jsx(ir,{className:"w-5 h-5 text-aeria-blue"}),"Emergency Communications"]}),r.emergency?n.jsx($n,{className:"w-5 h-5 text-gray-400"}):n.jsx(fn,{className:"w-5 h-5 text-gray-400"})]}),r.emergency&&n.jsxs("div",{className:"mt-4 space-y-4",children:[n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Emergency Word"}),n.jsx("input",{type:"text",value:h.emergencyWord||"MAYDAY",onChange:se=>x({emergencyWord:se.target.value}),className:"input font-bold text-red-600"}),n.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Word to indicate an emergency situation"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Stop Work Word"}),n.jsx("input",{type:"text",value:h.stopWord||"STOP STOP STOP",onChange:se=>x({stopWord:se.target.value}),className:"input font-bold text-amber-600"}),n.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Word to immediately cease all operations"})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Lost Communications Procedure"}),n.jsx("textarea",{value:h.lostCommsProcedure||"",onChange:se=>x({lostCommsProcedure:se.target.value}),className:"input min-h-[120px]",placeholder:"Procedure to follow if communications are lost..."})]})]})]}),n.jsx("div",{className:"card",children:n.jsxs("div",{className:"flex items-start gap-3",children:[n.jsx("input",{type:"checkbox",checked:h.aeronauticalRadio||!1,onChange:se=>x({aeronauticalRadio:se.target.checked}),className:"w-4 h-4 text-aeria-navy rounded mt-1"}),n.jsxs("div",{className:"flex-1",children:[n.jsx("label",{className:"font-medium text-gray-900 cursor-pointer",onClick:()=>x({aeronauticalRadio:!h.aeronauticalRadio}),children:"Aeronautical Radio Required"}),n.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Check if operations require monitoring aeronautical frequencies (controlled airspace, near aerodromes)"}),h.aeronauticalRadio&&n.jsxs("div",{className:"mt-3",children:[n.jsx("label",{className:"label",children:"Frequencies to Monitor"}),n.jsx("textarea",{value:h.aeronauticalFrequencies||"",onChange:se=>x({aeronauticalFrequencies:se.target.value}),className:"input min-h-[60px]",placeholder:"e.g., 126.7 MHz (CYSE Tower), 122.8 MHz (MF)"})]})]})]})}),n.jsxs("div",{className:"card",children:[n.jsx("h3",{className:"font-medium text-gray-900 mb-3",children:"Additional Communication Notes"}),n.jsx("textarea",{value:h.additionalNotes||"",onChange:se=>x({additionalNotes:se.target.value}),className:"input min-h-[80px]",placeholder:"Any additional communication requirements, client protocols, or site-specific considerations..."})]}),n.jsx("div",{className:"card bg-amber-50 border-amber-200",children:n.jsxs("div",{className:"flex gap-3",children:[n.jsx(Ns,{className:"w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5"}),n.jsxs("div",{children:[n.jsx("h3",{className:"font-medium text-amber-900",children:"Communication Test Reminder"}),n.jsx("p",{className:"text-sm text-amber-700 mt-1",children:"Test all communication devices during the tailgate briefing before commencing operations. Verify that all crew members can communicate with the PIC and understand the emergency words."})]})]})})]})}const b2=[{value:"environmental",label:"Environmental",icon:Xie,examples:"Weather conditions, terrain hazards, water bodies, wildlife, temperature extremes",color:"text-blue-600"},{value:"overhead",label:"Overhead / Obstacles",icon:hie,examples:"Power lines, towers, buildings, trees, wires, guy-wires",color:"text-orange-600"},{value:"access",label:"Access / Egress",icon:b6,examples:"Slips/trips, uneven terrain, water crossings, remote locations",color:"text-amber-600"},{value:"ergonomic",label:"Ergonomic",icon:ere,examples:"Awkward postures, repetitive tasks, manual handling, prolonged standing",color:"text-purple-600"},{value:"personal",label:"Personal Limitations",icon:ds,examples:"Fatigue, distraction, training gaps, stress, fitness for duty",color:"text-pink-600"},{value:"equipment",label:"Equipment",icon:bf,examples:"Malfunction, battery hazards, sharp edges, hot surfaces, moving parts",color:"text-red-600"},{value:"biological",label:"Biological",icon:die,examples:"Insects, poisonous plants, animal encounters, pathogens",color:"text-green-600"},{value:"chemical",label:"Chemical",icon:cie,examples:"Fuel, battery chemicals, site contaminants, cleaning agents",color:"text-cyan-600"}],V3={tower:{category:"overhead",description:"Tower/Mast obstacle"},powerline:{category:"overhead",description:"Power lines in operational area"},building:{category:"overhead",description:"Building/Structure obstacle"},tree:{category:"overhead",description:"Trees/Vegetation obstacle"},terrain:{category:"access",description:"Terrain feature hazard"},wire:{category:"overhead",description:"Wire/Cable obstacle"},antenna:{category:"overhead",description:"Antenna obstacle"},other:{category:"environmental",description:"Site obstacle"}},bI=[{value:1,label:"Rare",description:"Highly unlikely to occur",color:"bg-green-100"},{value:2,label:"Unlikely",description:"Could occur but not expected",color:"bg-green-200"},{value:3,label:"Possible",description:"Might occur occasionally",color:"bg-yellow-100"},{value:4,label:"Likely",description:"Will probably occur",color:"bg-orange-100"},{value:5,label:"Almost Certain",description:"Expected to occur",color:"bg-red-100"}],NS=[{value:1,label:"Negligible",description:"No injury, minor inconvenience",color:"bg-green-100"},{value:2,label:"Minor",description:"First aid injury, minor damage",color:"bg-green-200"},{value:3,label:"Moderate",description:"Medical treatment, significant damage",color:"bg-yellow-100"},{value:4,label:"Major",description:"Serious injury, major damage",color:"bg-orange-100"},{value:5,label:"Catastrophic",description:"Fatality, total loss",color:"bg-red-100"}],xae=[{value:"elimination",label:"Elimination",description:"Physically remove the hazard",effectiveness:"Most Effective",color:"bg-green-500"},{value:"substitution",label:"Substitution",description:"Replace the hazard with something safer",effectiveness:"Highly Effective",color:"bg-green-400"},{value:"engineering",label:"Engineering Controls",description:"Isolate people from the hazard",effectiveness:"Effective",color:"bg-yellow-400"},{value:"administrative",label:"Administrative Controls",description:"Change the way people work",effectiveness:"Moderately Effective",color:"bg-orange-400"},{value:"ppe",label:"PPE",description:"Protect the worker with equipment",effectiveness:"Least Effective",color:"bg-red-400"}],Qh=(t,e)=>{const r=t*e;return r<=4?{level:"Low",color:"bg-green-100 text-green-800 border-green-300",action:"Acceptable with monitoring",priority:4}:r<=9?{level:"Medium",color:"bg-yellow-100 text-yellow-800 border-yellow-300",action:"Mitigations recommended",priority:3}:r<=16?{level:"High",color:"bg-orange-100 text-orange-800 border-orange-300",action:"Mitigations required before proceeding",priority:2}:{level:"Critical",color:"bg-red-100 text-red-800 border-red-300",action:"Do not proceed without controls",priority:1}},_ae=({hazards:t})=>{const e={};return t.forEach((r,c)=>{const h=`${r.likelihood}-${r.severity}`;e[h]||(e[h]=[]),e[h].push(c+1)}),n.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg border",children:[n.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-3",children:"Risk Matrix Overview"}),n.jsxs("div",{className:"overflow-x-auto",children:[n.jsxs("table",{className:"w-full text-xs",children:[n.jsx("thead",{children:n.jsxs("tr",{children:[n.jsx("th",{className:"p-1"}),NS.map(r=>n.jsx("th",{className:"p-1 text-center font-medium text-gray-600",children:r.value},r.value))]})}),n.jsx("tbody",{children:[...bI].reverse().map(r=>n.jsxs("tr",{children:[n.jsx("td",{className:"p-1 font-medium text-gray-600 text-right pr-2",children:r.value}),NS.map(c=>{const h=`${r.value}-${c.value}`,x=Qh(r.value,c.value),w=e[h]||[];return n.jsx("td",{className:`p-1 text-center border ${x.color} ${w.length>0?"font-bold":""}`,children:w.length>0?w.join(","):""},c.value)})]},r.value))})]}),n.jsxs("div",{className:"flex justify-center gap-4 mt-3 text-xs",children:[n.jsxs("span",{className:"flex items-center gap-1",children:[n.jsx("span",{className:"w-3 h-3 bg-green-200 rounded"})," Low"]}),n.jsxs("span",{className:"flex items-center gap-1",children:[n.jsx("span",{className:"w-3 h-3 bg-yellow-200 rounded"})," Medium"]}),n.jsxs("span",{className:"flex items-center gap-1",children:[n.jsx("span",{className:"w-3 h-3 bg-orange-200 rounded"})," High"]}),n.jsxs("span",{className:"flex items-center gap-1",children:[n.jsx("span",{className:"w-3 h-3 bg-red-200 rounded"})," Critical"]})]})]})]})},vae=({hazard:t,index:e,onUpdate:r,onRemove:c})=>{const[h,x]=ue.useState(e===0),w=b2.find(F=>F.value===t.category)||b2[0],o=w.icon,C=Qh(t.likelihood,t.severity),R=Qh(t.residualLikelihood,t.residualSeverity);return n.jsxs("div",{className:`rounded-lg border-2 overflow-hidden ${C.color.replace("text-","border-").split(" ")[0]}`,children:[n.jsx("div",{className:`p-3 cursor-pointer ${h?"bg-gray-50":"bg-white"}`,onClick:()=>x(!h),children:n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsxs("span",{className:`text-lg font-bold ${w.color}`,children:["#",e+1]}),n.jsx(o,{className:`w-5 h-5 ${w.color}`}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsx("p",{className:"font-medium text-gray-900 truncate",children:t.description||"Untitled Hazard"}),n.jsx("p",{className:"text-xs text-gray-500",children:w.label})]}),n.jsxs("div",{className:"text-right mr-2",children:[n.jsx("p",{className:"text-xs text-gray-500",children:"Initial"}),n.jsx("span",{className:`px-2 py-0.5 rounded text-xs font-medium ${C.color}`,children:C.level})]}),n.jsxs("div",{className:"text-right",children:[n.jsx("p",{className:"text-xs text-gray-500",children:"Residual"}),n.jsx("span",{className:`px-2 py-0.5 rounded text-xs font-medium ${R.color}`,children:R.level})]}),h?n.jsx($n,{className:"w-5 h-5 text-gray-400"}):n.jsx(fn,{className:"w-5 h-5 text-gray-400"})]})}),h&&n.jsxs("div",{className:"p-4 bg-white border-t space-y-4",children:[n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"label text-xs",children:"Hazard Category"}),n.jsx("select",{value:t.category,onChange:F=>r("category",F.target.value),className:"input text-sm",children:b2.map(F=>n.jsx("option",{value:F.value,children:F.label},F.value))}),n.jsx("p",{className:"text-xs text-gray-400 mt-1",children:w.examples})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label text-xs",children:"Hazard Description"}),n.jsx("textarea",{value:t.description,onChange:F=>r("description",F.target.value),className:"input text-sm min-h-[80px]",placeholder:"Describe the specific hazard..."})]})]}),n.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[n.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"Initial Risk Assessment"}),n.jsxs("div",{className:"grid sm:grid-cols-3 gap-3",children:[n.jsxs("div",{children:[n.jsx("label",{className:"label text-xs",children:"Likelihood"}),n.jsx("select",{value:t.likelihood,onChange:F=>r("likelihood",parseInt(F.target.value)),className:"input text-sm",children:bI.map(F=>n.jsxs("option",{value:F.value,children:[F.value," - ",F.label]},F.value))})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label text-xs",children:"Severity"}),n.jsx("select",{value:t.severity,onChange:F=>r("severity",parseInt(F.target.value)),className:"input text-sm",children:NS.map(F=>n.jsxs("option",{value:F.value,children:[F.value," - ",F.label]},F.value))})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label text-xs",children:"Risk Score"}),n.jsxs("div",{className:`px-3 py-2 rounded text-sm font-medium border ${C.color}`,children:[t.likelihood*t.severity," - ",C.level]})]})]})]}),n.jsxs("div",{className:"p-3 bg-blue-50 rounded-lg border border-blue-200",children:[n.jsxs("h4",{className:"text-sm font-medium text-blue-800 mb-2 flex items-center gap-2",children:[n.jsx(Ds,{className:"w-4 h-4"}),"Control Measures"]}),n.jsxs("div",{className:"mb-3",children:[n.jsx("label",{className:"label text-xs",children:"Primary Control Type"}),n.jsx("select",{value:t.controlType||"administrative",onChange:F=>r("controlType",F.target.value),className:"input text-sm",children:xae.map(F=>n.jsxs("option",{value:F.value,children:[F.label," - ",F.description]},F.value))})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label text-xs",children:"Control Measure Details"}),n.jsx("textarea",{value:t.controls,onChange:F=>r("controls",F.target.value),className:"input text-sm min-h-[80px]",placeholder:"Describe specific control measures..."})]})]}),n.jsxs("div",{className:"p-3 bg-green-50 rounded-lg border border-green-200",children:[n.jsx("h4",{className:"text-sm font-medium text-green-800 mb-2",children:"Residual Risk (After Controls)"}),n.jsxs("div",{className:"grid sm:grid-cols-3 gap-3",children:[n.jsxs("div",{children:[n.jsx("label",{className:"label text-xs",children:"Residual Likelihood"}),n.jsx("select",{value:t.residualLikelihood,onChange:F=>r("residualLikelihood",parseInt(F.target.value)),className:"input text-sm",children:bI.map(F=>n.jsxs("option",{value:F.value,children:[F.value," - ",F.label]},F.value))})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label text-xs",children:"Residual Severity"}),n.jsx("select",{value:t.residualSeverity,onChange:F=>r("residualSeverity",parseInt(F.target.value)),className:"input text-sm",children:NS.map(F=>n.jsxs("option",{value:F.value,children:[F.value," - ",F.label]},F.value))})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label text-xs",children:"Residual Risk"}),n.jsxs("div",{className:`px-3 py-2 rounded text-sm font-medium border ${R.color}`,children:[t.residualLikelihood*t.residualSeverity," - ",R.level]})]})]})]}),n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"label text-xs",children:"Responsible Person"}),n.jsx("input",{type:"text",value:t.responsible||"",onChange:F=>r("responsible",F.target.value),className:"input text-sm",placeholder:"Who is responsible?"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label text-xs",children:"Verification Method"}),n.jsx("input",{type:"text",value:t.verification||"",onChange:F=>r("verification",F.target.value),className:"input text-sm",placeholder:"How will effectiveness be verified?"})]})]}),n.jsx("div",{className:"flex justify-end pt-2 border-t",children:n.jsxs("button",{onClick:c,className:"text-sm text-red-600 hover:text-red-800 flex items-center gap-1",children:[n.jsx(Ln,{className:"w-4 h-4"}),"Remove Hazard"]})})]})]})},bae=({hazards:t})=>{const e={total:t.length,critical:t.filter(c=>Qh(c.likelihood,c.severity).level==="Critical").length,high:t.filter(c=>Qh(c.likelihood,c.severity).level==="High").length,medium:t.filter(c=>Qh(c.likelihood,c.severity).level==="Medium").length,low:t.filter(c=>Qh(c.likelihood,c.severity).level==="Low").length},r=t.filter(c=>{const h=Qh(c.residualLikelihood,c.residualSeverity);return h.level==="Critical"||h.level==="High"}).length;return n.jsx("div",{className:`p-4 rounded-lg border ${r>0?"bg-red-50 border-red-200":"bg-green-50 border-green-200"}`,children:n.jsxs("div",{className:"flex items-start gap-3",children:[r>0?n.jsx(zl,{className:"w-6 h-6 text-red-500"}):n.jsx(fie,{className:"w-6 h-6 text-green-500"}),n.jsxs("div",{className:"flex-1",children:[n.jsx("h3",{className:`font-medium ${r>0?"text-red-800":"text-green-800"}`,children:r>0?`${r} Hazard${r>1?"s":""} Require Additional Controls`:"All Hazards Adequately Controlled"}),n.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4 mt-3",children:[n.jsxs("div",{className:"text-center p-2 bg-white rounded",children:[n.jsx("p",{className:"text-2xl font-bold text-gray-900",children:e.total}),n.jsx("p",{className:"text-xs text-gray-500",children:"Total"})]}),n.jsxs("div",{className:"text-center p-2 bg-white rounded",children:[n.jsx("p",{className:"text-2xl font-bold text-red-600",children:e.critical+e.high}),n.jsx("p",{className:"text-xs text-gray-500",children:"High/Critical"})]}),n.jsxs("div",{className:"text-center p-2 bg-white rounded",children:[n.jsx("p",{className:"text-2xl font-bold text-yellow-600",children:e.medium}),n.jsx("p",{className:"text-xs text-gray-500",children:"Medium"})]}),n.jsxs("div",{className:"text-center p-2 bg-white rounded",children:[n.jsx("p",{className:"text-2xl font-bold text-green-600",children:e.low}),n.jsx("p",{className:"text-xs text-gray-500",children:"Low"})]})]})]})]})})},wae=({project:t,existingHazards:e,onImport:r})=>{var X,he;const[c,h]=ue.useState([]),x=t.siteSurvey||{},w=x.obstacles||[],o=((X=x.groundConditions)==null?void 0:X.hazards)||"",C=((he=x.weather)==null?void 0:he.concerns)||"",R=[];w.forEach((se,de)=>{const K=V3[se.type]||V3.other,ge=`${K.description}: ${se.description||se.type}${se.height?` (${se.height}m AGL)`:""}${se.distance?` at ${se.distance}m`:""}`;R.push({id:`obstacle_${de}`,source:"Obstacle",category:K.category,description:ge,type:se.type})}),o.trim()&&R.push({id:"ground_hazards",source:"Ground Conditions",category:"access",description:`Ground hazards: ${o}`,type:"terrain"}),C.trim()&&R.push({id:"weather_concerns",source:"Weather",category:"environmental",description:`Weather concerns: ${C}`,type:"weather"});const F=e.map(se=>{var de;return((de=se.description)==null?void 0:de.toLowerCase())||""}),$=R.filter(se=>!F.some(de=>de.includes(se.description.toLowerCase().slice(0,30)))),Y=se=>{h(de=>de.includes(se)?de.filter(K=>K!==se):[...de,se])},H=()=>{const se=$.filter(de=>c.includes(de.id)).map(de=>({id:Date.now().toString()+Math.random().toString(36).substr(2,9),category:de.category,description:de.description,likelihood:3,severity:3,controlType:"administrative",controls:"",residualLikelihood:2,residualSeverity:2,responsible:"",verification:"",importedFrom:"siteSurvey"}));r(se),h([])};return $.length===0?n.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg border border-gray-200 text-center",children:[n.jsx(Wn,{className:"w-8 h-8 mx-auto mb-2 text-gray-400"}),n.jsx("p",{className:"text-sm text-gray-600",children:"No additional hazards found in Site Survey"}),n.jsx("p",{className:"text-xs text-gray-500 mt-1",children:w.length===0?"Add obstacles in the Site Survey tab to import them here":"All Site Survey hazards have been imported"})]}):n.jsxs("div",{className:"p-4 bg-blue-50 rounded-lg border border-blue-200",children:[n.jsxs("div",{className:"flex items-center justify-between mb-3",children:[n.jsxs("h4",{className:"font-medium text-blue-900 flex items-center gap-2",children:[n.jsx(vc,{className:"w-4 h-4"}),"Import from Site Survey"]}),n.jsxs("span",{className:"text-xs text-blue-700",children:[$.length," available"]})]}),n.jsx("div",{className:"space-y-2 mb-4",children:$.map(se=>{const de=c.includes(se.id),K=b2.find(Ae=>Ae.value===se.category),ge=(K==null?void 0:K.icon)||ir;return n.jsxs("label",{className:`flex items-start gap-3 p-3 rounded-lg cursor-pointer transition-colors ${de?"bg-blue-100 border-blue-300":"bg-white border-gray-200"} border`,children:[n.jsx("input",{type:"checkbox",checked:de,onChange:()=>Y(se.id),className:"mt-1 rounded border-gray-300 text-blue-600"}),n.jsx(ge,{className:`w-4 h-4 mt-0.5 ${(K==null?void 0:K.color)||"text-gray-500"}`}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsx("p",{className:"text-sm font-medium text-gray-900",children:se.description}),n.jsxs("p",{className:"text-xs text-gray-500",children:["Source: ",se.source,"  ",(K==null?void 0:K.label)||"Unknown"]})]})]},se.id)})}),n.jsxs("button",{onClick:H,disabled:c.length===0,className:"btn-primary w-full disabled:opacity-50 disabled:cursor-not-allowed",children:[n.jsx(vr,{className:"w-4 h-4 mr-2"}),"Import ",c.length>0?`${c.length} Hazard${c.length>1?"s":""}`:"Selected"]})]})};function Sae({project:t,onUpdate:e}){const[r,c]=ue.useState({import:!0,summary:!0,hazards:!0,matrix:!1,review:!0}),[h,x]=ue.useState(!1);if(ue.useEffect(()=>{h||!t||(t.hseRiskAssessment?x(!0):(x(!0),e({hseRiskAssessment:{hazards:[],overallRiskAcceptable:null,reviewNotes:"",reviewedBy:"",reviewDate:"",approvedBy:"",approvalDate:""}})))},[h,t,e]),!t)return n.jsx("div",{className:"p-4 text-gray-500",children:"Loading..."});const w=t.hseRiskAssessment||{hazards:[]},o=w.hazards||[],C=X=>{c(he=>({...he,[X]:!he[X]}))},R=X=>{e({hseRiskAssessment:{...w,...X}})},F=()=>{R({hazards:[...o,{id:Date.now().toString(),category:"environmental",description:"",likelihood:3,severity:3,controlType:"administrative",controls:"",residualLikelihood:2,residualSeverity:2,responsible:"",verification:""}]})},$=X=>{R({hazards:[...o,...X]})},Y=(X,he,se)=>{const de=[...o];de[X]={...de[X],[he]:se},R({hazards:de})},H=X=>{R({hazards:o.filter((he,se)=>se!==X)})};return n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"card bg-gradient-to-r from-amber-50 to-white",children:[n.jsxs("div",{className:"flex items-center justify-between mb-4",children:[n.jsxs("h2",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[n.jsx(Qc,{className:"w-5 h-5 text-amber-600"}),"HSE Risk Assessment"]}),n.jsx("span",{className:"px-2 py-1 text-xs bg-amber-100 text-amber-700 rounded",children:"Per HSE1047 & HSE1048"})]}),n.jsx("p",{className:"text-sm text-gray-600",children:"Identify workplace hazards, assess risks using the 55 matrix, and apply the hierarchy of controls."})]}),t.siteSurvey&&n.jsxs("div",{className:"card",children:[n.jsxs("button",{onClick:()=>C("import"),className:"flex items-center justify-between w-full text-left",children:[n.jsxs("h3",{className:"font-medium text-gray-900 flex items-center gap-2",children:[n.jsx(Wn,{className:"w-5 h-5 text-blue-500"}),"Import from Site Survey"]}),r.import?n.jsx($n,{className:"w-5 h-5 text-gray-400"}):n.jsx(fn,{className:"w-5 h-5 text-gray-400"})]}),r.import&&n.jsx("div",{className:"mt-4",children:n.jsx(wae,{project:t,existingHazards:o,onImport:$})})]}),o.length>0&&n.jsx(bae,{hazards:o}),o.length>0&&n.jsxs("div",{className:"card",children:[n.jsxs("button",{onClick:()=>C("matrix"),className:"flex items-center justify-between w-full text-left",children:[n.jsxs("h3",{className:"font-medium text-gray-900 flex items-center gap-2",children:[n.jsx(Ul,{className:"w-5 h-5 text-gray-400"}),"Risk Matrix"]}),r.matrix?n.jsx($n,{className:"w-5 h-5 text-gray-400"}):n.jsx(fn,{className:"w-5 h-5 text-gray-400"})]}),r.matrix&&n.jsx("div",{className:"mt-4",children:n.jsx(_ae,{hazards:o})})]}),n.jsxs("div",{className:"card",children:[n.jsxs("button",{onClick:()=>C("hazards"),className:"flex items-center justify-between w-full text-left",children:[n.jsxs("h3",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[n.jsx(ir,{className:"w-5 h-5 text-amber-500"}),"Identified Hazards",o.length>0&&n.jsx("span",{className:"px-2 py-0.5 text-xs bg-gray-100 text-gray-600 rounded",children:o.length})]}),r.hazards?n.jsx($n,{className:"w-5 h-5 text-gray-400"}):n.jsx(fn,{className:"w-5 h-5 text-gray-400"})]}),r.hazards&&n.jsx("div",{className:"mt-4 space-y-4",children:o.length===0?n.jsxs("div",{className:"text-center py-12 bg-gray-50 rounded-lg border border-dashed border-gray-300",children:[n.jsx(ir,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),n.jsx("p",{className:"text-gray-500 mb-2",children:"No hazards identified yet"}),n.jsx("p",{className:"text-sm text-gray-400 mb-4",children:"Import from Site Survey above or add manually"}),n.jsxs("button",{onClick:F,className:"btn-primary",children:[n.jsx(vr,{className:"w-4 h-4 mr-2"}),"Add First Hazard"]})]}):n.jsxs(n.Fragment,{children:[o.map((X,he)=>n.jsx(vae,{hazard:X,index:he,onUpdate:(se,de)=>Y(he,se,de),onRemove:()=>H(he)},X.id||he)),n.jsxs("button",{onClick:F,className:"w-full p-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-amber-400 hover:text-amber-600 flex items-center justify-center gap-2",children:[n.jsx(vr,{className:"w-5 h-5"}),"Add Another Hazard"]})]})})]}),n.jsxs("div",{className:"card",children:[n.jsxs("button",{onClick:()=>C("review"),className:"flex items-center justify-between w-full text-left",children:[n.jsxs("h3",{className:"font-medium text-gray-900 flex items-center gap-2",children:[n.jsx(Ij,{className:"w-5 h-5 text-green-500"}),"Review & Approval"]}),r.review?n.jsx($n,{className:"w-5 h-5 text-gray-400"}):n.jsx(fn,{className:"w-5 h-5 text-gray-400"})]}),r.review&&n.jsxs("div",{className:"mt-4 space-y-4",children:[n.jsx("div",{className:"p-4 bg-gray-50 rounded-lg",children:n.jsxs("label",{className:"flex items-center gap-3 cursor-pointer",children:[n.jsx("input",{type:"checkbox",checked:w.overallRiskAcceptable===!0,onChange:X=>R({overallRiskAcceptable:X.target.checked?!0:null}),className:"w-5 h-5 rounded border-gray-300 text-green-600"}),n.jsx("span",{className:"font-medium text-gray-900",children:"I confirm all identified hazards have been assessed and controlled to acceptable levels"})]})}),n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Reviewed By"}),n.jsx("input",{type:"text",value:w.reviewedBy||"",onChange:X=>R({reviewedBy:X.target.value}),className:"input",placeholder:"Reviewer name"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Review Date"}),n.jsx("input",{type:"date",value:w.reviewDate||"",onChange:X=>R({reviewDate:X.target.value}),className:"input"})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Review Notes"}),n.jsx("textarea",{value:w.reviewNotes||"",onChange:X=>R({reviewNotes:X.target.value}),className:"input min-h-[80px]",placeholder:"Additional notes, conditions, or observations..."})]})]})]})]})}function km({title:t,icon:e,children:r,defaultOpen:c=!0,badge:h=null,stepNumber:x=null,status:w=null}){const[o,C]=ue.useState(c),R={complete:"bg-green-100 text-green-700",partial:"bg-amber-100 text-amber-700",missing:"bg-red-100 text-red-700",info:"bg-blue-100 text-blue-700"};return n.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[n.jsxs("button",{type:"button",onClick:()=>C(!o),className:"w-full px-4 py-3 bg-gray-50 flex items-center justify-between hover:bg-gray-100 transition-colors",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[x&&n.jsx("span",{className:"w-6 h-6 rounded-full bg-aeria-navy text-white text-xs font-bold flex items-center justify-center",children:x}),e&&!x&&n.jsx(e,{className:"w-5 h-5 text-gray-500"}),n.jsx("span",{className:"font-medium text-gray-900",children:t}),h&&n.jsx("span",{className:`px-2 py-0.5 text-xs font-medium rounded-full ${R[w]||"bg-gray-100 text-gray-700"}`,children:h})]}),o?n.jsx($n,{className:"w-5 h-5 text-gray-400"}):n.jsx(fn,{className:"w-5 h-5 text-gray-400"})]}),o&&n.jsx("div",{className:"p-4 space-y-4",children:r})]})}function Tae({sites:t,activeSiteId:e,onSelectSite:r,calculations:c}){return t.length<=1?null:n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 flex items-center gap-3 overflow-x-auto",children:[n.jsx("span",{className:"text-sm font-medium text-gray-500 whitespace-nowrap",children:"Site:"}),n.jsx("div",{className:"flex gap-2",children:t.map((h,x)=>{const w=h.id===e,o=c==null?void 0:c[h.id],C=o==null?void 0:o.sail,R=C?Ld[C]:null;return n.jsxs("button",{type:"button",onClick:()=>r(h.id),className:`px-3 py-1.5 rounded-lg text-sm font-medium whitespace-nowrap transition-colors flex items-center gap-2 ${w?"bg-aeria-navy text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[n.jsx("div",{className:"w-2 h-2 rounded-full",style:{backgroundColor:w?"white":`hsl(${x*60}, 70%, 50%)`}}),h.name,C&&n.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded ${w?"bg-white/20":""}`,style:{backgroundColor:w?void 0:R},children:C})]},h.id)})})]})}function AS({sail:t,size:e="md"}){if(!t)return n.jsx("span",{className:"text-gray-400",children:"N/A"});const r=Ld[t]||"#9CA3AF",c={sm:"text-xs px-2 py-0.5",md:"text-sm px-3 py-1",lg:"text-lg px-4 py-2 font-bold"};return n.jsxs("span",{className:`rounded-full font-medium ${c[e]}`,style:{backgroundColor:r,color:t==="I"||t==="II"?"#1F2937":"#FFFFFF"},children:["SAIL ",t]})}function OC({label:t,value:e,description:r}){const c=h=>h===null?"bg-gray-200 text-gray-600":h<=2?"bg-green-500 text-white":h<=4?"bg-yellow-500 text-white":h<=6?"bg-orange-500 text-white":"bg-red-500 text-white";return n.jsxs("div",{className:"text-center p-4 bg-gray-50 rounded-lg",children:[n.jsx("p",{className:"text-sm text-gray-600 mb-2",children:t}),n.jsx("div",{className:`inline-flex items-center justify-center w-12 h-12 rounded-full text-xl font-bold ${c(e)}`,children:e??"?"}),r&&n.jsx("p",{className:"text-xs text-gray-500 mt-2",children:r})]})}function Nae({value:t,onChange:e,fromSiteSurvey:r,onSyncFromSurvey:c}){var h;return n.jsxs("div",{children:[n.jsxs("div",{className:"flex items-center justify-between mb-2",children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Population Category (Operations Area)"}),r&&r!==t&&n.jsxs("button",{type:"button",onClick:c,className:"text-xs text-aeria-navy hover:underline flex items-center gap-1",children:[n.jsx(eu,{className:"w-3 h-3"}),"Sync from Site Survey (",(h=hf[r])==null?void 0:h.label,")"]})]}),n.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2",children:Object.entries(hf).map(([x,w])=>{var R;const o=t===x,C=r===x;return n.jsxs("button",{type:"button",onClick:()=>e(x),className:`p-3 rounded-lg border text-left transition-all ${o?"border-aeria-navy bg-aeria-navy/5 ring-2 ring-aeria-navy/20":"border-gray-200 hover:border-gray-300"}`,children:[n.jsxs("div",{className:"flex items-center justify-between mb-1",children:[n.jsx("span",{className:`text-sm font-medium ${o?"text-aeria-navy":"text-gray-900"}`,children:w.label.split("(")[0].trim()}),C&&!o&&n.jsx("span",{className:"text-xs text-blue-600",children:"Survey"})]}),n.jsx("p",{className:"text-xs text-gray-500",children:((R=w.label.match(/\(([^)]+)\)/))==null?void 0:R[1])||""})]},x)})})]})}function Aae({value:t,onChange:e,aircraft:r}){var h;const c=ue.useMemo(()=>{if(!r||r.length===0)return null;const x=r.find(C=>C.isPrimary)||r[0],w=(x==null?void 0:x.maxDimension)||(x==null?void 0:x.wingspan)||1,o=(x==null?void 0:x.maxSpeed)||25;for(const[C,R]of Object.entries(tv))if(w<=R.maxDimension&&o<=R.maxSpeed)return C;return"1m_25ms"},[r]);return n.jsxs("div",{children:[n.jsxs("div",{className:"flex items-center justify-between mb-2",children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"UA Characteristics (Max Dimension / Max Speed)"}),c&&c!==t&&n.jsxs("button",{type:"button",onClick:()=>e(c),className:"text-xs text-aeria-navy hover:underline flex items-center gap-1",children:[n.jsx(eu,{className:"w-3 h-3"}),"Use suggested (",(h=tv[c])==null?void 0:h.label,")"]})]}),n.jsx("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-2",children:Object.entries(tv).map(([x,w])=>{const o=t===x,C=c===x;return n.jsxs("button",{type:"button",onClick:()=>e(x),className:`p-3 rounded-lg border text-center transition-all ${o?"border-aeria-navy bg-aeria-navy/5 ring-2 ring-aeria-navy/20":"border-gray-200 hover:border-gray-300"}`,children:[n.jsx("span",{className:`text-sm font-medium block ${o?"text-aeria-navy":"text-gray-900"}`,children:w.label}),n.jsx("p",{className:"text-xs text-gray-500 mt-1",children:w.description}),C&&!o&&n.jsx("span",{className:"text-xs text-blue-600 mt-1 block",children:"Suggested"})]},x)})})]})}function Cae({mitigationId:t,mitigation:e,config:r,onChange:c}){const h=(r==null?void 0:r.enabled)||!1,x=(r==null?void 0:r.robustness)||"none",w=Object.keys(e.reductions).filter(o=>o!=="none");return n.jsxs("div",{className:`p-4 rounded-lg border ${h?"border-aeria-navy bg-aeria-navy/5":"border-gray-200"}`,children:[n.jsxs("div",{className:"flex items-start justify-between mb-3",children:[n.jsxs("div",{className:"flex-1",children:[n.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[n.jsx("input",{type:"checkbox",checked:h,onChange:o=>c({...r,enabled:o.target.checked}),className:"w-4 h-4 text-aeria-navy rounded focus:ring-aeria-navy"}),n.jsx("span",{className:"font-medium text-gray-900",children:e.name})]}),n.jsx("p",{className:"text-sm text-gray-500 mt-1 ml-6",children:e.description})]}),h&&n.jsxs("span",{className:"text-sm font-medium text-green-600",children:[e.reductions[x]||0," GRC"]})]}),h&&n.jsxs("div",{className:"ml-6 space-y-3",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm text-gray-600 mb-1",children:"Robustness Level"}),n.jsx("div",{className:"flex gap-2",children:w.map(o=>{const C=e.reductions[o],R=x===o;return n.jsxs("button",{type:"button",onClick:()=>c({...r,robustness:o}),className:`px-3 py-1.5 rounded text-sm font-medium transition-colors ${R?"bg-aeria-navy text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[o.charAt(0).toUpperCase()+o.slice(1)," (",C,")"]},o)})})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm text-gray-600 mb-1",children:"Evidence / Justification"}),n.jsx("textarea",{value:(r==null?void 0:r.evidence)||"",onChange:o=>c({...r,evidence:o.target.value}),placeholder:"Describe the evidence supporting this mitigation claim...",rows:2,className:"input text-sm"})]}),e.notes&&n.jsxs("p",{className:"text-xs text-amber-600 flex items-start gap-1",children:[n.jsx(ir,{className:"w-3 h-3 mt-0.5 flex-shrink-0"}),e.notes]})]})]})}function Eae({value:t,onChange:e}){return n.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2",children:Object.entries(mU).map(([r,c])=>{const h=t===r,x={"ARC-a":"border-green-500 bg-green-50","ARC-b":"border-yellow-500 bg-yellow-50","ARC-c":"border-orange-500 bg-orange-50","ARC-d":"border-red-500 bg-red-50"};return n.jsxs("button",{type:"button",onClick:()=>e(r),className:`p-3 rounded-lg border-2 text-left transition-all ${h?x[r]:"border-gray-200 hover:border-gray-300"}`,children:[n.jsx("span",{className:"text-lg font-bold block",children:r}),n.jsx("p",{className:"text-xs text-gray-600 mt-1",children:c.description})]},r)})})}function Iae({value:t,onChange:e}){const r=(t==null?void 0:t.enabled)||!1,c=(t==null?void 0:t.type)||"VLOS",h=(t==null?void 0:t.robustness)||"low";return n.jsxs("div",{className:"space-y-4",children:[n.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[n.jsx("input",{type:"checkbox",checked:r,onChange:x=>e({...t,enabled:x.target.checked}),className:"w-4 h-4 text-aeria-navy rounded focus:ring-aeria-navy"}),n.jsx("span",{className:"font-medium text-gray-900",children:"Apply Tactical Mitigation (TMPR)"})]}),r&&n.jsxs("div",{className:"ml-6 space-y-4",children:[n.jsx("div",{className:"grid grid-cols-3 gap-2",children:Object.entries(fU).map(([x,w])=>{const o=c===x;return n.jsxs("button",{type:"button",onClick:()=>e({...t,type:x}),className:`p-3 rounded-lg border text-left transition-all ${o?"border-aeria-navy bg-aeria-navy/5 ring-2 ring-aeria-navy/20":"border-gray-200 hover:border-gray-300"}`,children:[n.jsx("span",{className:"font-medium block",children:x}),n.jsx("p",{className:"text-xs text-gray-500 mt-1",children:w.description}),n.jsxs("p",{className:"text-xs text-green-600 mt-1",children:["-",w.arcReduction," ARC step"]})]},x)})}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm text-gray-600 mb-1",children:"Robustness Level"}),n.jsx("div",{className:"flex gap-2",children:["low","medium","high"].map(x=>n.jsx("button",{type:"button",onClick:()=>e({...t,robustness:x}),className:`px-3 py-1.5 rounded text-sm font-medium transition-colors ${h===x?"bg-aeria-navy text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:x.charAt(0).toUpperCase()+x.slice(1)},x))})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm text-gray-600 mb-1",children:"Evidence"}),n.jsx("textarea",{value:(t==null?void 0:t.evidence)||"",onChange:x=>e({...t,evidence:x.target.value}),placeholder:"Describe how TMPR is achieved...",rows:2,className:"input text-sm"})]})]})]})}function Pae({sail:t,osoCompliance:e,onChange:r}){const[c,h]=ue.useState(null),[x,w]=ue.useState({}),o=e||{},C=ue.useMemo(()=>gU(t,o),[t,o]),R=ue.useCallback(($,Y)=>{const H={...o,[$]:{...o[$]||{robustness:"none",evidence:""},...Y}};r(H)},[o,r]),F=$=>{w(Y=>({...Y,[$]:!Y[$]}))};return n.jsxs("div",{className:"space-y-4",children:[n.jsx("div",{className:`p-4 rounded-lg ${C.summary.overallCompliant?"bg-green-50 border border-green-200":"bg-amber-50 border border-amber-200"}`,children:n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[C.summary.overallCompliant?n.jsx(qr,{className:"w-5 h-5 text-green-600"}):n.jsx(Cs,{className:"w-5 h-5 text-amber-600"}),n.jsxs("span",{className:"font-medium",children:[C.summary.compliant," of ",C.summary.total-C.summary.optional," required OSOs compliant"]})]}),n.jsxs("span",{className:"text-sm text-gray-600",children:[C.summary.nonCompliant," gaps remaining"]})]})}),n.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3",children:n.jsxs("p",{className:"text-sm text-blue-800",children:[n.jsx(Ns,{className:"w-4 h-4 inline mr-1"}),"Requirements shown for ",n.jsxs("strong",{children:["SAIL ",t]}),". Select robustness level achieved and provide evidence reference."]})}),Object.entries(Fne).map(([$,Y])=>{const H=C.results.filter(se=>se.category===$),X=c===$,he=H.filter(se=>se.compliant||se.required==="O").length;return n.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[n.jsxs("button",{type:"button",onClick:()=>h(X?null:$),className:"w-full px-4 py-3 bg-gray-50 flex items-center justify-between hover:bg-gray-100",children:[n.jsx("span",{className:"font-medium text-gray-900",children:Y.label}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsxs("span",{className:`text-sm px-2 py-0.5 rounded-full ${he===H.length?"bg-green-100 text-green-700":"bg-amber-100 text-amber-700"}`,children:[he,"/",H.length]}),X?n.jsx($n,{className:"w-4 h-4"}):n.jsx(fn,{className:"w-4 h-4"})]})]}),X&&n.jsx("div",{className:"divide-y divide-gray-100",children:H.map(se=>{var Ce,ne,ae;const de=((Ce=o[se.id])==null?void 0:Ce.robustness)||"none",K=((ne=o[se.id])==null?void 0:ne.evidence)||"",ge=x[se.id],Ae=se.required==="L"?"low":se.required==="M"?"medium":se.required==="H"?"high":null,Te=((ae=se.evidenceGuidance)==null?void 0:ae[Ae])||[];return n.jsxs("div",{className:`p-4 ${!se.compliant&&se.required!=="O"?"bg-red-50/30":""}`,children:[n.jsxs("div",{className:"flex items-start justify-between gap-4 mb-2",children:[n.jsxs("div",{className:"flex-1",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("span",{className:"font-medium text-gray-900",children:se.id}),se.compliant?n.jsx(ru,{className:"w-4 h-4 text-green-500"}):se.required==="O"?n.jsx("span",{className:"text-xs text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded",children:"Optional"}):n.jsx(cs,{className:"w-4 h-4 text-red-500"}),n.jsxs("span",{className:"text-xs text-gray-400",children:["(",se.responsibility,")"]})]}),n.jsx("p",{className:"text-sm text-gray-600",children:se.name}),n.jsx("p",{className:"text-xs text-gray-400 mt-0.5",children:se.description})]}),n.jsxs("div",{className:"text-right flex flex-col items-end gap-1",children:[n.jsxs("span",{className:`text-xs px-2 py-0.5 rounded font-medium ${se.required==="O"?"bg-gray-100 text-gray-600":se.required==="L"?"bg-green-100 text-green-700":se.required==="M"?"bg-amber-100 text-amber-700":"bg-red-100 text-red-700"}`,children:["Required: ",se.requiredLabel]}),Te.length>0&&n.jsxs("button",{type:"button",onClick:()=>F(se.id),className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1",children:[n.jsx(Ns,{className:"w-3 h-3"}),ge?"Hide":"Show"," guidance"]})]})]}),ge&&Te.length>0&&n.jsxs("div",{className:"mb-3 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[n.jsxs("p",{className:"text-xs font-medium text-blue-900 mb-1",children:["Evidence guidance for ",Ae," robustness:"]}),n.jsx("ul",{className:"text-xs text-blue-800 space-y-0.5",children:Te.map((q,oe)=>n.jsxs("li",{className:"flex items-start gap-1",children:[n.jsx("span",{className:"text-blue-500",children:""}),q]},oe))})]}),n.jsx("div",{className:"flex gap-2 mb-2",children:["none","low","medium","high"].map(q=>{const oe=de===q,ke=se.required==="O"||q==="low"&&["L"].includes(se.required)||q==="medium"&&["L","M"].includes(se.required)||q==="high";return n.jsx("button",{type:"button",onClick:Ve=>{Ve.preventDefault(),Ve.stopPropagation(),R(se.id,{robustness:q})},className:`px-3 py-1.5 text-xs rounded font-medium transition-colors ${oe?"bg-aeria-navy text-white":q!=="none"&&ke?"bg-green-50 text-green-700 border border-green-200 hover:bg-green-100":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:q==="none"?"None":q.charAt(0).toUpperCase()+q.slice(1)},`${se.id}-${q}`)})}),n.jsx("input",{type:"text",value:K,onChange:q=>R(se.id,{evidence:q.target.value}),placeholder:"Evidence reference (e.g., Training Records 3.2, Maintenance Log)",className:"input text-sm py-1"})]},se.id)})})]},$)})]})}function jae({sail:t,adjacentPopulation:e,operationalPopulation:r,containment:c={},maxSpeed:h=25,onChange:x}){var K,ge,Ae,Te;const[w,o]=ue.useState(!1),C=ue.useMemo(()=>Vne(h),[h]),R=["controlled","remote","lightly","sparsely","suburban","highdensity","assembly"],F=R.indexOf(r||"sparsely"),Y=R.indexOf(e||r||"sparsely")>F,H=ue.useMemo(()=>Y?Une(e,t)||"low":"none",[e,t,Y]),X=c.method||"none",he=((K=qw[X])==null?void 0:K.robustnessAchievable)||"none",se=["none","low","medium","high"],de=se.indexOf(he)>=se.indexOf(H);return n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{className:"space-y-3",children:[n.jsx("h4",{className:"font-medium text-gray-900",children:"Adjacent Area Assessment"}),n.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[n.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[n.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Operational Area"}),n.jsx("p",{className:"font-medium text-gray-900",children:((ge=hf[r])==null?void 0:ge.label)||"Not set"})]}),n.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[n.jsxs("p",{className:"text-xs text-gray-500 mb-1",children:["Adjacent Area (within ",(C/1e3).toFixed(0),"km)"]}),n.jsxs("select",{value:e||"",onChange:Ce=>x({adjacentPopulation:Ce.target.value}),className:"input text-sm py-1 mt-1",children:[n.jsx("option",{value:"",children:"Same as operational"}),Object.entries(hf).map(([Ce,ne])=>n.jsx("option",{value:Ce,children:ne.label},Ce))]})]})]}),Y?n.jsx("div",{className:"p-3 bg-amber-50 border border-amber-200 rounded-lg",children:n.jsxs("div",{className:"flex items-start gap-2",children:[n.jsx(Cs,{className:"w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5"}),n.jsxs("div",{children:[n.jsx("p",{className:"font-medium text-amber-900",children:"Higher Population Adjacent"}),n.jsx("p",{className:"text-sm text-amber-700 mt-1",children:"Adjacent area has higher population density. You must either:"}),n.jsxs("ul",{className:"text-sm text-amber-700 mt-1 ml-4 list-disc",children:[n.jsxs("li",{children:["Demonstrate containment with ",n.jsx("strong",{children:H})," robustness, OR"]}),n.jsx("li",{children:"Use the higher population category for GRC calculation"})]})]})]})}):n.jsx("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(qr,{className:"w-5 h-5 text-green-600"}),n.jsx("p",{className:"text-green-800",children:"Adjacent area population is same or lower - no additional containment required."})]})})]}),Y&&n.jsxs("div",{className:"space-y-3 pt-2",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("h4",{className:"font-medium text-gray-900",children:"Containment Method"}),n.jsxs("span",{className:`text-xs px-2 py-1 rounded-full font-medium ${H==="low"?"bg-green-100 text-green-700":H==="medium"?"bg-amber-100 text-amber-700":"bg-red-100 text-red-700"}`,children:["Required: ",H.charAt(0).toUpperCase()+H.slice(1)]})]}),n.jsx("div",{className:"space-y-2",children:Object.entries(qw).map(([Ce,ne])=>{const ae=X===Ce,q=se.indexOf(ne.robustnessAchievable)>=se.indexOf(H);return n.jsxs("label",{className:`flex items-start gap-3 p-3 rounded-lg border cursor-pointer transition-colors ${ae?"bg-aeria-navy/5 border-aeria-navy":q&&Ce!=="none"?"bg-green-50/50 border-green-200 hover:border-green-300":"bg-gray-50 border-gray-200 hover:border-gray-300"}`,children:[n.jsx("input",{type:"radio",name:"containmentMethod",value:Ce,checked:ae,onChange:()=>x({method:Ce}),className:"mt-1"}),n.jsxs("div",{className:"flex-1",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("span",{className:"font-medium text-gray-900",children:ne.label}),n.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded ${ne.robustnessAchievable==="none"?"bg-gray-100 text-gray-600":ne.robustnessAchievable==="low"?"bg-green-100 text-green-700":ne.robustnessAchievable==="medium"?"bg-amber-100 text-amber-700":"bg-red-100 text-red-700"}`,children:ne.robustnessAchievable==="none"?"N/A":ne.robustnessAchievable}),q&&Ce!=="none"&&n.jsx(ru,{className:"w-4 h-4 text-green-500"})]}),n.jsx("p",{className:"text-sm text-gray-600 mt-0.5",children:ne.description})]})]},Ce)})}),X!=="none"&&((Te=(Ae=qw[X])==null?void 0:Ae.evidenceRequired)==null?void 0:Te.length)>0&&n.jsxs("div",{className:"p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[n.jsxs("button",{type:"button",onClick:()=>o(!w),className:"w-full flex items-center justify-between text-left",children:[n.jsx("span",{className:"text-sm font-medium text-blue-900",children:"Evidence Required"}),w?n.jsx($n,{className:"w-4 h-4 text-blue-600"}):n.jsx(fn,{className:"w-4 h-4 text-blue-600"})]}),w&&n.jsx("ul",{className:"mt-2 text-sm text-blue-800 space-y-1",children:qw[X].evidenceRequired.map((Ce,ne)=>n.jsxs("li",{className:"flex items-start gap-1",children:[n.jsx("span",{className:"text-blue-500",children:""}),Ce]},ne))})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Containment Evidence Reference"}),n.jsx("input",{type:"text",value:c.evidence||"",onChange:Ce=>x({evidence:Ce.target.value}),placeholder:"e.g., Geofence test report 4.2, FTS certification...",className:"input"})]}),n.jsx("div",{className:`p-4 rounded-lg ${de?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:n.jsx("div",{className:"flex items-center gap-2",children:de?n.jsxs(n.Fragment,{children:[n.jsx(qr,{className:"w-5 h-5 text-green-600"}),n.jsx("span",{className:"font-medium text-green-900",children:"Containment requirement met"})]}):n.jsxs(n.Fragment,{children:[n.jsx(cs,{className:"w-5 h-5 text-red-600"}),n.jsxs("span",{className:"font-medium text-red-900",children:["Containment requirement not met - select method with ",H," robustness"]})]})})})]})]})}function Rae({sites:t,calculations:e}){const r=ue.useMemo(()=>{const c=t.map(w=>{const o=e[w.id]||{};return{id:w.id,name:w.name,iGRC:o.iGRC,fGRC:o.fGRC,initialARC:o.initialARC,residualARC:o.residualARC,sail:o.sail,withinScope:o.fGRC!==null&&o.fGRC<=7}}),h=c.reduce((w,o)=>{const C=["I","II","III","IV","V","VI"],R=C.indexOf(o.sail),F=C.indexOf(w);return R>F?o.sail:w},"I"),x=c.every(w=>w.withinScope);return{sites:c,maxSAIL:h,allWithinScope:x,siteCount:t.length}},[t,e]);return t.length<=1?null:n.jsxs("div",{className:"bg-gradient-to-r from-aeria-navy to-aeria-navy/80 text-white rounded-lg p-6",children:[n.jsxs("h3",{className:"text-lg font-bold mb-4 flex items-center gap-2",children:[n.jsx(oie,{className:"w-5 h-5"}),"Multi-Site Risk Summary"]}),n.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-4",children:[n.jsxs("div",{className:"bg-white/10 rounded-lg p-3 text-center",children:[n.jsx("p",{className:"text-white/70 text-sm",children:"Sites Assessed"}),n.jsx("p",{className:"text-2xl font-bold",children:r.siteCount})]}),n.jsxs("div",{className:"bg-white/10 rounded-lg p-3 text-center",children:[n.jsx("p",{className:"text-white/70 text-sm",children:"Highest SAIL"}),n.jsx("p",{className:"text-2xl font-bold",children:r.maxSAIL||"N/A"})]}),n.jsxs("div",{className:"bg-white/10 rounded-lg p-3 text-center",children:[n.jsx("p",{className:"text-white/70 text-sm",children:"Within SORA Scope"}),n.jsx("p",{className:"text-2xl font-bold",children:r.allWithinScope?n.jsx(ru,{className:"w-6 h-6 mx-auto text-green-400"}):n.jsx(cs,{className:"w-6 h-6 mx-auto text-red-400"})})]}),n.jsxs("div",{className:"bg-white/10 rounded-lg p-3 text-center",children:[n.jsx("p",{className:"text-white/70 text-sm",children:"Governing SAIL"}),n.jsx(AS,{sail:r.maxSAIL,size:"md"})]})]}),n.jsx("div",{className:"overflow-x-auto",children:n.jsxs("table",{className:"w-full text-sm",children:[n.jsx("thead",{children:n.jsxs("tr",{className:"text-white/70 border-b border-white/20",children:[n.jsx("th",{className:"text-left py-2",children:"Site"}),n.jsx("th",{className:"text-center py-2",children:"iGRC"}),n.jsx("th",{className:"text-center py-2",children:"fGRC"}),n.jsx("th",{className:"text-center py-2",children:"ARC"}),n.jsx("th",{className:"text-center py-2",children:"SAIL"})]})}),n.jsx("tbody",{children:r.sites.map(c=>n.jsxs("tr",{className:"border-b border-white/10",children:[n.jsx("td",{className:"py-2",children:c.name}),n.jsx("td",{className:"text-center py-2",children:c.iGRC??"-"}),n.jsx("td",{className:"text-center py-2",children:c.fGRC??"-"}),n.jsx("td",{className:"text-center py-2",children:c.residualARC||c.initialARC||"-"}),n.jsx("td",{className:"text-center py-2",children:c.sail?n.jsx(AS,{sail:c.sail,size:"sm"}):"-"})]},c.id))})]})})]})}function kae({project:t,onUpdate:e,onNavigateToSection:r}){var de,K,ge,Ae,Te,Ce,ne,ae,q,oe,ke,Ve;const c=ue.useMemo(()=>Array.isArray(t==null?void 0:t.sites)?t.sites:[],[t==null?void 0:t.sites]),h=(t==null?void 0:t.activeSiteId)||((de=c[0])==null?void 0:de.id)||null,x=ue.useMemo(()=>c.find(ie=>ie.id===h)||c[0]||null,[c,h]),w=ue.useMemo(()=>(x==null?void 0:x.soraAssessment)||{},[x==null?void 0:x.soraAssessment]),o=(t==null?void 0:t.aircraft)||[],C=((K=x==null?void 0:x.flightPlan)==null?void 0:K.aircraft)||[],R=(ge=x==null?void 0:x.flightPlan)==null?void 0:ge.primaryAircraftId,F=ue.useMemo(()=>{var ie;return C.length>0?o.filter(ze=>C.includes(ze.id)):((ie=t==null?void 0:t.flightPlan)==null?void 0:ie.aircraft)||[]},[C,o,(Ae=t==null?void 0:t.flightPlan)==null?void 0:Ae.aircraft]),$=ue.useMemo(()=>R?o.find(ie=>ie.id===R):F.length>0?F.find(ie=>ie.isPrimary)||F[0]:null,[R,F,o]),Y=ue.useMemo(()=>{const ie={};return c.forEach(ze=>{var Ot,Et;const ve=ze.soraAssessment||{},Le=ve.populationCategory||((Et=(Ot=ze.siteSurvey)==null?void 0:Ot.population)==null?void 0:Et.category)||"sparsely",Ke=ve.uaCharacteristics||"1m_25ms",Pe=RT(Le,Ke),It=kT(Pe,ve.mitigations||{}),tt=ve.initialARC||"ARC-b",zt=DT(tt,ve.tmpr||{}),vt=MT(It,zt);ie[ze.id]={population:Le,uaChar:Ke,iGRC:Pe,fGRC:It,initialARC:tt,residualARC:zt,sail:vt,withinScope:Bne(It)}}),ie},[c]),H=Y[h]||{},X=ue.useCallback(ie=>{e({activeSiteId:ie})},[e]),he=ue.useCallback(ie=>{if(!h||!c.length)return;const ze=c.map(ve=>{if(ve.id!==h)return ve;const Le={...ve.soraAssessment||{},...ie,lastUpdated:new Date().toISOString()};return{...ve,soraAssessment:Le,updatedAt:new Date().toISOString()}});e({sites:ze})},[c,h,e]),se=ue.useCallback(()=>{var ze,ve;const ie=(ve=(ze=x==null?void 0:x.siteSurvey)==null?void 0:ze.population)==null?void 0:ve.category;ie&&he({populationCategory:ie})},[x,he]);return ue.useEffect(()=>{var ve,Le;const ie=(Le=(ve=x==null?void 0:x.siteSurvey)==null?void 0:ve.population)==null?void 0:Le.category,ze=w==null?void 0:w.populationCategory;ie&&!ze&&he({populationCategory:ie})},[(Ce=(Te=x==null?void 0:x.siteSurvey)==null?void 0:Te.population)==null?void 0:Ce.category,h]),ue.useEffect(()=>{var ve,Le;const ie=(Le=(ve=x==null?void 0:x.siteSurvey)==null?void 0:ve.population)==null?void 0:Le.adjacentCategory,ze=w==null?void 0:w.adjacentAreaPopulation;ie&&!ze&&he({adjacentAreaPopulation:ie})},[(ae=(ne=x==null?void 0:x.siteSurvey)==null?void 0:ne.population)==null?void 0:ae.adjacentCategory,h]),ue.useEffect(()=>{if(!$||w!=null&&w.uaCharacteristics)return;const ie=($==null?void 0:$.maxDimension)||($==null?void 0:$.wingspan)||1,ze=($==null?void 0:$.maxSpeed)||25;let ve="1m_25ms";for(const[Le,Ke]of Object.entries(tv))if(ie<=Ke.maxDimension&&ze<=Ke.maxSpeed){ve=Le;break}he({uaCharacteristics:ve})},[$,h]),c.length===0?n.jsxs("div",{className:"text-center py-12",children:[n.jsx(Ds,{className:"w-12 h-12 mx-auto text-gray-300 mb-4"}),n.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Sites to Assess"}),n.jsx("p",{className:"text-gray-500 mb-4",children:"Add operation sites in Site Survey before performing SORA assessment."}),n.jsx("button",{type:"button",onClick:()=>r==null?void 0:r("siteSurvey"),className:"btn-primary",children:"Go to Site Survey"})]}):n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[n.jsxs("div",{children:[n.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"SORA 2.5 Assessment"}),n.jsx("p",{className:"text-gray-500",children:"JARUS Specific Operations Risk Assessment per site"})]}),n.jsx("div",{className:"flex items-center gap-4",children:H.sail&&n.jsxs("div",{className:"text-right",children:[n.jsx("p",{className:"text-sm text-gray-500",children:"Site SAIL Level"}),n.jsx(AS,{sail:H.sail,size:"lg"})]})})]}),n.jsx(Tae,{sites:c,activeSiteId:h,onSelectSite:X,calculations:Y}),n.jsx(Rae,{sites:c,calculations:Y}),!H.withinScope&&H.fGRC!==null&&n.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:n.jsxs("div",{className:"flex items-start gap-3",children:[n.jsx(ir,{className:"w-6 h-6 text-red-500 flex-shrink-0"}),n.jsxs("div",{children:[n.jsx("h3",{className:"font-medium text-red-800",children:"Outside SORA Scope"}),n.jsxs("p",{className:"text-sm text-red-700 mt-1",children:["Final GRC of ",H.fGRC," exceeds SORA limit of 7. This operation requires additional approval beyond SORA methodology."]})]})]})}),n.jsxs(km,{title:"Ground Risk - Intrinsic GRC (iGRC)",stepNumber:2,badge:H.iGRC?`iGRC: ${H.iGRC}`:null,status:H.iGRC?"complete":"missing",children:[n.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4",children:n.jsxs("p",{className:"text-sm text-blue-800",children:[n.jsx(Ns,{className:"w-4 h-4 inline mr-1"}),"iGRC is determined by population density and UA characteristics (SORA 2.5 Table 2)"]})}),n.jsx(Nae,{value:w.populationCategory||H.population,onChange:ie=>he({populationCategory:ie}),fromSiteSurvey:(oe=(q=x==null?void 0:x.siteSurvey)==null?void 0:q.population)==null?void 0:oe.category,onSyncFromSurvey:se}),n.jsx("div",{className:"mt-6",children:n.jsx(Aae,{value:w.uaCharacteristics||H.uaChar,onChange:ie=>he({uaCharacteristics:ie}),aircraft:F})}),n.jsx("div",{className:"mt-6 flex justify-center",children:n.jsx(OC,{label:"Intrinsic Ground Risk Class",value:H.iGRC,description:"Before mitigations"})})]}),n.jsxs(km,{title:"Ground Risk - Final GRC (fGRC)",stepNumber:3,badge:H.fGRC?`fGRC: ${H.fGRC}`:null,status:H.fGRC?"complete":"missing",children:[n.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4",children:n.jsxs("p",{className:"text-sm text-blue-800",children:[n.jsx(Ns,{className:"w-4 h-4 inline mr-1"}),"Apply mitigations to reduce ground risk. M3 (ERP) was removed in SORA 2.5."]})}),n.jsx("div",{className:"space-y-4",children:Object.entries(pU).map(([ie,ze])=>{var ve;return n.jsx(Cae,{mitigationId:ie,mitigation:ze,config:((ve=w.mitigations)==null?void 0:ve[ie])||{},onChange:Le=>he({mitigations:{...w.mitigations||{},[ie]:Le}})},ie)})}),n.jsxs("div",{className:"mt-6 flex justify-center gap-8",children:[n.jsx(OC,{label:"iGRC",value:H.iGRC}),n.jsx("div",{className:"flex items-center",children:n.jsx(fc,{className:"w-8 h-8 text-gray-400"})}),n.jsx(OC,{label:"Final GRC",value:H.fGRC,description:"After mitigations"})]})]}),n.jsxs(km,{title:"Air Risk - Initial ARC",stepNumber:4,badge:w.initialARC||"ARC-b",status:w.initialARC?"complete":"missing",children:[n.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4",children:n.jsxs("p",{className:"text-sm text-blue-800",children:[n.jsx(Ns,{className:"w-4 h-4 inline mr-1"}),"Initial ARC is determined by the airspace classification and encounter probability (SORA 2.5 Step #4)"]})}),n.jsx(Eae,{value:w.initialARC||"ARC-b",onChange:ie=>he({initialARC:ie})}),n.jsxs("div",{className:"mt-4 p-4 bg-gray-50 rounded-lg text-center",children:[n.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"Initial Air Risk Class"}),n.jsx("span",{className:"text-2xl font-bold",children:w.initialARC||"ARC-b"})]})]}),n.jsxs(km,{title:"Air Risk - Residual ARC (TMPR)",stepNumber:5,badge:H.residualARC,status:(ke=w.tmpr)!=null&&ke.enabled?"complete":"info",children:[n.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4",children:n.jsxs("p",{className:"text-sm text-blue-800",children:[n.jsx(Ns,{className:"w-4 h-4 inline mr-1"}),"Apply Tactical Mitigation Performance Requirements to reduce ARC (SORA 2.5 Step #5)"]})}),n.jsx(Iae,{value:w.tmpr||{},onChange:ie=>he({tmpr:ie})}),n.jsxs("div",{className:"mt-4 flex justify-center gap-8 p-4 bg-gray-50 rounded-lg",children:[n.jsxs("div",{className:"text-center",children:[n.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"Initial ARC"}),n.jsx("span",{className:"text-lg font-bold",children:w.initialARC||"ARC-b"})]}),n.jsx(fc,{className:"w-6 h-6 text-gray-400 self-center"}),n.jsxs("div",{className:"text-center",children:[n.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"Residual ARC"}),n.jsx("span",{className:"text-lg font-bold text-green-600",children:H.residualARC})]})]})]}),n.jsx(km,{title:"SAIL Determination",stepNumber:6,badge:H.sail?`SAIL ${H.sail}`:null,status:H.sail?"complete":"missing",children:n.jsxs("div",{className:"text-center py-6",children:[n.jsx("p",{className:"text-gray-600 mb-4",children:"Based on Final GRC and Residual ARC"}),n.jsxs("div",{className:"flex items-center justify-center gap-8 mb-6",children:[n.jsxs("div",{className:"text-center",children:[n.jsx("p",{className:"text-sm text-gray-500",children:"Final GRC"}),n.jsx("p",{className:"text-2xl font-bold",children:H.fGRC??"?"})]}),n.jsx("span",{className:"text-gray-400",children:""}),n.jsxs("div",{className:"text-center",children:[n.jsx("p",{className:"text-sm text-gray-500",children:"Residual ARC"}),n.jsx("p",{className:"text-2xl font-bold",children:H.residualARC})]}),n.jsx("span",{className:"text-gray-400",children:"="}),n.jsxs("div",{className:"text-center",children:[n.jsx("p",{className:"text-sm text-gray-500",children:"SAIL Level"}),n.jsx(AS,{sail:H.sail,size:"lg"})]})]}),H.sail&&fI[H.sail]&&n.jsx("p",{className:"text-sm text-gray-600 max-w-md mx-auto",children:fI[H.sail]})]})}),H.sail&&n.jsx(km,{title:"Operational Safety Objectives (OSO)",stepNumber:7,defaultOpen:!1,children:n.jsx(Pae,{sail:H.sail,osoCompliance:w.osoCompliance||{},onChange:ie=>he({osoCompliance:ie})},`oso-${h}`)}),H.sail&&n.jsx(km,{title:"Containment & Adjacent Area",stepNumber:8,defaultOpen:!1,status:w.adjacentAreaPopulation&&(Ve=w.containment)!=null&&Ve.method&&w.containment.method!=="none"?"complete":"incomplete",children:n.jsx(jae,{sail:H.sail,adjacentPopulation:w.adjacentAreaPopulation,operationalPopulation:w.populationCategory||H.population,containment:w.containment||{},maxSpeed:($==null?void 0:$.maxSpeed)||25,onChange:ie=>{const ze={};ie.adjacentPopulation!==void 0&&(ze.adjacentAreaPopulation=ie.adjacentPopulation),(ie.method!==void 0||ie.evidence!==void 0)&&(ze.containment={...w.containment||{},...ie.method!==void 0&&{method:ie.method},...ie.evidence!==void 0&&{evidence:ie.evidence}}),he(ze)}})}),n.jsxs("div",{className:"flex justify-between items-center p-4 bg-gray-50 rounded-lg",children:[n.jsxs("button",{type:"button",onClick:()=>r==null?void 0:r("siteSurvey"),className:"text-aeria-navy hover:underline flex items-center gap-1",children:[n.jsx(fc,{className:"w-4 h-4 rotate-180"}),"Back to Site Survey"]}),n.jsxs("button",{type:"button",onClick:()=>r==null?void 0:r("flightPlan"),className:"text-aeria-navy hover:underline flex items-center gap-1",children:["View Flight Plan",n.jsx(fc,{className:"w-4 h-4"})]})]})]})}const U3={pending:{label:"Pending Review",color:"bg-gray-100 text-gray-700",icon:Wu},submitted:{label:"Submitted",color:"bg-blue-100 text-blue-700",icon:hI},approved:{label:"Approved",color:"bg-green-100 text-green-700",icon:qr},rejected:{label:"Requires Changes",color:"bg-red-100 text-red-700",icon:zl},conditional:{label:"Conditional Approval",color:"bg-amber-100 text-amber-700",icon:ir}},Dae=[{value:"operations_manager",label:"Operations Manager"},{value:"chief_pilot",label:"Chief Pilot"},{value:"safety_officer",label:"Safety Officer"},{value:"client_representative",label:"Client Representative"},{value:"site_supervisor",label:"Site Supervisor"},{value:"other",label:"Other"}];function Mae({project:t,onUpdate:e}){var ae,q,oe,ke,Ve;const[r,c]=ue.useState({submission:!0,approval:!0,acknowledgments:!0});ue.useEffect(()=>{t.approvals||e({approvals:{status:"pending",submittedBy:"",submittedDate:"",submissionNotes:"",reviewer:{name:"",role:"operations_manager",email:""},reviewDate:"",reviewNotes:"",conditions:"",crewAcknowledgments:[]}})},[t.approvals]);const h=t.approvals||{},x=t.crew||[],w=ie=>{e({approvals:{...h,...ie}})},o=(ie,ze)=>{w({reviewer:{...h.reviewer||{},[ie]:ze}})},C=ie=>{c(ze=>({...ze,[ie]:!ze[ie]}))},R=()=>{if(!h.submittedBy){alert("Please enter your name before submitting.");return}w({status:"submitted",submittedDate:new Date().toISOString().split("T")[0]})},F=(ie=!1)=>{var ze;if(!((ze=h.reviewer)!=null&&ze.name)){alert("Please enter reviewer name.");return}w({status:ie?"conditional":"approved",reviewDate:new Date().toISOString().split("T")[0]})},$=()=>{var ie;if(!((ie=h.reviewer)!=null&&ie.name)){alert("Please enter reviewer name.");return}if(!h.reviewNotes){alert("Please provide notes on required changes.");return}w({status:"rejected",reviewDate:new Date().toISOString().split("T")[0]})},Y=()=>{confirm("Reset approval status to pending? This will clear review information.")&&w({status:"pending",reviewDate:"",reviewNotes:"",conditions:""})},H=(ie,ze)=>{const ve=h.crewAcknowledgments||[];ve.find(Ke=>Ke.crewId===ie)||w({crewAcknowledgments:[...ve,{crewId:ie,name:ze,date:new Date().toISOString().split("T")[0],timestamp:new Date().toISOString()}]})},X=ie=>{w({crewAcknowledgments:(h.crewAcknowledgments||[]).filter(ze=>ze.crewId!==ie)})},he=ie=>(h.crewAcknowledgments||[]).find(ze=>ze.crewId===ie),se=U3[h.status]||U3.pending,de=se.icon,K=h.status==="approved"||h.status==="conditional",ge=K,Ae=(h.crewAcknowledgments||[]).length,Te=x.length,ne=(()=>{var ze,ve,Le,Ke;const ie=[];return t.name||ie.push("Project name missing"),t.startDate||ie.push("Start date not set"),x.length===0&&ie.push("No crew assigned"),x.some(Pe=>Pe.role==="PIC")||ie.push("No PIC assigned"),(ze=t.sections)!=null&&ze.flightPlan&&((ve=t.flightPlan)!=null&&ve.maxAltitude||ie.push("Max altitude not set")),t.riskAssessment&&(t.riskAssessment.overallRiskAcceptable===null?ie.push("Risk assessment not reviewed"):t.riskAssessment.overallRiskAcceptable===!1&&ie.push("Risk assessment marked as not acceptable")),(Ke=(Le=t.emergencyPlan)==null?void 0:Le.primaryEmergencyContact)!=null&&Ke.name||ie.push("Emergency contact not set"),ie})();return n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:`p-4 rounded-lg ${se.color} flex items-center justify-between`,children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx(de,{className:"w-6 h-6"}),n.jsxs("div",{children:[n.jsx("p",{className:"font-semibold",children:se.label}),h.reviewDate&&n.jsxs("p",{className:"text-sm opacity-75",children:[h.status==="submitted"?"Submitted":"Reviewed"," on ",h.reviewDate]})]})]}),ge&&n.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[n.jsx(S6,{className:"w-4 h-4"}),"Plan Locked"]})]}),ne.length>0&&h.status==="pending"&&n.jsxs("div",{className:"card bg-amber-50 border-amber-200",children:[n.jsxs("h3",{className:"font-medium text-amber-900 mb-2 flex items-center gap-2",children:[n.jsx(ir,{className:"w-5 h-5"}),"Readiness Issues"]}),n.jsx("ul",{className:"space-y-1",children:ne.map((ie,ze)=>n.jsxs("li",{className:"text-sm text-amber-800 flex items-center gap-2",children:[n.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-amber-500"}),ie]},ze))}),n.jsx("p",{className:"text-xs text-amber-700 mt-3",children:"Address these items before submitting for approval."})]}),n.jsxs("div",{className:"card",children:[n.jsxs("button",{onClick:()=>C("submission"),className:"flex items-center justify-between w-full text-left",children:[n.jsxs("h2",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[n.jsx(hI,{className:"w-5 h-5 text-aeria-blue"}),"Plan Submission"]}),r.submission?n.jsx($n,{className:"w-5 h-5 text-gray-400"}):n.jsx(fn,{className:"w-5 h-5 text-gray-400"})]}),r.submission&&n.jsxs("div",{className:"mt-4 space-y-4",children:[n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Submitted By"}),n.jsx("input",{type:"text",value:h.submittedBy||"",onChange:ie=>w({submittedBy:ie.target.value}),className:"input",placeholder:"Your name",disabled:h.status!=="pending"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Submission Date"}),n.jsx("input",{type:"date",value:h.submittedDate||"",onChange:ie=>w({submittedDate:ie.target.value}),className:"input",disabled:h.status!=="pending"})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Submission Notes"}),n.jsx("textarea",{value:h.submissionNotes||"",onChange:ie=>w({submissionNotes:ie.target.value}),className:"input min-h-[80px]",placeholder:"Any notes for the reviewer...",disabled:h.status!=="pending"})]}),h.status==="pending"&&n.jsxs("button",{onClick:R,disabled:ne.length>0,className:"btn-primary inline-flex items-center gap-2",children:[n.jsx(hI,{className:"w-4 h-4"}),"Submit for Approval"]}),h.status==="rejected"&&n.jsxs("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:[n.jsxs("p",{className:"text-sm text-red-800",children:[n.jsx("strong",{children:"Changes Required:"})," Please address the reviewer's notes and resubmit."]}),n.jsxs("button",{onClick:()=>w({status:"pending"}),className:"mt-2 text-sm text-red-700 hover:underline inline-flex items-center gap-1",children:[n.jsx(wT,{className:"w-3 h-3"}),"Edit and Resubmit"]})]})]})]}),n.jsxs("div",{className:"card",children:[n.jsxs("button",{onClick:()=>C("approval"),className:"flex items-center justify-between w-full text-left",children:[n.jsxs("h2",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[n.jsx(eb,{className:"w-5 h-5 text-aeria-blue"}),"Review & Approval"]}),r.approval?n.jsx($n,{className:"w-5 h-5 text-gray-400"}):n.jsx(fn,{className:"w-5 h-5 text-gray-400"})]}),r.approval&&n.jsxs("div",{className:"mt-4 space-y-4",children:[n.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg border border-gray-200",children:[n.jsx("h3",{className:"font-medium text-gray-900 mb-3",children:"Reviewer Information"}),n.jsxs("div",{className:"grid sm:grid-cols-3 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Reviewer Name"}),n.jsx("input",{type:"text",value:((ae=h.reviewer)==null?void 0:ae.name)||"",onChange:ie=>o("name",ie.target.value),className:"input",placeholder:"Name",disabled:K})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Role"}),n.jsx("select",{value:((q=h.reviewer)==null?void 0:q.role)||"operations_manager",onChange:ie=>o("role",ie.target.value),className:"input",disabled:K,children:Dae.map(ie=>n.jsx("option",{value:ie.value,children:ie.label},ie.value))})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Email"}),n.jsx("input",{type:"email",value:((oe=h.reviewer)==null?void 0:oe.email)||"",onChange:ie=>o("email",ie.target.value),className:"input",placeholder:"Email",disabled:K})]})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Review Notes"}),n.jsx("textarea",{value:h.reviewNotes||"",onChange:ie=>w({reviewNotes:ie.target.value}),className:"input min-h-[80px]",placeholder:"Notes, required changes, or conditions...",disabled:K})]}),(h.status==="conditional"||h.conditions)&&n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Conditions of Approval"}),n.jsx("textarea",{value:h.conditions||"",onChange:ie=>w({conditions:ie.target.value}),className:"input min-h-[60px]",placeholder:"Conditions that must be met...",disabled:K})]}),h.status==="submitted"&&n.jsxs("div",{className:"flex flex-wrap gap-3 pt-2",children:[n.jsxs("button",{onClick:()=>F(!1),className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 inline-flex items-center gap-2",children:[n.jsx(qr,{className:"w-4 h-4"}),"Approve"]}),n.jsxs("button",{onClick:()=>F(!0),className:"px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 inline-flex items-center gap-2",children:[n.jsx(ir,{className:"w-4 h-4"}),"Approve with Conditions"]}),n.jsxs("button",{onClick:$,className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 inline-flex items-center gap-2",children:[n.jsx(zl,{className:"w-4 h-4"}),"Request Changes"]})]}),K&&n.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(qr,{className:"w-5 h-5 text-green-600"}),n.jsxs("span",{className:"text-sm text-green-800",children:["Approved by ",(ke=h.reviewer)==null?void 0:ke.name," on ",h.reviewDate,h.status==="conditional"&&" (with conditions)"]})]}),n.jsx("button",{onClick:Y,className:"text-xs text-green-700 hover:underline",children:"Reset"})]})]})]}),n.jsxs("div",{className:"card",children:[n.jsxs("button",{onClick:()=>C("acknowledgments"),className:"flex items-center justify-between w-full text-left",children:[n.jsxs("h2",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[n.jsx(ds,{className:"w-5 h-5 text-aeria-blue"}),"Crew Acknowledgments",Te>0&&n.jsxs("span",{className:`px-2 py-0.5 text-xs rounded-full ${Ae===Te?"bg-green-100 text-green-700":"bg-gray-100 text-gray-600"}`,children:[Ae,"/",Te]})]}),r.acknowledgments?n.jsx($n,{className:"w-5 h-5 text-gray-400"}):n.jsx(fn,{className:"w-5 h-5 text-gray-400"})]}),r.acknowledgments&&n.jsxs("div",{className:"mt-4 space-y-4",children:[!K&&n.jsx("div",{className:"p-3 bg-gray-50 border border-gray-200 rounded-lg",children:n.jsx("p",{className:"text-sm text-gray-600",children:"Crew acknowledgments are available after the plan is approved."})}),K&&x.length===0&&n.jsxs("div",{className:"text-center py-6 bg-gray-50 rounded-lg",children:[n.jsx(ds,{className:"w-10 h-10 mx-auto mb-2 text-gray-300"}),n.jsx("p",{className:"text-gray-500",children:"No crew members assigned."})]}),K&&x.length>0&&n.jsxs("div",{className:"space-y-2",children:[n.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"Each crew member should acknowledge they have reviewed and understood the operations plan."}),x.map(ie=>{var ve;const ze=he(ie.id);return n.jsx("div",{className:`p-3 rounded-lg border ${ze?"bg-green-50 border-green-200":"bg-gray-50 border-gray-200"}`,children:n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium ${ze?"bg-green-200 text-green-800":"bg-gray-200 text-gray-600"}`,children:((ve=ie.name)==null?void 0:ve.split(" ").map(Le=>Le[0]).join("").toUpperCase())||"?"}),n.jsxs("div",{children:[n.jsx("p",{className:"font-medium text-gray-900",children:ie.name}),n.jsx("p",{className:"text-sm text-gray-500",children:ie.role})]})]}),ze?n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsxs("div",{className:"text-right",children:[n.jsxs("p",{className:"text-sm text-green-700 flex items-center gap-1",children:[n.jsx(qr,{className:"w-4 h-4"}),"Acknowledged"]}),n.jsx("p",{className:"text-xs text-green-600",children:ze.date})]}),n.jsx("button",{onClick:()=>X(ie.id),className:"text-xs text-gray-400 hover:text-red-500",children:"Remove"})]}):n.jsx("button",{onClick:()=>H(ie.id,ie.name),className:"px-3 py-1.5 text-sm bg-aeria-navy text-white rounded-lg hover:bg-aeria-blue",children:"Acknowledge"})]})},ie.id)}),Ae===Te&&Te>0&&n.jsx("div",{className:"p-3 bg-green-100 border border-green-200 rounded-lg mt-4",children:n.jsxs("p",{className:"text-sm text-green-800 flex items-center gap-2",children:[n.jsx(Ds,{className:"w-4 h-4"}),"All crew members have acknowledged the operations plan."]})})]})]})]}),(h.submittedDate||h.reviewDate)&&n.jsxs("div",{className:"card bg-gray-50",children:[n.jsxs("h3",{className:"font-medium text-gray-700 mb-3 flex items-center gap-2",children:[n.jsx(Wu,{className:"w-4 h-4"}),"Approval Timeline"]}),n.jsxs("div",{className:"space-y-2 text-sm",children:[h.submittedDate&&n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("div",{className:"w-2 h-2 rounded-full bg-blue-500"}),n.jsxs("span",{className:"text-gray-600",children:["Submitted by ",h.submittedBy||"Unknown"," on ",h.submittedDate]})]}),h.reviewDate&&n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("div",{className:`w-2 h-2 rounded-full ${h.status==="approved"?"bg-green-500":h.status==="conditional"?"bg-amber-500":h.status==="rejected"?"bg-red-500":"bg-gray-500"}`}),n.jsxs("span",{className:"text-gray-600",children:[h.status==="rejected"?"Changes requested":"Approved"," by ",((Ve=h.reviewer)==null?void 0:Ve.name)||"Unknown"," on ",h.reviewDate]})]}),(h.crewAcknowledgments||[]).map((ie,ze)=>n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("div",{className:"w-2 h-2 rounded-full bg-green-400"}),n.jsxs("span",{className:"text-gray-600",children:[ie.name," acknowledged on ",ie.date]})]},ze))]})]}),n.jsx("div",{className:"card bg-blue-50 border-blue-200",children:n.jsxs("div",{className:"flex gap-3",children:[n.jsx(Ns,{className:"w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"}),n.jsxs("div",{children:[n.jsx("h3",{className:"font-medium text-blue-900",children:"Approval Workflow"}),n.jsx("p",{className:"text-sm text-blue-700 mt-1",children:"Operations plans must be reviewed and approved before field operations. Once approved, the plan is locked to prevent changes. All crew members should acknowledge review before the tailgate briefing."})]})]})})]})}const Oae="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js",Lae="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js";let q3=!1,Ww=null;function $3(t){return new Promise((e,r)=>{if(document.querySelector(`script[src="${t}"]`)){e();return}const c=document.createElement("script");c.src=t,c.async=!0,c.onload=e,c.onerror=()=>r(new Error(`Failed to load ${t}`)),document.head.appendChild(c)})}async function Fae(){return q3&&window.jspdf?window.jspdf.jsPDF:Ww||(Ww=(async()=>(await $3(Oae),await $3(Lae),q3=!0,window.jspdf.jsPDF))(),Ww)}const zae={operator:{name:"Aeria Solutions Ltd.",registration:"Transport Canada Operator #930355",tagline:"Professional RPAS Operations",website:"www.aeriasolutions.ca",email:"ops@aeriasolutions.ca",phone:"",address:"",logo:null,colors:{primary:"#1e3a5f",secondary:"#3b82f6",accent:"#10b981",light:"#e0f2fe",text:"#1f2937",textLight:"#6b7280"}},client:null};class Jd{constructor(e={}){this.options=e,this.doc=null,this.initialized=!1,this.branding={...zae,...e.branding},this.clientBranding=e.clientBranding||null,this.pageWidth=215.9,this.pageHeight=279.4,this.margin=e.margin||20,this.contentWidth=this.pageWidth-this.margin*2,this.currentY=this.margin,this.pageNumber=1,this.title=e.title||"Document",this.subtitle=e.subtitle||"",this.projectName=e.projectName||"",this.projectCode=e.projectCode||"",this.clientName=e.clientName||"",this.generatedDate=new Date().toLocaleDateString("en-CA"),this.tocEntries=[],this.tocPageNumber=2}async init(){if(this.initialized)return this;const e=await Fae();return this.doc=new e({orientation:"portrait",unit:"mm",format:"letter"}),this.initialized=!0,this}hexToRgb(e){const r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:{r:0,g:0,b:0}}setColor(e){const r=this.branding.operator.colors[e]||e,{r:c,g:h,b:x}=this.hexToRgb(r);return this.doc.setTextColor(c,h,x),this}setFillColor(e){const r=this.branding.operator.colors[e]||e,{r:c,g:h,b:x}=this.hexToRgb(r);return this.doc.setFillColor(c,h,x),this}setDrawColor(e){const r=this.branding.operator.colors[e]||e,{r:c,g:h,b:x}=this.hexToRgb(r);return this.doc.setDrawColor(c,h,x),this}addCoverPage(){var w,o,C,R;this.setFillColor("primary"),this.doc.rect(0,0,this.pageWidth,80,"F"),this.setFillColor("secondary"),this.doc.rect(0,80,this.pageWidth,4,"F"),this.doc.setTextColor(255,255,255),this.doc.setFontSize(18),this.doc.setFont("helvetica","bold"),this.doc.text(this.branding.operator.name,this.margin,25),this.doc.setFontSize(9),this.doc.setFont("helvetica","normal"),this.doc.setTextColor(200,220,255);const e=this.branding.operator.registration,r=this.doc.getTextWidth(e);this.doc.text(e,this.pageWidth-this.margin-r,25),this.doc.setFontSize(28),this.doc.setFont("helvetica","bold"),this.doc.setTextColor(255,255,255),this.doc.text(this.title,this.margin,50),this.subtitle&&(this.doc.setFontSize(12),this.doc.setFont("helvetica","normal"),this.doc.text(this.subtitle,this.margin,65));let c=100;if((w=this.clientBranding)!=null&&w.logo||(o=this.clientBranding)!=null&&o.name||this.clientName){if(this.setFillColor("light"),this.doc.roundedRect(this.margin,95,this.contentWidth,35,3,3,"F"),this.setColor("textLight"),this.doc.setFontSize(8),this.doc.text("PREPARED FOR",this.margin+10,103),this.setColor("text"),this.doc.setFontSize(14),this.doc.setFont("helvetica","bold"),this.doc.text(this.clientName||((C=this.clientBranding)==null?void 0:C.name)||"Client",this.margin+10,116),(R=this.clientBranding)!=null&&R.logo)try{this.doc.addImage(this.clientBranding.logo,"PNG",this.pageWidth-this.margin-45,100,35,25)}catch(F){console.warn("Client logo error:",F)}c=140}this.setFillColor("light"),this.doc.roundedRect(this.margin,c,this.contentWidth,55,3,3,"F"),this.setColor("text"),this.doc.setFontSize(11),this.doc.setFont("helvetica","bold"),this.doc.text("PROJECT DETAILS",this.margin+10,c+12),this.doc.setFont("helvetica","normal"),this.doc.setFontSize(10);const h=[{label:"Project:",value:this.projectName},{label:"Code:",value:this.projectCode},{label:"Client:",value:this.clientName||"N/A"},{label:"Generated:",value:this.generatedDate}],x=this.contentWidth/2;return h.forEach((F,$)=>{const Y=$%2,H=Math.floor($/2),X=this.margin+10+Y*x,he=c+25+H*12;this.doc.setFont("helvetica","bold"),this.setColor("text"),this.doc.text(F.label,X,he),this.doc.setFont("helvetica","normal"),this.setColor("textLight"),this.doc.text(F.value||"N/A",X+25,he)}),this.setColor("textLight"),this.doc.setFontSize(8),this.doc.text(this.branding.operator.name,this.margin,this.pageHeight-30),this.branding.operator.website&&this.doc.text(this.branding.operator.website,this.margin,this.pageHeight-25),this.doc.setFontSize(7),this.doc.text("This document contains confidential operational information.",this.margin,this.pageHeight-10),this}addTableOfContents(){return this.doc.addPage(),this.pageNumber++,this.setFillColor("primary"),this.doc.rect(0,0,this.pageWidth,15,"F"),this.doc.setTextColor(255,255,255),this.doc.setFontSize(10),this.doc.setFont("helvetica","bold"),this.doc.text("TABLE OF CONTENTS",this.margin,10),this.currentY=30,this.setColor("primary"),this.doc.setFontSize(16),this.doc.setFont("helvetica","bold"),this.doc.text("Contents",this.margin,this.currentY),this.currentY+=15,this.setDrawColor("secondary"),this.doc.setLineWidth(.5),this.doc.line(this.margin,this.currentY-5,this.pageWidth-this.margin,this.currentY-5),this.tocStartY=this.currentY,this}fillTableOfContents(){if(this.tocEntries.length===0)return this;this.doc.setPage(this.tocPageNumber);let e=this.tocStartY||45;return this.tocEntries.forEach((r,c)=>{if(e>this.pageHeight-30)return;this.setColor("text"),this.doc.setFontSize(r.level===1?11:9),this.doc.setFont("helvetica",r.level===1?"bold":"normal");const h=r.level===1?0:10,x=this.margin+h,w=this.pageWidth-this.margin-10,C=`${r.level===1?`${c+1}.`:""} ${r.title}`;this.doc.text(C,x,e);const R=String(r.page),F=this.doc.getTextWidth(R);this.setColor("textLight"),this.doc.text(R,w+10-F,e),e+=r.level===1?8:6}),this}addHeader(){if(this.setFillColor("primary"),this.doc.rect(0,0,this.pageWidth,15,"F"),this.doc.setTextColor(255,255,255),this.doc.setFontSize(9),this.doc.setFont("helvetica","bold"),this.doc.text(this.title,this.margin,10),this.projectCode){const e=this.doc.getTextWidth(this.projectCode);this.doc.setFont("helvetica","normal"),this.doc.text(this.projectCode,(this.pageWidth-e)/2,10)}if(this.branding.operator.logo)try{const c=this.pageWidth-this.margin-25;this.doc.addImage(this.branding.operator.logo,"PNG",c,2.5,25,10)}catch(e){console.warn("Header logo error:",e);const r=this.branding.operator.name.split(" ")[0]||"",c=this.doc.getTextWidth(r);this.doc.setFont("helvetica","normal"),this.doc.text(r,this.pageWidth-this.margin-c,10)}else{const e=this.branding.operator.name.split(" ")[0]||"",r=this.doc.getTextWidth(e);this.doc.setFont("helvetica","normal"),this.doc.text(e,this.pageWidth-this.margin-r,10)}return this.currentY=25,this}addFooter(e,r){var o;const c=this.pageHeight-10;this.setDrawColor("primary"),this.doc.setLineWidth(.3),this.doc.line(this.margin,c-5,this.pageWidth-this.margin,c-5),this.setColor("textLight"),this.doc.setFontSize(8),this.doc.setFont("helvetica","normal"),this.doc.text(this.branding.operator.name,this.margin,c);const h=this.doc.getTextWidth(this.generatedDate);this.doc.text(this.generatedDate,(this.pageWidth-h)/2,c);const x=`Page ${e} of ${r}`,w=this.doc.getTextWidth(x);if((o=this.clientBranding)!=null&&o.logo)try{const F=this.pageWidth-this.margin-20,$=c-12;this.doc.addImage(this.clientBranding.logo,"PNG",F,$,20,8),this.doc.text(x,F-w-5,c)}catch(C){console.warn("Footer client logo error:",C),this.doc.text(x,this.pageWidth-this.margin-w,c)}else this.doc.text(x,this.pageWidth-this.margin-w,c);return this}addNewSection(e,r=1){return r===1&&(this.doc.addPage(),this.pageNumber++,this.addHeader()),this.tocEntries.push({title:e,page:this.pageNumber,level:r}),r===1?this.addSectionTitle(e):this.addSubsectionTitle(e),this}addNewPage(){return this.doc.addPage(),this.pageNumber++,this.addHeader(),this}checkNewPage(e=30){return this.currentY+e>this.pageHeight-25?(this.addNewPage(),!0):!1}checkPageBreak(e=30){return this.checkNewPage(e)}addSectionTitle(e){return this.checkNewPage(20),this.setFillColor("primary"),this.doc.roundedRect(this.margin,this.currentY,this.contentWidth,10,2,2,"F"),this.doc.setTextColor(255,255,255),this.doc.setFontSize(11),this.doc.setFont("helvetica","bold"),this.doc.text(e.toUpperCase(),this.margin+5,this.currentY+7),this.currentY+=18,this}addSubsectionTitle(e){this.checkNewPage(15),this.setColor("secondary"),this.doc.setFontSize(10),this.doc.setFont("helvetica","bold"),this.doc.text(e,this.margin,this.currentY),this.setDrawColor("secondary"),this.doc.setLineWidth(.3);const r=this.doc.getTextWidth(e);return this.doc.line(this.margin,this.currentY+1,this.margin+r,this.currentY+1),this.currentY+=10,this}addParagraph(e,r={}){if(!e)return this;this.setColor(r.color||"text"),this.doc.setFontSize(r.fontSize||9),this.doc.setFont("helvetica",r.bold?"bold":"normal");const c=this.doc.splitTextToSize(e,this.contentWidth),h=(r.fontSize||9)*.4;return c.forEach(x=>{this.checkNewPage(h+2),this.doc.text(x,this.margin,this.currentY),this.currentY+=h}),this.currentY+=4,this}addSpacer(e=5){return this.currentY+=e,this}addLabelValue(e,r){if(!r)return this;this.checkNewPage(8),this.setColor("textLight"),this.doc.setFontSize(8),this.doc.setFont("helvetica","bold"),this.doc.text(e+":",this.margin,this.currentY),this.setColor("text"),this.doc.setFont("helvetica","normal");const c=this.doc.getTextWidth(e+": ");return this.doc.text(String(r),this.margin+c,this.currentY),this.currentY+=6,this}addKeyValuePairs(e=[]){return e.forEach(([r,c])=>{this.addLabelValue(r,c)}),this}addKeyValueGrid(e=[],r=2){this.checkNewPage(20);const c=this.contentWidth/r;return e.forEach((h,x)=>{const w=x%r,o=this.margin+w*c;w===0&&x>0&&(this.currentY+=8),this.setColor("textLight"),this.doc.setFontSize(7),this.doc.setFont("helvetica","normal"),this.doc.text((h.label||"").toUpperCase(),o,this.currentY),this.setColor("text"),this.doc.setFontSize(9),this.doc.setFont("helvetica","bold"),this.doc.text(String(h.value||"N/A"),o,this.currentY+4)}),this.currentY+=15,this}addTable(e=[],r=[],c={}){if(r.length===0)return this;this.checkNewPage(30);const h=this.branding.operator.colors,x=this.hexToRgb(h.primary);return this.doc.autoTable({startY:this.currentY,head:[e],body:r,margin:{left:this.margin,right:this.margin},styles:{font:"helvetica",fontSize:8,cellPadding:2},headStyles:{fillColor:[x.r,x.g,x.b],textColor:[255,255,255],fontStyle:"bold"},alternateRowStyles:{fillColor:[249,250,251]},...c}),this.currentY=this.doc.lastAutoTable.finalY+10,this}addInfoBox(e,r,c="info"){this.checkNewPage(25);const h={info:"#e0f2fe",warning:"#fef3c7",success:"#d1fae5",danger:"#fee2e2"},x={info:"#0ea5e9",warning:"#f59e0b",success:"#10b981",danger:"#ef4444"};this.setFillColor(h[c]||h.info),this.doc.roundedRect(this.margin,this.currentY,this.contentWidth,20,2,2,"F"),this.setDrawColor(x[c]||x.info),this.doc.setLineWidth(.5),this.doc.line(this.margin,this.currentY,this.margin,this.currentY+20),this.setColor("text"),this.doc.setFontSize(9),this.doc.setFont("helvetica","bold"),this.doc.text(e,this.margin+5,this.currentY+7),this.doc.setFont("helvetica","normal"),this.doc.setFontSize(8);const w=this.doc.splitTextToSize(r,this.contentWidth-10);return this.doc.text(w[0]||"",this.margin+5,this.currentY+14),this.currentY+=28,this}addKPIRow(e=[]){this.checkNewPage(30);const r=this.contentWidth/e.length;return this.setFillColor("light"),this.doc.roundedRect(this.margin,this.currentY,this.contentWidth,25,2,2,"F"),e.forEach((c,h)=>{const x=this.margin+h*r+r/2;this.setColor("text"),this.doc.setFontSize(14),this.doc.setFont("helvetica","bold");const w=String(c.value),o=this.doc.getTextWidth(w);this.doc.text(w,x-o/2,this.currentY+12),this.setColor("textLight"),this.doc.setFontSize(7),this.doc.setFont("helvetica","normal");const C=this.doc.getTextWidth(c.label);this.doc.text(c.label.toUpperCase(),x-C/2,this.currentY+20)}),this.currentY+=32,this}addSignatureBlock(e=[]){return this.checkNewPage(50),this.addSubsectionTitle("Signatures & Approvals"),this.currentY+=5,e.forEach(r=>{this.checkNewPage(30),this.setDrawColor("textLight"),this.doc.setLineWidth(.3),this.doc.line(this.margin,this.currentY+12,this.margin+65,this.currentY+12),this.setColor("text"),this.doc.setFontSize(8),this.doc.setFont("helvetica","normal"),this.doc.text(r.role||"Signature",this.margin,this.currentY+17),this.doc.line(this.margin+85,this.currentY+12,this.margin+130,this.currentY+12),this.doc.text("Date",this.margin+85,this.currentY+17),r.name&&(this.setColor("textLight"),this.doc.setFontSize(7),this.doc.text(`(${r.name})`,this.margin,this.currentY+22)),this.currentY+=30}),this}finalize(){this.tocEntries.length>0&&this.fillTableOfContents();const e=this.doc.internal.getNumberOfPages();for(let r=2;r<=e;r++)this.doc.setPage(r),this.addFooter(r-1,e-1);return this.doc.setProperties({title:this.title,subject:this.subtitle,author:this.branding.operator.name,creator:"Aeria Ops"}),this}save(e){return this.finalize(),this.doc.save(e),e}getBlob(){return this.finalize(),this.doc.output("blob")}getDataUrl(){return this.finalize(),this.doc.output("dataurlstring")}}async function wI(t,e=null,r=null){var h,x,w,o,C,R,F,$,Y,H,X,he,se,de,K,ge,Ae,Te;const c=new Jd({title:"RPAS Operations Plan",subtitle:(t==null?void 0:t.name)||"Operations Plan",projectName:(t==null?void 0:t.name)||"",projectCode:(t==null?void 0:t.projectCode)||"",clientName:(t==null?void 0:t.clientName)||"",branding:e,clientBranding:r});if(await c.init(),c.addCoverPage(),c.addTableOfContents(),c.addNewSection("Executive Summary"),c.addParagraph(`This RPAS Operations Plan details the planned flight operations for ${(t==null?void 0:t.name)||"this project"}. It includes site assessment, flight parameters, risk mitigations, and emergency procedures.`),((h=t==null?void 0:t.overview)!=null&&h.description||t!=null&&t.description)&&(c.addSubsectionTitle("Project Description"),c.addParagraph(((x=t==null?void 0:t.overview)==null?void 0:x.description)||(t==null?void 0:t.description))),c.addKeyValueGrid([{label:"Project Code",value:t==null?void 0:t.projectCode},{label:"Client",value:t==null?void 0:t.clientName},{label:"Location",value:((w=t==null?void 0:t.overview)==null?void 0:w.location)||((C=(o=t==null?void 0:t.siteSurvey)==null?void 0:o.location)==null?void 0:C.description)||((F=(R=t==null?void 0:t.siteSurvey)==null?void 0:R.location)==null?void 0:F.name)},{label:"Status",value:t==null?void 0:t.status}]),t!=null&&t.siteSurvey){c.addNewSection("Site Survey");const Ce=t.siteSurvey;if(Ce.location&&(c.addSubsectionTitle("Location Details"),c.addKeyValueGrid([{label:"Coordinates",value:Ce.location.lat&&Ce.location.lng?`${Ce.location.lat}, ${Ce.location.lng}`:Ce.location.coordinates?`${Ce.location.coordinates.lat}, ${Ce.location.coordinates.lng}`:"Not set"},{label:"Address",value:Ce.location.description||Ce.location.address},{label:"Site Name",value:Ce.location.name},{label:"Access Type",value:($=Ce.access)!=null&&$.type||(Y=Ce.access)!=null&&Y.vehicleAccess?"Vehicle":"Foot"}])),((H=Ce.obstacles)==null?void 0:H.length)>0){c.addSubsectionTitle("Identified Obstacles");const ne=Ce.obstacles.map(ae=>[ae.type||"Unknown",ae.description||"",ae.height?`${ae.height}m`:"N/A",ae.distance?`${ae.distance}m`:"N/A"]);c.addTable(["Type","Description","Height","Distance"],ne)}}if(t!=null&&t.flightPlan){c.addNewSection("Flight Plan");const Ce=t.flightPlan;c.addSubsectionTitle("Flight Parameters"),c.addKeyValueGrid([{label:"Aircraft",value:((he=(X=Ce.aircraft)==null?void 0:X[0])==null?void 0:he.nickname)||((se=Ce.aircraft)==null?void 0:se.name)||Ce.aircraftId},{label:"Operation Type",value:Ce.operationType},{label:"Max Altitude",value:Ce.maxAltitudeAGL?`${Ce.maxAltitudeAGL}m AGL`:Ce.maxAltitude?`${Ce.maxAltitude}m AGL`:"N/A"},{label:"Flight Area",value:Ce.flightAreaType||Ce.flightArea||"N/A"}])}if(t!=null&&t.hseRiskAssessment||t!=null&&t.hseRisk){c.addNewSection("HSE Risk Assessment");const Ce=(t==null?void 0:t.hseRiskAssessment)||(t==null?void 0:t.hseRisk);if(((de=Ce==null?void 0:Ce.hazards)==null?void 0:de.length)>0){c.addSubsectionTitle("Identified Hazards");const ne=Ce.hazards.map(ae=>{var q,oe;return[ae.category||"General",ae.description||"",((q=ae.riskLevel)==null?void 0:q.toUpperCase())||`${ae.likelihood||"?"}x${ae.severity||"?"}`,((oe=ae.residualRisk)==null?void 0:oe.toUpperCase())||`${ae.residualLikelihood||"?"}x${ae.residualSeverity||"?"}`]});c.addTable(["Category","Hazard","Initial Risk","Residual Risk"],ne)}}if(t!=null&&t.emergencyPlan||t!=null&&t.emergency){c.addNewSection("Emergency Procedures");const Ce=(t==null?void 0:t.emergencyPlan)||(t==null?void 0:t.emergency);if((Ce!=null&&Ce.primaryEmergencyContact||Ce!=null&&Ce.musterPoint)&&(c.addLabelValue("Muster Point",Ce.musterPoint||Ce.rallyPoint),c.addLabelValue("Emergency Contact",(K=Ce.primaryEmergencyContact)==null?void 0:K.name),c.addLabelValue("Contact Phone",(ge=Ce.primaryEmergencyContact)==null?void 0:ge.phone),c.addLabelValue("Nearest Hospital",Ce.nearestHospital)),((Ae=Ce==null?void 0:Ce.contacts)==null?void 0:Ae.length)>0){c.addSubsectionTitle("Emergency Contacts");const ne=Ce.contacts.map(ae=>[ae.name||"",ae.role||"",ae.phone||""]);c.addTable(["Name","Role","Phone"],ne)}}if(((Te=t==null?void 0:t.crew)==null?void 0:Te.length)>0){c.addNewSection("Crew Roster");const Ce=t.crew.map(ne=>{var ae,q;return[ne.name||`${ne.firstName||""} ${ne.lastName||""}`.trim(),ne.role||"",((q=(ae=ne.certifications)==null?void 0:ae.join)==null?void 0:q.call(ae,", "))||ne.certifications||"N/A"]});c.addTable(["Name","Role","Certifications"],Ce)}return c.addNewSection("Approvals"),c.addSignatureBlock([{role:"Pilot in Command (PIC)",name:""},{role:"Operations Manager",name:""},{role:"Client Representative",name:""}]),c}async function RU(t,e,r=null){const c=new Jd({title:"SORA Risk Assessment",subtitle:"JARUS SORA 2.5 Methodology",projectName:(t==null?void 0:t.name)||"",projectCode:(t==null?void 0:t.projectCode)||"",clientName:(t==null?void 0:t.clientName)||"",branding:r});return await c.init(),c.addCoverPage(),c.addTableOfContents(),c.addNewSection("Assessment Summary"),c.addInfoBox("SAIL Level Determination",`Based on the assessment, this operation has been assigned SAIL Level ${(e==null?void 0:e.sailLevel)||(e==null?void 0:e.sail)||"N/A"}`,"info"),c.addKPIRow([{label:"Initial GRC",value:(e==null?void 0:e.initialGRC)||(e==null?void 0:e.intrinsicGRC)||"N/A"},{label:"Final GRC",value:(e==null?void 0:e.finalGRC)||"N/A"},{label:"Air Risk Class",value:(e==null?void 0:e.airRiskClass)||(e==null?void 0:e.residualARC)||"N/A"},{label:"SAIL Level",value:(e==null?void 0:e.sailLevel)||(e==null?void 0:e.sail)||"N/A"}]),c.addNewSection("Ground Risk Assessment"),c.addSubsectionTitle("Intrinsic Ground Risk Class (iGRC)"),c.addParagraph("The initial ground risk is determined by the characteristic UA dimension and the population density of the operational area."),c.addNewSection("Ground Risk Mitigations"),c.addParagraph("Ground risk mitigations reduce the final GRC based on operational measures."),c.addNewSection("Air Risk Assessment"),c.addSubsectionTitle("Air Risk Class (ARC)"),c.addParagraph("The air risk class is determined by the airspace classification and the type of operation."),c.addNewSection("Assessment Approval"),c.addSignatureBlock([{role:"Assessor"},{role:"Reviewer"}]),c}async function kU(t,e=null){const r=new Jd({title:"HSE Risk Assessment",subtitle:"Workplace Hazard Analysis",projectName:(t==null?void 0:t.name)||"",projectCode:(t==null?void 0:t.projectCode)||"",clientName:(t==null?void 0:t.clientName)||"",branding:e});await r.init(),r.addCoverPage(),r.addTableOfContents();const c=(t==null?void 0:t.hseRiskAssessment)||(t==null?void 0:t.hseRisk)||{};r.addNewSection("Assessment Summary");const h=c.hazards||[],x=h.filter(C=>C.riskLevel==="high"||C.riskLevel==="extreme"||C.likelihood*C.severity>=15).length,w=h.filter(C=>C.riskLevel==="medium"||C.likelihood*C.severity>=8&&C.likelihood*C.severity<15).length,o=h.filter(C=>C.riskLevel==="low"||C.likelihood*C.severity<8).length;return r.addKPIRow([{label:"Total Hazards",value:h.length||0},{label:"High/Extreme Risk",value:x},{label:"Medium Risk",value:w},{label:"Low Risk",value:o}]),r.addNewSection("Hazard Register"),h.length>0?h.forEach((C,R)=>{var F,$;if(r.checkNewPage(40),r.addSubsectionTitle(`${R+1}. ${C.description||"Hazard"}`),r.addKeyValueGrid([{label:"Category",value:C.category},{label:"Initial Risk",value:((F=C.riskLevel)==null?void 0:F.toUpperCase())||`L${C.likelihood} x S${C.severity}`},{label:"Residual Risk",value:(($=C.residualRisk)==null?void 0:$.toUpperCase())||`L${C.residualLikelihood} x S${C.residualSeverity}`}]),C.controls){const Y=Array.isArray(C.controls)?C.controls.join("; "):C.controls;r.addParagraph("Controls: "+Y,{fontSize:8})}r.addSpacer(5)}):r.addParagraph("No hazards identified."),r.addNewSection("Approvals"),r.addSignatureBlock([{role:"Assessor"},{role:"Reviewer"}]),r}async function DU(t,e,r,c=[],h=null,x=null){var C,R,F,$,Y;const w=new Jd({title:(e==null?void 0:e.name)||"Form",subtitle:((R=(C=t.data)==null?void 0:C.header)==null?void 0:R.form_id)||t.id,projectName:(r==null?void 0:r.name)||"",projectCode:(r==null?void 0:r.projectCode)||"",clientName:(r==null?void 0:r.clientName)||"",branding:h,clientBranding:x});await w.init(),w.addCoverPage(),w.addNewPage(),w.addSectionTitle("Form Information"),w.addKeyValuePairs([["Form Type",e==null?void 0:e.name],["Form ID",(($=(F=t.data)==null?void 0:F.header)==null?void 0:$.form_id)||t.id],["Status",t.status==="completed"?"Completed":"Draft"],["Created",t.createdAt?new Date(t.createdAt.toDate?t.createdAt.toDate():t.createdAt).toLocaleString():"N/A"],["Completed",t.completedAt?new Date(t.completedAt.toDate?t.completedAt.toDate():t.completedAt).toLocaleString():"Not completed"]]);const o=Array.isArray(e==null?void 0:e.sections)?e.sections:[];for(const H of o){if(!H||H.type==="trigger_checklist")continue;w.checkNewPage(40),w.addSubsectionTitle(H.title||"Section");const X=(Y=t.data)==null?void 0:Y[H.id];if(X&&typeof X=="object"&&!Array.isArray(X)){const he=[];(H.fields||[]).forEach(se=>{const de=X[se.id];de!=null&&de!==""&&he.push([se.label,String(de)])}),he.length>0&&w.addKeyValuePairs(he)}}return w}async function Bae(t,e,r,c=[],h=null,x=null){var F,$;const w=await DU(t,e,r,c,h,x),o=(e==null?void 0:e.id)||"form",C=(($=(F=t.data)==null?void 0:F.header)==null?void 0:$.form_id)||t.id,R=`${o}_${C}_${new Date().toISOString().split("T")[0]}.pdf`;return w.save(R),R}const Vae=Object.freeze(Object.defineProperty({__proto__:null,BrandedPDF:Jd,exportFormToPDF:Bae,generateFormPDF:DU,generateHSERiskPDF:kU,generateOperationsPlanPDF:wI,generateSORAPDF:RU},Symbol.toStringTag,{value:"Module"})),LC=t=>({date:t||new Date().toISOString().split("T")[0],generatedAt:null,customNotes:"",weatherBriefing:"",weatherData:{temperature:"",windSpeed:"",windDirection:"",visibility:"",conditions:"",ceiling:""},checklistCompleted:{siteSecured:!1,equipmentChecked:!1,crewBriefed:!1,commsVerified:!1,emergencyReviewed:!1,notamsChecked:!1,weatherConfirmed:!1,riskReviewed:!1,clientNotified:!1,ppeConfirmed:!1},crewAttendance:{},briefingStartTime:"",briefingEndTime:"",goNoGoDecision:null,goNoGoNotes:"",flightLogs:[]});function Uae({project:t,onUpdate:e}){var mi,ht,hi,ni,ui,Fi,Ii,Bi,Ki,$r,nn,Gn,Tr;const[r,c]=ue.useState(!1),[h,x]=ue.useState(!1),[w,o]=ue.useState(0),[C,R]=ue.useState({briefing:!0,checklist:!0,attendance:!0,weather:!0});ue.useEffect(()=>{if(t.tailgate){if(!t.tailgate.days){const jt=t.tailgate;e({tailgate:{days:[{date:t.startDate||new Date().toISOString().split("T")[0],generatedAt:jt.generatedAt,customNotes:jt.customNotes||"",weatherBriefing:jt.weatherBriefing||"",weatherData:jt.weatherData||{},checklistCompleted:jt.checklistCompleted||{},crewAttendance:jt.crewAttendance||{},briefingStartTime:jt.briefingStartTime||"",briefingEndTime:jt.briefingEndTime||"",goNoGoDecision:jt.goNoGoDecision,goNoGoNotes:jt.goNoGoNotes||"",flightLogs:jt.flightLogs||[]}],isMultiDay:!1}})}}else{const jt=t.startDate||new Date().toISOString().split("T")[0];e({tailgate:{days:[LC(jt)],isMultiDay:!1}})}},[t.tailgate]);const F=t.tailgate||{days:[]},$=F.days||[],Y=$[w]||LC(),H=F.isMultiDay||$.length>1,X=jt=>{e({tailgate:{...F,...jt}})},he=jt=>{const bi=[...$];bi[w]={...Y,...jt},X({days:bi})},se=(jt,bi)=>{he({checklistCompleted:{...Y.checklistCompleted||{},[jt]:bi}})},de=(jt,bi)=>{he({crewAttendance:{...Y.crewAttendance||{},[jt]:{attended:bi,timestamp:bi?new Date().toISOString():null}}})},K=(jt,bi)=>{he({weatherData:{...Y.weatherData||{},[jt]:bi}})},ge=()=>{const jt=$[$.length-1],bi=jt!=null&&jt.date?new Date(jt.date):new Date;bi.setDate(bi.getDate()+1);const ar=bi.toISOString().split("T")[0];X({days:[...$,LC(ar)],isMultiDay:!0}),o($.length)},Ae=jt=>{if($.length<=1)return;const bi=$.filter((ar,li)=>li!==jt);X({days:bi,isMultiDay:bi.length>1}),w>=bi.length&&o(bi.length-1)},Te=jt=>{R(bi=>({...bi,[jt]:!bi[jt]}))},Ce=()=>{he({generatedAt:new Date().toISOString(),briefingStartTime:new Date().toLocaleTimeString("en-CA",{hour:"2-digit",minute:"2-digit"})})},ne=t.crew||[],ae=ne.find(jt=>jt.role==="PIC"),q=jt=>jt?new Date(jt+"T12:00:00").toLocaleDateString("en-CA",{weekday:"long",year:"numeric",month:"long",day:"numeric"}):"Not set",oe=jt=>jt?new Date(jt+"T12:00:00").toLocaleDateString("en-CA",{weekday:"short",month:"short",day:"numeric"}):"Day",ke=()=>{var ar,li,ai;const jt=t.ppe||{},bi=[];if(((ar=jt.selectedItems)==null?void 0:ar.length)>0){const Jt={hi_vis_vest:"High-Visibility Vest",safety_boots:"Safety Boots (CSA)",hard_hat:"Hard Hat",safety_glasses:"Safety Glasses",ear_plugs:"Hearing Protection",work_gloves:"Work Gloves",sunscreen:"Sunscreen",winter_jacket:"Winter Jacket",rain_gear:"Rain Gear"};jt.selectedItems.forEach(Vi=>{Jt[Vi]?bi.push(Jt[Vi]):bi.push(Vi.replace(/_/g," "))})}return((li=jt.customItems)==null?void 0:li.length)>0&&jt.customItems.forEach(Jt=>bi.push(Jt.item)),((ai=jt.items)==null?void 0:ai.length)>0&&bi.length===0&&jt.items.forEach(Jt=>bi.push(Jt.item||Jt.name||Jt)),bi.length===0?["Safety Vest","Safety Boots","Safety Glasses (as required)"]:bi},Ve=()=>{var bi,ar;return(((bi=t.hseRiskAssessment)==null?void 0:bi.hazards)||((ar=t.riskAssessment)==null?void 0:ar.hazards)||[]).slice(0,6)},ie=()=>{const jt=ze();navigator.clipboard.writeText(jt),c(!0),setTimeout(()=>c(!1),2e3)},ze=()=>{var ai,Jt,Vi,fi,vi,Pi,Nr,er;const jt=ke(),bi=Ve(),ar=Y.weatherData||{};return[`PRE-DEPLOYMENT BRIEFING - ${t.name||"Untitled Project"}`,"".repeat(50),`Date: ${q(Y.date)}`,H?`Day ${w+1} of ${$.length}`:"",`Project Code: ${t.projectCode||"N/A"}`,`Client: ${t.clientName||"N/A"}`,""," CREW ",...ne.map(Wr=>` ${Wr.role}: ${Wr.name}${Wr.phone?` (${Wr.phone})`:""}`),""," WEATHER ",ar.temperature?`Temperature: ${ar.temperature}`:"",ar.windSpeed?`Wind: ${ar.windSpeed} ${ar.windDirection||""}`:"",ar.visibility?`Visibility: ${ar.visibility}`:"",ar.conditions?`Conditions: ${ar.conditions}`:"",Y.weatherBriefing||"",""," OPERATION OVERVIEW ",`Description: ${t.description||"No description"}`,`Operation Type: ${((ai=t.flightPlan)==null?void 0:ai.operationType)||"Standard"}`,`Max Altitude: ${((Jt=t.flightPlan)==null?void 0:Jt.maxAltitudeAGL)||"N/A"} m AGL`,""," KEY HAZARDS & CONTROLS ",...bi.length>0?bi.map(Wr=>` ${Wr.description||"Unnamed"}
   ${Wr.controls||"None"}`):["No hazards documented"],""," PPE REQUIREMENTS ",...jt.map(Wr=>` ${Wr}`),""," EMERGENCY ",`Contact: ${((fi=(Vi=t.emergencyPlan)==null?void 0:Vi.primaryEmergencyContact)==null?void 0:fi.name)||"Not set"} - ${((Pi=(vi=t.emergencyPlan)==null?void 0:vi.primaryEmergencyContact)==null?void 0:Pi.phone)||"N/A"}`,`Hospital: ${((Nr=t.emergencyPlan)==null?void 0:Nr.nearestHospital)||"Not set"}`,`Rally Point: ${((er=t.emergencyPlan)==null?void 0:er.rallyPoint)||"Not set"}`,"",Y.customNotes?` NOTES 
${Y.customNotes}`:"","","".repeat(50),`Generated: ${new Date().toLocaleString()}`,`Decision: ${Y.goNoGoDecision===!0?"GO":Y.goNoGoDecision===!1?"NO-GO":"Pending"}`].filter(Wr=>Wr!=="").join(`
`)},ve=async()=>{x(!0);try{const jt=new Jd({title:`Pre-Deployment Briefing${H?` - Day ${w+1}`:""}`,subtitle:"Tailgate Safety Meeting",projectName:t.name,projectCode:t.projectCode,clientName:t.clientName});await jt.init(),jt.addCoverPage(),jt.addNewPage(),jt.addSectionTitle("Operation Details"),jt.addKeyValueGrid([{label:"Project",value:t.name},{label:"Date",value:q(Y.date)},{label:"Day",value:H?`${w+1} of ${$.length}`:"1"},{label:"Briefing Time",value:Y.briefingStartTime||"Not recorded"}]);const bi=Y.weatherData||{};if((bi.temperature||bi.windSpeed||Y.weatherBriefing)&&(jt.addSectionTitle("Weather Conditions"),jt.addKeyValueGrid([{label:"Temperature",value:bi.temperature||"N/A"},{label:"Wind",value:bi.windSpeed?`${bi.windSpeed} ${bi.windDirection||""}`:"N/A"},{label:"Visibility",value:bi.visibility||"N/A"},{label:"Conditions",value:bi.conditions||"N/A"}]),Y.weatherBriefing&&jt.addParagraph(Y.weatherBriefing)),ne.length>0){jt.addSectionTitle("Crew Roster");const ai=ne.map(Jt=>{var Vi,fi;return[Jt.role||"N/A",Jt.name||"N/A",Jt.phone||"N/A",(fi=(Vi=Y.crewAttendance)==null?void 0:Vi[Jt.id||Jt.name])!=null&&fi.attended?" Present":" Absent"]});jt.addTable(["Role","Name","Phone","Attendance"],ai)}const ar=Ve();if(ar.length>0){jt.addSectionTitle("Key Hazards & Controls");const ai=ar.map((Jt,Vi)=>[String(Vi+1),Jt.description||"Unnamed",Jt.controls||"None documented"]);jt.addTable(["#","Hazard","Controls"],ai)}jt.addSectionTitle("Required PPE"),jt.addParagraph(ke().join("  ")),jt.addSectionTitle("Go/No-Go Decision"),jt.addLabelValue("Decision",Y.goNoGoDecision===!0?"GO":Y.goNoGoDecision===!1?"NO-GO":"Pending"),Y.goNoGoNotes&&jt.addParagraph(Y.goNoGoNotes),jt.addSectionTitle("Acknowledgment"),jt.addSignatureBlock([{role:"Pilot in Command",name:ae==null?void 0:ae.name},{role:"Crew Present",name:`${Object.values(Y.crewAttendance||{}).filter(ai=>ai==null?void 0:ai.attended).length} of ${ne.length}`}]);const li=`Tailgate_${t.projectCode||t.name||"briefing"}_Day${w+1}_${Y.date||"nodate"}.pdf`;jt.save(li)}catch(jt){console.error("PDF export failed:",jt),alert("Failed to export PDF. Please try again.")}finally{x(!1)}},Le=Y.checklistCompleted||{},Ke=Object.values(Le).filter(Boolean).length,Pe=10,It=Y.crewAttendance||{},tt=Object.values(It).filter(jt=>jt==null?void 0:jt.attended).length,zt=ne.length>0&&tt===ne.length,vt=Ke===Pe&&zt&&Y.goNoGoDecision===!0,Ot=ue.useMemo(()=>{let jt=0,bi=0,ar=0;return $.forEach(li=>{li.goNoGoDecision===!0?(bi++,jt++):li.goNoGoDecision===!1&&(ar++,jt++)}),{total:$.length,completed:jt,go:bi,noGo:ar}},[$]),Et=Ve(),yi=ke();return n.jsxs("div",{className:"space-y-6",children:[H&&n.jsxs("div",{className:"card bg-gradient-to-r from-blue-50 to-white",children:[n.jsxs("div",{className:"flex items-center justify-between mb-4",children:[n.jsxs("div",{children:[n.jsxs("h3",{className:"font-semibold text-gray-900 flex items-center gap-2",children:[n.jsx(il,{className:"w-5 h-5 text-blue-600"}),"Multi-Day Operation"]}),n.jsxs("p",{className:"text-sm text-gray-600",children:[Ot.go," GO / ",Ot.noGo," NO-GO / ",Ot.total-Ot.completed," Pending"]})]}),n.jsxs("button",{onClick:ge,className:"btn-secondary text-sm",children:[n.jsx(vr,{className:"w-4 h-4 mr-1"}),"Add Day"]})]}),n.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2",children:$.map((jt,bi)=>{const ar=jt.checklistCompleted||{},li=Object.values(ar).filter(Boolean).length,ai=jt.goNoGoDecision===!0,Jt=jt.goNoGoDecision===!1;return n.jsx("button",{onClick:()=>o(bi),className:`flex-shrink-0 px-4 py-2 rounded-lg border-2 transition-all ${bi===w?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,children:n.jsxs("div",{className:"text-center",children:[n.jsxs("p",{className:`text-xs font-medium ${bi===w?"text-blue-700":"text-gray-600"}`,children:["Day ",bi+1]}),n.jsx("p",{className:`text-sm ${bi===w?"text-blue-900":"text-gray-900"}`,children:oe(jt.date)}),n.jsxs("div",{className:"flex items-center justify-center gap-1 mt-1",children:[ai&&n.jsx(qr,{className:"w-4 h-4 text-green-500"}),Jt&&n.jsx(zl,{className:"w-4 h-4 text-red-500"}),!ai&&!Jt&&n.jsxs("span",{className:"text-xs text-gray-400",children:[li,"/10"]})]})]})},bi)})})]}),n.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[n.jsxs("div",{children:[n.jsxs("h2",{className:"text-lg font-semibold text-gray-900",children:[H?`Day ${w+1}: `:"","Pre-Deployment Briefing"]}),n.jsxs("p",{className:"text-sm text-gray-500",children:[q(Y.date),Y.generatedAt&&`  Generated ${new Date(Y.generatedAt).toLocaleTimeString()}`]})]}),n.jsxs("div",{className:"flex gap-2",children:[n.jsxs("button",{onClick:Ce,className:"btn-secondary inline-flex items-center gap-2",children:[n.jsx(eu,{className:"w-4 h-4"}),Y.generatedAt?"Refresh":"Generate"]}),n.jsxs("button",{onClick:ie,className:"btn-secondary inline-flex items-center gap-2",children:[r?n.jsx(ru,{className:"w-4 h-4"}):n.jsx(Op,{className:"w-4 h-4"}),r?"Copied!":"Copy"]}),n.jsxs("button",{onClick:ve,disabled:h,className:"btn-primary inline-flex items-center gap-2",children:[h?n.jsx(Ro,{className:"w-4 h-4 animate-spin"}):n.jsx(vc,{className:"w-4 h-4"}),h?"Exporting...":"PDF"]}),H&&$.length>1&&n.jsx("button",{onClick:()=>Ae(w),className:"btn-secondary text-red-600 hover:bg-red-50",title:"Remove this day",children:n.jsx(Ln,{className:"w-4 h-4"})})]})]}),n.jsx("div",{className:`p-4 rounded-lg border-2 ${vt?"bg-green-50 border-green-500":"bg-amber-50 border-amber-300"}`,children:n.jsxs("div",{className:"flex items-center gap-3",children:[vt?n.jsx(qr,{className:"w-8 h-8 text-green-600"}):n.jsx(ir,{className:"w-8 h-8 text-amber-600"}),n.jsxs("div",{children:[n.jsx("h3",{className:`font-semibold ${vt?"text-green-800":"text-amber-800"}`,children:vt?"Ready for Operations":"Pre-Flight Items Pending"}),n.jsxs("p",{className:`text-sm ${vt?"text-green-600":"text-amber-600"}`,children:["Checklist: ",Ke,"/",Pe,"  Crew: ",tt,"/",ne.length,"  Decision: ",Y.goNoGoDecision===!0?"GO":Y.goNoGoDecision===!1?"NO-GO":"Pending"]})]})]})}),n.jsxs("div",{className:"card",children:[n.jsx("label",{className:"label",children:"Operation Date"}),n.jsx("input",{type:"date",value:Y.date||"",onChange:jt=>he({date:jt.target.value}),className:"input max-w-xs"}),!H&&n.jsx("button",{onClick:()=>X({isMultiDay:!0}),className:"ml-4 text-sm text-blue-600 hover:text-blue-800",children:"+ Enable multi-day operation"})]}),n.jsxs("div",{className:"card border-2 border-gray-200",children:[n.jsxs("h3",{className:"font-semibold text-gray-900 mb-4 flex items-center gap-2",children:[n.jsx(Ul,{className:"w-5 h-5 text-aeria-blue"}),"Go / No-Go Decision"]}),n.jsxs("div",{className:"flex flex-wrap gap-4 mb-4",children:[n.jsxs("button",{onClick:()=>he({goNoGoDecision:!0}),className:`flex-1 min-w-[150px] p-4 rounded-lg border-2 transition-all flex items-center justify-center gap-3 ${Y.goNoGoDecision===!0?"border-green-500 bg-green-50 text-green-700":"border-gray-200 hover:border-green-300 hover:bg-green-50/50"}`,children:[n.jsx(Kie,{className:"w-6 h-6"}),n.jsx("span",{className:"text-lg font-semibold",children:"GO"})]}),n.jsxs("button",{onClick:()=>he({goNoGoDecision:!1}),className:`flex-1 min-w-[150px] p-4 rounded-lg border-2 transition-all flex items-center justify-center gap-3 ${Y.goNoGoDecision===!1?"border-red-500 bg-red-50 text-red-700":"border-gray-200 hover:border-red-300 hover:bg-red-50/50"}`,children:[n.jsx(Yie,{className:"w-6 h-6"}),n.jsx("span",{className:"text-lg font-semibold",children:"NO-GO"})]})]}),Y.goNoGoDecision===!1&&n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Reason for No-Go"}),n.jsx("textarea",{value:Y.goNoGoNotes||"",onChange:jt=>he({goNoGoNotes:jt.target.value}),className:"input min-h-[80px]",placeholder:"Document the reason for the No-Go decision..."})]})]}),n.jsxs("div",{className:"card",children:[n.jsxs("button",{onClick:()=>Te("weather"),className:"flex items-center justify-between w-full text-left",children:[n.jsxs("h2",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[n.jsx(by,{className:"w-5 h-5 text-blue-500"}),"Weather Conditions"]}),C.weather?n.jsx($n,{className:"w-5 h-5 text-gray-400"}):n.jsx(fn,{className:"w-5 h-5 text-gray-400"})]}),C.weather&&n.jsxs("div",{className:"mt-4 space-y-4",children:[n.jsxs("div",{className:"grid sm:grid-cols-2 lg:grid-cols-3 gap-4",children:[n.jsxs("div",{children:[n.jsxs("label",{className:"label flex items-center gap-2",children:[n.jsx(k6,{className:"w-4 h-4"}),"Temperature"]}),n.jsx("input",{type:"text",value:((mi=Y.weatherData)==null?void 0:mi.temperature)||"",onChange:jt=>K("temperature",jt.target.value),className:"input",placeholder:"e.g., 15C"})]}),n.jsxs("div",{children:[n.jsxs("label",{className:"label flex items-center gap-2",children:[n.jsx(by,{className:"w-4 h-4"}),"Wind Speed"]}),n.jsx("input",{type:"text",value:((ht=Y.weatherData)==null?void 0:ht.windSpeed)||"",onChange:jt=>K("windSpeed",jt.target.value),className:"input",placeholder:"e.g., 10 km/h"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Wind Direction"}),n.jsx("input",{type:"text",value:((hi=Y.weatherData)==null?void 0:hi.windDirection)||"",onChange:jt=>K("windDirection",jt.target.value),className:"input",placeholder:"e.g., NW"})]}),n.jsxs("div",{children:[n.jsxs("label",{className:"label flex items-center gap-2",children:[n.jsx(ga,{className:"w-4 h-4"}),"Visibility"]}),n.jsx("input",{type:"text",value:((ni=Y.weatherData)==null?void 0:ni.visibility)||"",onChange:jt=>K("visibility",jt.target.value),className:"input",placeholder:"e.g., >10 SM"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Ceiling"}),n.jsx("input",{type:"text",value:((ui=Y.weatherData)==null?void 0:ui.ceiling)||"",onChange:jt=>K("ceiling",jt.target.value),className:"input",placeholder:"e.g., CLR or 5000 ft"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Conditions"}),n.jsx("input",{type:"text",value:((Fi=Y.weatherData)==null?void 0:Fi.conditions)||"",onChange:jt=>K("conditions",jt.target.value),className:"input",placeholder:"e.g., Clear, Few clouds"})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Weather Notes / METAR"}),n.jsx("textarea",{value:Y.weatherBriefing||"",onChange:jt=>he({weatherBriefing:jt.target.value}),className:"input min-h-[60px]",placeholder:"METAR, TAF, or other weather notes..."})]})]})]}),n.jsxs("div",{className:"card",children:[n.jsxs("button",{onClick:()=>Te("attendance"),className:"flex items-center justify-between w-full text-left",children:[n.jsxs("h2",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[n.jsx(ds,{className:"w-5 h-5 text-aeria-blue"}),"Crew Attendance",n.jsxs("span",{className:`px-2 py-0.5 text-xs rounded-full ${zt?"bg-green-100 text-green-700":"bg-gray-100 text-gray-600"}`,children:[tt,"/",ne.length]})]}),C.attendance?n.jsx($n,{className:"w-5 h-5 text-gray-400"}):n.jsx(fn,{className:"w-5 h-5 text-gray-400"})]}),C.attendance&&n.jsx("div",{className:"mt-4 space-y-2",children:ne.length===0?n.jsx("p",{className:"text-sm text-gray-500 italic",children:"No crew assigned to this project"}):ne.map(jt=>{const bi=It[jt.id||jt.name],ar=bi==null?void 0:bi.attended;return n.jsxs("div",{className:`flex items-center justify-between p-3 rounded-lg border ${ar?"bg-green-50 border-green-200":"bg-gray-50 border-gray-200"}`,children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center ${ar?"bg-green-200":"bg-gray-200"}`,children:ar?n.jsx(Jie,{className:"w-5 h-5 text-green-700"}):n.jsx(ds,{className:"w-5 h-5 text-gray-500"})}),n.jsxs("div",{children:[n.jsx("p",{className:"font-medium text-gray-900",children:jt.name}),n.jsx("p",{className:"text-sm text-gray-500",children:jt.role})]})]}),n.jsx("button",{onClick:()=>de(jt.id||jt.name,!ar),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${ar?"bg-green-100 text-green-700 hover:bg-green-200":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:ar?"Present ":"Mark Present"})]},jt.id||jt.name)})})]}),n.jsxs("div",{className:"card",children:[n.jsxs("button",{onClick:()=>Te("checklist"),className:"flex items-center justify-between w-full text-left",children:[n.jsxs("h2",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[n.jsx(Ul,{className:"w-5 h-5 text-aeria-blue"}),"Pre-Flight Checklist",n.jsxs("span",{className:`px-2 py-0.5 text-xs rounded-full ${Ke===Pe?"bg-green-100 text-green-700":"bg-gray-100 text-gray-600"}`,children:[Ke,"/",Pe]})]}),C.checklist?n.jsx($n,{className:"w-5 h-5 text-gray-400"}):n.jsx(fn,{className:"w-5 h-5 text-gray-400"})]}),C.checklist&&n.jsx("div",{className:"mt-4 space-y-2",children:[{key:"siteSecured",label:"Site secured and perimeter established",icon:Wn},{key:"equipmentChecked",label:"Aircraft and equipment pre-flight complete",icon:Zn},{key:"crewBriefed",label:"Crew briefed on operation plan",icon:ds},{key:"commsVerified",label:"Communications verified",icon:Jc},{key:"emergencyReviewed",label:"Emergency procedures reviewed",icon:jv},{key:"notamsChecked",label:"NOTAMs and airspace checked",icon:Pj},{key:"weatherConfirmed",label:"Weather conditions confirmed acceptable",icon:by},{key:"riskReviewed",label:"Risk assessment reviewed with crew",icon:Ds},{key:"clientNotified",label:"Client/stakeholders notified",icon:Hd},{key:"ppeConfirmed",label:"All required PPE confirmed",icon:Qc}].map(jt=>{const bi=jt.icon,ar=Le[jt.key];return n.jsxs("label",{className:`flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-colors ${ar?"bg-green-50 border-green-200":"bg-white border-gray-200 hover:border-gray-300"}`,children:[n.jsx("input",{type:"checkbox",checked:ar||!1,onChange:li=>se(jt.key,li.target.checked),className:"w-5 h-5 rounded border-gray-300 text-green-600"}),n.jsx(bi,{className:`w-4 h-4 ${ar?"text-green-600":"text-gray-400"}`}),n.jsx("span",{className:`text-sm ${ar?"text-green-800":"text-gray-700"}`,children:jt.label})]},jt.key)})})]}),n.jsxs("div",{className:"card",children:[n.jsxs("button",{onClick:()=>Te("briefing"),className:"flex items-center justify-between w-full text-left",children:[n.jsxs("h2",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[n.jsx(rs,{className:"w-5 h-5 text-aeria-blue"}),"Briefing Summary"]}),C.briefing?n.jsx($n,{className:"w-5 h-5 text-gray-400"}):n.jsx(fn,{className:"w-5 h-5 text-gray-400"})]}),C.briefing&&n.jsxs("div",{className:"mt-4 space-y-4",children:[n.jsxs("div",{className:"p-4 bg-gradient-to-r from-aeria-navy to-aeria-blue text-white rounded-lg",children:[n.jsx("h3",{className:"text-xl font-bold",children:t.name||"Untitled Project"}),n.jsxs("div",{className:"grid sm:grid-cols-4 gap-4 mt-3 text-sm",children:[n.jsxs("div",{children:[n.jsx("p",{className:"text-white/70",children:"Date"}),n.jsx("p",{className:"font-semibold",children:oe(Y.date)})]}),n.jsxs("div",{children:[n.jsx("p",{className:"text-white/70",children:"Client"}),n.jsx("p",{className:"font-semibold",children:t.clientName||"N/A"})]}),n.jsxs("div",{children:[n.jsx("p",{className:"text-white/70",children:"Operation"}),n.jsx("p",{className:"font-semibold",children:((Ii=t.flightPlan)==null?void 0:Ii.operationType)||"VLOS"})]}),n.jsxs("div",{children:[n.jsx("p",{className:"text-white/70",children:"Max Alt"}),n.jsxs("p",{className:"font-semibold",children:[((Bi=t.flightPlan)==null?void 0:Bi.maxAltitudeAGL)||120,"m AGL"]})]})]})]}),Et.length>0&&n.jsxs("div",{className:"p-4 bg-amber-50 border border-amber-200 rounded-lg",children:[n.jsxs("h4",{className:"font-semibold text-amber-900 mb-3 flex items-center gap-2",children:[n.jsx(ir,{className:"w-4 h-4"}),"Key Hazards & Controls"]}),n.jsx("div",{className:"space-y-2",children:Et.map((jt,bi)=>n.jsxs("div",{className:"text-sm",children:[n.jsx("p",{className:"font-medium text-amber-900",children:jt.description||"Unnamed"}),n.jsxs("p",{className:"text-amber-700",children:[" ",jt.controls||"None documented"]})]},bi))})]}),n.jsxs("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[n.jsxs("h4",{className:"font-semibold text-blue-900 mb-3 flex items-center gap-2",children:[n.jsx(Qc,{className:"w-4 h-4"}),"Required PPE"]}),n.jsx("div",{className:"flex flex-wrap gap-2",children:yi.map((jt,bi)=>n.jsx("span",{className:"px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm",children:jt},bi))})]}),n.jsxs("div",{className:"p-4 bg-red-50 border border-red-200 rounded-lg",children:[n.jsxs("h4",{className:"font-semibold text-red-900 mb-2 flex items-center gap-2",children:[n.jsx(jv,{className:"w-4 h-4"}),"Emergency Information"]}),n.jsxs("div",{className:"grid sm:grid-cols-2 gap-2 text-sm",children:[n.jsxs("div",{children:[n.jsx("span",{className:"text-red-700",children:"Contact: "}),n.jsxs("span",{className:"text-red-900 font-medium",children:[(($r=(Ki=t.emergencyPlan)==null?void 0:Ki.primaryEmergencyContact)==null?void 0:$r.name)||"Not set"," - ",((Gn=(nn=t.emergencyPlan)==null?void 0:nn.primaryEmergencyContact)==null?void 0:Gn.phone)||"N/A"]})]}),n.jsxs("div",{children:[n.jsx("span",{className:"text-red-700",children:"Hospital: "}),n.jsx("span",{className:"text-red-900 font-medium",children:((Tr=t.emergencyPlan)==null?void 0:Tr.nearestHospital)||"Not set"})]})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Additional Notes"}),n.jsx("textarea",{value:Y.customNotes||"",onChange:jt=>he({customNotes:jt.target.value}),className:"input min-h-[80px]",placeholder:"Any other items for today's briefing..."})]})]})]})]})}const qae="modulepreload",$ae=function(t){return"/"+t},G3={},D0=function(e,r,c){let h=Promise.resolve();if(r&&r.length>0){document.getElementsByTagName("link");const w=document.querySelector("meta[property=csp-nonce]"),o=(w==null?void 0:w.nonce)||(w==null?void 0:w.getAttribute("nonce"));h=Promise.allSettled(r.map(C=>{if(C=$ae(C),C in G3)return;G3[C]=!0;const R=C.endsWith(".css"),F=R?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${C}"]${F}`))return;const $=document.createElement("link");if($.rel=R?"stylesheet":qae,R||($.as="script"),$.crossOrigin="",$.href=C,o&&$.setAttribute("nonce",o),document.head.appendChild($),R)return new Promise((Y,H)=>{$.addEventListener("load",Y),$.addEventListener("error",()=>H(new Error(`Unable to preload CSS for ${C}`)))})}))}function x(w){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=w,window.dispatchEvent(o),!o.defaultPrevented)throw w}return h.then(w=>{for(const o of w||[])o.status==="rejected"&&x(o.reason);return e().catch(x)})},CS={name:"Aeria Solutions Ltd.",registration:"Transport Canada Operator #930355",tagline:"Professional RPAS Operations",website:"www.aeriasolutions.ca",email:"ops@aeriasolutions.ca",phone:"",address:"",logo:null,colors:{primary:"#1e3a5f",secondary:"#3b82f6",accent:"#10b981",light:"#e0f2fe"}},Zw=({label:t,value:e,onChange:r})=>n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("input",{type:"color",value:e,onChange:c=>r(c.target.value),className:"w-10 h-10 rounded cursor-pointer border border-gray-300"}),n.jsxs("div",{className:"flex-1",children:[n.jsx("label",{className:"text-sm font-medium text-gray-700",children:t}),n.jsx("input",{type:"text",value:e,onChange:c=>r(c.target.value),className:"input text-xs mt-1",placeholder:"#000000"})]})]}),H3=({logo:t,onUpload:e,onRemove:r,label:c="Logo"})=>{const[h,x]=ue.useState(!1),[w,o]=ue.useState(null),C=async R=>{var $;const F=($=R.target.files)==null?void 0:$[0];if(F){if(!F.type.startsWith("image/")){o("Please select an image file");return}if(F.size>500*1024){o("Image must be under 500KB");return}x(!0),o(null);try{const Y=new FileReader;Y.onload=H=>{e(H.target.result),x(!1)},Y.onerror=()=>{o("Failed to read file"),x(!1)},Y.readAsDataURL(F)}catch{o("Failed to upload logo"),x(!1)}}};return n.jsxs("div",{className:"space-y-2",children:[n.jsx("label",{className:"label",children:c}),t?n.jsxs("div",{className:"flex items-center gap-4 p-4 bg-gray-50 rounded-lg border border-gray-200",children:[n.jsx("img",{src:t,alt:"Logo preview",className:"h-16 w-auto max-w-[200px] object-contain"}),n.jsxs("button",{onClick:r,type:"button",className:"btn-secondary text-red-600 hover:bg-red-50 inline-flex items-center gap-1",children:[n.jsx(Ln,{className:"w-4 h-4"}),"Remove"]})]}):n.jsxs("label",{className:"flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-aeria-blue hover:bg-gray-50 transition-colors",children:[n.jsx("div",{className:"flex flex-col items-center justify-center pt-5 pb-6",children:h?n.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-aeria-blue"}):n.jsxs(n.Fragment,{children:[n.jsx(_2,{className:"w-8 h-8 text-gray-400 mb-2"}),n.jsx("p",{className:"text-sm text-gray-500",children:"Click to upload logo"}),n.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"PNG, JPG up to 500KB"})]})}),n.jsx("input",{type:"file",className:"hidden",accept:"image/*",onChange:C,disabled:h})]}),w&&n.jsxs("p",{className:"text-sm text-red-600 flex items-center gap-1",children:[n.jsx(Cs,{className:"w-4 h-4"}),w]})]})};function Gae(){const{user:t}=iu(),[e,r]=ue.useState(!0),[c,h]=ue.useState(!1),[x,w]=ue.useState(!1),[o,C]=ue.useState("operator"),[R,F]=ue.useState(CS),[$,Y]=ue.useState([]),[H,X]=ue.useState(null);ue.useEffect(()=>{(async()=>{try{const Ce=await Ap(qn(rn,"settings","branding"));if(Ce.exists()){const ne=Ce.data();ne.operator&&F({...CS,...ne.operator}),ne.clients&&Y(ne.clients)}}catch(Ce){console.error("Failed to load branding:",Ce)}finally{r(!1)}})()},[]);const he=async()=>{h(!0),w(!1);try{await cI(qn(rn,"settings","branding"),{operator:R,clients:$,updatedAt:new Date().toISOString(),updatedBy:(t==null?void 0:t.uid)||"unknown"},{merge:!0}),w(!0),setTimeout(()=>w(!1),3e3)}catch(Te){console.error("Failed to save branding:",Te),alert("Failed to save branding settings")}finally{h(!1)}},se=(Te,Ce)=>{F(ne=>({...ne,[Te]:Ce}))},de=(Te,Ce)=>{F(ne=>({...ne,colors:{...ne.colors,[Te]:Ce}}))},K=()=>{const Te={id:`client_${Date.now()}`,name:"New Client",logo:null,colors:null};Y(Ce=>[...Ce,Te]),X(Te.id)},ge=(Te,Ce,ne)=>{Y(ae=>ae.map(q=>q.id===Te?{...q,[Ce]:ne}:q))},Ae=Te=>{Y(Ce=>Ce.filter(ne=>ne.id!==Te)),H===Te&&X(null)};return e?n.jsxs("div",{className:"card text-center py-12",children:[n.jsx("div",{className:"w-8 h-8 border-4 border-aeria-navy border-t-transparent rounded-full animate-spin mx-auto mb-4"}),n.jsx("p",{className:"text-gray-500",children:"Loading branding settings..."})]}):n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"card",children:[n.jsxs("div",{className:"flex items-center justify-between mb-4",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("div",{className:"p-2 bg-aeria-sky rounded-lg",children:n.jsx(A6,{className:"w-5 h-5 text-aeria-navy"})}),n.jsxs("div",{children:[n.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Branding"}),n.jsx("p",{className:"text-sm text-gray-500",children:"Customize PDF export appearance"})]})]}),n.jsx("button",{onClick:he,disabled:c,className:"btn-primary inline-flex items-center gap-2",children:c?n.jsxs(n.Fragment,{children:[n.jsx(Ro,{className:"w-4 h-4 animate-spin"}),"Saving..."]}):x?n.jsxs(n.Fragment,{children:[n.jsx(ru,{className:"w-4 h-4"}),"Saved!"]}):n.jsxs(n.Fragment,{children:[n.jsx(tb,{className:"w-4 h-4"}),"Save Branding"]})})]}),n.jsxs("div",{className:"flex gap-2 border-b border-gray-200 pb-4",children:[n.jsxs("button",{onClick:()=>C("operator"),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${o==="operator"?"bg-aeria-navy text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[n.jsx(zy,{className:"w-4 h-4 inline mr-2"}),"Operator Branding"]}),n.jsxs("button",{onClick:()=>C("clients"),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${o==="clients"?"bg-aeria-navy text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[n.jsx(By,{className:"w-4 h-4 inline mr-2"}),"Client Branding"]})]})]}),o==="operator"&&n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"card",children:[n.jsx("h3",{className:"font-semibold text-gray-900 mb-4",children:"Company Information"}),n.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Company Name"}),n.jsx("input",{type:"text",value:R.name,onChange:Te=>se("name",Te.target.value),className:"input"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Registration"}),n.jsx("input",{type:"text",value:R.registration,onChange:Te=>se("registration",Te.target.value),className:"input",placeholder:"e.g., Transport Canada Operator #123456"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Tagline"}),n.jsx("input",{type:"text",value:R.tagline,onChange:Te=>se("tagline",Te.target.value),className:"input",placeholder:"e.g., Professional RPAS Operations"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Website"}),n.jsx("input",{type:"text",value:R.website,onChange:Te=>se("website",Te.target.value),className:"input",placeholder:"www.yourcompany.com"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Email"}),n.jsx("input",{type:"email",value:R.email,onChange:Te=>se("email",Te.target.value),className:"input"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Phone"}),n.jsx("input",{type:"tel",value:R.phone,onChange:Te=>se("phone",Te.target.value),className:"input",placeholder:"+1 (555) 123-4567"})]}),n.jsxs("div",{className:"md:col-span-2",children:[n.jsx("label",{className:"label",children:"Address"}),n.jsx("textarea",{value:R.address,onChange:Te=>se("address",Te.target.value),className:"input",rows:2,placeholder:"Street, City, Province, Postal Code"})]})]})]}),n.jsxs("div",{className:"card",children:[n.jsx("h3",{className:"font-semibold text-gray-900 mb-4",children:"Company Logo"}),n.jsx(H3,{logo:R.logo,onUpload:Te=>se("logo",Te),onRemove:()=>se("logo",null),label:"Operator Logo"}),n.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"This logo will appear on all PDF exports. For best results, use a transparent PNG."})]}),n.jsxs("div",{className:"card",children:[n.jsx("h3",{className:"font-semibold text-gray-900 mb-4",children:"Brand Colors"}),n.jsxs("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-4",children:[n.jsx(Zw,{label:"Primary",value:R.colors.primary,onChange:Te=>de("primary",Te)}),n.jsx(Zw,{label:"Secondary",value:R.colors.secondary,onChange:Te=>de("secondary",Te)}),n.jsx(Zw,{label:"Accent",value:R.colors.accent,onChange:Te=>de("accent",Te)}),n.jsx(Zw,{label:"Light",value:R.colors.light,onChange:Te=>de("light",Te)})]})]}),n.jsxs("div",{className:"card bg-gray-50",children:[n.jsxs("h3",{className:"font-semibold text-gray-900 mb-4 flex items-center gap-2",children:[n.jsx(ga,{className:"w-5 h-5"}),"Preview"]}),n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:[n.jsxs("div",{className:"flex items-center justify-between border-b pb-4",style:{borderColor:R.colors.primary},children:[n.jsxs("div",{className:"flex items-center gap-4",children:[R.logo?n.jsx("img",{src:R.logo,alt:"Logo",className:"h-12 w-auto"}):n.jsx("div",{className:"w-12 h-12 bg-gray-200 rounded flex items-center justify-center text-gray-400",children:n.jsx(By,{className:"w-6 h-6"})}),n.jsxs("div",{children:[n.jsx("h4",{className:"font-bold",style:{color:R.colors.primary},children:R.name}),n.jsx("p",{className:"text-sm text-gray-500",children:R.tagline})]})]}),n.jsxs("div",{className:"text-right text-sm text-gray-500",children:[n.jsx("p",{children:R.registration}),n.jsx("p",{children:R.website})]})]}),n.jsxs("div",{className:"mt-4 flex gap-2",children:[n.jsx("div",{className:"w-8 h-8 rounded",style:{backgroundColor:R.colors.primary},title:"Primary"}),n.jsx("div",{className:"w-8 h-8 rounded",style:{backgroundColor:R.colors.secondary},title:"Secondary"}),n.jsx("div",{className:"w-8 h-8 rounded",style:{backgroundColor:R.colors.accent},title:"Accent"}),n.jsx("div",{className:"w-8 h-8 rounded border",style:{backgroundColor:R.colors.light},title:"Light"})]})]})]})]}),o==="clients"&&n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"card",children:[n.jsxs("div",{className:"flex items-center justify-between mb-4",children:[n.jsx("h3",{className:"font-semibold text-gray-900",children:"Client Branding"}),n.jsxs("button",{onClick:K,className:"btn-secondary inline-flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Add Client"]})]}),$.length===0?n.jsxs("div",{className:"text-center py-8",children:[n.jsx(zy,{className:"w-12 h-12 mx-auto mb-4 text-gray-300"}),n.jsx("h4",{className:"font-medium text-gray-900 mb-1",children:"No client branding configured"}),n.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"Add client logos to enable co-branded PDF exports"}),n.jsxs("button",{onClick:K,className:"btn-primary inline-flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Add Client"]})]}):n.jsx("div",{className:"space-y-4",children:$.map(Te=>n.jsxs("div",{className:`p-4 rounded-lg border-2 transition-colors ${H===Te.id?"border-aeria-blue bg-blue-50":"border-gray-200 hover:border-gray-300"}`,children:[n.jsxs("div",{className:"flex items-center justify-between mb-3",children:[n.jsx("input",{type:"text",value:Te.name,onChange:Ce=>ge(Te.id,"name",Ce.target.value),className:"input font-medium",placeholder:"Client name"}),n.jsx("button",{onClick:()=>Ae(Te.id),className:"p-2 text-red-500 hover:bg-red-50 rounded-lg",children:n.jsx(Ln,{className:"w-4 h-4"})})]}),n.jsx(H3,{logo:Te.logo,onUpload:Ce=>ge(Te.id,"logo",Ce),onRemove:()=>ge(Te.id,"logo",null),label:"Client Logo"})]},Te.id))})]}),n.jsx("div",{className:"card bg-blue-50 border-blue-200",children:n.jsxs("div",{className:"flex gap-3",children:[n.jsx(Cs,{className:"w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"}),n.jsxs("div",{children:[n.jsx("h4",{className:"font-medium text-blue-900",children:"How Client Branding Works"}),n.jsxs("ul",{className:"text-sm text-blue-700 mt-2 space-y-1",children:[n.jsx("li",{children:" Client logos appear alongside your operator branding on PDFs"}),n.jsx("li",{children:" Select a client when creating a project to enable co-branding"}),n.jsx("li",{children:" Client branding is optional - your operator branding always appears"})]})]})]})})]})]})}function Zj(){const[t,e]=ue.useState({operator:CS,clients:[]}),[r,c]=ue.useState(!0);return ue.useEffect(()=>{(async()=>{try{const w=await Ap(qn(rn,"settings","branding"));if(w.exists()){const o=w.data();e({operator:{...CS,...o.operator},clients:o.clients||[]})}}catch(w){console.error("Failed to load branding:",w)}finally{c(!1)}})()},[]),{branding:t,loading:r,getClientBranding:x=>t.clients.find(w=>w.id===x)||null}}const UT=[{value:"environmental",label:"Environmental Hazards",description:"Weather, terrain, wildlife, temperature",category:"general"},{value:"overhead",label:"Overhead Hazards",description:"Power lines, structures, obstacles",category:"general"},{value:"access_egress",label:"Access/Egress",description:"Slips, trips, water hazards",category:"general"},{value:"ergonomic",label:"Ergonomic",description:"Awkward positions, repetitive tasks",category:"general"},{value:"personal_limitations",label:"Personal Limitations",description:"Fatigue, distraction, training gaps",category:"general"},{value:"equipment",label:"Equipment",description:"Malfunction, improper use",category:"general"},{value:"vehicle",label:"Vehicle Hazards",description:"Driving, loading, terrain navigation",category:"general"},{value:"chemical",label:"Chemical/Biological",description:"Fuel, batteries, contamination",category:"general"},{value:"airspace",label:"Airspace Hazards",description:"Controlled airspace, NOTAMs, TFRs, airport proximity",category:"rpas"},{value:"rf_interference",label:"RF/Signal Hazards",description:"Interference, link loss, GPS denial, EMI",category:"rpas"},{value:"flyaway",label:"Loss of Control",description:"Fly-away risk, GPS failure, compass interference",category:"rpas"},{value:"battery_thermal",label:"Battery Hazards",description:"Thermal runaway, swelling, cold weather performance",category:"rpas"},{value:"public_interaction",label:"Public/Bystanders",description:"Spectators, pedestrians, vehicle traffic",category:"rpas"},{value:"manned_aircraft",label:"Manned Aircraft",description:"Helicopters, fixed-wing, emergency aircraft",category:"rpas"},{value:"obstacle_collision",label:"Obstacle Collision",description:"Trees, buildings, powerlines, guy wires",category:"rpas"},{value:"vlos_limitations",label:"VLOS Limitations",description:"Visual line of sight obstructions, lighting",category:"rpas"},{value:"payload",label:"Payload Hazards",description:"Camera/sensor weight, balance, detachment",category:"rpas"},{value:"ground_crew",label:"Ground Crew Safety",description:"Prop strike, hand launch/catch, rotor hazards",category:"rpas"}];UT.filter(t=>t.category==="general");UT.filter(t=>t.category==="rpas");const MU=[{value:"1",label:"1 - Catastrophic",description:"Death or permanent disability",color:"bg-red-700"},{value:"2",label:"2 - Serious",description:"Major injury or damage",color:"bg-red-500"},{value:"3",label:"3 - Minor",description:"Non-serious injury",color:"bg-yellow-500"},{value:"4",label:"4 - Negligible",description:"No injury, minor inconvenience",color:"bg-green-500"}],OU=[{value:"A",label:"A - Frequent",description:"Will occur repeatedly",color:"bg-red-600"},{value:"B",label:"B - Reasonably Probable",description:"Will occur eventually",color:"bg-orange-500"},{value:"C",label:"C - Remote",description:"Could occur at some point",color:"bg-yellow-500"},{value:"D",label:"D - Extremely Improbable",description:"Very unlikely",color:"bg-green-500"}],LU=(t,e)=>({"1A":"critical","1B":"critical","1C":"high","1D":"medium","2A":"critical","2B":"high","2C":"medium","2D":"low","3A":"high","3B":"medium","3C":"low","3D":"low","4A":"medium","4B":"low","4C":"low","4D":"low"})[`${t}${e}`]||"unknown",FU=[{value:"elimination",label:"1. Elimination",description:"Remove the hazard entirely"},{value:"substitution",label:"2. Substitution",description:"Replace with less hazardous option"},{value:"engineering",label:"3. Engineering Controls",description:"Isolate people from hazard"},{value:"administrative",label:"4. Administrative Controls",description:"Change work procedures"},{value:"ppe",label:"5. PPE",description:"Personal protective equipment (last resort)"}],zU=["Operating equipment without authorization","Failure to warn or secure","Operating at improper speed","Using defective equipment","Failing to use PPE properly","Improper lifting or positioning","Failure to follow procedures","Failure to identify hazards"],BU=["Inadequate safety barriers or PPE","Defective tools, equipment, or materials","Poor housekeeping or clutter","Exposure to hazardous substances","Inadequate ventilation or lighting","Extreme temperatures","High noise levels","Congested workspace"],Hae=["Inadequate physical capability","Inadequate mental capability","Lack of knowledge or training","Improper motivation","Lack of safety awareness","Fatigue or overwork","Emotional strain or stress"],Wae=["Inadequate leadership or supervision","Deficient engineering or maintenance","Inadequate tools or equipment","Inadequate work standards","Poor communication","Lack of safety policies","Inadequate purchasing controls"],Zae={TSB_IMMEDIATE:{label:"TSB IMMEDIATE NOTIFICATION",phone:"1-800-387-3557",altPhone:"1-819-994-3741",conditions:["fatality","serious_injury_hospitalization","rpas_over_25kg_accident","collision_manned_aircraft"],instructions:"Call Transportation Safety Board IMMEDIATELY before any other actions."},TRANSPORT_CANADA:{label:"Transport Canada Notification",conditions:["fly_away","loss_of_control","boundary_violation","unintended_contact_person","equipment_damage_affecting_flight","near_miss_aircraft"],instructions:"Submit CADORS report. If under SFOC, submit RPAS Aviation Occurrence Reporting Form."},WORKSAFEBC:{label:"WorkSafeBC Notification",conditions:["serious_injury_hospitalization","fatality"],instructions:"Report workplace incident to WorkSafeBC."},AERIA_INTERNAL:{label:"Aeria Internal Notification",accountableExecutive:"Dustin Wales",phone:"604-849-2345",conditions:["all_incidents"],instructions:"Notify Accountable Executive for ALL incidents."}},w2=[{id:"pre_operation",name:"Pre-Operation",description:"Planning and assessment forms",icon:"ClipboardCheck",forms:["site_survey","flight_plan","formal_hazard_assessment","first_aid_assessment"]},{id:"daily_field",name:"Daily/Field",description:"Daily operations forms",icon:"Calendar",forms:["tailgate_briefing","flha","preflight_checklist","daily_flight_log"]},{id:"incident",name:"Incident",description:"Incident and investigation forms",icon:"AlertTriangle",forms:["near_miss","incident_report","investigation_report"]},{id:"tracking",name:"Tracking/Admin",description:"Administrative tracking forms",icon:"FileText",forms:["safety_meeting_log","training_record","equipment_inspection","ppe_inspection","vehicle_inspection"]}],S2={flha:{id:"flha",name:"Field Level Hazard Assessment",shortName:"FLHA",category:"daily_field",description:"Real-time hazard identification before/during field work",icon:"Shield",version:"1.0",sections:[{id:"header",title:"Assessment Information",fields:[{id:"form_id",type:"auto_id",label:"Form ID",required:!0},{id:"project",type:"project_select",label:"Project",required:!0},{id:"date",type:"date",label:"Date",required:!0,defaultToday:!0},{id:"time",type:"time",label:"Time",required:!0,defaultNow:!0},{id:"location_gps",type:"gps",label:"GPS Location",required:!0},{id:"location_description",type:"text",label:"Location Description",required:!0},{id:"weather",type:"weather_conditions",label:"Weather Conditions",required:!0},{id:"crew_present",type:"crew_multi_select",label:"Crew Present",required:!0}]},{id:"hazards",title:"Hazard Assessment",repeatable:!0,repeatLabel:"Add Hazard",fields:[{id:"task",type:"text",label:"Task Being Performed",required:!0},{id:"hazard_category",type:"select",label:"Hazard Category",required:!0,options:"HAZARD_CATEGORIES"},{id:"hazard_description",type:"textarea",label:"Specific Hazard",required:!0},{id:"source_identification",type:"textarea",label:"Source Identification",required:!0,helpText:"Where/why this hazard exists"},{id:"severity",type:"select",label:"Severity",required:!0,options:"SEVERITY_RATINGS"},{id:"probability",type:"select",label:"Probability",required:!0,options:"PROBABILITY_RATINGS"},{id:"initial_risk",type:"risk_matrix",label:"Initial Risk Score",calculated:!0},{id:"control_type",type:"select",label:"Control Type",required:!0,options:"CONTROL_TYPES"},{id:"control_description",type:"textarea",label:"Control Description",required:!0},{id:"residual_severity",type:"select",label:"Residual Severity",required:!0,options:"SEVERITY_RATINGS"},{id:"residual_probability",type:"select",label:"Residual Probability",required:!0,options:"PROBABILITY_RATINGS"},{id:"residual_risk",type:"risk_matrix",label:"Residual Risk Score",calculated:!0}]},{id:"signoff",title:"Sign-Off",fields:[{id:"completed_by",type:"signature",label:"Completed By",required:!0},{id:"crew_acknowledgment",type:"multi_signature",label:"Crew Acknowledgment",required:!0,helpText:"All crew members must sign"},{id:"supervisor_review",type:"signature",label:"Supervisor Review (if applicable)",required:!1},{id:"notes",type:"textarea",label:"Additional Notes/Observations",required:!1}]}]},incident_report:{id:"incident_report",name:"RPAS Incident/Accident Report",shortName:"Incident Report",category:"incident",description:"Document all RPAS-related incidents with regulatory trigger logic",icon:"AlertOctagon",version:"1.0",hasTriggers:!0,sections:[{id:"header",title:"Report Information",fields:[{id:"form_id",type:"auto_id",label:"Form ID",required:!0},{id:"report_date",type:"datetime",label:"Date/Time of Report",required:!0,defaultNow:!0},{id:"reporter_name",type:"user_auto",label:"Reporter Name",required:!0},{id:"reporter_role",type:"select",label:"Reporter Role",required:!0,options:[{value:"pic",label:"Pilot in Command"},{value:"vo",label:"Visual Observer"},{value:"crew",label:"Crew Member"},{value:"other",label:"Other"}]},{id:"reporter_phone",type:"phone",label:"Reporter Phone",required:!0}]},{id:"occurrence",title:"Occurrence Details",fields:[{id:"occurrence_date",type:"date",label:"Date of Occurrence",required:!0},{id:"occurrence_time",type:"time",label:"Time of Occurrence",required:!0},{id:"project",type:"project_select",label:"Project/Operation",required:!0},{id:"location_gps",type:"gps",label:"GPS Location",required:!0},{id:"location_description",type:"text",label:"Location Description",required:!0}]},{id:"rpas_info",title:"RPAS Information",fields:[{id:"aircraft",type:"aircraft_select",label:"Aircraft",required:!0},{id:"rpas_weight",type:"calculated",label:"RPAS Weight Category",helpText:"Auto-filled from aircraft selection"},{id:"registration",type:"calculated",label:"Registration Number"}]},{id:"personnel",title:"Personnel Involved",fields:[{id:"pic",type:"operator_select",label:"PIC",required:!0},{id:"pic_cert",type:"calculated",label:"PIC Certificate #"},{id:"visual_observers",type:"crew_multi_select",label:"Visual Observer(s)",required:!1},{id:"other_crew",type:"crew_multi_select",label:"Other Crew",required:!1}]},{id:"classification",title:"Occurrence Classification",description:"Answer these questions to determine regulatory notification requirements",fields:[{id:"fatality",type:"yesno",label:"Was anyone killed?",required:!0,trigger:"TSB_IMMEDIATE"},{id:"serious_injury",type:"yesno",label:"Was anyone seriously injured requiring hospitalization?",required:!0,trigger:"TSB_IMMEDIATE,WORKSAFEBC"},{id:"collision_manned",type:"yesno",label:"Was there a collision with a manned aircraft?",required:!0,trigger:"TSB_IMMEDIATE"},{id:"rpas_over_25kg",type:"yesno_conditional",label:"Was RPAS weight >25kg AND accident occurred?",required:!0,trigger:"TSB_IMMEDIATE",condition:"rpas_weight > 25"},{id:"fly_away",type:"yesno",label:"Did RPAS become uncontrollable/fly-away/go missing?",required:!0,trigger:"TRANSPORT_CANADA"},{id:"boundary_violation",type:"yesno",label:"Was RPAS operated outside horizontal/altitude limits?",required:!0,trigger:"TRANSPORT_CANADA"},{id:"unintended_contact",type:"yesno",label:"Was there unintended contact between RPAS and any person?",required:!0,trigger:"TRANSPORT_CANADA"},{id:"equipment_damage",type:"yesno",label:"Was there damage affecting flight characteristics?",required:!0,trigger:"TRANSPORT_CANADA"},{id:"near_miss",type:"yesno",label:"Was there risk of collision with another aircraft?",required:!0,trigger:"TRANSPORT_CANADA"},{id:"medical_attention",type:"yesno",label:"Did injury require medical attention beyond first aid?",required:!0},{id:"property_damage",type:"yesno",label:"Was there property damage?",required:!0},{id:"property_damage_value",type:"currency",label:"Estimated property damage value",required:!1,showIf:"property_damage === true"},{id:"under_sfoc",type:"yesno",label:"Was this operation under an SFOC?",required:!0,trigger:"SFOC_FORM"},{id:"sfoc_reference",type:"text",label:"SFOC Reference Number",required:!1,showIf:"under_sfoc === true"},{id:"police_report",type:"yesno",label:"Was a police report filed?",required:!0}]},{id:"notification_checklist",title:"Required Notifications",type:"trigger_checklist",description:"Based on your answers, the following notifications are required:",autoGenerated:!0},{id:"description",title:"Incident Description",fields:[{id:"detailed_description",type:"textarea",label:"Detailed Description",required:!0,rows:6,helpText:"What happened - be specific"},{id:"weather_conditions",type:"text",label:"Weather at Time",required:!0},{id:"task_at_time",type:"textarea",label:"Task being performed when incident occurred",required:!0,helpText:"Source identification"}]},{id:"immediate_cause",title:"Immediate Cause Classification",fields:[{id:"substandard_acts",type:"multiselect",label:"Substandard Acts",options:"SUBSTANDARD_ACTS",required:!1},{id:"substandard_acts_detail",type:"textarea",label:"Substandard Acts Details",required:!1},{id:"substandard_conditions",type:"multiselect",label:"Substandard Conditions",options:"SUBSTANDARD_CONDITIONS",required:!1},{id:"substandard_conditions_detail",type:"textarea",label:"Substandard Conditions Details",required:!1}]},{id:"evidence",title:"Evidence",fields:[{id:"photos",type:"file_upload",label:"Photos/Video",required:!1,multiple:!0,accept:"image/*,video/*"},{id:"airdata_log",type:"file_upload",label:"AirData Flight Log",required:!0},{id:"witnesses",type:"repeatable_text",label:"Witness Names",required:!1},{id:"witness_statements",type:"file_upload",label:"Witness Statements",required:!1,multiple:!0},{id:"equipment_tagged",type:"yesno",label:"Equipment Tagged Out?",required:!0},{id:"scene_secured",type:"yesno",label:"Scene Secured?",required:!0}]},{id:"immediate_actions",title:"Immediate Actions Taken",fields:[{id:"emergency_called",type:"yesno",label:"Emergency Services Called?",required:!0},{id:"emergency_time",type:"time",label:"Time Called",required:!1,showIf:"emergency_called === true"},{id:"first_aid",type:"yesno",label:"First Aid Provided?",required:!0},{id:"first_aid_detail",type:"textarea",label:"First Aid Details",required:!1,showIf:"first_aid === true"},{id:"operations_ceased",type:"yesno",label:"Operations Ceased?",required:!0},{id:"operations_ceased_time",type:"time",label:"Time Operations Ceased",required:!1,showIf:"operations_ceased === true"},{id:"scene_preservation",type:"textarea",label:"Scene Preservation Actions",required:!0}]},{id:"signoff",title:"Sign-Off",fields:[{id:"reporter_signature",type:"signature",label:"Reporter Signature",required:!0},{id:"pic_signature",type:"signature",label:"PIC Signature (if different)",required:!1},{id:"supervisor_signature",type:"signature",label:"Supervisor Acknowledgment",required:!0}]}]},investigation_report:{id:"investigation_report",name:"Investigation Report",shortName:"Investigation",category:"incident",description:"Root cause analysis and corrective action tracking",icon:"Search",version:"1.0",sections:[{id:"header",title:"Investigation Information",fields:[{id:"investigation_id",type:"auto_id",label:"Investigation ID",required:!0},{id:"linked_incident",type:"incident_select",label:"Linked Incident Report",required:!0},{id:"investigation_type",type:"select",label:"Investigation Type",required:!0,options:[{value:"formal_serious",label:"Formal - Serious/Fatality"},{value:"formal_regulatory",label:"Formal - Regulatory"},{value:"formal_environmental",label:"Formal - Environmental"},{value:"standard",label:"Standard"},{value:"informal",label:"Informal"},{value:"rpas_specific",label:"RPAS-Specific"}]},{id:"lead_investigator",type:"operator_select",label:"Lead Investigator",required:!0},{id:"investigation_team",type:"crew_multi_select",label:"Investigation Team",required:!1},{id:"start_date",type:"date",label:"Investigation Start Date",required:!0},{id:"due_date",type:"date",label:"Due Date",required:!0,helpText:"Within 24 hours of incident"}]},{id:"scope",title:"Investigation Scope",fields:[{id:"external_agencies",type:"multiselect",label:"External Agencies Involved",options:[{value:"tsb",label:"Transportation Safety Board"},{value:"transport_canada",label:"Transport Canada"},{value:"worksafebc",label:"WorkSafeBC"},{value:"rcmp",label:"RCMP"},{value:"environment_canada",label:"Environment Canada"}],required:!1},{id:"regulatory_reporting",type:"checklist",label:"Regulatory Reporting Completed",options:[{value:"tsb",label:"TSB Report"},{value:"transport_canada",label:"Transport Canada"},{value:"sfoc_form",label:"SFOC Occurrence Form"},{value:"cadors",label:"CADORS"},{value:"worksafebc",label:"WorkSafeBC"}],required:!0}]},{id:"fact_gathering_who",title:"Fact Gathering - Who",fields:[{id:"persons_involved",type:"repeatable_person",label:"Persons Involved",required:!0},{id:"witnesses",type:"repeatable_witness",label:"Witnesses Interviewed",required:!1}]},{id:"fact_gathering_what",title:"Fact Gathering - What Happened",fields:[{id:"location_details",type:"text",label:"Location Details",required:!0},{id:"location_gps",type:"gps",label:"GPS Coordinates",required:!0},{id:"incident_datetime",type:"datetime",label:"Date/Time of Incident",required:!0},{id:"environmental_conditions",type:"textarea",label:"Environmental Conditions",required:!0},{id:"sequence_before",type:"textarea",label:"Sequence of Events - Before Incident",required:!0,rows:4},{id:"sequence_during",type:"textarea",label:"Sequence of Events - During Incident",required:!0,rows:4},{id:"sequence_after",type:"textarea",label:"Sequence of Events - After Incident",required:!0,rows:4},{id:"equipment_involved",type:"multiselect_text",label:"Equipment Involved",required:!0},{id:"equipment_condition",type:"textarea",label:"Equipment Condition",required:!0}]},{id:"root_cause",title:"Root Cause Analysis",fields:[{id:"immediate_substandard_acts",type:"multiselect",label:"Immediate Causes - Substandard Acts",options:"SUBSTANDARD_ACTS",required:!1},{id:"immediate_acts_detail",type:"textarea",label:"Substandard Acts Details",required:!1},{id:"immediate_substandard_conditions",type:"multiselect",label:"Immediate Causes - Substandard Conditions",options:"SUBSTANDARD_CONDITIONS",required:!1},{id:"immediate_conditions_detail",type:"textarea",label:"Substandard Conditions Details",required:!1}]},{id:"root_cause_personal",title:"Root Causes - Personal Factors",fields:[{id:"personal_factors",type:"multiselect",label:"Personal Factors Identified",options:"PERSONAL_FACTORS",required:!1},{id:"personal_factors_detail",type:"textarea",label:"Personal Factors Details",required:!1}]},{id:"root_cause_system",title:"Root Causes - Job/System Factors",fields:[{id:"system_factors",type:"multiselect",label:"Job/System Factors Identified",options:"JOB_SYSTEM_FACTORS",required:!1},{id:"system_factors_detail",type:"textarea",label:"Job/System Factors Details",required:!1}]},{id:"corrective_actions",title:"Corrective Action Plan",repeatable:!0,repeatLabel:"Add Corrective Action",fields:[{id:"action_description",type:"textarea",label:"Action Description",required:!0},{id:"control_type",type:"select",label:"Control Type",required:!0,options:"CONTROL_TYPES"},{id:"responsible_party",type:"operator_select",label:"Responsible Party",required:!0},{id:"target_date",type:"date",label:"Target Completion Date",required:!0},{id:"actual_date",type:"date",label:"Actual Completion Date",required:!1},{id:"verification_method",type:"text",label:"Verification Method",required:!0},{id:"verifier",type:"operator_select",label:"Verifier",required:!0},{id:"verification_date",type:"date",label:"Verification Date",required:!1},{id:"status",type:"select",label:"Status",required:!0,options:[{value:"open",label:"Open"},{value:"in_progress",label:"In Progress"},{value:"completed",label:"Completed"},{value:"verified",label:"Verified"},{value:"closed",label:"Closed"}]},{id:"evidence",type:"file_upload",label:"Evidence of Completion",required:!1}]},{id:"findings",title:"Findings Summary",fields:[{id:"summary",type:"textarea",label:"Summary of Findings",required:!0,rows:6},{id:"lessons_learned",type:"textarea",label:"Lessons Learned",required:!0,rows:4,helpText:"For safety meetings"},{id:"policy_updates",type:"yesno_text",label:"Policy/Procedure Updates Required",required:!0},{id:"training_updates",type:"yesno_text",label:"Training Updates Required",required:!0}]},{id:"approval",title:"Approval",fields:[{id:"investigator_signature",type:"signature",label:"Investigator Signature",required:!0},{id:"hse_review",type:"signature",label:"HSE Representative Review",required:!0},{id:"management_approval",type:"signature",label:"Management Approval",required:!0},{id:"closed_date",type:"date",label:"Investigation Closed Date",required:!1,helpText:"When all CAs verified"}]}]},near_miss:{id:"near_miss",name:"Near Miss Report",shortName:"Near Miss",category:"incident",description:"Capture close calls before they become incidents",icon:"AlertTriangle",version:"1.0",sections:[{id:"header",title:"Event Information",fields:[{id:"form_id",type:"auto_id",label:"Form ID",required:!0},{id:"event_datetime",type:"datetime",label:"Date/Time of Event",required:!0},{id:"location_gps",type:"gps",label:"GPS Location",required:!0},{id:"location_description",type:"text",label:"Location Description",required:!0},{id:"project",type:"project_select",label:"Project",required:!0},{id:"reporter",type:"user_auto",label:"Reporter",required:!0}]},{id:"event_details",title:"Event Details",fields:[{id:"what_happened",type:"textarea",label:"What happened?",required:!0,rows:4},{id:"what_could_have_happened",type:"textarea",label:"What could have happened?",required:!0,rows:3,helpText:"Potential consequence"},{id:"task_performed",type:"text",label:"Task being performed",required:!0,helpText:"Source identification"}]},{id:"source",title:"Source Identification",fields:[{id:"hazard_category",type:"select",label:"Hazard Category",required:!0,options:"HAZARD_CATEGORIES"},{id:"hazard_source",type:"text",label:"Source of Hazard",required:!0,helpText:"Equipment, environment, procedure, behavior"},{id:"contributing_factors",type:"multiselect_text",label:"Contributing Factors",required:!0}]},{id:"risk",title:"Risk Assessment",fields:[{id:"potential_severity",type:"select",label:"Potential Severity",required:!0,options:"SEVERITY_RATINGS",helpText:"If it had resulted in incident"},{id:"potential_probability",type:"select",label:"Potential Probability",required:!0,options:"PROBABILITY_RATINGS",helpText:"How likely to recur"},{id:"risk_score",type:"risk_matrix",label:"Risk Score",calculated:!0}]},{id:"actions",title:"Actions",fields:[{id:"immediate_actions",type:"textarea",label:"Immediate Actions Taken",required:!0},{id:"hazard_still_present",type:"yesno",label:"Hazard Still Present?",required:!0},{id:"suggested_controls",type:"textarea",label:"Suggested Controls",required:!0},{id:"requires_investigation",type:"yesno",label:"Requires Follow-up Investigation?",required:!0}]},{id:"signoff",title:"Sign-Off",fields:[{id:"reporter_signature",type:"signature",label:"Reporter Signature",required:!0},{id:"supervisor_signature",type:"signature",label:"Supervisor Acknowledgment",required:!0,helpText:"Within 24 hours"}]}]},tailgate_briefing:{id:"tailgate_briefing",name:"Tailgate Safety Briefing",shortName:"Tailgate",category:"daily_field",description:"Condensed ops plan for field briefing",icon:"Users",version:"1.0",sections:[{id:"header",title:"Briefing Information",fields:[{id:"form_id",type:"auto_id",label:"Form ID",required:!0},{id:"date",type:"date",label:"Date",required:!0,defaultToday:!0},{id:"time",type:"time",label:"Time",required:!0,defaultNow:!0},{id:"project",type:"project_select",label:"Project",required:!0},{id:"location",type:"text",label:"Location",required:!0,autoFill:"project.location"},{id:"briefing_lead",type:"operator_select",label:"Briefing Led By",required:!0}]},{id:"crew",title:"Crew Present",fields:[{id:"attendees",type:"crew_multi_signature",label:"Attendees",required:!0,helpText:"All must sign"}]},{id:"key_info",title:"Key Information",autoPopulate:"project",fields:[{id:"objectives",type:"textarea",label:"Today's Objectives",required:!0},{id:"key_hazards",type:"hazard_summary",label:"Key Hazards",required:!0,autoFill:"project.hazards"},{id:"controls",type:"control_summary",label:"Controls in Place",required:!0,autoFill:"project.controls"},{id:"ppe_required",type:"checklist",label:"PPE Required",required:!0,autoFill:"project.ppe"},{id:"muster_point",type:"text",label:"Emergency Muster Point",required:!0,autoFill:"project.muster_point"},{id:"emergency_contacts",type:"contact_summary",label:"Emergency Contacts",required:!0},{id:"flyaway_script",type:"checkbox",label:"Fly-Away Script Location Confirmed",required:!0}]},{id:"amendments",title:"Field Amendments",fields:[{id:"conditions_changed",type:"yesno",label:"Site Conditions Changed from Plan?",required:!0},{id:"additional_hazards",type:"textarea",label:"Additional Hazards Identified",required:!1,showIf:"conditions_changed === true"},{id:"additional_controls",type:"textarea",label:"Additional Controls Required",required:!1,showIf:"conditions_changed === true"},{id:"weather_checked",type:"yesno",label:"Weather Check Completed?",required:!0},{id:"weather_conditions",type:"text",label:"Current Weather Conditions",required:!0},{id:"notams_reviewed",type:"yesno",label:"NOTAMs Reviewed?",required:!0},{id:"navcanada_submitted",type:"yesno",label:"NavCanada Flight Plan Submitted?",required:!1}]},{id:"confirmation",title:"Crew Confirmation",fields:[{id:"roles_understood",type:"checkbox",label:"Everyone understands their roles",required:!0},{id:"fit_for_duty",type:"checkbox",label:"Everyone fit for duty",required:!0},{id:"questions_raised",type:"textarea",label:"Questions/Concerns Raised",required:!1}]},{id:"signoff",title:"Sign-Off",fields:[{id:"crew_signatures",type:"multi_signature",label:"All Crew Signatures",required:!0},{id:"briefing_complete_time",type:"time",label:"Briefing Complete Time",required:!0}]}]},preflight_checklist:{id:"preflight_checklist",name:"Pre-Flight Checklist",shortName:"Pre-Flight",category:"daily_field",description:"VO/PIC call-and-response before launch",icon:"CheckSquare",version:"1.0",sections:[{id:"header",title:"Flight Information",fields:[{id:"form_id",type:"auto_id",label:"Form ID",required:!0},{id:"datetime",type:"datetime",label:"Date/Time",required:!0,defaultNow:!0},{id:"flight_number",type:"number",label:"Flight # (today)",required:!0},{id:"aircraft",type:"aircraft_select",label:"Aircraft",required:!0},{id:"pic",type:"user_auto",label:"PIC",required:!0},{id:"vo",type:"operator_select",label:"VO",required:!0}]},{id:"call_response",title:"Call & Response",description:"VO reads call, PIC responds",fields:[{id:"takeoff_time",type:"time",label:"Take-off Time Noted",required:!0},{id:"wind_weather",type:"text",label:"Wind & Weather",required:!0,placeholder:"Within limits / describe"},{id:"air_vehicle_batteries",type:"text",label:"Air Vehicle Batteries (%)",required:!0},{id:"ground_control_batteries",type:"text",label:"Ground Control Batteries (%)",required:!0},{id:"ground_control_app",type:"select",label:"Ground Control App Status",required:!0,options:[{value:"ok",label:"OK"},{value:"error",label:"Error"}]},{id:"payload",type:"select",label:"Payload Status",required:!0,options:[{value:"connected",label:"Connected"},{value:"clear",label:"Clear"},{value:"na",label:"N/A"}]},{id:"failsafe",type:"text",label:"Failsafe Settings",required:!0,helpText:"Mode, RTL altitude, limits"},{id:"takeoff_mode",type:"text",label:"Take-off Mode",required:!0,defaultValue:"P-GPS (Loiter)"},{id:"area_traffic",type:"select",label:"Area & Air Traffic",required:!0,options:[{value:"clear",label:"Clear"},{value:"traffic_noted",label:"Traffic Noted"}]},{id:"airdata_synced",type:"yesno",label:"AirData Synced?",required:!0}]},{id:"clearance",title:"Clearance",fields:[{id:"vo_cleared",type:"checkbox",label:'VO: "Cleared for Takeoff"',required:!0},{id:"pic_clear",type:"checkbox",label:'PIC: "CLEAR"',required:!0}]},{id:"signoff",title:"Sign-Off",fields:[{id:"pic_signature",type:"signature",label:"PIC Signature",required:!0},{id:"vo_signature",type:"signature",label:"VO Signature",required:!0}]}]},daily_flight_log:{id:"daily_flight_log",name:"Daily Flight Log",shortName:"Flight Log",category:"daily_field",description:"CAR 901.48 compliance - 24 month retention",icon:"FileText",version:"1.0",retentionPeriod:"24 months",sections:[{id:"header",title:"Log Information",fields:[{id:"log_id",type:"auto_id",label:"Log ID",required:!0},{id:"date",type:"date",label:"Date",required:!0,defaultToday:!0},{id:"project",type:"project_select",label:"Project",required:!0},{id:"location_gps",type:"gps",label:"GPS Location",required:!0},{id:"location_description",type:"text",label:"Location Description",required:!0}]},{id:"flights",title:"Flight Entries",repeatable:!0,repeatLabel:"Add Flight",fields:[{id:"flight_number",type:"auto_increment",label:"Flight #",required:!0},{id:"aircraft",type:"aircraft_select",label:"Aircraft",required:!0},{id:"pic",type:"operator_select",label:"PIC",required:!0},{id:"takeoff_time",type:"time",label:"Take-off Time",required:!0},{id:"landing_time",type:"time",label:"Landing Time",required:!0},{id:"flight_duration",type:"calculated",label:"Flight Duration",calculated:!0},{id:"battery_id",type:"battery_select",label:"Battery Used",required:!0},{id:"battery_start",type:"number",label:"Battery Start %",required:!0},{id:"battery_end",type:"number",label:"Battery End %",required:!0},{id:"max_altitude",type:"number",label:"Max Altitude (AGL)",required:!0},{id:"flight_type",type:"select",label:"Flight Type",required:!0,options:[{value:"survey",label:"Survey"},{value:"inspection",label:"Inspection"},{value:"training",label:"Training"},{value:"test",label:"Test Flight"}]},{id:"airdata_log_id",type:"text",label:"AirData Log ID",required:!0},{id:"notes",type:"textarea",label:"Incidents/Notes",required:!1}]},{id:"summary",title:"Daily Summary",fields:[{id:"total_flights",type:"calculated",label:"Total Flights",calculated:!0},{id:"total_flight_time",type:"calculated",label:"Total Flight Time",calculated:!0},{id:"equipment_issues",type:"textarea",label:"Equipment Issues",required:!1},{id:"maintenance_required",type:"yesno_text",label:"Maintenance Required",required:!1}]},{id:"signoff",title:"Sign-Off",fields:[{id:"pic_signature",type:"signature",label:"PIC Signature",required:!0},{id:"signoff_date",type:"date",label:"Date",required:!0}]}]},equipment_inspection:{id:"equipment_inspection",name:"Equipment Inspection",shortName:"Equipment",category:"tracking",description:"Track RPAS and support equipment condition",icon:"Wrench",version:"1.0",sections:[{id:"header",title:"Inspection Information",fields:[{id:"inspection_id",type:"auto_id",label:"Inspection ID",required:!0},{id:"date",type:"date",label:"Date",required:!0,defaultToday:!0},{id:"inspector",type:"operator_select",label:"Inspector",required:!0},{id:"equipment_type",type:"select",label:"Equipment Type",required:!0,options:[{value:"rpas",label:"RPAS"},{value:"ground_control",label:"Ground Control Station"},{value:"battery",label:"Battery"},{value:"payload",label:"Payload"},{value:"support",label:"Support Equipment"}]},{id:"equipment_id",type:"equipment_select",label:"Equipment ID",required:!0}]},{id:"checklist",title:"Inspection Checklist",dynamicByEquipmentType:!0,repeatable:!0,fields:[{id:"item",type:"text",label:"Item",required:!0},{id:"condition",type:"select",label:"Condition",required:!0,options:[{value:"pass",label:"Pass"},{value:"fail",label:"Fail"},{value:"na",label:"N/A"}]},{id:"notes",type:"text",label:"Notes",required:!1,showIf:'condition === "fail"'}]},{id:"results",title:"Results",fields:[{id:"overall_status",type:"select",label:"Overall Status",required:!0,options:[{value:"pass",label:"Pass - Serviceable"},{value:"fail",label:"Fail - Remove from Service"}]},{id:"defects_found",type:"repeatable_text",label:"Defects Found",required:!1,showIf:'overall_status === "fail"'},{id:"action_required",type:"textarea",label:"Action Required",required:!1,showIf:'overall_status === "fail"'},{id:"locked_out",type:"yesno",label:"Equipment Locked Out?",required:!0,showIf:'overall_status === "fail"'},{id:"lockout_tag",type:"text",label:"Lock-out Tag #",required:!1,showIf:"locked_out === true"}]},{id:"corrective",title:"Corrective Action",showIf:'overall_status === "fail"',fields:[{id:"action_description",type:"textarea",label:"Action Description",required:!0},{id:"responsible",type:"operator_select",label:"Responsible Party",required:!0},{id:"due_date",type:"date",label:"Due Date",required:!0},{id:"completion_date",type:"date",label:"Completion Date",required:!1},{id:"return_to_service",type:"signature",label:"Return to Service Approved By",required:!1}]},{id:"signoff",title:"Sign-Off",fields:[{id:"inspector_signature",type:"signature",label:"Inspector Signature",required:!0}]}]},ppe_inspection:{id:"ppe_inspection",name:"PPE Inspection",shortName:"PPE",category:"tracking",description:"CSA/ANSI compliance tracking",icon:"HardHat",version:"1.0",sections:[{id:"header",title:"Inspection Information",fields:[{id:"inspection_id",type:"auto_id",label:"Inspection ID",required:!0},{id:"date",type:"date",label:"Date",required:!0,defaultToday:!0},{id:"inspector",type:"operator_select",label:"Inspector",required:!0}]},{id:"items",title:"PPE Items",repeatable:!0,repeatLabel:"Add PPE Item",fields:[{id:"ppe_type",type:"select",label:"PPE Type",required:!0,options:[{value:"hard_hat",label:"Hard Hat"},{value:"safety_glasses",label:"Safety Glasses"},{value:"hi_vis",label:"Hi-Vis Vest"},{value:"boots",label:"Safety Boots"},{value:"gloves",label:"Gloves"},{value:"hearing",label:"Hearing Protection"},{value:"fall_protection",label:"Fall Protection"},{value:"respirator",label:"Respirator"}]},{id:"assigned_to",type:"operator_select",label:"Assigned To",required:!0},{id:"manufacturer",type:"text",label:"Manufacturer",required:!0},{id:"model",type:"text",label:"Model",required:!0},{id:"serial_number",type:"text",label:"Serial/Lot #",required:!1},{id:"manufacture_date",type:"date",label:"Manufacture Date",required:!1},{id:"expiry_date",type:"date",label:"Expiry Date",required:!1},{id:"visual_condition",type:"select",label:"Visual Condition",required:!0,options:[{value:"pass",label:"Pass"},{value:"fail",label:"Fail"}]},{id:"functional_test",type:"select",label:"Functional Test",required:!0,options:[{value:"pass",label:"Pass"},{value:"fail",label:"Fail"},{value:"na",label:"N/A"}]},{id:"cleanliness",type:"select",label:"Cleanliness",required:!0,options:[{value:"pass",label:"Pass"},{value:"fail",label:"Fail"}]},{id:"defects",type:"text",label:"Defects Found",required:!1},{id:"disposition",type:"select",label:"Disposition",required:!0,options:[{value:"serviceable",label:"Serviceable"},{value:"replace",label:"Replace"},{value:"repair",label:"Repair"}]},{id:"replacement_ordered",type:"yesno",label:"Replacement Ordered?",required:!1,showIf:'disposition === "replace"'}]},{id:"signoff",title:"Sign-Off",fields:[{id:"inspector_signature",type:"signature",label:"Inspector Signature",required:!0}]}]},training_record:{id:"training_record",name:"Training Record",shortName:"Training",category:"tracking",description:"Personnel competency tracking",icon:"GraduationCap",version:"1.0",sections:[{id:"header",title:"Record Information",fields:[{id:"record_id",type:"auto_id",label:"Record ID",required:!0},{id:"employee",type:"operator_select",label:"Employee",required:!0}]},{id:"training",title:"Training Details",fields:[{id:"training_type",type:"select",label:"Training Type",required:!0,options:[{value:"initial",label:"Initial"},{value:"refresher",label:"Refresher"},{value:"specialized",label:"Specialized"},{value:"certification",label:"Certification"}]},{id:"course_topic",type:"text",label:"Course/Topic",required:!0},{id:"provider",type:"text",label:"Provider",required:!0,helpText:"Internal or external organization"},{id:"trainer",type:"text",label:"Trainer Name",required:!0},{id:"date_completed",type:"date",label:"Date Completed",required:!0},{id:"duration",type:"number",label:"Duration (hours)",required:!0},{id:"location",type:"text",label:"Location",required:!0}]},{id:"certification",title:"Certification",fields:[{id:"cert_issued",type:"yesno",label:"Certificate Issued?",required:!0},{id:"cert_number",type:"text",label:"Certificate Number",required:!1,showIf:"cert_issued === true"},{id:"expiry_date",type:"date",label:"Expiry Date",required:!1},{id:"renewal_required",type:"calculated",label:"Renewal Required",calculated:!0}]},{id:"assessment",title:"Competency Assessment",fields:[{id:"assessment_method",type:"select",label:"Assessment Method",required:!1,options:[{value:"written",label:"Written"},{value:"practical",label:"Practical"},{value:"observation",label:"Observation"}]},{id:"assessment_result",type:"select",label:"Assessment Result",required:!1,options:[{value:"pass",label:"Pass"},{value:"fail",label:"Fail"}]},{id:"competency_verified",type:"signature",label:"Competency Verified By",required:!0}]},{id:"attachments",title:"Attachments",fields:[{id:"certificate_copy",type:"file_upload",label:"Certificate Copy",required:!1},{id:"training_materials",type:"file_upload",label:"Training Materials",required:!1}]},{id:"signoff",title:"Sign-Off",fields:[{id:"employee_signature",type:"signature",label:"Employee Acknowledgment",required:!0},{id:"supervisor_signature",type:"signature",label:"Supervisor Verification",required:!0}]}]},safety_meeting_log:{id:"safety_meeting_log",name:"Safety Meeting Log",shortName:"Safety Meeting",category:"tracking",description:"Document tailgate and safety planning meetings",icon:"Users",version:"1.0",sections:[{id:"header",title:"Meeting Information",fields:[{id:"meeting_id",type:"auto_id",label:"Meeting ID",required:!0},{id:"date",type:"date",label:"Date",required:!0,defaultToday:!0},{id:"time",type:"time",label:"Time",required:!0},{id:"meeting_type",type:"select",label:"Meeting Type",required:!0,options:[{value:"tailgate",label:"Tailgate"},{value:"safety_planning",label:"Safety Planning"},{value:"toolbox_talk",label:"Toolbox Talk"},{value:"incident_review",label:"Incident Review"}]},{id:"location_project",type:"text",label:"Location/Project",required:!0},{id:"meeting_lead",type:"operator_select",label:"Meeting Led By",required:!0}]},{id:"attendees",title:"Attendees",fields:[{id:"attendees",type:"crew_multi_signature",label:"Attendees",required:!0}]},{id:"content",title:"Content",fields:[{id:"topics",type:"textarea",label:"Topics Discussed",required:!0,rows:4},{id:"hazards_reviewed",type:"textarea",label:"Hazards Reviewed",required:!1},{id:"incidents_discussed",type:"textarea",label:"Incidents/Near Misses Discussed",required:!1},{id:"lessons_shared",type:"textarea",label:"Lessons Learned Shared",required:!1}]},{id:"actions",title:"Action Items",repeatable:!0,repeatLabel:"Add Action Item",fields:[{id:"action",type:"text",label:"Action Item",required:!0},{id:"assigned_to",type:"operator_select",label:"Assigned To",required:!0},{id:"due_date",type:"date",label:"Due Date",required:!0},{id:"status",type:"select",label:"Status",required:!0,options:[{value:"open",label:"Open"},{value:"complete",label:"Complete"}]}]},{id:"signoff",title:"Sign-Off",fields:[{id:"all_signatures",type:"multi_signature",label:"All Attendee Signatures",required:!0},{id:"meeting_duration",type:"number",label:"Meeting Duration (minutes)",required:!0}]}]},vehicle_inspection:{id:"vehicle_inspection",name:"Vehicle Inspection",shortName:"Vehicle",category:"tracking",description:"Pre/post trip compliance",icon:"Truck",version:"1.0",sections:[{id:"header",title:"Inspection Information",fields:[{id:"inspection_id",type:"auto_id",label:"Inspection ID",required:!0},{id:"date",type:"date",label:"Date",required:!0,defaultToday:!0},{id:"inspection_type",type:"select",label:"Inspection Type",required:!0,options:[{value:"pre_trip",label:"Pre-Trip"},{value:"post_trip",label:"Post-Trip"}]},{id:"vehicle_id",type:"text",label:"Vehicle ID/Plate",required:!0},{id:"odometer",type:"number",label:"Odometer Reading",required:!0},{id:"driver",type:"operator_select",label:"Driver",required:!0}]},{id:"checklist",title:"Inspection Checklist",fields:[{id:"tires",type:"select",label:"Tires",required:!0,options:[{value:"pass",label:"Pass"},{value:"fail",label:"Fail"}]},{id:"fluids",type:"select",label:"Fluids (oil, coolant, washer)",required:!0,options:[{value:"pass",label:"Pass"},{value:"fail",label:"Fail"}]},{id:"lights",type:"select",label:"Lights (headlights, brake, signals)",required:!0,options:[{value:"pass",label:"Pass"},{value:"fail",label:"Fail"}]},{id:"brakes",type:"select",label:"Brakes",required:!0,options:[{value:"pass",label:"Pass"},{value:"fail",label:"Fail"}]},{id:"mirrors",type:"select",label:"Mirrors",required:!0,options:[{value:"pass",label:"Pass"},{value:"fail",label:"Fail"}]},{id:"wipers",type:"select",label:"Wipers",required:!0,options:[{value:"pass",label:"Pass"},{value:"fail",label:"Fail"}]},{id:"horn",type:"select",label:"Horn",required:!0,options:[{value:"pass",label:"Pass"},{value:"fail",label:"Fail"}]},{id:"seatbelts",type:"select",label:"Seatbelts",required:!0,options:[{value:"pass",label:"Pass"},{value:"fail",label:"Fail"}]},{id:"first_aid_kit",type:"select",label:"First Aid Kit",required:!0,options:[{value:"pass",label:"Pass"},{value:"fail",label:"Fail"}]},{id:"fire_extinguisher",type:"select",label:"Fire Extinguisher",required:!0,options:[{value:"pass",label:"Pass"},{value:"fail",label:"Fail"}]}]},{id:"defects",title:"Defects",fields:[{id:"defects_found",type:"textarea",label:"Defects Found",required:!1},{id:"action_taken",type:"textarea",label:"Action Taken",required:!1},{id:"vehicle_serviceable",type:"yesno",label:"Vehicle Serviceable?",required:!0}]},{id:"signoff",title:"Sign-Off",fields:[{id:"driver_signature",type:"signature",label:"Driver Signature",required:!0}]}]},formal_hazard_assessment:{id:"formal_hazard_assessment",name:"Formal Hazard Assessment",shortName:"FHA",category:"pre_operation",description:"Comprehensive hazard analysis for project planning - feeds FLHA",icon:"Shield",version:"1.0",sections:[{id:"header",title:"Assessment Information",fields:[{id:"form_id",type:"auto_id",label:"Form ID",required:!0},{id:"project",type:"project_select",label:"Project",required:!0},{id:"assessment_date",type:"date",label:"Assessment Date",required:!0,defaultToday:!0},{id:"assessor",type:"operator_select",label:"Assessor",required:!0},{id:"assessment_type",type:"select",label:"Assessment Type",required:!0,options:[{value:"initial",label:"Initial Assessment"},{value:"revision",label:"Revision"},{value:"periodic_review",label:"Periodic Review"}]},{id:"scope_description",type:"textarea",label:"Scope of Work",required:!0,helpText:"Describe the operations covered by this assessment"}]},{id:"tasks",title:"Task Inventory",description:"List all tasks involved in this project/operation",repeatable:!0,repeatLabel:"Add Task",fields:[{id:"task_name",type:"text",label:"Task Name",required:!0},{id:"task_description",type:"textarea",label:"Task Description",required:!0},{id:"task_category",type:"select",label:"Task Category",required:!0,options:[{value:"rpas_operation",label:"RPAS Operation"},{value:"ground_support",label:"Ground Support"},{value:"equipment_handling",label:"Equipment Handling"},{value:"vehicle_operation",label:"Vehicle Operation"},{value:"site_setup",label:"Site Setup/Teardown"},{value:"data_collection",label:"Data Collection"},{value:"environmental",label:"Environmental Work"},{value:"other",label:"Other"}]},{id:"frequency",type:"select",label:"Task Frequency",required:!0,options:[{value:"every_flight",label:"Every Flight"},{value:"daily",label:"Daily"},{value:"weekly",label:"Weekly"},{value:"as_needed",label:"As Needed"},{value:"one_time",label:"One Time"}]},{id:"personnel_required",type:"text",label:"Personnel Required",required:!0},{id:"equipment_required",type:"textarea",label:"Equipment Required",required:!1}]},{id:"hazards",title:"Hazard Identification",description:"Identify all hazards associated with the tasks",repeatable:!0,repeatLabel:"Add Hazard",fields:[{id:"related_task",type:"text",label:"Related Task(s)",required:!0},{id:"hazard_category",type:"select",label:"Hazard Category",required:!0,options:"HAZARD_CATEGORIES"},{id:"hazard_description",type:"textarea",label:"Hazard Description",required:!0},{id:"source_identification",type:"textarea",label:"Source/Cause",required:!0,helpText:"What creates this hazard?"},{id:"who_affected",type:"multiselect",label:"Who Could Be Affected",required:!0,options:[{value:"crew",label:"Flight Crew"},{value:"ground_crew",label:"Ground Crew"},{value:"client",label:"Client Personnel"},{value:"public",label:"Public"},{value:"emergency_responders",label:"Emergency Responders"}]},{id:"severity",type:"select",label:"Severity (Uncontrolled)",required:!0,options:"SEVERITY_RATINGS"},{id:"probability",type:"select",label:"Probability (Uncontrolled)",required:!0,options:"PROBABILITY_RATINGS"},{id:"initial_risk",type:"risk_matrix",label:"Initial Risk Level",calculated:!0}]},{id:"controls",title:"Control Measures",description:"Define controls following the Hierarchy of Controls",repeatable:!0,repeatLabel:"Add Control",fields:[{id:"related_hazard",type:"text",label:"Related Hazard",required:!0},{id:"control_type",type:"select",label:"Control Type (Hierarchy)",required:!0,options:"CONTROL_TYPES"},{id:"control_description",type:"textarea",label:"Control Description",required:!0},{id:"responsible_party",type:"text",label:"Responsible Party",required:!0},{id:"verification_method",type:"select",label:"Verification Method",required:!0,options:[{value:"visual_inspection",label:"Visual Inspection"},{value:"checklist",label:"Checklist Verification"},{value:"testing",label:"Testing/Demonstration"},{value:"documentation",label:"Documentation Review"},{value:"training_confirmation",label:"Training Confirmation"}]},{id:"residual_severity",type:"select",label:"Residual Severity",required:!0,options:"SEVERITY_RATINGS"},{id:"residual_probability",type:"select",label:"Residual Probability",required:!0,options:"PROBABILITY_RATINGS"},{id:"residual_risk",type:"risk_matrix",label:"Residual Risk Level",calculated:!0},{id:"acceptable",type:"yesno",label:"Residual Risk Acceptable?",required:!0},{id:"additional_controls_needed",type:"textarea",label:"Additional Controls Needed",required:!1,showIf:"acceptable === false"}]},{id:"ppe_requirements",title:"PPE Requirements",fields:[{id:"required_ppe",type:"checklist",label:"Required PPE",required:!0,options:[{value:"hard_hat",label:"Hard Hat"},{value:"safety_glasses",label:"Safety Glasses"},{value:"high_vis",label:"High Visibility Vest"},{value:"safety_boots",label:"Safety Boots"},{value:"gloves",label:"Gloves"},{value:"hearing_protection",label:"Hearing Protection"},{value:"sun_protection",label:"Sun Protection"},{value:"cold_weather",label:"Cold Weather Gear"},{value:"rain_gear",label:"Rain Gear"},{value:"respirator",label:"Respirator"}]},{id:"ppe_notes",type:"textarea",label:"PPE Notes/Special Requirements",required:!1}]},{id:"training_requirements",title:"Training Requirements",fields:[{id:"required_training",type:"checklist",label:"Required Training/Certifications",required:!0,options:[{value:"rpas_pilot",label:"RPAS Pilot Certificate (Basic/Advanced)"},{value:"first_aid",label:"First Aid Certification"},{value:"defensive_driving",label:"Defensive Driving"},{value:"whmis",label:"WHMIS"},{value:"ground_disturbance",label:"Ground Disturbance"},{value:"wildlife_awareness",label:"Wildlife Awareness"},{value:"bear_aware",label:"Bear Aware"},{value:"h2s_alive",label:"H2S Alive"},{value:"confined_space",label:"Confined Space Entry"},{value:"fall_protection",label:"Fall Protection"}]},{id:"training_notes",type:"textarea",label:"Additional Training Notes",required:!1}]},{id:"review",title:"Review & Approval",fields:[{id:"review_date",type:"date",label:"Review Date",required:!0},{id:"next_review",type:"date",label:"Next Review Date",required:!0},{id:"assessor_signature",type:"signature",label:"Assessor Signature",required:!0},{id:"reviewer_signature",type:"signature",label:"Reviewer/Supervisor Signature",required:!0},{id:"approval_notes",type:"textarea",label:"Review Notes",required:!1}]}]},first_aid_assessment:{id:"first_aid_assessment",name:"First Aid Assessment",shortName:"First Aid",category:"pre_operation",description:"OHS first aid requirements assessment for worksites",icon:"Shield",version:"1.0",sections:[{id:"header",title:"Assessment Information",fields:[{id:"form_id",type:"auto_id",label:"Form ID",required:!0},{id:"project",type:"project_select",label:"Project",required:!0},{id:"assessment_date",type:"date",label:"Assessment Date",required:!0,defaultToday:!0},{id:"assessor",type:"operator_select",label:"Assessor",required:!0},{id:"work_location",type:"text",label:"Work Location",required:!0},{id:"location_gps",type:"gps",label:"GPS Coordinates",required:!0}]},{id:"worksite_classification",title:"Worksite Classification",description:"Per OHS First Aid Regulation",fields:[{id:"hazard_rating",type:"select",label:"Worksite Hazard Rating",required:!0,options:[{value:"low",label:"Low Hazard - Office/clerical type work"},{value:"moderate",label:"Moderate Hazard - Light industrial, warehousing"},{value:"high",label:"High Hazard - Construction, forestry, mining"}]},{id:"workers_per_shift",type:"number",label:"Number of Workers Per Shift",required:!0},{id:"travel_time_medical",type:"select",label:"Travel Time to Medical Facility",required:!0,options:[{value:"under_20",label:"Under 20 minutes"},{value:"20_to_40",label:"20-40 minutes"},{value:"over_40",label:"Over 40 minutes"}]},{id:"remote_worksite",type:"yesno",label:"Is this a Remote Worksite?",required:!0,helpText:"More than 40 minutes from medical facility"}]},{id:"medical_facilities",title:"Nearest Medical Facilities",fields:[{id:"nearest_hospital",type:"text",label:"Nearest Hospital Name",required:!0},{id:"hospital_address",type:"textarea",label:"Hospital Address",required:!0},{id:"hospital_phone",type:"phone",label:"Hospital Phone",required:!0},{id:"hospital_distance",type:"text",label:"Distance (km)",required:!0},{id:"hospital_time",type:"text",label:"Travel Time (minutes)",required:!0},{id:"nearest_clinic",type:"text",label:"Nearest Walk-In Clinic",required:!1},{id:"clinic_address",type:"textarea",label:"Clinic Address",required:!1},{id:"clinic_phone",type:"phone",label:"Clinic Phone",required:!1}]},{id:"first_aid_requirements",title:"First Aid Requirements",description:"Based on worksite classification",fields:[{id:"kit_level_required",type:"select",label:"First Aid Kit Level Required",required:!0,options:[{value:"level_1",label:"Level 1 - Personal Kit"},{value:"level_2",label:"Level 2 - Basic Kit"},{value:"level_3",label:"Level 3 - Intermediate Kit"}]},{id:"first_aiders_required",type:"number",label:"Number of First Aiders Required",required:!0},{id:"first_aid_level_required",type:"select",label:"First Aid Certification Level Required",required:!0,options:[{value:"ofa_1",label:"OFA Level 1 (8 hours)"},{value:"ofa_2",label:"OFA Level 2 (16 hours)"},{value:"ofa_3",label:"OFA Level 3 (70 hours)"},{value:"emt",label:"Emergency Medical Technician"}]},{id:"first_aid_room",type:"yesno",label:"First Aid Room Required?",required:!0},{id:"transportation_required",type:"yesno",label:"Emergency Transportation Required?",required:!0}]},{id:"current_resources",title:"Current First Aid Resources",fields:[{id:"kit_available",type:"yesno",label:"First Aid Kit Available?",required:!0},{id:"kit_location",type:"text",label:"Kit Location",required:!0},{id:"kit_last_inspected",type:"date",label:"Kit Last Inspected",required:!0},{id:"aed_available",type:"yesno",label:"AED Available?",required:!1},{id:"aed_location",type:"text",label:"AED Location",required:!1,showIf:"aed_available === true"}]},{id:"first_aiders",title:"Designated First Aiders",repeatable:!0,repeatLabel:"Add First Aider",fields:[{id:"name",type:"operator_select",label:"First Aider Name",required:!0},{id:"certification_level",type:"select",label:"Certification Level",required:!0,options:[{value:"ofa_1",label:"OFA Level 1"},{value:"ofa_2",label:"OFA Level 2"},{value:"ofa_3",label:"OFA Level 3"},{value:"emt",label:"EMT"},{value:"other",label:"Other"}]},{id:"certificate_number",type:"text",label:"Certificate Number",required:!0},{id:"expiry_date",type:"date",label:"Expiry Date",required:!0},{id:"renewal_required",type:"calculated",label:"Renewal Status"}]},{id:"emergency_communication",title:"Emergency Communication",fields:[{id:"cell_coverage",type:"yesno",label:"Cell Phone Coverage Available?",required:!0},{id:"sat_phone_required",type:"yesno",label:"Satellite Phone Required?",required:!0},{id:"sat_phone_available",type:"yesno",label:"Satellite Phone Available?",required:!1,showIf:"sat_phone_required === true"},{id:"radio_available",type:"yesno",label:"Two-Way Radio Available?",required:!1},{id:"emergency_contacts",type:"repeatable_person",label:"Emergency Contact List",required:!0}]},{id:"gaps_actions",title:"Gaps & Action Items",fields:[{id:"gaps_identified",type:"textarea",label:"Gaps Identified",required:!1},{id:"action_items",type:"textarea",label:"Action Items Required",required:!1},{id:"action_due_date",type:"date",label:"Action Items Due Date",required:!1},{id:"compliance_confirmed",type:"yesno",label:"First Aid Requirements Met?",required:!0}]},{id:"signoff",title:"Sign-Off",fields:[{id:"assessor_signature",type:"signature",label:"Assessor Signature",required:!0},{id:"supervisor_signature",type:"signature",label:"Supervisor Approval",required:!0},{id:"assessment_notes",type:"textarea",label:"Additional Notes",required:!1}]}]}},T2=S2||{},SI=w2||[],Xae=UT||[],Yae=MU||[],Kae=OU||[],Qae=FU||[],W3=zU||[],Z3=BU||[],X3=Hae||[],Y3=Wae||[],qm=Zae||{},Jae=LU||(()=>"unknown"),Xj={Shield:Ds,Users:ds,Truck:D6,AlertTriangle:ir,AlertOctagon:jv,FileText:rs,ClipboardCheck:Ul,Calendar:il,Clipboard:x6,CheckSquare:Ul,Search:nu,GraduationCap:w6,HardHat:Qc,Wrench:bf},eoe=t=>{const r=new Date().toISOString().split("T")[0].replace(/-/g,""),c=Math.random().toString(36).substring(2,6).toUpperCase();return`${t.toUpperCase()}-${r}-${c}`},K3={critical:"bg-red-600 text-white",high:"bg-orange-500 text-white",medium:"bg-yellow-400 text-gray-900",low:"bg-green-500 text-white",unknown:"bg-gray-300 text-gray-700"},toe=()=>{try{const t=T2||{};return typeof t!="object"||t===null?(console.warn("FORM_TEMPLATES is not an object:",t),[]):Object.values(t).map(e=>!e||typeof e!="object"?null:{id:e.id||"",name:e.name||"Unknown Form",shortName:e.shortName||e.name||"Unknown",description:e.description||"",category:e.category||"other",icon:e.icon||"FileText",version:e.version||"1.0",sections:Array.isArray(e.sections)?e.sections:[]}).filter(Boolean)}catch(t){return console.error("Error in getAvailableForms:",t),[]}},Q3={pending:{label:"Pending",color:"bg-gray-100 text-gray-600",icon:Wu},in_progress:{label:"In Progress",color:"bg-blue-100 text-blue-700",icon:wT},completed:{label:"Completed",color:"bg-green-100 text-green-700",icon:qr},issue:{label:"Issue Noted",color:"bg-amber-100 text-amber-700",icon:ir}},ioe=(t,e)=>{if(!t||!e)return null;const[r,c]=t.split(":").map(Number),[h,x]=e.split(":").map(Number);let w=h*60+x-(r*60+c);w<0&&(w+=24*60);const o=Math.floor(w/60),C=w%60;return`${o}h ${C}m`},roe=(t,e=30)=>{if(!t)return null;const r=new Date(t),c=new Date,h=new Date;return h.setDate(h.getDate()+e),r<c?"EXPIRED":r<=h?"DUE SOON":"Current"},noe=t=>{const e=[];return((t==null?void 0:t.fatality)===!0||(t==null?void 0:t.serious_injury)===!0||(t==null?void 0:t.collision_manned)===!0||(t==null?void 0:t.rpas_over_25kg)===!0)&&e.push({...qm.TSB_IMMEDIATE,key:"TSB_IMMEDIATE",severity:"critical"}),((t==null?void 0:t.fly_away)===!0||(t==null?void 0:t.boundary_violation)===!0||(t==null?void 0:t.unintended_contact)===!0||(t==null?void 0:t.equipment_damage)===!0||(t==null?void 0:t.near_miss)===!0)&&e.push({...qm.TRANSPORT_CANADA,key:"TRANSPORT_CANADA",severity:"high"}),((t==null?void 0:t.fatality)===!0||(t==null?void 0:t.serious_injury)===!0)&&e.push({...qm.WORKSAFEBC,key:"WORKSAFEBC",severity:"high"}),e.push({...qm.AERIA_INTERNAL,key:"AERIA_INTERNAL",severity:"normal"}),e};function soe({form:t,formTemplate:e,project:r,operators:c=[],aircraft:h=[],onSave:x,onClose:w,onBackToLibrary:o}){if(!e||typeof e!="object")return n.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:n.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-md p-6 text-center",children:[n.jsx(Cs,{className:"w-12 h-12 text-red-500 mx-auto mb-4"}),n.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Form Template Error"}),n.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"Unable to load this form template."}),n.jsx("button",{onClick:w,className:"btn-primary mt-6",children:"Close"})]})});const[C,R]=ue.useState(()=>{const ve=(t==null?void 0:t.data)||{};try{e!=null&&e.sections&&Array.isArray(e.sections)&&e.sections.forEach(Le=>{!Le||!Le.id||(ve[Le.id]||(ve[Le.id]=Le.repeatable?[]:{}),Array.isArray(Le.fields)&&Le.fields.forEach(Ke=>{var Pe,It,tt,zt,vt,Ot,Et,yi,mi,ht,hi,ni,ui,Fi,Ii;if(!(!Ke||!Ke.id)){if(Ke.type==="auto_id"&&!ve[Le.id][Ke.id]&&(ve[Le.id][Ke.id]=eoe(e.id)),Ke.defaultToday&&!ve[Le.id][Ke.id]&&(ve[Le.id][Ke.id]=new Date().toISOString().split("T")[0]),Ke.defaultNow&&!ve[Le.id][Ke.id]){const Bi=new Date;ve[Le.id][Ke.id]=Bi.toTimeString().slice(0,5)}if(Ke.autoFill&&r&&!ve[Le.id][Ke.id]){const Bi=Ke.autoFill.replace("project.","").split(".");let Ki=r;if(Ke.autoFill==="project.hazards")Ki=((Pe=r.hseRisk)==null?void 0:Pe.hazards)||((It=r.siteSurvey)==null?void 0:It.hazards)||[];else if(Ke.autoFill==="project.controls")Ki=((tt=r.hseRisk)==null?void 0:tt.controls)||((zt=r.siteSurvey)==null?void 0:zt.controls)||[];else if(Ke.autoFill==="project.ppe")Ki=((vt=r.ppe)==null?void 0:vt.required)||((Ot=r.hseRisk)==null?void 0:Ot.ppe)||{high_vis:!0,safety_boots:!0,safety_glasses:!0};else if(Ke.autoFill==="project.muster_point")Ki=((Et=r.emergency)==null?void 0:Et.musterPoint)||((yi=r.siteSurvey)==null?void 0:yi.musterPoint)||"";else if(Ke.autoFill==="project.location")Ki=((ht=(mi=r.siteSurvey)==null?void 0:mi.location)==null?void 0:ht.description)||((hi=r.overview)==null?void 0:hi.location)||r.location||"";else if(Ke.autoFill==="project.crew")Ki=((ui=(ni=r.crew)==null?void 0:ni.members)==null?void 0:ui.map($r=>$r.id))||[];else if(Ke.autoFill==="project.aircraft")Ki=((Fi=r.flightPlan)==null?void 0:Fi.aircraft)||((Ii=r.equipment)==null?void 0:Ii.primaryAircraft)||"";else for(const $r of Bi)Ki=Ki==null?void 0:Ki[$r];Ki!=null&&(ve[Le.id][Ke.id]=Ki)}}}))})}catch(Le){console.error("Error initializing form data:",Le)}return ve}),[F,$]=ue.useState(0),[Y,H]=ue.useState({}),[X,he]=ue.useState({}),[se,de]=ue.useState(!1);if(!e)return null;const K=(ve,Le,Ke,Pe=null)=>{R(It=>{if(Pe!==null){const zt=[...It[ve]||[]];return zt[Pe]||(zt[Pe]={}),zt[Pe][Le]=Ke,{...It,[ve]:zt}}return{...It,[ve]:{...It[ve]||{},[Le]:Ke}}})},ge=(ve,Le,Ke=null)=>{var Pe,It,tt;return Ke!==null?((It=(Pe=C[ve])==null?void 0:Pe[Ke])==null?void 0:It[Le])||"":((tt=C[ve])==null?void 0:tt[Le])||""},Ae=ve=>{R(Le=>({...Le,[ve]:[...Le[ve]||[],{}]}))},Te=(ve,Le)=>{R(Ke=>({...Ke,[ve]:(Ke[ve]||[]).filter((Pe,It)=>It!==Le)}))},Ce=(ve=!1)=>{x(C,ve)},ne=()=>{de(!0),navigator.geolocation&&navigator.geolocation.getCurrentPosition(ve=>{var tt;const{latitude:Le,longitude:Ke}=ve.coords,Pe=e.sections[F],It=(tt=Pe==null?void 0:Pe.fields)==null?void 0:tt.find(zt=>zt.type==="gps");It&&K(Pe.id,It.id,{lat:Le.toFixed(6),lng:Ke.toFixed(6)}),de(!1)},ve=>{console.error("Error getting location:",ve),de(!1)})},ae=ve=>Array.isArray(ve)?ve:{HAZARD_CATEGORIES:Xae||[],SEVERITY_RATINGS:Yae||[],PROBABILITY_RATINGS:Kae||[],CONTROL_TYPES:Qae||[],SUBSTANDARD_ACTS:Array.isArray(W3)?W3.map(Ke=>({value:Ke,label:Ke})):[],SUBSTANDARD_CONDITIONS:Array.isArray(Z3)?Z3.map(Ke=>({value:Ke,label:Ke})):[],PERSONAL_FACTORS:Array.isArray(X3)?X3.map(Ke=>({value:Ke,label:Ke})):[],JOB_SYSTEM_FACTORS:Array.isArray(Y3)?Y3.map(Ke=>({value:Ke,label:Ke})):[]}[ve]||[],q=(ve,Le,Ke=null)=>{if(!ve.showIf)return!0;const Pe=ve.showIf.match(/(\w+)\s*(===|!==|>|<|>=|<=)\s*(.+)/);if(!Pe)return!0;const[,It,tt,zt]=Pe,vt=ge(Le,It,Ke);let Ot=zt.trim();switch(Ot==="true"?Ot=!0:Ot==="false"?Ot=!1:(Ot.startsWith('"')||Ot.startsWith("'"))&&(Ot=Ot.slice(1,-1)),tt){case"===":return vt===Ot;case"!==":return vt!==Ot;case">":return vt>Ot;case"<":return vt<Ot;case">=":return vt>=Ot;case"<=":return vt<=Ot;default:return!0}},oe=(ve,Le,Ke=null)=>{var tt,zt,vt,Ot,Et,yi;if(!q(ve,Le,Ke))return null;const Pe=ge(Le,ve.id,Ke),It=Ke!==null?`${Le}-${Ke}-${ve.id}`:`${Le}-${ve.id}`;switch(ve.type){case"text":return n.jsx("input",{type:"text",value:Pe,onChange:pt=>K(Le,ve.id,pt.target.value,Ke),className:"input",placeholder:ve.placeholder||""});case"auto_id":return n.jsx("input",{type:"text",value:Pe,className:"input bg-gray-50 font-mono text-sm",readOnly:!0});case"auto_increment":return n.jsx("input",{type:"text",value:Pe||(Ke!==null?Ke+1:1),className:"input bg-gray-50 font-mono text-sm w-20",readOnly:!0});case"battery_select":return n.jsx("input",{type:"text",value:Pe,onChange:pt=>K(Le,ve.id,pt.target.value,Ke),className:"input",placeholder:"Battery ID (e.g., BAT-001)"});case"yesno_text":const mi=Pe||{answer:null,details:""};return n.jsxs("div",{className:"space-y-2",children:[n.jsxs("div",{className:"flex gap-4",children:[n.jsxs("label",{className:`flex items-center gap-2 px-4 py-2 rounded-lg border cursor-pointer transition-colors ${mi.answer===!0?"bg-green-100 border-green-500 text-green-700":"hover:bg-gray-50"}`,children:[n.jsx("input",{type:"radio",name:It,checked:mi.answer===!0,onChange:()=>K(Le,ve.id,{...mi,answer:!0},Ke),className:"w-4 h-4"}),n.jsx("span",{children:"Yes"})]}),n.jsxs("label",{className:`flex items-center gap-2 px-4 py-2 rounded-lg border cursor-pointer transition-colors ${mi.answer===!1?"bg-red-100 border-red-500 text-red-700":"hover:bg-gray-50"}`,children:[n.jsx("input",{type:"radio",name:It,checked:mi.answer===!1,onChange:()=>K(Le,ve.id,{...mi,answer:!1},Ke),className:"w-4 h-4"}),n.jsx("span",{children:"No"})]})]}),mi.answer===!0&&n.jsx("textarea",{value:mi.details||"",onChange:pt=>K(Le,ve.id,{...mi,details:pt.target.value},Ke),className:"input",placeholder:"Please provide details...",rows:2})]});case"number":return n.jsx("input",{type:"number",value:Pe,onChange:pt=>K(Le,ve.id,pt.target.value,Ke),className:"input",min:ve.min,max:ve.max,step:ve.step});case"currency":return n.jsxs("div",{className:"relative",children:[n.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-500",children:"$"}),n.jsx("input",{type:"number",value:Pe,onChange:pt=>K(Le,ve.id,pt.target.value,Ke),className:"input pl-7",min:"0",step:"0.01"})]});case"phone":return n.jsxs("div",{className:"relative",children:[n.jsx(Hd,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),n.jsx("input",{type:"tel",value:Pe,onChange:pt=>K(Le,ve.id,pt.target.value,Ke),className:"input pl-10",placeholder:"(555) 555-5555"})]});case"date":return n.jsx("input",{type:"date",value:Pe||"",onChange:pt=>K(Le,ve.id,pt.target.value,Ke),className:"input"});case"time":return n.jsx("input",{type:"time",value:Pe||"",onChange:pt=>K(Le,ve.id,pt.target.value,Ke),className:"input"});case"datetime":return n.jsx("input",{type:"datetime-local",value:Pe||"",onChange:pt=>K(Le,ve.id,pt.target.value,Ke),className:"input"});case"textarea":return n.jsx("textarea",{value:Pe,onChange:pt=>K(Le,ve.id,pt.target.value,Ke),className:"input min-h-[80px]",rows:ve.rows||3,placeholder:ve.placeholder||""});case"select":const ht=ae(ve.options);return n.jsxs("select",{value:Pe,onChange:pt=>K(Le,ve.id,pt.target.value,Ke),className:"input",children:[n.jsx("option",{value:"",children:"Select..."}),ht.map(pt=>n.jsxs("option",{value:pt.value,children:[pt.label,pt.description&&` - ${pt.description}`]},pt.value))]});case"multiselect":const hi=ae(ve.options),ni=Pe||[];return n.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto border rounded-lg p-2",children:hi.map(pt=>n.jsxs("label",{className:"flex items-start gap-2 cursor-pointer p-1 hover:bg-gray-50 rounded",children:[n.jsx("input",{type:"checkbox",checked:ni.includes(pt.value||pt),onChange:oi=>{const Mi=pt.value||pt;oi.target.checked?K(Le,ve.id,[...ni,Mi],Ke):K(Le,ve.id,ni.filter(qi=>qi!==Mi),Ke)},className:"w-4 h-4 rounded mt-0.5"}),n.jsx("span",{className:"text-sm",children:pt.label||pt})]},pt.value||pt))});case"multiselect_text":const ui=ae(ve.options)||[],Fi=Pe||{selected:[],other:""};return n.jsxs("div",{className:"space-y-2",children:[n.jsx("div",{className:"max-h-40 overflow-y-auto border rounded-lg p-2",children:ui.map(pt=>n.jsxs("label",{className:"flex items-start gap-2 cursor-pointer p-1 hover:bg-gray-50 rounded",children:[n.jsx("input",{type:"checkbox",checked:(Fi.selected||[]).includes(pt.value||pt),onChange:oi=>{const Mi=pt.value||pt,qi=Fi.selected||[],Xn=oi.target.checked?[...qi,Mi]:qi.filter(mr=>mr!==Mi);K(Le,ve.id,{...Fi,selected:Xn},Ke)},className:"w-4 h-4 rounded mt-0.5"}),n.jsx("span",{className:"text-sm",children:pt.label||pt})]},pt.value||pt))}),n.jsx("input",{type:"text",value:Fi.other||"",onChange:pt=>K(Le,ve.id,{...Fi,other:pt.target.value},Ke),className:"input",placeholder:"Other (please specify)"})]});case"yesno":return n.jsxs("div",{className:"flex gap-4",children:[n.jsxs("label",{className:`flex items-center gap-2 px-4 py-2 rounded-lg border cursor-pointer transition-colors ${Pe===!0?"bg-green-100 border-green-500 text-green-700":"hover:bg-gray-50"}`,children:[n.jsx("input",{type:"radio",name:It,checked:Pe===!0,onChange:()=>K(Le,ve.id,!0,Ke),className:"w-4 h-4"}),n.jsx("span",{children:"Yes"})]}),n.jsxs("label",{className:`flex items-center gap-2 px-4 py-2 rounded-lg border cursor-pointer transition-colors ${Pe===!1?"bg-red-100 border-red-500 text-red-700":"hover:bg-gray-50"}`,children:[n.jsx("input",{type:"radio",name:It,checked:Pe===!1,onChange:()=>K(Le,ve.id,!1,Ke),className:"w-4 h-4"}),n.jsx("span",{children:"No"})]})]});case"yesno_conditional":return n.jsxs("div",{className:"flex gap-4",children:[n.jsxs("label",{className:`flex items-center gap-2 px-4 py-2 rounded-lg border cursor-pointer transition-colors ${Pe===!0?"bg-green-100 border-green-500 text-green-700":"hover:bg-gray-50"}`,children:[n.jsx("input",{type:"radio",name:It,checked:Pe===!0,onChange:()=>K(Le,ve.id,!0,Ke),className:"w-4 h-4"}),n.jsx("span",{children:"Yes"})]}),n.jsxs("label",{className:`flex items-center gap-2 px-4 py-2 rounded-lg border cursor-pointer transition-colors ${Pe===!1?"bg-red-100 border-red-500 text-red-700":"hover:bg-gray-50"}`,children:[n.jsx("input",{type:"radio",name:It,checked:Pe===!1,onChange:()=>K(Le,ve.id,!1,Ke),className:"w-4 h-4"}),n.jsx("span",{children:"No"})]})]});case"checkbox":return n.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[n.jsx("input",{type:"checkbox",checked:Pe===!0,onChange:pt=>K(Le,ve.id,pt.target.checked,Ke),className:"w-5 h-5 rounded"}),n.jsx("span",{className:"text-sm",children:ve.checkboxLabel||"Confirmed"})]});case"checklist":const Ii=ae(ve.options)||ve.items||[],Bi=Pe||{};return n.jsx("div",{className:"space-y-2",children:Ii.map(pt=>n.jsxs("label",{className:"flex items-start gap-2 cursor-pointer p-2 rounded hover:bg-gray-50",children:[n.jsx("input",{type:"checkbox",checked:Bi[pt.value]===!0,onChange:oi=>K(Le,ve.id,{...Bi,[pt.value]:oi.target.checked},Ke),className:"w-4 h-4 rounded mt-0.5"}),n.jsx("span",{className:"text-sm",children:pt.label})]},pt.value))});case"operator_select":case"user_auto":return n.jsxs("select",{value:Pe,onChange:pt=>K(Le,ve.id,pt.target.value,Ke),className:"input",children:[n.jsx("option",{value:"",children:"Select person..."}),(Array.isArray(c)?c:[]).map(pt=>n.jsx("option",{value:pt.id,children:pt.name},pt.id))]});case"crew_multi_select":const Ki=Pe||[];return n.jsxs("div",{className:"space-y-2",children:[n.jsx("div",{className:"flex flex-wrap gap-2",children:Ki.map(pt=>{const oi=c.find(Mi=>Mi.id===pt);return oi?n.jsxs("span",{className:"px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-sm flex items-center gap-1",children:[oi.name,n.jsx("button",{onClick:()=>K(Le,ve.id,Ki.filter(Mi=>Mi!==pt),Ke),className:"hover:text-blue-900",children:n.jsx(cs,{className:"w-3 h-3"})})]},pt):null})}),n.jsxs("select",{value:"",onChange:pt=>{pt.target.value&&!Ki.includes(pt.target.value)&&K(Le,ve.id,[...Ki,pt.target.value],Ke)},className:"input",children:[n.jsx("option",{value:"",children:"Add crew member..."}),(Array.isArray(c)?c:[]).filter(pt=>!Ki.includes(pt.id)).map(pt=>n.jsx("option",{value:pt.id,children:pt.name},pt.id))]})]});case"aircraft_select":return n.jsxs("select",{value:Pe,onChange:pt=>K(Le,ve.id,pt.target.value,Ke),className:"input",children:[n.jsx("option",{value:"",children:"Select aircraft..."}),(Array.isArray(h)?h:[]).map(pt=>n.jsxs("option",{value:pt.id,children:[pt.nickname||pt.model," - ",pt.serialNumber]},pt.id))]});case"equipment_select":return n.jsx("input",{type:"text",value:Pe,onChange:pt=>K(Le,ve.id,pt.target.value,Ke),className:"input",placeholder:"Equipment ID or description"});case"incident_select":const nn=(Array.isArray(r==null?void 0:r.forms)?r.forms:[]).filter(pt=>pt.templateId==="incident_report");return n.jsxs("select",{value:Pe,onChange:pt=>K(Le,ve.id,pt.target.value,Ke),className:"input",children:[n.jsx("option",{value:"",children:"Select incident report..."}),nn.map(pt=>{var oi,Mi,qi,Xn;return n.jsxs("option",{value:pt.id,children:[((Mi=(oi=pt.data)==null?void 0:oi.header)==null?void 0:Mi.form_id)||pt.id," - ",((Xn=(qi=pt.data)==null?void 0:qi.occurrence)==null?void 0:Xn.occurrence_date)||"No date"]},pt.id)})]});case"project_select":return n.jsx("input",{type:"text",value:(r==null?void 0:r.name)||"",className:"input bg-gray-50",readOnly:!0});case"gps":const Gn=Pe||{};return n.jsxs("div",{className:"space-y-2",children:[n.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[n.jsxs("div",{children:[n.jsx("label",{className:"text-xs text-gray-500",children:"Latitude"}),n.jsx("input",{type:"text",value:Gn.lat||"",onChange:pt=>K(Le,ve.id,{...Gn,lat:pt.target.value},Ke),className:"input font-mono text-sm",placeholder:"e.g., 49.2827"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"text-xs text-gray-500",children:"Longitude"}),n.jsx("input",{type:"text",value:Gn.lng||"",onChange:pt=>K(Le,ve.id,{...Gn,lng:pt.target.value},Ke),className:"input font-mono text-sm",placeholder:"e.g., -123.1207"})]})]}),n.jsxs("button",{onClick:ne,disabled:se,className:"btn-secondary text-sm flex items-center gap-2",children:[se?n.jsx(Ro,{className:"w-4 h-4 animate-spin"}):n.jsx(Wn,{className:"w-4 h-4"}),se?"Getting Location...":"Use Current Location"]})]});case"weather_conditions":const Tr=Pe||{};return n.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-3",children:[n.jsxs("div",{children:[n.jsx("label",{className:"text-xs text-gray-500",children:"Temperature (C)"}),n.jsx("input",{type:"number",value:Tr.temp||"",onChange:pt=>K(Le,ve.id,{...Tr,temp:pt.target.value},Ke),className:"input"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"text-xs text-gray-500",children:"Wind (km/h)"}),n.jsx("input",{type:"number",value:Tr.wind||"",onChange:pt=>K(Le,ve.id,{...Tr,wind:pt.target.value},Ke),className:"input"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"text-xs text-gray-500",children:"Visibility"}),n.jsxs("select",{value:Tr.visibility||"",onChange:pt=>K(Le,ve.id,{...Tr,visibility:pt.target.value},Ke),className:"input",children:[n.jsx("option",{value:"",children:"Select..."}),n.jsx("option",{value:"good",children:"Good (>5km)"}),n.jsx("option",{value:"moderate",children:"Moderate (1-5km)"}),n.jsx("option",{value:"poor",children:"Poor (<1km)"})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"text-xs text-gray-500",children:"Conditions"}),n.jsxs("select",{value:Tr.conditions||"",onChange:pt=>K(Le,ve.id,{...Tr,conditions:pt.target.value},Ke),className:"input",children:[n.jsx("option",{value:"",children:"Select..."}),n.jsx("option",{value:"clear",children:"Clear"}),n.jsx("option",{value:"cloudy",children:"Cloudy"}),n.jsx("option",{value:"rain",children:"Rain"}),n.jsx("option",{value:"snow",children:"Snow"}),n.jsx("option",{value:"fog",children:"Fog"})]})]})]});case"signature":return n.jsx("div",{className:`border-2 rounded-lg p-4 text-center ${Pe?"border-green-300 bg-green-50":"border-dashed border-gray-300"}`,children:Pe?n.jsxs("div",{className:"space-y-1",children:[n.jsx(qr,{className:"w-8 h-8 text-green-500 mx-auto"}),n.jsx("p",{className:"text-sm font-medium text-gray-700",children:Pe.name}),n.jsx("p",{className:"text-xs text-gray-500",children:new Date(Pe.timestamp).toLocaleString()}),n.jsx("button",{onClick:()=>K(Le,ve.id,null,Ke),className:"text-xs text-red-500 hover:underline mt-2",children:"Clear signature"})]}):n.jsxs("button",{onClick:()=>{var oi;const pt=((oi=c.find(Mi=>{var qi;return Mi.id===((qi=C.header)==null?void 0:qi.pic)}))==null?void 0:oi.name)||"User";K(Le,ve.id,{name:pt,timestamp:new Date().toISOString()},Ke)},className:"w-full py-4 text-sm text-aeria-blue hover:bg-blue-50 rounded transition-colors",children:[n.jsx(fa,{className:"w-6 h-6 mx-auto mb-1 opacity-50"}),"Click to sign"]})});case"multi_signature":case"crew_multi_signature":const jt=Pe||[];return n.jsxs("div",{className:"space-y-3",children:[jt.length>0&&n.jsx("div",{className:"space-y-2",children:jt.map((pt,oi)=>n.jsxs("div",{className:"flex items-center justify-between p-2 bg-green-50 border border-green-200 rounded",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(qr,{className:"w-4 h-4 text-green-500"}),n.jsx("span",{className:"text-sm font-medium",children:pt.name}),n.jsx("span",{className:"text-xs text-gray-500",children:new Date(pt.timestamp).toLocaleTimeString()})]}),n.jsx("button",{onClick:()=>K(Le,ve.id,jt.filter((Mi,qi)=>qi!==oi),Ke),className:"text-red-500 hover:text-red-700",children:n.jsx(cs,{className:"w-4 h-4"})})]},oi))}),n.jsxs("div",{className:"flex gap-2",children:[n.jsxs("select",{id:`${It}-select`,className:"input flex-1",defaultValue:"",children:[n.jsx("option",{value:"",children:"Select person to sign..."}),(Array.isArray(c)?c:[]).filter(pt=>!jt.find(oi=>oi.id===pt.id)).map(pt=>n.jsx("option",{value:pt.id,children:pt.name},pt.id))]}),n.jsx("button",{onClick:()=>{const pt=document.getElementById(`${It}-select`);if(pt!=null&&pt.value){const oi=c.find(Mi=>Mi.id===pt.value);oi&&(K(Le,ve.id,[...jt,{id:oi.id,name:oi.name,timestamp:new Date().toISOString()}],Ke),pt.value="")}},className:"btn-secondary",children:"Add Signature"})]})]});case"risk_matrix":const bi=ve.id.includes("residual")?"residual_severity":"severity",ar=ve.id.includes("residual")?"residual_probability":"probability",li=ve.id.includes("potential")?"potential_severity":bi,ai=ve.id.includes("potential")?"potential_probability":ar,Jt=ge(Le,bi,Ke)||ge(Le,li,Ke),Vi=ge(Le,ar,Ke)||ge(Le,ai,Ke),fi=Jae(Jt,Vi);return n.jsx("div",{className:`px-4 py-2 rounded-lg font-medium text-center ${K3[fi]}`,children:fi.toUpperCase()});case"file_upload":const vi=Pe||[];return n.jsxs("div",{className:"space-y-2",children:[n.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-aeria-blue transition-colors",children:[n.jsx(_2,{className:"w-8 h-8 mx-auto text-gray-400 mb-2"}),n.jsx("p",{className:"text-sm text-gray-500",children:ve.multiple?"Drop files here or click to upload":"Drop file here or click to upload"}),n.jsx("input",{type:"file",accept:ve.accept||"*",multiple:ve.multiple,className:"hidden",id:It,onChange:pt=>{const oi=Array.from(pt.target.files).map(Mi=>({name:Mi.name,size:Mi.size,type:Mi.type,uploadedAt:new Date().toISOString()}));K(Le,ve.id,ve.multiple?[...vi,...oi]:oi,Ke)}}),n.jsx("label",{htmlFor:It,className:"btn-secondary mt-2 cursor-pointer inline-block",children:"Browse Files"})]}),vi.length>0&&n.jsx("div",{className:"space-y-1",children:vi.map((pt,oi)=>n.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-50 rounded",children:[n.jsx("span",{className:"text-sm truncate",children:pt.name}),n.jsx("button",{onClick:()=>K(Le,ve.id,vi.filter((Mi,qi)=>qi!==oi),Ke),className:"text-red-500 hover:text-red-700",children:n.jsx(cs,{className:"w-4 h-4"})})]},oi))})]});case"photo_capture":const Pi=Pe||[];return n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[n.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-aeria-blue transition-colors",children:[n.jsx(bl,{className:"w-8 h-8 mx-auto text-gray-400 mb-2"}),n.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"Take Photo"}),n.jsx("input",{type:"file",accept:"image/*",capture:"environment",className:"hidden",id:`${It}-camera`,onChange:pt=>{var oi;if((oi=pt.target.files)!=null&&oi[0]){const Mi=pt.target.files[0],qi=new FileReader;qi.onload=Xn=>{const mr={id:`photo-${Date.now()}`,name:Mi.name,type:Mi.type,size:Mi.size,data:Xn.target.result,capturedAt:new Date().toISOString(),gps:null,annotation:""};navigator.geolocation?navigator.geolocation.getCurrentPosition(sn=>{mr.gps={lat:sn.coords.latitude.toFixed(6),lng:sn.coords.longitude.toFixed(6)},K(Le,ve.id,[...Pi,mr],Ke)},()=>{K(Le,ve.id,[...Pi,mr],Ke)}):K(Le,ve.id,[...Pi,mr],Ke)},qi.readAsDataURL(Mi)}}}),n.jsxs("label",{htmlFor:`${It}-camera`,className:"btn-secondary text-xs cursor-pointer",children:[n.jsx(bl,{className:"w-3 h-3 inline mr-1"}),"Camera"]})]}),n.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-aeria-blue transition-colors",children:[n.jsx(_2,{className:"w-8 h-8 mx-auto text-gray-400 mb-2"}),n.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"Upload Photo"}),n.jsx("input",{type:"file",accept:"image/*",multiple:!0,className:"hidden",id:`${It}-upload`,onChange:pt=>{Array.from(pt.target.files).forEach(oi=>{const Mi=new FileReader;Mi.onload=qi=>{var mr;const Xn={id:`photo-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,name:oi.name,type:oi.type,size:oi.size,data:qi.target.result,capturedAt:new Date().toISOString(),gps:null,annotation:""};K(Le,ve.id,[...((mr=C[Le])==null?void 0:mr[ve.id])||[],Xn],Ke)},Mi.readAsDataURL(oi)})}}),n.jsxs("label",{htmlFor:`${It}-upload`,className:"btn-secondary text-xs cursor-pointer",children:[n.jsx(_2,{className:"w-3 h-3 inline mr-1"}),"Browse"]})]})]}),Pi.length>0&&n.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-2",children:Pi.map((pt,oi)=>n.jsxs("div",{className:"relative group",children:[n.jsx("img",{src:pt.data,alt:pt.name||`Photo ${oi+1}`,className:"w-full h-24 object-cover rounded-lg border"}),n.jsxs("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded-lg flex items-center justify-center gap-2",children:[n.jsx("button",{onClick:()=>{const Mi=prompt("Add annotation:",pt.annotation||"");if(Mi!==null){const qi=[...Pi];qi[oi]={...pt,annotation:Mi},K(Le,ve.id,qi,Ke)}},className:"p-1.5 bg-white rounded-full text-gray-700 hover:bg-blue-100",title:"Add annotation",children:n.jsx(wT,{className:"w-3 h-3"})}),n.jsx("button",{onClick:()=>K(Le,ve.id,Pi.filter((Mi,qi)=>qi!==oi),Ke),className:"p-1.5 bg-white rounded-full text-red-500 hover:bg-red-100",title:"Delete",children:n.jsx(cs,{className:"w-3 h-3"})})]}),pt.gps&&n.jsxs("div",{className:"absolute bottom-1 left-1 px-1.5 py-0.5 bg-black/70 rounded text-white text-[10px] flex items-center gap-1",children:[n.jsx(Wn,{className:"w-2.5 h-2.5"}),"GPS"]}),pt.annotation&&n.jsx("div",{className:"absolute bottom-1 right-1 px-1.5 py-0.5 bg-blue-600/90 rounded text-white text-[10px]",children:"Note"})]},pt.id||oi))}),Pi.length>0&&n.jsxs("p",{className:"text-xs text-gray-500",children:[Pi.length," photo",Pi.length!==1?"s":""," captured"]})]});case"repeatable_text":const Nr=Pe||[];return n.jsxs("div",{className:"space-y-2",children:[Nr.map((pt,oi)=>n.jsxs("div",{className:"flex gap-2",children:[n.jsx("input",{type:"text",value:pt,onChange:Mi=>{const qi=[...Nr];qi[oi]=Mi.target.value,K(Le,ve.id,qi,Ke)},className:"input flex-1",placeholder:ve.placeholder||`Item ${oi+1}`}),n.jsx("button",{onClick:()=>K(Le,ve.id,Nr.filter((Mi,qi)=>qi!==oi),Ke),className:"p-2 text-red-500 hover:bg-red-50 rounded",children:n.jsx(cs,{className:"w-4 h-4"})})]},oi)),n.jsxs("button",{onClick:()=>K(Le,ve.id,[...Nr,""],Ke),className:"btn-secondary text-sm flex items-center gap-1",children:[n.jsx(vr,{className:"w-4 h-4"}),"Add ",ve.itemLabel||"Item"]})]});case"repeatable_person":const er=Pe||[];return n.jsxs("div",{className:"space-y-3",children:[er.map((pt,oi)=>n.jsxs("div",{className:"p-3 border rounded-lg bg-gray-50 relative",children:[n.jsx("button",{onClick:()=>K(Le,ve.id,er.filter((Mi,qi)=>qi!==oi),Ke),className:"absolute top-2 right-2 p-1 text-red-500 hover:bg-red-100 rounded",children:n.jsx(cs,{className:"w-4 h-4"})}),n.jsxs("div",{className:"grid sm:grid-cols-3 gap-2",children:[n.jsx("input",{type:"text",value:pt.name||"",onChange:Mi=>{const qi=[...er];qi[oi]={...pt,name:Mi.target.value},K(Le,ve.id,qi,Ke)},className:"input",placeholder:"Name"}),n.jsx("input",{type:"text",value:pt.role||"",onChange:Mi=>{const qi=[...er];qi[oi]={...pt,role:Mi.target.value},K(Le,ve.id,qi,Ke)},className:"input",placeholder:"Role"}),n.jsx("input",{type:"text",value:pt.contact||"",onChange:Mi=>{const qi=[...er];qi[oi]={...pt,contact:Mi.target.value},K(Le,ve.id,qi,Ke)},className:"input",placeholder:"Contact info"})]})]},oi)),n.jsxs("button",{onClick:()=>K(Le,ve.id,[...er,{name:"",role:"",contact:""}],Ke),className:"btn-secondary text-sm flex items-center gap-1",children:[n.jsx(vr,{className:"w-4 h-4"}),"Add Person"]})]});case"repeatable_witness":const Wr=Pe||[];return n.jsxs("div",{className:"space-y-3",children:[Wr.map((pt,oi)=>n.jsxs("div",{className:"p-3 border rounded-lg bg-gray-50 relative",children:[n.jsx("button",{onClick:()=>K(Le,ve.id,Wr.filter((Mi,qi)=>qi!==oi),Ke),className:"absolute top-2 right-2 p-1 text-red-500 hover:bg-red-100 rounded",children:n.jsx(cs,{className:"w-4 h-4"})}),n.jsxs("div",{className:"space-y-2",children:[n.jsx("input",{type:"text",value:pt.name||"",onChange:Mi=>{const qi=[...Wr];qi[oi]={...pt,name:Mi.target.value},K(Le,ve.id,qi,Ke)},className:"input",placeholder:"Witness name"}),n.jsx("textarea",{value:pt.statement||"",onChange:Mi=>{const qi=[...Wr];qi[oi]={...pt,statement:Mi.target.value},K(Le,ve.id,qi,Ke)},className:"input",rows:2,placeholder:"Statement summary"})]})]},oi)),n.jsxs("button",{onClick:()=>K(Le,ve.id,[...Wr,{name:"",statement:""}],Ke),className:"btn-secondary text-sm flex items-center gap-1",children:[n.jsx(vr,{className:"w-4 h-4"}),"Add Witness"]})]});case"hazard_summary":const kr=((tt=r==null?void 0:r.hseRisk)==null?void 0:tt.hazards)||((zt=r==null?void 0:r.siteSurvey)==null?void 0:zt.hazards)||[];return kr.length===0?n.jsx("p",{className:"text-sm text-gray-500 italic",children:"No hazards identified in project assessment"}):n.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:kr.map((pt,oi)=>{var Mi;return n.jsxs("div",{className:"p-2 bg-amber-50 border border-amber-200 rounded text-sm",children:[n.jsxs("span",{className:"font-medium",children:[pt.category||pt.type,":"]})," ",pt.description||pt.hazard,pt.risk&&n.jsx("span",{className:`ml-2 px-2 py-0.5 rounded text-xs ${K3[(Mi=pt.risk)==null?void 0:Mi.toLowerCase()]||"bg-gray-200"}`,children:pt.risk})]},oi)})});case"control_summary":const di=((vt=r==null?void 0:r.hseRisk)==null?void 0:vt.controls)||((Ot=r==null?void 0:r.siteSurvey)==null?void 0:Ot.controls)||[];return di.length===0?n.jsx("p",{className:"text-sm text-gray-500 italic",children:"No controls defined in project assessment"}):n.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:di.map((pt,oi)=>n.jsxs("div",{className:"p-2 bg-green-50 border border-green-200 rounded text-sm",children:[n.jsxs("span",{className:"font-medium",children:[pt.type||"Control",":"]})," ",pt.description||pt.control]},oi))});case"contact_summary":const or=((Et=r==null?void 0:r.emergency)==null?void 0:Et.contacts)||[],jn=[{role:"Emergency Services",number:"911"},{role:"Poison Control",number:"1-800-567-8911"},{role:"Aeria Accountable Executive",number:((yi=qm==null?void 0:qm.AERIA_INTERNAL)==null?void 0:yi.phone)||"604-849-2345"}],Da=or.length>0?or:jn;return n.jsx("div",{className:"space-y-2",children:Da.map((pt,oi)=>n.jsxs("div",{className:"flex items-center justify-between p-2 bg-blue-50 border border-blue-200 rounded",children:[n.jsx("span",{className:"text-sm font-medium",children:pt.role||pt.name}),n.jsxs("span",{className:"text-sm font-mono flex items-center gap-1",children:[n.jsx(a3,{className:"w-3 h-3"}),pt.number||pt.phone]})]},oi))});case"calculated":let ms="Auto-calculated";if(ve.id==="flight_duration"){const pt=ge(Le,"takeoff_time",Ke),oi=ge(Le,"landing_time",Ke);ms=ioe(pt,oi)||"Enter times"}else if(ve.id==="total_flights"){const pt=C.flights||[];ms=`${pt.length} flight${pt.length!==1?"s":""}`}else if(ve.id==="total_flight_time"){const pt=C.flights||[];let oi=0;pt.forEach(Xn=>{if(Xn.takeoff_time&&Xn.landing_time){const[mr,sn]=Xn.takeoff_time.split(":").map(Number),[al,Ma]=Xn.landing_time.split(":").map(Number);let fs=al*60+Ma-(mr*60+sn);fs<0&&(fs+=24*60),oi+=fs}});const Mi=Math.floor(oi/60),qi=oi%60;ms=pt.length>0?`${Mi}h ${qi}m`:"No flights"}else if(ve.id==="renewal_required"){const pt=ge(Le,"expiry_date",Ke),oi=roe(pt);if(oi==="EXPIRED")return n.jsx("div",{className:"px-3 py-2 bg-red-100 text-red-700 rounded font-medium",children:"EXPIRED"});if(oi==="DUE SOON")return n.jsx("div",{className:"px-3 py-2 bg-amber-100 text-amber-700 rounded font-medium",children:"Renewal Due Soon"});ms=oi||"Enter expiry date"}else if(ve.id==="rpas_weight"){const pt=ge("rpas_info","aircraft",Ke),oi=h.find(Mi=>Mi.id===pt);ms=oi!=null&&oi.weight?`${oi.weight} kg`:"Select aircraft"}else if(ve.id==="registration"){const pt=ge("rpas_info","aircraft",Ke),oi=h.find(Mi=>Mi.id===pt);ms=(oi==null?void 0:oi.registration)||"Select aircraft"}else if(ve.id==="pic_cert"){const pt=ge("personnel","pic",Ke),oi=c.find(Mi=>Mi.id===pt);ms=(oi==null?void 0:oi.certNumber)||"Select PIC"}return n.jsx("div",{className:"input bg-gray-50 text-gray-700",children:ms});default:return n.jsx("input",{type:"text",value:Pe,onChange:pt=>K(Le,ve.id,pt.target.value,Ke),className:"input",placeholder:ve.placeholder||""})}},ke=()=>{const ve=C.classification||{},Le=noe(ve),Ke=Le.some(Pe=>Pe.severity==="critical");return n.jsxs("div",{className:"space-y-4",children:[Ke&&n.jsx("div",{className:"p-4 bg-red-600 text-white rounded-lg animate-pulse",children:n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx(Wc,{className:"w-8 h-8"}),n.jsxs("div",{children:[n.jsx("h4",{className:"font-bold text-lg",children:"IMMEDIATE ACTION REQUIRED"}),n.jsx("p",{className:"text-sm",children:"Based on your answers, regulatory notification is required IMMEDIATELY"})]})]})}),n.jsx("div",{className:"space-y-3",children:Le.map((Pe,It)=>{var tt;return n.jsx("div",{className:`p-4 rounded-lg border-2 ${Pe.severity==="critical"?"bg-red-50 border-red-500":Pe.severity==="high"?"bg-orange-50 border-orange-400":"bg-blue-50 border-blue-300"}`,children:n.jsxs("div",{className:"flex items-start gap-3",children:[n.jsx("div",{className:`p-2 rounded-full ${Pe.severity==="critical"?"bg-red-500 text-white":Pe.severity==="high"?"bg-orange-500 text-white":"bg-blue-500 text-white"}`,children:Pe.severity==="critical"?n.jsx(jv,{className:"w-5 h-5"}):n.jsx(ir,{className:"w-5 h-5"})}),n.jsxs("div",{className:"flex-1",children:[n.jsx("h4",{className:"font-semibold text-gray-900",children:Pe.label}),Pe.phone&&n.jsxs("p",{className:"text-lg font-mono font-bold mt-1 flex items-center gap-2",children:[n.jsx(a3,{className:"w-4 h-4"}),Pe.phone,Pe.altPhone&&n.jsxs("span",{className:"text-sm font-normal",children:["or ",Pe.altPhone]})]}),n.jsx("p",{className:"text-sm text-gray-600 mt-2",children:Pe.instructions}),n.jsxs("label",{className:"flex items-center gap-2 mt-3 cursor-pointer",children:[n.jsx("input",{type:"checkbox",checked:((tt=C.notification_checklist)==null?void 0:tt[Pe.key])===!0,onChange:zt=>K("notification_checklist",Pe.key,zt.target.checked),className:"w-5 h-5 rounded"}),n.jsx("span",{className:"text-sm font-medium",children:Pe.key==="AERIA_INTERNAL"?"Accountable Executive notified":"Notification completed"})]})]})]})},Pe.key)})})]})},Ve=(ve,Le)=>{var Pe;const Ke=F===Le;if(ve.type==="trigger_checklist")return n.jsxs("div",{className:`${Ke?"":"hidden"}`,children:[ve.description&&n.jsx("p",{className:"text-sm text-gray-600 bg-blue-50 p-3 rounded-lg mb-4",children:ve.description}),ke()]},ve.id);if(ve.repeatable){const It=C[ve.id]||[];return n.jsx("div",{className:`${Ke?"":"hidden"}`,children:n.jsxs("div",{className:"space-y-4",children:[It.length===0&&n.jsx("p",{className:"text-sm text-gray-500 italic",children:"No items added yet"}),It.map((tt,zt)=>{var vt,Ot;return n.jsxs("div",{className:"p-4 border rounded-lg bg-gray-50 relative",children:[n.jsx("div",{className:"absolute top-2 right-2",children:n.jsx("button",{onClick:()=>Te(ve.id,zt),className:"p-1 text-red-500 hover:bg-red-100 rounded",children:n.jsx(Ln,{className:"w-4 h-4"})})}),n.jsxs("h4",{className:"text-sm font-medium text-gray-700 mb-3",children:[((vt=ve.repeatLabel)==null?void 0:vt.replace("Add ",""))||"Item"," #",zt+1]}),n.jsx("div",{className:"grid gap-4",children:(Ot=ve.fields)==null?void 0:Ot.map(Et=>n.jsxs("div",{children:[n.jsxs("label",{className:"label flex items-center gap-1",children:[Et.label,Et.required&&n.jsx("span",{className:"text-red-500",children:"*"}),Et.helpText&&n.jsxs("span",{className:"text-xs text-gray-400 ml-1",children:["(",Et.helpText,")"]})]}),oe(Et,ve.id,zt)]},Et.id))})]},zt)}),n.jsxs("button",{onClick:()=>Ae(ve.id),className:"btn-secondary w-full flex items-center justify-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),ve.repeatLabel||"Add Item"]})]})},ve.id)}return n.jsxs("div",{className:`space-y-4 ${Ke?"":"hidden"}`,children:[ve.description&&n.jsx("p",{className:"text-sm text-gray-600 bg-blue-50 p-3 rounded-lg",children:ve.description}),(Pe=ve.fields)==null?void 0:Pe.map(It=>q(It,ve.id)?n.jsxs("div",{children:[n.jsxs("label",{className:"label flex items-center gap-1",children:[It.label,It.required&&n.jsx("span",{className:"text-red-500",children:"*"})]}),It.helpText&&n.jsx("p",{className:"text-xs text-gray-500 mb-1",children:It.helpText}),oe(It,ve.id)]},It.id):null)]},ve.id)},ie=Array.isArray(e.sections)?e.sections:[];ie[F];const ze=Xj[e.icon]||rs;return ie.length===0?n.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:n.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-md p-6 text-center",children:[n.jsx(Cs,{className:"w-12 h-12 text-amber-500 mx-auto mb-4"}),n.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Form Not Yet Available"}),n.jsxs("p",{className:"text-sm text-gray-500 mt-2",children:['The "',e.name,`" form template doesn't have any sections defined yet.`]}),n.jsxs("div",{className:"flex gap-2 justify-center mt-6",children:[o&&n.jsx("button",{onClick:o,className:"btn-secondary",children:"Back to Library"}),n.jsx("button",{onClick:w,className:"btn-primary",children:"Close"})]})]})}):n.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:n.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[95vh] flex flex-col",children:[n.jsxs("div",{className:"p-4 border-b flex items-center justify-between bg-gradient-to-r from-aeria-blue to-blue-600 text-white rounded-t-xl",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx(ze,{className:"w-6 h-6"}),n.jsxs("div",{children:[n.jsx("h2",{className:"text-lg font-semibold",children:e.name}),n.jsx("p",{className:"text-sm text-blue-100",children:e.description})]})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[o&&n.jsxs("button",{onClick:o,className:"px-3 py-1.5 text-sm bg-white/20 hover:bg-white/30 rounded-lg transition-colors flex items-center gap-1",children:[n.jsx(e3,{className:"w-4 h-4"}),"Back to Library"]}),n.jsx("button",{onClick:w,className:"p-2 hover:bg-white/20 rounded-lg transition-colors",children:n.jsx(cs,{className:"w-5 h-5"})})]})]}),n.jsx("div",{className:"border-b bg-gray-50 px-4 overflow-x-auto",children:n.jsx("div",{className:"flex gap-1 py-2",children:ie.map((ve,Le)=>n.jsxs("button",{onClick:()=>$(Le),className:`px-4 py-2 text-sm font-medium rounded-lg whitespace-nowrap transition-colors ${F===Le?"bg-white text-aeria-blue shadow":"text-gray-600 hover:bg-white/50"}`,children:[n.jsxs("span",{className:"mr-2",children:[Le+1,"."]}),ve.title]},ve.id))})}),n.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:ie.map((ve,Le)=>Ve(ve,Le))}),n.jsxs("div",{className:"p-4 border-t bg-gray-50 flex items-center justify-between",children:[n.jsxs("div",{className:"flex gap-2",children:[n.jsxs("button",{onClick:()=>$(Math.max(0,F-1)),disabled:F===0,className:"btn-secondary flex items-center gap-1 disabled:opacity-50",children:[n.jsx(e3,{className:"w-4 h-4"}),"Previous"]}),n.jsxs("button",{onClick:()=>$(Math.min(ie.length-1,F+1)),disabled:F===ie.length-1,className:"btn-secondary flex items-center gap-1 disabled:opacity-50",children:["Next",n.jsx(ko,{className:"w-4 h-4"})]})]}),n.jsxs("div",{className:"flex gap-2",children:[n.jsxs("button",{onClick:()=>Ce(!1),className:"btn-secondary flex items-center gap-2",children:[n.jsx(tb,{className:"w-4 h-4"}),"Save Draft"]}),n.jsxs("button",{onClick:()=>Ce(!0),className:"btn-primary flex items-center gap-2",children:[n.jsx(qr,{className:"w-4 h-4"}),"Complete Form"]})]})]})]})})}function aoe({onSelectForm:t,onClose:e}){const[r,c]=ue.useState(""),[h,x]=ue.useState("all"),w=toe()||[],o=Array.isArray(w)?w.filter(C=>{if(!C)return!1;const R=!r||(C.name||"").toLowerCase().includes(r.toLowerCase())||(C.description||"").toLowerCase().includes(r.toLowerCase()),F=h==="all"||C.category===h;return R&&F}):[];return n.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:n.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col",children:[n.jsxs("div",{className:"p-4 border-b flex items-center justify-between",children:[n.jsxs("h2",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[n.jsx(Ll,{className:"w-5 h-5 text-aeria-blue"}),"Form Library"]}),n.jsx("button",{onClick:e,className:"p-2 hover:bg-gray-100 rounded-lg",children:n.jsx(cs,{className:"w-5 h-5"})})]}),n.jsxs("div",{className:"p-4 border-b space-y-3",children:[n.jsxs("div",{className:"relative",children:[n.jsx(nu,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),n.jsx("input",{type:"text",value:r,onChange:C=>c(C.target.value),placeholder:"Search forms...",className:"input pl-10"})]}),n.jsxs("div",{className:"flex flex-wrap gap-2",children:[n.jsx("button",{onClick:()=>x("all"),className:`px-3 py-1.5 rounded-full text-sm ${h==="all"?"bg-aeria-blue text-white":"bg-gray-100 hover:bg-gray-200"}`,children:"All Forms"}),(SI||[]).map(C=>n.jsx("button",{onClick:()=>x(C.id),className:`px-3 py-1.5 rounded-full text-sm ${h===C.id?"bg-aeria-blue text-white":"bg-gray-100 hover:bg-gray-200"}`,children:C.name},C.id))]})]}),n.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[n.jsx("div",{className:"grid sm:grid-cols-2 lg:grid-cols-3 gap-4",children:o.map(C=>{const R=Xj[C.icon]||rs;return n.jsx("button",{onClick:()=>t(C),className:"p-4 border rounded-lg text-left hover:border-aeria-blue hover:bg-blue-50 transition-colors group",children:n.jsxs("div",{className:"flex items-start gap-3",children:[n.jsx("div",{className:"p-2 bg-gray-100 rounded-lg group-hover:bg-aeria-blue group-hover:text-white transition-colors",children:n.jsx(R,{className:"w-5 h-5"})}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsx("h3",{className:"font-medium text-gray-900 truncate",children:C.shortName||C.name}),n.jsx("p",{className:"text-xs text-gray-500 line-clamp-2 mt-1",children:C.description})]})]})},C.id)})}),o.length===0&&n.jsxs("div",{className:"text-center py-12 text-gray-500",children:[n.jsx(rs,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),n.jsx("p",{children:"No forms found matching your criteria"})]})]})]})})}function ooe({project:t,onUpdate:e}){const[r,c]=ue.useState([]),[h,x]=ue.useState([]),[w,o]=ue.useState([]),[C,R]=ue.useState(!1),[F,$]=ue.useState(null),[Y,H]=ue.useState(null),[X,he]=ue.useState(!0),[se,de]=ue.useState(null),{branding:K}=Zj();ue.useEffect(()=>{(async()=>{try{const[ie,ze,ve]=await Promise.all([rx().catch(()=>[]),IT().catch(()=>[]),ix().catch(()=>[])]);c(ie||[]),x(ze||[]),o(ve||[])}catch(ie){console.error("Error loading data:",ie),c([]),de(ie.message)}finally{he(!1)}})()},[]);const ge=Array.isArray(t==null?void 0:t.forms)?t.forms:[],Ae=Ve=>{$(Ve),R(!1)},Te=(Ve,ie)=>{const ze={id:(Y==null?void 0:Y.id)||`form-${Date.now()}`,templateId:(F==null?void 0:F.id)||(Y==null?void 0:Y.templateId),status:ie?"completed":"in_progress",data:Ve,createdAt:(Y==null?void 0:Y.createdAt)||new Date().toISOString(),updatedAt:new Date().toISOString(),completedAt:ie?new Date().toISOString():null};let ve;Y?ve=ge.map(Le=>Le.id===Y.id?ze:Le):ve=[...ge,ze],e({forms:ve}),$(null),H(null)},Ce=Ve=>{const ie=(T2||{})[Ve.templateId];ie&&($(ie),H(Ve))},ne=Ve=>{window.confirm("Are you sure you want to delete this form?")&&e({forms:ge.filter(ie=>ie.id!==Ve)})},ae=async Ve=>{const ie=(T2||{})[Ve.templateId];if(!ie){alert("Unable to export: Form template not found");return}try{const ze=t!=null&&t.clientId?w.find(Pe=>Pe.id===t.clientId):null,ve=K!=null&&K.operator?{operator:K.operator}:null,Le=ze!=null&&ze.logo?{name:ze.name,logo:ze.logo}:null,{exportFormToPDF:Ke}=await D0(async()=>{const{exportFormToPDF:Pe}=await Promise.resolve().then(()=>Vae);return{exportFormToPDF:Pe}},void 0);await Ke(Ve,ie,t,r,ve,Le)}catch(ze){console.error("Error exporting form:",ze),alert("Error exporting form to PDF. Please try again.")}};if(X)return n.jsx("div",{className:"flex items-center justify-center h-64",children:n.jsx(Ro,{className:"w-8 h-8 animate-spin text-aeria-blue"})});const q=Array.isArray(SI)?SI:[],oe=T2||{},ke={};return q.forEach(Ve=>{ke[Ve.id]=ge.filter(ie=>{const ze=oe[ie.templateId];return(ze==null?void 0:ze.category)===Ve.id})}),n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{children:[n.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Project Forms"}),n.jsxs("p",{className:"text-sm text-gray-500 mt-1",children:[ge.length," form",ge.length!==1?"s":""," ",ge.filter(Ve=>Ve.status==="completed").length," completed"]})]}),n.jsxs("button",{onClick:()=>R(!0),className:"btn-primary flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Add Form"]})]}),ge.length===0?n.jsxs("div",{className:"card text-center py-12",children:[n.jsx(Ll,{className:"w-12 h-12 mx-auto text-gray-400 mb-3"}),n.jsx("h3",{className:"font-medium text-gray-900",children:"No forms yet"}),n.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Add forms from the library to get started"}),n.jsx("button",{onClick:()=>R(!0),className:"btn-primary mt-4",children:"Browse Form Library"})]}):n.jsx("div",{className:"space-y-6",children:q.map(Ve=>{const ie=ke[Ve.id]||[];return ie.length===0?null:n.jsxs("div",{className:"card",children:[n.jsxs("h3",{className:"font-medium text-gray-900 mb-4 flex items-center gap-2",children:[Ve.name,n.jsxs("span",{className:"text-sm font-normal text-gray-500",children:["(",ie.length,")"]})]}),n.jsx("div",{className:"space-y-2",children:ie.map(ze=>{const ve=oe[ze.templateId],Le=Q3[ze.status]||Q3.pending,Ke=Le.icon,Pe=Xj[ve==null?void 0:ve.icon]||rs;return n.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx(Pe,{className:"w-5 h-5 text-gray-400"}),n.jsxs("div",{children:[n.jsx("h4",{className:"font-medium text-gray-900",children:(ve==null?void 0:ve.shortName)||(ve==null?void 0:ve.name)||"Unknown Form"}),n.jsx("p",{className:"text-xs text-gray-500",children:ze.updatedAt?`Updated ${new Date(ze.updatedAt).toLocaleDateString()}`:"Draft"})]})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsxs("span",{className:`px-2 py-1 rounded text-xs font-medium flex items-center gap-1 ${Le.color}`,children:[n.jsx(Ke,{className:"w-3 h-3"}),Le.label]}),n.jsx("button",{onClick:()=>Ce(ze),className:"p-2 text-gray-500 hover:text-aeria-blue hover:bg-blue-50 rounded",title:"Edit form",children:n.jsx(wT,{className:"w-4 h-4"})}),n.jsx("button",{onClick:()=>ae(ze),className:"p-2 text-gray-500 hover:text-green-600 hover:bg-green-50 rounded",title:"Export to PDF",children:n.jsx(vc,{className:"w-4 h-4"})}),n.jsx("button",{onClick:()=>ne(ze.id),className:"p-2 text-gray-500 hover:text-red-500 hover:bg-red-50 rounded",title:"Delete form",children:n.jsx(Ln,{className:"w-4 h-4"})})]})]},ze.id)})})]},Ve.id)})}),C&&n.jsx(aoe,{onSelectForm:Ae,onClose:()=>R(!1)}),F&&n.jsx(soe,{form:Y,formTemplate:F,project:t,operators:r,aircraft:h,onSave:Te,onBackToLibrary:()=>{$(null),H(null),R(!0)},onClose:()=>{$(null),H(null)}})]})}async function loe(t,e=null,r=null){var $,Y,H,X,he,se,de;const c=Array.isArray(t==null?void 0:t.sites)?t.sites:[],h=new Jd({title:"Multi-Site Operations Plan",subtitle:`${c.length} Operation Site${c.length!==1?"s":""}`,projectName:(t==null?void 0:t.name)||"",projectCode:(t==null?void 0:t.projectCode)||"",clientName:(t==null?void 0:t.clientName)||"",branding:e,clientBranding:r});await h.init(),h.addCoverPage(),h.addTableOfContents(),h.addNewSection("Executive Summary"),h.addParagraph(`This operations plan covers ${c.length} operation site${c.length!==1?"s":""} for the ${(t==null?void 0:t.name)||"unnamed"} project.`),h.addSpacer(5);const x=[...new Set(c.map(K=>{var ge;return((ge=K.flightPlan)==null?void 0:ge.operationType)||"VLOS"}))],w=Yj(c);h.addKPIRow([{label:"Total Sites",value:c.length},{label:"Operation Types",value:x.join(", ")},{label:"Governing SAIL",value:w||"N/A"},{label:"Status",value:(t==null?void 0:t.status)||"Draft"}]),h.addSpacer(10),h.addSubsectionTitle("Sites Overview");const o=c.map((K,ge)=>{var Te,Ce;const Ae=Xm(K);return[K.name||`Site ${ge+1}`,((Te=K.siteSurvey)==null?void 0:Te.location)||"Not specified",((Ce=K.flightPlan)==null?void 0:Ce.operationType)||"VLOS",Ae.sail||"N/A"]});if(h.addTable(["Site Name","Location","Operation Type","SAIL"],o),c.forEach((K,ge)=>{var ie,ze,ve,Le,Ke,Pe,It,tt,zt,vt,Ot,Et,yi,mi,ht,hi,ni,ui,Fi,Ii,Bi,Ki;h.addNewSection(`Site ${ge+1}: ${K.name||"Unnamed Site"}`),h.addSubsectionTitle("Site Survey");const Ae=K.siteSurvey||{};if(h.addKeyValueGrid([{label:"Location",value:Ae.location||"Not specified"},{label:"Coordinates",value:Xw(Ae.coordinates||((Le=(ve=(ze=(ie=K.mapData)==null?void 0:ie.siteSurvey)==null?void 0:ze.siteLocation)==null?void 0:ve.geometry)==null?void 0:Le.coordinates))},{label:"Population Category",value:((Pe=hf[(Ke=Ae.population)==null?void 0:Ke.category])==null?void 0:Pe.label)||"Not assessed"},{label:"Airspace Class",value:((It=Ae.airspace)==null?void 0:It.classification)||"Not specified"}]),((tt=Ae.obstacles)==null?void 0:tt.length)>0){h.addSpacer(5),h.addParagraph(`Identified Obstacles: ${Ae.obstacles.length}`,{bold:!0});const $r=Ae.obstacles.slice(0,5).map(nn=>[nn.type||"Unknown",nn.height?`${nn.height}m`:"N/A",nn.distance?`${nn.distance}m`:"N/A"]);h.addTable(["Type","Height","Distance"],$r)}h.checkNewPage(40),h.addSubsectionTitle("Flight Plan");const Te=K.flightPlan||{};h.addKeyValueGrid([{label:"Operation Type",value:Te.operationType||"VLOS"},{label:"Max Altitude AGL",value:Te.maxAltitudeAGL?`${Te.maxAltitudeAGL}m`:"Not specified"},{label:"Flight Geography Method",value:Te.flightGeographyMethod||"Not specified"},{label:"Contingency Buffer",value:Te.contingencyBuffer?`${Te.contingencyBuffer}m`:"Not specified"}]);const Ce=K.mapData||{};if((zt=Ce.flightPlan)!=null&&zt.launchPoint||(vt=Ce.flightPlan)!=null&&vt.recoveryPoint){h.addSpacer(5),h.addParagraph("Key Positions:",{bold:!0});const $r=[];(yi=(Et=(Ot=Ce.flightPlan)==null?void 0:Ot.launchPoint)==null?void 0:Et.geometry)!=null&&yi.coordinates&&$r.push(["Launch Point",Xw(Ce.flightPlan.launchPoint.geometry.coordinates)]),(hi=(ht=(mi=Ce.flightPlan)==null?void 0:mi.recoveryPoint)==null?void 0:ht.geometry)!=null&&hi.coordinates&&$r.push(["Recovery Point",Xw(Ce.flightPlan.recoveryPoint.geometry.coordinates)]),(Fi=(ui=(ni=Ce.flightPlan)==null?void 0:ni.pilotPosition)==null?void 0:ui.geometry)!=null&&Fi.coordinates&&$r.push(["Pilot Position",Xw(Ce.flightPlan.pilotPosition.geometry.coordinates)]),$r.length>0&&h.addTable(["Position","Coordinates"],$r)}h.checkNewPage(40),h.addSubsectionTitle("Emergency Plan");const ne=((Ii=K.mapData)==null?void 0:Ii.emergency)||{},ae=ne.musterPoints||[],q=ne.evacuationRoutes||[];h.addKeyValueGrid([{label:"Muster Points",value:ae.length>0?`${ae.length} defined`:"Not defined"},{label:"Primary Muster",value:((Bi=ae.find($r=>$r.isPrimary))==null?void 0:Bi.name)||"Not designated"},{label:"Evacuation Routes",value:q.length>0?`${q.length} defined`:"Not defined"}]),h.checkNewPage(40),h.addSubsectionTitle("SORA Assessment");const oe=Xm(K);h.addKPIRow([{label:"iGRC",value:oe.iGRC??"N/A"},{label:"fGRC",value:oe.fGRC??"N/A"},{label:"Initial ARC",value:oe.initialARC||"N/A"},{label:"Residual ARC",value:oe.residualARC||"N/A"},{label:"SAIL",value:oe.sail||"N/A"}]);const ke=K.soraAssessment||{},Ve=Object.entries(ke.mitigations||{}).filter(([$r,nn])=>nn==null?void 0:nn.enabled).map(([$r,nn])=>`${$r} (${nn.robustness})`);Ve.length>0&&(h.addSpacer(5),h.addParagraph(`Ground Mitigations: ${Ve.join(", ")}`)),(Ki=ke.tmpr)!=null&&Ki.enabled&&h.addParagraph(`Tactical Mitigation: ${ke.tmpr.type} (${ke.tmpr.robustness} robustness)`)}),(($=t==null?void 0:t.aircraft)==null?void 0:$.length)>0||((H=(Y=t==null?void 0:t.flightPlan)==null?void 0:Y.aircraft)==null?void 0:H.length)>0){h.addNewSection("Aircraft");const K=t.aircraft||[];if(K.length>0){const ge=K.map(Ae=>[Ae.nickname||Ae.registration||"N/A",`${Ae.make||""} ${Ae.model||""}`.trim()||"N/A",Ae.mtow?`${Ae.mtow} kg`:"N/A",Ae.isPrimary?"Primary":""]);h.addTable(["Nickname/Reg","Make/Model","MTOW","Status"],ge)}}if(((X=t==null?void 0:t.crew)==null?void 0:X.length)>0){h.addNewSection("Crew Roster");const K=t.crew.map(ge=>[ge.name||`${ge.firstName||""} ${ge.lastName||""}`.trim(),ge.role||"",ge.pilotCertNumber||"",Array.isArray(ge.certifications)?ge.certifications.join(", "):ge.certifications||"N/A"]);h.addTable(["Name","Role","Cert #","Certifications"],K)}const C=(he=t==null?void 0:t.flightPlan)==null?void 0:he.weatherMinimums;C&&(h.addNewSection("Weather Minimums"),h.addKeyValueGrid([{label:"Min Visibility",value:C.minVisibility?`${C.minVisibility} SM`:"N/A"},{label:"Min Ceiling",value:C.minCeiling?`${C.minCeiling} ft AGL`:"N/A"},{label:"Max Wind",value:C.maxWind?`${C.maxWind} m/s`:"N/A"},{label:"Max Gust",value:C.maxGust?`${C.maxGust} m/s`:"N/A"},{label:"Precipitation",value:C.precipitation===!1?"Not Allowed":"Allowed"}]));const R=(t==null?void 0:t.emergencyPlan)||{};if(((se=R.contacts)==null?void 0:se.length)>0){h.addNewSection("Emergency Contacts");const K=R.contacts.map(ge=>[ge.name||"",ge.role||"",ge.phone||"",ge.notes||""]);h.addTable(["Name","Role","Phone","Notes"],K),(de=R.facilities)!=null&&de.hospitalName&&(h.addSpacer(10),h.addSubsectionTitle("Nearest Emergency Facilities"),h.addKeyValueGrid([{label:"Hospital",value:R.facilities.hospitalName},{label:"Address",value:R.facilities.hospitalAddress||"N/A"},{label:"Phone",value:R.facilities.hospitalPhone||"N/A"},{label:"Distance",value:R.facilities.hospitalDistance?`${R.facilities.hospitalDistance} km`:"N/A"}]))}h.addNewSection("Approvals"),h.addParagraph("This operations plan has been reviewed and approved by the following personnel:"),h.addSpacer(10),h.addSignatureBlock([{role:"Pilot in Command (PIC)",name:""},{role:"Operations Manager",name:""},{role:"Safety Officer",name:""},{role:"Client Representative",name:""}]),h.fillTableOfContents();const F=h.pageNumber;for(let K=2;K<=F;K++)h.doc.setPage(K),h.addFooter(K,F);return h}async function coe(t,e=null){const r=Array.isArray(t==null?void 0:t.sites)?t.sites:[],c=new Jd({title:"SORA Risk Assessment",subtitle:`Multi-Site Assessment - ${r.length} Sites`,projectName:(t==null?void 0:t.name)||"",projectCode:(t==null?void 0:t.projectCode)||"",clientName:(t==null?void 0:t.clientName)||"",branding:e});await c.init(),c.addCoverPage(),c.addTableOfContents(),c.addNewSection("Assessment Summary");const h=Yj(r),x=r.every(C=>{const R=Xm(C);return R.fGRC!==null&&R.fGRC<=7});c.addInfoBox("Governing SAIL Level",`Based on the multi-site assessment, this operation is governed by SAIL Level ${h||"N/A"}. ${x?"All sites are within SORA scope.":"WARNING: One or more sites are outside SORA scope."}`,x?"info":"warning"),c.addSpacer(10),c.addKPIRow([{label:"Sites Assessed",value:r.length},{label:"Governing SAIL",value:h||"N/A"},{label:"Within Scope",value:x?"Yes":"No"},{label:"Assessment Date",value:new Date().toLocaleDateString("en-CA")}]),c.addSpacer(10),c.addSubsectionTitle("Site Risk Comparison");const w=r.map((C,R)=>{var Y;const F=Xm(C),$=C.soraAssessment||{};return[C.name||`Site ${R+1}`,((Y=hf[$.populationCategory||"sparsely"])==null?void 0:Y.label.split("(")[0].trim())||"N/A",F.iGRC??"-",F.fGRC??"-",F.residualARC||F.initialARC||"-",F.sail||"-"]});c.addTable(["Site","Population","iGRC","fGRC","ARC","SAIL"],w),r.forEach((C,R)=>{var X,he,se,de;c.addNewSection(`Site ${R+1}: ${C.name||"Unnamed"} - SORA`);const F=C.soraAssessment||{},$=Xm(C);c.addSubsectionTitle("Step 2: Intrinsic Ground Risk Class (iGRC)"),c.addKeyValueGrid([{label:"Population Category",value:((X=hf[F.populationCategory||$.population])==null?void 0:X.label)||"Not specified"},{label:"UA Characteristics",value:((he=tv[F.uaCharacteristics||$.uaChar])==null?void 0:he.label)||"Not specified"},{label:"Intrinsic GRC",value:$.iGRC??"N/A"}]),c.checkNewPage(50),c.addSubsectionTitle("Step 3: Final Ground Risk Class (fGRC)");const Y=F.mitigations||{},H=Object.entries(Y).filter(([K,ge])=>ge==null?void 0:ge.enabled);if(H.length>0){const K=H.map(([ge,Ae])=>{var ne,ae,q;const Te=pU[ge],Ce=((ne=Te==null?void 0:Te.reductions)==null?void 0:ne[Ae.robustness])||0;return[(Te==null?void 0:Te.name)||ge,((ae=Ae.robustness)==null?void 0:ae.charAt(0).toUpperCase())+((q=Ae.robustness)==null?void 0:q.slice(1))||"None",Ce.toString(),Ae.evidence||"Not documented"]});c.addTable(["Mitigation","Robustness","Reduction","Evidence"],K)}else c.addParagraph("No ground mitigations applied.");if(c.addSpacer(5),c.addKeyValueGrid([{label:"iGRC",value:$.iGRC??"N/A"},{label:"Total Reduction",value:$.iGRC-$.fGRC||0},{label:"Final GRC",value:$.fGRC??"N/A"}]),c.checkNewPage(40),c.addSubsectionTitle("Steps 4-5: Air Risk Assessment"),c.addKeyValueGrid([{label:"Initial ARC",value:`${$.initialARC} - ${((se=mU[$.initialARC])==null?void 0:se.description)||""}`},{label:"TMPR Applied",value:(de=F.tmpr)!=null&&de.enabled?`${F.tmpr.type} (${F.tmpr.robustness})`:"None"},{label:"Residual ARC",value:$.residualARC}]),c.checkNewPage(30),c.addSubsectionTitle("Step 6: SAIL Determination"),$.sail&&Ld[$.sail],c.addInfoBox(`SAIL Level: ${$.sail||"N/A"}`,fI[$.sail]||"SAIL could not be determined.",$.fGRC<=7?"info":"warning"),$.sail){c.checkNewPage(30),c.addSubsectionTitle("Step 7: OSO Requirements Summary");const K=gU($.sail,F.osoCompliance||{});c.addKeyValueGrid([{label:"Total OSOs",value:K.summary.total},{label:"Compliant",value:K.summary.compliant},{label:"Non-Compliant",value:K.summary.nonCompliant},{label:"Optional",value:K.summary.optional}]),K.summary.overallCompliant||(c.addSpacer(5),c.addInfoBox("OSO Compliance Gap",`${K.summary.nonCompliant} required OSOs are not yet compliant.`,"warning"))}}),c.addNewSection("Assessment Approval"),c.addSignatureBlock([{role:"SORA Assessor",name:""},{role:"Technical Reviewer",name:""},{role:"Operations Manager",name:""}]),c.fillTableOfContents();const o=c.pageNumber;for(let C=2;C<=o;C++)c.doc.setPage(C),c.addFooter(C,o);return c}function Xm(t){var R,F;const e=t.soraAssessment||{},r=e.populationCategory||((F=(R=t.siteSurvey)==null?void 0:R.population)==null?void 0:F.category)||"sparsely",c=e.uaCharacteristics||"1m_25ms",h=RT(r,c),x=kT(h,e.mitigations||{}),w=e.initialARC||"ARC-b",o=DT(w,e.tmpr||{}),C=MT(x,o);return{population:r,uaChar:c,iGRC:h,fGRC:x,initialARC:w,residualARC:o,sail:C,withinScope:x!==null&&x<=7}}function Yj(t){const e=["I","II","III","IV","V","VI"];let r=-1;return t.forEach(c=>{const h=Xm(c),x=e.indexOf(h.sail);x>r&&(r=x)}),r>=0?e[r]:null}function Xw(t){return t?Array.isArray(t)&&t.length>=2?`${t[1].toFixed(5)}N, ${t[0].toFixed(5)}W`:t.lat!==void 0&&t.lng!==void 0?`${t.lat.toFixed(5)}N, ${t.lng.toFixed(5)}W`:"Invalid coordinates":"Not specified"}const J3=[{id:"overview",label:"Project Overview",included:!0},{id:"crew",label:"Crew Roster",included:!0},{id:"siteSurvey",label:"Site Survey",included:!0,conditional:!0},{id:"flightPlan",label:"Flight Plan",included:!0,conditional:!0},{id:"riskAssessment",label:"Risk Assessment",included:!0},{id:"emergency",label:"Emergency Plan",included:!0},{id:"ppe",label:"PPE Requirements",included:!0},{id:"communications",label:"Communications",included:!0},{id:"approvals",label:"Approvals & Signatures",included:!0},{id:"forms",label:"Forms Checklist",included:!1}],uoe=[{id:"operations-plan",label:"Full Operations Plan",description:"Complete project documentation including all sections",icon:rs,color:"blue",supportsMultiSite:!0},{id:"sora",label:"SORA Assessment",description:"Specific Operations Risk Assessment (SORA 2.5)",icon:Ds,color:"purple",conditional:"soraAssessment",supportsMultiSite:!0},{id:"hse-risk",label:"HSE Risk Assessment",description:"Health, Safety & Environment hazard assessment",icon:Cs,color:"orange",conditional:"hseRiskAssessment",supportsMultiSite:!1},{id:"site-survey",label:"Site Survey Report",description:"Site survey documentation and findings",icon:Wn,color:"green",conditional:"siteSurvey",supportsMultiSite:!1},{id:"flight-plan",label:"Flight Plan",description:"Flight operations plan and aircraft details",icon:Zn,color:"cyan",conditional:"flightPlan",supportsMultiSite:!1},{id:"tailgate",label:"Tailgate Meeting",description:"Pre-deployment safety briefing form",icon:ds,color:"amber",supportsMultiSite:!1}],FC=(t,e)=>{const r=URL.createObjectURL(t),c=document.createElement("a");c.href=r,c.download=e,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(r)};function doe({sites:t,selectedSite:e,onSelect:r,calculations:c}){return!t||t.length<=1?null:n.jsxs("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[n.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[n.jsx(vT,{className:"w-5 h-5 text-blue-600"}),n.jsx("span",{className:"font-medium text-blue-900",children:"Multi-Site Project"}),n.jsxs("span",{className:"text-sm text-blue-700",children:["(",t.length," sites)"]})]}),n.jsx("p",{className:"text-sm text-blue-700 mb-3",children:"Select which sites to include in the export:"}),n.jsxs("div",{className:"space-y-2",children:[n.jsxs("label",{className:"flex items-center gap-3 p-2 bg-white rounded-lg border border-blue-200 cursor-pointer hover:bg-blue-50",children:[n.jsx("input",{type:"radio",name:"siteSelection",checked:e===null,onChange:()=>r(null),className:"w-4 h-4 text-aeria-navy"}),n.jsxs("div",{className:"flex-1",children:[n.jsx("span",{className:"font-medium text-gray-900",children:"All Sites"}),n.jsx("span",{className:"text-sm text-gray-500 ml-2",children:"Export complete multi-site document"})]}),c&&n.jsxs("span",{className:"text-xs text-gray-500",children:["Max SAIL: ",Yj(t)||"N/A"]})]}),t.map((h,x)=>{var o;const w=(c==null?void 0:c[h.id])||{};return n.jsxs("label",{className:"flex items-center gap-3 p-2 bg-white rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50",children:[n.jsx("input",{type:"radio",name:"siteSelection",checked:e===h.id,onChange:()=>r(h.id),className:"w-4 h-4 text-aeria-navy"}),n.jsx("div",{className:"w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-medium",style:{backgroundColor:`hsl(${x*60}, 70%, 50%)`},children:x+1}),n.jsxs("div",{className:"flex-1",children:[n.jsx("span",{className:"font-medium text-gray-900",children:h.name||`Site ${x+1}`}),n.jsx("span",{className:"text-sm text-gray-500 ml-2",children:((o=h.siteSurvey)==null?void 0:o.location)||"No location"})]}),w.sail&&n.jsxs("span",{className:"px-2 py-0.5 rounded text-xs font-medium",style:{backgroundColor:Ld[w.sail],color:w.sail==="I"||w.sail==="II"?"#1F2937":"#FFFFFF"},children:["SAIL ",w.sail]})]},h.id)})]})]})}function hoe({project:t,onUpdate:e}){var Le,Ke;const[r,c]=ue.useState(!1),[h,x]=ue.useState(null),[w,o]=ue.useState(!1),[C,R]=ue.useState(J3.reduce((Pe,It)=>({...Pe,[It.id]:It.included}),{})),[F,$]=ue.useState(!0),[Y,H]=ue.useState(!0),[X,he]=ue.useState(!1),[se,de]=ue.useState(null),[K,ge]=ue.useState(null),[Ae,Te]=ue.useState(!1),{branding:Ce}=Zj(),ne=ue.useMemo(()=>Array.isArray(t==null?void 0:t.sites)?t.sites:[],[t==null?void 0:t.sites]),ae=ne.length>1,q=ue.useMemo(()=>{if(!ae)return{};const Pe={};return ne.forEach(It=>{Pe[It.id]=Xm(It)}),Pe},[ne,ae]),oe=Pe=>{R(It=>({...It,[Pe]:!It[Pe]}))},ke=()=>{var It,tt,zt,vt,Ot,Et,yi,mi,ht,hi,ni,ui,Fi;const Pe=[];if(Pe.push("=".repeat(60)),Pe.push("RPAS OPERATIONS PLAN"),Pe.push("=".repeat(60)),Pe.push(""),Pe.push(`Project: ${t.name||"Untitled"}`),Pe.push(`Code: ${t.projectCode||"N/A"}`),Pe.push(`Client: ${t.clientName||"N/A"}`),Pe.push(`Date: ${t.startDate||"TBD"}`),Pe.push(`Status: ${((It=t.status)==null?void 0:It.toUpperCase())||"DRAFT"}`),ae&&(Pe.push(`Sites: ${ne.length}`),Pe.push(""),Pe.push("Operation Sites:"),ne.forEach((Ii,Bi)=>{const Ki=q[Ii.id]||{};Pe.push(`  ${Bi+1}. ${Ii.name||"Unnamed"} - SAIL: ${Ki.sail||"N/A"}`)})),Pe.push(""),C.crew&&(Pe.push("-".repeat(40)),Pe.push("CREW"),Pe.push("-".repeat(40)),((tt=t.crew)==null?void 0:tt.length)>0?t.crew.forEach(Ii=>{Pe.push(`${Ii.role}: ${Ii.name}`),Ii.phone&&Pe.push(`  Phone: ${Ii.phone}`),Ii.certifications&&Pe.push(`  Certs: ${Ii.certifications}`)}):Pe.push("No crew assigned"),Pe.push("")),C.flightPlan&&((zt=t.sections)!=null&&zt.flightPlan)){Pe.push("-".repeat(40)),Pe.push("FLIGHT PLAN"),Pe.push("-".repeat(40));const Ii=t.flightPlan||{};Pe.push(`Operation Type: ${Ii.operationType||"VLOS"}`),Pe.push(`Max Altitude: ${Ii.maxAltitudeAGL||Ii.maxAltitude||"N/A"} m AGL`),Pe.push(`Aircraft: ${((Ot=(vt=Ii.aircraft)==null?void 0:vt[0])==null?void 0:Ot.registration)||"N/A"}`),Ii.flightArea&&Pe.push(`Flight Area: ${Ii.flightArea}`),Pe.push("")}if(C.siteSurvey&&((Et=t.sections)!=null&&Et.siteSurvey)){Pe.push("-".repeat(40)),Pe.push("SITE SURVEY"),Pe.push("-".repeat(40));const Ii=t.siteSurvey||{};Pe.push(`Site: ${((yi=Ii.general)==null?void 0:yi.siteName)||"N/A"}`),(mi=Ii.general)!=null&&mi.coordinates&&Pe.push(`Coordinates: ${Ii.general.coordinates.lat}, ${Ii.general.coordinates.lng}`),Pe.push("")}if(C.riskAssessment){if(Pe.push("-".repeat(40)),Pe.push("RISK ASSESSMENT"),Pe.push("-".repeat(40)),t.soraAssessment){const Ii=t.soraAssessment;Pe.push(`SORA SAIL: ${Ii.sail||"N/A"}`),Pe.push(`Final GRC: ${Ii.finalGRC||"N/A"}`),Pe.push(`Residual ARC: ${Ii.residualARC||Ii.initialARC||"N/A"}`)}((hi=(ht=t.hseRiskAssessment)==null?void 0:ht.hazards)==null?void 0:hi.length)>0&&(Pe.push(""),Pe.push("Identified Hazards:"),t.hseRiskAssessment.hazards.forEach((Ii,Bi)=>{Pe.push(`${Bi+1}. ${Ii.description||"Unnamed hazard"}`),Pe.push(`   Controls: ${Ii.controls||"None documented"}`)})),Pe.push("")}if(C.emergency){Pe.push("-".repeat(40)),Pe.push("EMERGENCY PLAN"),Pe.push("-".repeat(40));const Ii=t.emergencyPlan||{},Bi=Ii.primaryEmergencyContact||{};Pe.push(`Emergency Contact: ${Bi.name||"Not set"}`),Bi.phone&&Pe.push(`  Phone: ${Bi.phone}`),Pe.push(`Hospital: ${Ii.nearestHospital||"Not set"}`),Pe.push(`Rally Point: ${Ii.rallyPoint||"Not set"}`),Pe.push("")}if(C.communications){Pe.push("-".repeat(40)),Pe.push("COMMUNICATIONS"),Pe.push("-".repeat(40));const Ii=t.communications||{};Pe.push(`Primary: ${Ii.primaryChannel||"Not set"}`),Pe.push(`Backup: ${Ii.backupChannel||"Not set"}`),Pe.push(`Lost Link: ${Ii.lostLinkProcedure||"RTH"}`),Pe.push("")}if(C.ppe){Pe.push("-".repeat(40)),Pe.push("PPE REQUIREMENTS"),Pe.push("-".repeat(40));const Ii=t.ppe||{};((ni=Ii.required)==null?void 0:ni.length)>0?Ii.required.forEach(Bi=>Pe.push(` ${Bi}`)):Pe.push("Standard PPE"),Pe.push("")}return Pe.push("=".repeat(60)),Pe.push(`Generated: ${new Date().toLocaleString()}`),Pe.push(`${((ui=Ce==null?void 0:Ce.operator)==null?void 0:ui.name)||"Operator"} - ${((Fi=Ce==null?void 0:Ce.operator)==null?void 0:Fi.registration)||""}`),Pe.push("=".repeat(60)),Pe.join(`
`)},Ve=()=>{var It,tt,zt,vt,Ot,Et,yi,mi;const Pe=((It=Ce==null?void 0:Ce.operator)==null?void 0:It.colors)||{primary:"#1e3a5f",secondary:"#3b82f6"};return`<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${t.name||"Operations Plan"} - ${((tt=Ce==null?void 0:Ce.operator)==null?void 0:tt.name)||"Operator"}</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #1f2937; }
    .header { background: ${Pe.primary}; color: white; padding: 2rem; }
    .header h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
    .header p { opacity: 0.9; font-size: 0.9rem; }
    .container { max-width: 900px; margin: 0 auto; padding: 2rem; }
    .section { margin-bottom: 2rem; }
    .section-title { background: ${Pe.secondary}; color: white; padding: 0.75rem 1rem; border-radius: 4px; font-weight: 600; margin-bottom: 1rem; }
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
    .field { background: #f9fafb; padding: 0.75rem; border-radius: 4px; }
    .field-label { font-size: 0.75rem; color: #6b7280; text-transform: uppercase; }
    .field-value { font-weight: 500; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th { background: ${Pe.primary}; color: white; text-align: left; padding: 0.75rem; }
    td { padding: 0.75rem; border-bottom: 1px solid #e5e7eb; }
    tr:nth-child(even) { background: #f9fafb; }
    .footer { text-align: center; padding: 2rem; color: #6b7280; font-size: 0.875rem; border-top: 1px solid #e5e7eb; margin-top: 2rem; }
    .site-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    .site-card h3 { font-size: 1rem; margin-bottom: 0.5rem; }
    @media print { .header { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
  </style>
</head>
<body>
  <div class="header">
    <h1>${t.name||"RPAS Operations Plan"}</h1>
    <p>${t.projectCode||""} | ${t.clientName||"No Client"} | ${t.startDate||"TBD"}${ae?` | ${ne.length} Sites`:""}</p>
  </div>
  
  <div class="container">
    ${C.overview?`
    <div class="section">
      <div class="section-title">Project Overview</div>
      <div class="grid">
        <div class="field"><div class="field-label">Project Name</div><div class="field-value">${t.name||"N/A"}</div></div>
        <div class="field"><div class="field-label">Project Code</div><div class="field-value">${t.projectCode||"N/A"}</div></div>
        <div class="field"><div class="field-label">Client</div><div class="field-value">${t.clientName||"N/A"}</div></div>
        <div class="field"><div class="field-label">Status</div><div class="field-value">${((zt=t.status)==null?void 0:zt.toUpperCase())||"DRAFT"}</div></div>
        <div class="field"><div class="field-label">Start Date</div><div class="field-value">${t.startDate||"TBD"}</div></div>
        <div class="field"><div class="field-label">End Date</div><div class="field-value">${t.endDate||"TBD"}</div></div>
      </div>
    </div>
    `:""}
    
    ${ae?`
    <div class="section">
      <div class="section-title">Operation Sites (${ne.length})</div>
      ${ne.map((ht,hi)=>{var ui,Fi;const ni=q[ht.id]||{};return`
        <div class="site-card">
          <h3>${hi+1}. ${ht.name||"Unnamed Site"}</h3>
          <div class="grid">
            <div class="field"><div class="field-label">Location</div><div class="field-value">${((ui=ht.siteSurvey)==null?void 0:ui.location)||"N/A"}</div></div>
            <div class="field"><div class="field-label">Operation Type</div><div class="field-value">${((Fi=ht.flightPlan)==null?void 0:Fi.operationType)||"VLOS"}</div></div>
            <div class="field"><div class="field-label">SAIL Level</div><div class="field-value">${ni.sail||"N/A"}</div></div>
            <div class="field"><div class="field-label">Final GRC</div><div class="field-value">${ni.fGRC||"N/A"}</div></div>
          </div>
        </div>
        `}).join("")}
    </div>
    `:""}
    
    ${C.crew&&((vt=t.crew)==null?void 0:vt.length)>0?`
    <div class="section">
      <div class="section-title">Crew Roster</div>
      <table>
        <thead><tr><th>Role</th><th>Name</th><th>Certifications</th><th>Phone</th></tr></thead>
        <tbody>
          ${t.crew.map(ht=>`<tr><td>${ht.role||"N/A"}</td><td>${ht.name||"N/A"}</td><td>${ht.certifications||"N/A"}</td><td>${ht.phone||"N/A"}</td></tr>`).join("")}
        </tbody>
      </table>
    </div>
    `:""}
    
    ${C.riskAssessment&&t.soraAssessment?`
    <div class="section">
      <div class="section-title">SORA Assessment</div>
      <div class="grid">
        <div class="field"><div class="field-label">SAIL Level</div><div class="field-value">${t.soraAssessment.sail||"N/A"}</div></div>
        <div class="field"><div class="field-label">Final GRC</div><div class="field-value">${t.soraAssessment.finalGRC||"N/A"}</div></div>
        <div class="field"><div class="field-label">Initial ARC</div><div class="field-value">${t.soraAssessment.initialARC||"N/A"}</div></div>
        <div class="field"><div class="field-label">Operation Type</div><div class="field-value">${t.soraAssessment.operationType||"VLOS"}</div></div>
      </div>
    </div>
    `:""}
    
    ${C.emergency&&t.emergencyPlan?`
    <div class="section">
      <div class="section-title">Emergency Response</div>
      <div class="grid">
        <div class="field"><div class="field-label">Emergency Contact</div><div class="field-value">${((Ot=t.emergencyPlan.primaryEmergencyContact)==null?void 0:Ot.name)||"N/A"}</div></div>
        <div class="field"><div class="field-label">Contact Phone</div><div class="field-value">${((Et=t.emergencyPlan.primaryEmergencyContact)==null?void 0:Et.phone)||"N/A"}</div></div>
        <div class="field"><div class="field-label">Nearest Hospital</div><div class="field-value">${t.emergencyPlan.nearestHospital||"N/A"}</div></div>
        <div class="field"><div class="field-label">Rally Point</div><div class="field-value">${t.emergencyPlan.rallyPoint||"N/A"}</div></div>
      </div>
    </div>
    `:""}
  </div>
  
  <div class="footer">
    <p>Generated ${new Date().toLocaleString()}</p>
    <p>${((yi=Ce==null?void 0:Ce.operator)==null?void 0:yi.name)||"Operator"} | ${((mi=Ce==null?void 0:Ce.operator)==null?void 0:mi.registration)||""}</p>
  </div>
</body>
</html>`},ie=async Pe=>{var It,tt,zt,vt,Ot,Et;c(!0),x(Pe),de("Generating PDF...");try{const yi=t.clientId?(It=Ce==null?void 0:Ce.clients)==null?void 0:It.find(ui=>ui.id===t.clientId):null,mi={operator:Ce==null?void 0:Ce.operator,client:yi};let ht;const hi=ae?K?`_site-${K}`:"_all-sites":"",ni=`${Pe}${hi}_${t.projectCode||t.name||"export"}_${new Date().toISOString().split("T")[0]}.pdf`;if(ae&&(Pe==="operations-plan"||Pe==="sora"))de("Generating multi-site PDF..."),Pe==="operations-plan"?ht=await loe(K?{...t,sites:ne.filter(ui=>ui.id===K)}:t,mi,yi):Pe==="sora"&&(ht=await coe(K?{...t,sites:ne.filter(ui=>ui.id===K)}:t,mi));else switch(Pe){case"operations-plan":ht=await wI(t,mi);break;case"sora":const ui={intrinsicGRC:((tt=t.soraAssessment)==null?void 0:tt.intrinsicGRC)||3,finalGRC:((zt=t.soraAssessment)==null?void 0:zt.finalGRC)||3,residualARC:((vt=t.soraAssessment)==null?void 0:vt.residualARC)||((Ot=t.soraAssessment)==null?void 0:Ot.initialARC)||"ARC-b",sail:((Et=t.soraAssessment)==null?void 0:Et.sail)||"II"};ht=await RU(t,ui,mi);break;case"hse-risk":ht=await kU(t,mi);break;default:ht=await wI(t,mi)}de("Saving..."),ht.save(ni),de(null)}catch(yi){console.error("PDF export failed:",yi),de("Export failed"),setTimeout(()=>de(null),3e3)}finally{c(!1),x(null)}},ze=async Pe=>{c(!0),x(Pe);try{switch(Pe){case"text":const It=ke(),tt=new Blob([It],{type:"text/plain"});FC(tt,`${t.projectCode||"ops-plan"}-${t.name||"export"}.txt`);break;case"copy":const zt=ke();await navigator.clipboard.writeText(zt),o(!0),setTimeout(()=>o(!1),2e3);break;case"json":const vt={exportedAt:new Date().toISOString(),project:t},Ot=new Blob([JSON.stringify(vt,null,2)],{type:"application/json"});FC(Ot,`${t.projectCode||"project"}-backup.json`);break;case"html":const Et=Ve(),yi=new Blob([Et],{type:"text/html"});FC(yi,`${t.projectCode||"ops-plan"}-${t.name||"export"}.html`);break;case"print":window.print();break}}catch(It){console.error("Export failed:",It)}finally{c(!1),x(null)}},ve=ue.useMemo(()=>{var It,tt,zt,vt,Ot,Et,yi;const Pe=[{label:"Project overview complete",ok:!!t.name&&!!t.startDate},{label:"Crew assigned",ok:((It=t.crew)==null?void 0:It.length)>0},{label:"Flight plan configured",ok:!!((tt=t.flightPlan)!=null&&tt.operationType)||ne.some(mi=>{var ht;return(ht=mi.flightPlan)==null?void 0:ht.operationType})},{label:"Risk assessment complete",ok:!!((zt=t.soraAssessment)!=null&&zt.sail)||ne.some(mi=>{var ht;return(ht=mi.soraAssessment)==null?void 0:ht.populationCategory})},{label:"Emergency contacts set",ok:!!((Ot=(vt=t.emergencyPlan)==null?void 0:vt.primaryEmergencyContact)!=null&&Ot.name)||!!((yi=(Et=t.emergencyPlan)==null?void 0:Et.contacts)!=null&&yi.length)},{label:"Project approved",ok:t.status==="approved"}];if(ae){const mi=ne.filter(hi=>{var ni,ui;return(ui=(ni=hi.mapData)==null?void 0:ni.siteSurvey)==null?void 0:ui.operationsBoundary}).length;ne.filter(hi=>{var ni,ui;return(ui=(ni=hi.mapData)==null?void 0:ni.flightPlan)==null?void 0:ui.launchPoint}).length;const ht=ne.filter(hi=>{var ni;return(ni=q[hi.id])==null?void 0:ni.sail}).length;Pe.push({label:`Sites with boundaries (${mi}/${ne.length})`,ok:mi===ne.length}),Pe.push({label:`Sites with SORA (${ht}/${ne.length})`,ok:ht===ne.length})}return Pe},[t,ne,ae,q]);return n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"card",children:[n.jsxs("h2",{className:"text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2",children:[n.jsx(eb,{className:"w-5 h-5 text-aeria-blue"}),"Export Readiness",ae&&n.jsxs("span",{className:"ml-2 px-2 py-0.5 text-xs bg-blue-100 text-blue-700 rounded-full",children:[ne.length," Sites"]})]}),n.jsx("div",{className:"grid sm:grid-cols-2 lg:grid-cols-3 gap-2",children:ve.map((Pe,It)=>n.jsxs("div",{className:`flex items-center gap-2 p-2 rounded ${Pe.ok?"bg-green-50":"bg-gray-50"}`,children:[Pe.ok?n.jsx(qr,{className:"w-4 h-4 text-green-600"}):n.jsx(ir,{className:"w-4 h-4 text-gray-400"}),n.jsx("span",{className:`text-sm ${Pe.ok?"text-green-800":"text-gray-500"}`,children:Pe.label})]},It))})]}),n.jsxs("div",{className:"card",children:[n.jsxs("div",{className:"flex items-center justify-between mb-4",children:[n.jsxs("h2",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[n.jsx(wie,{className:"w-5 h-5 text-red-500"}),"PDF Export"]}),n.jsx("span",{className:"px-2 py-1 text-xs bg-red-100 text-red-700 rounded",children:"Professional"})]}),n.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"Generate branded PDF reports for clients and regulatory submissions."}),ae&&n.jsx(doe,{sites:ne,selectedSite:K,onSelect:ge,calculations:q}),n.jsx("div",{className:"grid sm:grid-cols-2 lg:grid-cols-3 gap-4",children:uoe.map(Pe=>{const It=Pe.icon,tt=Pe.conditional&&!t[Pe.conditional]&&!ne.some(Ot=>Ot[Pe.conditional]),zt=Pe.supportsMultiSite,vt={blue:"bg-blue-100 text-blue-600",purple:"bg-purple-100 text-purple-600",orange:"bg-orange-100 text-orange-600",green:"bg-green-100 text-green-600",cyan:"bg-cyan-100 text-cyan-600",amber:"bg-amber-100 text-amber-600"};return n.jsxs("button",{onClick:()=>ie(Pe.id),disabled:r||tt,className:`p-4 border rounded-lg text-left transition-all ${tt?"border-gray-200 opacity-50 cursor-not-allowed":"border-gray-200 hover:border-red-300 hover:bg-red-50"}`,children:[n.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[n.jsx("div",{className:`p-2 rounded-lg ${vt[Pe.color]}`,children:n.jsx(It,{className:"w-5 h-5"})}),n.jsxs("div",{className:"flex-1",children:[n.jsx("span",{className:"font-medium text-gray-900",children:Pe.label}),ae&&zt&&n.jsx("span",{className:"ml-2 text-xs text-blue-600",children:"Multi-site"})]})]}),n.jsx("p",{className:"text-sm text-gray-500",children:Pe.description}),tt&&n.jsx("p",{className:"text-xs text-gray-400 mt-2",children:"Section not enabled"}),r&&h===Pe.id&&n.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[n.jsx(Ro,{className:"w-4 h-4 animate-spin text-red-500"}),n.jsx("span",{className:"text-xs text-red-600",children:se})]})]},Pe.id)})}),n.jsxs("div",{className:"mt-4 p-3 bg-gray-50 rounded-lg flex items-center gap-3",children:[(Le=Ce==null?void 0:Ce.operator)!=null&&Le.logo?n.jsx("img",{src:Ce.operator.logo,alt:"Logo",className:"h-8 w-auto"}):n.jsx("div",{className:"h-8 w-8 bg-gray-300 rounded flex items-center justify-center text-xs text-gray-500",children:"Logo"}),n.jsxs("div",{className:"flex-1",children:[n.jsx("p",{className:"text-sm font-medium text-gray-700",children:((Ke=Ce==null?void 0:Ce.operator)==null?void 0:Ke.name)||"Your Company"}),n.jsx("p",{className:"text-xs text-gray-500",children:"PDFs will be branded with your company identity"})]}),n.jsx("a",{href:"/settings",className:"text-xs text-aeria-blue hover:underline",children:"Edit branding"})]})]}),n.jsxs("div",{className:"card",children:[n.jsxs("h2",{className:"text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2",children:[n.jsx(kv,{className:"w-5 h-5 text-aeria-blue"}),"Export Sections"]}),n.jsx("div",{className:"grid sm:grid-cols-2 gap-2 mb-4",children:J3.map(Pe=>{var tt;const It=Pe.conditional&&!((tt=t.sections)!=null&&tt[Pe.id]);return n.jsxs("label",{className:`flex items-center gap-3 p-2 rounded cursor-pointer ${It?"opacity-50":"hover:bg-gray-50"}`,children:[n.jsx("input",{type:"checkbox",checked:C[Pe.id]&&!It,onChange:()=>oe(Pe.id),disabled:It,className:"w-4 h-4 text-aeria-navy rounded"}),n.jsx("span",{className:"text-sm text-gray-700",children:Pe.label}),It&&n.jsx("span",{className:"text-xs text-gray-400",children:"(not enabled)"})]},Pe.id)})}),n.jsxs("div",{className:"flex flex-wrap gap-4 pt-3 border-t border-gray-200",children:[n.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[n.jsx("input",{type:"checkbox",checked:Y,onChange:Pe=>H(Pe.target.checked),className:"w-4 h-4 text-aeria-navy rounded"}),n.jsx("span",{className:"text-sm text-gray-700",children:"Include cover page"})]}),n.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[n.jsx("input",{type:"checkbox",checked:F,onChange:Pe=>$(Pe.target.checked),className:"w-4 h-4 text-aeria-navy rounded"}),n.jsx("span",{className:"text-sm text-gray-700",children:"Include appendices"})]})]})]}),n.jsxs("div",{className:"card",children:[n.jsxs("h2",{className:"text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2",children:[n.jsx(vc,{className:"w-5 h-5 text-aeria-blue"}),"Other Export Formats"]}),n.jsxs("div",{className:"grid sm:grid-cols-2 lg:grid-cols-3 gap-4",children:[n.jsxs("button",{onClick:()=>ze("html"),disabled:r,className:"p-4 border border-gray-200 rounded-lg hover:border-aeria-blue hover:bg-aeria-sky transition-colors text-left",children:[n.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[n.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:n.jsx(rs,{className:"w-5 h-5 text-blue-600"})}),n.jsx("span",{className:"font-medium text-gray-900",children:"HTML Report"})]}),n.jsx("p",{className:"text-sm text-gray-500",children:"Formatted report viewable in any browser"}),r&&h==="html"&&n.jsx(Ro,{className:"w-4 h-4 animate-spin mt-2"})]}),n.jsxs("button",{onClick:()=>ze("text"),disabled:r,className:"p-4 border border-gray-200 rounded-lg hover:border-aeria-blue hover:bg-aeria-sky transition-colors text-left",children:[n.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[n.jsx("div",{className:"p-2 bg-gray-100 rounded-lg",children:n.jsx(Sie,{className:"w-5 h-5 text-gray-600"})}),n.jsx("span",{className:"font-medium text-gray-900",children:"Plain Text"})]}),n.jsx("p",{className:"text-sm text-gray-500",children:"Simple text file for printing or email"}),r&&h==="text"&&n.jsx(Ro,{className:"w-4 h-4 animate-spin mt-2"})]}),n.jsxs("button",{onClick:()=>ze("copy"),disabled:r,className:"p-4 border border-gray-200 rounded-lg hover:border-aeria-blue hover:bg-aeria-sky transition-colors text-left",children:[n.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[n.jsx("div",{className:"p-2 bg-green-100 rounded-lg",children:w?n.jsx(ru,{className:"w-5 h-5 text-green-600"}):n.jsx(Op,{className:"w-5 h-5 text-green-600"})}),n.jsx("span",{className:"font-medium text-gray-900",children:w?"Copied!":"Copy to Clipboard"})]}),n.jsx("p",{className:"text-sm text-gray-500",children:"Copy summary to paste in email or document"})]}),n.jsxs("button",{onClick:()=>ze("json"),disabled:r,className:"p-4 border border-gray-200 rounded-lg hover:border-aeria-blue hover:bg-aeria-sky transition-colors text-left",children:[n.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[n.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:n.jsx(Bie,{className:"w-5 h-5 text-purple-600"})}),n.jsx("span",{className:"font-medium text-gray-900",children:"JSON Data"})]}),n.jsx("p",{className:"text-sm text-gray-500",children:"Full project data for backup or import"}),r&&h==="json"&&n.jsx(Ro,{className:"w-4 h-4 animate-spin mt-2"})]}),n.jsxs("button",{onClick:()=>ze("print"),disabled:r,className:"p-4 border border-gray-200 rounded-lg hover:border-aeria-blue hover:bg-aeria-sky transition-colors text-left",children:[n.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[n.jsx("div",{className:"p-2 bg-amber-100 rounded-lg",children:n.jsx(C6,{className:"w-5 h-5 text-amber-600"})}),n.jsx("span",{className:"font-medium text-gray-900",children:"Print"})]}),n.jsx("p",{className:"text-sm text-gray-500",children:"Print current view directly"})]}),n.jsxs("div",{className:"p-4 border border-gray-200 rounded-lg opacity-50 text-left",children:[n.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[n.jsx("div",{className:"p-2 bg-gray-100 rounded-lg",children:n.jsx(bT,{className:"w-5 h-5 text-gray-400"})}),n.jsx("span",{className:"font-medium text-gray-500",children:"Email"})]}),n.jsx("p",{className:"text-sm text-gray-400",children:"Coming soon"})]})]})]}),n.jsx("div",{className:"card bg-blue-50 border-blue-200",children:n.jsxs("div",{className:"flex gap-3",children:[n.jsx(Ns,{className:"w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"}),n.jsxs("div",{children:[n.jsx("h3",{className:"font-medium text-blue-900",children:"Export Notes"}),n.jsxs("p",{className:"text-sm text-blue-700 mt-1",children:["PDF exports include professional branding and are suitable for client delivery and regulatory submissions. Configure your company branding in Settings to customize the appearance of all exported documents.",ae&&n.jsxs("span",{className:"block mt-1",children:[n.jsx("strong",{children:"Multi-Site:"}),' Select "All Sites" to generate a comprehensive document, or choose a specific site for a focused report.']})]})]})]})})]})}const e5={inspection:{id:"inspection",name:"Infrastructure Inspection",icon:zy,description:"Power lines, pipelines, bridges, towers, buildings, solar farms",typicalPayloads:["rgb_camera","thermal","zoom_camera"],considerations:["Proximity to energized infrastructure","Electromagnetic interference potential","Access restrictions and permits","Weather windows for thermal imaging"],deliverables:["Inspection report","Annotated imagery","Thermal anomaly report","Asset condition assessment"],typicalAltitude:"30-120m AGL",typicalDuration:"20-45 min per flight",recommendedOperationType:"VLOS",riskFactors:["proximity_operations","critical_infrastructure","electromagnetic_interference"]},survey_mapping:{id:"survey_mapping",name:"Survey & Mapping",icon:Wn,description:"Topographic surveys, volumetrics, orthomosaics, 3D modeling",typicalPayloads:["rgb_camera","multispectral","lidar"],considerations:["Ground control point placement","Overlap and GSD requirements","Weather conditions for photogrammetry","Coordinate system and datum requirements"],deliverables:["Orthomosaic","Digital elevation model","Point cloud","Volumetric calculations","Survey report"],typicalAltitude:"60-120m AGL",typicalDuration:"15-30 min per sortie",recommendedOperationType:"VLOS",riskFactors:["large_area_coverage","altitude_requirements"]},construction:{id:"construction",name:"Construction Progress",icon:Qc,description:"Site progress monitoring, stockpile measurement, safety documentation",typicalPayloads:["rgb_camera","zoom_camera"],considerations:["Active construction site hazards","Coordination with site management","Worker proximity and notification","Equipment movement scheduling"],deliverables:["Progress photos","Site overview video","Stockpile volumes","Time-lapse compilation"],typicalAltitude:"60-100m AGL",typicalDuration:"15-25 min per flight",recommendedOperationType:"VLOS",riskFactors:["active_worksite","personnel_proximity","dynamic_environment"]},agriculture:{id:"agriculture",name:"Agriculture",icon:ire,description:"Crop health, irrigation monitoring, precision agriculture, livestock",typicalPayloads:["multispectral","thermal","rgb_camera"],considerations:["Crop growth stage timing","Spray drift considerations","Wildlife and livestock presence","Seasonal access restrictions"],deliverables:["NDVI maps","Crop health report","Irrigation assessment","Field boundary mapping"],typicalAltitude:"60-120m AGL",typicalDuration:"20-40 min per flight",recommendedOperationType:"VLOS",riskFactors:["large_area_coverage","wildlife_interaction"]},emergency:{id:"emergency",name:"Emergency Response",icon:Pj,description:"Search and rescue, disaster assessment, wildfire monitoring",typicalPayloads:["thermal","rgb_camera","zoom_camera","spotlight"],considerations:["Coordination with emergency services","Dynamic airspace restrictions","Time-critical operations","Communication with incident command"],deliverables:["Search area coverage","Thermal detection report","Situational awareness imagery","Damage assessment"],typicalAltitude:"30-150m AGL",typicalDuration:"20-45 min per flight",recommendedOperationType:"BVLOS",riskFactors:["time_critical","dynamic_airspace","coordination_complexity"]},media:{id:"media",name:"Media & Film",icon:y6,description:"Aerial cinematography, photography, real estate, events",typicalPayloads:["rgb_camera","cinema_camera","gimbal"],considerations:["Shot planning and storyboarding","Crowd and event coordination","Lighting conditions","Noise considerations"],deliverables:["Edited video","Still photography","Raw footage","Aerial panoramas"],typicalAltitude:"10-120m AGL",typicalDuration:"10-20 min per flight",recommendedOperationType:"VLOS",riskFactors:["public_proximity","event_coordination","noise_sensitive"]},security:{id:"security",name:"Security & Surveillance",icon:Ij,description:"Perimeter patrol, event security, asset monitoring",typicalPayloads:["rgb_camera","thermal","zoom_camera","spotlight"],considerations:["Privacy regulations compliance","Communication with security team","Coverage patterns and schedules","Night operations requirements"],deliverables:["Patrol coverage report","Incident documentation","Thermal scans","Security assessment"],typicalAltitude:"30-90m AGL",typicalDuration:"20-35 min per flight",recommendedOperationType:"VLOS",riskFactors:["night_operations","privacy_considerations","continuous_operations"]},environmental:{id:"environmental",name:"Environmental Monitoring",icon:jie,description:"Wildlife surveys, habitat mapping, erosion monitoring, spill detection",typicalPayloads:["multispectral","thermal","rgb_camera","gas_sensor"],considerations:["Wildlife disturbance protocols","Seasonal nesting restrictions","Habitat sensitivity","Regulatory permits for wildlife"],deliverables:["Wildlife count report","Habitat mapping","Change detection analysis","Environmental assessment"],typicalAltitude:"60-150m AGL",typicalDuration:"25-45 min per flight",recommendedOperationType:"VLOS",riskFactors:["wildlife_disturbance","sensitive_habitat","permit_requirements"]},mining:{id:"mining",name:"Mining Operations",icon:Aie,description:"Pit surveys, stockpile measurement, haul road inspection, blast monitoring",typicalPayloads:["rgb_camera","lidar","multispectral"],considerations:["Blast schedules and exclusion zones","Dust and particulate interference","Equipment movement coordination","Pit wall stability"],deliverables:["Volumetric calculations","Pit survey","Haul road assessment","Blast damage analysis"],typicalAltitude:"60-120m AGL",typicalDuration:"20-40 min per flight",recommendedOperationType:"VLOS",riskFactors:["active_mining","blast_coordination","dust_interference"]},linear:{id:"linear",name:"Linear Infrastructure",icon:_S,description:"Pipelines, transmission lines, railways, roads, corridors",typicalPayloads:["rgb_camera","thermal","lidar","gas_sensor"],considerations:["ROW access and permissions","Crossing agreements","Segment planning and logistics","Emergency landing zones along route"],deliverables:["Corridor assessment","Encroachment report","Condition survey","Thermal anomaly detection"],typicalAltitude:"30-90m AGL",typicalDuration:"25-45 min per segment",recommendedOperationType:"BVLOS",riskFactors:["extended_range","corridor_operations","multiple_jurisdictions"]}},zC={controlled:{id:"controlled",name:"Controlled Site",description:"Private property with access control, no uninvolved persons",populationCategory:"controlled",soraCategory:"Controlled ground area",characteristics:["Fenced or otherwise secured perimeter","Access controlled by operator or client","All persons aware of operations","No uninvolved third parties"],examples:["Secured industrial site","Private farm with gates","Closed construction site"],typicalSAIL:"I-II"},remote:{id:"remote",name:"Remote/Uninhabited",description:"Very low population density, minimal infrastructure",populationCategory:"sparse",soraCategory:"Remote/Rural",characteristics:["Population density < 50 people/km","Minimal infrastructure","Limited road access","Primarily natural terrain"],examples:["Remote wilderness","Offshore areas","Desert regions"],typicalSAIL:"I-II"},sparsely:{id:"sparsely",name:"Sparsely Populated",description:"Rural areas with scattered residences and light traffic",populationCategory:"sparse",soraCategory:"Sparsely populated",characteristics:["Population density 50-500 people/km","Scattered residences","Agricultural land use","Light vehicle traffic"],examples:["Agricultural areas","Rural communities","Light industrial zones"],typicalSAIL:"II-III"},suburban:{id:"suburban",name:"Suburban",description:"Residential areas with moderate population density",populationCategory:"moderate",soraCategory:"Suburban/Residential",characteristics:["Population density 500-2000 people/km","Residential neighborhoods","Local commercial areas","Moderate vehicle traffic"],examples:["Residential neighborhoods","Small town centers","Light commercial areas"],typicalSAIL:"III-IV"},urban:{id:"urban",name:"Urban",description:"Dense urban areas with high population and infrastructure",populationCategory:"populated",soraCategory:"Urban/Dense",characteristics:["Population density > 2000 people/km","Multi-story buildings","High pedestrian traffic","Complex infrastructure"],examples:["City centers","Downtown areas","Major commercial districts"],typicalSAIL:"IV-VI"},gathering:{id:"gathering",name:"Assembly of People",description:"Events, gatherings, or areas with concentrated populations",populationCategory:"gathering",soraCategory:"Assembly of people",characteristics:["Temporary or permanent gatherings","High local density during events","Limited dispersal capability","Public event considerations"],examples:["Sporting events","Concerts","Public gatherings","Markets"],typicalSAIL:"V-VI"},mixed:{id:"mixed",name:"Mixed Environment",description:"Operations spanning multiple environment types",populationCategory:"moderate",soraCategory:"Mixed",characteristics:["Varying population density","Multiple land use types","Requires per-segment assessment","Conservative approach recommended"],examples:["Linear infrastructure","Large project areas","Corridor operations"],typicalSAIL:"III-V"}},t5={uncontrolled_rural:{id:"uncontrolled_rural",name:"Uncontrolled Rural",class:"G",description:"Class G airspace in rural areas, no nearby aerodromes",complexity:"low",requirements:["No ATC authorization required","Standard altitude limits apply","NOTAM recommended for extended operations"],arcBase:"a"},uncontrolled_suburban:{id:"uncontrolled_suburban",name:"Uncontrolled Suburban",class:"G",description:"Class G airspace near populated areas",complexity:"low",requirements:["No ATC authorization required","Maintain awareness of local traffic","Consider helipad proximity"],arcBase:"a"},controlled_transition:{id:"controlled_transition",name:"Controlled Airspace (Transition)",class:"E",description:"Class E transition areas or control zones",complexity:"medium",requirements:["ATC authorization required","NAV CANADA coordination","NOTAM required","Two-way communication capability recommended"],arcBase:"b"},near_aerodrome:{id:"near_aerodrome",name:"Near Aerodrome",class:"D/E",description:"Within 5.6km of controlled aerodrome",complexity:"medium",requirements:["Site-specific authorization from NAV CANADA","Coordination with aerodrome operator","NOTAM required","Real-time communication capability"],arcBase:"b"},control_zone:{id:"control_zone",name:"Control Zone",class:"C/D",description:"Within airport control zone",complexity:"high",requirements:["SFOC likely required","Direct coordination with ATC","NOTAM required","Real-time ATC communication","Transponder recommended"],arcBase:"c"},restricted_special:{id:"restricted_special",name:"Restricted/Special Use",class:"F",description:"Military, restricted, or special use airspace",complexity:"high",requirements:["Special authorization required","Coordination with controlling authority","Time-limited operations","Additional security clearance may be required"],arcBase:"c"}},M0={vlos_day:{id:"vlos_day",name:"VLOS - Day",icon:R6,description:"Visual line of sight during daylight hours",requirements:["Basic or Advanced certificate","Unaided visual contact maintained"],complexity:"standard",sailModifier:0},vlos_twilight:{id:"vlos_twilight",name:"VLOS - Twilight",icon:Zie,description:"Visual line of sight during civil twilight",requirements:["Advanced certificate","Anti-collision lighting","Enhanced visibility measures"],complexity:"enhanced",sailModifier:0},vlos_night:{id:"vlos_night",name:"VLOS - Night",icon:zie,description:"Visual line of sight during night operations",requirements:["SFOC required","Anti-collision lighting","Night-specific training","Enhanced procedures"],complexity:"advanced",sailModifier:1},evlos_day:{id:"evlos_day",name:"EVLOS - Day",icon:ga,description:"Extended visual line of sight with visual observers",requirements:["Advanced certificate","Qualified visual observers","Communication protocols"],complexity:"enhanced",sailModifier:0},bvlos_day:{id:"bvlos_day",name:"BVLOS - Day",icon:Jc,description:"Beyond visual line of sight daytime operations",requirements:["SFOC required","Detect and avoid capability","Redundant C2 link","Emergency procedures"],complexity:"advanced",sailModifier:1},bvlos_night:{id:"bvlos_night",name:"BVLOS - Night",icon:Jc,description:"Beyond visual line of sight night operations",requirements:["SFOC required","Full DAA system","Enhanced lighting","Night BVLOS procedures"],complexity:"high",sailModifier:2}},VU={point:{id:"point",name:"Point/Asset",description:"Single structure or asset inspection",areaRange:"< 1 ha",flightEstimate:"1-2 flights",platformSuggestion:"Multi-rotor"},small_area:{id:"small_area",name:"Small Area",description:"Limited area survey or inspection",areaRange:"1-10 ha",flightEstimate:"2-4 flights",platformSuggestion:"Multi-rotor"},medium_area:{id:"medium_area",name:"Medium Area",description:"Site-wide coverage or moderate survey",areaRange:"10-50 ha",flightEstimate:"4-8 flights",platformSuggestion:"Multi-rotor or VTOL"},large_area:{id:"large_area",name:"Large Area",description:"Extensive area mapping or survey",areaRange:"50-200 ha",flightEstimate:"8-15 flights",platformSuggestion:"VTOL or Fixed-wing"},very_large:{id:"very_large",name:"Very Large Area",description:"Regional or district-scale coverage",areaRange:"200-1000 ha",flightEstimate:"15-30+ flights",platformSuggestion:"Fixed-wing or VTOL"},linear_short:{id:"linear_short",name:"Linear - Short",description:"Short corridor or linear feature",areaRange:"< 5 km",flightEstimate:"1-3 flights",platformSuggestion:"Multi-rotor"},linear_long:{id:"linear_long",name:"Linear - Extended",description:"Extended corridor or pipeline",areaRange:"5-50+ km",flightEstimate:"5-20+ flights",platformSuggestion:"VTOL or Fixed-wing (BVLOS)"}},O0={rgb_camera:{id:"rgb_camera",name:"RGB Camera",icon:bl,description:"Standard visual spectrum camera",weight:"light",typicalWeight:"100-500g",applications:["Photography","Videography","Mapping","Inspection"],dataOutput:"Images, Video"},zoom_camera:{id:"zoom_camera",name:"Zoom/Optical Camera",icon:bl,description:"High-zoom optical camera for detailed inspection",weight:"medium",typicalWeight:"300-800g",applications:["Detailed inspection","Wildlife observation","Security"],dataOutput:"High-resolution images, Video"},thermal:{id:"thermal",name:"Thermal Infrared",icon:k6,description:"Thermal imaging camera",weight:"medium",typicalWeight:"200-600g",applications:["Electrical inspection","Search and rescue","Building assessment","Wildlife"],dataOutput:"Radiometric images, FLIR video"},multispectral:{id:"multispectral",name:"Multispectral",icon:vT,description:"Multi-band spectral imaging for agriculture/environment",weight:"medium",typicalWeight:"200-500g",applications:["Crop health","Environmental monitoring","Vegetation analysis"],dataOutput:"Multi-band imagery, NDVI/NDRE maps"},lidar:{id:"lidar",name:"LiDAR",icon:qie,description:"Light Detection and Ranging sensor",weight:"heavy",typicalWeight:"500-2000g",applications:["Topographic survey","Forestry","Corridor mapping","Volumetrics"],dataOutput:"Point cloud, DEM, DTM"},gas_sensor:{id:"gas_sensor",name:"Gas Detection",icon:by,description:"Methane or multi-gas detection sensor",weight:"medium",typicalWeight:"200-800g",applications:["Pipeline inspection","Environmental monitoring","Industrial safety"],dataOutput:"Gas concentration data, Leak detection"},cinema_camera:{id:"cinema_camera",name:"Cinema Camera",icon:y6,description:"Professional cinema-grade camera system",weight:"heavy",typicalWeight:"1000-3000g",applications:["Film production","Commercial video","Broadcast"],dataOutput:"RAW video, ProRes"},spotlight:{id:"spotlight",name:"Spotlight/Illumination",icon:Pj,description:"High-intensity illumination for night operations",weight:"medium",typicalWeight:"300-800g",applications:["Search and rescue","Night inspection","Security"],dataOutput:"N/A (illumination)"},delivery:{id:"delivery",name:"Delivery/Drop System",icon:f6,description:"Payload delivery or release mechanism",weight:"varies",typicalWeight:"200-2000g",applications:["Medical delivery","Supply drop","Emergency response"],dataOutput:"Delivery confirmation"},gimbal:{id:"gimbal",name:"Gimbal System",icon:cf,description:"Stabilized gimbal mount for cameras",weight:"medium",typicalWeight:"300-1000g",applications:["Stabilized video","Inspection","Cinematography"],dataOutput:"N/A (stabilization)"}},N2=t=>{const e=t.map(r=>{var c;return((c=O0[r])==null?void 0:c.weight)||"light"});return e.includes("heavy")||e.filter(r=>r==="medium").length>=2?"heavy":e.includes("medium")?"medium":"light"},UU=t=>{const{operationType:e,environment:r,airspace:c,payloads:h}=t;return[e==null?void 0:e.includes("night"),e==null?void 0:e.includes("bvlos"),c==="control_zone"||c==="restricted_special",r==="gathering",r==="urban"&&e!=="vlos_day"].filter(Boolean).length>=1?{pathway:"SFOC",reason:"Special Flight Operations Certificate required due to: "+[(e==null?void 0:e.includes("night"))&&"Night operations",(e==null?void 0:e.includes("bvlos"))&&"BVLOS operations",(c==="control_zone"||c==="restricted_special")&&"Complex airspace",r==="gathering"&&"Operations over gatherings",r==="urban"&&e!=="vlos_day"&&"Urban operations"].filter(Boolean).join(", "),complexity:"high"}:[r==="suburban"||r==="urban",c==="controlled_transition"||c==="near_aerodrome",e==="evlos_day"||e==="vlos_twilight"].filter(Boolean).length>=1?{pathway:"Advanced",reason:"Advanced operations certificate required for operations in "+[(r==="suburban"||r==="urban")&&"populated areas",(c==="controlled_transition"||c==="near_aerodrome")&&"controlled airspace",(e==="evlos_day"||e==="vlos_twilight")&&"EVLOS/twilight operations"].filter(Boolean).join(", "),complexity:"medium"}:{pathway:"Basic",reason:"Basic operations in uncontrolled airspace over unpopulated areas",complexity:"low"}},poe=t=>{var C;const{operationType:e,environment:r,airspace:c}=t;let h=1;switch(r){case"controlled":h=1;break;case"remote":h=1;break;case"sparsely":h=2;break;case"suburban":h=3;break;case"urban":h=4;break;case"gathering":h=5;break;case"mixed":h=3;break;default:h=2}let x=0;(c==="control_zone"||c==="restricted_special")&&(x=1);const w=((C=M0[e])==null?void 0:C.sailModifier)||0,o=Math.min(6,Math.max(1,h+x+w));return{level:["I","II","III","IV","V","VI"][o-1],numeric:o,factors:{environment:h,airspace:x,operationType:w}}},moe=t=>{const{missionProfile:e,operationType:r,coverage:c,environment:h}=t,x={pic:{required:!0,count:1,notes:[]},vo:{required:!1,count:0,notes:[]},payloadOperator:{required:!1,count:0,notes:[]},groundSupport:{required:!1,count:0,notes:[]}};r!=null&&r.includes("evlos")&&(x.vo.required=!0,x.vo.count=1,x.vo.notes.push("Required for EVLOS operations")),(c==="large_area"||c==="very_large"||c==="linear_long")&&(x.vo.required=!0,x.vo.count=Math.max(x.vo.count,2),x.vo.notes.push("Recommended for large area operations"));const w=["lidar","multispectral","cinema_camera","gas_sensor"];return(t.payloads||[]).some(C=>w.includes(C))&&(x.payloadOperator.required=!0,x.payloadOperator.count=1,x.payloadOperator.notes.push("Complex payload requires dedicated operator")),(h==="urban"||h==="gathering")&&(x.groundSupport.required=!0,x.groundSupport.count=1,x.groundSupport.notes.push("Crowd/traffic management in populated areas")),(e==="emergency"||e==="security")&&(x.groundSupport.count=Math.max(x.groundSupport.count,2),x.groundSupport.notes.push("Coordination with emergency/security services")),x},foe=t=>{const{missionProfile:e,coverage:r,payloads:c,operationType:h}=t,x=VU[r],w=N2(c||[]);let o="Multi-rotor";r==="very_large"||r==="linear_long"?o="Fixed-wing or VTOL":(r==="large_area"||r==="linear_short")&&(o="Multi-rotor or VTOL");let C="250g";w==="medium"&&(C="500g"),w==="heavy"&&(C="1kg+");let R="20 min";["large_area","very_large","linear_long"].includes(r)&&(R="30+ min");const F=[];return(h!=null&&h.includes("night")||h!=null&&h.includes("twilight"))&&F.push("Anti-collision lighting"),h!=null&&h.includes("bvlos")&&F.push("Redundant C2 link","Return-to-home","Geofencing"),c!=null&&c.includes("thermal")&&F.push("Gimbal compatibility"),c!=null&&c.includes("lidar")&&F.push("Stable platform","High payload capacity"),e==="emergency"&&F.push("Quick deployment","All-weather capability"),{platformType:o,minCapacity:C,minFlightTime:R,features:F,recommendation:(x==null?void 0:x.platformSuggestion)||o}},goe=t=>{const{missionProfile:e,operationType:r,payloads:c,environment:h,airspace:x}=t,w={flightEquipment:[{item:"Aircraft (primary)",required:!0},{item:"Spare batteries (min 3)",required:!0},{item:"Battery charger",required:!0},{item:"Controller",required:!0},{item:"Mobile device with flight app",required:!0},{item:"Landing pad",required:!0}],safetyEquipment:[{item:"Fire extinguisher",required:!0},{item:"First aid kit",required:!0},{item:"High-visibility vest",required:!0},{item:"Safety cones/tape",required:h!=="remote"},{item:"Hard hat",required:["construction","mining","inspection"].includes(e)}],communicationEquipment:[{item:"Two-way radio",required:!0},{item:"Mobile phone",required:!0},{item:"Aviation radio",required:["control_zone","near_aerodrome","controlled_transition"].includes(x)}],documentationEquipment:[{item:"Pilot certificate",required:!0},{item:"Aircraft registration",required:!0},{item:"Insurance documentation",required:!0},{item:"Site authorization",required:h!=="controlled"},{item:"SFOC (if applicable)",required:(r==null?void 0:r.includes("bvlos"))||(r==null?void 0:r.includes("night"))}],payloadEquipment:[],additionalEquipment:[]};return c!=null&&c.includes("thermal")&&w.payloadEquipment.push({item:"Thermal calibration target",required:!1}),c!=null&&c.includes("lidar")&&w.payloadEquipment.push({item:"LiDAR sensor",required:!0},{item:"Ground control points",required:!0},{item:"RTK base station",required:!1}),c!=null&&c.includes("multispectral")&&w.payloadEquipment.push({item:"Calibration panel",required:!0},{item:"GPS ground control",required:!0}),e==="survey_mapping"&&w.additionalEquipment.push({item:"Ground control points",required:!0},{item:"RTK/PPK receiver",required:!1},{item:"Measuring tape/rod",required:!1}),e==="emergency"&&w.additionalEquipment.push({item:"Spotlight/floodlight",required:r==null?void 0:r.includes("night")},{item:"Emergency beacon",required:!1},{item:"Incident command radio",required:!0}),r!=null&&r.includes("night")&&w.additionalEquipment.push({item:"Headlamp/flashlight",required:!0},{item:"Reflective markers",required:!0},{item:"Illuminated landing pad",required:!0}),w},yoe=t=>{const{operationType:e,environment:r,airspace:c}=t,h=UU(t),x={required:["Pilot certificate (appropriate level)","Aircraft registration","Proof of insurance","Flight log/records"],recommended:["Site risk assessment","Emergency response plan","Client authorization/contract"],operational:["Pre-flight checklist","Daily flight log","Weather briefing documentation"]};return h.pathway==="Advanced"&&x.required.push("Advanced pilot certificate","NAV CANADA authorization (if applicable)","Site survey documentation"),h.pathway==="SFOC"&&x.required.push("SFOC (Special Flight Operations Certificate)","SFOC-specific operating procedures","Crew qualification records","Aircraft airworthiness documentation"),["control_zone","near_aerodrome","controlled_transition"].includes(c)&&x.required.push("NAV CANADA authorization","NOTAM request/confirmation"),e!=null&&e.includes("bvlos")&&x.required.push("BVLOS-specific procedures","DAA system documentation","C2 link specifications"),x};function Hg({title:t,icon:e,children:r,defaultOpen:c=!0,badge:h=null,complete:x=null}){const[w,o]=ue.useState(c);return n.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[n.jsxs("button",{onClick:()=>o(!w),className:"w-full px-4 py-3 bg-gray-50 flex items-center justify-between hover:bg-gray-100 transition-colors",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[e&&n.jsx(e,{className:"w-5 h-5 text-gray-500"}),n.jsx("span",{className:"font-medium text-gray-900",children:t}),h&&n.jsx("span",{className:"px-2 py-0.5 text-xs font-medium bg-aeria-navy/10 text-aeria-navy rounded-full",children:h}),x!==null&&n.jsx("span",{className:`px-2 py-0.5 text-xs font-medium rounded-full ${x?"bg-green-100 text-green-700":"bg-amber-100 text-amber-700"}`,children:x?"Complete":"Incomplete"})]}),w?n.jsx($n,{className:"w-5 h-5 text-gray-400"}):n.jsx(fn,{className:"w-5 h-5 text-gray-400"})]}),w&&n.jsx("div",{className:"p-4 space-y-4",children:r})]})}function i5({item:t,selected:e,onSelect:r,icon:c}){return n.jsx("button",{onClick:()=>r(t.id),className:`p-4 rounded-lg border-2 text-left transition-all ${e?"border-aeria-navy bg-aeria-navy/5":"border-gray-200 hover:border-gray-300 hover:bg-gray-50"}`,children:n.jsxs("div",{className:"flex items-start gap-3",children:[c?n.jsx(c,{className:`w-6 h-6 flex-shrink-0 ${e?"text-aeria-navy":"text-gray-400"}`}):t.icon?n.jsx(t.icon,{className:`w-6 h-6 flex-shrink-0 ${e?"text-aeria-navy":"text-gray-400"}`}):null,n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsx("p",{className:`font-medium ${e?"text-aeria-navy":"text-gray-900"}`,children:t.name}),n.jsx("p",{className:"text-sm text-gray-500 mt-1",children:t.description})]}),e&&n.jsx(qr,{className:"w-5 h-5 text-aeria-navy flex-shrink-0"})]})})}function Yw({type:t="info",children:e}){const r={info:"bg-blue-50 border-blue-200 text-blue-800",warning:"bg-amber-50 border-amber-200 text-amber-800",success:"bg-green-50 border-green-200 text-green-800",error:"bg-red-50 border-red-200 text-red-800"},h={info:Ns,warning:ir,success:qr,error:ir}[t];return n.jsx("div",{className:`p-4 rounded-lg border ${r[t]}`,children:n.jsxs("div",{className:"flex items-start gap-3",children:[n.jsx(h,{className:"w-5 h-5 flex-shrink-0 mt-0.5"}),n.jsx("div",{className:"flex-1",children:e})]})})}function xoe({payload:t,selected:e,onToggle:r}){const c=({weight:h})=>{const x={light:"bg-green-100 text-green-700",medium:"bg-amber-100 text-amber-700",heavy:"bg-red-100 text-red-700",varies:"bg-gray-100 text-gray-700"};return n.jsx("span",{className:`px-2 py-0.5 text-xs font-medium rounded ${x[h]}`,children:h})};return n.jsxs("button",{onClick:()=>r(t.id),className:`p-3 rounded-lg border-2 text-left transition-all ${e?"border-aeria-navy bg-aeria-navy/5":"border-gray-200 hover:border-gray-300"}`,children:[n.jsxs("div",{className:"flex items-center justify-between mb-2",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(t.icon,{className:`w-5 h-5 ${e?"text-aeria-navy":"text-gray-400"}`}),n.jsx("span",{className:`font-medium text-sm ${e?"text-aeria-navy":"text-gray-900"}`,children:t.name})]}),n.jsx(c,{weight:t.weight})]}),n.jsx("p",{className:"text-xs text-gray-500",children:t.description})]})}function _oe({pathway:t}){if(!t)return null;const e={Basic:"bg-green-100 border-green-300 text-green-800",Advanced:"bg-amber-100 border-amber-300 text-amber-800",SFOC:"bg-red-100 border-red-300 text-red-800"};return n.jsxs("div",{className:`p-4 rounded-lg border-2 ${e[t.pathway]}`,children:[n.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[n.jsx(Ds,{className:"w-6 h-6"}),n.jsxs("div",{children:[n.jsx("p",{className:"text-xs uppercase tracking-wide opacity-75",children:"Regulatory Pathway"}),n.jsxs("p",{className:"text-xl font-bold",children:[t.pathway," Operations"]})]})]}),n.jsx("p",{className:"text-sm opacity-90",children:t.reason})]})}function voe({sail:t}){if(!t)return null;const e={I:"bg-green-100 border-green-300 text-green-800",II:"bg-lime-100 border-lime-300 text-lime-800",III:"bg-amber-100 border-amber-300 text-amber-800",IV:"bg-orange-100 border-orange-300 text-orange-800",V:"bg-red-100 border-red-300 text-red-800",VI:"bg-red-200 border-red-400 text-red-900"};return n.jsxs("div",{className:`p-4 rounded-lg border-2 ${e[t.level]}`,children:[n.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[n.jsx(Rv,{className:"w-6 h-6"}),n.jsxs("div",{children:[n.jsx("p",{className:"text-xs uppercase tracking-wide opacity-75",children:"Estimated SAIL Level"}),n.jsxs("p",{className:"text-2xl font-bold",children:["SAIL ",t.level]})]})]}),n.jsxs("div",{className:"grid grid-cols-3 gap-2 text-xs",children:[n.jsxs("div",{className:"bg-white/50 rounded p-2",children:[n.jsx("p",{className:"opacity-75",children:"Environment"}),n.jsxs("p",{className:"font-semibold",children:["+",t.factors.environment]})]}),n.jsxs("div",{className:"bg-white/50 rounded p-2",children:[n.jsx("p",{className:"opacity-75",children:"Airspace"}),n.jsxs("p",{className:"font-semibold",children:["+",t.factors.airspace]})]}),n.jsxs("div",{className:"bg-white/50 rounded p-2",children:[n.jsx("p",{className:"opacity-75",children:"Operation"}),n.jsxs("p",{className:"font-semibold",children:["+",t.factors.operationType]})]})]})]})}function boe({requirements:t}){if(!t)return null;const e=[{key:"pic",name:"Pilot-in-Command",icon:ds},{key:"vo",name:"Visual Observer",icon:ga},{key:"payloadOperator",name:"Payload Operator",icon:bl},{key:"groundSupport",name:"Ground Support",icon:Ij}];return n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[n.jsxs("h4",{className:"font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[n.jsx(ds,{className:"w-5 h-5 text-aeria-navy"}),"Crew Requirements"]}),n.jsx("div",{className:"space-y-3",children:e.map(r=>{const c=t[r.key];return c?n.jsxs("div",{className:`flex items-start gap-3 p-3 rounded-lg ${c.required?"bg-aeria-navy/5":"bg-gray-50"}`,children:[n.jsx(r.icon,{className:`w-5 h-5 ${c.required?"text-aeria-navy":"text-gray-400"}`}),n.jsxs("div",{className:"flex-1",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:`font-medium ${c.required?"text-gray-900":"text-gray-500"}`,children:r.name}),n.jsx("span",{className:`px-2 py-0.5 text-xs font-medium rounded ${c.required?"bg-aeria-navy text-white":"bg-gray-200 text-gray-600"}`,children:c.required?`Required (${c.count})`:"Optional"})]}),c.notes.length>0&&n.jsx("ul",{className:"mt-1 text-xs text-gray-500",children:c.notes.map((h,x)=>n.jsxs("li",{children:[" ",h]},x))})]})]},r.key):null})})]})}function woe({requirements:t}){return t?n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[n.jsxs("h4",{className:"font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[n.jsx(Zn,{className:"w-5 h-5 text-aeria-navy"}),"Aircraft Requirements"]}),n.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[n.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[n.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Platform Type"}),n.jsx("p",{className:"font-medium text-gray-900",children:t.platformType})]}),n.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[n.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Min Payload Capacity"}),n.jsx("p",{className:"font-medium text-gray-900",children:t.minCapacity})]}),n.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[n.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Min Flight Time"}),n.jsx("p",{className:"font-medium text-gray-900",children:t.minFlightTime})]}),n.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[n.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Recommendation"}),n.jsx("p",{className:"font-medium text-gray-900",children:t.recommendation})]})]}),t.features.length>0&&n.jsxs("div",{children:[n.jsx("p",{className:"text-sm font-medium text-gray-700 mb-2",children:"Required Features:"}),n.jsx("div",{className:"flex flex-wrap gap-2",children:t.features.map((e,r)=>n.jsx("span",{className:"px-2 py-1 bg-aeria-navy/10 text-aeria-navy text-xs rounded",children:e},r))})]})]}):null}function Soe({equipment:t}){if(!t)return null;const e=[{key:"flightEquipment",name:"Flight Equipment",icon:Zn},{key:"safetyEquipment",name:"Safety Equipment",icon:Ds},{key:"communicationEquipment",name:"Communication",icon:Jc},{key:"documentationEquipment",name:"Documentation",icon:rs},{key:"payloadEquipment",name:"Payload Equipment",icon:bl},{key:"additionalEquipment",name:"Additional Equipment",icon:f6}];return n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[n.jsxs("h4",{className:"font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[n.jsx(kie,{className:"w-5 h-5 text-aeria-navy"}),"Equipment Checklist"]}),n.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:e.map(r=>{const c=t[r.key]||[];return c.length===0?null:n.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[n.jsxs("h5",{className:"font-medium text-gray-900 mb-2 flex items-center gap-2 text-sm",children:[n.jsx(r.icon,{className:"w-4 h-4 text-gray-500"}),r.name]}),n.jsx("ul",{className:"space-y-1",children:c.map((h,x)=>n.jsxs("li",{className:"flex items-center gap-2 text-sm",children:[h.required?n.jsx(qr,{className:"w-4 h-4 text-green-500 flex-shrink-0"}):n.jsx("div",{className:"w-4 h-4 border border-gray-300 rounded flex-shrink-0"}),n.jsx("span",{className:h.required?"text-gray-900":"text-gray-500",children:h.item})]},x))})]},r.key)})})]})}function Toe({docs:t}){return t?n.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[n.jsxs("h4",{className:"font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[n.jsx(eb,{className:"w-5 h-5 text-aeria-navy"}),"Documentation Requirements"]}),n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[n.jsxs("div",{children:[n.jsxs("h5",{className:"font-medium text-red-700 mb-2 text-sm flex items-center gap-1",children:[n.jsx(ir,{className:"w-4 h-4"}),"Required"]}),n.jsx("ul",{className:"space-y-1",children:t.required.map((e,r)=>n.jsxs("li",{className:"text-sm text-gray-700 flex items-start gap-2",children:[n.jsx(ko,{className:"w-4 h-4 text-red-500 flex-shrink-0 mt-0.5"}),e]},r))})]}),n.jsxs("div",{children:[n.jsxs("h5",{className:"font-medium text-amber-700 mb-2 text-sm flex items-center gap-1",children:[n.jsx(Ns,{className:"w-4 h-4"}),"Recommended"]}),n.jsx("ul",{className:"space-y-1",children:t.recommended.map((e,r)=>n.jsxs("li",{className:"text-sm text-gray-700 flex items-start gap-2",children:[n.jsx(ko,{className:"w-4 h-4 text-amber-500 flex-shrink-0 mt-0.5"}),e]},r))})]}),n.jsxs("div",{children:[n.jsxs("h5",{className:"font-medium text-gray-700 mb-2 text-sm flex items-center gap-1",children:[n.jsx(x6,{className:"w-4 h-4"}),"Operational"]}),n.jsx("ul",{className:"space-y-1",children:t.operational.map((e,r)=>n.jsxs("li",{className:"text-sm text-gray-700 flex items-start gap-2",children:[n.jsx(ko,{className:"w-4 h-4 text-gray-400 flex-shrink-0 mt-0.5"}),e]},r))})]})]})]}):null}function Noe({project:t,onUpdate:e,onNavigate:r}){var Y;const[c,h]=ue.useState(()=>(t==null?void 0:t.needsAnalysis)||{missionProfile:null,environment:null,airspace:null,operationType:null,coverage:null,payloads:[]}),[x,w]=ue.useState(!1),o=ue.useCallback((H,X)=>{h(he=>{const se={...he,[H]:X};return e&&e({needsAnalysis:se}),se})},[e]),C=ue.useCallback(H=>{h(X=>{const he=X.payloads||[],se=he.includes(H)?he.filter(K=>K!==H):[...he,H],de={...X,payloads:se};return e&&e({needsAnalysis:de}),de})},[e]),R=ue.useMemo(()=>!c.missionProfile||!c.environment||!c.airspace||!c.operationType?null:{regulatory:UU(c),sail:poe(c),crew:moe(c),aircraft:foe(c),equipment:goe(c),documentation:yoe(c)},[c]),F=ue.useMemo(()=>{var se;const H={missionProfile:!!c.missionProfile,environment:!!c.environment,airspace:!!c.airspace,operationType:!!c.operationType,coverage:!!c.coverage,payloads:(((se=c.payloads)==null?void 0:se.length)||0)>0},X=Object.values(H).filter(Boolean).length,he=Object.keys(H).length;return{checks:H,completed:X,total:he,percent:Math.round(X/he*100),isComplete:X===he}},[c]),$=c.missionProfile?e5[c.missionProfile]:null;return n.jsxs("div",{className:"space-y-6",children:[n.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:n.jsxs("div",{className:"flex items-start justify-between",children:[n.jsxs("div",{children:[n.jsxs("h2",{className:"text-xl font-bold text-gray-900 flex items-center gap-2",children:[n.jsx(go,{className:"w-6 h-6 text-aeria-navy"}),"CONOPS Needs Analysis"]}),n.jsx("p",{className:"text-gray-500 mt-1",children:"Define your operation requirements to determine regulatory pathway, crew, and equipment needs"})]}),n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsxs("div",{className:"text-right",children:[n.jsx("p",{className:"text-sm text-gray-500",children:"Completion"}),n.jsxs("p",{className:`text-lg font-bold ${F.percent===100?"text-green-600":"text-gray-900"}`,children:[F.percent,"%"]})]}),n.jsx("div",{className:"w-32 bg-gray-200 rounded-full h-2",children:n.jsx("div",{className:`h-2 rounded-full transition-all ${F.percent===100?"bg-green-500":"bg-aeria-navy"}`,style:{width:`${F.percent}%`}})})]})]})}),n.jsxs("div",{className:"space-y-4",children:[n.jsxs(Hg,{title:"Mission Profile",icon:go,badge:"Step 1",complete:F.checks.missionProfile,defaultOpen:!F.checks.missionProfile,children:[n.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Select the type of operation that best describes your mission objectives."}),n.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:Object.values(e5).map(H=>n.jsx(i5,{item:H,selected:c.missionProfile===H.id,onSelect:X=>o("missionProfile",X)},H.id))}),$&&n.jsxs("div",{className:"mt-4 p-4 bg-aeria-navy/5 rounded-lg",children:[n.jsx("h4",{className:"font-medium text-aeria-navy mb-3",children:"Mission Profile Details"}),n.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[n.jsxs("div",{children:[n.jsx("p",{className:"text-gray-500",children:"Typical Altitude"}),n.jsx("p",{className:"font-medium",children:$.typicalAltitude})]}),n.jsxs("div",{children:[n.jsx("p",{className:"text-gray-500",children:"Typical Duration"}),n.jsx("p",{className:"font-medium",children:$.typicalDuration})]}),n.jsxs("div",{children:[n.jsx("p",{className:"text-gray-500",children:"Recommended Op Type"}),n.jsx("p",{className:"font-medium",children:$.recommendedOperationType})]}),n.jsxs("div",{children:[n.jsx("p",{className:"text-gray-500",children:"Common Payloads"}),n.jsx("p",{className:"font-medium",children:$.typicalPayloads.map(H=>{var X;return((X=O0[H])==null?void 0:X.name)||H}).join(", ")})]})]}),n.jsxs("div",{className:"mt-3",children:[n.jsx("p",{className:"text-gray-500 text-sm mb-1",children:"Key Considerations:"}),n.jsx("ul",{className:"text-sm text-gray-700 space-y-1",children:$.considerations.map((H,X)=>n.jsxs("li",{className:"flex items-start gap-2",children:[n.jsx(ko,{className:"w-4 h-4 text-aeria-navy flex-shrink-0 mt-0.5"}),H]},X))})]})]})]}),n.jsxs(Hg,{title:"Operating Environment",icon:Wn,badge:"Step 2",complete:F.checks.environment,defaultOpen:F.checks.missionProfile&&!F.checks.environment,children:[n.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Characterize the ground environment where operations will take place."}),n.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:Object.values(zC).map(H=>n.jsx(i5,{item:H,selected:c.environment===H.id,onSelect:X=>o("environment",X)},H.id))}),c.environment&&n.jsxs(Yw,{type:"info",children:[n.jsx("strong",{children:"SORA Category:"})," ",zC[c.environment].soraCategory,n.jsx("br",{}),n.jsx("strong",{children:"Typical SAIL Range:"})," ",zC[c.environment].typicalSAIL]})]}),n.jsxs(Hg,{title:"Airspace",icon:Zn,badge:"Step 3",complete:F.checks.airspace,defaultOpen:F.checks.environment&&!F.checks.airspace,children:[n.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Select the airspace scenario that applies to your operation area."}),n.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:Object.values(t5).map(H=>n.jsxs("button",{onClick:()=>o("airspace",H.id),className:`p-4 rounded-lg border-2 text-left transition-all ${c.airspace===H.id?"border-aeria-navy bg-aeria-navy/5":"border-gray-200 hover:border-gray-300"}`,children:[n.jsxs("div",{className:"flex items-start justify-between mb-2",children:[n.jsxs("div",{children:[n.jsx("p",{className:`font-medium ${c.airspace===H.id?"text-aeria-navy":"text-gray-900"}`,children:H.name}),n.jsxs("p",{className:"text-sm text-gray-500",children:["Class ",H.class]})]}),n.jsx("span",{className:`px-2 py-0.5 text-xs font-medium rounded ${H.complexity==="low"?"bg-green-100 text-green-700":H.complexity==="medium"?"bg-amber-100 text-amber-700":"bg-red-100 text-red-700"}`,children:H.complexity})]}),n.jsx("p",{className:"text-sm text-gray-500",children:H.description})]},H.id))}),c.airspace&&n.jsxs("div",{className:"mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg",children:[n.jsx("h4",{className:"font-medium text-amber-800 mb-2",children:"Requirements:"}),n.jsx("ul",{className:"text-sm text-amber-700 space-y-1",children:t5[c.airspace].requirements.map((H,X)=>n.jsxs("li",{className:"flex items-start gap-2",children:[n.jsx(ko,{className:"w-4 h-4 flex-shrink-0 mt-0.5"}),H]},X))})]})]}),n.jsxs(Hg,{title:"Operation Type",icon:ga,badge:"Step 4",complete:F.checks.operationType,defaultOpen:F.checks.airspace&&!F.checks.operationType,children:[n.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Define the visual line of sight and time-of-day parameters."}),n.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3",children:Object.values(M0).map(H=>n.jsxs("button",{onClick:()=>o("operationType",H.id),className:`p-4 rounded-lg border-2 text-left transition-all ${c.operationType===H.id?"border-aeria-navy bg-aeria-navy/5":"border-gray-200 hover:border-gray-300"}`,children:[n.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[n.jsx(H.icon,{className:`w-6 h-6 ${c.operationType===H.id?"text-aeria-navy":"text-gray-400"}`}),n.jsxs("div",{children:[n.jsx("p",{className:`font-medium ${c.operationType===H.id?"text-aeria-navy":"text-gray-900"}`,children:H.name}),n.jsx("p",{className:`text-xs ${H.complexity==="standard"?"text-green-600":H.complexity==="enhanced"?"text-amber-600":H.complexity==="advanced"?"text-orange-600":"text-red-600"}`,children:H.complexity})]})]}),n.jsx("p",{className:"text-sm text-gray-500",children:H.description})]},H.id))}),c.operationType&&n.jsxs(Yw,{type:M0[c.operationType].complexity==="standard"?"success":M0[c.operationType].complexity==="enhanced"?"info":"warning",children:[n.jsx("strong",{children:"Requirements:"}),n.jsx("ul",{className:"mt-1 space-y-1",children:M0[c.operationType].requirements.map((H,X)=>n.jsxs("li",{children:[" ",H]},X))})]})]}),n.jsxs(Hg,{title:"Coverage Requirements",icon:yie,badge:"Step 5",complete:F.checks.coverage,defaultOpen:F.checks.operationType&&!F.checks.coverage,children:[n.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Estimate the area or distance to be covered."}),n.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:Object.values(VU).map(H=>n.jsxs("button",{onClick:()=>o("coverage",H.id),className:`p-4 rounded-lg border-2 text-left transition-all ${c.coverage===H.id?"border-aeria-navy bg-aeria-navy/5":"border-gray-200 hover:border-gray-300"}`,children:[n.jsx("p",{className:`font-medium ${c.coverage===H.id?"text-aeria-navy":"text-gray-900"}`,children:H.name}),n.jsx("p",{className:"text-sm text-gray-500 mb-2",children:H.description}),n.jsxs("div",{className:"flex items-center gap-4 text-xs",children:[n.jsxs("span",{className:"text-gray-500",children:[n.jsx("strong",{children:"Area:"})," ",H.areaRange]}),n.jsxs("span",{className:"text-gray-500",children:[n.jsx("strong",{children:"Est. Flights:"})," ",H.flightEstimate]})]}),n.jsxs("p",{className:"text-xs text-aeria-navy mt-1",children:[n.jsx("strong",{children:"Platform:"})," ",H.platformSuggestion]})]},H.id))})]}),n.jsxs(Hg,{title:"Payloads & Sensors",icon:bl,badge:"Step 6",complete:F.checks.payloads,defaultOpen:F.checks.coverage&&!F.checks.payloads,children:[n.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Select all payload types required for the mission. Weight classification affects aircraft requirements."}),$&&n.jsxs(Yw,{type:"info",children:[n.jsxs("strong",{children:["Recommended for ",$.name,":"]})," ",$.typicalPayloads.map(H=>{var X;return((X=O0[H])==null?void 0:X.name)||H}).join(", ")]}),n.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mt-4",children:Object.values(O0).map(H=>{var X;return n.jsx(xoe,{payload:H,selected:(X=c.payloads)==null?void 0:X.includes(H.id),onToggle:C},H.id)})}),((Y=c.payloads)==null?void 0:Y.length)>0&&n.jsxs("div",{className:"mt-4 p-3 bg-gray-50 rounded-lg",children:[n.jsxs("p",{className:"text-sm text-gray-600",children:[n.jsxs("strong",{children:["Selected (",c.payloads.length,"):"]})," ",c.payloads.map(H=>{var X;return(X=O0[H])==null?void 0:X.name}).join(", ")]}),n.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:[n.jsx("strong",{children:"Combined Weight Class:"})," ",n.jsx("span",{className:`font-medium ${N2(c.payloads)==="light"?"text-green-600":N2(c.payloads)==="medium"?"text-amber-600":"text-red-600"}`,children:N2(c.payloads)})]})]})]})]}),F.isComplete&&n.jsx("div",{className:"flex justify-center",children:n.jsxs("button",{onClick:()=>w(!x),className:"btn-primary flex items-center gap-2 px-6 py-3",children:[n.jsx(pie,{className:"w-5 h-5"}),x?"Hide Analysis Results":"Generate Analysis Results",n.jsx(fc,{className:"w-5 h-5"})]})}),x&&R&&n.jsxs("div",{className:"space-y-4",children:[n.jsx("div",{className:"border-t border-gray-200 pt-6",children:n.jsxs("h3",{className:"text-lg font-bold text-gray-900 mb-4 flex items-center gap-2",children:[n.jsx(Ul,{className:"w-6 h-6 text-aeria-navy"}),"Analysis Results"]})}),n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[n.jsx(_oe,{pathway:R.regulatory}),n.jsx(voe,{sail:R.sail})]}),n.jsxs("div",{className:"space-y-4",children:[n.jsx(boe,{requirements:R.crew}),n.jsx(woe,{requirements:R.aircraft}),n.jsx(Soe,{equipment:R.equipment}),n.jsx(Toe,{docs:R.documentation})]}),n.jsxs("div",{className:"flex items-center justify-between pt-4 border-t border-gray-200",children:[n.jsxs("button",{onClick:()=>w(!1),className:"btn-secondary flex items-center gap-2",children:[n.jsx(eu,{className:"w-4 h-4"}),"Modify Analysis"]}),n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsxs("button",{onClick:()=>r==null?void 0:r("site-survey"),className:"btn-secondary flex items-center gap-2",children:[n.jsx(Wn,{className:"w-4 h-4"}),"Continue to Site Survey"]}),n.jsxs("button",{onClick:()=>r==null?void 0:r("flight-plan"),className:"btn-primary flex items-center gap-2",children:[n.jsx(Zn,{className:"w-4 h-4"}),"Continue to Flight Plan",n.jsx(fc,{className:"w-4 h-4"})]})]})]})]}),!F.isComplete&&n.jsx(Yw,{type:"info",children:"Complete all six analysis sections to generate your regulatory pathway, crew requirements, aircraft specifications, and equipment checklist. This analysis helps ensure you have the right resources and documentation before beginning detailed flight planning."})]})}const Aoe=[{id:"overview",label:"Overview",icon:Zm},{id:"needs",label:"Needs Analysis",icon:go},{id:"sections",label:"Sections",icon:Gie},{id:"crew",label:"Crew",icon:ds},{id:"site",label:"Site Survey",icon:Wn,toggleable:!0,sectionKey:"siteSurvey"},{id:"flight",label:"Flight Plan",icon:Zn,toggleable:!0,sectionKey:"flightPlan"},{id:"hseRisk",label:"HSE Risk",icon:ir},{id:"sora",label:"SORA",icon:Ds},{id:"emergency",label:"Emergency",icon:E6},{id:"ppe",label:"PPE",icon:Qc},{id:"comms",label:"Communications",icon:Jc},{id:"review",label:"Review",icon:eb},{id:"tailgate",label:"Tailgate",icon:rs},{id:"forms",label:"Forms",icon:Ll},{id:"export",label:"Export",icon:vc}],Coe={draft:"bg-gray-100 text-gray-700 border-gray-300",planning:"bg-blue-100 text-blue-700 border-blue-300",active:"bg-green-100 text-green-700 border-green-300",completed:"bg-purple-100 text-purple-700 border-purple-300",archived:"bg-gray-100 text-gray-500 border-gray-300"},ao={IDLE:"idle",PENDING:"pending",SAVING:"saving",SAVED:"saved",ERROR:"error"};function Eoe(){const{projectId:t}=NP(),e=tu();jp();const[r,c]=ue.useState(null),[h,x]=ue.useState(!0),[w,o]=ue.useState(""),[C,R]=ue.useState("overview"),[F,$]=ue.useState(!1),[Y,H]=ue.useState(ao.IDLE),[X,he]=ue.useState(null),[se,de]=ue.useState(null),K=ue.useRef(r),ge=ue.useRef(null),Ae=ue.useRef(!1);ue.useEffect(()=>{K.current=r},[r]),ue.useEffect(()=>(Te(),()=>{ge.current&&clearTimeout(ge.current),Ae.current&&K.current&&Ce(K.current)}),[t]),ue.useEffect(()=>{(async()=>{if(r!=null&&r.clientId)try{const Ke=(await ix()).find(Pe=>Pe.id===r.clientId);de(Ke||null)}catch(Le){console.error("Error loading client data:",Le)}else de(null)})()},[r==null?void 0:r.clientId]),ue.useEffect(()=>{const ve=Le=>{if(Ae.current)return K.current&&Ce(K.current),Le.preventDefault(),Le.returnValue="You have unsaved changes.",Le.returnValue};return window.addEventListener("beforeunload",ve),()=>window.removeEventListener("beforeunload",ve)},[]);const Te=async()=>{x(!0),o("");try{let ve=await $6(t);ve=aU(ve),c(ve),he(new Date)}catch(ve){console.error("Error loading project:",ve),o("Project not found")}finally{x(!1)}},Ce=async ve=>{if(!ve||!t)return!1;H(ao.SAVING);try{return await Z6(t,ve),H(ao.SAVED),he(new Date),Ae.current=!1,setTimeout(()=>{H(Le=>Le===ao.SAVED?ao.IDLE:Le)},2e3),!0}catch(Le){return console.error("Save failed:",Le),H(ao.ERROR),setTimeout(()=>{H(ao.PENDING)},3e3),!1}},ne=ue.useCallback(ve=>{ge.current&&clearTimeout(ge.current),Ae.current=!0,H(ao.PENDING),ge.current=setTimeout(()=>{Ce(ve)},2e3)},[t]),ae=async()=>{r&&(ge.current&&clearTimeout(ge.current),await Ce(r))},q=ue.useCallback(ve=>{c(Le=>{if(!Le)return Le;const Ke={...Le,...ve};return ne(Ke),Ke})},[ne]),oe=async()=>{if(confirm(`Are you sure you want to delete "${r.name}"? This cannot be undone.`)){ge.current&&clearTimeout(ge.current);try{await kj(t),e("/projects")}catch(ve){console.error("Error deleting project:",ve),alert("Failed to delete project")}}},ke=ve=>{q({status:ve})},Ve=async()=>{Ae.current&&K.current&&(ge.current&&clearTimeout(ge.current),await Ce(K.current))},ie=Aoe.filter(ve=>{var Le;return ve.toggleable?(Le=r==null?void 0:r.sections)==null?void 0:Le[ve.sectionKey]:!0});if(h)return n.jsx("div",{className:"flex items-center justify-center h-64",children:n.jsxs("div",{className:"text-center",children:[n.jsx("div",{className:"w-8 h-8 border-4 border-aeria-navy border-t-transparent rounded-full animate-spin mx-auto mb-4"}),n.jsx("p",{className:"text-gray-500",children:"Loading project..."})]})});if(w||!r)return n.jsxs("div",{className:"space-y-6",children:[n.jsxs(dr,{to:"/projects",className:"inline-flex items-center gap-2 text-gray-600 hover:text-gray-900",children:[n.jsx(mc,{className:"w-4 h-4"}),"Back to Projects"]}),n.jsxs("div",{className:"card text-center py-12",children:[n.jsx(ir,{className:"w-12 h-12 mx-auto mb-4 text-amber-500"}),n.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Project Not Found"}),n.jsx("p",{className:"text-gray-600 mb-4",children:w||"The requested project could not be loaded."}),n.jsx(dr,{to:"/projects",className:"btn-primary",children:"View All Projects"})]})]});const ze=()=>{switch(Y){case ao.PENDING:return n.jsxs("span",{className:"text-sm text-amber-600 flex items-center gap-1",children:[n.jsx(g6,{className:"w-2 h-2 fill-current"}),"Unsaved"]});case ao.SAVING:return n.jsxs("span",{className:"text-sm text-blue-600 flex items-center gap-1",children:[n.jsx(Ro,{className:"w-3 h-3 animate-spin"}),"Saving..."]});case ao.SAVED:return n.jsxs("span",{className:"text-sm text-green-600 flex items-center gap-1",children:[n.jsx(qr,{className:"w-4 h-4"}),"Saved"]});case ao.ERROR:return n.jsxs("span",{className:"text-sm text-red-600 flex items-center gap-1",children:[n.jsx(Cs,{className:"w-4 h-4"}),"Save failed"]});default:return X?n.jsxs("span",{className:"text-xs text-gray-400 flex items-center gap-1",children:[n.jsx(Ej,{className:"w-3 h-3"}),"Synced"]}):null}};return n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[n.jsxs("div",{className:"flex items-center gap-4",children:[n.jsx(dr,{to:"/projects",onClick:async ve=>{Ae.current&&(ve.preventDefault(),await Ve(),e("/projects"))},className:"p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100",children:n.jsx(mc,{className:"w-5 h-5"})}),se!=null&&se.logo?n.jsx("div",{className:"w-10 h-10 rounded-lg border bg-white flex items-center justify-center p-1 flex-shrink-0",children:n.jsx("img",{src:se.logo,alt:se.name,className:"max-w-full max-h-full object-contain"})}):r.clientId?n.jsx("div",{className:"w-10 h-10 rounded-lg bg-gradient-to-br from-aeria-blue to-aeria-navy flex items-center justify-center flex-shrink-0",children:n.jsx(Vl,{className:"w-5 h-5 text-white"})}):null,n.jsxs("div",{children:[n.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:r.name}),n.jsx("p",{className:"text-gray-600",children:r.clientName||"No client assigned"})]})]}),n.jsxs("div",{className:"flex items-center gap-3",children:[ze(),n.jsx("button",{onClick:ae,disabled:Y===ao.SAVING||Y===ao.IDLE,className:`btn-primary inline-flex items-center gap-2 ${Y===ao.IDLE?"opacity-50 cursor-not-allowed":""}`,"aria-busy":Y===ao.SAVING,children:Y===ao.SAVING?n.jsxs(n.Fragment,{children:[n.jsx(Ro,{className:"w-4 h-4 animate-spin","aria-hidden":"true"}),"Saving..."]}):n.jsxs(n.Fragment,{children:[n.jsx(tb,{className:"w-4 h-4","aria-hidden":"true"}),"Save"]})}),n.jsxs("select",{value:r.status,onChange:ve=>ke(ve.target.value),className:`px-3 py-2 rounded-lg border text-sm font-medium ${Coe[r.status]}`,"aria-label":"Project status",children:[n.jsx("option",{value:"draft",children:"Draft"}),n.jsx("option",{value:"planning",children:"Planning"}),n.jsx("option",{value:"active",children:"Active"}),n.jsx("option",{value:"completed",children:"Completed"}),n.jsx("option",{value:"archived",children:"Archived"})]}),n.jsxs("div",{className:"relative",children:[n.jsx("button",{onClick:()=>$(!F),className:"p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100","aria-label":"More options","aria-expanded":F,"aria-haspopup":"true",children:n.jsx(Qd,{className:"w-5 h-5","aria-hidden":"true"})}),F&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>$(!1)}),n.jsx("div",{className:"absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-20",children:n.jsxs("button",{onClick:()=>{oe(),$(!1)},className:"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2",children:[n.jsx(Ln,{className:"w-4 h-4","aria-hidden":"true"}),"Delete Project"]})})]})]})]})]}),n.jsx("div",{className:"border-b border-gray-200",children:n.jsx("nav",{className:"flex gap-1 overflow-x-auto pb-px",role:"tablist","aria-label":"Project sections",onKeyDown:ve=>{var Pe,It,tt,zt;const Le=ie,Ke=Le.findIndex(vt=>vt.id===C);if(ve.key==="ArrowRight"||ve.key==="ArrowDown"){ve.preventDefault();const vt=Ke<Le.length-1?Ke+1:0;R(Le[vt].id),(Pe=document.getElementById(`tab-${Le[vt].id}`))==null||Pe.focus()}else if(ve.key==="ArrowLeft"||ve.key==="ArrowUp"){ve.preventDefault();const vt=Ke>0?Ke-1:Le.length-1;R(Le[vt].id),(It=document.getElementById(`tab-${Le[vt].id}`))==null||It.focus()}else ve.key==="Home"?(ve.preventDefault(),R(Le[0].id),(tt=document.getElementById(`tab-${Le[0].id}`))==null||tt.focus()):ve.key==="End"&&(ve.preventDefault(),R(Le[Le.length-1].id),(zt=document.getElementById(`tab-${Le[Le.length-1].id}`))==null||zt.focus())},children:ie.map((ve,Le)=>{const Ke=ve.icon,Pe=C===ve.id;return n.jsxs("button",{id:`tab-${ve.id}`,role:"tab","aria-selected":Pe,"aria-controls":`tabpanel-${ve.id}`,tabIndex:Pe?0:-1,onClick:()=>R(ve.id),className:`flex items-center gap-2 px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 transition-colors ${Pe?"border-aeria-navy text-aeria-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}`,children:[n.jsx(Ke,{className:"w-4 h-4","aria-hidden":"true"}),ve.label]},ve.id)})})}),n.jsxs("div",{role:"tabpanel",id:`tabpanel-${C}`,"aria-labelledby":`tab-${C}`,tabIndex:0,children:[C==="overview"&&n.jsx(cse,{project:r,onUpdate:q}),C==="needs"&&n.jsx(Noe,{project:r,onUpdate:q}),C==="sections"&&n.jsx(dse,{project:r,onUpdate:q}),C==="crew"&&n.jsx(pse,{project:r,onUpdate:q}),C==="site"&&n.jsx(nae,{project:r,onUpdate:q}),C==="flight"&&n.jsx(Kse,{project:r,onUpdate:q,onNavigateToSection:ve=>{ve==="siteSurvey"?R("site"):ve==="flightPlan"?R("flight"):ve==="sora"&&R("sora")}}),C==="hseRisk"&&n.jsx(Sae,{project:r,onUpdate:q}),C==="sora"&&n.jsx(kae,{project:r,onUpdate:q,onNavigateToSection:ve=>{ve==="siteSurvey"?R("site"):ve==="flightPlan"&&R("flight")}}),C==="emergency"&&n.jsx(pae,{project:r,onUpdate:q}),C==="ppe"&&n.jsx(mae,{project:r,onUpdate:q}),C==="comms"&&n.jsx(yae,{project:r,onUpdate:q}),C==="review"&&n.jsx(Mae,{project:r,onUpdate:q}),C==="tailgate"&&n.jsx(Uae,{project:r,onUpdate:q}),C==="forms"&&n.jsx(ooe,{project:r,onUpdate:q}),C==="export"&&n.jsx(hoe,{project:r})]})]})}function r5(t,e){return`[${new Date().toISOString().split("T")[1].slice(0,12)}] [${t}] ${e}`}const Ioe={debug:(t,...e)=>{},info:(t,...e)=>{},warn:(t,...e)=>{console.warn(r5("WARN",t),...e)},error:(t,...e)=>{console.error(r5("ERROR",t),...e)},group:(t,e)=>{},table:t=>{},time:t=>{},timeEnd:t=>{}},TI={Shield:Ds,AlertOctagon:jv,AlertTriangle:ir,Users:ds,CheckSquare:gie,FileText:rs,Wrench:bf,HardHat:Qc,GraduationCap:w6,Truck:D6,Calendar:il,ClipboardCheck:Ul,Search:nu};function Poe({status:t}){const e={draft:"bg-gray-100 text-gray-700",in_progress:"bg-blue-100 text-blue-700",completed:"bg-green-100 text-green-700",requires_action:"bg-amber-100 text-amber-700"},r={draft:"Draft",in_progress:"In Progress",completed:"Completed",requires_action:"Requires Action"};return n.jsx("span",{className:`px-2 py-1 text-xs font-medium rounded-full ${e[t]||e.draft}`,children:r[t]||t})}function joe({level:t}){const e={critical:"bg-red-700 text-white",high:"bg-red-500 text-white",medium:"bg-amber-500 text-white",low:"bg-green-500 text-white"};return n.jsx("span",{className:`px-2 py-1 text-xs font-bold uppercase rounded ${e[t]||"bg-gray-200"}`,children:t})}function Roe({triggers:t}){return!t||t.length===0?null:n.jsx("div",{className:"bg-red-50 border-2 border-red-300 rounded-lg p-4 mb-6",children:n.jsxs("div",{className:"flex items-start gap-3",children:[n.jsx(Cs,{className:"w-6 h-6 text-red-600 flex-shrink-0 mt-0.5"}),n.jsxs("div",{className:"flex-1",children:[n.jsx("h3",{className:"font-bold text-red-800 text-lg",children:"REQUIRED NOTIFICATIONS"}),n.jsx("p",{className:"text-red-700 text-sm mb-4",children:"Based on your answers, the following actions are required:"}),n.jsxs("div",{className:"space-y-3",children:[t.includes("TSB_IMMEDIATE")&&n.jsxs("div",{className:"bg-red-100 border border-red-400 rounded-lg p-3",children:[n.jsxs("div",{className:"flex items-center gap-2 font-bold text-red-900",children:[n.jsx(Hd,{className:"w-5 h-5"}),n.jsx("span",{children:"CALL TSB IMMEDIATELY"})]}),n.jsxs("div",{className:"mt-2 text-red-800",children:[n.jsx("p",{className:"font-mono text-lg",children:"1-800-387-3557 (toll-free)"}),n.jsx("p",{className:"font-mono",children:"or 1-819-994-3741 (direct/collect)"})]}),n.jsx("p",{className:"text-sm mt-2 text-red-700",children:"Triggered by: Fatality, serious injury, RPAS >25kg accident, collision with manned aircraft"})]}),t.includes("TRANSPORT_CANADA")&&n.jsxs("div",{className:"bg-orange-100 border border-orange-400 rounded-lg p-3",children:[n.jsxs("div",{className:"flex items-center gap-2 font-bold text-orange-900",children:[n.jsx(rs,{className:"w-5 h-5"}),n.jsx("span",{children:"NOTIFY TRANSPORT CANADA"})]}),n.jsx("p",{className:"text-sm mt-1 text-orange-800",children:"Submit CADORS report. If under SFOC, submit RPAS Aviation Occurrence Reporting Form."})]}),t.includes("WORKSAFEBC")&&n.jsxs("div",{className:"bg-yellow-100 border border-yellow-400 rounded-lg p-3",children:[n.jsxs("div",{className:"flex items-center gap-2 font-bold text-yellow-900",children:[n.jsx(ir,{className:"w-5 h-5"}),n.jsx("span",{children:"NOTIFY WORKSAFEBC"})]}),n.jsx("p",{className:"text-sm mt-1 text-yellow-800",children:"Report workplace incident to WorkSafeBC."})]}),n.jsxs("div",{className:"bg-blue-100 border border-blue-400 rounded-lg p-3",children:[n.jsxs("div",{className:"flex items-center gap-2 font-bold text-blue-900",children:[n.jsx(fa,{className:"w-5 h-5"}),n.jsx("span",{children:"NOTIFY AERIA ACCOUNTABLE EXECUTIVE"})]}),n.jsx("div",{className:"mt-1 text-blue-800",children:n.jsxs("p",{children:["Dustin Wales: ",n.jsx("span",{className:"font-mono",children:"604-849-2345"})]})}),n.jsx("p",{className:"text-sm mt-1 text-blue-700",children:"Required for ALL incidents."})]})]})]})]})})}function n5({field:t,value:e,onChange:r,formData:c}){const[h,x]=ue.useState(e||""),w=(R,F)=>{if(!R||!F)return!0;const $=R.match(/^(\w+)\s*(===?|!==?)\s*['"]([^'"]*)['"]\s*$/);if($){const[,X,he,se]=$,de=F[X];if(he==="==="||he==="==")return de===se;if(he==="!=="||he==="!=")return de!==se}const Y=R.match(/^(\w+)\s*(===?|!==?)\s*(true|false)\s*$/);if(Y){const[,X,he,se]=Y,de=F[X],K=se==="true";if(he==="==="||he==="==")return de===K;if(he==="!=="||he==="!=")return de!==K}const H=R.match(/^!?(\w+)$/);if(H){const X=R.startsWith("!"),he=H[1],se=F[he];return X?!se:!!se}return R.includes("&&")?R.split("&&").map(he=>he.trim()).every(he=>w(he,F)):R.includes("||")?R.split("||").map(he=>he.trim()).some(he=>w(he,F)):(console.warn("Could not parse showIf condition:",R),!0)};if(t.showIf&&!w(t.showIf,c))return null;const o=R=>{x(R),r(t.id,R)},C="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-aeria-navy focus:border-transparent transition-colors";switch(t.type){case"text":return n.jsxs("div",{children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[t.label," ",t.required&&n.jsx("span",{className:"text-red-500",children:"*"})]}),n.jsx("input",{type:"text",value:h,onChange:X=>o(X.target.value),placeholder:t.placeholder,className:C,required:t.required}),t.helpText&&n.jsx("p",{className:"text-xs text-gray-500 mt-1",children:t.helpText})]});case"textarea":return n.jsxs("div",{children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[t.label," ",t.required&&n.jsx("span",{className:"text-red-500",children:"*"})]}),n.jsx("textarea",{value:h,onChange:X=>o(X.target.value),rows:t.rows||3,className:C,required:t.required}),t.helpText&&n.jsx("p",{className:"text-xs text-gray-500 mt-1",children:t.helpText})]});case"select":const R=typeof t.options=="string"?t.options==="HAZARD_CATEGORIES"?UT:t.options==="SEVERITY_RATINGS"?MU:t.options==="PROBABILITY_RATINGS"?OU:t.options==="CONTROL_TYPES"?FU:[]:t.options;return n.jsxs("div",{children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[t.label," ",t.required&&n.jsx("span",{className:"text-red-500",children:"*"})]}),n.jsxs("select",{value:h,onChange:X=>o(X.target.value),className:C,required:t.required,children:[n.jsx("option",{value:"",children:"Select..."}),R.map(X=>n.jsx("option",{value:X.value,children:X.label},X.value))]}),t.helpText&&n.jsx("p",{className:"text-xs text-gray-500 mt-1",children:t.helpText})]});case"yesno":return n.jsxs("div",{children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[t.label," ",t.required&&n.jsx("span",{className:"text-red-500",children:"*"})]}),n.jsxs("div",{className:"flex gap-4",children:[n.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[n.jsx("input",{type:"radio",name:t.id,value:"true",checked:h===!0||h==="true",onChange:()=>o(!0),className:"w-4 h-4 text-aeria-navy"}),n.jsx("span",{className:`px-3 py-1 rounded-full text-sm ${h===!0||h==="true"?"bg-red-100 text-red-700 font-medium":"bg-gray-100 text-gray-600"}`,children:"Yes"})]}),n.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[n.jsx("input",{type:"radio",name:t.id,value:"false",checked:h===!1||h==="false",onChange:()=>o(!1),className:"w-4 h-4 text-aeria-navy"}),n.jsx("span",{className:`px-3 py-1 rounded-full text-sm ${h===!1||h==="false"?"bg-green-100 text-green-700 font-medium":"bg-gray-100 text-gray-600"}`,children:"No"})]})]}),t.trigger&&(h===!0||h==="true")&&n.jsxs("p",{className:"text-xs text-red-600 mt-1 font-medium",children:[" This triggers: ",t.trigger]})]});case"date":return n.jsxs("div",{children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[t.label," ",t.required&&n.jsx("span",{className:"text-red-500",children:"*"})]}),n.jsx("input",{type:"date",value:h||(t.defaultToday?new Date().toISOString().split("T")[0]:""),onChange:X=>o(X.target.value),className:C,required:t.required})]});case"time":return n.jsxs("div",{children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[t.label," ",t.required&&n.jsx("span",{className:"text-red-500",children:"*"})]}),n.jsx("input",{type:"time",value:h,onChange:X=>o(X.target.value),className:C,required:t.required})]});case"datetime":return n.jsxs("div",{children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[t.label," ",t.required&&n.jsx("span",{className:"text-red-500",children:"*"})]}),n.jsx("input",{type:"datetime-local",value:h,onChange:X=>o(X.target.value),className:C,required:t.required})]});case"number":return n.jsxs("div",{children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[t.label," ",t.required&&n.jsx("span",{className:"text-red-500",children:"*"})]}),n.jsx("input",{type:"number",value:h,onChange:X=>o(X.target.value),className:C,required:t.required}),t.helpText&&n.jsx("p",{className:"text-xs text-gray-500 mt-1",children:t.helpText})]});case"checkbox":return n.jsx("div",{children:n.jsxs("label",{className:"flex items-center gap-3 cursor-pointer",children:[n.jsx("input",{type:"checkbox",checked:h===!0,onChange:X=>o(X.target.checked),className:"w-5 h-5 text-aeria-navy rounded"}),n.jsx("span",{className:"text-sm font-medium text-gray-700",children:t.label}),t.required&&n.jsx("span",{className:"text-red-500",children:"*"})]})});case"risk_matrix":const F=(c==null?void 0:c[t.id.replace("_risk","_severity")])||(c==null?void 0:c.severity),$=(c==null?void 0:c[t.id.replace("_risk","_probability")])||(c==null?void 0:c.probability),Y=LU(F,$);return n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:t.label}),n.jsx(joe,{level:Y})]});case"signature":return n.jsxs("div",{children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[t.label," ",t.required&&n.jsx("span",{className:"text-red-500",children:"*"})]}),n.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4 text-center bg-gray-50 hover:bg-gray-100 cursor-pointer transition-colors",children:[n.jsx(fa,{className:"w-8 h-8 mx-auto mb-2 text-gray-400"}),n.jsx("p",{className:"text-sm text-gray-600",children:"Click to sign"}),h&&n.jsxs("div",{className:"mt-2",children:[n.jsx(qr,{className:"w-5 h-5 mx-auto text-green-500"}),n.jsx("p",{className:"text-xs text-green-600 mt-1",children:"Signed"})]})]})]});case"gps":return n.jsxs("div",{children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[t.label," ",t.required&&n.jsx("span",{className:"text-red-500",children:"*"})]}),n.jsxs("div",{className:"flex gap-2",children:[n.jsx("input",{type:"text",value:h,onChange:X=>o(X.target.value),placeholder:"Lat, Long",className:`${C} flex-1`}),n.jsx("button",{type:"button",className:"px-3 py-2 bg-aeria-navy text-white rounded-lg hover:bg-aeria-blue transition-colors flex items-center gap-1",onClick:()=>{navigator.geolocation&&navigator.geolocation.getCurrentPosition(X=>{o(`${X.coords.latitude.toFixed(6)}, ${X.coords.longitude.toFixed(6)}`)})},children:n.jsx(Wn,{className:"w-4 h-4"})})]})]});case"file_upload":return n.jsxs("div",{children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[t.label," ",t.required&&n.jsx("span",{className:"text-red-500",children:"*"})]}),n.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:bg-gray-50 cursor-pointer transition-colors",children:[n.jsx(vc,{className:"w-8 h-8 mx-auto mb-2 text-gray-400 rotate-180"}),n.jsx("p",{className:"text-sm text-gray-600",children:"Click to upload or drag files here"}),n.jsx("p",{className:"text-xs text-gray-400 mt-1",children:t.accept||"Any file type"})]})]});case"auto_id":return n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:t.label}),n.jsx("div",{className:"px-3 py-2 bg-gray-100 border border-gray-200 rounded-lg text-gray-600 font-mono text-sm",children:h||"Auto-generated on save"})]});case"multiselect":const H=typeof t.options=="string"?[]:t.options;return n.jsxs("div",{children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[t.label," ",t.required&&n.jsx("span",{className:"text-red-500",children:"*"})]}),n.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-3",children:H.map(X=>n.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[n.jsx("input",{type:"checkbox",checked:Array.isArray(h)&&h.includes(X.value||X),onChange:he=>{const se=Array.isArray(h)?h:[];he.target.checked?o([...se,X.value||X]):o(se.filter(de=>de!==(X.value||X)))},className:"w-4 h-4 text-aeria-navy rounded"}),n.jsx("span",{className:"text-sm text-gray-700",children:X.label||X})]},X.value||X))})]});case"project_select":case"operator_select":case"aircraft_select":case"crew_multi_select":case"equipment_select":case"incident_select":return n.jsxs("div",{children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[t.label," ",t.required&&n.jsx("span",{className:"text-red-500",children:"*"})]}),n.jsxs("select",{value:h,onChange:X=>o(X.target.value),className:C,required:t.required,children:[n.jsx("option",{value:"",children:"Select..."}),n.jsx("option",{value:"demo",children:"Demo Selection"})]}),t.helpText&&n.jsx("p",{className:"text-xs text-gray-500 mt-1",children:t.helpText})]});default:return n.jsxs("div",{children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[t.label," ",t.required&&n.jsx("span",{className:"text-red-500",children:"*"})]}),n.jsx("input",{type:"text",value:h,onChange:X=>o(X.target.value),className:C})]})}}function koe({section:t,formData:e,onChange:r,isExpanded:c,onToggle:h}){const[x,w]=ue.useState([{id:1}]),o=()=>{w([...x,{id:Date.now()}])};return n.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[n.jsxs("button",{type:"button",onClick:h,className:"w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 transition-colors",children:[n.jsx("h3",{className:"font-semibold text-gray-900",children:t.title}),c?n.jsx(fn,{className:"w-5 h-5"}):n.jsx(ko,{className:"w-5 h-5"})]}),c&&n.jsxs("div",{className:"p-4 space-y-4",children:[t.description&&n.jsx("p",{className:"text-sm text-gray-600 mb-4",children:t.description}),t.repeatable?n.jsxs(n.Fragment,{children:[x.map((C,R)=>n.jsxs("div",{className:"p-4 border border-gray-200 rounded-lg bg-gray-50 space-y-4",children:[n.jsxs("div",{className:"flex items-center justify-between mb-2",children:[n.jsxs("span",{className:"text-sm font-medium text-gray-600",children:["#",R+1]}),R>0&&n.jsx("button",{type:"button",onClick:()=>w(x.filter(F=>F.id!==C.id)),className:"text-red-500 hover:text-red-700",children:n.jsx(cs,{className:"w-4 h-4"})})]}),n.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:t.fields.map(F=>n.jsx("div",{className:F.type==="textarea"?"md:col-span-2":"",children:n.jsx(n5,{field:F,value:e==null?void 0:e[`${t.id}_${R}_${F.id}`],onChange:($,Y)=>r(`${t.id}_${R}_${$}`,Y),formData:e})},F.id))})]},C.id)),n.jsxs("button",{type:"button",onClick:o,className:"w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-aeria-navy hover:text-aeria-navy transition-colors flex items-center justify-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),t.repeatLabel||"Add Item"]})]}):n.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:t.fields.map(C=>n.jsx("div",{className:C.type==="textarea"||C.type==="multi_signature"?"md:col-span-2":"",children:n.jsx(n5,{field:C,value:e==null?void 0:e[C.id],onChange:r,formData:e})},C.id))})]})]})}function Doe({template:t,onClose:e,onSave:r}){var Y;const[c,h]=ue.useState({}),[x,w]=ue.useState({[(Y=t.sections[0])==null?void 0:Y.id]:!0}),[o,C]=ue.useState([]),R=TI[t.icon]||Ll,F=(H,X)=>{const he={...c,[H]:X};if(h(he),t.hasTriggers){const se=new Set;(he.fatality===!0||he.fatality==="true")&&se.add("TSB_IMMEDIATE"),(he.serious_injury===!0||he.serious_injury==="true")&&(se.add("TSB_IMMEDIATE"),se.add("WORKSAFEBC")),(he.collision_manned===!0||he.collision_manned==="true")&&se.add("TSB_IMMEDIATE"),(he.rpas_over_25kg===!0||he.rpas_over_25kg==="true")&&se.add("TSB_IMMEDIATE"),(he.fly_away===!0||he.fly_away==="true")&&se.add("TRANSPORT_CANADA"),(he.boundary_violation===!0||he.boundary_violation==="true")&&se.add("TRANSPORT_CANADA"),(he.unintended_contact===!0||he.unintended_contact==="true")&&se.add("TRANSPORT_CANADA"),(he.near_miss===!0||he.near_miss==="true")&&se.add("TRANSPORT_CANADA"),C(Array.from(se))}},$=H=>{w(X=>({...X,[H]:!X[H]}))};return n.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-start justify-center overflow-y-auto py-8",children:n.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 my-auto",children:[n.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-r from-aeria-navy to-aeria-blue text-white rounded-t-xl",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("div",{className:"w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center",children:n.jsx(R,{className:"w-6 h-6"})}),n.jsxs("div",{children:[n.jsx("h2",{className:"text-xl font-bold",children:t.name}),n.jsx("p",{className:"text-sm text-white/80",children:t.description})]})]}),n.jsx("button",{onClick:e,className:"p-2 hover:bg-white/20 rounded-lg transition-colors",children:n.jsx(cs,{className:"w-6 h-6"})})]}),n.jsxs("div",{className:"p-6 max-h-[70vh] overflow-y-auto",children:[t.hasTriggers&&o.length>0&&n.jsx(Roe,{triggers:o}),n.jsx("div",{className:"space-y-4",children:t.sections.map(H=>n.jsx(koe,{section:H,formData:c,onChange:F,isExpanded:x[H.id],onToggle:()=>$(H.id)},H.id))})]}),n.jsxs("div",{className:"flex items-center justify-between p-6 border-t border-gray-200 bg-gray-50 rounded-b-xl",children:[n.jsx("button",{onClick:e,className:"px-4 py-2 text-gray-600 hover:text-gray-900 transition-colors",children:"Cancel"}),n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("button",{className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors",children:"Save as Draft"}),n.jsxs("button",{onClick:()=>r(c),className:"px-6 py-2 bg-aeria-navy text-white rounded-lg hover:bg-aeria-blue transition-colors flex items-center gap-2",children:[n.jsx(qr,{className:"w-4 h-4"}),"Submit Form"]})]})]})]})})}function Moe(){var H;const[t,e]=ue.useState(""),[r,c]=ue.useState(null),[h,x]=ue.useState(null),[w,o]=ue.useState([]),[C,R]=ue.useState("templates"),F=Object.values(S2).filter(X=>{const he=!t||X.name.toLowerCase().includes(t.toLowerCase())||X.shortName.toLowerCase().includes(t.toLowerCase()),se=!r||X.category===r;return he&&se}),$=X=>{const he=S2[X];he&&x(he)},Y=X=>{Ioe.debug("Saving form:",X),o([{id:Date.now(),template:h.id,templateName:h.name,status:"completed",date:new Date().toISOString(),submittedBy:"Current User"},...w]),x(null)};return n.jsxs("div",{className:"flex h-full -m-6",children:[n.jsxs("div",{className:"w-64 bg-gray-50 border-r border-gray-200 p-4 flex-shrink-0",children:[n.jsx("h2",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4",children:"Form Categories"}),n.jsxs("nav",{className:"space-y-1",children:[n.jsxs("button",{onClick:()=>c(null),className:`w-full flex items-center gap-3 px-3 py-2 rounded-lg text-left transition-colors ${r?"text-gray-700 hover:bg-gray-200":"bg-aeria-navy text-white"}`,children:[n.jsx(Ll,{className:"w-5 h-5"}),n.jsx("span",{className:"font-medium",children:"All Forms"}),n.jsx("span",{className:`ml-auto text-xs px-2 py-0.5 rounded-full ${r?"bg-gray-200":"bg-white/20"}`,children:Object.keys(S2).length})]}),w2.map(X=>{const he=TI[X.icon]||Ll,se=X.forms.length;return n.jsxs("button",{onClick:()=>c(X.id),className:`w-full flex items-center gap-3 px-3 py-2 rounded-lg text-left transition-colors ${r===X.id?"bg-aeria-navy text-white":"text-gray-700 hover:bg-gray-200"}`,children:[n.jsx(he,{className:"w-5 h-5"}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsx("span",{className:"font-medium block truncate",children:X.name}),n.jsx("span",{className:`text-xs ${r===X.id?"text-white/70":"text-gray-500"}`,children:X.description})]}),n.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full flex-shrink-0 ${r===X.id?"bg-white/20":"bg-gray-200"}`,children:se})]},X.id)})]}),n.jsx("hr",{className:"my-4 border-gray-200"}),n.jsxs("button",{className:"w-full flex items-center gap-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-200 transition-colors",children:[n.jsx(vr,{className:"w-5 h-5"}),n.jsx("span",{className:"font-medium",children:"Custom Form Builder"})]})]}),n.jsxs("div",{className:"flex-1 p-6 overflow-y-auto",children:[n.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6",children:[n.jsxs("div",{children:[n.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Forms"}),n.jsx("p",{className:"text-gray-600 mt-1",children:r?(H=w2.find(X=>X.id===r))==null?void 0:H.description:"All field forms and documentation"})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("button",{onClick:()=>R("templates"),className:`px-4 py-2 rounded-lg transition-colors ${C==="templates"?"bg-aeria-navy text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:"Templates"}),n.jsx("button",{onClick:()=>R("submitted"),className:`px-4 py-2 rounded-lg transition-colors ${C==="submitted"?"bg-aeria-navy text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:"Submitted"})]})]}),n.jsxs("div",{className:"relative mb-6",children:[n.jsx(nu,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),n.jsx("input",{type:"text",placeholder:"Search forms...",value:t,onChange:X=>e(X.target.value),className:"w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-aeria-navy focus:border-transparent"})]}),C==="templates"?n.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:F.map(X=>{const he=TI[X.icon]||Ll,se=w2.find(de=>de.id===X.category);return n.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-5 hover:shadow-lg hover:border-aeria-navy/30 transition-all cursor-pointer group",onClick:()=>$(X.id),children:[n.jsxs("div",{className:"flex items-start gap-4",children:[n.jsx("div",{className:"w-12 h-12 bg-aeria-sky rounded-lg flex items-center justify-center group-hover:bg-aeria-navy group-hover:text-white transition-colors",children:n.jsx(he,{className:"w-6 h-6 text-aeria-navy group-hover:text-white"})}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsx("h3",{className:"font-semibold text-gray-900 group-hover:text-aeria-navy transition-colors",children:X.shortName}),n.jsx("p",{className:"text-sm text-gray-500 mt-1 line-clamp-2",children:X.description}),X.hasTriggers&&n.jsxs("span",{className:"inline-flex items-center gap-1 mt-2 text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded-full",children:[n.jsx(ir,{className:"w-3 h-3"}),"Has regulatory triggers"]})]})]}),n.jsxs("div",{className:"flex items-center justify-between mt-4 pt-4 border-t border-gray-100",children:[n.jsx("span",{className:"text-xs text-gray-400",children:se==null?void 0:se.name}),n.jsxs("span",{className:"text-xs text-gray-400",children:[X.sections.length," sections"]})]})]},X.id)})}):n.jsx("div",{className:"space-y-3",children:w.length>0?w.map(X=>n.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4 flex items-center justify-between hover:shadow-md transition-shadow",children:[n.jsxs("div",{className:"flex items-center gap-4",children:[n.jsx("div",{className:"w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center",children:n.jsx(qr,{className:"w-5 h-5 text-green-600"})}),n.jsxs("div",{children:[n.jsx("h4",{className:"font-medium text-gray-900",children:X.templateName}),n.jsxs("p",{className:"text-sm text-gray-500",children:["Submitted ",new Date(X.date).toLocaleDateString()," by ",X.submittedBy]})]})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(Poe,{status:X.status}),n.jsx("button",{className:"p-2 text-gray-400 hover:text-aeria-navy transition-colors",children:n.jsx(ga,{className:"w-5 h-5"})}),n.jsx("button",{className:"p-2 text-gray-400 hover:text-aeria-navy transition-colors",children:n.jsx(vc,{className:"w-5 h-5"})})]})]},X.id)):n.jsxs("div",{className:"text-center py-12 bg-gray-50 rounded-lg",children:[n.jsx(Ll,{className:"w-12 h-12 mx-auto mb-4 text-gray-300"}),n.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-1",children:"No submitted forms yet"}),n.jsx("p",{className:"text-gray-500 mb-4",children:"Complete a form to see it here"}),n.jsxs("button",{onClick:()=>R("templates"),className:"px-4 py-2 bg-aeria-navy text-white rounded-lg hover:bg-aeria-blue transition-colors inline-flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Start a Form"]})]})})]}),h&&n.jsx(Doe,{template:h,onClose:()=>x(null),onSave:Y})]})}const Ooe=["PIC","VO","Safety Lead","Project Lead","First Aid","Ground Support","Data Processor"],Loe=["Advanced RPAS Certificate","Basic RPAS Certificate","ROC-A (Restricted Operator Certificate - Aeronautical)","Wilderness First Aid","Standard First Aid","OFA Level 1","OFA Level 2","OFA Level 3","H2S Alive","WHMIS","Ground Disturbance","Bear Awareness","Transportation of Dangerous Goods","SECOR","Fall Protection","Other"],Foe=["Transport Canada","Red Cross","St. John Ambulance","WorkSafe BC","Energy Safety Canada","Other"];function zoe({isOpen:t,onClose:e,operator:r}){const c=!!r,[h,x]=ue.useState(!1),[w,o]=ue.useState(""),[C,R]=ue.useState({firstName:"",lastName:"",email:"",phone:"",emergencyContact:{name:"",phone:"",email:"",relationship:""},roles:[],status:"active"}),[F,$]=ue.useState([]);ue.useEffect(()=>{r?(R({firstName:r.firstName||"",lastName:r.lastName||"",email:r.email||"",phone:r.phone||"",emergencyContact:r.emergencyContact||{name:"",phone:"",email:"",relationship:""},roles:r.roles||[],status:r.status||"active"}),$(r.certifications||[])):Y()},[r,t]);const Y=()=>{R({firstName:"",lastName:"",email:"",phone:"",emergencyContact:{name:"",phone:"",email:"",relationship:""},roles:[],status:"active"}),$([]),o("")},H=Te=>{const{name:Ce,value:ne}=Te.target;R(ae=>({...ae,[Ce]:ne}))},X=Te=>{const{name:Ce,value:ne}=Te.target;R(ae=>({...ae,emergencyContact:{...ae.emergencyContact,[Ce]:ne}}))},he=Te=>{R(Ce=>({...Ce,roles:Ce.roles.includes(Te)?Ce.roles.filter(ne=>ne!==Te):[...Ce.roles,Te]}))},se=()=>{$(Te=>[...Te,{type:"",customType:"",certificateNumber:"",issuedDate:"",expiryDate:"",issuingBody:"",customIssuingBody:""}])},de=(Te,Ce,ne)=>{$(ae=>ae.map((q,oe)=>oe===Te?{...q,[Ce]:ne}:q))},K=Te=>{$(Ce=>Ce.filter((ne,ae)=>ae!==Te))},ge=async Te=>{Te.preventDefault(),o(""),x(!0);try{if(!C.firstName.trim())throw new Error("First name is required");if(!C.lastName.trim())throw new Error("Last name is required");if(!C.email.trim())throw new Error("Email is required");if(!C.phone.trim())throw new Error("Phone is required");if(!C.emergencyContact.name.trim())throw new Error("Emergency contact name is required");if(!C.emergencyContact.phone.trim())throw new Error("Emergency contact phone is required");const Ce=F.filter(ae=>ae.type).map(ae=>({type:ae.type==="Other"?ae.customType:ae.type,certificateNumber:ae.certificateNumber,issuedDate:ae.issuedDate,expiryDate:ae.expiryDate||null,issuingBody:ae.issuingBody==="Other"?ae.customIssuingBody:ae.issuingBody})),ne={...C,certifications:Ce};c?await Mj(r.id,ne):await J6(ne),e()}catch(Ce){o(Ce.message)}finally{x(!1)}},Ae=()=>{Y(),e()};return n.jsx(Lj,{isOpen:t,onClose:Ae,title:c?"Edit Operator":"Add Operator",size:"lg",children:n.jsxs("form",{onSubmit:ge,className:"space-y-6",children:[w&&n.jsxs("div",{className:"flex items-center gap-2 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm",children:[n.jsx(Cs,{className:"w-4 h-4 flex-shrink-0"}),n.jsx("span",{children:w})]}),n.jsxs("div",{children:[n.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Basic Information"}),n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsxs("label",{className:"label",children:["First Name ",n.jsx("span",{className:"text-red-500",children:"*"})]}),n.jsx("input",{type:"text",name:"firstName",value:C.firstName,onChange:H,className:"input"})]}),n.jsxs("div",{children:[n.jsxs("label",{className:"label",children:["Last Name ",n.jsx("span",{className:"text-red-500",children:"*"})]}),n.jsx("input",{type:"text",name:"lastName",value:C.lastName,onChange:H,className:"input"})]}),n.jsxs("div",{children:[n.jsxs("label",{className:"label",children:["Email ",n.jsx("span",{className:"text-red-500",children:"*"})]}),n.jsx("input",{type:"email",name:"email",value:C.email,onChange:H,className:"input"})]}),n.jsxs("div",{children:[n.jsxs("label",{className:"label",children:["Phone ",n.jsx("span",{className:"text-red-500",children:"*"})]}),n.jsx("input",{type:"tel",name:"phone",value:C.phone,onChange:H,className:"input",placeholder:"(555) 555-5555"})]})]})]}),n.jsxs("div",{children:[n.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Emergency Contact"}),n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4 mb-4",children:[n.jsxs("div",{children:[n.jsxs("label",{className:"label",children:["Name ",n.jsx("span",{className:"text-red-500",children:"*"})]}),n.jsx("input",{type:"text",name:"name",value:C.emergencyContact.name,onChange:X,className:"input"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Relationship"}),n.jsx("input",{type:"text",name:"relationship",value:C.emergencyContact.relationship,onChange:X,className:"input",placeholder:"e.g., Spouse, Parent"})]})]}),n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsxs("label",{className:"label",children:["Phone ",n.jsx("span",{className:"text-red-500",children:"*"})]}),n.jsx("input",{type:"tel",name:"phone",value:C.emergencyContact.phone,onChange:X,className:"input"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Email"}),n.jsx("input",{type:"email",name:"email",value:C.emergencyContact.email,onChange:X,className:"input",placeholder:"emergency@email.com"})]})]})]}),n.jsxs("div",{children:[n.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Roles"}),n.jsx("div",{className:"flex flex-wrap gap-2",children:Ooe.map(Te=>n.jsx("button",{type:"button",onClick:()=>he(Te),className:`px-3 py-1.5 text-sm font-medium rounded-full border transition-colors ${C.roles.includes(Te)?"bg-aeria-navy text-white border-aeria-navy":"bg-white text-gray-700 border-gray-300 hover:border-gray-400"}`,children:Te},Te))})]}),n.jsxs("div",{children:[n.jsxs("div",{className:"flex items-center justify-between mb-3",children:[n.jsxs("h3",{className:"text-sm font-semibold text-gray-900 flex items-center gap-2",children:[n.jsx(gS,{className:"w-4 h-4"}),"Certifications"]}),n.jsxs("button",{type:"button",onClick:se,className:"text-sm text-aeria-blue hover:text-aeria-navy inline-flex items-center gap-1",children:[n.jsx(vr,{className:"w-4 h-4"}),"Add Certification"]})]}),F.length===0?n.jsx("p",{className:"text-sm text-gray-500 italic",children:"No certifications added yet."}):n.jsx("div",{className:"space-y-4",children:F.map((Te,Ce)=>n.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg border border-gray-200",children:[n.jsxs("div",{className:"flex justify-between items-start mb-3",children:[n.jsxs("span",{className:"text-xs font-medium text-gray-500",children:["Certification ",Ce+1]}),n.jsx("button",{type:"button",onClick:()=>K(Ce),className:"p-1 text-gray-400 hover:text-red-500",children:n.jsx(Ln,{className:"w-4 h-4"})})]}),n.jsxs("div",{className:"grid sm:grid-cols-2 gap-3",children:[n.jsxs("div",{children:[n.jsx("label",{className:"label text-xs",children:"Type"}),n.jsxs("select",{value:Te.type,onChange:ne=>de(Ce,"type",ne.target.value),className:"input text-sm",children:[n.jsx("option",{value:"",children:"Select type..."}),Loe.map(ne=>n.jsx("option",{value:ne,children:ne},ne))]}),Te.type==="Other"&&n.jsx("input",{type:"text",value:Te.customType,onChange:ne=>de(Ce,"customType",ne.target.value),className:"input text-sm mt-2",placeholder:"Specify certification type"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label text-xs",children:"Issuing Body"}),n.jsxs("select",{value:Te.issuingBody,onChange:ne=>de(Ce,"issuingBody",ne.target.value),className:"input text-sm",children:[n.jsx("option",{value:"",children:"Select issuing body..."}),Foe.map(ne=>n.jsx("option",{value:ne,children:ne},ne))]}),Te.issuingBody==="Other"&&n.jsx("input",{type:"text",value:Te.customIssuingBody,onChange:ne=>de(Ce,"customIssuingBody",ne.target.value),className:"input text-sm mt-2",placeholder:"Specify issuing body"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label text-xs",children:"Certificate Number"}),n.jsx("input",{type:"text",value:Te.certificateNumber,onChange:ne=>de(Ce,"certificateNumber",ne.target.value),className:"input text-sm",placeholder:"Optional"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label text-xs",children:"Issued Date"}),n.jsx("input",{type:"date",value:Te.issuedDate,onChange:ne=>de(Ce,"issuedDate",ne.target.value),className:"input text-sm"})]}),n.jsxs("div",{className:"sm:col-span-2",children:[n.jsxs("label",{className:"label text-xs",children:["Expiry Date ",n.jsx("span",{className:"text-gray-400 font-normal",children:"(leave blank if no expiry)"})]}),n.jsx("input",{type:"date",value:Te.expiryDate,onChange:ne=>de(Ce,"expiryDate",ne.target.value),className:"input text-sm"})]})]})]},Ce))})]}),c&&n.jsxs("div",{children:[n.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Status"}),n.jsxs("select",{name:"status",value:C.status,onChange:H,className:"input w-40",children:[n.jsx("option",{value:"active",children:"Active"}),n.jsx("option",{value:"inactive",children:"Inactive"})]})]}),n.jsxs(Fj,{children:[n.jsx("button",{type:"button",onClick:Ae,className:"btn-secondary",children:"Cancel"}),n.jsx("button",{type:"submit",disabled:h,className:"btn-primary",children:h?"Saving...":c?"Save Changes":"Add Operator"})]})]})})}const Boe={PIC:"bg-blue-100 text-blue-700",VO:"bg-green-100 text-green-700","Safety Lead":"bg-orange-100 text-orange-700","Project Lead":"bg-purple-100 text-purple-700","First Aid":"bg-red-100 text-red-700"};function Voe(){const[t,e]=ue.useState([]),[r,c]=ue.useState(!0),[h,x]=ue.useState(""),[w,o]=ue.useState("all"),[C,R]=ue.useState(!1),[F,$]=ue.useState(null),[Y,H]=ue.useState(null),[X,he]=ue.useState(null);ue.useEffect(()=>{se()},[]);const se=async()=>{c(!0);try{const ne=await rx();e(ne)}catch(ne){console.error("Error loading operators:",ne)}finally{c(!1)}},de=async(ne,ae)=>{if(confirm(`Are you sure you want to delete ${ae}? This cannot be undone.`)){try{await eU(ne),e(q=>q.filter(oe=>oe.id!==ne))}catch(q){console.error("Error deleting operator:",q),alert("Failed to delete operator")}H(null)}},K=ne=>{$(ne),R(!0),H(null)},ge=()=>{R(!1),$(null),se()},Ae=t.filter(ne=>{var ke;const q=`${ne.firstName} ${ne.lastName}`.toLowerCase().includes(h.toLowerCase())||((ke=ne.email)==null?void 0:ke.toLowerCase().includes(h.toLowerCase())),oe=w==="all"||ne.status===w;return q&&oe}),Te=ne=>{if(!ne.expiryDate)return{status:"valid",label:"No Expiry",color:"text-green-600"};const ae=jT(new Date(ne.expiryDate),new Date);return ae<0?{status:"expired",label:"Expired",color:"text-red-600",icon:zl}:ae<=90?{status:"expiring",label:`${ae} days`,color:"text-amber-600",icon:ir}:{status:"valid",label:"Valid",color:"text-green-600",icon:qr}},Ce=ne=>{var ae;return(ae=ne.certifications)!=null&&ae.length?ne.certifications.some(q=>{const oe=Te(q);return oe.status==="expired"||oe.status==="expiring"}):!1};return n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[n.jsxs("div",{children:[n.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Operators"}),n.jsx("p",{className:"text-gray-600 mt-1",children:"Team members and certifications"})]}),n.jsxs("button",{onClick:()=>R(!0),className:"btn-primary inline-flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Add Operator"]})]}),n.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[n.jsxs("div",{className:"relative flex-1",children:[n.jsx(nu,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),n.jsx("input",{type:"text",placeholder:"Search operators...",value:h,onChange:ne=>x(ne.target.value),className:"input pl-9"})]}),n.jsxs("select",{value:w,onChange:ne=>o(ne.target.value),className:"input w-full sm:w-40",children:[n.jsx("option",{value:"all",children:"All Status"}),n.jsx("option",{value:"active",children:"Active"}),n.jsx("option",{value:"inactive",children:"Inactive"})]})]}),r?n.jsxs("div",{className:"card text-center py-12",children:[n.jsx("div",{className:"w-8 h-8 border-4 border-aeria-navy border-t-transparent rounded-full animate-spin mx-auto mb-4"}),n.jsx("p",{className:"text-gray-500",children:"Loading operators..."})]}):Ae.length===0?n.jsxs("div",{className:"card text-center py-12",children:[n.jsx(ds,{className:"w-12 h-12 mx-auto mb-4 text-gray-300"}),t.length===0?n.jsxs(n.Fragment,{children:[n.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-1",children:"No operators yet"}),n.jsx("p",{className:"text-gray-500 mb-4",children:"Add team members to assign them to projects and track certifications."}),n.jsxs("button",{onClick:()=>R(!0),className:"btn-primary inline-flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Add Operator"]})]}):n.jsxs(n.Fragment,{children:[n.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-1",children:"No matching operators"}),n.jsx("p",{className:"text-gray-500",children:"Try adjusting your search or filters."})]})]}):n.jsx("div",{className:"space-y-3",children:Ae.map(ne=>{var ae,q,oe,ke,Ve;return n.jsxs("div",{className:"card",children:[n.jsxs("div",{className:"flex items-start gap-4",children:[n.jsx("div",{className:"w-12 h-12 bg-aeria-blue rounded-full flex items-center justify-center flex-shrink-0",children:n.jsxs("span",{className:"text-white font-semibold text-lg",children:[(ae=ne.firstName)==null?void 0:ae[0],(q=ne.lastName)==null?void 0:q[0]]})}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[n.jsxs("h3",{className:"font-semibold text-gray-900",children:[ne.firstName," ",ne.lastName]}),ne.status==="inactive"&&n.jsx("span",{className:"px-2 py-0.5 text-xs font-medium bg-gray-100 text-gray-500 rounded-full",children:"Inactive"}),Ce(ne)&&n.jsx(ir,{className:"w-4 h-4 text-amber-500"})]}),n.jsxs("div",{className:"flex flex-wrap gap-x-4 gap-y-1 text-sm text-gray-500 mb-2",children:[ne.email&&n.jsxs("span",{className:"inline-flex items-center gap-1",children:[n.jsx(bT,{className:"w-3.5 h-3.5"}),ne.email]}),ne.phone&&n.jsxs("span",{className:"inline-flex items-center gap-1",children:[n.jsx(Hd,{className:"w-3.5 h-3.5"}),ne.phone]})]}),((oe=ne.roles)==null?void 0:oe.length)>0&&n.jsx("div",{className:"flex flex-wrap gap-1",children:ne.roles.map((ie,ze)=>n.jsx("span",{className:`px-2 py-0.5 text-xs font-medium rounded-full ${Boe[ie]||"bg-gray-100 text-gray-700"}`,children:ie},ze))})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[((ke=ne.certifications)==null?void 0:ke.length)>0&&n.jsxs("button",{onClick:()=>he(X===ne.id?null:ne.id),className:"p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100",title:"View certifications",children:[n.jsx(gS,{className:"w-4 h-4"}),X===ne.id?n.jsx($n,{className:"w-3 h-3 absolute -mt-1 -mr-1"}):n.jsx(fn,{className:"w-3 h-3 absolute -mt-1 -mr-1"})]}),n.jsxs("div",{className:"relative",children:[n.jsx("button",{onClick:()=>H(Y===ne.id?null:ne.id),className:"p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100",children:n.jsx(Qd,{className:"w-4 h-4"})}),Y===ne.id&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>H(null)}),n.jsxs("div",{className:"absolute right-0 mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-20",children:[n.jsxs("button",{onClick:()=>K(ne),className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2",children:[n.jsx(uf,{className:"w-4 h-4"}),"Edit"]}),n.jsxs("button",{onClick:()=>de(ne.id,`${ne.firstName} ${ne.lastName}`),className:"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2",children:[n.jsx(Ln,{className:"w-4 h-4"}),"Delete"]})]})]})]})]})]}),X===ne.id&&((Ve=ne.certifications)==null?void 0:Ve.length)>0&&n.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-200",children:[n.jsxs("h4",{className:"text-sm font-medium text-gray-700 mb-3 flex items-center gap-2",children:[n.jsx(gS,{className:"w-4 h-4"}),"Certifications"]}),n.jsx("div",{className:"grid sm:grid-cols-2 gap-3",children:ne.certifications.map((ie,ze)=>{const ve=Te(ie),Le=ve.icon;return n.jsxs("div",{className:`p-3 rounded-lg border ${ve.status==="expired"?"bg-red-50 border-red-200":ve.status==="expiring"?"bg-amber-50 border-amber-200":"bg-gray-50 border-gray-200"}`,children:[n.jsxs("div",{className:"flex items-start justify-between",children:[n.jsxs("div",{children:[n.jsx("p",{className:"font-medium text-gray-900 text-sm",children:ie.type}),n.jsx("p",{className:"text-xs text-gray-500",children:ie.issuingBody}),ie.certificateNumber&&n.jsxs("p",{className:"text-xs text-gray-400 font-mono mt-1",children:["#",ie.certificateNumber]})]}),n.jsxs("div",{className:`flex items-center gap-1 text-xs font-medium ${ve.color}`,children:[Le&&n.jsx(Le,{className:"w-3.5 h-3.5"}),ve.label]})]}),ie.expiryDate&&n.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["Expires: ",bc(new Date(ie.expiryDate),"MMM d, yyyy")]})]},ze)})})]})]},ne.id)})}),n.jsx(zoe,{isOpen:C,onClose:ge,operator:F})]})}const Uoe=[{value:"multirotor",label:"Multirotor"},{value:"fixed_wing",label:"Fixed Wing"},{value:"vtol",label:"VTOL (Hybrid)"},{value:"helicopter",label:"Helicopter"},{value:"other",label:"Other"}],qoe=[{value:"airworthy",label:"Airworthy"},{value:"maintenance",label:"In Maintenance"},{value:"grounded",label:"Grounded"},{value:"retired",label:"Retired"}];function $oe({isOpen:t,onClose:e,aircraft:r}){const c=!!r,[h,x]=ue.useState(!1),[w,o]=ue.useState(""),[C,R]=ue.useState({nickname:"",make:"",model:"",serialNumber:"",registration:"",category:"multirotor",mtow:"",maxSpeed:"",maxAltitude:"",endurance:"",sensors:"",status:"airworthy",notes:""});ue.useEffect(()=>{r?R({nickname:r.nickname||"",make:r.make||"",model:r.model||"",serialNumber:r.serialNumber||"",registration:r.registration||"",category:r.category||"multirotor",mtow:r.mtow||"",maxSpeed:r.maxSpeed||"",maxAltitude:r.maxAltitude||"",endurance:r.endurance||"",sensors:r.sensors||"",status:r.status||"airworthy",notes:r.notes||""}):F()},[r,t]);const F=()=>{R({nickname:"",make:"",model:"",serialNumber:"",registration:"",category:"multirotor",mtow:"",maxSpeed:"",maxAltitude:"",endurance:"",sensors:"",status:"airworthy",notes:""}),o("")},$=X=>{const{name:he,value:se}=X.target;R(de=>({...de,[he]:se}))},Y=async X=>{X.preventDefault(),o(""),x(!0);try{if(!C.nickname.trim())throw new Error("Nickname is required");if(!C.make.trim())throw new Error("Make is required");if(!C.model.trim())throw new Error("Model is required");const he={...C,mtow:C.mtow?parseFloat(C.mtow):null,maxSpeed:C.maxSpeed?parseFloat(C.maxSpeed):null,maxAltitude:C.maxAltitude?parseFloat(C.maxAltitude):null,endurance:C.endurance?parseFloat(C.endurance):null};c?await rU(r.id,he):await iU(he),e()}catch(he){o(he.message)}finally{x(!1)}},H=()=>{F(),e()};return n.jsx(Lj,{isOpen:t,onClose:H,title:c?"Edit Aircraft":"Add Aircraft",size:"lg",children:n.jsxs("form",{onSubmit:Y,className:"space-y-6",children:[w&&n.jsxs("div",{className:"flex items-center gap-2 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm",children:[n.jsx(Cs,{className:"w-4 h-4 flex-shrink-0"}),n.jsx("span",{children:w})]}),n.jsxs("div",{children:[n.jsxs("h3",{className:"text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[n.jsx(Zn,{className:"w-4 h-4"}),"Aircraft Information"]}),n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsxs("label",{className:"label",children:["Nickname ",n.jsx("span",{className:"text-red-500",children:"*"})]}),n.jsx("input",{type:"text",name:"nickname",value:C.nickname,onChange:$,className:"input",placeholder:"e.g., Blue Bird, M300-01"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Category"}),n.jsx("select",{name:"category",value:C.category,onChange:$,className:"input",children:Uoe.map(X=>n.jsx("option",{value:X.value,children:X.label},X.value))})]}),n.jsxs("div",{children:[n.jsxs("label",{className:"label",children:["Make ",n.jsx("span",{className:"text-red-500",children:"*"})]}),n.jsx("input",{type:"text",name:"make",value:C.make,onChange:$,className:"input",placeholder:"e.g., DJI, senseFly, Freefly"})]}),n.jsxs("div",{children:[n.jsxs("label",{className:"label",children:["Model ",n.jsx("span",{className:"text-red-500",children:"*"})]}),n.jsx("input",{type:"text",name:"model",value:C.model,onChange:$,className:"input",placeholder:"e.g., Matrice 300 RTK"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Serial Number"}),n.jsx("input",{type:"text",name:"serialNumber",value:C.serialNumber,onChange:$,className:"input font-mono",placeholder:"Manufacturer serial number"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Registration"}),n.jsx("input",{type:"text",name:"registration",value:C.registration,onChange:$,className:"input font-mono",placeholder:"e.g., C-XXXX (if registered)"})]})]})]}),n.jsxs("div",{children:[n.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[n.jsx("h3",{className:"text-sm font-semibold text-gray-900",children:"Performance Specifications"}),n.jsxs("div",{className:"group relative",children:[n.jsx(Ns,{className:"w-4 h-4 text-gray-400"}),n.jsx("div",{className:"absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none",children:"Used for SORA calculations"})]})]}),n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"MTOW (kg)"}),n.jsx("input",{type:"number",name:"mtow",value:C.mtow,onChange:$,className:"input",placeholder:"Maximum takeoff weight",step:"0.1",min:"0"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Max Speed (m/s)"}),n.jsx("input",{type:"number",name:"maxSpeed",value:C.maxSpeed,onChange:$,className:"input",placeholder:"Maximum cruise speed",step:"0.1",min:"0"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Max Altitude AGL (m)"}),n.jsx("input",{type:"number",name:"maxAltitude",value:C.maxAltitude,onChange:$,className:"input",placeholder:"Maximum operating altitude",step:"1",min:"0"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Endurance (minutes)"}),n.jsx("input",{type:"number",name:"endurance",value:C.endurance,onChange:$,className:"input",placeholder:"Typical flight time",step:"1",min:"0"})]})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Sensors / Payloads"}),n.jsx("textarea",{name:"sensors",value:C.sensors,onChange:$,className:"input min-h-[80px]",placeholder:"e.g., Zenmuse H20T, L1 LiDAR, MicaSense RedEdge..."})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Status"}),n.jsx("select",{name:"status",value:C.status,onChange:$,className:"input w-48",children:qoe.map(X=>n.jsx("option",{value:X.value,children:X.label},X.value))})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Notes"}),n.jsx("textarea",{name:"notes",value:C.notes,onChange:$,className:"input min-h-[80px]",placeholder:"Any additional notes about this aircraft..."})]}),n.jsxs(Fj,{children:[n.jsx("button",{type:"button",onClick:H,className:"btn-secondary",children:"Cancel"}),n.jsx("button",{type:"submit",disabled:h,className:"btn-primary",children:h?"Saving...":c?"Save Changes":"Add Aircraft"})]})]})})}const A2={airworthy:{label:"Airworthy",color:"bg-green-100 text-green-700 border-green-200",icon:qr},maintenance:{label:"In Maintenance",color:"bg-amber-100 text-amber-700 border-amber-200",icon:bf},grounded:{label:"Grounded",color:"bg-red-100 text-red-700 border-red-200",icon:ir},retired:{label:"Retired",color:"bg-gray-100 text-gray-500 border-gray-200",icon:cs}},NI={multirotor:"Multirotor",fixed_wing:"Fixed Wing",vtol:"VTOL",helicopter:"Helicopter",other:"Other"},ss=({icon:t,label:e,value:r,unit:c,className:h=""})=>!r&&r!==0?null:n.jsxs("div",{className:`flex items-start gap-3 p-3 bg-gray-50 rounded-lg ${h}`,children:[n.jsx("div",{className:"p-2 bg-white rounded-lg shadow-sm",children:n.jsx(t,{className:"w-4 h-4 text-aeria-navy"})}),n.jsxs("div",{children:[n.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide",children:e}),n.jsxs("p",{className:"font-semibold text-gray-900",children:[r,c&&n.jsx("span",{className:"text-gray-500 font-normal ml-1",children:c})]})]})]});function Goe({aircraft:t,isOpen:e,onClose:r,branding:c}){const[h,x]=ue.useState(!1),[w,o]=ue.useState(!1);if(!e||!t)return null;const C=A2[t.status]||A2.airworthy,R=C.icon,F=async()=>{const H=$(t);await navigator.clipboard.writeText(H),x(!0),setTimeout(()=>x(!1),2e3)},$=H=>{var he;return["".repeat(50),"AIRCRAFT SPECIFICATION SHEET","".repeat(50),"",`Name: ${H.nickname||"N/A"}`,`Make: ${H.make||"N/A"}`,`Model: ${H.model||"N/A"}`,`Serial Number: ${H.serialNumber||"N/A"}`,`Registration: ${H.registration||"N/A"}`,`Category: ${NI[H.category]||H.category||"N/A"}`,`Status: ${((he=A2[H.status])==null?void 0:he.label)||"Unknown"}`,"","".repeat(30),"PERFORMANCE SPECIFICATIONS","".repeat(30),`MTOW: ${H.mtow?H.mtow+" kg":"N/A"}`,`Max Speed: ${H.maxSpeed?H.maxSpeed+" m/s":"N/A"}`,`Cruise Speed: ${H.cruiseSpeed?H.cruiseSpeed+" m/s":"N/A"}`,`Max Altitude: ${H.maxAltitude?H.maxAltitude+" m":"N/A"}`,`Endurance: ${H.endurance?H.endurance+" min":"N/A"}`,`Range: ${H.range?H.range+" km":"N/A"}`,"","".repeat(30),"PHYSICAL SPECIFICATIONS","".repeat(30),`Dimensions: ${H.dimensions||"N/A"}`,`Wingspan/Diameter: ${H.wingspan?H.wingspan+" m":"N/A"}`,`Empty Weight: ${H.emptyWeight?H.emptyWeight+" kg":"N/A"}`,`Payload Capacity: ${H.payloadCapacity?H.payloadCapacity+" kg":"N/A"}`,"","".repeat(30),"SYSTEMS","".repeat(30),`Propulsion: ${H.propulsion||"N/A"}`,`Battery: ${H.batteryType||"N/A"}`,`Flight Controller: ${H.flightController||"N/A"}`,`GPS: ${H.gps||"N/A"}`,`Datalink: ${H.datalink||"N/A"}`,"","".repeat(30),"SENSORS & PAYLOADS","".repeat(30),`Primary Sensor: ${H.primarySensor||"N/A"}`,`Secondary Sensor: ${H.secondarySensor||"N/A"}`,`Other Payloads: ${H.otherPayloads||"N/A"}`,"","".repeat(30),"MAINTENANCE","".repeat(30),`Last Inspection: ${H.lastInspection||"N/A"}`,`Next Inspection Due: ${H.nextInspectionDue||"N/A"}`,`Total Flight Hours: ${H.totalFlightHours?H.totalFlightHours+" hrs":"N/A"}`,`Total Cycles: ${H.totalCycles||"N/A"}`,"","".repeat(50),`Generated: ${new Date().toLocaleString()}`,"".repeat(50)].join(`
`)},Y=async()=>{o(!0);try{qU(t,c).save(`spec-sheet_${t.nickname||t.serialNumber||"aircraft"}_${new Date().toISOString().split("T")[0]}.pdf`)}catch(H){console.error("PDF export failed:",H)}finally{o(!1)}};return n.jsxs("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:[n.jsx("div",{className:"fixed inset-0 bg-black/50 transition-opacity",onClick:r}),n.jsx("div",{className:"flex min-h-full items-center justify-center p-4",children:n.jsxs("div",{className:"relative bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden",children:[n.jsxs("div",{className:"bg-gradient-to-r from-aeria-navy to-aeria-blue p-6 text-white",children:[n.jsxs("div",{className:"flex items-start justify-between",children:[n.jsxs("div",{className:"flex items-center gap-4",children:[n.jsx("div",{className:"w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center",children:n.jsx(Zn,{className:"w-8 h-8"})}),n.jsxs("div",{children:[n.jsx("h2",{className:"text-2xl font-bold",children:t.nickname||"Unnamed Aircraft"}),n.jsxs("p",{className:"text-white/80",children:[t.make," ",t.model]}),t.serialNumber&&n.jsxs("p",{className:"text-sm text-white/60 font-mono mt-1",children:["S/N: ",t.serialNumber]})]})]}),n.jsx("button",{onClick:r,className:"p-2 hover:bg-white/20 rounded-lg transition-colors",children:n.jsx(cs,{className:"w-5 h-5"})})]}),n.jsxs("div",{className:"flex items-center justify-between mt-4 pt-4 border-t border-white/20",children:[n.jsxs("span",{className:`inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium border ${C.color}`,children:[n.jsx(R,{className:"w-4 h-4"}),C.label]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsxs("button",{onClick:F,className:"flex items-center gap-2 px-3 py-1.5 bg-white/20 hover:bg-white/30 rounded-lg text-sm transition-colors",children:[h?n.jsx(ru,{className:"w-4 h-4"}):n.jsx(Op,{className:"w-4 h-4"}),h?"Copied!":"Copy"]}),n.jsxs("button",{onClick:Y,disabled:w,className:"flex items-center gap-2 px-3 py-1.5 bg-white text-aeria-navy hover:bg-gray-100 rounded-lg text-sm font-medium transition-colors",children:[w?n.jsx("div",{className:"w-4 h-4 border-2 border-aeria-navy border-t-transparent rounded-full animate-spin"}):n.jsx(vc,{className:"w-4 h-4"}),"Export PDF"]})]})]})]}),n.jsxs("div",{className:"p-6 overflow-y-auto max-h-[calc(90vh-200px)]",children:[n.jsxs("div",{className:"mb-6",children:[n.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[n.jsx(Rv,{className:"w-5 h-5 text-aeria-blue"}),"Performance Specifications"]}),n.jsxs("div",{className:"grid sm:grid-cols-2 lg:grid-cols-3 gap-3",children:[n.jsx(ss,{icon:v2,label:"MTOW",value:t.mtow,unit:"kg"}),n.jsx(ss,{icon:Rv,label:"Max Speed",value:t.maxSpeed,unit:"m/s"}),n.jsx(ss,{icon:cf,label:"Cruise Speed",value:t.cruiseSpeed,unit:"m/s"}),n.jsx(ss,{icon:s3,label:"Max Altitude",value:t.maxAltitude,unit:"m"}),n.jsx(ss,{icon:Wu,label:"Endurance",value:t.endurance,unit:"min"}),n.jsx(ss,{icon:by,label:"Range",value:t.range,unit:"km"})]})]}),n.jsxs("div",{className:"mb-6",children:[n.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[n.jsx(o3,{className:"w-5 h-5 text-aeria-blue"}),"Physical Specifications"]}),n.jsxs("div",{className:"grid sm:grid-cols-2 lg:grid-cols-3 gap-3",children:[n.jsx(ss,{icon:s3,label:"Dimensions",value:t.dimensions}),n.jsx(ss,{icon:o3,label:"Wingspan/Diameter",value:t.wingspan,unit:"m"}),n.jsx(ss,{icon:v2,label:"Empty Weight",value:t.emptyWeight,unit:"kg"}),n.jsx(ss,{icon:v2,label:"Payload Capacity",value:t.payloadCapacity,unit:"kg"}),n.jsx(ss,{icon:Zn,label:"Category",value:NI[t.category]})]})]}),n.jsxs("div",{className:"mb-6",children:[n.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[n.jsx(t3,{className:"w-5 h-5 text-aeria-blue"}),"Systems"]}),n.jsxs("div",{className:"grid sm:grid-cols-2 lg:grid-cols-3 gap-3",children:[n.jsx(ss,{icon:kv,label:"Propulsion",value:t.propulsion}),n.jsx(ss,{icon:lie,label:"Battery",value:t.batteryType}),n.jsx(ss,{icon:t3,label:"Flight Controller",value:t.flightController}),n.jsx(ss,{icon:cf,label:"GPS",value:t.gps}),n.jsx(ss,{icon:Jc,label:"Datalink",value:t.datalink}),n.jsx(ss,{icon:Jc,label:"Frequency",value:t.frequency,unit:"GHz"})]})]}),n.jsxs("div",{className:"mb-6",children:[n.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[n.jsx(bl,{className:"w-5 h-5 text-aeria-blue"}),"Sensors & Payloads"]}),n.jsxs("div",{className:"grid sm:grid-cols-2 lg:grid-cols-3 gap-3",children:[n.jsx(ss,{icon:bl,label:"Primary Sensor",value:t.primarySensor}),n.jsx(ss,{icon:bl,label:"Secondary Sensor",value:t.secondarySensor}),n.jsx(ss,{icon:kv,label:"Other Payloads",value:t.otherPayloads})]})]}),n.jsxs("div",{className:"mb-6",children:[n.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[n.jsx(l3,{className:"w-5 h-5 text-aeria-blue"}),"Identification"]}),n.jsxs("div",{className:"grid sm:grid-cols-2 lg:grid-cols-3 gap-3",children:[n.jsx(ss,{icon:r3,label:"Serial Number",value:t.serialNumber}),n.jsx(ss,{icon:l3,label:"Registration",value:t.registration}),n.jsx(ss,{icon:Ds,label:"Insurance Policy",value:t.insurancePolicy})]})]}),n.jsxs("div",{className:"mb-6",children:[n.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[n.jsx(bf,{className:"w-5 h-5 text-aeria-blue"}),"Maintenance"]}),n.jsxs("div",{className:"grid sm:grid-cols-2 lg:grid-cols-3 gap-3",children:[n.jsx(ss,{icon:il,label:"Last Inspection",value:t.lastInspection}),n.jsx(ss,{icon:il,label:"Next Inspection",value:t.nextInspectionDue}),n.jsx(ss,{icon:Wu,label:"Total Flight Hours",value:t.totalFlightHours,unit:"hrs"}),n.jsx(ss,{icon:r3,label:"Total Cycles",value:t.totalCycles})]})]}),t.notes&&n.jsxs("div",{className:"mb-6",children:[n.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[n.jsx(rs,{className:"w-5 h-5 text-aeria-blue"}),"Notes"]}),n.jsx("div",{className:"p-4 bg-gray-50 rounded-lg",children:n.jsx("p",{className:"text-gray-700 whitespace-pre-wrap",children:t.notes})})]})]})]})})]})}function qU(t,e={}){var c;const r=new Jd({title:"Aircraft Specification Sheet",subtitle:`${t.make} ${t.model}`,projectName:t.nickname||"Aircraft",projectCode:t.serialNumber||"",branding:e});return r.addCoverPage(),r.addNewPage(),r.addSectionTitle("Aircraft Information"),r.addKeyValueGrid([{label:"Name",value:t.nickname},{label:"Make",value:t.make},{label:"Model",value:t.model},{label:"Serial Number",value:t.serialNumber},{label:"Registration",value:t.registration},{label:"Category",value:NI[t.category]},{label:"Status",value:(c=A2[t.status])==null?void 0:c.label}]),r.addSectionTitle("Performance Specifications"),r.addKeyValueGrid([{label:"MTOW",value:t.mtow?`${t.mtow} kg`:"N/A"},{label:"Max Speed",value:t.maxSpeed?`${t.maxSpeed} m/s`:"N/A"},{label:"Cruise Speed",value:t.cruiseSpeed?`${t.cruiseSpeed} m/s`:"N/A"},{label:"Max Altitude",value:t.maxAltitude?`${t.maxAltitude} m`:"N/A"},{label:"Endurance",value:t.endurance?`${t.endurance} min`:"N/A"},{label:"Range",value:t.range?`${t.range} km`:"N/A"}]),r.addSectionTitle("Physical Specifications"),r.addKeyValueGrid([{label:"Dimensions",value:t.dimensions||"N/A"},{label:"Wingspan/Diameter",value:t.wingspan?`${t.wingspan} m`:"N/A"},{label:"Empty Weight",value:t.emptyWeight?`${t.emptyWeight} kg`:"N/A"},{label:"Payload Capacity",value:t.payloadCapacity?`${t.payloadCapacity} kg`:"N/A"}]),r.addSectionTitle("Systems"),r.addKeyValueGrid([{label:"Propulsion",value:t.propulsion||"N/A"},{label:"Battery",value:t.batteryType||"N/A"},{label:"Flight Controller",value:t.flightController||"N/A"},{label:"GPS",value:t.gps||"N/A"},{label:"Datalink",value:t.datalink||"N/A"},{label:"Frequency",value:t.frequency?`${t.frequency} GHz`:"N/A"}]),r.addSectionTitle("Sensors & Payloads"),r.addKeyValueGrid([{label:"Primary Sensor",value:t.primarySensor||"N/A"},{label:"Secondary Sensor",value:t.secondarySensor||"N/A"},{label:"Other Payloads",value:t.otherPayloads||"N/A"}]),r.addSectionTitle("Maintenance"),r.addKeyValueGrid([{label:"Last Inspection",value:t.lastInspection||"N/A"},{label:"Next Inspection",value:t.nextInspectionDue||"N/A"},{label:"Total Flight Hours",value:t.totalFlightHours?`${t.totalFlightHours} hrs`:"N/A"},{label:"Total Cycles",value:t.totalCycles||"N/A"}]),t.notes&&(r.addSectionTitle("Notes"),r.addParagraph(t.notes)),r}const s5={airworthy:{label:"Airworthy",color:"bg-green-100 text-green-700",icon:qr},maintenance:{label:"In Maintenance",color:"bg-amber-100 text-amber-700",icon:bf},grounded:{label:"Grounded",color:"bg-red-100 text-red-700",icon:ir},retired:{label:"Retired",color:"bg-gray-100 text-gray-500",icon:aie}},Hoe={multirotor:"Multirotor",fixed_wing:"Fixed Wing",vtol:"VTOL",helicopter:"Helicopter",other:"Other"};function Woe(){const[t,e]=ue.useState([]),[r,c]=ue.useState(!0),[h,x]=ue.useState(""),[w,o]=ue.useState("all"),[C,R]=ue.useState(!1),[F,$]=ue.useState(null),[Y,H]=ue.useState(null),[X,he]=ue.useState(null),{branding:se}=Zj();ue.useEffect(()=>{de()},[]);const de=async()=>{c(!0);try{const q=await IT();e(q)}catch(q){console.error("Error loading aircraft:",q)}finally{c(!1)}},K=async(q,oe)=>{if(confirm(`Are you sure you want to delete ${oe}? This cannot be undone.`)){try{await nU(q),e(ke=>ke.filter(Ve=>Ve.id!==q))}catch(ke){console.error("Error deleting aircraft:",ke),alert("Failed to delete aircraft")}H(null)}},ge=q=>{$(q),R(!0),H(null)},Ae=q=>{he(q),H(null)},Te=q=>{try{qU(q,se).save(`spec-sheet_${q.nickname||q.serialNumber||"aircraft"}_${new Date().toISOString().split("T")[0]}.pdf`)}catch(oe){console.error("Failed to export spec:",oe)}H(null)},Ce=()=>{R(!1),$(null),de()},ne=t.filter(q=>{var Ve,ie,ze,ve;const oe=((Ve=q.nickname)==null?void 0:Ve.toLowerCase().includes(h.toLowerCase()))||((ie=q.make)==null?void 0:ie.toLowerCase().includes(h.toLowerCase()))||((ze=q.model)==null?void 0:ze.toLowerCase().includes(h.toLowerCase()))||((ve=q.serialNumber)==null?void 0:ve.toLowerCase().includes(h.toLowerCase())),ke=w==="all"||q.status===w;return oe&&ke}),ae={total:t.length,airworthy:t.filter(q=>q.status==="airworthy").length,maintenance:t.filter(q=>q.status==="maintenance").length,grounded:t.filter(q=>q.status==="grounded").length};return n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[n.jsxs("div",{children:[n.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Aircraft"}),n.jsx("p",{className:"text-gray-600 mt-1",children:"RPAS fleet management"})]}),n.jsxs("button",{onClick:()=>R(!0),className:"btn-primary inline-flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Add Aircraft"]})]}),n.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4",children:[n.jsxs("div",{className:"card bg-gray-50",children:[n.jsx("p",{className:"text-sm text-gray-500",children:"Total Fleet"}),n.jsx("p",{className:"text-2xl font-bold text-gray-900",children:ae.total})]}),n.jsxs("div",{className:"card bg-green-50",children:[n.jsx("p",{className:"text-sm text-green-600",children:"Airworthy"}),n.jsx("p",{className:"text-2xl font-bold text-green-700",children:ae.airworthy})]}),n.jsxs("div",{className:"card bg-amber-50",children:[n.jsx("p",{className:"text-sm text-amber-600",children:"In Maintenance"}),n.jsx("p",{className:"text-2xl font-bold text-amber-700",children:ae.maintenance})]}),n.jsxs("div",{className:"card bg-red-50",children:[n.jsx("p",{className:"text-sm text-red-600",children:"Grounded"}),n.jsx("p",{className:"text-2xl font-bold text-red-700",children:ae.grounded})]})]}),n.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[n.jsxs("div",{className:"relative flex-1",children:[n.jsx(nu,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),n.jsx("input",{type:"text",placeholder:"Search aircraft...",value:h,onChange:q=>x(q.target.value),className:"input pl-9"})]}),n.jsxs("select",{value:w,onChange:q=>o(q.target.value),className:"input w-full sm:w-44",children:[n.jsx("option",{value:"all",children:"All Status"}),n.jsx("option",{value:"airworthy",children:"Airworthy"}),n.jsx("option",{value:"maintenance",children:"In Maintenance"}),n.jsx("option",{value:"grounded",children:"Grounded"}),n.jsx("option",{value:"retired",children:"Retired"})]})]}),r?n.jsxs("div",{className:"card text-center py-12",children:[n.jsx("div",{className:"w-8 h-8 border-4 border-aeria-navy border-t-transparent rounded-full animate-spin mx-auto mb-4"}),n.jsx("p",{className:"text-gray-500",children:"Loading aircraft..."})]}):ne.length===0?n.jsxs("div",{className:"card text-center py-12",children:[n.jsx(Zn,{className:"w-12 h-12 mx-auto mb-4 text-gray-300"}),t.length===0?n.jsxs(n.Fragment,{children:[n.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-1",children:"No aircraft yet"}),n.jsx("p",{className:"text-gray-500 mb-4",children:"Add aircraft to your fleet to assign them to operations."}),n.jsxs("button",{onClick:()=>R(!0),className:"btn-primary inline-flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Add Aircraft"]})]}):n.jsxs(n.Fragment,{children:[n.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-1",children:"No matching aircraft"}),n.jsx("p",{className:"text-gray-500",children:"Try adjusting your search or filters."})]})]}):n.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:ne.map(q=>{const oe=s5[q.status]||s5.airworthy,ke=oe.icon;return n.jsxs("div",{className:"card hover:shadow-md transition-shadow",children:[n.jsxs("div",{className:"flex items-start justify-between mb-3",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("div",{className:"w-10 h-10 bg-aeria-sky rounded-lg flex items-center justify-center",children:n.jsx(Zn,{className:"w-5 h-5 text-aeria-navy"})}),n.jsxs("div",{children:[n.jsx("h3",{className:"font-semibold text-gray-900",children:q.nickname}),n.jsxs("p",{className:"text-sm text-gray-500",children:[q.make," ",q.model]})]})]}),n.jsxs("div",{className:"relative",children:[n.jsx("button",{onClick:()=>H(Y===q.id?null:q.id),className:"p-1.5 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100",children:n.jsx(Qd,{className:"w-4 h-4"})}),Y===q.id&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>H(null)}),n.jsxs("div",{className:"absolute right-0 mt-1 w-52 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-20",children:[n.jsxs("button",{onClick:()=>Ae(q),className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2",children:[n.jsx(ga,{className:"w-4 h-4"}),"View Spec Sheet"]}),n.jsxs("button",{onClick:()=>Te(q),className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2",children:[n.jsx(vc,{className:"w-4 h-4"}),"Export Spec PDF"]}),n.jsx("hr",{className:"my-1 border-gray-200"}),n.jsxs("button",{onClick:()=>ge(q),className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2",children:[n.jsx(uf,{className:"w-4 h-4"}),"Edit"]}),n.jsxs("button",{onClick:()=>K(q.id,q.nickname),className:"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2",children:[n.jsx(Ln,{className:"w-4 h-4"}),"Delete"]})]})]})]})]}),n.jsx("div",{className:"mb-3",children:n.jsxs("span",{className:`inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full ${oe.color}`,children:[n.jsx(ke,{className:"w-3.5 h-3.5"}),oe.label]})}),n.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[q.mtow&&n.jsxs("div",{className:"flex items-center gap-1.5 text-gray-600",children:[n.jsx(v2,{className:"w-3.5 h-3.5 text-gray-400"}),n.jsxs("span",{children:[q.mtow," kg"]})]}),q.maxSpeed&&n.jsxs("div",{className:"flex items-center gap-1.5 text-gray-600",children:[n.jsx(Rv,{className:"w-3.5 h-3.5 text-gray-400"}),n.jsxs("span",{children:[q.maxSpeed," m/s"]})]}),q.endurance&&n.jsxs("div",{className:"flex items-center gap-1.5 text-gray-600",children:[n.jsx(Wu,{className:"w-3.5 h-3.5 text-gray-400"}),n.jsxs("span",{children:[q.endurance," min"]})]}),q.category&&n.jsxs("div",{className:"flex items-center gap-1.5 text-gray-600",children:[n.jsx(Zn,{className:"w-3.5 h-3.5 text-gray-400"}),n.jsx("span",{children:Hoe[q.category]||q.category})]})]}),q.serialNumber&&n.jsxs("p",{className:"text-xs text-gray-400 font-mono mt-3 pt-3 border-t border-gray-100",children:["S/N: ",q.serialNumber]}),n.jsxs("button",{onClick:()=>Ae(q),className:"w-full mt-3 pt-3 border-t border-gray-100 text-sm text-aeria-blue hover:text-aeria-navy flex items-center justify-center gap-1",children:[n.jsx(rs,{className:"w-4 h-4"}),"View Full Specifications"]})]},q.id)})}),n.jsx($oe,{isOpen:C,onClose:Ce,aircraft:F}),n.jsx(Goe,{aircraft:X,isOpen:!!X,onClose:()=>he(null),branding:se})]})}function Zoe({logo:t,onLogoChange:e}){const r=ue.useRef(null),[c,h]=ue.useState(!1),[x,w]=ue.useState(!1),o=async $=>{if($){if(!$.type.startsWith("image/")){alert("Please select an image file (PNG, JPG, GIF)");return}if($.size>500*1024){alert("Logo must be less than 500KB. Please resize or compress the image.");return}h(!0);try{const Y=new FileReader;Y.onload=H=>{const X=new window.Image;X.onload=()=>{let{width:de,height:K}=X;if(de>200||K>100){const Ce=Math.min(200/de,100/K);de*=Ce,K*=Ce}const ge=document.createElement("canvas");ge.width=de,ge.height=K,ge.getContext("2d").drawImage(X,0,0,de,K);const Te=ge.toDataURL("image/png",.9);e(Te),h(!1)},X.src=H.target.result},Y.onerror=()=>{alert("Error reading file"),h(!1)},Y.readAsDataURL($)}catch(Y){console.error("Error uploading logo:",Y),alert("Failed to upload logo"),h(!1)}}},C=$=>{$.preventDefault(),w(!1);const Y=$.dataTransfer.files[0];o(Y)},R=$=>{$.preventDefault(),w(!0)},F=()=>{w(!1)};return n.jsxs("div",{className:"space-y-2",children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Company Logo",n.jsx("span",{className:"text-gray-400 font-normal ml-1",children:"(for branded exports)"})]}),t?n.jsxs("div",{className:"flex items-center gap-4",children:[n.jsx("div",{className:"relative w-32 h-20 border rounded-lg bg-gray-50 flex items-center justify-center p-2",children:n.jsx("img",{src:t,alt:"Client logo",className:"max-w-full max-h-full object-contain"})}),n.jsxs("div",{className:"flex flex-col gap-2",children:[n.jsx("button",{type:"button",onClick:()=>{var $;return($=r.current)==null?void 0:$.click()},className:"btn-secondary text-sm",children:"Replace"}),n.jsx("button",{type:"button",onClick:()=>e(null),className:"text-red-500 text-sm hover:text-red-700",children:"Remove"})]})]}):n.jsx("div",{className:`border-2 border-dashed rounded-lg p-4 text-center transition-colors cursor-pointer
            ${x?"border-aeria-blue bg-blue-50":"border-gray-300 hover:border-aeria-blue"}`,onClick:()=>{var $;return($=r.current)==null?void 0:$.click()},onDrop:C,onDragOver:R,onDragLeave:F,children:c?n.jsxs("div",{className:"flex flex-col items-center gap-2 py-2",children:[n.jsx(Ro,{className:"w-6 h-6 text-aeria-blue animate-spin"}),n.jsx("p",{className:"text-sm text-gray-500",children:"Processing..."})]}):n.jsxs(n.Fragment,{children:[n.jsx(By,{className:"w-8 h-8 mx-auto text-gray-400 mb-2"}),n.jsx("p",{className:"text-sm text-gray-500",children:"Drop logo here or click to upload"}),n.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"PNG, JPG up to 500KB. Will be resized to fit."})]})}),n.jsx("input",{ref:r,type:"file",accept:"image/*",className:"hidden",onChange:$=>o($.target.files[0])})]})}function Xoe({isOpen:t,onClose:e,client:r,onSave:c}){const[h,x]=ue.useState({name:"",contactName:"",email:"",phone:"",address:"",notes:"",logo:null}),[w,o]=ue.useState(!1);ue.useEffect(()=>{x(r?{name:r.name||"",contactName:r.contactName||"",email:r.email||"",phone:r.phone||"",address:r.address||"",notes:r.notes||"",logo:r.logo||null}:{name:"",contactName:"",email:"",phone:"",address:"",notes:"",logo:null})},[r,t]);const C=async R=>{if(R.preventDefault(),!h.name.trim()){alert("Please enter a client name");return}o(!0);try{await c(h),e()}catch(F){console.error("Error saving client:",F),alert("Failed to save client")}finally{o(!1)}};return t?n.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:n.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto",children:[n.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-200",children:[n.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:r?"Edit Client":"Add Client"}),n.jsx("button",{onClick:e,className:"p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100",children:n.jsx(cs,{className:"w-5 h-5"})})]}),n.jsxs("form",{onSubmit:C,className:"p-4 space-y-4",children:[n.jsx(Zoe,{logo:h.logo,onLogoChange:R=>x({...h,logo:R})}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Company Name *"}),n.jsx("input",{type:"text",value:h.name,onChange:R=>x({...h,name:R.target.value}),className:"input",placeholder:"Client company name",required:!0})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Primary Contact"}),n.jsx("input",{type:"text",value:h.contactName,onChange:R=>x({...h,contactName:R.target.value}),className:"input",placeholder:"Contact person name"})]}),n.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),n.jsx("input",{type:"email",value:h.email,onChange:R=>x({...h,email:R.target.value}),className:"input",placeholder:"email@company.com"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Phone"}),n.jsx("input",{type:"tel",value:h.phone,onChange:R=>x({...h,phone:R.target.value}),className:"input",placeholder:"+1 (555) 123-4567"})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Address"}),n.jsx("textarea",{value:h.address,onChange:R=>x({...h,address:R.target.value}),className:"input",rows:2,placeholder:"Street, City, Province, Postal Code"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),n.jsx("textarea",{value:h.notes,onChange:R=>x({...h,notes:R.target.value}),className:"input",rows:2,placeholder:"Any additional notes..."})]}),n.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t border-gray-200",children:[n.jsx("button",{type:"button",onClick:e,className:"btn-secondary",children:"Cancel"}),n.jsx("button",{type:"submit",className:"btn-primary",disabled:w,children:w?"Saving...":r?"Update Client":"Add Client"})]})]})]})}):null}function Yoe({client:t,onEdit:e,onDelete:r,menuOpen:c,setMenuOpen:h}){const x=C=>{C.stopPropagation(),h(c===t.id?null:t.id)},w=C=>{C.stopPropagation(),e(t),h(null)},o=C=>{C.stopPropagation(),r(t.id,t.name),h(null)};return n.jsxs("div",{className:"card hover:shadow-lg transition-shadow",children:[n.jsxs("div",{className:"flex items-start justify-between",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[t.logo?n.jsx("div",{className:"w-12 h-12 rounded-lg border bg-white flex items-center justify-center p-1",children:n.jsx("img",{src:t.logo,alt:t.name,className:"max-w-full max-h-full object-contain"})}):n.jsx("div",{className:"w-12 h-12 rounded-lg bg-gradient-to-br from-aeria-blue to-aeria-navy flex items-center justify-center",children:n.jsx(Vl,{className:"w-6 h-6 text-white"})}),n.jsxs("div",{children:[n.jsx("h3",{className:"font-semibold text-gray-900",children:t.name}),t.contactName&&n.jsxs("p",{className:"text-sm text-gray-500 flex items-center gap-1",children:[n.jsx(fa,{className:"w-3 h-3"}),t.contactName]})]})]}),n.jsxs("div",{className:"relative",children:[n.jsx("button",{onClick:x,className:"p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100",children:n.jsx(Qd,{className:"w-4 h-4"})}),c===t.id&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"fixed inset-0 z-10",onClick:C=>{C.stopPropagation(),h(null)}}),n.jsxs("div",{className:"absolute right-0 top-10 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-20 min-w-[120px]",children:[n.jsxs("button",{onClick:w,className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2",children:[n.jsx(uf,{className:"w-4 h-4"}),"Edit"]}),n.jsxs("button",{onClick:o,className:"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2",children:[n.jsx(Ln,{className:"w-4 h-4"}),"Delete"]})]})]})]})]}),n.jsxs("div",{className:"mt-4 space-y-2",children:[t.email&&n.jsxs("a",{href:`mailto:${t.email}`,className:"text-sm text-gray-600 hover:text-aeria-blue flex items-center gap-2",children:[n.jsx(bT,{className:"w-4 h-4 text-gray-400"}),t.email]}),t.phone&&n.jsxs("a",{href:`tel:${t.phone}`,className:"text-sm text-gray-600 hover:text-aeria-blue flex items-center gap-2",children:[n.jsx(Hd,{className:"w-4 h-4 text-gray-400"}),t.phone]}),t.address&&n.jsxs("p",{className:"text-sm text-gray-500 flex items-start gap-2",children:[n.jsx(Wn,{className:"w-4 h-4 text-gray-400 mt-0.5 flex-shrink-0"}),n.jsx("span",{className:"line-clamp-2",children:t.address})]})]}),t.notes&&n.jsx("div",{className:"mt-3 pt-3 border-t border-gray-100",children:n.jsx("p",{className:"text-xs text-gray-400 line-clamp-2",children:t.notes})}),t.logo&&n.jsx("div",{className:"mt-3 pt-3 border-t border-gray-100",children:n.jsxs("span",{className:"inline-flex items-center gap-1 text-xs text-green-600 bg-green-50 px-2 py-1 rounded",children:[n.jsx(By,{className:"w-3 h-3"}),"Logo on file"]})})]})}function Koe(){const[t,e]=ue.useState([]),[r,c]=ue.useState(!0),[h,x]=ue.useState(""),[w,o]=ue.useState(!1),[C,R]=ue.useState(null),[F,$]=ue.useState(null);ue.useEffect(()=>{Y()},[]);const Y=async()=>{c(!0);try{const de=await ix();e(de)}catch(de){console.error("Error loading clients:",de)}finally{c(!1)}},H=async de=>{C?await Y6(C.id,de):await Dj(de),await Y(),R(null)},X=async(de,K)=>{if(confirm(`Are you sure you want to delete "${K}"?`))try{await K6(de),await Y()}catch(ge){console.error("Error deleting client:",ge),alert("Failed to delete client")}},he=de=>{R(de),o(!0)},se=t.filter(de=>{var ge,Ae,Te;const K=h.toLowerCase();return((ge=de.name)==null?void 0:ge.toLowerCase().includes(K))||((Ae=de.contactName)==null?void 0:Ae.toLowerCase().includes(K))||((Te=de.email)==null?void 0:Te.toLowerCase().includes(K))});return n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[n.jsxs("div",{children:[n.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Clients"}),n.jsx("p",{className:"text-gray-600 mt-1",children:"Manage your client companies"})]}),n.jsxs("button",{onClick:()=>{R(null),o(!0)},className:"btn-primary",children:[n.jsx(vr,{className:"w-4 h-4 mr-2"}),"Add Client"]})]}),n.jsxs("div",{className:"relative",children:[n.jsx(nu,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),n.jsx("input",{type:"text",placeholder:"Search clients...",value:h,onChange:de=>x(de.target.value),className:"input pl-10"})]}),r?n.jsxs("div",{className:"text-center py-12",children:[n.jsx("div",{className:"w-12 h-12 border-4 border-aeria-navy border-t-transparent rounded-full animate-spin mx-auto mb-4"}),n.jsx("p",{className:"text-gray-500",children:"Loading clients..."})]}):se.length===0?n.jsxs("div",{className:"card text-center py-12",children:[n.jsx(Vl,{className:"w-12 h-12 mx-auto text-gray-300 mb-4"}),n.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-1",children:h?"No clients found":"No clients yet"}),n.jsx("p",{className:"text-gray-500 mb-4",children:h?"Try adjusting your search":"Add your first client to get started"}),!h&&n.jsxs("button",{onClick:()=>{R(null),o(!0)},className:"btn-primary",children:[n.jsx(vr,{className:"w-4 h-4 mr-2"}),"Add Client"]})]}):n.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:se.map(de=>n.jsx(Yoe,{client:de,onEdit:he,onDelete:X,menuOpen:F,setMenuOpen:$},de.id))}),!r&&t.length>0&&n.jsxs("div",{className:"flex items-center justify-between text-sm text-gray-500 pt-4 border-t border-gray-200",children:[n.jsxs("span",{children:["Showing ",se.length," of ",t.length," clients"]}),n.jsxs("span",{children:[t.filter(de=>de.logo).length," with logo"]})]}),n.jsx(Xoe,{isOpen:w,onClose:()=>{o(!1),R(null)},client:C,onSave:H})]})}function Qoe(){const{userProfile:t,user:e}=iu(),[r,c]=ue.useState("profile"),[h,x]=ue.useState({firstName:"",lastName:"",phone:"",certifications:""}),[w,o]=ue.useState(!1),[C,R]=ue.useState(!1),[F,$]=ue.useState({name:"Aeria Solutions Ltd.",operatorNumber:"930355",email:"ops@aeriasolutions.ca",phone:"",address:""}),[Y,H]=ue.useState(!1),[X,he]=ue.useState(!1),[se,de]=ue.useState({projectUpdates:!0,approvalRequests:!0,maintenanceReminders:!0,weeklySummary:!1}),[K,ge]=ue.useState(!1),[Ae,Te]=ue.useState(!1),[Ce,ne]=ue.useState({current:"",new:"",confirm:""}),[ae,q]=ue.useState(!1),[oe,ke]=ue.useState(""),[Ve,ie]=ue.useState(!1);ue.useEffect(()=>{t&&x({firstName:t.firstName||"",lastName:t.lastName||"",phone:t.phone||"",certifications:t.certifications||""})},[t]),ue.useEffect(()=>{ze()},[]);const ze=async()=>{try{const vt=qn(rn,"settings","company"),Ot=await Ap(vt);Ot.exists()&&$(Et=>({...Et,...Ot.data()}))}catch(vt){console.error("Error loading company settings:",vt)}};ue.useEffect(()=>{e&&ve()},[e]);const ve=async()=>{try{const vt=qn(rn,"userPreferences",e.uid),Ot=await Ap(vt);Ot.exists()&&Ot.data().notifications&&de(Et=>({...Et,...Ot.data().notifications}))}catch(vt){console.error("Error loading notification prefs:",vt)}},Le=async()=>{o(!0),R(!1);try{await Mj(t.id,h),R(!0),setTimeout(()=>R(!1),3e3)}catch(vt){console.error("Error saving profile:",vt),alert("Failed to save profile")}finally{o(!1)}},Ke=async()=>{H(!0),he(!1);try{const vt=qn(rn,"settings","company");await cI(vt,F,{merge:!0}),he(!0),setTimeout(()=>he(!1),3e3)}catch(vt){console.error("Error saving company settings:",vt),alert("Failed to save company settings")}finally{H(!1)}},Pe=async()=>{ge(!0),Te(!1);try{const vt=qn(rn,"userPreferences",e.uid);await cI(vt,{notifications:se},{merge:!0}),Te(!0),setTimeout(()=>Te(!1),3e3)}catch(vt){console.error("Error saving notification prefs:",vt),alert("Failed to save notification preferences")}finally{ge(!1)}},It=async()=>{if(ke(""),ie(!1),Ce.new!==Ce.confirm){ke("New passwords do not match");return}if(Ce.new.length<6){ke("Password must be at least 6 characters");return}q(!0);try{const vt=yf.credential(e.email,Ce.current);await mY(uy.currentUser,vt),await _Y(uy.currentUser,Ce.new),ie(!0),ne({current:"",new:"",confirm:""}),setTimeout(()=>ie(!1),3e3)}catch(vt){console.error("Error updating password:",vt),vt.code==="auth/wrong-password"?ke("Current password is incorrect"):ke(vt.message)}finally{q(!1)}},tt=[{id:"profile",label:"Profile",icon:fa,description:"Your personal information"},{id:"company",label:"Company",icon:zy,description:"Organization settings"},{id:"branding",label:"Branding",icon:A6,description:"PDF export branding"},{id:"notifications",label:"Notifications",icon:Wc,description:"Alert preferences"},{id:"security",label:"Security",icon:Ds,description:"Password & authentication"}],zt=({saving:vt,saved:Ot,onClick:Et,label:yi="Save Changes"})=>n.jsx("button",{onClick:Et,disabled:vt,className:"btn-primary inline-flex items-center gap-2",children:vt?n.jsxs(n.Fragment,{children:[n.jsx(Ro,{className:"w-4 h-4 animate-spin"}),"Saving..."]}):Ot?n.jsxs(n.Fragment,{children:[n.jsx(ru,{className:"w-4 h-4"}),"Saved!"]}):yi});return n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{children:[n.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Settings"}),n.jsx("p",{className:"text-gray-600 mt-1",children:"Manage your account and preferences"})]}),n.jsx("div",{className:"flex flex-wrap gap-2 border-b border-gray-200 pb-4",children:tt.map(vt=>{const Ot=vt.icon;return n.jsxs("button",{onClick:()=>c(vt.id),className:`flex items-center gap-2 px-4 py-2 rounded-lg transition-colors ${r===vt.id?"bg-aeria-navy text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[n.jsx(Ot,{className:"w-4 h-4"}),n.jsx("span",{className:"text-sm font-medium",children:vt.label})]},vt.id)})}),n.jsxs("div",{className:"grid gap-6",children:[r==="profile"&&n.jsxs("div",{className:"card",children:[n.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[n.jsx("div",{className:"p-2 bg-aeria-sky rounded-lg",children:n.jsx(fa,{className:"w-5 h-5 text-aeria-navy"})}),n.jsxs("div",{children:[n.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Profile"}),n.jsx("p",{className:"text-sm text-gray-500",children:"Your personal information"})]})]}),n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"First Name"}),n.jsx("input",{type:"text",className:"input",value:h.firstName,onChange:vt=>x({...h,firstName:vt.target.value}),placeholder:"First name"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Last Name"}),n.jsx("input",{type:"text",className:"input",value:h.lastName,onChange:vt=>x({...h,lastName:vt.target.value}),placeholder:"Last name"})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Email"}),n.jsx("input",{type:"email",className:"input bg-gray-50",value:(t==null?void 0:t.email)||"",disabled:!0}),n.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Contact administrator to change email"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Phone"}),n.jsx("input",{type:"tel",className:"input",value:h.phone,onChange:vt=>x({...h,phone:vt.target.value}),placeholder:"+1 (555) 123-4567"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Certifications"}),n.jsx("input",{type:"text",className:"input",value:h.certifications,onChange:vt=>x({...h,certifications:vt.target.value}),placeholder:"Advanced RPAS, etc."})]}),n.jsx("div",{className:"pt-4",children:n.jsx(zt,{saving:w,saved:C,onClick:Le})})]})]}),r==="company"&&n.jsxs("div",{className:"card",children:[n.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[n.jsx("div",{className:"p-2 bg-aeria-sky rounded-lg",children:n.jsx(zy,{className:"w-5 h-5 text-aeria-navy"})}),n.jsxs("div",{children:[n.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Company"}),n.jsx("p",{className:"text-sm text-gray-500",children:"Organization settings"})]})]}),n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Company Name"}),n.jsx("input",{type:"text",className:"input",value:F.name,onChange:vt=>$({...F,name:vt.target.value})})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Transport Canada Operator Number"}),n.jsx("input",{type:"text",className:"input",value:F.operatorNumber,onChange:vt=>$({...F,operatorNumber:vt.target.value})})]}),n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Primary Contact Email"}),n.jsx("input",{type:"email",className:"input",value:F.email,onChange:vt=>$({...F,email:vt.target.value})})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Primary Contact Phone"}),n.jsx("input",{type:"tel",className:"input",value:F.phone,onChange:vt=>$({...F,phone:vt.target.value}),placeholder:"+1 (555) 123-4567"})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Address"}),n.jsx("textarea",{className:"input min-h-[80px]",value:F.address,onChange:vt=>$({...F,address:vt.target.value}),placeholder:"Street Address, City, Province, Postal Code"})]}),n.jsx("div",{className:"pt-4",children:n.jsx(zt,{saving:Y,saved:X,onClick:Ke})})]})]}),r==="branding"&&n.jsx(Gae,{}),r==="notifications"&&n.jsxs("div",{className:"card",children:[n.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[n.jsx("div",{className:"p-2 bg-aeria-sky rounded-lg",children:n.jsx(Wc,{className:"w-5 h-5 text-aeria-navy"})}),n.jsxs("div",{children:[n.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Notifications"}),n.jsx("p",{className:"text-sm text-gray-500",children:"Email and alert preferences"})]})]}),n.jsxs("div",{className:"space-y-4",children:[n.jsxs("label",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer",children:[n.jsxs("div",{children:[n.jsx("p",{className:"font-medium text-gray-900",children:"Project Updates"}),n.jsx("p",{className:"text-sm text-gray-500",children:"Get notified when projects are updated"})]}),n.jsx("input",{type:"checkbox",checked:se.projectUpdates,onChange:vt=>de({...se,projectUpdates:vt.target.checked}),className:"w-5 h-5 text-aeria-navy rounded"})]}),n.jsxs("label",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer",children:[n.jsxs("div",{children:[n.jsx("p",{className:"font-medium text-gray-900",children:"Approval Requests"}),n.jsx("p",{className:"text-sm text-gray-500",children:"Get notified when approval is needed"})]}),n.jsx("input",{type:"checkbox",checked:se.approvalRequests,onChange:vt=>de({...se,approvalRequests:vt.target.checked}),className:"w-5 h-5 text-aeria-navy rounded"})]}),n.jsxs("label",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer",children:[n.jsxs("div",{children:[n.jsx("p",{className:"font-medium text-gray-900",children:"Maintenance Reminders"}),n.jsx("p",{className:"text-sm text-gray-500",children:"Get reminders for aircraft maintenance"})]}),n.jsx("input",{type:"checkbox",checked:se.maintenanceReminders,onChange:vt=>de({...se,maintenanceReminders:vt.target.checked}),className:"w-5 h-5 text-aeria-navy rounded"})]}),n.jsxs("label",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer",children:[n.jsxs("div",{children:[n.jsx("p",{className:"font-medium text-gray-900",children:"Weekly Summary"}),n.jsx("p",{className:"text-sm text-gray-500",children:"Receive weekly activity summary"})]}),n.jsx("input",{type:"checkbox",checked:se.weeklySummary,onChange:vt=>de({...se,weeklySummary:vt.target.checked}),className:"w-5 h-5 text-aeria-navy rounded"})]}),n.jsx("div",{className:"pt-4",children:n.jsx(zt,{saving:K,saved:Ae,onClick:Pe,label:"Save Preferences"})})]})]}),r==="security"&&n.jsxs("div",{className:"card",children:[n.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[n.jsx("div",{className:"p-2 bg-aeria-sky rounded-lg",children:n.jsx(Ds,{className:"w-5 h-5 text-aeria-navy"})}),n.jsxs("div",{children:[n.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Security"}),n.jsx("p",{className:"text-sm text-gray-500",children:"Password and authentication"})]})]}),n.jsxs("div",{className:"space-y-4",children:[oe&&n.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm",children:oe}),Ve&&n.jsx("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm",children:"Password updated successfully!"}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Current Password"}),n.jsx("input",{type:"password",className:"input",placeholder:"Enter current password",value:Ce.current,onChange:vt=>ne({...Ce,current:vt.target.value})})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"New Password"}),n.jsx("input",{type:"password",className:"input",placeholder:"Enter new password",value:Ce.new,onChange:vt=>ne({...Ce,new:vt.target.value})})]}),n.jsxs("div",{children:[n.jsx("label",{className:"label",children:"Confirm New Password"}),n.jsx("input",{type:"password",className:"input",placeholder:"Confirm new password",value:Ce.confirm,onChange:vt=>ne({...Ce,confirm:vt.target.value})})]}),n.jsx("div",{className:"pt-4",children:n.jsx("button",{onClick:It,disabled:ae||!Ce.current||!Ce.new||!Ce.confirm,className:"btn-primary inline-flex items-center gap-2",children:ae?n.jsxs(n.Fragment,{children:[n.jsx(Ro,{className:"w-4 h-4 animate-spin"}),"Updating..."]}):"Update Password"})}),n.jsxs("div",{className:"border-t border-gray-200 pt-4 mt-6",children:[n.jsx("h3",{className:"font-medium text-gray-900 mb-3",children:"Two-Factor Authentication"}),n.jsx("p",{className:"text-sm text-gray-500 mb-3",children:"Add an extra layer of security to your account"}),n.jsx("button",{className:"btn-secondary",children:"Enable 2FA"})]})]})]})]})]})}function Kw({title:t,value:e,subtitle:r,icon:c,color:h="bg-white",link:x}){const w=n.jsxs("div",{className:`card hover:shadow-md transition-shadow ${x?"cursor-pointer":""}`,children:[n.jsxs("div",{className:"flex items-start justify-between",children:[n.jsxs("div",{className:"flex-1",children:[n.jsx("p",{className:"text-sm font-medium text-gray-500",children:t}),n.jsx("p",{className:"text-2xl font-bold text-gray-900 mt-1",children:e}),r&&n.jsx("p",{className:"text-xs text-gray-500 mt-1",children:r})]}),c&&n.jsx("div",{className:`p-2 rounded-lg ${h}`,children:n.jsx(c,{className:"w-5 h-5"})})]}),x&&n.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-100 flex items-center text-sm text-aeria-blue",children:["View details ",n.jsx(ko,{className:"w-4 h-4 ml-1"})]})]});return x?n.jsx(dr,{to:x,children:w}):w}function Joe({days:t,lastIncident:e}){const r=h=>h===null?"from-gray-600 to-gray-700":h>=365?"from-green-600 to-green-700":h>=90?"from-green-500 to-green-600":h>=30?"from-yellow-500 to-yellow-600":h>=7?"from-orange-500 to-orange-600":"from-red-500 to-red-600",c=h=>h===null?"No recordable incidents on record":h>=365?"Outstanding safety record!":h>=90?"Excellent safety performance":h>=30?"Good progress - keep it up":h>=7?"Stay vigilant":"Focus on safety";return n.jsx("div",{className:`card bg-gradient-to-br ${r(t)} text-white`,children:n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{children:[n.jsx("p",{className:"text-white/80 text-sm font-medium",children:"Days Since Last Recordable Incident"}),n.jsx("p",{className:"text-6xl font-bold mt-2",children:t!==null?t:""}),n.jsx("p",{className:"text-white/80 text-sm mt-2",children:c(t)}),e&&n.jsxs("p",{className:"text-white/60 text-xs mt-1",children:["Last: ",e.title||e.incidentNumber]})]}),n.jsx("div",{className:"p-4 bg-white/20 rounded-2xl",children:n.jsx(Ds,{className:"w-16 h-16 text-white"})})]})})}function ele(){const[t,e]=ue.useState(!0),[r,c]=ue.useState(null),[h,x]=ue.useState(null),[w,o]=ue.useState(!1),[C,R]=ue.useState({daysSinceIncident:null,lastIncident:null,ytdIncidents:0,ytdNearMisses:0,openCapas:0,overdueCapas:0,capaOnTimeRate:100,pendingNotifications:0});ue.useEffect(()=>{F()},[]);const F=async()=>{var H;e(!0),c(null);try{const{getIncidents:X,getCapas:he}=await D0(async()=>{const{getIncidents:ie,getCapas:ze}=await Promise.resolve().then(()=>a5);return{getIncidents:ie,getCapas:ze}},void 0),[se,de]=await Promise.all([X({}).catch(()=>[]),he({}).catch(()=>[])]),K=new Date,ge=new Date(K.getFullYear(),0,1),Ae=se.filter(ie=>{var ve;return((ve=ie.dateOccurred)!=null&&ve.toDate?ie.dateOccurred.toDate():new Date(ie.dateOccurred))>=ge}),Te=Ae.filter(ie=>ie.type!=="near_miss"),Ce=Ae.filter(ie=>ie.type==="near_miss"),ne=Te.sort((ie,ze)=>{var Ke,Pe;const ve=(Ke=ie.dateOccurred)!=null&&Ke.toDate?ie.dateOccurred.toDate():new Date(ie.dateOccurred);return((Pe=ze.dateOccurred)!=null&&Pe.toDate?ze.dateOccurred.toDate():new Date(ze.dateOccurred))-ve});let ae=null,q=null;if(ne.length>0){q=ne[0];const ie=(H=q.dateOccurred)!=null&&H.toDate?q.dateOccurred.toDate():new Date(q.dateOccurred);ae=Math.floor((K-ie)/(1e3*60*60*24))}const oe=de.filter(ie=>!["closed","verified_effective"].includes(ie.status)),ke=oe.filter(ie=>{var ve;return ie.targetDate?((ve=ie.targetDate)!=null&&ve.toDate?ie.targetDate.toDate():new Date(ie.targetDate))<K:!1}),Ve=se.filter(ie=>{const ze=ie.regulatoryNotifications||{};return ze.tsbRequired&&!ze.tsbNotified||ze.tcRequired&&!ze.tcNotified||ze.worksafebcRequired&&!ze.worksafebcNotified});R({daysSinceIncident:ae,lastIncident:q,ytdIncidents:Te.length,ytdNearMisses:Ce.length,openCapas:oe.length,overdueCapas:ke.length,capaOnTimeRate:de.length>0?Math.round(de.filter(ie=>{var ze;return(ze=ie.metrics)==null?void 0:ze.onTime}).length/de.length*100):100,pendingNotifications:Ve.length}),x(new Date)}catch(X){console.error("Error loading safety dashboard:",X),c("Failed to load safety data. Please try again.")}finally{e(!1)}},$=async()=>{o(!0);try{const{getIncidents:H,getCapas:X}=await D0(async()=>{const{getIncidents:Ve,getCapas:ie}=await Promise.resolve().then(()=>a5);return{getIncidents:Ve,getCapas:ie}},void 0),{getProjects:he,getOperators:se,getAircraft:de,getClients:K}=await D0(async()=>{const{getProjects:Ve,getOperators:ie,getAircraft:ze,getClients:ve}=await Promise.resolve().then(()=>Are);return{getProjects:Ve,getOperators:ie,getAircraft:ze,getClients:ve}},void 0),{exportCORReport:ge}=await D0(async()=>{const{exportCORReport:Ve}=await import("./corReportGenerator-DNPWeDbz.js");return{exportCORReport:Ve}},[]),[Ae,Te,Ce,ne,ae,q]=await Promise.all([H({}).catch(()=>[]),X({}).catch(()=>[]),he().catch(()=>[]),se().catch(()=>[]),de().catch(()=>[]),K().catch(()=>[])]),oe=[];Ce.forEach(Ve=>{Ve.forms&&Array.isArray(Ve.forms)&&oe.push(...Ve.forms.map(ie=>({...ie,projectId:Ve.id})))}),await ge({incidents:Ae,capas:Te,forms:oe,operators:ne,projects:Ce,aircraft:ae,clients:q},{includeAppendices:!0})}catch(H){console.error("Error exporting COR report:",H),alert("Failed to generate COR Program Report. Please try again.")}finally{o(!1)}},Y=()=>h?h.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"";return t?n.jsxs("div",{className:"space-y-6",children:[n.jsx("div",{className:"flex items-center justify-between",children:n.jsxs("div",{children:[n.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Safety Dashboard"}),n.jsx("p",{className:"text-gray-600 mt-1",children:"Loading safety metrics..."})]})}),n.jsxs("div",{className:"card text-center py-16",children:[n.jsx("div",{className:"w-12 h-12 border-4 border-aeria-navy border-t-transparent rounded-full animate-spin mx-auto mb-4"}),n.jsx("p",{className:"text-gray-500",children:"Loading safety data..."})]})]}):r?n.jsxs("div",{className:"space-y-6",children:[n.jsx("div",{className:"flex items-center justify-between",children:n.jsxs("div",{children:[n.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Safety Dashboard"}),n.jsx("p",{className:"text-gray-600 mt-1",children:"Safety performance overview"})]})}),n.jsxs("div",{className:"card border-red-200 bg-red-50 text-center py-8",children:[n.jsx(ir,{className:"w-12 h-12 mx-auto mb-4 text-red-400"}),n.jsx("h3",{className:"text-lg font-medium text-red-900 mb-1",children:"Failed to Load"}),n.jsx("p",{className:"text-red-700 mb-4",children:r}),n.jsxs("button",{onClick:F,className:"btn-primary",children:[n.jsx(eu,{className:"w-4 h-4 mr-2"}),"Try Again"]})]})]}):n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[n.jsxs("div",{children:[n.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Safety Dashboard"}),n.jsxs("p",{className:"text-gray-600 mt-1",children:["Safety performance overview",h&&n.jsxs("span",{className:"text-gray-400 ml-2",children:[" Updated ",Y()]})]})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("button",{onClick:$,disabled:w,className:"btn-secondary inline-flex items-center gap-2",title:"Export COR Program Report",children:w?n.jsxs(n.Fragment,{children:[n.jsx(Ro,{className:"w-4 h-4 animate-spin"}),"Generating..."]}):n.jsxs(n.Fragment,{children:[n.jsx(bie,{className:"w-4 h-4"}),"COR Report"]})}),n.jsxs("button",{onClick:F,className:"btn-secondary inline-flex items-center gap-2",children:[n.jsx(eu,{className:"w-4 h-4"}),"Refresh"]}),n.jsxs(dr,{to:"/incidents/new",className:"btn-primary inline-flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Report Incident"]})]})]}),n.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-4",children:n.jsxs("div",{className:"flex items-start gap-3",children:[n.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:n.jsx(rs,{className:"w-5 h-5 text-blue-600"})}),n.jsxs("div",{className:"flex-1",children:[n.jsx("h3",{className:"font-semibold text-blue-900",children:"COR Audit Documentation"}),n.jsx("p",{className:"text-sm text-blue-700 mt-1",children:"Generate a comprehensive Health & Safety Program Report for COR audit preparation. Includes all incidents, CAPAs, training records, inspections, and KPIs."})]}),n.jsx("button",{onClick:$,disabled:w,className:"btn-primary text-sm whitespace-nowrap",children:w?"Generating...":"Export Report"})]})}),n.jsx(Joe,{days:C.daysSinceIncident,lastIncident:C.lastIncident}),n.jsxs("div",{className:"grid sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[n.jsx(Kw,{title:"YTD Incidents",value:C.ytdIncidents,subtitle:"Recordable incidents",icon:ir,color:"bg-red-100 text-red-600",link:"/incidents"}),n.jsx(Kw,{title:"Near Misses",value:C.ytdNearMisses,subtitle:"YTD reported",icon:Cs,color:"bg-yellow-100 text-yellow-600",link:"/incidents?type=near_miss"}),n.jsx(Kw,{title:"Open CAPAs",value:C.openCapas,subtitle:C.overdueCapas>0?`${C.overdueCapas} overdue`:"None overdue",icon:go,color:C.overdueCapas>0?"bg-red-100 text-red-600":"bg-blue-100 text-blue-600",link:"/capas"}),n.jsx(Kw,{title:"CAPA On-Time Rate",value:`${C.capaOnTimeRate}%`,subtitle:"Completion rate",icon:qr,color:"bg-green-100 text-green-600",link:"/capas"})]}),(C.overdueCapas>0||C.pendingNotifications>0)&&n.jsxs("div",{className:"card border-orange-200 bg-orange-50",children:[n.jsxs("h2",{className:"text-lg font-semibold text-orange-900 mb-4 flex items-center gap-2",children:[n.jsx(Wc,{className:"w-5 h-5"}),"Action Items Requiring Attention"]}),n.jsxs("div",{className:"space-y-2",children:[C.pendingNotifications>0&&n.jsxs(dr,{to:"/incidents?filter=pending_notification",className:"flex items-center justify-between p-3 bg-white rounded-lg hover:bg-orange-100 transition-colors",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("div",{className:"p-2 bg-red-100 rounded-lg",children:n.jsx(Wc,{className:"w-4 h-4 text-red-600"})}),n.jsxs("div",{children:[n.jsx("p",{className:"font-medium text-gray-900",children:"Pending Regulatory Notifications"}),n.jsxs("p",{className:"text-sm text-gray-500",children:[C.pendingNotifications," incident(s) require notification"]})]})]}),n.jsx(ko,{className:"w-5 h-5 text-gray-400"})]}),C.overdueCapas>0&&n.jsxs(dr,{to:"/capas?filter=overdue",className:"flex items-center justify-between p-3 bg-white rounded-lg hover:bg-orange-100 transition-colors",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("div",{className:"p-2 bg-red-100 rounded-lg",children:n.jsx(Wu,{className:"w-4 h-4 text-red-600"})}),n.jsxs("div",{children:[n.jsx("p",{className:"font-medium text-gray-900",children:"Overdue CAPAs"}),n.jsxs("p",{className:"text-sm text-gray-500",children:[C.overdueCapas," CAPA(s) past target date"]})]})]}),n.jsx(ko,{className:"w-5 h-5 text-gray-400"})]})]})]}),n.jsxs("div",{className:"grid sm:grid-cols-2 lg:grid-cols-3 gap-4",children:[n.jsx(dr,{to:"/incidents",className:"card hover:shadow-md transition-shadow",children:n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("div",{className:"p-2 bg-red-100 rounded-lg",children:n.jsx(ir,{className:"w-5 h-5 text-red-600"})}),n.jsxs("div",{children:[n.jsx("h3",{className:"font-semibold text-gray-900",children:"Incident Register"}),n.jsx("p",{className:"text-sm text-gray-500",children:"View and manage incidents"})]})]})}),n.jsx(dr,{to:"/capas",className:"card hover:shadow-md transition-shadow",children:n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:n.jsx(Ul,{className:"w-5 h-5 text-blue-600"})}),n.jsxs("div",{children:[n.jsx("h3",{className:"font-semibold text-gray-900",children:"CAPA Register"}),n.jsx("p",{className:"text-sm text-gray-500",children:"Corrective & preventive actions"})]})]})}),n.jsx(dr,{to:"/incidents/new",className:"card hover:shadow-md transition-shadow",children:n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("div",{className:"p-2 bg-green-100 rounded-lg",children:n.jsx(rs,{className:"w-5 h-5 text-green-600"})}),n.jsxs("div",{children:[n.jsx("h3",{className:"font-semibold text-gray-900",children:"Report Incident"}),n.jsx("p",{className:"text-sm text-gray-500",children:"Submit a new incident report"})]})]})})]}),n.jsxs("div",{className:"card bg-gray-50",children:[n.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Emergency Contacts"}),n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4 text-sm",children:[n.jsxs("div",{children:[n.jsx("p",{className:"font-medium text-gray-700",children:"TSB (Aircraft Occurrence)"}),n.jsx("p",{className:"text-gray-900",children:"1-800-387-3557"})]}),n.jsxs("div",{children:[n.jsx("p",{className:"font-medium text-gray-700",children:"Aeria Operations"}),n.jsx("p",{className:"text-gray-900",children:"604-849-2345"})]})]})]})]})}const $h=Mp(rn,"incidents"),Mu=Mp(rn,"capas");Mp(rn,"safetyMetrics");const qT={near_miss:{label:"Near Miss",severity:"near_miss",color:"bg-yellow-100 text-yellow-800"},first_aid:{label:"First Aid",severity:"minor",color:"bg-orange-100 text-orange-800"},medical_aid:{label:"Medical Aid",severity:"moderate",color:"bg-orange-200 text-orange-900"},lost_time:{label:"Lost Time Injury",severity:"serious",color:"bg-red-100 text-red-800"},property_damage:{label:"Property Damage",severity:"varies",color:"bg-purple-100 text-purple-800"},environmental:{label:"Environmental",severity:"varies",color:"bg-green-100 text-green-800"},regulatory:{label:"Regulatory Violation",severity:"varies",color:"bg-blue-100 text-blue-800"},aircraft:{label:"Aircraft Incident",severity:"varies",color:"bg-sky-100 text-sky-800"}},$T={fly_away:{label:"Fly-Away",notifyTC:!0,notifyTSB:!1},loss_of_control:{label:"Loss of Control",notifyTC:!0,notifyTSB:!1},collision:{label:"Collision",notifyTC:!0,notifyTSB:!0},boundary_violation:{label:"Boundary/Airspace Violation",notifyTC:!0,notifyTSB:!1},airspace_incursion:{label:"Airspace Incursion",notifyTC:!0,notifyTSB:!1},equipment_failure:{label:"Equipment Failure",notifyTC:!0,notifyTSB:!1},battery_issue:{label:"Battery Issue",notifyTC:!1,notifyTSB:!1},c2_link_loss:{label:"C2 Link Loss",notifyTC:!0,notifyTSB:!1},gps_failure:{label:"GPS Failure",notifyTC:!1,notifyTSB:!1},near_miss_aircraft:{label:"Near Miss with Aircraft",notifyTC:!0,notifyTSB:!0}},Vy={near_miss:{label:"Near Miss",value:0,color:"bg-yellow-500",recordable:!1},minor:{label:"Minor (First Aid)",value:1,color:"bg-orange-400",recordable:!1},moderate:{label:"Moderate (Medical Aid)",value:2,color:"bg-orange-600",recordable:!0},serious:{label:"Serious (Lost Time)",value:3,color:"bg-red-500",recordable:!0},critical:{label:"Critical",value:4,color:"bg-red-700",recordable:!0},fatal:{label:"Fatal",value:5,color:"bg-black",recordable:!0}},Mv={reported:{label:"Reported",color:"bg-blue-100 text-blue-800",order:1},under_investigation:{label:"Under Investigation",color:"bg-yellow-100 text-yellow-800",order:2},root_cause_identified:{label:"Root Cause Identified",color:"bg-orange-100 text-orange-800",order:3},capa_in_progress:{label:"CAPA In Progress",color:"bg-purple-100 text-purple-800",order:4},pending_verification:{label:"Pending Verification",color:"bg-indigo-100 text-indigo-800",order:5},closed:{label:"Closed",color:"bg-green-100 text-green-800",order:6}},ES={open:{label:"Open",color:"bg-blue-100 text-blue-800",order:1},in_progress:{label:"In Progress",color:"bg-yellow-100 text-yellow-800",order:2},pending_verification:{label:"Pending Verification",color:"bg-purple-100 text-purple-800",order:3},verified_effective:{label:"Verified Effective",color:"bg-green-100 text-green-800",order:4},verified_ineffective:{label:"Verified Ineffective",color:"bg-red-100 text-red-800",order:5},closed:{label:"Closed",color:"bg-gray-100 text-gray-800",order:6}},Uy={corrective:{label:"Corrective Action",description:"Fix the immediate problem"},preventive:{label:"Preventive Action",description:"Prevent recurrence"},improvement:{label:"Continuous Improvement",description:"Enhance existing controls"}},_p={critical:{label:"Critical",color:"bg-red-600 text-white",daysToResolve:1},high:{label:"High",color:"bg-orange-500 text-white",daysToResolve:7},medium:{label:"Medium",color:"bg-yellow-500 text-black",daysToResolve:14},low:{label:"Low",color:"bg-green-500 text-white",daysToResolve:30}},Ad={TSB_IMMEDIATE:{label:"TSB IMMEDIATE NOTIFICATION",phone:"1-800-387-3557",altPhone:"1-819-994-3741",conditions:["fatal","serious_injury","rpas_over_25kg","collision_manned_aircraft"],timeframe:"Immediately"},TRANSPORT_CANADA:{label:"Transport Canada (CADORS)",conditions:["fly_away","loss_of_control","boundary_violation","airspace_incursion","near_miss_aircraft"],timeframe:"72 hours"},WORKSAFEBC:{label:"WorkSafeBC",conditions:["fatal","serious_injury","hospitalization"],timeframe:"Immediately"},AERIA_INTERNAL:{label:"Aeria Internal (Accountable Executive)",name:"Dustin Wales",phone:"604-849-2345",conditions:["all"],timeframe:"Same day"}};async function $U(){const t=new Date().getFullYear(),e=`INC-${t}-`,r=is($h,ha("incidentNumber",">=",e),ha("incidentNumber","<",`INC-${t+1}-`),pa("incidentNumber","desc"),Qy(1)),c=await Kd(r);let h=1;if(!c.empty){const x=c.docs[0].data();h=parseInt(x.incidentNumber.split("-")[2],10)+1}return`${e}${String(h).padStart(4,"0")}`}async function GU(){const t=new Date().getFullYear(),e=`CAPA-${t}-`,r=is(Mu,ha("capaNumber",">=",e),ha("capaNumber","<",`CAPA-${t+1}-`),pa("capaNumber","desc"),Qy(1)),c=await Kd(r);let h=1;if(!c.empty){const x=c.docs[0].data();h=parseInt(x.capaNumber.split("-")[2],10)+1}return`${e}${String(h).padStart(4,"0")}`}const AI=()=>({incidentNumber:"",type:"near_miss",rpasType:null,severity:"near_miss",dateOccurred:null,timeOccurred:"",dateReported:null,reportedBy:"",reportedByEmail:"",location:"",gpsCoordinates:null,projectId:null,projectName:"",aircraftId:null,aircraftName:"",title:"",description:"",immediateActions:"",witnesses:[],photos:[],involvedPersons:[],equipmentDamage:[],regulatoryNotifications:{tsbRequired:!1,tsbNotified:!1,tsbNotifiedDate:null,tsbReference:"",tcRequired:!1,tcNotified:!1,tcNotifiedDate:null,tcReference:"",worksafebcRequired:!1,worksafebcNotified:!1,worksafebcNotifiedDate:null,worksafebcReference:"",aeriaNotified:!1,aeriaNotifiedDate:null},investigation:{assigned:!1,assignedTo:"",assignedDate:null,startedDate:null,completedDate:null,immediateCauses:{substandardActs:[],substandardConditions:[]},rootCauses:{personalFactors:[],jobSystemFactors:[]},fiveWhys:[],fishbone:{people:[],process:[],equipment:[],environment:[],management:[],measurement:[]},findings:"",recommendations:[]},timeline:[],linkedCapas:[],status:"reported",metrics:{reportingDelay:0,investigationDuration:0,totalResolutionTime:0},createdAt:null,updatedAt:null,closedAt:null,closedBy:""});async function HU(t={}){let e=is($h,pa("createdAt","desc"));return t.status&&(e=is($h,ha("status","==",t.status),pa("createdAt","desc"))),t.type&&(e=is($h,ha("type","==",t.type),pa("createdAt","desc"))),t.severity&&(e=is($h,ha("severity","==",t.severity),pa("createdAt","desc"))),t.projectId&&(e=is($h,ha("projectId","==",t.projectId),pa("createdAt","desc"))),t.dateFrom&&t.dateTo&&(e=is($h,ha("dateOccurred",">=",sa.fromDate(new Date(t.dateFrom))),ha("dateOccurred","<=",sa.fromDate(new Date(t.dateTo))),pa("dateOccurred","desc"))),t.limit&&(e=is(e,Qy(t.limit))),(await Kd(e)).docs.map(c=>({id:c.id,...c.data()}))}async function nb(t){const e=qn(rn,"incidents",t),r=await Ap(e);if(!r.exists())throw new Error("Incident not found");return{id:r.id,...r.data()}}async function WU(t){const e=await $U(),r=eR(t),c={...AI(),...t,incidentNumber:e,regulatoryNotifications:{...AI().regulatoryNotifications,...r},dateReported:Pn(),timeline:[{date:new Date().toISOString(),action:"Incident Reported",by:t.reportedBy||"System",notes:`Incident ${e} created`}],createdAt:Pn(),updatedAt:Pn()};return{id:(await ex($h,c)).id,...c,incidentNumber:e}}async function IS(t,e){var h;const r=qn(rn,"incidents",t);let c=e.timeline||[];e.status&&e._previousStatus&&e.status!==e._previousStatus&&(c=[...c,{date:new Date().toISOString(),action:`Status changed to ${((h=Mv[e.status])==null?void 0:h.label)||e.status}`,by:e._changedBy||"System",notes:e._statusChangeNotes||""}],delete e._previousStatus,delete e._changedBy,delete e._statusChangeNotes),await Gl(r,{...e,timeline:c,updatedAt:Pn()})}async function ZU(t,e,r=""){var o;const c=await nb(t),h=[...c.timeline||[],{date:new Date().toISOString(),action:"Incident Closed",by:e,notes:r}],x=(o=c.createdAt)!=null&&o.toDate?c.createdAt.toDate():new Date(c.createdAt),w=Math.ceil((new Date-x)/(1e3*60*60*24));await Gl(qn(rn,"incidents",t),{status:"closed",closedAt:Pn(),closedBy:e,timeline:h,"metrics.totalResolutionTime":w,updatedAt:Pn()})}async function Kj(t){const e=qn(rn,"incidents",t);await Jy(e)}const XU=()=>({capaNumber:"",sourceType:"incident",sourceId:null,sourceReference:"",type:"corrective",priority:"medium",category:"",title:"",problemStatement:"",rootCause:"",assignedTo:"",assignedToEmail:"",assignedBy:"",assignedDate:null,targetDate:null,revisedTargetDate:null,extensionReason:"",completedDate:null,action:{description:"",methodology:"",resources:[],estimatedCost:0,actualCost:0},implementation:{status:"not_started",actionsTaken:"",evidenceProvided:[],resourcesUsed:[],completionNotes:""},verification:{required:!0,method:"",criteria:"",verifiedBy:"",verifiedDate:null,effective:null,evidence:"",findings:"",recurrenceCheck:{required:!0,checkDate:null,checkedBy:"",recurred:null,notes:""}},status:"open",relatedIncidentId:null,relatedCapas:[],comments:[],statusHistory:[],metrics:{daysOpen:0,daysOverdue:0,onTime:null,effectivenessScore:null},createdAt:null,updatedAt:null,closedAt:null});async function Qj(t={}){let e=is(Mu,pa("createdAt","desc"));if(t.status&&(e=is(Mu,ha("status","==",t.status),pa("createdAt","desc"))),t.assignedTo&&(e=is(Mu,ha("assignedTo","==",t.assignedTo),pa("createdAt","desc"))),t.priority&&(e=is(Mu,ha("priority","==",t.priority),pa("createdAt","desc"))),t.type&&(e=is(Mu,ha("type","==",t.type),pa("createdAt","desc"))),t.sourceType&&(e=is(Mu,ha("sourceType","==",t.sourceType),pa("createdAt","desc"))),t.incidentId&&(e=is(Mu,ha("relatedIncidentId","==",t.incidentId),pa("createdAt","desc"))),t.overdue){const c=sa.now();e=is(Mu,ha("targetDate","<",c),ha("status","in",["open","in_progress"]),pa("targetDate","asc"))}return t.limit&&(e=is(e,Qy(t.limit))),(await Kd(e)).docs.map(c=>({id:c.id,...c.data()}))}async function Fp(t){const e=qn(rn,"capas",t),r=await Ap(e);if(!r.exists())throw new Error("CAPA not found");return{id:r.id,...r.data()}}async function YU(t){const e=await GU(),r={...XU(),...t,capaNumber:e,assignedDate:t.assignedTo?Pn():null,statusHistory:[{date:new Date().toISOString(),from:null,to:"open",by:t.assignedBy||"System",reason:"CAPA created"}],createdAt:Pn(),updatedAt:Pn()},c=await ex(Mu,r);if(t.relatedIncidentId){const h=await nb(t.relatedIncidentId);await IS(t.relatedIncidentId,{linkedCapas:[...h.linkedCapas||[],c.id]})}return{id:c.id,...r,capaNumber:e}}async function KU(t,e){const r=qn(rn,"capas",t),c=await Fp(t);let h=c.statusHistory||[];e.status&&e.status!==c.status&&(h=[...h,{date:new Date().toISOString(),from:c.status,to:e.status,by:e._changedBy||"System",reason:e._statusChangeReason||""}],delete e._changedBy,delete e._statusChangeReason),await Gl(r,{...e,statusHistory:h,updatedAt:Pn()})}async function QU(t,e){var h;const r=await Fp(t),c=(h=r.targetDate)!=null&&h.toDate?new Date<=r.targetDate.toDate():!0;await Gl(qn(rn,"capas",t),{status:"pending_verification",completedDate:Pn(),"implementation.status":"complete","implementation.actionsTaken":e.actionsTaken,"implementation.evidenceProvided":e.evidence||[],"implementation.completionNotes":e.notes||"","metrics.onTime":c,statusHistory:[...r.statusHistory||[],{date:new Date().toISOString(),from:r.status,to:"pending_verification",by:e.completedBy||"System",reason:"Implementation completed"}],updatedAt:Pn()})}async function JU(t,e){const r=await Fp(t),c=e.effective?"verified_effective":"verified_ineffective";return await Gl(qn(rn,"capas",t),{status:c,"verification.verifiedBy":e.verifiedBy,"verification.verifiedDate":Pn(),"verification.effective":e.effective,"verification.evidence":e.evidence||"","verification.findings":e.findings||"","metrics.effectivenessScore":e.effective?100:0,statusHistory:[...r.statusHistory||[],{date:new Date().toISOString(),from:r.status,to:c,by:e.verifiedBy,reason:e.effective?"Verified effective":"Verified ineffective"}],updatedAt:Pn()}),{effective:e.effective,status:c}}async function eq(t,e){const r=await Fp(t);return await Gl(qn(rn,"capas",t),{"verification.recurrenceCheck.checkDate":Pn(),"verification.recurrenceCheck.checkedBy":e.checkedBy,"verification.recurrenceCheck.recurred":e.recurred,"verification.recurrenceCheck.notes":e.notes||"",status:e.recurred?"verified_ineffective":"closed",closedAt:e.recurred?null:Pn(),statusHistory:[...r.statusHistory||[],{date:new Date().toISOString(),from:r.status,to:e.recurred?"verified_ineffective":"closed",by:e.checkedBy,reason:e.recurred?"Issue recurred - CAPA ineffective":"No recurrence - CAPA closed"}],updatedAt:Pn()}),{recurred:e.recurred}}async function tq(t,e,r=""){const c=await Fp(t);await Gl(qn(rn,"capas",t),{status:"closed",closedAt:Pn(),statusHistory:[...c.statusHistory||[],{date:new Date().toISOString(),from:c.status,to:"closed",by:e,reason:r||"CAPA closed"}],updatedAt:Pn()})}async function Jj(t){const e=qn(rn,"capas",t);await Jy(e)}async function iq(t,e){const r=await Fp(t),c={date:new Date().toISOString(),by:e.by,text:e.text};return await Gl(qn(rn,"capas",t),{comments:[...r.comments||[],c],updatedAt:Pn()}),c}function eR(t){var r,c;const e={tsbRequired:!1,tcRequired:!1,worksafebcRequired:!1,aeriaNotified:!1};return(t.severity==="fatal"||t.severity==="serious"&&((r=t.involvedPersons)!=null&&r.some(h=>h.hospitalized))||t.rpasType==="collision"||t.rpasType==="near_miss_aircraft")&&(e.tsbRequired=!0),(t.rpasType==="fly_away"||t.rpasType==="loss_of_control"||t.rpasType==="boundary_violation"||t.rpasType==="airspace_incursion"||t.rpasType==="near_miss_aircraft"||t.type==="aircraft")&&(e.tcRequired=!0),(t.severity==="fatal"||t.severity==="serious"||(c=t.involvedPersons)!=null&&c.some(h=>h.hospitalized))&&(e.worksafebcRequired=!0),e.aeriaNotified=!1,e}async function rq(t,e,r=""){const h={tsb:{notified:"regulatoryNotifications.tsbNotified",date:"regulatoryNotifications.tsbNotifiedDate",ref:"regulatoryNotifications.tsbReference"},tc:{notified:"regulatoryNotifications.tcNotified",date:"regulatoryNotifications.tcNotifiedDate",ref:"regulatoryNotifications.tcReference"},worksafebc:{notified:"regulatoryNotifications.worksafebcNotified",date:"regulatoryNotifications.worksafebcNotifiedDate",ref:"regulatoryNotifications.worksafebcReference"},aeria:{notified:"regulatoryNotifications.aeriaNotified",date:"regulatoryNotifications.aeriaNotifiedDate"}}[e];if(!h)throw new Error("Invalid notification type");const x={[h.notified]:!0,[h.date]:Pn(),updatedAt:Pn()};h.ref&&r&&(x[h.ref]=r),await Gl(qn(rn,"incidents",t),x)}const a5=Object.freeze(Object.defineProperty({__proto__:null,CAPA_STATUS:ES,CAPA_TYPES:Uy,INCIDENT_STATUS:Mv,INCIDENT_TYPES:qT,PRIORITY_LEVELS:_p,REGULATORY_TRIGGERS:Ad,RPAS_INCIDENT_TYPES:$T,SEVERITY_LEVELS:Vy,addCapaComment:iq,closeCapa:tq,closeIncident:ZU,completeCapa:QU,createCapa:YU,createIncident:WU,deleteCapa:Jj,deleteIncident:Kj,determineRegulatoryNotifications:eR,generateCapaNumber:GU,generateIncidentNumber:$U,getCapa:Fp,getCapas:Qj,getDefaultCapaStructure:XU,getDefaultIncidentStructure:AI,getIncident:nb,getIncidents:HU,markNotificationComplete:rq,recordRecurrenceCheck:eq,updateCapa:KU,updateIncident:IS,verifyCapa:JU},Symbol.toStringTag,{value:"Module"}));function tle(){const[t,e]=Vv(),[r,c]=ue.useState([]),[h,x]=ue.useState(!0),[w,o]=ue.useState(""),[C,R]=ue.useState(t.get("status")||"all"),[F,$]=ue.useState(t.get("type")||"all"),[Y,H]=ue.useState(t.get("severity")||"all"),[X,he]=ue.useState(null);ue.useEffect(()=>{se()},[]),ue.useEffect(()=>{const q=new URLSearchParams;C!=="all"&&q.set("status",C),F!=="all"&&q.set("type",F),Y!=="all"&&q.set("severity",Y),e(q)},[C,F,Y]);const se=async()=>{x(!0);try{const q=await HU();c(q)}catch(q){console.error("Error loading incidents:",q)}finally{x(!1)}},de=async(q,oe)=>{if(confirm(`Are you sure you want to delete incident "${oe}"? This cannot be undone.`)){try{await Kj(q),c(ke=>ke.filter(Ve=>Ve.id!==q))}catch(ke){console.error("Error deleting incident:",ke),alert("Failed to delete incident")}he(null)}},K=r.filter(q=>{var ze,ve,Le,Ke,Pe;const oe=((ze=q.incidentNumber)==null?void 0:ze.toLowerCase().includes(w.toLowerCase()))||((ve=q.title)==null?void 0:ve.toLowerCase().includes(w.toLowerCase()))||((Le=q.description)==null?void 0:Le.toLowerCase().includes(w.toLowerCase()))||((Ke=q.location)==null?void 0:Ke.toLowerCase().includes(w.toLowerCase()))||((Pe=q.projectName)==null?void 0:Pe.toLowerCase().includes(w.toLowerCase())),ke=C==="all"||q.status===C,Ve=F==="all"||q.type===F,ie=Y==="all"||q.severity===Y;return oe&&ke&&Ve&&ie}),ge=q=>{if(!q)return"Unknown";try{const oe=q.toDate?q.toDate():new Date(q);return bc(oe,"MMM d, yyyy")}catch{return"Invalid date"}},Ae=q=>{const oe=Vy[q];return oe?n.jsx("span",{className:`px-2 py-0.5 text-xs font-medium rounded-full ${q==="fatal"?"bg-black text-white":q==="critical"?"bg-red-700 text-white":q==="serious"?"bg-red-500 text-white":q==="moderate"?"bg-orange-500 text-white":q==="minor"?"bg-orange-300 text-orange-900":"bg-yellow-200 text-yellow-800"}`,children:oe.label}):null},Te=q=>{const oe=Mv[q];return oe?n.jsx("span",{className:`px-2 py-0.5 text-xs font-medium rounded-full ${oe.color}`,children:oe.label}):null},Ce=(q,oe)=>{if(oe)return n.jsx(Zn,{className:"w-5 h-5 text-sky-600"});switch(q){case"near_miss":return n.jsx(Cs,{className:"w-5 h-5 text-yellow-500"});case"property_damage":return n.jsx(Vl,{className:"w-5 h-5 text-purple-500"});case"environmental":return n.jsx(Wn,{className:"w-5 h-5 text-green-500"});default:return n.jsx(ir,{className:"w-5 h-5 text-orange-500"})}},ne=q=>{const oe=q.regulatoryNotifications||{};return oe.tsbRequired&&!oe.tsbNotified||oe.tcRequired&&!oe.tcNotified||oe.worksafebcRequired&&!oe.worksafebcNotified||!oe.aeriaNotified},ae={total:K.length,open:K.filter(q=>!["closed"].includes(q.status)).length,nearMiss:K.filter(q=>q.type==="near_miss"||q.severity==="near_miss").length,needsNotification:K.filter(ne).length};return n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[n.jsxs("div",{children:[n.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Incidents"}),n.jsx("p",{className:"text-gray-600 mt-1",children:"Track and manage safety incidents"})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsxs(dr,{to:"/safety",className:"btn-secondary inline-flex items-center gap-2",children:[n.jsx(ga,{className:"w-4 h-4"}),"Dashboard"]}),n.jsxs(dr,{to:"/incidents/new",className:"btn-primary inline-flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Report Incident"]})]})]}),n.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4",children:[n.jsxs("div",{className:"card py-3",children:[n.jsx("p",{className:"text-2xl font-bold text-gray-900",children:ae.total}),n.jsx("p",{className:"text-sm text-gray-500",children:"Total"})]}),n.jsxs("div",{className:"card py-3",children:[n.jsx("p",{className:"text-2xl font-bold text-blue-600",children:ae.open}),n.jsx("p",{className:"text-sm text-gray-500",children:"Open"})]}),n.jsxs("div",{className:"card py-3",children:[n.jsx("p",{className:"text-2xl font-bold text-yellow-600",children:ae.nearMiss}),n.jsx("p",{className:"text-sm text-gray-500",children:"Near Misses"})]}),n.jsxs("div",{className:"card py-3",children:[n.jsx("p",{className:`text-2xl font-bold ${ae.needsNotification>0?"text-red-600":"text-green-600"}`,children:ae.needsNotification}),n.jsx("p",{className:"text-sm text-gray-500",children:"Pending Notifications"})]})]}),n.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[n.jsxs("div",{className:"relative flex-1",children:[n.jsx(nu,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),n.jsx("input",{type:"text",placeholder:"Search incidents...",value:w,onChange:q=>o(q.target.value),className:"input pl-9"})]}),n.jsxs("select",{value:C,onChange:q=>R(q.target.value),className:"input w-full sm:w-44",children:[n.jsx("option",{value:"all",children:"All Status"}),Object.entries(Mv).map(([q,oe])=>n.jsx("option",{value:q,children:oe.label},q))]}),n.jsxs("select",{value:F,onChange:q=>$(q.target.value),className:"input w-full sm:w-44",children:[n.jsx("option",{value:"all",children:"All Types"}),Object.entries(qT).map(([q,oe])=>n.jsx("option",{value:q,children:oe.label},q))]}),n.jsxs("select",{value:Y,onChange:q=>H(q.target.value),className:"input w-full sm:w-44",children:[n.jsx("option",{value:"all",children:"All Severity"}),Object.entries(Vy).map(([q,oe])=>n.jsx("option",{value:q,children:oe.label},q))]})]}),h?n.jsxs("div",{className:"card text-center py-12",children:[n.jsx("div",{className:"w-8 h-8 border-4 border-aeria-navy border-t-transparent rounded-full animate-spin mx-auto mb-4"}),n.jsx("p",{className:"text-gray-500",children:"Loading incidents..."})]}):K.length===0?n.jsxs("div",{className:"card text-center py-12",children:[n.jsx(ir,{className:"w-12 h-12 mx-auto mb-4 text-gray-300"}),r.length===0?n.jsxs(n.Fragment,{children:[n.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-1",children:"No incidents recorded"}),n.jsx("p",{className:"text-gray-500 mb-4",children:"That's good news! Report any incidents or near misses here."}),n.jsxs(dr,{to:"/incidents/new",className:"btn-primary inline-flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Report Incident"]})]}):n.jsxs(n.Fragment,{children:[n.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-1",children:"No matching incidents"}),n.jsx("p",{className:"text-gray-500",children:"Try adjusting your search or filters."})]})]}):n.jsx("div",{className:"space-y-3",children:K.map(q=>{var oe,ke;return n.jsx("div",{className:"card hover:shadow-md transition-shadow group",children:n.jsxs("div",{className:"flex items-start gap-4",children:[n.jsx("div",{className:`w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0 ${q.severity==="fatal"||q.severity==="critical"?"bg-red-100":q.severity==="near_miss"?"bg-yellow-100":"bg-orange-100"}`,children:Ce(q.type,q.rpasType)}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsxs("div",{className:"flex items-center gap-2 mb-1 flex-wrap",children:[n.jsx(dr,{to:`/incidents/${q.id}`,className:"font-semibold text-gray-900 hover:text-aeria-blue",children:q.incidentNumber}),Ae(q.severity),Te(q.status),ne(q)&&n.jsxs("span",{className:"px-2 py-0.5 text-xs font-medium rounded-full bg-red-100 text-red-700 flex items-center gap-1",children:[n.jsx(Wc,{className:"w-3 h-3"}),"Notify"]})]}),n.jsx("p",{className:"text-gray-700 mb-2 line-clamp-1",children:q.title||q.description||"No description"}),n.jsxs("div",{className:"flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-gray-500",children:[n.jsxs("span",{className:"inline-flex items-center gap-1",children:[n.jsx(il,{className:"w-3.5 h-3.5"}),ge(q.dateOccurred)]}),q.location&&n.jsxs("span",{className:"inline-flex items-center gap-1",children:[n.jsx(Wn,{className:"w-3.5 h-3.5"}),q.location]}),q.projectName&&n.jsxs("span",{className:"inline-flex items-center gap-1",children:[n.jsx(Vl,{className:"w-3.5 h-3.5"}),q.projectName]}),q.rpasType&&n.jsxs("span",{className:"inline-flex items-center gap-1 text-sky-600",children:[n.jsx(Zn,{className:"w-3.5 h-3.5"}),((oe=$T[q.rpasType])==null?void 0:oe.label)||q.rpasType]}),q.reportedBy&&n.jsxs("span",{className:"inline-flex items-center gap-1",children:[n.jsx(fa,{className:"w-3.5 h-3.5"}),q.reportedBy]})]}),((ke=q.linkedCapas)==null?void 0:ke.length)>0&&n.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[n.jsx(rs,{className:"w-3.5 h-3.5 text-purple-500"}),n.jsxs("span",{className:"text-xs text-purple-600",children:[q.linkedCapas.length," CAPA",q.linkedCapas.length>1?"s":""," linked"]})]})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(dr,{to:`/incidents/${q.id}`,className:"p-2 text-gray-400 hover:text-aeria-blue rounded-lg hover:bg-gray-100 opacity-0 group-hover:opacity-100 transition-opacity",title:"View details",children:n.jsx(ko,{className:"w-5 h-5"})}),n.jsxs("div",{className:"relative",children:[n.jsx("button",{onClick:()=>he(X===q.id?null:q.id),className:"p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100",children:n.jsx(Qd,{className:"w-4 h-4"})}),X===q.id&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>he(null)}),n.jsxs("div",{className:"absolute right-0 mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-20",children:[n.jsxs(dr,{to:`/incidents/${q.id}`,className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2",children:[n.jsx(ga,{className:"w-4 h-4"}),"View Details"]}),n.jsxs(dr,{to:`/incidents/${q.id}/edit`,className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2",children:[n.jsx(rs,{className:"w-4 h-4"}),"Edit"]}),q.status!=="closed"&&n.jsxs(dr,{to:`/capas/new?incidentId=${q.id}`,className:"w-full px-4 py-2 text-left text-sm text-purple-700 hover:bg-purple-50 flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Create CAPA"]}),n.jsxs("button",{onClick:()=>de(q.id,q.incidentNumber),className:"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2",children:[n.jsx(Ln,{className:"w-4 h-4"}),"Delete"]})]})]})]})]})]})},q.id)})}),K.length>0&&n.jsxs("div",{className:"flex items-center justify-between text-sm text-gray-500",children:[n.jsxs("span",{children:["Showing ",K.length," incident",K.length!==1?"s":""]}),n.jsxs("button",{onClick:se,className:"inline-flex items-center gap-1 text-aeria-blue hover:text-aeria-navy",children:[n.jsx(eu,{className:"w-4 h-4"}),"Refresh"]})]})]})}function Dm({title:t,description:e,children:r,icon:c}){return n.jsxs("div",{className:"card",children:[n.jsxs("div",{className:"flex items-start gap-3 mb-4",children:[c&&n.jsx("div",{className:"p-2 bg-gray-100 rounded-lg",children:n.jsx(c,{className:"w-5 h-5 text-gray-600"})}),n.jsxs("div",{children:[n.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:t}),e&&n.jsx("p",{className:"text-sm text-gray-500 mt-0.5",children:e})]})]}),r]})}function o5({notifications:t}){const e=[];if(t.tsbRequired&&e.push({type:"TSB",label:Ad.TSB_IMMEDIATE.label,phone:Ad.TSB_IMMEDIATE.phone,timeframe:Ad.TSB_IMMEDIATE.timeframe,critical:!0}),t.tcRequired&&e.push({type:"TC",label:Ad.TRANSPORT_CANADA.label,timeframe:Ad.TRANSPORT_CANADA.timeframe,critical:!1}),t.worksafebcRequired&&e.push({type:"WSBC",label:Ad.WORKSAFEBC.label,timeframe:Ad.WORKSAFEBC.timeframe,critical:!0}),e.length===0)return null;const r=e.some(c=>c.critical);return n.jsx("div",{className:`p-4 rounded-lg border-2 ${r?"bg-red-50 border-red-300":"bg-yellow-50 border-yellow-300"}`,children:n.jsxs("div",{className:"flex items-start gap-3",children:[n.jsx(Wc,{className:`w-6 h-6 flex-shrink-0 ${r?"text-red-600":"text-yellow-600"}`}),n.jsxs("div",{className:"flex-1",children:[n.jsx("h3",{className:`font-bold ${r?"text-red-900":"text-yellow-900"}`,children:"Regulatory Notifications Required"}),n.jsx("p",{className:`text-sm mt-1 ${r?"text-red-700":"text-yellow-700"}`,children:"Based on the incident details, the following notifications are required:"}),n.jsx("ul",{className:"mt-3 space-y-2",children:e.map(c=>n.jsxs("li",{className:"flex items-start gap-2",children:[n.jsx("span",{className:`px-2 py-0.5 text-xs font-bold rounded ${c.critical?"bg-red-200 text-red-800":"bg-yellow-200 text-yellow-800"}`,children:c.type}),n.jsxs("div",{className:"text-sm",children:[n.jsx("span",{className:c.critical?"text-red-800":"text-yellow-800",children:c.label}),c.phone&&n.jsx("a",{href:`tel:${c.phone}`,className:"ml-2 font-bold underline",children:c.phone}),n.jsxs("span",{className:"text-gray-500 ml-2",children:["(",c.timeframe,")"]})]})]},c.type))})]})]})})}function l5(){const t=tu(),[e]=Vv(),{userProfile:r}=iu(),[c,h]=ue.useState(!1),[x,w]=ue.useState([]),[o,C]=ue.useState([]),[R,F]=ue.useState(!0),[$,Y]=ue.useState({type:"near_miss",rpasType:"",severity:"near_miss",title:"",dateOccurred:new Date().toISOString().split("T")[0],timeOccurred:"",location:"",gpsCoordinates:null,projectId:e.get("projectId")||"",projectName:"",aircraftId:"",aircraftName:"",description:"",immediateActions:"",involvedPersons:[],equipmentDamage:[],witnesses:[],reportedBy:r!=null&&r.firstName&&(r!=null&&r.lastName)?`${r.firstName} ${r.lastName}`:"",reportedByEmail:(r==null?void 0:r.email)||""}),[H,X]=ue.useState({tsbRequired:!1,tcRequired:!1,worksafebcRequired:!1});ue.useEffect(()=>{he()},[]),ue.useEffect(()=>{const ze=eR($);X(ze)},[$.type,$.rpasType,$.severity,$.involvedPersons]);const he=async()=>{F(!0);try{const[ze,ve]=await Promise.all([ET(),IT()]);if(w(ze),C(ve),e.get("projectId")){const Le=ze.find(Ke=>Ke.id===e.get("projectId"));Le&&Y(Ke=>({...Ke,projectName:Le.name}))}}catch(ze){console.error("Error loading reference data:",ze)}finally{F(!1)}},se=(ze,ve)=>{Y(Le=>({...Le,[ze]:ve}))},de=ze=>{const ve=x.find(Le=>Le.id===ze);Y(Le=>({...Le,projectId:ze,projectName:(ve==null?void 0:ve.name)||""}))},K=ze=>{const ve=o.find(Le=>Le.id===ze);Y(Le=>({...Le,aircraftId:ze,aircraftName:ve?`${ve.nickname} (${ve.make} ${ve.model})`:""}))},ge=()=>{Y(ze=>({...ze,involvedPersons:[...ze.involvedPersons,{id:Date.now(),name:"",role:"",injuryType:"none",injuryDescription:"",treatmentReceived:"",hospitalized:!1,daysLost:0}]}))},Ae=(ze,ve,Le)=>{Y(Ke=>({...Ke,involvedPersons:Ke.involvedPersons.map(Pe=>Pe.id===ze?{...Pe,[ve]:Le}:Pe)}))},Te=ze=>{Y(ve=>({...ve,involvedPersons:ve.involvedPersons.filter(Le=>Le.id!==ze)}))},Ce=()=>{Y(ze=>({...ze,equipmentDamage:[...ze.equipmentDamage,{id:Date.now(),item:"",damageDescription:"",estimatedCost:0,repairable:!0}]}))},ne=(ze,ve,Le)=>{Y(Ke=>({...Ke,equipmentDamage:Ke.equipmentDamage.map(Pe=>Pe.id===ze?{...Pe,[ve]:Le}:Pe)}))},ae=ze=>{Y(ve=>({...ve,equipmentDamage:ve.equipmentDamage.filter(Le=>Le.id!==ze)}))},q=()=>{Y(ze=>({...ze,witnesses:[...ze.witnesses,{id:Date.now(),name:"",contact:"",statement:""}]}))},oe=(ze,ve,Le)=>{Y(Ke=>({...Ke,witnesses:Ke.witnesses.map(Pe=>Pe.id===ze?{...Pe,[ve]:Le}:Pe)}))},ke=ze=>{Y(ve=>({...ve,witnesses:ve.witnesses.filter(Le=>Le.id!==ze)}))},Ve=async ze=>{if(ze.preventDefault(),!$.title.trim()){alert("Please enter an incident title");return}if(!$.description.trim()){alert("Please enter an incident description");return}h(!0);try{const ve=await WU({...$,dateOccurred:new Date($.dateOccurred),involvedPersons:$.involvedPersons.map(({id:Le,...Ke})=>Ke),equipmentDamage:$.equipmentDamage.map(({id:Le,...Ke})=>Ke),witnesses:$.witnesses.map(({id:Le,...Ke})=>Ke)});t(`/incidents/${ve.id}`,{state:{message:"Incident reported successfully"}})}catch(ve){console.error("Error creating incident:",ve),alert("Failed to report incident. Please try again.")}finally{h(!1)}},ie=$.type==="aircraft"||!!$.rpasType;return n.jsxs("div",{className:"space-y-6 max-w-4xl mx-auto",children:[n.jsxs("div",{className:"flex items-center gap-4",children:[n.jsx("button",{onClick:()=>t(-1),className:"p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100",children:n.jsx(mc,{className:"w-5 h-5"})}),n.jsxs("div",{children:[n.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Report Incident"}),n.jsx("p",{className:"text-gray-600 mt-1",children:"Document a safety incident or near miss"})]})]}),(H.tsbRequired||H.tcRequired||H.worksafebcRequired)&&n.jsx(o5,{notifications:H}),n.jsxs("form",{onSubmit:Ve,className:"space-y-6",children:[n.jsx(Dm,{title:"Classification",description:"Categorize the incident type and severity",icon:ir,children:n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Incident Type *"}),n.jsx("select",{value:$.type,onChange:ze=>se("type",ze.target.value),className:"input",required:!0,children:Object.entries(qT).map(([ze,ve])=>n.jsx("option",{value:ze,children:ve.label},ze))})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Severity *"}),n.jsx("select",{value:$.severity,onChange:ze=>se("severity",ze.target.value),className:"input",required:!0,children:Object.entries(Vy).map(([ze,ve])=>n.jsx("option",{value:ze,children:ve.label},ze))})]}),($.type==="aircraft"||ie)&&n.jsxs("div",{className:"sm:col-span-2",children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"RPAS Incident Type"}),n.jsxs("select",{value:$.rpasType,onChange:ze=>se("rpasType",ze.target.value),className:"input",children:[n.jsx("option",{value:"",children:"Select RPAS incident type..."}),Object.entries($T).map(([ze,ve])=>n.jsxs("option",{value:ze,children:[ve.label,ve.notifyTC&&" (TC)",ve.notifyTSB&&" (TSB)"]},ze))]}),n.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"TC = Transport Canada notification, TSB = Transportation Safety Board notification"})]})]})}),n.jsx(Dm,{title:"Event Details",description:"When and where did the incident occur?",icon:il,children:n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Incident Title *"}),n.jsx("input",{type:"text",value:$.title,onChange:ze=>se("title",ze.target.value),className:"input",placeholder:"Brief description of the incident",required:!0})]}),n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date Occurred *"}),n.jsx("input",{type:"date",value:$.dateOccurred,onChange:ze=>se("dateOccurred",ze.target.value),className:"input",required:!0})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Time Occurred"}),n.jsx("input",{type:"time",value:$.timeOccurred,onChange:ze=>se("timeOccurred",ze.target.value),className:"input"})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Location"}),n.jsx("input",{type:"text",value:$.location,onChange:ze=>se("location",ze.target.value),className:"input",placeholder:"Site name, address, or GPS coordinates"})]}),n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Related Project"}),n.jsxs("select",{value:$.projectId,onChange:ze=>de(ze.target.value),className:"input",children:[n.jsx("option",{value:"",children:"No project linked"}),x.map(ze=>n.jsxs("option",{value:ze.id,children:[ze.name," ",ze.projectCode&&`(${ze.projectCode})`]},ze.id))]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Aircraft Involved"}),n.jsxs("select",{value:$.aircraftId,onChange:ze=>K(ze.target.value),className:"input",children:[n.jsx("option",{value:"",children:"No aircraft involved"}),o.map(ze=>n.jsxs("option",{value:ze.id,children:[ze.nickname," (",ze.make," ",ze.model,")"]},ze.id))]})]})]})]})}),n.jsx(Dm,{title:"Description",description:"Provide details about what happened",icon:Ns,children:n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description of Incident *"}),n.jsx("textarea",{value:$.description,onChange:ze=>se("description",ze.target.value),className:"input",rows:5,placeholder:"Describe what happened, including events leading up to and during the incident...",required:!0})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Immediate Actions Taken"}),n.jsx("textarea",{value:$.immediateActions,onChange:ze=>se("immediateActions",ze.target.value),className:"input",rows:3,placeholder:"What actions were taken immediately after the incident?"})]})]})}),n.jsx(Dm,{title:"People Involved",description:"Document any injuries or personnel involved",icon:fa,children:$.involvedPersons.length===0?n.jsxs("div",{className:"text-center py-6 bg-gray-50 rounded-lg",children:[n.jsx(fa,{className:"w-8 h-8 mx-auto mb-2 text-gray-300"}),n.jsx("p",{className:"text-gray-500 mb-3",children:"No people documented yet"}),n.jsxs("button",{type:"button",onClick:ge,className:"btn-secondary inline-flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Add Person"]})]}):n.jsxs("div",{className:"space-y-4",children:[$.involvedPersons.map((ze,ve)=>n.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg relative",children:[n.jsx("button",{type:"button",onClick:()=>Te(ze.id),className:"absolute top-2 right-2 p-1 text-gray-400 hover:text-red-500",children:n.jsx(Ln,{className:"w-4 h-4"})}),n.jsxs("h4",{className:"font-medium text-gray-700 mb-3",children:["Person ",ve+1]}),n.jsxs("div",{className:"grid sm:grid-cols-2 gap-3",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Name"}),n.jsx("input",{type:"text",value:ze.name,onChange:Le=>Ae(ze.id,"name",Le.target.value),className:"input",placeholder:"Full name"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Role"}),n.jsx("input",{type:"text",value:ze.role,onChange:Le=>Ae(ze.id,"role",Le.target.value),className:"input",placeholder:"e.g., Pilot, Ground Crew"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Injury Type"}),n.jsxs("select",{value:ze.injuryType,onChange:Le=>Ae(ze.id,"injuryType",Le.target.value),className:"input",children:[n.jsx("option",{value:"none",children:"No Injury"}),n.jsx("option",{value:"first_aid",children:"First Aid"}),n.jsx("option",{value:"medical_aid",children:"Medical Aid"}),n.jsx("option",{value:"lost_time",children:"Lost Time"}),n.jsx("option",{value:"hospitalization",children:"Hospitalization"}),n.jsx("option",{value:"fatality",children:"Fatality"})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Days Lost"}),n.jsx("input",{type:"number",value:ze.daysLost,onChange:Le=>Ae(ze.id,"daysLost",parseInt(Le.target.value)||0),className:"input",min:"0"})]}),n.jsxs("div",{className:"sm:col-span-2",children:[n.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Injury Description"}),n.jsx("input",{type:"text",value:ze.injuryDescription,onChange:Le=>Ae(ze.id,"injuryDescription",Le.target.value),className:"input",placeholder:"Describe the injury"})]}),n.jsxs("div",{className:"sm:col-span-2",children:[n.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Treatment Received"}),n.jsx("input",{type:"text",value:ze.treatmentReceived,onChange:Le=>Ae(ze.id,"treatmentReceived",Le.target.value),className:"input",placeholder:"What treatment was provided?"})]}),n.jsx("div",{className:"sm:col-span-2",children:n.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[n.jsx("input",{type:"checkbox",checked:ze.hospitalized,onChange:Le=>Ae(ze.id,"hospitalized",Le.target.checked),className:"rounded border-gray-300"}),n.jsx("span",{className:"text-sm text-gray-700",children:"Hospitalized"})]})})]})]},ze.id)),n.jsxs("button",{type:"button",onClick:ge,className:"btn-secondary inline-flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Add Another Person"]})]})}),n.jsx(Dm,{title:"Equipment Damage",description:"Document any equipment or property damage",icon:Zn,children:$.equipmentDamage.length===0?n.jsxs("div",{className:"text-center py-6 bg-gray-50 rounded-lg",children:[n.jsx(Zn,{className:"w-8 h-8 mx-auto mb-2 text-gray-300"}),n.jsx("p",{className:"text-gray-500 mb-3",children:"No equipment damage documented"}),n.jsxs("button",{type:"button",onClick:Ce,className:"btn-secondary inline-flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Add Equipment"]})]}):n.jsxs("div",{className:"space-y-4",children:[$.equipmentDamage.map((ze,ve)=>n.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg relative",children:[n.jsx("button",{type:"button",onClick:()=>ae(ze.id),className:"absolute top-2 right-2 p-1 text-gray-400 hover:text-red-500",children:n.jsx(Ln,{className:"w-4 h-4"})}),n.jsxs("h4",{className:"font-medium text-gray-700 mb-3",children:["Item ",ve+1]}),n.jsxs("div",{className:"grid sm:grid-cols-2 gap-3",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Equipment/Item"}),n.jsx("input",{type:"text",value:ze.item,onChange:Le=>ne(ze.id,"item",Le.target.value),className:"input",placeholder:"e.g., DJI Mavic 3"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Estimated Cost ($)"}),n.jsx("input",{type:"number",value:ze.estimatedCost,onChange:Le=>ne(ze.id,"estimatedCost",parseFloat(Le.target.value)||0),className:"input",min:"0",step:"0.01"})]}),n.jsxs("div",{className:"sm:col-span-2",children:[n.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Damage Description"}),n.jsx("input",{type:"text",value:ze.damageDescription,onChange:Le=>ne(ze.id,"damageDescription",Le.target.value),className:"input",placeholder:"Describe the damage"})]}),n.jsx("div",{className:"sm:col-span-2",children:n.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[n.jsx("input",{type:"checkbox",checked:ze.repairable,onChange:Le=>ne(ze.id,"repairable",Le.target.checked),className:"rounded border-gray-300"}),n.jsx("span",{className:"text-sm text-gray-700",children:"Repairable"})]})})]})]},ze.id)),n.jsxs("button",{type:"button",onClick:Ce,className:"btn-secondary inline-flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Add Another Item"]})]})}),n.jsx(Dm,{title:"Witnesses",description:"Document any witnesses to the incident",icon:fa,children:$.witnesses.length===0?n.jsxs("div",{className:"text-center py-6 bg-gray-50 rounded-lg",children:[n.jsx(fa,{className:"w-8 h-8 mx-auto mb-2 text-gray-300"}),n.jsx("p",{className:"text-gray-500 mb-3",children:"No witnesses documented"}),n.jsxs("button",{type:"button",onClick:q,className:"btn-secondary inline-flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Add Witness"]})]}):n.jsxs("div",{className:"space-y-4",children:[$.witnesses.map((ze,ve)=>n.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg relative",children:[n.jsx("button",{type:"button",onClick:()=>ke(ze.id),className:"absolute top-2 right-2 p-1 text-gray-400 hover:text-red-500",children:n.jsx(Ln,{className:"w-4 h-4"})}),n.jsxs("h4",{className:"font-medium text-gray-700 mb-3",children:["Witness ",ve+1]}),n.jsxs("div",{className:"grid sm:grid-cols-2 gap-3",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Name"}),n.jsx("input",{type:"text",value:ze.name,onChange:Le=>oe(ze.id,"name",Le.target.value),className:"input",placeholder:"Full name"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Contact"}),n.jsx("input",{type:"text",value:ze.contact,onChange:Le=>oe(ze.id,"contact",Le.target.value),className:"input",placeholder:"Phone or email"})]}),n.jsxs("div",{className:"sm:col-span-2",children:[n.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Statement"}),n.jsx("textarea",{value:ze.statement,onChange:Le=>oe(ze.id,"statement",Le.target.value),className:"input",rows:2,placeholder:"Witness statement..."})]})]})]},ze.id)),n.jsxs("button",{type:"button",onClick:q,className:"btn-secondary inline-flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Add Another Witness"]})]})}),n.jsx(Dm,{title:"Reporter Information",description:"Who is reporting this incident?",icon:fa,children:n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reported By *"}),n.jsx("input",{type:"text",value:$.reportedBy,onChange:ze=>se("reportedBy",ze.target.value),className:"input",placeholder:"Your name",required:!0})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),n.jsx("input",{type:"email",value:$.reportedByEmail,onChange:ze=>se("reportedByEmail",ze.target.value),className:"input",placeholder:"your.email@example.com"})]})]})}),(H.tsbRequired||H.tcRequired||H.worksafebcRequired)&&n.jsx(o5,{notifications:H}),n.jsxs("div",{className:"flex items-center justify-between pt-4 border-t border-gray-200",children:[n.jsx("button",{type:"button",onClick:()=>t(-1),className:"btn-secondary",disabled:c,children:"Cancel"}),n.jsx("button",{type:"submit",className:"btn-primary inline-flex items-center gap-2",disabled:c,children:c?n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Saving..."]}):n.jsxs(n.Fragment,{children:[n.jsx(tb,{className:"w-4 h-4"}),"Report Incident"]})})]})]})]})}function Wg({title:t,icon:e,children:r,defaultOpen:c=!0,badge:h}){const[x,w]=ue.useState(c);return n.jsxs("div",{className:"card",children:[n.jsxs("button",{onClick:()=>w(!x),className:"w-full flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[e&&n.jsx(e,{className:"w-5 h-5 text-gray-400"}),n.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:t}),h&&n.jsx("span",{className:"px-2 py-0.5 text-xs font-medium rounded-full bg-purple-100 text-purple-700",children:h})]}),x?n.jsx($n,{className:"w-5 h-5 text-gray-400"}):n.jsx(fn,{className:"w-5 h-5 text-gray-400"})]}),x&&n.jsx("div",{className:"mt-4 pt-4 border-t border-gray-100",children:r})]})}function ku({label:t,value:e,icon:r}){return e?n.jsxs("div",{className:"flex items-start gap-3 py-2",children:[r&&n.jsx(r,{className:"w-4 h-4 text-gray-400 mt-0.5 flex-shrink-0"}),n.jsxs("div",{children:[n.jsx("p",{className:"text-xs text-gray-500",children:t}),n.jsx("p",{className:"text-sm text-gray-900",children:e})]})]}):null}function c5({status:t}){const e=Mv[t];return e?n.jsx("span",{className:`px-3 py-1 text-sm font-medium rounded-full ${e.color}`,children:e.label}):null}function ile({severity:t}){const e=Vy[t];if(!e)return null;const r=t==="fatal"?"bg-black text-white":t==="critical"?"bg-red-700 text-white":t==="serious"?"bg-red-500 text-white":t==="moderate"?"bg-orange-500 text-white":t==="minor"?"bg-orange-300 text-orange-900":"bg-yellow-200 text-yellow-800";return n.jsx("span",{className:`px-3 py-1 text-sm font-medium rounded-full ${r}`,children:e.label})}function BC({type:t,required:e,notified:r,notifiedDate:c,reference:h,onMarkComplete:x,incidentId:w}){const o=Ad[t];if(!o||!e)return null;const[C,R]=ue.useState(!1),[F,$]=ue.useState(h||""),Y=async()=>{R(!0);try{await x(t.toLowerCase().replace("_immediate",""),F)}finally{R(!1)}};return n.jsx("div",{className:`p-4 rounded-lg border-2 ${r?"bg-green-50 border-green-200":"bg-red-50 border-red-300"}`,children:n.jsxs("div",{className:"flex items-start justify-between",children:[n.jsxs("div",{children:[n.jsxs("div",{className:"flex items-center gap-2",children:[r?n.jsx(qr,{className:"w-5 h-5 text-green-600"}):n.jsx(Wc,{className:"w-5 h-5 text-red-600"}),n.jsx("h4",{className:`font-medium ${r?"text-green-900":"text-red-900"}`,children:o.label})]}),o.phone&&n.jsxs("a",{href:`tel:${o.phone}`,className:`flex items-center gap-1 mt-1 text-sm ${r?"text-green-700":"text-red-700 font-bold"}`,children:[n.jsx(Hd,{className:"w-3 h-3"}),o.phone]}),n.jsxs("p",{className:`text-xs mt-1 ${r?"text-green-600":"text-red-600"}`,children:["Timeframe: ",o.timeframe]}),r&&c&&n.jsxs("p",{className:"text-xs text-green-600 mt-1",children:["Notified: ",bc(c.toDate?c.toDate():new Date(c),"MMM d, yyyy h:mm a")]}),r&&h&&n.jsxs("p",{className:"text-xs text-green-600 mt-1",children:["Reference: ",h]})]}),!r&&n.jsxs("div",{className:"flex flex-col gap-2",children:[n.jsx("input",{type:"text",value:F,onChange:H=>$(H.target.value),placeholder:"Reference #",className:"input text-sm py-1 px-2 w-32"}),n.jsx("button",{onClick:Y,disabled:C,className:"btn-primary text-xs py-1 px-2",children:C?"Saving...":"Mark Complete"})]})]})})}function rle(){var ie,ze,ve,Le,Ke,Pe,It,tt,zt,vt,Ot,Et,yi,mi;const{id:t}=NP(),e=tu(),{userProfile:r}=iu(),c=r?`${r.firstName||""} ${r.lastName||""}`.trim()||r.email:"Unknown User",[h,x]=ue.useState(null),[w,o]=ue.useState([]),[C,R]=ue.useState(!0),[F,$]=ue.useState(null),[Y,H]=ue.useState(!1),[X,he]=ue.useState(!1),[se,de]=ue.useState({assignedTo:"",substandardActs:[],substandardConditions:[],personalFactors:[],jobSystemFactors:[],fiveWhys:[{why:1,answer:""}],findings:"",recommendations:""});ue.useEffect(()=>{K()},[t]);const K=async()=>{var ht,hi,ni,ui,Fi,Ii,Bi;R(!0),$(null);try{const Ki=await nb(t);if(x(Ki),((ht=Ki.linkedCapas)==null?void 0:ht.length)>0){const $r=await Qj({incidentId:t});o($r)}Ki.investigation&&de({assignedTo:Ki.investigation.assignedTo||"",substandardActs:((hi=Ki.investigation.immediateCauses)==null?void 0:hi.substandardActs)||[],substandardConditions:((ni=Ki.investigation.immediateCauses)==null?void 0:ni.substandardConditions)||[],personalFactors:((ui=Ki.investigation.rootCauses)==null?void 0:ui.personalFactors)||[],jobSystemFactors:((Fi=Ki.investigation.rootCauses)==null?void 0:Fi.jobSystemFactors)||[],fiveWhys:((Ii=Ki.investigation.fiveWhys)==null?void 0:Ii.length)>0?Ki.investigation.fiveWhys:[{why:1,answer:""}],findings:Ki.investigation.findings||"",recommendations:((Bi=Ki.investigation.recommendations)==null?void 0:Bi.join(`
`))||""})}catch(Ki){console.error("Error loading incident:",Ki),$("Failed to load incident")}finally{R(!1)}},ge=async ht=>{H(!0);try{await IS(t,{status:ht,_previousStatus:h.status,_changedBy:c,_statusChangeNotes:""}),await K()}catch(hi){console.error("Error updating status:",hi),alert("Failed to update status")}finally{H(!1)}},Ae=async(ht,hi)=>{try{await rq(t,ht,hi),await K()}catch(ni){console.error("Error marking notification complete:",ni),alert("Failed to update notification status")}},Te=async()=>{var ht;H(!0);try{await IS(t,{investigation:{...h.investigation,assigned:!!se.assignedTo,assignedTo:se.assignedTo,assignedDate:((ht=h.investigation)==null?void 0:ht.assignedDate)||new Date().toISOString(),immediateCauses:{substandardActs:se.substandardActs,substandardConditions:se.substandardConditions},rootCauses:{personalFactors:se.personalFactors,jobSystemFactors:se.jobSystemFactors},fiveWhys:se.fiveWhys.filter(hi=>hi.answer),findings:se.findings,recommendations:se.recommendations.split(`
`).filter(hi=>hi.trim())},status:h.status==="reported"?"under_investigation":h.status,_previousStatus:h.status,_changedBy:c}),await K(),he(!1)}catch(hi){console.error("Error saving investigation:",hi),alert("Failed to save investigation")}finally{H(!1)}},Ce=async()=>{if(confirm("Are you sure you want to close this incident?")){H(!0);try{await ZU(t,c,"Incident closed"),await K()}catch(ht){console.error("Error closing incident:",ht),alert("Failed to close incident")}finally{H(!1)}}},ne=async()=>{if(confirm(`Delete incident ${h.incidentNumber}? This cannot be undone.`))try{await Kj(t),e("/incidents")}catch(ht){console.error("Error deleting incident:",ht),alert("Failed to delete incident")}},ae=ht=>{if(!ht)return"Unknown";try{const hi=ht.toDate?ht.toDate():new Date(ht);return bc(hi,"MMM d, yyyy")}catch{return"Invalid date"}},q=ht=>{if(!ht)return"Unknown";try{const hi=ht.toDate?ht.toDate():new Date(ht);return bc(hi,"MMM d, yyyy h:mm a")}catch{return"Invalid date"}};if(C)return n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"flex items-center gap-4",children:[n.jsx("button",{onClick:()=>e(-1),className:"p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100",children:n.jsx(mc,{className:"w-5 h-5"})}),n.jsx("div",{className:"h-8 w-48 bg-gray-200 rounded animate-pulse"})]}),n.jsxs("div",{className:"card text-center py-16",children:[n.jsx("div",{className:"w-12 h-12 border-4 border-aeria-navy border-t-transparent rounded-full animate-spin mx-auto mb-4"}),n.jsx("p",{className:"text-gray-500",children:"Loading incident..."})]})]});if(F||!h)return n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"flex items-center gap-4",children:[n.jsx("button",{onClick:()=>e(-1),className:"p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100",children:n.jsx(mc,{className:"w-5 h-5"})}),n.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Incident Not Found"})]}),n.jsxs("div",{className:"card border-red-200 bg-red-50 text-center py-8",children:[n.jsx(ir,{className:"w-12 h-12 mx-auto mb-4 text-red-400"}),n.jsx("h3",{className:"text-lg font-medium text-red-900 mb-1",children:F||"Incident not found"}),n.jsx(dr,{to:"/incidents",className:"btn-primary mt-4",children:"Back to Incidents"})]})]});const oe=h.regulatoryNotifications||{},ke=oe.tsbRequired||oe.tcRequired||oe.worksafebcRequired,Ve=oe.tsbRequired&&!oe.tsbNotified||oe.tcRequired&&!oe.tcNotified||oe.worksafebcRequired&&!oe.worksafebcNotified;return n.jsxs("div",{className:"space-y-6 max-w-5xl mx-auto",children:[n.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4",children:[n.jsxs("div",{className:"flex items-start gap-4",children:[n.jsx("button",{onClick:()=>e(-1),className:"p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100",children:n.jsx(mc,{className:"w-5 h-5"})}),n.jsxs("div",{children:[n.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[n.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:h.incidentNumber}),n.jsx(ile,{severity:h.severity}),n.jsx(c5,{status:h.status})]}),n.jsx("p",{className:"text-gray-600 mt-1",children:h.title})]})]}),n.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[h.status!=="closed"&&n.jsxs(n.Fragment,{children:[n.jsxs(dr,{to:`/capas/new?incidentId=${t}&sourceReference=${h.incidentNumber}`,className:"btn-secondary inline-flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Create CAPA"]}),n.jsxs(dr,{to:`/incidents/${t}/edit`,className:"btn-secondary inline-flex items-center gap-2",children:[n.jsx(uf,{className:"w-4 h-4"}),"Edit"]})]}),n.jsx("button",{onClick:ne,className:"p-2 text-gray-400 hover:text-red-500 rounded-lg hover:bg-red-50",title:"Delete incident",children:n.jsx(Ln,{className:"w-5 h-5"})})]})]}),Ve&&n.jsx("div",{className:"p-4 rounded-lg border-2 bg-red-50 border-red-300",children:n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx(Wc,{className:"w-6 h-6 text-red-600"}),n.jsxs("div",{children:[n.jsx("h3",{className:"font-bold text-red-900",children:"Action Required: Regulatory Notifications Pending"}),n.jsx("p",{className:"text-sm text-red-700",children:"Complete the required notifications below before proceeding."})]})]})}),h.status!=="closed"&&n.jsx("div",{className:"card bg-gray-50",children:n.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-4",children:[n.jsxs("div",{children:[n.jsx("p",{className:"text-sm text-gray-500",children:"Current Status"}),n.jsx(c5,{status:h.status})]}),n.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[h.status==="reported"&&n.jsx("button",{onClick:()=>ge("under_investigation"),disabled:Y,className:"btn-primary text-sm",children:"Start Investigation"}),h.status==="under_investigation"&&n.jsx("button",{onClick:()=>ge("root_cause_identified"),disabled:Y,className:"btn-primary text-sm",children:"Root Cause Identified"}),h.status==="root_cause_identified"&&n.jsx("button",{onClick:()=>ge("capa_in_progress"),disabled:Y,className:"btn-primary text-sm",children:"CAPA In Progress"}),h.status==="capa_in_progress"&&n.jsx("button",{onClick:()=>ge("pending_verification"),disabled:Y,className:"btn-primary text-sm",children:"Pending Verification"}),h.status==="pending_verification"&&n.jsxs("button",{onClick:Ce,disabled:Y,className:"btn-primary text-sm bg-green-600 hover:bg-green-700",children:[n.jsx(qr,{className:"w-4 h-4 mr-1"}),"Close Incident"]})]})]})}),n.jsxs("div",{className:"grid lg:grid-cols-3 gap-6",children:[n.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[n.jsxs(Wg,{title:"Incident Details",icon:ir,defaultOpen:!0,children:[n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[n.jsx(ku,{label:"Type",value:(ie=qT[h.type])==null?void 0:ie.label,icon:Cs}),n.jsx(ku,{label:"Severity",value:(ze=Vy[h.severity])==null?void 0:ze.label,icon:ir}),n.jsx(ku,{label:"Date Occurred",value:ae(h.dateOccurred),icon:il}),n.jsx(ku,{label:"Time",value:h.timeOccurred,icon:Wu}),n.jsx(ku,{label:"Location",value:h.location,icon:Wn}),n.jsx(ku,{label:"Reported By",value:h.reportedBy,icon:fa}),h.rpasType&&n.jsx(ku,{label:"RPAS Incident Type",value:(ve=$T[h.rpasType])==null?void 0:ve.label,icon:Zn}),h.projectName&&n.jsx(ku,{label:"Project",value:h.projectName,icon:Vl}),h.aircraftName&&n.jsx(ku,{label:"Aircraft",value:h.aircraftName,icon:Zn})]}),h.description&&n.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-100",children:[n.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Description"}),n.jsx("p",{className:"text-sm text-gray-900 whitespace-pre-wrap",children:h.description})]}),h.immediateActions&&n.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-100",children:[n.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Immediate Actions Taken"}),n.jsx("p",{className:"text-sm text-gray-900 whitespace-pre-wrap",children:h.immediateActions})]})]}),ke&&n.jsx(Wg,{title:"Regulatory Notifications",icon:Wc,defaultOpen:Ve,children:n.jsxs("div",{className:"space-y-3",children:[n.jsx(BC,{type:"TSB_IMMEDIATE",required:oe.tsbRequired,notified:oe.tsbNotified,notifiedDate:oe.tsbNotifiedDate,reference:oe.tsbReference,onMarkComplete:Ae,incidentId:t}),n.jsx(BC,{type:"TRANSPORT_CANADA",required:oe.tcRequired,notified:oe.tcNotified,notifiedDate:oe.tcNotifiedDate,reference:oe.tcReference,onMarkComplete:Ae,incidentId:t}),n.jsx(BC,{type:"WORKSAFEBC",required:oe.worksafebcRequired,notified:oe.worksafebcNotified,notifiedDate:oe.worksafebcNotifiedDate,reference:oe.worksafebcReference,onMarkComplete:Ae,incidentId:t}),n.jsx("div",{className:`p-4 rounded-lg border ${oe.aeriaNotified?"bg-green-50 border-green-200":"bg-blue-50 border-blue-200"}`,children:n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[oe.aeriaNotified?n.jsx(qr,{className:"w-5 h-5 text-green-600"}):n.jsx(Wc,{className:"w-5 h-5 text-blue-600"}),n.jsxs("div",{children:[n.jsx("h4",{className:`font-medium ${oe.aeriaNotified?"text-green-900":"text-blue-900"}`,children:"Aeria Internal (Accountable Executive)"}),n.jsxs("p",{className:"text-sm",children:["Dustin Wales - ",n.jsx("a",{href:"tel:604-849-2345",className:"underline",children:"604-849-2345"})]})]})]}),!oe.aeriaNotified&&n.jsx("button",{onClick:()=>Ae("aeria",""),className:"btn-secondary text-sm",children:"Mark Notified"})]})})]})}),((Le=h.involvedPersons)==null?void 0:Le.length)>0&&n.jsx(Wg,{title:"People Involved",icon:ds,badge:h.involvedPersons.length,children:n.jsx("div",{className:"space-y-3",children:h.involvedPersons.map((ht,hi)=>{var ni;return n.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[n.jsxs("div",{className:"flex items-center justify-between mb-2",children:[n.jsx("span",{className:"font-medium text-gray-900",children:ht.name||`Person ${hi+1}`}),n.jsx("span",{className:`px-2 py-0.5 text-xs font-medium rounded-full ${ht.injuryType==="fatality"?"bg-black text-white":ht.injuryType==="hospitalization"?"bg-red-100 text-red-700":ht.injuryType==="lost_time"?"bg-orange-100 text-orange-700":ht.injuryType==="medical_aid"?"bg-yellow-100 text-yellow-700":ht.injuryType==="first_aid"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:((ni=ht.injuryType)==null?void 0:ni.replace(/_/g," "))||"No injury"})]}),n.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[ht.role&&n.jsxs("div",{children:[n.jsx("span",{className:"text-gray-500",children:"Role:"})," ",ht.role]}),ht.daysLost>0&&n.jsxs("div",{children:[n.jsx("span",{className:"text-gray-500",children:"Days Lost:"})," ",ht.daysLost]}),ht.injuryDescription&&n.jsxs("div",{className:"col-span-2",children:[n.jsx("span",{className:"text-gray-500",children:"Injury:"})," ",ht.injuryDescription]}),ht.treatmentReceived&&n.jsxs("div",{className:"col-span-2",children:[n.jsx("span",{className:"text-gray-500",children:"Treatment:"})," ",ht.treatmentReceived]})]})]},hi)})})}),((Ke=h.equipmentDamage)==null?void 0:Ke.length)>0&&n.jsx(Wg,{title:"Equipment Damage",icon:bf,badge:h.equipmentDamage.length,children:n.jsx("div",{className:"space-y-3",children:h.equipmentDamage.map((ht,hi)=>n.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[n.jsxs("div",{className:"flex items-center justify-between mb-2",children:[n.jsx("span",{className:"font-medium text-gray-900",children:ht.item||`Item ${hi+1}`}),ht.estimatedCost>0&&n.jsxs("span",{className:"text-sm text-gray-600",children:["$",ht.estimatedCost.toLocaleString()]})]}),ht.damageDescription&&n.jsx("p",{className:"text-sm text-gray-600",children:ht.damageDescription}),n.jsx("span",{className:`inline-block mt-2 px-2 py-0.5 text-xs font-medium rounded-full ${ht.repairable?"bg-green-100 text-green-700":"bg-red-100 text-red-700"}`,children:ht.repairable?"Repairable":"Not Repairable"})]},hi))})}),n.jsx(Wg,{title:"Investigation",icon:go,defaultOpen:h.status!=="reported",children:X?n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Assigned To"}),n.jsx("input",{type:"text",value:se.assignedTo,onChange:ht=>de(hi=>({...hi,assignedTo:ht.target.value})),className:"input",placeholder:"Investigator name"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Substandard Acts (Immediate Causes)"}),n.jsx("div",{className:"flex flex-wrap gap-2",children:zU.map(ht=>n.jsxs("label",{className:"flex items-center gap-1 text-sm",children:[n.jsx("input",{type:"checkbox",checked:se.substandardActs.includes(ht),onChange:hi=>{hi.target.checked?de(ni=>({...ni,substandardActs:[...ni.substandardActs,ht]})):de(ni=>({...ni,substandardActs:ni.substandardActs.filter(ui=>ui!==ht)}))},className:"rounded border-gray-300"}),ht]},ht))})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Substandard Conditions (Immediate Causes)"}),n.jsx("div",{className:"flex flex-wrap gap-2",children:BU.map(ht=>n.jsxs("label",{className:"flex items-center gap-1 text-sm",children:[n.jsx("input",{type:"checkbox",checked:se.substandardConditions.includes(ht),onChange:hi=>{hi.target.checked?de(ni=>({...ni,substandardConditions:[...ni.substandardConditions,ht]})):de(ni=>({...ni,substandardConditions:ni.substandardConditions.filter(ui=>ui!==ht)}))},className:"rounded border-gray-300"}),ht]},ht))})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Findings"}),n.jsx("textarea",{value:se.findings,onChange:ht=>de(hi=>({...hi,findings:ht.target.value})),className:"input",rows:4,placeholder:"Summary of investigation findings..."})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Recommendations (one per line)"}),n.jsx("textarea",{value:se.recommendations,onChange:ht=>de(hi=>({...hi,recommendations:ht.target.value})),className:"input",rows:3,placeholder:"Enter recommendations, one per line..."})]}),n.jsxs("div",{className:"flex items-center gap-2 pt-4",children:[n.jsx("button",{onClick:Te,disabled:Y,className:"btn-primary",children:Y?"Saving...":"Save Investigation"}),n.jsx("button",{onClick:()=>he(!1),className:"btn-secondary",children:"Cancel"})]})]}):n.jsx("div",{children:(Pe=h.investigation)!=null&&Pe.assignedTo?n.jsxs("div",{className:"space-y-4",children:[n.jsx(ku,{label:"Assigned To",value:h.investigation.assignedTo,icon:fa}),((tt=(It=h.investigation.immediateCauses)==null?void 0:It.substandardActs)==null?void 0:tt.length)>0&&n.jsxs("div",{children:[n.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"Substandard Acts"}),n.jsx("div",{className:"flex flex-wrap gap-1",children:h.investigation.immediateCauses.substandardActs.map((ht,hi)=>n.jsx("span",{className:"px-2 py-0.5 text-xs bg-orange-100 text-orange-700 rounded",children:ht},hi))})]}),((vt=(zt=h.investigation.immediateCauses)==null?void 0:zt.substandardConditions)==null?void 0:vt.length)>0&&n.jsxs("div",{children:[n.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"Substandard Conditions"}),n.jsx("div",{className:"flex flex-wrap gap-1",children:h.investigation.immediateCauses.substandardConditions.map((ht,hi)=>n.jsx("span",{className:"px-2 py-0.5 text-xs bg-yellow-100 text-yellow-700 rounded",children:ht},hi))})]}),h.investigation.findings&&n.jsxs("div",{children:[n.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Findings"}),n.jsx("p",{className:"text-sm text-gray-900 whitespace-pre-wrap",children:h.investigation.findings})]}),((Ot=h.investigation.recommendations)==null?void 0:Ot.length)>0&&n.jsxs("div",{children:[n.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"Recommendations"}),n.jsx("ul",{className:"list-disc list-inside text-sm text-gray-900 space-y-1",children:h.investigation.recommendations.map((ht,hi)=>n.jsx("li",{children:ht},hi))})]}),n.jsxs("button",{onClick:()=>he(!0),className:"btn-secondary text-sm mt-4",children:[n.jsx(uf,{className:"w-4 h-4 mr-1"}),"Edit Investigation"]})]}):n.jsxs("div",{className:"text-center py-6",children:[n.jsx(go,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),n.jsx("p",{className:"text-gray-500 mb-4",children:"No investigation data recorded yet"}),n.jsxs("button",{onClick:()=>he(!0),className:"btn-primary",children:[n.jsx(vr,{className:"w-4 h-4 mr-1"}),"Start Investigation"]})]})})}),n.jsx(Wg,{title:"Linked CAPAs",icon:Ul,badge:w.length||((Et=h.linkedCapas)==null?void 0:Et.length),children:w.length>0?n.jsx("div",{className:"space-y-2",children:w.map(ht=>n.jsxs(dr,{to:`/capas/${ht.id}`,className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors",children:[n.jsxs("div",{children:[n.jsx("span",{className:"font-medium text-gray-900",children:ht.capaNumber}),n.jsx("p",{className:"text-sm text-gray-600 line-clamp-1",children:ht.title})]}),n.jsx(fn,{className:"w-4 h-4 text-gray-400 -rotate-90"})]},ht.id))}):n.jsxs("div",{className:"text-center py-6",children:[n.jsx(Ul,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),n.jsx("p",{className:"text-gray-500 mb-4",children:"No CAPAs linked to this incident"}),h.status!=="closed"&&n.jsxs(dr,{to:`/capas/new?incidentId=${t}&sourceReference=${h.incidentNumber}`,className:"btn-primary inline-flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Create CAPA"]})]})})]}),n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"card",children:[n.jsxs("h3",{className:"font-semibold text-gray-900 mb-4 flex items-center gap-2",children:[n.jsx(fS,{className:"w-5 h-5 text-gray-400"}),"Timeline"]}),((yi=h.timeline)==null?void 0:yi.length)>0?n.jsx("div",{className:"space-y-4",children:h.timeline.slice().reverse().map((ht,hi)=>n.jsxs("div",{className:"flex gap-3",children:[n.jsx("div",{className:"w-2 h-2 mt-2 rounded-full bg-aeria-blue flex-shrink-0"}),n.jsxs("div",{children:[n.jsx("p",{className:"text-sm font-medium text-gray-900",children:ht.action}),n.jsxs("p",{className:"text-xs text-gray-500",children:[q(ht.date)," by ",ht.by]}),ht.notes&&n.jsx("p",{className:"text-xs text-gray-600 mt-1",children:ht.notes})]})]},hi))}):n.jsx("p",{className:"text-sm text-gray-500",children:"No timeline entries"})]}),((mi=h.witnesses)==null?void 0:mi.length)>0&&n.jsxs("div",{className:"card",children:[n.jsxs("h3",{className:"font-semibold text-gray-900 mb-4 flex items-center gap-2",children:[n.jsx(ds,{className:"w-5 h-5 text-gray-400"}),"Witnesses (",h.witnesses.length,")"]}),n.jsx("div",{className:"space-y-3",children:h.witnesses.map((ht,hi)=>n.jsxs("div",{className:"p-2 bg-gray-50 rounded",children:[n.jsx("p",{className:"text-sm font-medium text-gray-900",children:ht.name}),ht.contact&&n.jsx("p",{className:"text-xs text-gray-500",children:ht.contact})]},hi))})]}),h.metrics&&n.jsxs("div",{className:"card",children:[n.jsx("h3",{className:"font-semibold text-gray-900 mb-4",children:"Metrics"}),n.jsxs("div",{className:"space-y-2",children:[h.metrics.reportingDelay!==void 0&&n.jsxs("div",{className:"flex justify-between text-sm",children:[n.jsx("span",{className:"text-gray-500",children:"Reporting Delay"}),n.jsxs("span",{className:"text-gray-900",children:[h.metrics.reportingDelay," days"]})]}),h.metrics.totalResolutionTime!==void 0&&h.status==="closed"&&n.jsxs("div",{className:"flex justify-between text-sm",children:[n.jsx("span",{className:"text-gray-500",children:"Total Resolution Time"}),n.jsxs("span",{className:"text-gray-900",children:[h.metrics.totalResolutionTime," days"]})]})]})]}),n.jsxs("div",{className:"card",children:[n.jsx("h3",{className:"font-semibold text-gray-900 mb-4",children:"Quick Actions"}),n.jsxs("div",{className:"space-y-2",children:[n.jsxs(dr,{to:"/incidents",className:"flex items-center gap-2 p-2 rounded-lg hover:bg-gray-50 text-gray-700 text-sm",children:[n.jsx(mc,{className:"w-4 h-4"}),"Back to Incidents"]}),n.jsxs(dr,{to:"/safety",className:"flex items-center gap-2 p-2 rounded-lg hover:bg-gray-50 text-gray-700 text-sm",children:[n.jsx(fS,{className:"w-4 h-4"}),"Safety Dashboard"]}),h.projectId&&n.jsxs(dr,{to:`/projects/${h.projectId}`,className:"flex items-center gap-2 p-2 rounded-lg hover:bg-gray-50 text-gray-700 text-sm",children:[n.jsx(Vl,{className:"w-4 h-4"}),"View Project"]})]})]})]})]})]})}function nle(){const[t,e]=Vv(),[r,c]=ue.useState([]),[h,x]=ue.useState(!0),[w,o]=ue.useState(""),[C,R]=ue.useState(t.get("filter")||"all"),[F,$]=ue.useState(t.get("type")||"all"),[Y,H]=ue.useState(t.get("priority")||"all"),[X,he]=ue.useState(null);ue.useEffect(()=>{se()},[]),ue.useEffect(()=>{const q=new URLSearchParams;C!=="all"&&q.set("filter",C),F!=="all"&&q.set("type",F),Y!=="all"&&q.set("priority",Y),e(q)},[C,F,Y]);const se=async()=>{x(!0);try{const q=await Qj();c(q)}catch(q){console.error("Error loading CAPAs:",q)}finally{x(!1)}},de=async(q,oe)=>{if(confirm(`Are you sure you want to delete CAPA "${oe}"? This cannot be undone.`)){try{await Jj(q),c(ke=>ke.filter(Ve=>Ve.id!==q))}catch(ke){console.error("Error deleting CAPA:",ke),alert("Failed to delete CAPA")}he(null)}},K=q=>{if(!q.targetDate)return null;const oe=q.targetDate.toDate?q.targetDate.toDate():new Date(q.targetDate),Ve=jT(oe,new Date);return["closed","verified_effective","verified_ineffective"].includes(q.status)?null:Ve<0?{overdue:!0,days:Math.abs(Ve)}:{overdue:!1,days:Ve}},ge=r.filter(q=>{var ze,ve,Le,Ke;const oe=((ze=q.capaNumber)==null?void 0:ze.toLowerCase().includes(w.toLowerCase()))||((ve=q.title)==null?void 0:ve.toLowerCase().includes(w.toLowerCase()))||((Le=q.problemStatement)==null?void 0:Le.toLowerCase().includes(w.toLowerCase()))||((Ke=q.assignedTo)==null?void 0:Ke.toLowerCase().includes(w.toLowerCase()));let ke=!0;if(C==="overdue"){const Pe=K(q);ke=(Pe==null?void 0:Pe.overdue)===!0}else if(C==="due_soon"){const Pe=K(q);ke=Pe&&!Pe.overdue&&Pe.days<=7}else C!=="all"&&(ke=q.status===C);const Ve=F==="all"||q.type===F,ie=Y==="all"||q.priority===Y;return oe&&ke&&Ve&&ie}),Ae=q=>{if(!q)return"Not set";try{const oe=q.toDate?q.toDate():new Date(q);return bc(oe,"MMM d, yyyy")}catch{return"Invalid date"}},Te=q=>{const oe=ES[q];return oe?n.jsx("span",{className:`px-2 py-0.5 text-xs font-medium rounded-full ${oe.color}`,children:oe.label}):null},Ce=q=>{const oe=_p[q];return oe?n.jsx("span",{className:`px-2 py-0.5 text-xs font-medium rounded ${oe.color}`,children:oe.label}):null},ne=q=>{switch(q){case"corrective":return n.jsx(ir,{className:"w-5 h-5 text-orange-500"});case"preventive":return n.jsx(go,{className:"w-5 h-5 text-blue-500"});case"improvement":return n.jsx(qr,{className:"w-5 h-5 text-green-500"});default:return n.jsx(Ul,{className:"w-5 h-5 text-purple-500"})}},ae={total:ge.length,open:ge.filter(q=>["open","in_progress"].includes(q.status)).length,overdue:ge.filter(q=>{var oe;return(oe=K(q))==null?void 0:oe.overdue}).length,pendingVerification:ge.filter(q=>q.status==="pending_verification").length,effective:ge.filter(q=>q.status==="verified_effective").length};return n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[n.jsxs("div",{children:[n.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"CAPAs"}),n.jsx("p",{className:"text-gray-600 mt-1",children:"Corrective and Preventive Actions"})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsxs(dr,{to:"/safety",className:"btn-secondary inline-flex items-center gap-2",children:[n.jsx(ga,{className:"w-4 h-4"}),"Dashboard"]}),n.jsxs(dr,{to:"/capas/new",className:"btn-primary inline-flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"New CAPA"]})]})]}),n.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-5 gap-4",children:[n.jsxs("div",{className:"card py-3",children:[n.jsx("p",{className:"text-2xl font-bold text-gray-900",children:ae.total}),n.jsx("p",{className:"text-sm text-gray-500",children:"Total"})]}),n.jsxs("div",{className:"card py-3",children:[n.jsx("p",{className:"text-2xl font-bold text-blue-600",children:ae.open}),n.jsx("p",{className:"text-sm text-gray-500",children:"Open"})]}),n.jsxs("div",{className:"card py-3",children:[n.jsx("p",{className:`text-2xl font-bold ${ae.overdue>0?"text-red-600":"text-green-600"}`,children:ae.overdue}),n.jsx("p",{className:"text-sm text-gray-500",children:"Overdue"})]}),n.jsxs("div",{className:"card py-3",children:[n.jsx("p",{className:"text-2xl font-bold text-purple-600",children:ae.pendingVerification}),n.jsx("p",{className:"text-sm text-gray-500",children:"Pending VOE"})]}),n.jsxs("div",{className:"card py-3",children:[n.jsx("p",{className:"text-2xl font-bold text-green-600",children:ae.effective}),n.jsx("p",{className:"text-sm text-gray-500",children:"Effective"})]})]}),n.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[n.jsxs("div",{className:"relative flex-1",children:[n.jsx(nu,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),n.jsx("input",{type:"text",placeholder:"Search CAPAs...",value:w,onChange:q=>o(q.target.value),className:"input pl-9"})]}),n.jsxs("select",{value:C,onChange:q=>R(q.target.value),className:"input w-full sm:w-44",children:[n.jsx("option",{value:"all",children:"All Status"}),n.jsx("option",{value:"overdue",children:" Overdue"}),n.jsx("option",{value:"due_soon",children:" Due Soon (7 days)"}),Object.entries(ES).map(([q,oe])=>n.jsx("option",{value:q,children:oe.label},q))]}),n.jsxs("select",{value:F,onChange:q=>$(q.target.value),className:"input w-full sm:w-40",children:[n.jsx("option",{value:"all",children:"All Types"}),Object.entries(Uy).map(([q,oe])=>n.jsx("option",{value:q,children:oe.label},q))]}),n.jsxs("select",{value:Y,onChange:q=>H(q.target.value),className:"input w-full sm:w-36",children:[n.jsx("option",{value:"all",children:"All Priority"}),Object.entries(_p).map(([q,oe])=>n.jsx("option",{value:q,children:oe.label},q))]})]}),h?n.jsxs("div",{className:"card text-center py-12",children:[n.jsx("div",{className:"w-8 h-8 border-4 border-aeria-navy border-t-transparent rounded-full animate-spin mx-auto mb-4"}),n.jsx("p",{className:"text-gray-500",children:"Loading CAPAs..."})]}):ge.length===0?n.jsxs("div",{className:"card text-center py-12",children:[n.jsx(Ul,{className:"w-12 h-12 mx-auto mb-4 text-gray-300"}),r.length===0?n.jsxs(n.Fragment,{children:[n.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-1",children:"No CAPAs yet"}),n.jsx("p",{className:"text-gray-500 mb-4",children:"Create a CAPA to track corrective or preventive actions."}),n.jsxs(dr,{to:"/capas/new",className:"btn-primary inline-flex items-center gap-2",children:[n.jsx(vr,{className:"w-4 h-4"}),"Create CAPA"]})]}):n.jsxs(n.Fragment,{children:[n.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-1",children:"No matching CAPAs"}),n.jsx("p",{className:"text-gray-500",children:"Try adjusting your search or filters."})]})]}):n.jsx("div",{className:"space-y-3",children:ge.map(q=>{var ke,Ve;const oe=K(q);return n.jsx("div",{className:`card hover:shadow-md transition-shadow group ${oe!=null&&oe.overdue?"border-l-4 border-l-red-500":""}`,children:n.jsxs("div",{className:"flex items-start gap-4",children:[n.jsx("div",{className:`w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0 ${q.type==="corrective"?"bg-orange-100":q.type==="preventive"?"bg-blue-100":"bg-green-100"}`,children:ne(q.type)}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsxs("div",{className:"flex items-center gap-2 mb-1 flex-wrap",children:[n.jsx(dr,{to:`/capas/${q.id}`,className:"font-semibold text-gray-900 hover:text-aeria-blue",children:q.capaNumber}),Te(q.status),Ce(q.priority),(oe==null?void 0:oe.overdue)&&n.jsxs("span",{className:"px-2 py-0.5 text-xs font-medium rounded-full bg-red-100 text-red-700",children:[oe.days,"d overdue"]}),oe&&!oe.overdue&&oe.days<=7&&n.jsxs("span",{className:"px-2 py-0.5 text-xs font-medium rounded-full bg-yellow-100 text-yellow-700",children:["Due in ",oe.days,"d"]})]}),n.jsx("p",{className:"text-gray-700 mb-2 line-clamp-1",children:q.title||q.problemStatement||"No description"}),n.jsxs("div",{className:"flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-gray-500",children:[n.jsx("span",{className:"inline-flex items-center gap-1 capitalize",children:((ke=Uy[q.type])==null?void 0:ke.label)||q.type}),q.targetDate&&n.jsxs("span",{className:`inline-flex items-center gap-1 ${oe!=null&&oe.overdue?"text-red-600":""}`,children:[n.jsx(il,{className:"w-3.5 h-3.5"}),"Due: ",Ae(q.targetDate)]}),q.assignedTo&&n.jsxs("span",{className:"inline-flex items-center gap-1",children:[n.jsx(fa,{className:"w-3.5 h-3.5"}),q.assignedTo]}),q.sourceReference&&n.jsxs("span",{className:"inline-flex items-center gap-1 text-purple-600",children:[n.jsx(rs,{className:"w-3.5 h-3.5"}),q.sourceReference]})]}),q.status==="in_progress"&&((Ve=q.implementation)==null?void 0:Ve.status)&&n.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[n.jsx("div",{className:"flex-1 h-1.5 bg-gray-200 rounded-full overflow-hidden",children:n.jsx("div",{className:`h-full ${q.implementation.status==="complete"?"bg-green-500 w-full":q.implementation.status==="in_progress"?"bg-blue-500 w-1/2":"bg-gray-300 w-0"}`})}),n.jsx("span",{className:"text-xs text-gray-500 capitalize",children:q.implementation.status.replace(/_/g," ")})]})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(dr,{to:`/capas/${q.id}`,className:"p-2 text-gray-400 hover:text-aeria-blue rounded-lg hover:bg-gray-100 opacity-0 group-hover:opacity-100 transition-opacity",title:"View details",children:n.jsx(ko,{className:"w-5 h-5"})}),n.jsxs("div",{className:"relative",children:[n.jsx("button",{onClick:()=>he(X===q.id?null:q.id),className:"p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100",children:n.jsx(Qd,{className:"w-4 h-4"})}),X===q.id&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>he(null)}),n.jsxs("div",{className:"absolute right-0 mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-20",children:[n.jsxs(dr,{to:`/capas/${q.id}`,className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2",children:[n.jsx(ga,{className:"w-4 h-4"}),"View Details"]}),n.jsxs(dr,{to:`/capas/${q.id}/edit`,className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2",children:[n.jsx(rs,{className:"w-4 h-4"}),"Edit"]}),q.relatedIncidentId&&n.jsxs(dr,{to:`/incidents/${q.relatedIncidentId}`,className:"w-full px-4 py-2 text-left text-sm text-orange-700 hover:bg-orange-50 flex items-center gap-2",children:[n.jsx(ir,{className:"w-4 h-4"}),"View Incident"]}),n.jsxs("button",{onClick:()=>de(q.id,q.capaNumber),className:"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2",children:[n.jsx(Ln,{className:"w-4 h-4"}),"Delete"]})]})]})]})]})]})},q.id)})}),ge.length>0&&n.jsxs("div",{className:"flex items-center justify-between text-sm text-gray-500",children:[n.jsxs("span",{children:["Showing ",ge.length," CAPA",ge.length!==1?"s":""]}),n.jsxs("button",{onClick:se,className:"inline-flex items-center gap-1 text-aeria-blue hover:text-aeria-navy",children:[n.jsx(eu,{className:"w-4 h-4"}),"Refresh"]})]})]})}function w0({title:t,description:e,children:r,icon:c}){return n.jsxs("div",{className:"card",children:[n.jsxs("div",{className:"flex items-start gap-3 mb-4",children:[c&&n.jsx("div",{className:"p-2 bg-gray-100 rounded-lg",children:n.jsx(c,{className:"w-5 h-5 text-gray-600"})}),n.jsxs("div",{children:[n.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:t}),e&&n.jsx("p",{className:"text-sm text-gray-500 mt-0.5",children:e})]})]}),r]})}function u5(){var ne,ae;const t=tu(),[e]=Vv(),{userProfile:r}=iu(),[c,h]=ue.useState(!1),[x,w]=ue.useState([]),[o,C]=ue.useState(null),[R,F]=ue.useState(!0),$=e.get("incidentId"),Y=e.get("sourceType")||($?"incident":"observation"),H=e.get("sourceReference")||"",[X,he]=ue.useState({sourceType:Y,sourceId:$||null,sourceReference:H,type:"corrective",priority:"medium",category:"",title:"",problemStatement:"",rootCause:"",assignedTo:"",assignedToEmail:"",assignedBy:r!=null&&r.firstName&&(r!=null&&r.lastName)?`${r.firstName} ${r.lastName}`:"",targetDate:"",action:{description:"",methodology:"",resources:[],estimatedCost:0},verification:{required:!0,method:"",criteria:""}});ue.useEffect(()=>{se()},[$]);const se=async()=>{F(!0);try{const[q]=await Promise.all([rx()]);if(w(q),$)try{const oe=await nb($);C(oe),he(ke=>{var Ve;return{...ke,sourceReference:oe.incidentNumber,problemStatement:oe.description||"",rootCause:((Ve=oe.investigation)==null?void 0:Ve.findings)||""}})}catch(oe){console.error("Error loading linked incident:",oe)}}catch(q){console.error("Error loading data:",q)}finally{F(!1)}},de=(q,oe)=>{he(ke=>({...ke,[q]:oe}))},K=(q,oe)=>{he(ke=>({...ke,action:{...ke.action,[q]:oe}}))},ge=(q,oe)=>{he(ke=>({...ke,verification:{...ke.verification,[q]:oe}}))},Ae=q=>{const oe=x.find(ke=>ke.id===q);he(oe?ke=>({...ke,assignedTo:`${oe.firstName} ${oe.lastName}`,assignedToEmail:oe.email||""}):ke=>({...ke,assignedTo:"",assignedToEmail:""}))},Te=async q=>{if(q.preventDefault(),!X.title.trim()){alert("Please enter a CAPA title");return}if(!X.problemStatement.trim()){alert("Please enter a problem statement");return}if(!X.action.description.trim()){alert("Please enter the planned action");return}h(!0);try{const oe=await YU({...X,targetDate:X.targetDate?new Date(X.targetDate):null,relatedIncidentId:$||null});t(`/capas/${oe.id}`,{state:{message:"CAPA created successfully"}})}catch(oe){console.error("Error creating CAPA:",oe),alert("Failed to create CAPA. Please try again.")}finally{h(!1)}},Ce=q=>{var Ve;const oe=((Ve=_p[q])==null?void 0:Ve.daysToResolve)||14,ke=new Date;return ke.setDate(ke.getDate()+oe),ke.toISOString().split("T")[0]};return n.jsxs("div",{className:"space-y-6 max-w-4xl mx-auto",children:[n.jsxs("div",{className:"flex items-center gap-4",children:[n.jsx("button",{onClick:()=>t(-1),className:"p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100",children:n.jsx(mc,{className:"w-5 h-5"})}),n.jsxs("div",{children:[n.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Create CAPA"}),n.jsx("p",{className:"text-gray-600 mt-1",children:"Corrective and Preventive Action"})]})]}),o&&n.jsx("div",{className:"card bg-orange-50 border-orange-200",children:n.jsxs("div",{className:"flex items-start gap-3",children:[n.jsx(ir,{className:"w-5 h-5 text-orange-600 mt-0.5"}),n.jsxs("div",{children:[n.jsx("h3",{className:"font-medium text-orange-900",children:"Linked to Incident"}),n.jsxs("p",{className:"text-sm text-orange-700 mt-1",children:[o.incidentNumber,": ",o.title]})]})]})}),n.jsxs("form",{onSubmit:Te,className:"space-y-6",children:[n.jsxs(w0,{title:"Classification",description:"Define the type and priority of this CAPA",icon:go,children:[n.jsxs("div",{className:"grid sm:grid-cols-3 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"CAPA Type *"}),n.jsx("select",{value:X.type,onChange:q=>de("type",q.target.value),className:"input",required:!0,children:Object.entries(Uy).map(([q,oe])=>n.jsx("option",{value:q,children:oe.label},q))}),n.jsx("p",{className:"text-xs text-gray-500 mt-1",children:(ne=Uy[X.type])==null?void 0:ne.description})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Priority *"}),n.jsx("select",{value:X.priority,onChange:q=>{de("priority",q.target.value),X.targetDate||de("targetDate",Ce(q.target.value))},className:"input",required:!0,children:Object.entries(_p).map(([q,oe])=>n.jsxs("option",{value:q,children:[oe.label," (",oe.daysToResolve," days)"]},q))})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Category"}),n.jsxs("select",{value:X.category,onChange:q=>de("category",q.target.value),className:"input",children:[n.jsx("option",{value:"",children:"Select category..."}),n.jsx("option",{value:"HSE",children:"HSE"}),n.jsx("option",{value:"Operations",children:"Operations"}),n.jsx("option",{value:"Equipment",children:"Equipment"}),n.jsx("option",{value:"Training",children:"Training"}),n.jsx("option",{value:"Procedures",children:"Procedures"}),n.jsx("option",{value:"Documentation",children:"Documentation"}),n.jsx("option",{value:"Other",children:"Other"})]})]})]}),n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4 mt-4 pt-4 border-t border-gray-100",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Source Type"}),n.jsxs("select",{value:X.sourceType,onChange:q=>de("sourceType",q.target.value),className:"input",disabled:!!$,children:[n.jsx("option",{value:"incident",children:"Incident"}),n.jsx("option",{value:"audit",children:"Audit Finding"}),n.jsx("option",{value:"observation",children:"Observation"}),n.jsx("option",{value:"inspection",children:"Inspection"}),n.jsx("option",{value:"meeting",children:"Meeting Action"}),n.jsx("option",{value:"drill",children:"Drill Gap"}),n.jsx("option",{value:"other",children:"Other"})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Source Reference"}),n.jsx("input",{type:"text",value:X.sourceReference,onChange:q=>de("sourceReference",q.target.value),className:"input",placeholder:"e.g., INC-2026-0001, Audit Finding #3",disabled:!!$})]})]})]}),n.jsx(w0,{title:"Problem Description",description:"Describe the issue that needs to be addressed",icon:Ns,children:n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"CAPA Title *"}),n.jsx("input",{type:"text",value:X.title,onChange:q=>de("title",q.target.value),className:"input",placeholder:"Brief title describing the action",required:!0})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Problem Statement *"}),n.jsx("textarea",{value:X.problemStatement,onChange:q=>de("problemStatement",q.target.value),className:"input",rows:4,placeholder:"Describe the problem or issue that triggered this CAPA...",required:!0})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Root Cause"}),n.jsx("textarea",{value:X.rootCause,onChange:q=>de("rootCause",q.target.value),className:"input",rows:3,placeholder:"What is the underlying cause of this problem?"})]})]})}),n.jsx(w0,{title:"Planned Action",description:"What will be done to address the problem?",icon:rs,children:n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Action Description *"}),n.jsx("textarea",{value:X.action.description,onChange:q=>K("description",q.target.value),className:"input",rows:4,placeholder:"Describe the specific actions that will be taken...",required:!0})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Methodology"}),n.jsx("textarea",{value:X.action.methodology,onChange:q=>K("methodology",q.target.value),className:"input",rows:2,placeholder:"How will the action be implemented?"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Estimated Cost ($)"}),n.jsx("input",{type:"number",value:X.action.estimatedCost,onChange:q=>K("estimatedCost",parseFloat(q.target.value)||0),className:"input w-48",min:"0",step:"0.01"})]})]})}),n.jsx(w0,{title:"Assignment",description:"Who is responsible and when is it due?",icon:fa,children:n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Assigned To"}),n.jsxs("select",{onChange:q=>Ae(q.target.value),className:"input",children:[n.jsx("option",{value:"",children:"Select assignee..."}),x.map(q=>n.jsxs("option",{value:q.id,children:[q.firstName," ",q.lastName]},q.id))]}),X.assignedTo&&n.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:[X.assignedTo," ",X.assignedToEmail&&`(${X.assignedToEmail})`]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Target Completion Date"}),n.jsx("input",{type:"date",value:X.targetDate,onChange:q=>de("targetDate",q.target.value),className:"input",min:new Date().toISOString().split("T")[0]}),X.priority&&n.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Recommended: ",(ae=_p[X.priority])==null?void 0:ae.daysToResolve," days for ",X.priority," priority"]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Assigned By"}),n.jsx("input",{type:"text",value:X.assignedBy,onChange:q=>de("assignedBy",q.target.value),className:"input",placeholder:"Your name"})]})]})}),n.jsx(w0,{title:"Verification of Effectiveness",description:"How will effectiveness be verified?",icon:go,children:n.jsxs("div",{className:"space-y-4",children:[n.jsx("div",{className:"flex items-center gap-3",children:n.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[n.jsx("input",{type:"checkbox",checked:X.verification.required,onChange:q=>ge("required",q.target.checked),className:"rounded border-gray-300"}),n.jsx("span",{className:"text-sm text-gray-700",children:"Verification of effectiveness required"})]})}),X.verification.required&&n.jsxs(n.Fragment,{children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Verification Method"}),n.jsxs("select",{value:X.verification.method,onChange:q=>ge("method",q.target.value),className:"input",children:[n.jsx("option",{value:"",children:"Select method..."}),n.jsx("option",{value:"inspection",children:"Inspection"}),n.jsx("option",{value:"audit",children:"Audit"}),n.jsx("option",{value:"review",children:"Document Review"}),n.jsx("option",{value:"testing",children:"Testing"}),n.jsx("option",{value:"observation",children:"Observation"}),n.jsx("option",{value:"interview",children:"Interview"}),n.jsx("option",{value:"other",children:"Other"})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Success Criteria"}),n.jsx("textarea",{value:X.verification.criteria,onChange:q=>ge("criteria",q.target.value),className:"input",rows:2,placeholder:"How will you measure if the action was effective?"})]})]})]})}),n.jsxs("div",{className:"flex items-center justify-between pt-4 border-t border-gray-200",children:[n.jsx("button",{type:"button",onClick:()=>t(-1),className:"btn-secondary",disabled:c,children:"Cancel"}),n.jsx("button",{type:"submit",className:"btn-primary inline-flex items-center gap-2",disabled:c,children:c?n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Creating..."]}):n.jsxs(n.Fragment,{children:[n.jsx(tb,{className:"w-4 h-4"}),"Create CAPA"]})})]})]})]})}function S0({title:t,icon:e,children:r,defaultOpen:c=!0,badge:h,status:x}){const[w,o]=ue.useState(c);return n.jsxs("div",{className:"card",children:[n.jsxs("button",{onClick:()=>o(!w),className:"w-full flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[e&&n.jsx(e,{className:"w-5 h-5 text-gray-400"}),n.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:t}),h&&n.jsx("span",{className:"px-2 py-0.5 text-xs font-medium rounded-full bg-purple-100 text-purple-700",children:h}),x&&n.jsx("span",{className:`px-2 py-0.5 text-xs font-medium rounded-full ${x==="complete"?"bg-green-100 text-green-700":x==="in_progress"?"bg-blue-100 text-blue-700":x==="pending"?"bg-yellow-100 text-yellow-700":"bg-gray-100 text-gray-700"}`,children:x.replace(/_/g," ")})]}),w?n.jsx($n,{className:"w-5 h-5 text-gray-400"}):n.jsx(fn,{className:"w-5 h-5 text-gray-400"})]}),w&&n.jsx("div",{className:"mt-4 pt-4 border-t border-gray-100",children:r})]})}function Bh({label:t,value:e,icon:r}){return e?n.jsxs("div",{className:"flex items-start gap-3 py-2",children:[r&&n.jsx(r,{className:"w-4 h-4 text-gray-400 mt-0.5 flex-shrink-0"}),n.jsxs("div",{children:[n.jsx("p",{className:"text-xs text-gray-500",children:t}),n.jsx("p",{className:"text-sm text-gray-900",children:e})]})]}):null}function sle({status:t}){const e=ES[t];return e?n.jsx("span",{className:`px-3 py-1 text-sm font-medium rounded-full ${e.color}`,children:e.label}):null}function ale({priority:t}){const e=_p[t];return e?n.jsx("span",{className:`px-3 py-1 text-sm font-medium rounded ${e.color}`,children:e.label}):null}function ole({currentStatus:t}){const e=[{key:"open",label:"Open"},{key:"in_progress",label:"In Progress"},{key:"pending_verification",label:"Pending VOE"},{key:"verified",label:"Verified"},{key:"closed",label:"Closed"}],c=t==="closed"?4:t==="verified_effective"||t==="verified_ineffective"?3:t==="pending_verification"?2:t==="in_progress"?1:0,h=t==="verified_ineffective";return n.jsx("div",{className:"flex items-center justify-between",children:e.map((x,w)=>n.jsxs("div",{className:"flex items-center flex-1",children:[n.jsx("div",{className:`flex items-center justify-center w-8 h-8 rounded-full text-sm font-medium ${w<c?"bg-green-500 text-white":w===c?h&&w===3?"bg-red-500 text-white":"bg-aeria-blue text-white":"bg-gray-200 text-gray-500"}`,children:w<c?n.jsx(qr,{className:"w-5 h-5"}):w===c&&h&&w===3?n.jsx(zl,{className:"w-5 h-5"}):w+1}),w<e.length-1&&n.jsx("div",{className:`flex-1 h-1 mx-2 ${w<c?"bg-green-500":"bg-gray-200"}`})]},x.key))})}function lle(){var Et,yi,mi,ht,hi,ni,ui,Fi,Ii,Bi,Ki,$r,nn,Gn,Tr,jt,bi,ar,li,ai,Jt,Vi,fi,vi,Pi,Nr,er,Wr,kr;const{id:t}=NP(),e=tu();Vv();const[r,c]=ue.useState(null),[h,x]=ue.useState(!0),[w,o]=ue.useState(null),[C,R]=ue.useState(!1),[F,$]=ue.useState(!1),[Y,H]=ue.useState(!1),[X,he]=ue.useState(!1),[se,de]=ue.useState(!1),[K,ge]=ue.useState({actionsTaken:"",evidence:[],notes:""}),[Ae,Te]=ue.useState({verifiedBy:"",effective:null,evidence:"",findings:""}),[Ce,ne]=ue.useState({checkedBy:"",recurred:null,notes:""}),[ae,q]=ue.useState("");ue.useEffect(()=>{oe()},[t]);const oe=async()=>{x(!0),o(null);try{const di=await Fp(t);c(di),di.implementation&&ge({actionsTaken:di.implementation.actionsTaken||"",evidence:di.implementation.evidenceProvided||[],notes:di.implementation.completionNotes||""}),di.verification&&(Te({verifiedBy:di.verification.verifiedBy||"",effective:di.verification.effective,evidence:di.verification.evidence||"",findings:di.verification.findings||""}),di.verification.recurrenceCheck&&ne({checkedBy:di.verification.recurrenceCheck.checkedBy||"",recurred:di.verification.recurrenceCheck.recurred,notes:di.verification.recurrenceCheck.notes||""}))}catch(di){console.error("Error loading CAPA:",di),o("Failed to load CAPA")}finally{x(!1)}},ke=async di=>{R(!0);try{await KU(t,{status:di,_changedBy:"Current User",_statusChangeReason:""}),await oe()}catch(or){console.error("Error updating status:",or),alert("Failed to update status")}finally{R(!1)}},Ve=async()=>{R(!0);try{await QU(t,{actionsTaken:K.actionsTaken,evidence:K.evidence,notes:K.notes,completedBy:"Current User"}),await oe(),$(!1)}catch(di){console.error("Error completing CAPA:",di),alert("Failed to save implementation")}finally{R(!1)}},ie=async()=>{if(Ae.effective===null){alert("Please select whether the CAPA was effective");return}R(!0);try{await JU(t,{verifiedBy:Ae.verifiedBy,effective:Ae.effective,evidence:Ae.evidence,findings:Ae.findings}),await oe(),H(!1)}catch(di){console.error("Error verifying CAPA:",di),alert("Failed to save verification")}finally{R(!1)}},ze=async()=>{if(Ce.recurred===null){alert("Please select whether the issue has recurred");return}R(!0);try{await eq(t,{checkedBy:Ce.checkedBy,recurred:Ce.recurred,notes:Ce.notes}),await oe(),he(!1)}catch(di){console.error("Error recording recurrence check:",di),alert("Failed to save recurrence check")}finally{R(!1)}},ve=async()=>{if(ae.trim()){R(!0);try{await iq(t,{by:"Current User",text:ae}),q(""),await oe(),de(!1)}catch(di){console.error("Error adding comment:",di),alert("Failed to add comment")}finally{R(!1)}}},Le=async()=>{if(confirm("Are you sure you want to close this CAPA?")){R(!0);try{await tq(t,"Current User","CAPA closed"),await oe()}catch(di){console.error("Error closing CAPA:",di),alert("Failed to close CAPA")}finally{R(!1)}}},Ke=async()=>{if(confirm(`Delete CAPA ${r.capaNumber}? This cannot be undone.`))try{await Jj(t),e("/capas")}catch(di){console.error("Error deleting CAPA:",di),alert("Failed to delete CAPA")}},Pe=di=>{if(!di)return"Not set";try{const or=di.toDate?di.toDate():new Date(di);return bc(or,"MMM d, yyyy")}catch{return"Invalid date"}},It=di=>{if(!di)return"Unknown";try{const or=di.toDate?di.toDate():new Date(di);return bc(or,"MMM d, yyyy h:mm a")}catch{return"Invalid date"}},tt=()=>{if(!(r!=null&&r.targetDate))return null;const di=r.targetDate.toDate?r.targetDate.toDate():new Date(r.targetDate),jn=jT(di,new Date);return["closed","verified_effective","verified_ineffective"].includes(r.status)?null:jn<0?{overdue:!0,days:Math.abs(jn)}:{overdue:!1,days:jn}};if(h)return n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"flex items-center gap-4",children:[n.jsx("button",{onClick:()=>e(-1),className:"p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100",children:n.jsx(mc,{className:"w-5 h-5"})}),n.jsx("div",{className:"h-8 w-48 bg-gray-200 rounded animate-pulse"})]}),n.jsxs("div",{className:"card text-center py-16",children:[n.jsx("div",{className:"w-12 h-12 border-4 border-aeria-navy border-t-transparent rounded-full animate-spin mx-auto mb-4"}),n.jsx("p",{className:"text-gray-500",children:"Loading CAPA..."})]})]});if(w||!r)return n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"flex items-center gap-4",children:[n.jsx("button",{onClick:()=>e(-1),className:"p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100",children:n.jsx(mc,{className:"w-5 h-5"})}),n.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"CAPA Not Found"})]}),n.jsxs("div",{className:"card border-red-200 bg-red-50 text-center py-8",children:[n.jsx(ir,{className:"w-12 h-12 mx-auto mb-4 text-red-400"}),n.jsx("h3",{className:"text-lg font-medium text-red-900 mb-1",children:w||"CAPA not found"}),n.jsx(dr,{to:"/capas",className:"btn-primary mt-4",children:"Back to CAPAs"})]})]});const zt=tt(),vt=["closed","verified_effective"].includes(r.status),Ot=r.status==="verified_ineffective";return n.jsxs("div",{className:"space-y-6 max-w-5xl mx-auto",children:[n.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4",children:[n.jsxs("div",{className:"flex items-start gap-4",children:[n.jsx("button",{onClick:()=>e(-1),className:"p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100",children:n.jsx(mc,{className:"w-5 h-5"})}),n.jsxs("div",{children:[n.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[n.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:r.capaNumber}),n.jsx(sle,{status:r.status}),n.jsx(ale,{priority:r.priority}),(zt==null?void 0:zt.overdue)&&n.jsxs("span",{className:"px-2 py-0.5 text-xs font-medium rounded-full bg-red-100 text-red-700",children:[zt.days,"d overdue"]})]}),n.jsx("p",{className:"text-gray-600 mt-1",children:r.title})]})]}),n.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[!vt&&!Ot&&n.jsxs(dr,{to:`/capas/${t}/edit`,className:"btn-secondary inline-flex items-center gap-2",children:[n.jsx(uf,{className:"w-4 h-4"}),"Edit"]}),n.jsx("button",{onClick:Ke,className:"p-2 text-gray-400 hover:text-red-500 rounded-lg hover:bg-red-50",title:"Delete CAPA",children:n.jsx(Ln,{className:"w-5 h-5"})})]})]}),n.jsxs("div",{className:"card",children:[n.jsx("h3",{className:"text-sm font-medium text-gray-500 mb-4",children:"CAPA Progress"}),n.jsx(ole,{currentStatus:r.status}),n.jsxs("div",{className:"flex justify-between mt-2 text-xs text-gray-500",children:[n.jsx("span",{children:"Open"}),n.jsx("span",{children:"In Progress"}),n.jsx("span",{children:"Pending VOE"}),n.jsx("span",{children:"Verified"}),n.jsx("span",{children:"Closed"})]})]}),(zt==null?void 0:zt.overdue)&&n.jsx("div",{className:"p-4 rounded-lg border-2 bg-red-50 border-red-300",children:n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx(Cs,{className:"w-6 h-6 text-red-600"}),n.jsxs("div",{children:[n.jsx("h3",{className:"font-bold text-red-900",children:"CAPA Overdue"}),n.jsxs("p",{className:"text-sm text-red-700",children:["This CAPA is ",zt.days," days past its target date of ",Pe(r.targetDate),"."]})]})]})}),Ot&&n.jsx("div",{className:"p-4 rounded-lg border-2 bg-red-50 border-red-300",children:n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx(zl,{className:"w-6 h-6 text-red-600"}),n.jsxs("div",{children:[n.jsx("h3",{className:"font-bold text-red-900",children:"CAPA Verified Ineffective"}),n.jsx("p",{className:"text-sm text-red-700",children:"This CAPA was found to be ineffective. Consider creating a new CAPA with revised actions."}),n.jsx(dr,{to:`/capas/new?sourceType=capa&sourceId=${t}&sourceReference=${r.capaNumber}`,className:"btn-primary text-sm mt-3",children:"Create Follow-up CAPA"})]})]})}),n.jsxs("div",{className:"grid lg:grid-cols-3 gap-6",children:[n.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[n.jsxs(S0,{title:"CAPA Details",icon:Ul,defaultOpen:!0,children:[n.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[n.jsx(Bh,{label:"Type",value:(Et=Uy[r.type])==null?void 0:Et.label,icon:go}),n.jsx(Bh,{label:"Priority",value:(yi=_p[r.priority])==null?void 0:yi.label,icon:ir}),n.jsx(Bh,{label:"Assigned To",value:r.assignedTo,icon:fa}),n.jsx(Bh,{label:"Assigned Date",value:Pe(r.assignedDate),icon:il}),n.jsx(Bh,{label:"Target Date",value:Pe(r.targetDate),icon:il}),r.completedDate&&n.jsx(Bh,{label:"Completed Date",value:Pe(r.completedDate),icon:qr}),n.jsx(Bh,{label:"Source",value:r.sourceReference,icon:rs}),n.jsx(Bh,{label:"Category",value:r.category,icon:Vl})]}),r.problemStatement&&n.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-100",children:[n.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Problem Statement"}),n.jsx("p",{className:"text-sm text-gray-900 whitespace-pre-wrap",children:r.problemStatement})]}),r.rootCause&&n.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-100",children:[n.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Root Cause"}),n.jsx("p",{className:"text-sm text-gray-900 whitespace-pre-wrap",children:r.rootCause})]}),((mi=r.action)==null?void 0:mi.description)&&n.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-100",children:[n.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Planned Action"}),n.jsx("p",{className:"text-sm text-gray-900 whitespace-pre-wrap",children:r.action.description})]})]}),n.jsx(S0,{title:"Implementation",icon:cle,status:((ht=r.implementation)==null?void 0:ht.status)||"not_started",defaultOpen:r.status==="in_progress"||r.status==="pending_verification",children:F?n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Actions Taken *"}),n.jsx("textarea",{value:K.actionsTaken,onChange:di=>ge(or=>({...or,actionsTaken:di.target.value})),className:"input",rows:4,placeholder:"Describe the actions that were taken..."})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Completion Notes"}),n.jsx("textarea",{value:K.notes,onChange:di=>ge(or=>({...or,notes:di.target.value})),className:"input",rows:2,placeholder:"Any additional notes..."})]}),n.jsxs("div",{className:"flex items-center gap-2 pt-4",children:[n.jsx("button",{onClick:Ve,disabled:C||!K.actionsTaken,className:"btn-primary",children:C?"Saving...":"Complete Implementation"}),n.jsx("button",{onClick:()=>$(!1),className:"btn-secondary",children:"Cancel"})]})]}):n.jsx("div",{children:(hi=r.implementation)!=null&&hi.actionsTaken?n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{children:[n.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Actions Taken"}),n.jsx("p",{className:"text-sm text-gray-900 whitespace-pre-wrap",children:r.implementation.actionsTaken})]}),((ni=r.implementation.evidenceProvided)==null?void 0:ni.length)>0&&n.jsxs("div",{children:[n.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"Evidence Provided"}),n.jsx("div",{className:"space-y-1",children:r.implementation.evidenceProvided.map((di,or)=>n.jsxs("div",{className:"flex items-center gap-2 p-2 bg-gray-50 rounded",children:[n.jsx(rs,{className:"w-4 h-4 text-gray-400"}),n.jsx("span",{className:"text-sm",children:di.description||di.type||`Evidence ${or+1}`})]},or))})]}),r.implementation.completionNotes&&n.jsxs("div",{children:[n.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Completion Notes"}),n.jsx("p",{className:"text-sm text-gray-900",children:r.implementation.completionNotes})]}),r.status==="in_progress"&&n.jsxs("button",{onClick:()=>$(!0),className:"btn-secondary text-sm mt-4",children:[n.jsx(uf,{className:"w-4 h-4 mr-1"}),"Edit Implementation"]})]}):n.jsxs("div",{className:"text-center py-6",children:[n.jsx(go,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),n.jsx("p",{className:"text-gray-500 mb-4",children:"No implementation recorded yet"}),r.status==="open"&&n.jsx("button",{onClick:()=>{ke("in_progress"),$(!0)},className:"btn-primary",children:"Start Implementation"}),r.status==="in_progress"&&n.jsx("button",{onClick:()=>$(!0),className:"btn-primary",children:"Record Implementation"})]})})}),n.jsx(S0,{title:"Verification of Effectiveness",icon:qr,status:((ui=r.verification)==null?void 0:ui.effective)===!0?"effective":((Fi=r.verification)==null?void 0:Fi.effective)===!1?"ineffective":r.status==="pending_verification"?"pending":null,defaultOpen:r.status==="pending_verification"||((Ii=r.verification)==null?void 0:Ii.verifiedDate),children:Y?n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Verified By *"}),n.jsx("input",{type:"text",value:Ae.verifiedBy,onChange:di=>Te(or=>({...or,verifiedBy:di.target.value})),className:"input",placeholder:"Verifier name"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Was the CAPA effective? *"}),n.jsxs("div",{className:"flex gap-4",children:[n.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[n.jsx("input",{type:"radio",name:"effective",checked:Ae.effective===!0,onChange:()=>Te(di=>({...di,effective:!0})),className:"text-green-600"}),n.jsx("span",{className:"text-green-700",children:"Yes, Effective"})]}),n.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[n.jsx("input",{type:"radio",name:"effective",checked:Ae.effective===!1,onChange:()=>Te(di=>({...di,effective:!1})),className:"text-red-600"}),n.jsx("span",{className:"text-red-700",children:"No, Ineffective"})]})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Findings"}),n.jsx("textarea",{value:Ae.findings,onChange:di=>Te(or=>({...or,findings:di.target.value})),className:"input",rows:3,placeholder:"Describe your verification findings..."})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Evidence"}),n.jsx("textarea",{value:Ae.evidence,onChange:di=>Te(or=>({...or,evidence:di.target.value})),className:"input",rows:2,placeholder:"Evidence of effectiveness or lack thereof..."})]}),n.jsxs("div",{className:"flex items-center gap-2 pt-4",children:[n.jsx("button",{onClick:ie,disabled:C||!Ae.verifiedBy||Ae.effective===null,className:"btn-primary",children:C?"Saving...":"Save Verification"}),n.jsx("button",{onClick:()=>H(!1),className:"btn-secondary",children:"Cancel"})]})]}):n.jsx("div",{children:(Bi=r.verification)!=null&&Bi.verifiedDate?n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{className:`p-4 rounded-lg ${r.verification.effective?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[n.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[r.verification.effective?n.jsx(qr,{className:"w-5 h-5 text-green-600"}):n.jsx(zl,{className:"w-5 h-5 text-red-600"}),n.jsx("span",{className:`font-medium ${r.verification.effective?"text-green-900":"text-red-900"}`,children:r.verification.effective?"Verified Effective":"Verified Ineffective"})]}),n.jsxs("p",{className:"text-sm text-gray-600",children:["Verified by ",r.verification.verifiedBy," on ",Pe(r.verification.verifiedDate)]})]}),r.verification.findings&&n.jsxs("div",{children:[n.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Findings"}),n.jsx("p",{className:"text-sm text-gray-900",children:r.verification.findings})]}),r.verification.evidence&&n.jsxs("div",{children:[n.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Evidence"}),n.jsx("p",{className:"text-sm text-gray-900",children:r.verification.evidence})]})]}):n.jsxs("div",{className:"text-center py-6",children:[n.jsx(qr,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),n.jsx("p",{className:"text-gray-500 mb-4",children:"Verification not yet completed"}),r.status==="pending_verification"&&n.jsx("button",{onClick:()=>H(!0),className:"btn-primary",children:"Verify Effectiveness"})]})})}),((Ki=r.verification)==null?void 0:Ki.effective)&&n.jsx(S0,{title:"Recurrence Check",icon:eu,status:((nn=($r=r.verification)==null?void 0:$r.recurrenceCheck)==null?void 0:nn.recurred)===!1?"no_recurrence":((Tr=(Gn=r.verification)==null?void 0:Gn.recurrenceCheck)==null?void 0:Tr.recurred)===!0?"recurred":"pending",defaultOpen:!((bi=(jt=r.verification)==null?void 0:jt.recurrenceCheck)!=null&&bi.checkDate),children:X?n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Checked By *"}),n.jsx("input",{type:"text",value:Ce.checkedBy,onChange:di=>ne(or=>({...or,checkedBy:di.target.value})),className:"input",placeholder:"Your name"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Has the issue recurred? *"}),n.jsxs("div",{className:"flex gap-4",children:[n.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[n.jsx("input",{type:"radio",name:"recurred",checked:Ce.recurred===!1,onChange:()=>ne(di=>({...di,recurred:!1})),className:"text-green-600"}),n.jsx("span",{className:"text-green-700",children:"No, not recurred"})]}),n.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[n.jsx("input",{type:"radio",name:"recurred",checked:Ce.recurred===!0,onChange:()=>ne(di=>({...di,recurred:!0})),className:"text-red-600"}),n.jsx("span",{className:"text-red-700",children:"Yes, recurred"})]})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),n.jsx("textarea",{value:Ce.notes,onChange:di=>ne(or=>({...or,notes:di.target.value})),className:"input",rows:2,placeholder:"Any observations or notes..."})]}),n.jsxs("div",{className:"flex items-center gap-2 pt-4",children:[n.jsx("button",{onClick:ze,disabled:C||!Ce.checkedBy||Ce.recurred===null,className:"btn-primary",children:C?"Saving...":"Save Check"}),n.jsx("button",{onClick:()=>he(!1),className:"btn-secondary",children:"Cancel"})]})]}):n.jsx("div",{children:(li=(ar=r.verification)==null?void 0:ar.recurrenceCheck)!=null&&li.checkDate?n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{className:`p-4 rounded-lg ${r.verification.recurrenceCheck.recurred?"bg-red-50 border border-red-200":"bg-green-50 border border-green-200"}`,children:[n.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[r.verification.recurrenceCheck.recurred?n.jsx(zl,{className:"w-5 h-5 text-red-600"}):n.jsx(qr,{className:"w-5 h-5 text-green-600"}),n.jsx("span",{className:`font-medium ${r.verification.recurrenceCheck.recurred?"text-red-900":"text-green-900"}`,children:r.verification.recurrenceCheck.recurred?"Issue Recurred":"No Recurrence"})]}),n.jsxs("p",{className:"text-sm text-gray-600",children:["Checked by ",r.verification.recurrenceCheck.checkedBy," on ",Pe(r.verification.recurrenceCheck.checkDate)]})]}),r.verification.recurrenceCheck.notes&&n.jsxs("div",{children:[n.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Notes"}),n.jsx("p",{className:"text-sm text-gray-900",children:r.verification.recurrenceCheck.notes})]})]}):n.jsxs("div",{className:"text-center py-6",children:[n.jsx(eu,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),n.jsx("p",{className:"text-gray-500 mb-2",children:"Recurrence check not yet completed"}),n.jsx("p",{className:"text-xs text-gray-400 mb-4",children:"Recommended: 30-90 days after verification"}),n.jsx("button",{onClick:()=>he(!0),className:"btn-primary",children:"Record Recurrence Check"})]})})}),n.jsx(S0,{title:"Comments",icon:T6,badge:(ai=r.comments)==null?void 0:ai.length,defaultOpen:!1,children:n.jsxs("div",{className:"space-y-4",children:[((Jt=r.comments)==null?void 0:Jt.length)>0?n.jsx("div",{className:"space-y-3",children:r.comments.map((di,or)=>n.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[n.jsxs("div",{className:"flex items-center justify-between mb-1",children:[n.jsx("span",{className:"font-medium text-gray-900 text-sm",children:di.by}),n.jsx("span",{className:"text-xs text-gray-500",children:It(di.date)})]}),n.jsx("p",{className:"text-sm text-gray-700",children:di.text})]},or))}):n.jsx("p",{className:"text-sm text-gray-500 text-center py-4",children:"No comments yet"}),se?n.jsxs("div",{className:"space-y-2",children:[n.jsx("textarea",{value:ae,onChange:di=>q(di.target.value),className:"input",rows:2,placeholder:"Write a comment..."}),n.jsxs("div",{className:"flex gap-2",children:[n.jsx("button",{onClick:ve,disabled:C||!ae.trim(),className:"btn-primary text-sm",children:C?"Adding...":"Add Comment"}),n.jsx("button",{onClick:()=>{de(!1),q("")},className:"btn-secondary text-sm",children:"Cancel"})]})]}):n.jsxs("button",{onClick:()=>de(!0),className:"btn-secondary text-sm w-full",children:[n.jsx(vr,{className:"w-4 h-4 mr-1"}),"Add Comment"]})]})})]}),n.jsxs("div",{className:"space-y-6",children:[!vt&&!Ot&&n.jsxs("div",{className:"card",children:[n.jsx("h3",{className:"font-semibold text-gray-900 mb-4",children:"Actions"}),n.jsxs("div",{className:"space-y-2",children:[r.status==="open"&&n.jsx("button",{onClick:()=>ke("in_progress"),disabled:C,className:"btn-primary w-full text-sm",children:"Start Implementation"}),r.status==="in_progress"&&((Vi=r.implementation)==null?void 0:Vi.actionsTaken)&&n.jsx("button",{onClick:()=>ke("pending_verification"),disabled:C,className:"btn-primary w-full text-sm",children:"Ready for Verification"}),r.status==="verified_effective"&&!((vi=(fi=r.verification)==null?void 0:fi.recurrenceCheck)!=null&&vi.checkDate)&&n.jsx("button",{onClick:()=>he(!0),className:"btn-primary w-full text-sm",children:"Record Recurrence Check"}),r.status==="verified_effective"&&((Nr=(Pi=r.verification)==null?void 0:Pi.recurrenceCheck)==null?void 0:Nr.recurred)===!1&&n.jsxs("button",{onClick:Le,disabled:C,className:"btn-primary w-full text-sm bg-green-600 hover:bg-green-700",children:[n.jsx(qr,{className:"w-4 h-4 mr-1"}),"Close CAPA"]})]})]}),n.jsxs("div",{className:"card",children:[n.jsxs("h3",{className:"font-semibold text-gray-900 mb-4 flex items-center gap-2",children:[n.jsx(fS,{className:"w-5 h-5 text-gray-400"}),"Status History"]}),((er=r.statusHistory)==null?void 0:er.length)>0?n.jsx("div",{className:"space-y-4",children:r.statusHistory.slice().reverse().map((di,or)=>n.jsxs("div",{className:"flex gap-3",children:[n.jsx("div",{className:"w-2 h-2 mt-2 rounded-full bg-aeria-blue flex-shrink-0"}),n.jsxs("div",{children:[n.jsx("p",{className:"text-sm font-medium text-gray-900",children:di.from?`${di.from}  ${di.to}`:di.to}),n.jsxs("p",{className:"text-xs text-gray-500",children:[It(di.date)," by ",di.by]}),di.reason&&n.jsx("p",{className:"text-xs text-gray-600 mt-1",children:di.reason})]})]},or))}):n.jsx("p",{className:"text-sm text-gray-500",children:"No status changes recorded"})]}),(((Wr=r.metrics)==null?void 0:Wr.daysOpen)||((kr=r.metrics)==null?void 0:kr.onTime)!==void 0)&&n.jsxs("div",{className:"card",children:[n.jsx("h3",{className:"font-semibold text-gray-900 mb-4",children:"Metrics"}),n.jsxs("div",{className:"space-y-2",children:[r.metrics.onTime!==void 0&&n.jsxs("div",{className:"flex justify-between text-sm",children:[n.jsx("span",{className:"text-gray-500",children:"On Time"}),n.jsx("span",{className:r.metrics.onTime?"text-green-600":"text-red-600",children:r.metrics.onTime?"Yes":"No"})]}),r.metrics.effectivenessScore!==void 0&&n.jsxs("div",{className:"flex justify-between text-sm",children:[n.jsx("span",{className:"text-gray-500",children:"Effectiveness Score"}),n.jsxs("span",{className:"text-gray-900",children:[r.metrics.effectivenessScore,"%"]})]})]})]}),n.jsxs("div",{className:"card",children:[n.jsx("h3",{className:"font-semibold text-gray-900 mb-4",children:"Related"}),n.jsxs("div",{className:"space-y-2",children:[r.relatedIncidentId&&n.jsxs(dr,{to:`/incidents/${r.relatedIncidentId}`,className:"flex items-center gap-2 p-2 rounded-lg hover:bg-gray-50 text-gray-700 text-sm",children:[n.jsx(ir,{className:"w-4 h-4 text-orange-500"}),"View Related Incident"]}),n.jsxs(dr,{to:"/capas",className:"flex items-center gap-2 p-2 rounded-lg hover:bg-gray-50 text-gray-700 text-sm",children:[n.jsx(mc,{className:"w-4 h-4"}),"Back to CAPAs"]}),n.jsxs(dr,{to:"/safety",className:"flex items-center gap-2 p-2 rounded-lg hover:bg-gray-50 text-gray-700 text-sm",children:[n.jsx(fS,{className:"w-4 h-4"}),"Safety Dashboard"]})]})]})]})]})]})}const cle=({className:t})=>n.jsx("svg",{className:t,xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:n.jsx("path",{d:"M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"})});function ule({children:t}){const{isAuthenticated:e,loading:r}=iu();return r?n.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:n.jsxs("div",{className:"text-center",children:[n.jsx("div",{className:"w-12 h-12 border-4 border-aeria-navy border-t-transparent rounded-full animate-spin mx-auto mb-4"}),n.jsx("p",{className:"text-gray-600",children:"Loading..."})]})}):e?t:n.jsx(AP,{to:"/login",replace:!0})}function dle({children:t}){const{isAuthenticated:e,loading:r}=iu();return r?n.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:n.jsx("div",{className:"w-12 h-12 border-4 border-aeria-navy border-t-transparent rounded-full animate-spin"})}):e?n.jsx(AP,{to:"/",replace:!0}):t}function hle(){return n.jsx(sre,{children:n.jsxs(AW,{children:[n.jsx(ra,{path:"/login",element:n.jsx(dle,{children:n.jsx(ure,{})})}),n.jsxs(ra,{path:"/",element:n.jsx(ule,{children:n.jsx(cre,{})}),children:[n.jsx(ra,{index:!0,element:n.jsx(Kne,{})}),n.jsx(ra,{path:"projects",element:n.jsx(tse,{})}),n.jsx(ra,{path:"projects/:projectId",element:n.jsx(Eoe,{})}),n.jsx(ra,{path:"forms",element:n.jsx(Moe,{})}),n.jsx(ra,{path:"policies",element:n.jsx(Zne,{})}),n.jsx(ra,{path:"operators",element:n.jsx(Voe,{})}),n.jsx(ra,{path:"aircraft",element:n.jsx(Woe,{})}),n.jsx(ra,{path:"clients",element:n.jsx(Koe,{})}),n.jsx(ra,{path:"settings",element:n.jsx(Qoe,{})}),n.jsx(ra,{path:"safety",element:n.jsx(ele,{})}),n.jsx(ra,{path:"incidents",element:n.jsx(tle,{})}),n.jsx(ra,{path:"incidents/new",element:n.jsx(l5,{})}),n.jsx(ra,{path:"incidents/:id",element:n.jsx(rle,{})}),n.jsx(ra,{path:"incidents/:id/edit",element:n.jsx(l5,{})}),n.jsx(ra,{path:"capas",element:n.jsx(nle,{})}),n.jsx(ra,{path:"capas/new",element:n.jsx(u5,{})}),n.jsx(ra,{path:"capas/:id",element:n.jsx(lle,{})}),n.jsx(ra,{path:"capas/:id/edit",element:n.jsx(u5,{})})]}),n.jsx(ra,{path:"*",element:n.jsx(AP,{to:"/",replace:!0})})]})})}VC.createRoot(document.getElementById("root")).render(n.jsx(jI.StrictMode,{children:n.jsx(MW,{children:n.jsx(iie,{children:n.jsx(hle,{})})})}));export{Jd as B};
